<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<HTML dir=ltr>
<HEAD>
<META HTTP-EQUIV="Content-Type" Content="text/html; charset=Windows-1252">
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-83731338-2"></script><script>  window.dataLayer = window.dataLayer || [];  function gtag(){dataLayer.push(arguments);}  gtag('js', new Date());  gtag('config', 'UA-83731338-2');</script><title>Tip 167: Controlling the State of Virtual Keys on the Keyboard</title>
                <style>@import url(msdn_ie4.css);</style>
	<link disabled rel="stylesheet" href="msdn_ie3.css">
</HEAD>
<BODY>

<h1><sup><a name="msdn_msdn167"></a></sup>Tip 167: Controlling the State of Virtual Keys on the Keyboard</h1>
<p>
December 5, 1995</p>
<h2>Abstract</h2>
<p>
This article explains how to control the state of any virtual key from within a Microsoft® Visual Basic® application.</p>
<h2>Retrieving and Setting the State of Virtual Keys</h2>
<p>
From within a Microsoft® Visual Basic® application, you can control the state of any one of the 256 virtual keys on the keyboard. You do this by executing two Microsoft Windows® application programming interface (API) functions—<b>GetKeyboardState</b> and <b>SetKeyboardState</b>.</p>
<p>
In the example program below, you switch the state of both the caps lock and num lock keys. To do this, you must first retrieve the state of these two toggle keys by calling the <b>GetKeyboardState</b> function. After calling this function, the KeyboardBuffer array that you have defined in the program contains the current state of every virtual key.</p>
<p>
To isolate the caps lock and num lock keys, you must interrogate the bytes stored in the KeyboardBuffer array. The constants VK_CAPITAL and VK_NUMLOCK represent the caps lock and num lock keys, respectively. If the low-order bit in the byte representing the toggle key is 1, then the key is on. If the low-order bit is 0, the key is off.</p>
<p>
You can use the Visual Basic logical AND operator to test the low-order bit for the toggle keys, as shown here:</p>
<pre><code>If KeyboardBuffer(VK_CAPITAL) And 1 Then
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; KeyboardBuffer(VK_CAPITAL) = 0
 &nbsp;&nbsp; Else
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; KeyboardBuffer(VK_CAPITAL) = 1
End If
</code></pre>
<p>
In the code fragment above, you first test the state of the caps lock key. If the caps lock key is currently on (the low-order bit is 1), you reset the low-order bit to 0 to turn the key off. If the caps lock key is off (the low-order bit is 0), you reset the low-order bit to 1 to turn the key on.</p>
<p>
When you want to reverse the state of the toggle keys (that is, turn the key on if it is not engaged or off if it is engaged), you use the <b>SetKeyboardState</b> function. This function modifies the state of any virtual key. The key you want to modify is again stored in the KeyboardBuffer array.</p>
<h2>Example Program</h2>
<p>
This program shows how to turn the toggle (caps lock and num lock) keys on and off.
<ol>
<li>
Create a new project in Visual Basic. Form1 is created by default.<br><br></li>
<li>
Add the following <b>Constant</b> and <b>Declare</b> statements to the General Declarations section of Form1:<pre><code>Private Declare Sub GetKeyboardState Lib "user32" (lpKeyState As Any)
Private Declare Sub SetKeyboardState Lib "user32" (lpKeyState As Any)
Const VK_CAPITAL = &amp;H14
Const VK_NUMLOCK = &amp;H90
</code></pre>
</li>
<li>
Add a <b>Command Button</b> control to Form1. Command1 is created by default.<br><br></li>
<li>
Add the following code to the Click event for Command1:<pre><code>Private Sub Command1_Click()
 &nbsp;&nbsp; ReDim KeyboardBuffer(256) As Byte

 &nbsp;&nbsp; GetKeyboardState KeyboardBuffer(0)

 &nbsp;&nbsp; If KeyboardBuffer(VK_CAPITAL) And 1 Then
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; KeyboardBuffer(VK_CAPITAL) = 0
 &nbsp;&nbsp; Else
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; KeyboardBuffer(VK_CAPITAL) = 1
 &nbsp;&nbsp; End If

 &nbsp;&nbsp; If KeyboardBuffer(VK_NUMLOCK) And 1 Then
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; KeyboardBuffer(VK_NUMLOCK) = 0
 &nbsp;&nbsp; Else
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; KeyboardBuffer(VK_NUMLOCK) = 1
 &nbsp;&nbsp; End If

 &nbsp;&nbsp; SetKeyboardState KeyboardBuffer(0)
End Sub
</code></pre>
</li>
</ol>
<p>
Run the example program by pressing f5. Notice that both the caps lock and num lock keys are off. Click the <b>Command Button</b> control. The caps lock and num lock keys are both on. Each time you click the <b>Command Button</b> control, the state of the caps lock and num lock keys is reversed.</p>
</BODY>
</HTML>
