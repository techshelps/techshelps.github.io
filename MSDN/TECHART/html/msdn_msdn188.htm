<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<HTML dir=ltr>
<HEAD>
<META HTTP-EQUIV="Content-Type" Content="text/html; charset=Windows-1252">
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-83731338-2"></script><script>  window.dataLayer = window.dataLayer || [];  function gtag(){dataLayer.push(arguments);}  gtag('js', new Date());  gtag('config', 'UA-83731338-2');</script><title>Tip 188: Adding New Commands to the Control Menu</title>
                <style>@import url(msdn_ie4.css);</style>
	<link disabled rel="stylesheet" href="msdn_ie3.css">
</HEAD>
<BODY>

<h1><sup><a name="msdn_msdn188"></a></sup>Tip 188: Adding New Commands to the Control Menu</h1>
<p>
December 5, 1995</p>
<h2>Abstract</h2>
<p>
This article explains how to add a new command to your Microsoft® Visual Basic® Control menu.</p>
<h2>Adding New Commands</h2>
<p>
When developing a Microsoft® Visual Basic® application, you may need to customize the application's Control menu. For example, you may want to add an Always On Top command to the Control menu that gives the user the ability to have the application window always displayed on top of other windows.</p>
<p>
To add a new command to the Control menu, you need to perform several steps. First, you need to use the Microsoft Windows® application programming interface (API) <b>GetSystemMenu</b> function to retrieve the handle of the Control menu. (Note that this tip applies to Windows 95 only.) The following code is the <b>Declare</b> statement for this function:</p>
<pre><code>Private Declare Function GetSystemMenu Lib "user32" 
 &nbsp; (ByVal hWnd As Long, ByVal bRevert As Long) As Long
</code></pre>
<p>
The <b>GetSystemMenu</b> function requires two arguments. The <i>hWnd</i> argument is the handle of the window that owns the Control menu. In this case, this argument is the handle of your application's window. The <i>bRevert</i> argument tells the <b>GetSystemMenu</b> function which of two actions you want to perform.</p>
<p>
If the <i>bRevert</i> argument is set to True, the <b>GetSystemMenu</b> function will reset the Control menu back to its original state (the Windows 95 default). Other applications, as well as your own, may have previously modified the Control menu.</p>
<p>
If the <i>bRevert</i> argument is set to False, the <b>GetSystemMenu</b> function will return the handle of the current Control menu. This may or may not be the original Control menu (the Windows 95 default).</p>
<p>
In the example program below, you want to add a new command to the Control menu. Therefore, you run the <b>GetSystemMenu</b> function with the <i>bRevert</i> argument set to False.</p>
<p>
Once you have the handle of the Control menu, you need to call the Windows API <b>AppendMenu</b> function. The following code is the <b>Declare</b> statement for this function:</p>
<pre><code>Private Declare Function AppendMenu Lib "user32" Alias "AppendMenuA" 
 &nbsp; (ByVal hMenu As Long, ByVal wFlags As Long, ByVal wIDNewItem 
 &nbsp; As Long, ByVal lpNewItem As String) As Long
</code></pre>
<p>
You can use the <b>AppendMenu</b> function to modify an existing menu's structure. You can also use this function to modify the appearance of a new menu command. In this case, however, you just want the command to appear as normal (that is, a textual description).</p>
<p>
The <b>AppendMenu</b> function requires the following four arguments:</p>
<table border=1 cellpadding=5 cols=3 frame=below rules=rows>
<tr valign=top>
<td width=16%><i>hMenu</i></td>
<td colspan=2 width=84%>A long value containing the handle of the menu you want to modify.</td>
</tr>
<tr valign=top>
<td width=16%><i>wFlags</i></td>
<td colspan=2 width=84%>A long value that consists of one or more of the following flags that define the appearance and behavior of the new menu command:</td>
</tr>
<tr valign=top>
<td width=16%></td>
<td width=23%>MF_BITMAP</td>
<td width=61%>A bitmap is used as the command. The <i>lpNewItem</i> argument must contain the bitmap's handle.</td>
</tr>
<tr valign=top>
<td width=16%></td>
<td width=23%>MF_CHECKED</td>
<td width=61%>A check mark is placed next to the command.</td>
</tr>
<tr valign=top>
<td width=16%></td>
<td width=23%>MF_DISABLED</td>
<td width=61%>The command is disabled but not grayed.</td>
</tr>
<tr valign=top>
<td width=16%></td>
<td width=23%>MF_ENABLED</td>
<td width=61%>The command is enabled.</td>
</tr>
<tr valign=top>
<td width=16%></td>
<td width=23%>MF_GRAYED</td>
<td width=61%>The command is grayed.</td>
</tr>
<tr valign=top>
<td width=16%></td>
<td width=23%>MF_MENUBARBREAK</td>
<td width=61%>The command is placed on a new line. If this is a pop-up menu, the new command is placed in a new column and a vertical line separates the columns.</td>
</tr>
<tr valign=top>
<td width=16%></td>
<td width=23%>MF_MENUBREAK</td>
<td width=61%>The command is placed on a new line. If this is a pop-up menu, the new command is placed in a new column.</td>
</tr>
<tr valign=top>
<td width=16%></td>
<td width=23%>MF_OWNERDRAW</td>
<td width=61%>The command is an owner-drawn command.</td>
</tr>
<tr valign=top>
<td width=16%></td>
<td width=23%>MF_POPUP</td>
<td width=61%>The command is a pop-up command. Selecting this command displays a pop-up menu. The pop-up menu's handle must be in the <i>wIDNewItem</i> argument.</td>
</tr>
<tr valign=top>
<td width=16%></td>
<td width=23%>MF_SEPARATOR</td>
<td width=61%>A horizontal dividing line is drawn in a pop-up menu only.</td>
</tr>
<tr valign=top>
<td width=16%></td>
<td width=23%>MF_STRING</td>
<td width=61%>The command is a string. The <i>lpNewItem</i> argument must contain the string itself.</td>
</tr>
<tr valign=top>
<td width=16%></td>
<td width=23%>MF_UNCHECKED</td>
<td width=61%>A check mark is not placed next to the command. This is the default setting.</td>
</tr>
<tr valign=top>
<td width=16%><i>wIDNewItem</i></td>
<td colspan=2 width=84%>A long value containing the new menu command's identifier. If the <i>wFlags</i> argument is set to MF_POPUP, this argument contains the pop-up menu's handle.</td>
</tr>
<tr valign=top>
<td width=16%><i>lpNewItem</i></td>
<td colspan=2 width=84%>A string containing the content of the new menu command according to the <i>wFlags</i> argument, as follows:</td>
</tr>
<tr valign=top>
<td width=16%></td>
<td width=23%>MF_BITMAP</td>
<td width=61%>A bitmap handle.</td>
</tr>
<tr valign=top>
<td width=16%></td>
<td width=23%>MF_OWNERDRAW</td>
<td width=61%>A 32-bit value specifying an application's appearance and behavior instructions for the owner-drawn command.</td>
</tr>
<tr valign=top>
<td width=16%></td>
<td width=23%>MF_STRING</td>
<td width=61%>The command's text.</td>
</tr>
</table><br>
<p>
In the example program below, you use the <b>AppendMenu</b> function to add a new command called "NewMenu" to the Control menu. However, in order to perform some action when a user clicks NewMenu, you need to determine when the application receives a Click event for that new menu command.</p>
<p>
To do this, you need to use a third-party subclassing control such as <b>Message Blaster</b>. The application's window will receive a WM_SYSCOMMAND message each time the user clicks a command on the Control menu. The subclassing control traps each WM_SYSCOMMAND received. If the command corresponds to the new command (identified as SC_NEWMENU), you can perform your own function. In all other cases, Windows 95 will process the menu selection as normal.</p>
<h2>Example Program</h2>
<p>
This program shows how to add a new command to your application's Control menu.
<ol>
<li>
Create a new project in Visual Basic. Form1 is created by default.<br><br></li>
<li>
Add the following code to the General Declarations section of Form1 (note that each <b>Declare</b> statement must be typed as a single line of code):<pre><code>Private Declare Function AppendMenu Lib "user32" Alias "AppendMenuA" 
 &nbsp; (ByVal hMenu As Long, ByVal wFlags As Long, ByVal wIDNewItem As Long, 
 &nbsp; ByVal lpNewItem As String) As Long
Private Declare Function GetSystemMenu Lib "user32" (ByVal hWnd As Long, ByVal 
 &nbsp; bRevert As Long) As Long
Const WM_SYSCOMMAND = &amp;H112
Const MF_STRING = &amp;H0
Const SC_NEWMENU = 1
</code></pre>
</li>
<li>
Add the following code to the Form_Load event for Form1:<pre><code>Private Sub Form_Load()
 &nbsp;&nbsp; Dim hw As Long
 &nbsp;&nbsp; Dim hMenu As Long

 &nbsp;&nbsp; hw = Me.hWnd
 &nbsp;&nbsp; hMenu = GetSystemMenu(hw, False)

 &nbsp;&nbsp; If AppendMenu(hMenu, MF_STRING, SC_NEWMENU, "&amp;NewMenu") Then
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; MsgBlaster1.hWndTarget = hw
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; MsgBlaster1.AddMessage WM_SYSCOMMAND, POSTPROCESS
 &nbsp;&nbsp; End If

End Sub
</code></pre>
</li>
<li>
Add a <b>Message Blaster</b> control to Form1. MsgBlaster1 is created by default.<br><br></li>
<li>
Add the following code to the MsgBlaster1_Message event:<pre><code>Private Sub MsgBlaster1_Message(ByVal hWnd As Long, ByVal Msg As Long, wParam As 
 &nbsp; Long, lParam As Long, nPassage As Integer, lReturnValue As Long)
 &nbsp;&nbsp; If (wParam = SC_NEWMENU) Then
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; MsgBox "NewMenu menu command selected"
 &nbsp;&nbsp; End If
End Sub
</code></pre>
</li>
</ol>
<p>
Run the example program by pressing F5. Form1 appears on the screen. Click the form's Control menu. The new command, NewMenu, is shown on the Control menu. When you click this new command, a message box appears indicating that NewMenu was selected.</p>
</BODY>
</HTML>
