<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<HTML dir=ltr>
<HEAD>
<META HTTP-EQUIV="Content-Type" Content="text/html; charset=Windows-1252">
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-83731338-2"></script><script>  window.dataLayer = window.dataLayer || [];  function gtag(){dataLayer.push(arguments);}  gtag('js', new Date());  gtag('config', 'UA-83731338-2');</script><title>Adding Internet Features to Controls</title>
<style>@import url(msdn_ie4.css);</style>
<link disabled rel="stylesheet" href="msdn_ie3.css"></HEAD>
<BODY>

<h1><a name="vbconaddinginternetfeaturestocontrols"></a>Adding Internet Features to Controls</h1>
<p>
<object id=alink_1 type="application/x-oleobject"
	classid="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
<PARAM name="Command" value="ALink">
<PARAM name="Font" value=",,,,underline">
<PARAM name="Text" value="Text:See Also">
<PARAM name="Flags" value=",,1">
<PARAM name="Item1" value="">
<PARAM name="Item2" value="vbconAddingInternetFeaturesToControlsC">
</object></p>
<p>
ActiveX controls created with Visual Basic can support asynchronous downloading of property values, such as Picture properties that may contain bitmaps. Through the Hyperlink property of the UserControl object, they can also request that a browser jump to a URL, or navigate through the history list.</p>
<p>
These features are available when the control is placed on a container that provides the necessary support functions, such as Microsoft Internet Explorer.</p>
<p>
You may wish to design your control to support both normal loading of property values from a PropertyBag, which is not supported by browsers, and asynchronous downloading of property values.</p>
<p class=indent>
<B><b>Note</b></B>&nbsp;&nbsp;&nbsp;Asynchronous downloading of <i>local files </i>is available in any application. An absolute file path must be used (that is, a path starting from the root directory). Relative file locations will not work.</p>
<h2>Asynchronous Downloading</h2>
<p>
A control requests asynchronous downloading of a property by calling the AsyncRead method of the UserControl object. This method can be called from any event, method, or property procedure of your control, as long as the control has already been sited on the container.</p>
<p>
The call returns immediately, and downloading proceeds in the background, as shown in Figure 9.8a.</p>
<p class=label>
<b>Figure 9.8a&nbsp;&nbsp;&nbsp;Starting asynchronous download of a bitmap property</b></p>
<p>
<img src="avtcm044.gif" border=0></p>
<p>
When the container has retrieved the entire property value, the control receives an AsyncReadComplete event that identifies the property whose value has been retrieved. The control can then access the retrieved data and set the property value, as shown in Figure 9.8b.</p>
<p class=label>
<b>Figure 9.8b&nbsp;&nbsp;&nbsp;Asynchronous download completes</b></p>
<p>
<img src="avtcm051.gif" border=0></p>
<p>
The example code in this topic follows this scheme to create a simple control that displays a bitmap.</p>
<p>
To work through the example, open a new Standard EXE project. Use the Project menu to add a UserControl to the project. Place a PictureBox control on the UserControl, and set the properties as shown in the following table:</p>
<table border=1 cellpadding=5 cols=3 frame=below rules=rows>
<tr valign=top>
<td class=label width=33%><b>Object</b></td>
<td class=label width=33%><b>Property</b></td>
<td class=label width=34%><b>Setting</b></td>
</tr>
<tr valign=top>
<td width=33%>UserControl</td>
<td width=33%>Name</td>
<td width=34%>AsyncBitmap</td>
</tr>
<tr valign=top>
<td width=33%>PictureBox</td>
<td width=33%>Name</td>
<td width=34%>picBitmap</td>
</tr>
<tr valign=top>
<td width=33%></td>
<td width=33%>AutoSize</td>
<td width=34%>True</td>
</tr>
</table><br>
<p>
The control will have two properties, an ordinary Picture property and a related PictureFromURL property. The Picture property is implemented with all three property procedures, because a Picture object can be assigned with or without the Set statement.</p>
<pre><code>Public Property Get Picture() As Picture
   Set Picture = picBitmap.Picture
End Property

Public Property Let Picture(ByVal NewPicture _
      As Picture)
   Set picBitmap.Picture = NewPicture
   PropertyChanged "Picture"
End Property

Public Property Set Picture(ByVal NewPicture _
      As Picture)
   Set picBitmap.Picture = NewPicture
   PropertyChanged "Picture"
End Property
</code></pre>
<p>
The Picture property of the ActiveX control simply delegates to the Picture property of the picture box, <code>picBitmap</code>. The picture box does all the work of displaying the bitmap.</p>
<p>
The new property overrides the Picture property of the UserControl object. From now on, if you type Picture without qualifying it, you will get the ActiveX control's Picture property, as defined here. To access the Picture property of the UserControl, you must now qualify it by typing <code>UserControl.Picture</code>.</p>
<p class=indent>
<B><b>Note</b></B>&nbsp;&nbsp;&nbsp;The purpose and importance of PropertyChanged are discussed in "Adding Properties to Controls," later in this chapter.</p>
<h4>The PictureFromURL Property</h4>
<p>
When a URL string is assigned to the ActiveX control's PictureFromURL property, the Property Let begins a download of the bitmap. When the download is complete, the bitmap is assigned to the Picture property. PictureFromURL is thus an alternate way of assigning a value to the Picture property.</p>
<p>
The PictureFromURL property stores the URL string in a private data member, in the Declarations section of the UserControl:</p>
<pre><code>Option Explicit
Private mstrPictureFromURL As String
</code></pre>
<p>
The Property Get simply returns this string, so the program can discover where the picture was downloaded from. The Property Let does all the work:</p>
<pre><code>Public Property Get PictureFromURL() As String
   PictureFromURL = mstrPictureFromURL
End Property

Public Property Let PictureFromURL(ByVal NewString _
      As String)
   ' (Code to validate path or URL omitted.)
   mstrPictureFromURL = NewString
   If (Ambient.UserMode = True) _
         And (NewString &lt;&gt; "") Then
      ' If program is in run mode, and the URL string
      ' is not empty, begin the download.
      AsyncRead NewString, vbAsyncTypePicture, _
         "PictureFromURL"
   End If
   PropertyChanged "PictureFromURL"
End Property
</code></pre>
<p>
When a URL string is assigned to the PictureFromURL property, the string is saved in the private variable. If the project the control has been added to is in run mode (which will always be true for a control on an HTML page) and if the URL string is not empty, the Property Let starts an asynchronous download, and then exits.</p>
<p>
The asynchronous download is begun by calling the UserControl's AsyncRead method, which has the following syntax:</p>
<p>
<b>AsyncRead </b><i>Target</i><b>,</b> <i>AsyncType</i> <b>[,</b> <i>Property</i><b>]</b></p>
<p>
The <i>Target</i> argument specifies the location of the data. This can be a path or a URL. The host determines the correct method to retrieve the data.</p>
<p>
The <i>AsyncType </i>argument specifies the form in which the retrieved data will be provided. It has the following possible values:</p>
<table border=1 cellpadding=5 cols=2 frame=below rules=rows>
<tr valign=top>
<td class=label width=33%><b>Constant</b></td>
<td class=label width=67%><b>Description</b></td>
</tr>
<tr valign=top>
<td width=33%>VbAsyncTypePicture</td>
<td width=67%>The retrieved data is provided as a Picture object.</td>
</tr>
<tr valign=top>
<td width=33%>VbAsyncTypeFile</td>
<td width=67%>The retrieved data is placed in a file created by Visual Basic. A string containing the path to the file is provided. This is useful when the data contains a large AVI file to be played. The control author can assign the string to the file name property of the appropriate constituent control.</td>
</tr>
<tr valign=top>
<td width=33%>VbAsyncTypeByteArray</td>
<td width=67%>The retrieved data is provided as a byte array. It is assumed that the control author will know how to handle this data.</td>
</tr>
</table><br>
<p>
The <i>Property</i> argument is a string containing the name of the property whose value is to be downloaded. You can use this to enable multiple simultaneous downloads, because this same string is returned in the AsyncReadComplete event, and can be used in a Select statement.</p>
<p>
The value of the Property argument can also be used as the argument of the CancelAsyncRead method, described below.</p>
<h4>Completing the Download</h4>
<p>
As each requested download completes, the control receives an AsyncReadComplete event. The argument of the AsyncReadComplete event is a reference to an AsyncProperty object, which can be used to identify the downloaded property and retrieve the downloaded data.</p>
<pre><code>Private Sub UserControl_AsyncReadComplete( _
      AsyncProp As VB.AsyncProperty)
   On Error Resume Next
   Select Case AsyncProp.PropertyName
      Case "PictureFromURL"
         Set Picture = AsyncProp.Value
         Debug.Print "Download complete"
   End Select
End Sub
</code></pre>
<p>
You should place error handling code in this event procedure, because an error condition may have stopped the download. If this was the case, that error will be raised when you access the Value property of the AsyncProperty object.</p>
<p>
When the downloaded bitmap is assigned to the Picture property, the control repaints.</p>
<p class=indent>
<B><b>Note</b></B>&nbsp;&nbsp;&nbsp;In addition to the Value property that contains the downloaded data and the PropertyName property that contains the name of the property being downloaded, the AsyncProperty object has an AsyncType property. This contains the same value as the AsyncType argument of the AsyncRead method that started the download.</p>
<h3>A Bit More Code</h3>
<p>
So far, the example has no way to save a bitmap assigned at design time. That is, there is no code in the InitProperties, ReadProperties, and WriteProperties events. That code is omitted here, because the purpose of the example is to show asynchronous downloading of a local file.</p>
<p>
One more bit of code will prove useful, however. The reason for using a picture box to display the bitmap, instead of simply using the Picture property of the UserControl, is to take advantage of the AutoSize property of the picture box. The following code resizes the entire control whenever the picture box is resized by the arrival of a new bitmap.</p>
<pre><code>Private Sub picBitmap_Resize()
   ' If there's a Picture assigned, resize.
   If picBitmap.Picture &lt;&gt; 0 Then
      UserControl.Size picBitmap.Width, _
         picBitmap.Height
   End If
End Sub
</code></pre>
<p>
The resizing only happens if the picture box actually contains a Picture object. This allows the user to specify the size of the empty picture box while the download is pending. The code is as follows:</p>
<pre><code>Private Sub UserControl_Resize()
   If picBitmap.Picture = 0 Then
      picBitmap.Move 0, 0, ScaleWidth, ScaleHeight
   Else
      If (Width &lt;&gt; picBitmap.Width) _
            Or (Height &lt;&gt; picBitmap.Height) Then
         Size picBitmap.Width, picBitmap.Height
      End If
   End If
End Sub
</code></pre>
<p>
If there is no Picture object, the picture box is sized to fill the visible area of the UserControl. If there is a Picture object, and the UserControl is resized, it will snap back to the size of the picture box.</p>
<h3>Starting the Download</h3>
<p>
Close the UserControl designer. The control is now running, even though the rest of the project is in design mode. The default control icon on the Toolbox is enabled, so you can add an instance of the control to Form1.</p>
<p>
Locate a large bitmap on your computer — the larger the better. Note the file name and path to the file. Add the following code to the Declarations section of Form1, substituting the name and path of your bitmap for the one shown here:</p>
<pre><code>Option Explicit
Const DOWNLOADFILE = "file:\windows\forest.bmp"
</code></pre>
<p>
Make sure the string begins with <code>file:\</code> so that it's a valid URL for a local file.</p>
<p class=indent>
<B><b>Note</b></B>&nbsp;&nbsp;&nbsp;The URL you pass to the AsyncRead method cannot be a relative URL. That is, you cannot specify relative pathnames for local files.</p>
<p>
Place the following code in the form's Load event:</p>
<pre><code>Private Sub Form_Load()
   AsyncBitmap1.PictureFromURL = DOWNLOADFILE
   DEBUG.PRINT "Load event complete"
End Sub
</code></pre>
<p>
When the form loads, the URL for the local bitmap file will be assigned to the PictureFromURL property, starting the download.</p>
<h3>Running the Sample</h3>
<p>
Press F5 to run the project. In the Immediate window, notice that the first message is "Load event complete," followed by the "Download complete" message from the AsyncReadComplete event.</p>
<p>
If the bitmap was large enough, you may also have noticed that Form1 painted while the bitmap was still downloading. Close Form1, to return to design mode.</p>
<p>
Run the project again, and this time click the Close button on Form1 as soon as you see it. Because the download is proceeding asynchronously in the background, the form becomes active and can respond to user input before the bitmap has been loaded.</p>
<h4>Using the Control</h4>
<p>
Up to this point, the example only demonstrates downloading of a local file. It can't be used on a Web page, because controls in Standard EXE projects cannot be used by other applications. To use the control in other projects or on Web pages, add the source file to an ActiveX control project and compile it as an .ocx file. You'll need some additional code —for example, to save the Picture property, as shown here.</p>
<pre><code>Private Sub UserControl_InitProperties()
   ' Use Nothing as the default when initializing,
   '&nbsp;&nbsp; reading, and writing the Picture property,
   '&nbsp;&nbsp; so than an .frx file won't be needed if
   '&nbsp;&nbsp; there's no picture.
   Set Picture = Nothing
End Sub

Private Sub UserControl_ReadProperties( _
         PropBag As PropertyBag)
   Set Picture = _
      PropBag.ReadProperty("Picture", Nothing)
End Sub

Private Sub UserControl_WriteProperties( _
         PropBag As PropertyBag)
   PropBag.WriteProperty "Picture", Picture, Nothing
End Sub
</code></pre>
<p>
You can use the ActiveX Control Interface Wizard to add standard properties, methods, and events — such as MouseMove — to the control.</p>
<h3>Canceling Asynchronous Downloads</h3>
<p>
You can call the CancelAsyncRead method to cancel an asynchronous data load. CancelAsyncRead takes the property name as an argument; this must match the value of the PropertyName argument in a prior AsyncRead method call.</p>
<p>
Only the specified data load is canceled. All others continue normally.</p>
<p>
<B><b>For More Information</b></B>&nbsp;&nbsp;&nbsp;You can also use the AsyncReadProgress event to monitor the progress of an asynchronous download. The AsynchReadProgress event is discussed in "Downloading Data Asynchronously" in "Building ActiveX Documents."</p>
<h2>Navigating with the Hyperlink Object</h2>
<p>
The Hyperlink object gives your control access to ActiveX hyperlinking functionality. Using the properties and methods of the Hyperlink object, your control can request a hyperlink-aware container, such as Microsoft Internet Explorer, to jump to a given URL or to navigate through the history list.</p>
<p>
You can access the Hyperlink object through the Hyperlink property of the UserControl object. The following code fragment assumes that the control's URLText property contains a URL string. Clicking on the control causes it to request that its container navigate to that URL.</p>
<pre><code>Private Sub UserControl_Click()
   HyperLink.NavigateTo Target:=URLText
End Sub
</code></pre>
<p>
If the target is not a valid URL or document, an error occurs. If the control is sited on a container that does not support hyperlinking, an application that is registered as supporting hyperlinking is started to handle the request.</p>
<p>
The NavigateTo method accepts an optional <i>Location</i> argument, which specifies a location within the target URL. If a location is not specified, the server will jump to the top of the URL or document.</p>
<p>
The NavigateTo method also accepts an optional <i>FrameName</i> argument, which specifies a frame within the target URL.</p>
<p class=indent>
<B><b>Note</b></B>&nbsp;&nbsp;&nbsp;If your control is placed on a container that does not support the IHLink interface, the Hyperlink property of the UserControl object will return Nothing. You should test the property for this value before attempting to use the Hyperlink object.</p>
<h3>Moving Through the History List</h3>
<p>
You can call the GoForward and GoBack methods to navigate through the History list. For example:</p>
<pre><code>   Hyperlink.GoForward
</code></pre>
<p>
If GoForward and GoBack are called when there are no entries in the History list to move forward to, an error occurs. GoForward and GoBack will also raise errors if the container is not hyperlink-aware.</p>
<p>
<B><b>For More Information</b></B>&nbsp;&nbsp;&nbsp;Details of Internet support for ActiveX controls authored in Visual Basic can be found on the Microsoft Visual Basic Web site.</p>
<p>
Information on designing Internet and intranet applications with Visual Basic can be found in <i>Building Internet Applications.</i></p>
</BODY>
</HTML>
