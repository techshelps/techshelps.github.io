<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<HTML dir=ltr>
<HEAD>
<META HTTP-EQUIV="Content-Type" Content="text/html; charset=Windows-1252">
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-83731338-2"></script><script>  window.dataLayer = window.dataLayer || [];  function gtag(){dataLayer.push(arguments);}  gtag('js', new Date());  gtag('config', 'UA-83731338-2');</script><title>CryptMsgOpenToEncode</title>
<link disabled rel=stylesheet href=../../backsdk3.css>
<style type="text/css">
@import url(../../backsdk4.css);
</style>
</HEAD>
<BODY BGCOLOR = #FFFFFF TEXT = #000000>

<h1><a name="_crypto2_cryptmsgopentoencode"></a>CryptMsgOpenToEncode</h1>
<p>
The <b>CryptMsgOpenToEncode</b> function opens a cryptographic message for encoding and returns a handle to the opened message. The message remains open until <a href="llmsg_3485.htm"><b>CryptMsgClose</b></a> is called.</p>
<pre><code><b>#include &lt;wincrypt.h&gt;
HCRYPTMSG WINAPI CryptMsgOpenToEncode(
  DWORD</b><i> dwMsgEncodingType</i><b>,         </b>// in
<b>  DWORD</b><i> dwFlags</i><b>,                   </b>// in
<b>  DWORD</b><i> dwMsgType</i><b>,                 </b>// in
<b>  const void </b><i>*pvMsgEncodeInfo</i><b>,     </b>// in
<b>  LPSTR</b><i> pszInnerContentObjID</i><b>,      </b>// in/optional
<b>  PCMSG_STREAM_INFO</b><i> pStreamInfo    </i>// in/optional
<b>);</b>
 </code></pre>
<h4>Parameters</h4>
<dl>
<dt>
<i>dwMsgEncodingType</i></dt>
<dd>
The type of message encoding used. Note that it is always acceptable to specify both the certificate and message encoding types, by combining them with a bitwise OR operation, as shown in the following example:
<pre><code>CRYPT_ASN_ENCODING | PKCS_7_ASN_ENCODING
 </code></pre>

<p>
However, it is required only to specify the message encoding here. Currently defined encoding types are shown in the following table.

<table cellspacing=4 cols=2>
<tr valign=top>
<th align=left width=45%>Encoding type</th>
<th align=left width=55%>Value</th>
</tr>
<tr valign=top>
<td width=45%>CRYPT_ASN_ENCODING</td>
<td width=55%>0x00000001</td>
</tr>
<tr valign=top>
<td width=45%>PKCS_7_ASN_ENCODING</td>
<td width=55%>0x00010000</td>
</tr>
</table><br>

</dd>
<dt>
<i>dwFlags</i></dt>
<dd>
Flag values. Currently defined flags are shown in the following table:
<table cellspacing=4 cols=2>
<tr valign=top>
<th align=left width=73%>Flag</th>
<th align=left width=27%>Value</th>
</tr>
<tr valign=top>
<td width=73%>CMSG_BARE_CONTENT_FLAG </td>
<td width=27%>0x00000001 </td>
</tr>
<tr valign=top>
<td width=73%>CMSG_DETACHED_FLAG </td>
<td width=27%>0x00000004</td>
</tr>
<tr valign=top>
<td width=73%>CMSG_AUTHENTICATED_ATTRIBUTES_FLAG </td>
<td width=27%>0x00000008</td>
</tr>
</table><br>


<p>
CMSG_BARE_CONTENT_FLAG can be specified for a streamed message to indicate that the streamed output will not have an outer ContentInfo wrapper (as defined by PKCS #7). This makes it suitable to be streamed into an enclosing message.

<p>
The CMSG_DETACHED_FLAG indicates that there is detached data being supplied for the subsequent calls to <a href="llmsg_6rtx.htm"><b>CryptMsgUpdate</b></a>.

<p>
The CMSG_AUTHENTICATED_ATTRIBUTES_FLAG indicates that authenticated attributes are forced to be included in the SignerInfo (as defined by PKCS #7) in cases where they would not otherwise be required. 
</dd>
<dt>
<i>dwMsgType</i></dt>
<dd>
The message type. Currently defined types are shown in the following table.
<table cellspacing=4 cols=3>
<tr valign=top>
<th align=left width=40%>Message type</th>
<th align=left width=46%>Associated structures</th>
<th align=left width=14%>Value</th>
</tr>
<tr valign=top>
<td width=40%>CMSG_DATA</td>
<td width=46%>Raw data (no associated structure)</td>
<td width=14%>1</td>
</tr>
<tr valign=top>
<td width=40%>CMSG_SIGNED</td>
<td width=46%><a href="structs_89rj.htm"><b>CMSG_SIGNER_ENCODE_INFO</b></a>, <a href="structs_2pyn.htm"><b>CMSG_SIGNED_ENCODE_INFO</b></a></td>
<td width=14%>2</td>
</tr>
<tr valign=top>
<td width=40%>CMSG_ENVELOPED</td>
<td width=46%><a href="structs_91pr.htm"><b>CMSG_ENVELOPED_ENCODE_INFO</b></a></td>
<td width=14%>3</td>
</tr>
<tr valign=top>
<td width=40%>CMSG_SIGNED_AND_<br>
ENVELOPED</td>
<td width=46%>Not implemented.</td>
<td width=14%>4</td>
</tr>
<tr valign=top>
<td width=40%>CMSG_HASHED</td>
<td width=46%><a href="structs_78fj.htm"><b>CMSG_HASHED_ENCODE_INFO</b></a></td>
<td width=14%>5</td>
</tr>
<tr valign=top>
<td width=40%>CMSG_ENCRYPTED</td>
<td width=46%>Not implemented.</td>
<td width=14%>6</td>
</tr>
</table><br>


<p>
CMSG_DATA. An octet (BYTE) string.

<p>
CMSG_SIGNED. Consists of content of any type and encrypted message digests of the content for zero or more signers.

<p>
CMSG_ENVELOPED. Consists of encrypted content of any type and encrypted content-encryption keys for one or more recipients. The combination of encrypted content and encrypted content-encryption key for a recipient is a digital envelope for that recipient. See <b>Remarks</b> for issues concerning changes made to the CryptoAPI which affect the handling of enveloped messages in order to support S/MIME e-mail interoperability.

<p>
CMSG_SIGNED_AND_ENVELOPED. Consists of encrypted content of any type, encrypted content-encryption keys for one or more recipients, and doubly encrypted message digests for one or more signers. The double encryption consists of an encryption with a signer's private key followed by an encryption with the content-encryption key.

<p>
CMSG_HASHED. Consists of content of any type and a message digest of the content.


<p>
<b>Note</b>&nbsp;&nbsp;Throughout the PKCS #7 specification, the terms "digest" and "digested" are used to refer to the value produced from applying a hashing algorithm to data. Throughout this document we have used the terms "hash" and "hashed" for the same purpose. For example, the data type used with the low-level message functions is called "hashed" rather than "digested." For the purposes of this document the two terms may be used interchangeably.


<p>
CMSG_ENCRYPTED. Consists of encrypted content of any type. Unlike the enveloped-data content type, the encrypted-data content type has neither recipients nor encrypted content-encryption keys. Keys are assumed to be managed by other means.
</dd>
<dt>
<i>pvMsgEncodeInfo</i></dt>
<dd>
Pointer to the data to be encoded. The type of data pointed to depends on the value of <i>dwMsgType</i>. The relationship between the <i>dwMsgType </i>and<i> pvMsgEncodeInfo </i>is given below:
<p>
When <i>dwMsgType is </i>CMSG_SIGNED<i>, pvMsgEncodeInfo</i> points to a <a href="structs_2pyn.htm"><b>CMSG_SIGNED_ENCODE_INFO</b></a> structure which optionally contains an array of a <a href="structs_89rj.htm"><b>CMSG_SIGNER_ENCODE_INFO</b></a> structures.

<p>
When <i>dwMsgType is </i>CMSG_ENVELOPED<i>, pvMsgEncodeInfo</i> points to a <a href="structs_91pr.htm"><b>CMSG_ENVELOPED_ENCODE_INFO</b></a> structure.

<p>
When <i>dwMsgType is </i>CMSG_HASHED<i>, pvMsgEncodeInfo</i> points to a <a href="structs_78fj.htm"><b>CMSG_HASHED_ENCODE_INFO</b></a> structure.
</dd>
<dt>
<i>pszInnerContentObjID</i></dt>
<dd>
When calling <b>CryptMsgOpenToEncode</b> and the data that is to be provided to <a href="llmsg_6rtx.htm"><b>CryptMsgUpdate</b></a> has already been message encoded, then the appropriate object identifier should be passed in <i>pszInnerContentObjID</i> (for example, "1.2.840.113549.1.7.2" for szOID_RSA_signedData). If <i>pszInnerContentObjID</i> is NULL, then the inner content type is assumed not to have been previously encoded, and is encoded as an octet string and given the type CMSG_DATA.

<p>
<b>Note</b>&nbsp;&nbsp;When streaming is being used, <i>pszInnerContentObjID </i>must be either NULL or szOID_RSA_data.


<p>
The following algorithm object identifiers are commonly used, and they can be found in Wincrypt.h. The user may also define his own inner content usage. All that is required in this case is for the sender and receiver of the message to agree upon the semantics associated with the object identifier.

<table cellspacing=4 cols=3>
<tr valign=top>
<th align=left width=40%>Name</th>
<th align=left width=29%>Base/Suffix</th>
<th align=left width=31%>Value</th>
</tr>
<tr valign=top>
<td width=40%>szOID_RSA_data          </td>
<td width=29%>szOID_PKCS_7 ".1"</td>
<td width=31%>"1.2.840.113549.1.7.1"</td>
</tr>
<tr valign=top>
<td width=40%>szOID_RSA_signedData    </td>
<td width=29%>szOID_PKCS_7 ".2"</td>
<td width=31%>"1.2.840.113549.1.7.2"</td>
</tr>
<tr valign=top>
<td width=40%>szOID_RSA_envelopedData </td>
<td width=29%>szOID_PKCS_7 ".3"</td>
<td width=31%>"1.2.840.113549.1.7.3"</td>
</tr>
<tr valign=top>
<td width=40%>szOID_RSA_signEnvData   </td>
<td width=29%>szOID_PKCS_7 ".4"</td>
<td width=31%>"1.2.840.113549.1.7.4"</td>
</tr>
<tr valign=top>
<td width=40%>szOID_RSA_digestedData  </td>
<td width=29%>szOID_PKCS_7 ".5"</td>
<td width=31%>"1.2.840.113549.1.7.5"</td>
</tr>
<tr valign=top>
<td width=40%>szOID_RSA_encryptedData </td>
<td width=29%>szOID_PKCS_7 ".6"</td>
<td width=31%>"1.2.840.113549.1.7.6"</td>
</tr>
<tr valign=top>
<td width=40%>SPC_INDIRECT_DATA_OBJID</td>
<td width=29%>Not applicable</td>
<td width=31%>"1.3.6.1.4.1.311.2.1.4"</td>
</tr>
</table><br>

</dd>
<dt>
<i>pStreamInfo</i></dt>
<dd>
When streaming is not being used, this parameter should be set to NULL. 
<p>
When streaming is being used, this parameter should point to a <a href="structs_3obz.htm">CMSG_STREAM_INFO</a> structure. The callback specified by <i>pfnStreamOutput</i> in the CMSG_STREAM_INFO structure is called when <a href="llmsg_6rtx.htm"><b>CryptMsgUpdate</b></a> is executed. The callback is passed the encoded bytes resulting from the encoding. For more information on how to use the callback, see <a href="structs_3obz.htm">CMSG_STREAM_INFO</a>.

<p>
Consider the case of a signed message being enclosed in an enveloped message. The encoded output from the streaming encode of the signed message can be fed into another streaming encode of the enveloped message, for example, the callback for the streaming encode of the signed message calls <b>CryptMsgUpdate</b> for the encode of the enveloped message. The callback for the enveloped message receives the encoded bytes of the nested signed message.

</dd>
</dl>
<h4>Return Values</h4>
<p>
A handle to the opened message is returned if successful. Returns NULL if the operation failed.</p>
<p>
To retrieve extended error information, use the <b>GetLastError</b> function.</p>
<p>
The following table lists the error codes most commonly returned by the <b>GetLastError</b> function. </p>
<table cellspacing=4 cols=2>
<tr valign=top>
<th align=left width=49%>Error code</th>
<th align=left width=51%>Description</th>
</tr>
<tr valign=top>
<td width=49%>CRYPT_E_INVALID_MSG_TYPE</td>
<td width=51%>The message type is invalid.</td>
</tr>
<tr valign=top>
<td width=49%>CRYPT_E_OID_FORMAT</td>
<td width=51%>The object identifier is badly formatted.</td>
</tr>
<tr valign=top>
<td width=49%>CRYPT_E_UNKNOWN_ALGO</td>
<td width=51%>The cryptographic algorithm is unknown.</td>
</tr>
<tr valign=top>
<td width=49%>E_INVALIDARG</td>
<td width=51%>One or more arguments are invalid.</td>
</tr>
<tr valign=top>
<td width=49%>E_OUTOFMEMORY</td>
<td width=51%>Ran out of memory.</td>
</tr>
<tr valign=top>
<td width=49%>Propagated errors that may be encountered:</td>
<td width=51%>For <i>dwMsgType == </i>CMSG_SIGNED an error can be propagated from <br>
<a href="capifunc_5kfc.htm"><b>CryptCreateHash</b></a><p>
For <i>dwMsgType == </i>CMSG_ENVELOPED an error can be propagated from <br>
<a href="capifunc_4ptl.htm"><b>CryptGenKey</b></a><b><br>
<a href="capifunc_5np5.htm">CryptImportKey</a><br>
<a href="capifunc_9y9l.htm">CryptExportKey</a></b></p>
<p>
For <i>dwMsgType ==</i>CMSG_HASHED an error can be propagated from <br>
<a href="capifunc_5kfc.htm"><b>CryptCreateHash</b></a> </p>
</td>
</tr>
</table><br>
<h4>Remarks</h4>
<p>
Important changes have been made to the CryptoAPI which affects the handling of enveloped messages to support S/MIME e-mail interoperability. The changes take effect for products released after Service Pack 3, such as Microsoft® Internet Explorer 4.0 and Microsoft® Windows NT® 5.0. The following changes have been made:</p>
<p>
For functions which perform encryption, the encrypted symmetric keys are reversed from little endian format to big endian format after <a href="capifunc_9y9l.htm"><b>CryptExportKey</b></a> is called internally to the function. For functions which perform decryption, the encrypted symmetric keys are reversed from big endian format to little endian format before <a href="capifunc_5np5.htm"><b>CryptImportKey</b></a> is called internally to the function. </p>
<p>
CRYPT_NO_SALT is specified when symmetric keys are generated and imported with <a href="capifunc_4ptl.htm"><b>CryptGenKey</b></a> and CryptImportKey. Previously, 11 bytes of zero value salt was being used instead of using no salt.</p>
<p>
For messages encrypted with the RC2 encryption algorithm, the KP_EFFECTIVE_KEYLEN is used with <a href="capifunc_6d9p.htm"><b>CryptGetKeyParam</b></a> to determine the effective key length of the RC2 key being imported/exported (40, 64, or 128 bits). Previously, a default key length of 40 bits was always used when importing/exporting keys.</p>
<p>
For messages encrypted with the RC2 encryption algorithm, encode and decode operations have been updated to handle ASN RC2 parameters for the contentEncryptionAlgorithm specified in the <a href="structs_91pr.htm"><b>CMSG_ENVELOPED_ENCODE_INFO</b></a>. Previously, the parameters were not supported. See the S/MIME documentation for more information.</p>
<p>
For messages encrypted with the RC4, DES, and 3DES encryption algorithms, encode and decode operations have been updated to handle the ASN IV octet string parameter for the contentEncryptionAlgorithm specified in the <b>CMSG_ENVELOPED_ENCODE_INFO</b>. Previously, that parameter was not supported. See the S/MIME documentation for more information.</p>
<h4>Example</h4>
<p>
See <a href="llmf_3zdx.htm">Signed Message Example Code</a>. </p>
<p>
See <a href="llmf_0igh.htm">Enveloped Message Example 1</a>. </p>
<p>
See <a href="llmf_7dut.htm">Hashed Message Example Code</a>. </p>
<h4>QuickInfo</h4>
<p>
<b>&nbsp;&nbsp;Windows NT: </b>Requires version 4.0 SP3 or later. Available also in IE 3.02 and later.<br>
<b>&nbsp;&nbsp;Windows: </b>Requires Windows 98 (or Windows 95 with IE 3.02 or later).<br>
<b>&nbsp;&nbsp;Windows CE: </b>Unsupported.<br>
<b>&nbsp;&nbsp;Header: </b>Declared in wincrypt.h.<br>
<b>&nbsp;&nbsp;Import Library: </b>Use crypt32.lib.</p>
<h4>See Also</h4>
<p>
<a href="llmsg_3485.htm"><b>CryptMsgClose</b></a>,<b> <a href="llmsg_6rtx.htm">CryptMsgUpdate</a></b>,<b> <a href="llmsg_6xm5.htm">CryptMsgGetParam</a></b>,<b> <a href="llmsg_4y1x.htm">CryptMsgOpenToDecode</a> </b></p>
<p>&nbsp;</p></body>
</HTML>
