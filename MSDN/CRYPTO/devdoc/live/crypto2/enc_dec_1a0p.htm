<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<HTML dir=ltr>
<HEAD>
<META HTTP-EQUIV="Content-Type" Content="text/html; charset=Windows-1252">
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-83731338-2"></script><script>  window.dataLayer = window.dataLayer || [];  function gtag(){dataLayer.push(arguments);}  gtag('js', new Date());  gtag('config', 'UA-83731338-2');</script><title>Encrypting and Decrypting Simultaneously</title>
<link disabled rel=stylesheet href=../../backsdk3.css>
<style type="text/css">
@import url(../../backsdk4.css);
</style>
</HEAD>
<BODY BGCOLOR = #FFFFFF TEXT = #000000>

<h2><a name="_crypto2_encrypting_and_decrypting_simultaneously"></a>Encrypting and Decrypting Simultaneously</h2>
<p>
Care must be taken when encrypting or decrypting two streams of data simultaneously with the same cryptographic key. The same physical session key must not be used for both operations, because every session key contains internal state information and it will get mixed up if used for more than one operation at a time. A simple solution to this problem is to make a copy of the session key. In this way, the original key can be used for one operation and the copy used for the other.</p>
<p>
Copying a session key is done by exporting the key with <a href="capifunc_9y9l.htm"><b>CryptExportKey</b></a> and then by using <a href="capifunc_5np5.htm"><b>CryptImportKey</b></a> to import it back in. When the key is imported, the CSP will give the new key its own section of internal memory, as if it were not related at all to the original key.</p>
<p>
The following code fragment shows how a copy of a session key can be obtained.</p>
<pre><code>HCRYPTPROV hProv;    // Handle to a CSP.
HCRYPTKEY hKey;      // Handle to a session key.

HCRYPTKEY hCopyKey = 0;
HCRYPTKEY hPubKey = 0;
BYTE pbBlob[256];
DWORD dwBlobLen;

// Get a handle to the current user's key exchange public key.
CryptGetUserKey(hProv, AT_KEYEXCHANGE, &amp;hPubKey);

// Export the session key into a key blob.
dwBlobLen = 256;
CryptExportKey(hKey, hPubKey, SIMPLEBLOB, 0, pbBlob, &amp;dwBlobLen);

// Import the session key back into the CSP. This is stored separately
// from the original session key.
CryptImportKey(hProv, pbBlob, dwBlobLen, 0, 0, &amp;hCopyKey);

// Use 'hKey' for one set of operations and 'hCopyKey' for the other.
...
 </code></pre>
<p>
Note that this technique should not be used with stream ciphers, as stream cipher keys should never be used more than once. Instead, separate transmit and receive keys should be used.</p>
<p>&nbsp;</p></body>
</HTML>
