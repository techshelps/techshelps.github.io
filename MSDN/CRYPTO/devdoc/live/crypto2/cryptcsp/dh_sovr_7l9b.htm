<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<HTML dir=ltr>
<HEAD>
<META HTTP-EQUIV="Content-Type" Content="text/html; charset=Windows-1252">
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-83731338-2"></script><script>  window.dataLayer = window.dataLayer || [];  function gtag(){dataLayer.push(arguments);}  gtag('js', new Date());  gtag('config', 'UA-83731338-2');</script><title>The Client Side (Diffie-Hellman)</title>
<link disabled rel=stylesheet href=../../../backsdk3.css>
<style type="text/css">
@import url(../../../backsdk4.css);
</style>
</HEAD>
<BODY BGCOLOR = #FFFFFF TEXT = #000000>

<h2><a name="_cryptcsp_the_client_side_diffie_hellman_"></a>The Client Side (Diffie-Hellman)</h2>
<p>
The protocol engine's client-side code is typically:</p>
<pre><code>HCRYPTPROV hProv      = <i>&lt;protocol engine's key container&gt;</i>;
HCRYPTKEY  hClientDHKey;  // handle to the client's DH key
HCRYPTKEY  hMasterKey;
ALG_ID     Algid;
PBYTE      pbServerPub = <i>&lt;pointer to Server Public Key&gt;</i>;
DWORD      cbServerPub = <i>&lt;size of Server Public Key&gt;</i>;
BYTE       rgbServerBlob[<i>&lt;max blob size&gt;</i>];
DWORD      cbServerBlob;
PBYTE      pbG = <i>&lt;pointer to generator G from Server&gt;</i>;
DWORD      cbG = <i>&lt;size of generator G from Server&gt;</i>;
PBYTE      pbP = <i>&lt;pointer to prime P from Server&gt;</i>;
DWORD      cbP = <i>&lt;size of prime P from Server&gt;</i>;
CRYPT_DATA_BLOB Data;
BYTE       rgbClientPubBlob[<i>size of the client public key blob]</i>;
DWORD      cbClientPubBlob;

// generate and set the parameters on the client DH key
CryptGenKey(hProv, CALG_DH_EPHEM, 0, &amp;hClientDHKey);

Data.pbData = pbP;
Data.cbData = cbP;
CryptSetKeyParam(hClientDHKey, KP_P, (BYTE*)&amp;Data, 0);

Data.pbData = pbG;
Data.cbData = cbG;
CryptSetKeyParam(hClientDHKey, KP_G, (BYTE*)&amp;Data, 0);

// actually create the client private DH key
CryptSetKeyParam(hClientDHKey, KP_X, NULL, 0);

// Build PUBLICKEYBLOB around the server's public key
{
     BLOBHEADER *pBlobHeader = (BLOBHEADER *)rgbServerBlob;
     DHPUBKEY   *pDHPubKey   = (DHPUBKEY *)(pBlobHeader + 1);
     BYTE       *pData       = (BYTE *)(pDHPubKey + 1);

     pBlobHeader-&gt;bType    = PUBLICKEYBLOB;
     pBlobHeader-&gt;bVersion = CUR_BLOB_VERSION;
     pBlobHeader-&gt;reserved = 0;
     pBlobHeader-&gt;aiKeyAlg = CALG_DH_EPHEM;

     pDHPubKey-&gt;magic = 0x31484400;
     pDHPubKey-&gt;bitlen = dwServerPub * 8;

     ReverseMemCopy(pData, pbServerPub, cbServerPub);
     cbServerBlob = sizeof(BLOBHEADER) + sizeof(DHPUBKEY) + 
       cbServerPub;
}

// import the server's public key and get an agreed key
CryptImportKey(hProv, rgbServerBlob, cbServerBlob, hClientDHKey, 0, 
   &amp;hMasterKey);

// Select the master key type.
switch(<i>&lt;protocol being used&gt;</i>)
{
    case <i>&lt;SSL 3.0&gt;</i>:
        Algid = CALG_SSL3_MASTER;
        break;

    case <i>&lt;TLS 1.0&gt;</i>:
        Algid = CALG_TLS1_MASTER;
        break;
}

// Convert the agreed key to the appropriate master key
CryptSetKeyParam(hMasterKey, KP_ALGID, (BYTE*)&amp;Algid, 0);

// Get the client Diffie-Hellman public key.
cbClientPubBlob = sizeof(rgbClientPubBlob);
CryptExportKey(hClientDHKey, 0, PUBLICKEYBLOB,
               0, rgbClientPubBlob, &amp; cbClientPubBlob);

CryptDestroyKey(hClientDHKey);
 </code></pre>
<p>&nbsp;</p></body>
</HTML>
