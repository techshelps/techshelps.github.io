<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<HTML dir=ltr>
<HEAD>
<META HTTP-EQUIV="Content-Type" Content="text/html; charset=Windows-1252">
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-83731338-2"></script><script>  window.dataLayer = window.dataLayer || [];  function gtag(){dataLayer.push(arguments);}  gtag('js', new Date());  gtag('config', 'UA-83731338-2');</script><title>Loading and Opening the VxD</title>
<link disabled rel=stylesheet href=../../../backsdk3.css>
<style type="text/css">
@import url(../../../backsdk4.css);
</style>
</HEAD>
<BODY BGCOLOR = #FFFFFF TEXT = #000000>

<h2><a name="_win95_loading_and_opening_the_vxd"></a>Loading and Opening the VxD</h2>
<p>
When your application calls <a href="../filesio_7wmd.htm"><b>CreateFile</b></a>, the system sends the <a href="95msg_8muk.htm">W32_DEVICEIOCONTROL</a> message to the control procedure of the specified VxD to determine if it supports the device IOCTL interface. The ESI register contains the address of a <a href="95str_42gi.htm"><b>DIOCParams</b></a> structure whose <b>dwIoControlCode</b> member specifies the DIOC_GETVERSION control code. A VxD that supports the device IOCTL interface must respond to the DIOC_GETVERSION control code by clearing the EAX register. (A VxD can also return version information in the buffer pointed to by the <b>lpvOutBuffer</b> member so long as the <b>cbOutBuffer</b> member is nonzero. If <b>cbOutBuffer</b> is zero, the calling application is not interested in version information, but the VxD must still return zero to indicate success.) If the VxD does not support the device IOCTL interface, it must place a nonzero value in EAX. </p>
<p>
For dynamically loadable VxDs, the system sends a SYS_DYNAMIC_INIT control message to the VxD the first time that it is opened. If the VxD returns success, the system sends the <a href="95msg_8muk.htm">W32_DEVICEIOCONTROL</a> message with the DIOC_OPEN (identical in value to the DIOC_GETVERSION control code) control code. The VxD must return zero to inform the calling application that it supports W32_DEVICEIOCONTROL. The system sets the reference count for the VxD to 1. On every subsequent call to <a href="../filesio_7wmd.htm"><b>CreateFile</b></a> for the VxD, the VxD receives the W32_DEVICEIOCONTROL message with the DIOC_OPEN control code and the reference count for the VxD is incremented. </p>
<p>
The VxD receives a W32_DEVICEIOCONTROL message with the DIOC_CLOSEHANDLE control code if the application closes the device handle by calling the <a href="../handobj_289x.htm"><b>CloseHandle</b></a> function, or if the operating system closes the handle when the application terminates (or <a href="../filesio_5n8l.htm"><b>DeleteFile</b></a> if the VxD was not opened with the FILE_FLAG_DELETE_ON_CLOSE value). The VxD can use this notification to perform cleanup operations and release structures associated with the application. The reference count for the VxD is decremented before the message is sent. If the reference count is decremented to zero, the VxD receives the SYS_DYNAMIC_EXIT message and is subsequently unloaded.</p>
<p>&nbsp;</p></body>
</HTML>
