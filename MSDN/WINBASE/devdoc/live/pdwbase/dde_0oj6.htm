<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<HTML dir=ltr>
<HEAD>
<META HTTP-EQUIV="Content-Type" Content="text/html; charset=Windows-1252">
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-83731338-2"></script><script>  window.dataLayer = window.dataLayer || [];  function gtag(){dataLayer.push(arguments);}  gtag('js', new Date());  gtag('config', 'UA-83731338-2');</script><title>Retrieving an Item from the Server</title>
<link disabled rel=stylesheet href=../../backsdk3.css>
<style type="text/css">
@import url(../../backsdk4.css);
</style>
</HEAD>
<BODY BGCOLOR = #FFFFFF TEXT = #000000>

<h3><a name="_win32_retrieving_an_item_from_the_server"></a>Retrieving an Item from the Server</h3>
<p>
To retrieve an item from the server, the client sends the server a <a href="dde_3gvo.htm">WM_DDE_REQUEST</a> message specifying the item and format to retrieve, as shown in the following example. </p>
<pre><code>if ((atomItem = GlobalAddAtom(szItemName)) != 0) 
{ 
    if (!PostMessage(hwndServerDDE, 
            WM_DDE_REQUEST, 
            (WPARAM) hwndClientDDE, 
            PackDDElParam(WM_DDE_REQUEST, CF_TEXT, atomItem))) 
    {
        GlobalDeleteAtom(atomItem); 
    }
} 
 
if (atomItem == 0) 
{ 

    // Handle errors. 

} 
 </code></pre>
<p>
In this example, the client specifies the clipboard format CF_TEXT as the preferred format for the requested data item. </p>
<p>
The receiver (server) of the <a href="dde_3gvo.htm">WM_DDE_REQUEST</a> message typically must delete the item atom, but if the <object id=alink_1 type="application/x-oleobject"
	classid="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
<PARAM name="Command" value="ALink,MENU">
<PARAM name="DefaultTopic" value="../../notopic_0pk4.htm">
<PARAM name="Item1" value="">
<PARAM name="Item2" value="_win32_postmessage">
</object><a href=JavaScript:alink_1.Click()><b>PostMessage</b></a> call fails, the client must delete the atom. </p>
<p>
If the server has access to the requested item and can render it in the requested format, the server copies the item value as a shared memory object and sends the client a <a href="dde_3kkh.htm">WM_DDE_DATA</a> message, as illustrated in the following example. </p>
<pre><code>// Allocate the size of the DDE data header, plus the data: a 
// string,&lt;CR&gt;&lt;LF&gt;&lt;NULL&gt;. The byte for the string's terminating 
// null character is counted by DDEDATA.Value[1]. 
 
if (!(hData = GlobalAlloc(GMEM_MOVEABLE | GMEM_DDESHARE, 
        (LONG) sizeof(DDEDATA) + lstrlen(szItemValue) + 2))) 
{
    return; 
}
 
if (!(lpData = (DDEDATA FAR*) GlobalLock(hData)))  
{
    GlobalFree(hData); 
    return; 
} 
 
lpData-&gt;cfFormat = CF_TEXT; 
lstrcpy((LPSTR) lpData-&gt;Value, (LPSTR) szItemValue); 
 
// Each line of CF_TEXT data is terminated by CR/LF. 
 
lstrcat((LPSTR) lpData-&gt;Value, (LPSTR) "\r\n"); 
GlobalUnlock(hData); 

if ((atomItem = GlobalAddAtom((LPSTR) szItemName)) != 0) 
{ 
    lParam = PackDDElParam(WM_DDE_ACK, (UINT) hData, atomItem); 
    if (!PostMessage(hwndClientDDE, 
            WM_DDE_DATA, 
            (WPARAM) hwndServerDDE, 
            lParam)) 
    { 
        GlobalFree(hData); 
        GlobalDeleteAtom(atomItem); 
        FreeDDElParam(WM_DDE_ACK, lParam); 
    } 
} 
 
if (atomItem == 0) 
{ 

    // Handle errors.  

} 
 </code></pre>
<p>
In this example, the server application allocates a memory object to contain the data item. The memory is allocated with the GMEM_DDESHARE option, so that the server and client applications can share the memory. After allocating the memory object, the server application locks the object so it can obtain the object's address. The data object is initialized as a <a href="dde_9f1u.htm"><b>DDEDATA</b></a> structure. </p>
<p>
The server application then sets the <b>cfFormat</b> member of the structure to CF_TEXT to inform the client application that the data is in text format. The client responds by copying the value of the requested data into the <b>Value</b> member of the <b>DDEDATA</b> structure. After the server has filled the data object, the server unlocks the data and creates a global atom containing the name of the data item. </p>
<p>
Finally, the server issues the <a href="dde_3kkh.htm">WM_DDE_DATA</a> message by calling <object id=alink_2 type="application/x-oleobject"
	classid="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
<PARAM name="Command" value="ALink,MENU">
<PARAM name="DefaultTopic" value="../../notopic_0pk4.htm">
<PARAM name="Item1" value="">
<PARAM name="Item2" value="_win32_postmessage">
</object><a href=JavaScript:alink_2.Click()><b>PostMessage</b></a>. The handle of the data object and the atom containing the item name are packed into the <i>lParam</i> parameter of the message by the <a href="dde_059p.htm"><b>PackDDElParam</b></a> function. </p>
<p>
If <b>PostMessage</b> fails, the server must use the <a href="dde_0mr1.htm"><b>FreeDDElParam</b></a> function to free the packed <i>lParam</i> parameter. The server must also free the packed <i>lParam</i> parameter for the <a href="dde_3gvo.htm">WM_DDE_REQUEST</a> message it received. </p>
<p>
If the server cannot satisfy the request, it sends a negative <a href="dde_678r.htm">WM_DDE_ACK</a> message to the client, as shown in the following example. </p>
<pre><code>// Negative acknowledgment. 
 
PostMessage(hwndClientDDE, 
    WM_DDE_ACK, 
    (WPARAM) hwndServerDDE, 
    PackDDElParam(WM_DDE_ACK, 0, atomItem)); 
 </code></pre>
<p>
Upon receiving a <a href="dde_3kkh.htm">WM_DDE_DATA</a> message, the client processes the data-item value as appropriate. Then, if the <b>fAckReq</b> member pointed to in the WM_DDE_DATA message is 1, the client must send the server a positive <a href="dde_678r.htm">WM_DDE_ACK</a> message, as shown in the following example. </p>
<pre><code>UnpackDDElParam(WM_DDE_DATA, lParam, (PUINT) &amp;hData, 
    (PUINT) &amp;atomItem); 
if (!(lpDDEData = (DDEDATA FAR*) GlobalLock(hData)) 
        || (lpDDEData-&gt;cfFormat != CF_TEXT)) 
{ 
    PostMessage(hwndServerDDE, 
        WM_DDE_ACK, 
        (WPARAM) hwndClientDDE, 
        PackDDElParam(WM_DDE_ACK, 0, atomItem)); // Negative ACK. 
} 
 
// Copy data from lpDDEData here. 
 
if (lpDDEData-&gt;fAckReq) 
{ 
    PostMessage(hwndServerDDE, 
        WM_DDE_ACK, 
        (WPARAM) hwndClientDDE, 
        PackDDElParam(WM_DDE_ACK, 0x8000, 
            atomItem)); // Positive ACK 
} 
 
bRelease = lpDDEData-&gt;fRelease; 
GlobalUnlock(hData); 
if (bRelease) 
    GlobalFree(hData); 
 </code></pre>
<p>
In this example, the client examines the format of the data. If the format is not CF_TEXT (or if the client cannot lock the memory for the data), the client sends a negative <a href="dde_678r.htm">WM_DDE_ACK</a> message to indicate that it cannot process the data. If the client cannot lock a data handle because the handle contains the <b>fAckReq</b> member, the client should not send a negative WM_DDE_ACK message. Instead, the client should terminate the conversation. </p>
<p>
If a client sends a negative acknowledgement in response to a <a href="dde_3kkh.htm">WM_DDE_DATA</a> message, the server is responsible for freeing the memory (but not the <i>lParam</i> parameter) referenced by the WM_DDE_DATA message associated with the negative acknowledgement. </p>
<p>
If it can process the data, the client examines the <b>fAckReq</b> member of the <a href="dde_9f1u.htm"><b>DDEDATA</b></a> structure to determine whether the server requested that it be informed that the client received and processed the data successfully. If the server did request this information, the client sends the server a positive WM_DDE_ACK message. </p>
<p>
Because unlocking data invalidates the pointer to the data, the client saves the value of the <b>fRelease</b> member before unlocking the data object. After saving the value, the client then examines it to determine whether the server application requested the client to free the memory containing the data; the client acts accordingly. </p>
<p>
Upon receiving a negative <a href="dde_678r.htm">WM_DDE_ACK</a> message, the client can ask for the same item value again, specifying a different clipboard format. Typically, a client will first ask for the most complex format it can support, then step down if necessary through progressively simpler formats until it finds one the server can provide. </p>
<p>
If the server supports the Formats item of the system topic, the client can determine once what clipboard formats the server supports, instead of determining them each time the client requests an item. For more information about the system topic, see <a href="dde_2gf7.htm">The System Topic</a>. </p>
<p>&nbsp;</p></body>
</HTML>
