<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<HTML dir=ltr>
<HEAD>
<META HTTP-EQUIV="Content-Type" Content="text/html; charset=Windows-1252">
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-83731338-2"></script><script>  window.dataLayer = window.dataLayer || [];  function gtag(){dataLayer.push(arguments);}  gtag('js', new Date());  gtag('config', 'UA-83731338-2');</script><title>Connection Pooling</title>
<link disabled rel=stylesheet href=msdn_ie3.css>
<style type="text/css">
@import url(msdn_ie4.css);
</style>
</HEAD>
<BODY>
<FONT FACE="Verdana, Arial, Helvetica" SIZE="2">

	<!--TOOLBAR_START-->
	<!--TOOLBAR_EXEMPT-->
	<!--TOOLBAR_END-->


<h1><a name="odbcconnection_pooling"></a>Connection Pooling</h1>
<p>
Connection pooling enables an application to use a connection from a pool of connections that do not need to be reestablished for each use. Once a connection has been created and placed in a pool, an application can reuse that connection without performing the complete connection process.</p>
<p>
Using a pooled connection can result in significant performance gains, because applications can save the overhead involved in making a connection. This can be particularly significant for middle-tier applications that connect over a network, or for applications that repeatedly connect and disconnect, such as Internet applications.</p>
<p>
In addition to performance gains, the connection pooling architecture enables an environment and its associated connections to be used by multiple components in a single process. This means that stand-alone components in the same process can interact with each other without being aware of each other. A connection in a connection pool can be used repeatedly by multiple components.</p>
<p class=indent>
<B><b>Note&nbsp;&nbsp;&nbsp;</b></B>Connection pooling can be used by an ODBC application exhibiting ODBC 2.<i>x</i> behavior, as long as the application can call <i>SQLSetEnvAttr</i>. When using connection pooling, the application must not execute SQL statements that change the database or the context of the database, such as changing the &lt;database name&gt;, which changes the catalog used by a data source.</p>
<p>
The connection pool is maintained by the Driver Manager. Connections are drawn from the pool when the application calls <b>SQLConnect</b> or <b>SQLDriverConnect</b>, and are returned to the pool when the application calls <b>SQLDisconnect</b>. The size of the pool grows dynamically based upon the requested resource allocations. It shrinks based on the inactivity timeout: If a connection is inactive for a period of time (it has not been used in a connection), it is removed from the pool. The size of the pool is limited only by memory constraints and limits on the server.</p>
<p>
The Driver Manager determines whether a specific connection in a pool should be used according to the arguments passed in <b>SQLConnect</b> or <b>SQLDriverConnect</b>, and the connection attributes set after the connection was allocated.</p>
<p>
When the Driver Manager is pooling connections, it needs to be able to determine if a connection is still working before handing the connection out. Otherwise, the Driver Manager keeps on handing out the dead connection to the application whenever a transient network failure occurs. In ODBC 3.x a new connection attribute, SQL_ATTR_CONNECTION_DEAD, has been defined. This is a read-only connection attribute that returns either SQL_CD_TRUE or SQL_CD_FALSE. The value SQL_CD_TRUE means that the connection has been lost, while the value SQL_CD_FALSE means that the connection is still active. (Drivers conforming to earlier versions of ODBC can also support this attribute.)</p>
<p>
A driver must implement this option efficiently, or it will impair the connection pooling performance. Specifically, a call to get this connection attribute should not cause a round trip to the server. Instead, a driver should just return the last known state of the connection. The connection is dead if the last trip to the server failed, and not dead if the last trip succeeded. </p>
<p>
To use a connection pool, an application performs the following steps:
<ol>
<li>
Enables connection pooling by calling <b>SQLSetEnvAttr</b> to set the SQL_ATTR_CONNECTION_POOLING environment attribute to SQL_CP_ONE_PER_DRIVER or SQL_CP_ONE_PER_HENV. This call must be made before the application allocates the shared environment for which connection pooling is to be enabled. The environment handle in the call to <b>SQLSetEnvAttr</b> should be set to null, which makes SQL_ATTR_CONNECTION_POOLING a process-level attribute. If the attribute is set to SQL_CP_ONE_PER_DRIVER, a single connection pool is supported for each driver. If an application works with many drivers and few environments, this may be more efficient because fewer comparisons may be required. If set to SQL_CP_ONE_PER_HENV, a single connection pool is supported for each environment. If an application works with many environments and few drivers, this may be more efficient because fewer comparisons may be required. Connection pooling is disabled by setting SQL_ATTR_CONNECTION_POOLING to SQL_CP_OFF.<br><br></li>
<li>
Allocates an environment by calling <b>SQLAllocHandle</b> with the <i>HandleType</i> argument set to SQL_HANDLE_ENV. The environment allocated by this call will be an implicit shared environment because connection pooling has been enabled. The environment to be used is not determined, however, until <b>SQLAllocHandle</b> with a <i>HandleType</i> of SQL_HANDLE_DBC is called on this environment. <br><br></li>
<li>
Allocates a connection by calling <b>SQLAllocHandle</b> with <i>InputHandle</i> set to SQL_HANDLE_DBC, and the <i>InputHandle</i> set to the environment handle allocated for connection pooling. The Driver Manager attempts to find an existing environment that matches the environment attributes set by the application. If no such environment exists, one is created, with a reference count (maintained by the Driver Manager) of 1. If a matching shared environment is found, the environment is returned to the application, and its reference count is incremented.<br><br></li>
<li>
The actual connection to be used is not determined by the Driver Manager until <b>SQLConnect</b> or <b>SQLDriverConnect</b> is called.<br><br></li>
<li>
Calls <b>SQLConnect</b> or <b>SQLDriverConnect</b> to make the connection. The Driver Manager uses the connection options in the call to <b>SQLConnect</b> (or the connection keywords in the call to <b>SQLDriverConnect</b>) and the connection attributes set after connection allocation to determine which connection in the pool should be used. <p class=atl>
<B><b>Note&nbsp;&nbsp;&nbsp;</b></B>How a requested connection is matched to a pooled connection is determined by the SQL_ATTR_CP_MATCH environment attribute. For more information, see <a href="odch21jpr_1gtu.htm">SQLSetEnvAttr</a>.</p></li>
<li>
Calls <b>SQLDisconnect</b> when done with the connection. The connection is returned to the connection pool and becomes available for reuse.</li>
</ol>
</font></BODY>
</HTML>
