<!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML//EN">
<html>

<HEAD>
<meta name="PREMIUM" content="MSDN">
<meta http-equiv="Content-Type" content="text/html; charset=iso8859-1">
<meta name="MS.LOCALE" content="EN-US">
<meta name="DESCRIPTION" content="This page is from the Microsoft Proxy Server book, found in the Tools and Technologies Section in the MSDN Library">



<script async src="https://www.googletagmanager.com/gtag/js?id=UA-83731338-2"></script><script>  window.dataLayer = window.dataLayer || [];  function gtag(){dataLayer.push(arguments);}  gtag('js', new Date());  gtag('config', 'UA-83731338-2');</script><title>Appendix D, Architecture</title>
<style>@import url(msdn_ie4.css);</style>
<link disabled rel="stylesheet" href="msdn_ie3.css"></HEAD>


<BODY bgcolor="#FFFFFF" link=#003399 vlink=#996699>


<FONT FACE="Verdana, Arial, Helvetica" SIZE="2">

	<!--TOOLBAR_START-->
	<!--TOOLBAR_EXEMPT-->
	<!--TOOLBAR_END-->

<FONT FACE="Verdana, Arial, Helvetica" SIZE="2">

<p align="left"><a name="Top"><font size="2"
face="Verdana, Arial, Helvetica"><img src="onepix.gif" alt="Space"
align="top" width="1" height="1"></font></a></p>

<hr>

<h3><a name="AppendixD"><font size="2" face="Verdana, Arial, Helvetica"><br>
Appendix D</font></a></h3>

<h1><a name="Architecture"><font size="6" face="Verdana, Arial, Helvetica">Architecture</font></a></h1>

<blockquote>
    <p><a href="#2h1"><font size="2" face="Verdana, Arial, Helvetica">How
    the Web Proxy Service Works</font></a><font size="2"
    face="Verdana, Arial, Helvetica"><br>
    </font><a href="#3h1"><font size="2" face="Verdana, Arial, Helvetica">How
    the WinSock Proxy Service Works</font></a></p>
</blockquote>

<hr>

<h1><a href="#Top"><font size="2" face="Verdana, Arial, Helvetica"><img
src="up.gif" alt="To Top" align="middle" border="0" width="14"
height="11"></font></a><a name="2h1"><font size="2"
face="Verdana, Arial, Helvetica">How the Web Proxy Service Works</font></a></h1>

<blockquote>
    <p><a href="#3h2"><font size="2" face="Verdana, Arial, Helvetica">The
    CERN-Proxy Protocol</font></a><font size="2"
    face="Verdana, Arial, Helvetica"><br>
    </font><a href="#4h2"><font size="2" face="Verdana, Arial, Helvetica">The
    Microsoft Proxy Server Web Proxy service</font></a><font
    size="2" face="Verdana, Arial, Helvetica"><br>
    </font><a href="#5h2"><font size="2" face="Verdana, Arial, Helvetica">Caching
    Mechanisms</font></a></p>
</blockquote>

<h2><a href="#Top"><font size="2" face="Verdana, Arial, Helvetica"><img
src="up.gif" alt="To Top" align="middle" border="0" width="14"
height="11"></font></a><a name="3h2"><font size="2"
face="Verdana, Arial, Helvetica">The CERN-Proxy Protocol</font></a></h2>

<blockquote>
    <p><a href="#20h4"><font size="2" face="Verdana, Arial, Helvetica">What
    is CERN-Proxy?</font></a><font size="2"
    face="Verdana, Arial, Helvetica"><br>
    </font><a href="#21h4"><font size="2" face="Verdana, Arial, Helvetica">How
    HTTP Works</font></a><font size="2" face="Verdana, Arial, Helvetica"><br>
    </font><a href="#22h4"><font size="2" face="Verdana, Arial, Helvetica">How
    the GET Method Works</font></a><font size="2"
    face="Verdana, Arial, Helvetica"><br>
    </font><a href="#23h4"><font size="2" face="Verdana, Arial, Helvetica">Examples
    of Usage with Web Proxy Service</font></a></p>
</blockquote>

<h3><a href="#Top"><font size="2" face="Verdana, Arial, Helvetica"><img
src="up.gif" alt="To Top" align="middle" border="0" width="14"
height="11"></font></a><a name="20h4"><font size="2"
face="Verdana, Arial, Helvetica"><strong>What is CERN-Proxy?</strong></font></a></h3>

<p><font size="2" face="Verdana, Arial, Helvetica">The CERN-proxy protocol
is widely recognized throughout the World Wide Web (WWW)
community as the standard for implementing proxy services in
TCP/IP-based networks. It has its origins within the standards
for Hypertext Transfer Protocol (HTTP) as a UNIX-based service
first developed by members of Switzerland&#146;s Conseil Europeen
pour la Recherche Nucleair (European Laboratory for Particle
Physics, or CERN) in the early 1990s. </font></p>

<p><font size="2" face="Verdana, Arial, Helvetica">As the CERN staff added
application-aware proxy support for Hypertext Transfer Protocol
daemon (HTTPd) servers commonly known as Web servers to their
libraries, the WWW community built on these additions. In the
time since it was first introduced, the CERN-proxy protocol has
become an accepted industry standard for implementing HTTP proxy
service. The Microsoft Proxy Server Web Proxy service is fully
compatible with the CERN-proxy standard. </font></p>

<p><font size="2" face="Verdana, Arial, Helvetica">To better understand
how CERN-proxy works, it is important to understand the
differences between how most Internet applications, such as File
Transfer Protocol (FTP) and Gopher, work and how HTTP
applications work. </font></p>

<p><font size="2" face="Verdana, Arial, Helvetica">Standard TCP/IP
applications such as FTP use TCP (or in some cases, User Datagram
Protocol, or UDP) as the transport-level protocol for supporting
client/server communications. For HTTP-based applications, a set
of commands (called methods) are defined that are used in
Web-based client/server communications. While CERN-compatible
proxy services support WWW (HTTP), FTP, and Gopher requests, it
is important to keep in mind that <em>a CERN-based Web proxy
server uses HTTP for all communications with its Web Proxy
clients.</em> </font></p>

<h3><a href="#Top"><font size="2" face="Verdana, Arial, Helvetica"><img
src="up.gif" alt="To Top" align="middle" border="0" width="14"
height="11"></font></a><a name="21h4"><font size="2"
face="Verdana, Arial, Helvetica"><strong>How HTTP Works</strong></font></a></h3>

<p><font size="2" face="Verdana, Arial, Helvetica">HTTP defines a set of
commands (called <em>methods</em>) that a client can send to a
server. The two most common methods are: </font></p>

<ul>
    <li><p align="left"><font size="2" face="Verdana, Arial, Helvetica"><strong>GET&nbsp;&nbsp;&nbsp;</strong>GET
        is used to forward a Uniform Resource Locator (URL) to a
        server requesting the resource to which the URL refers. </font></p>
    </li>
    <li><font size="2" face="Verdana, Arial, Helvetica"><strong>POST&nbsp;&nbsp;&nbsp;</strong>POST
        is used to forward a request that contains a URL and
        data; typically, a user provides this data by completing
        a Hypertext Markup Language (HTML) form.<br>
        <br>
        </font></li>
</ul>

<h3><a href="#Top"><font size="2" face="Verdana, Arial, Helvetica"><img
src="up.gif" alt="To Top" align="middle" border="0" width="14"
height="11"></font></a><a name="22h4"><font size="2"
face="Verdana, Arial, Helvetica"><strong>How the GET Method Works</strong></font></a></h3>

<p><font size="2" face="Verdana, Arial, Helvetica">In a simple HTTP
request, a browser that is not configured for proxy service sends
an HTTP URL directly to a Web server. The browser sends the
server a GET method, which includes the path and resource name
requested. In the process, the browser will remove the protocol
and site name from the URL (http://<i>domainname</i>) before
forwarding the GET method request on to the site named in the
URL. </font></p>

<p><font size="2" face="Verdana, Arial, Helvetica">For example, if the
following URL is typed on the command line of a browser not
configured for proxy service </font></p>

<blockquote>
    <p><font size="2" face="Verdana, Arial, Helvetica"><tt>http://host.com/sales/report.htm
    </tt></font></p>
</blockquote>

<p><font size="2" face="Verdana, Arial, Helvetica">the browser parses the
URL and sends the following command to Host.com as: </font></p>

<blockquote>
    <p><font size="2" face="Verdana, Arial, Helvetica"><tt>GET
    /Sales/Report.htm</tt><b> </b></font></p>
</blockquote>

<p><font size="2" face="Verdana, Arial, Helvetica">This type of processing
simplifies communications because HTTP is the protocol for all
message requests that browser clients communicate to the server,
but it limits browser requests to sending and receiving by use of
HTTP only. Browser requests for FTP URLs can not be handled
directly in this manner, although proxy service can support these
types of requests for browser clients.</font></p>

<h4><a name="23h4"><font size="2" face="Verdana, Arial, Helvetica"><strong>Examples
of GET Usage with Proxy Service</strong></font></a></h4>

<p><font size="2" face="Verdana, Arial, Helvetica">When a browser is
configured for use with a proxy server, GET methods issued by the
browser are created with more detail about the resource included.
The browser client will issue the full URL without parsing the
named protocol first. The named protocol indicates the type of
service being requested and whether the GET request is for a WWW,
FTP, or Gopher resource. The fully detailed GET method is then
forwarded to the proxy server. </font></p>

<p><font size="2" face="Verdana, Arial, Helvetica">The following is an
example of a WWW (HTTP) request that shows proxy-based service
for a document entitled Doc.htm in the Sales directory on the
server Host.com: </font></p>

<p align="left"><font size="2" face="Verdana, Arial, Helvetica"><img
src="xag_f03.gif" width="452" height="144"></font></p>

<p><font size="2" face="Verdana, Arial, Helvetica">The process by which a
proxy request is serviced is as follows: </font></p>

<ol>
    <li><p align="left"><font size="2" face="Verdana, Arial, Helvetica">The
        Web browser sends the full URL request as a GET statement
        to the proxy server. </font></p>
    </li>
    <li><p align="left"><font size="2" face="Verdana, Arial, Helvetica">The
        proxy server: </font></p>
        <ul>
            <li><p align="left"><font size="2"
                face="Verdana, Arial, Helvetica">Receives the request. </font></p>
            </li>
            <li><p align="left"><font size="2"
                face="Verdana, Arial, Helvetica">Parses the URL. </font></p>
                <p align="left"><font size="2"
                face="Verdana, Arial, Helvetica">If the URL is in the
                cache, the request is serviced to the Web browser
                from the cache. </font></p>
            </li>
            <li><p align="left"><font size="2"
                face="Verdana, Arial, Helvetica">Identifies the type of
                resource the request is for (such as HTTP or
                FTP). </font></p>
            </li>
            <li><p align="left"><font size="2"
                face="Verdana, Arial, Helvetica">Resolves the domain name
                to an IP address. </font></p>
            </li>
            <li><p align="left"><font size="2"
                face="Verdana, Arial, Helvetica">Requests Doc.htm from the
                Internet server by using the appropriate
                protocol, such as HTTP or FTP. </font></p>
                <p align="left"><font size="2"
                face="Verdana, Arial, Helvetica">In this case, because the
                URL specified HTTP, HTTP is the appropriate
                protocol. Note that a request sent to a Web
                server is formatted by the proxy service as a
                standard request, that is, a request not
                forwarded by the proxy service. </font></p>
            </li>
        </ul>
    </li>
    <li><p align="left"><font size="2" face="Verdana, Arial, Helvetica">The
        Web server: </font></p>
        <ul>
            <li><font size="2" face="Verdana, Arial, Helvetica">Receives
                the request.</font></li>
            <li><p align="left"><font size="2"
                face="Verdana, Arial, Helvetica">Responds by sending
                Doc.htm to the proxy by using HTTP. </font></p>
            </li>
        </ul>
    </li>
    <li><p align="left"><font size="2" face="Verdana, Arial, Helvetica">The
        proxy server: </font></p>
        <ul>
            <li><font size="2" face="Verdana, Arial, Helvetica">Receives
                Doc.htm.</font></li>
            <li><p align="left"><font size="2"
                face="Verdana, Arial, Helvetica">Sends Doc.htm to the
                browser by using HTTP. </font></p>
            </li>
        </ul>
    </li>
    <li><p align="left"><font size="2" face="Verdana, Arial, Helvetica">The
        Web browser receives Doc.htm and displays it on-screen,
        completing the process. </font></p>
    </li>
</ol>

<p><font size="2" face="Verdana, Arial, Helvetica">Another example of this
process will demonstrate how an FTP resource is requested and
handled under proxy service.</font></p>

<p><font size="2" face="Verdana, Arial, Helvetica">The following diagram
shows how an FTP request is forwarded using proxy service. The
browser sends a request to the proxy service for an FTP-published
document named Q296.doc. The GET method that is used contains the
full FTP URL entered at the browser command line,
ftp://host.com/sales/Q296.doc. (Note that the HTTP protocol is
used by the browser to send the GET method to the proxy.) </font></p>

<p align="left"><font size="2" face="Verdana, Arial, Helvetica"><img
src="xag_f04.gif" width="376" height="103"></font></p>

<p><font size="2" face="Verdana, Arial, Helvetica">In this case, the proxy
service identifies the request as the FTP protocol, and requests
Q296.doc from host.com by using the FTP protocol. Host.com then
returns Q296.doc to the proxy by using the FTP protocol, and the
proxy uses the HTTP protocol to send the document to the client. </font></p>

<p><font size="2" face="Verdana, Arial, Helvetica">Browsers that are not
configured for the proxy service issue FTP and Gopher requests by
using the FTP and Gopher protocols, respectively. A browser that
is not configured for the proxy service cannot issue an FTP or
Gopher requests by using HTTP. </font></p>

<p><font size="2" face="Verdana, Arial, Helvetica">Configuring a browser
to communicate with a proxy server actually simplifies the work
that the browser needs to do, because all requests are processed
with HTTP and have complete URLs. </font></p>

<h2><a href="#Top"><font size="2" face="Verdana, Arial, Helvetica"><img
src="up.gif" alt="To Top" align="middle" border="0" width="14"
height="11"></font></a><a name="4h2"><font size="2"
face="Verdana, Arial, Helvetica">The Microsoft Proxy Server </font></a><font
size="2" face="Verdana, Arial, Helvetica">Web Proxy Service</font></h2>

<blockquote>
    <p><a href="#0h3"><font size="2" face="Verdana, Arial, Helvetica">About
    the Web Proxy Service</font></a><font size="2"
    face="Verdana, Arial, Helvetica"><br>
    </font><a href="#1h3"><font size="2" face="Verdana, Arial, Helvetica">Proxy
    ISAPI Filter</font></a><font size="2" face="Verdana, Arial, Helvetica"><br>
    </font><a href="#2h3"><font size="2" face="Verdana, Arial, Helvetica">Proxy
    ISAPI Application</font></a><font size="2"
    face="Verdana, Arial, Helvetica"><br>
    </font><a href="#4h3"><font size="2" face="Verdana, Arial, Helvetica">Advantages
    of the Web Proxy Service</font></a><font size="2"
    face="Verdana, Arial, Helvetica"><br>
    </font></p>
</blockquote>

<h3><a href="#Top"><font size="2" face="Verdana, Arial, Helvetica"><img
src="up.gif" alt="To Top" align="middle" border="0" width="14"
height="11"></font></a><a name="0h3"><font size="2"
face="Verdana, Arial, Helvetica">About the Web Proxy Service</font></a></h3>

<p><font size="2" face="Verdana, Arial, Helvetica">The Microsoft Proxy
server fully supports the CERN standards for proxy service with
added support for other application-level proxy services as well.
</font></p>

<p><font size="2" face="Verdana, Arial, Helvetica">How does the Web Proxy
service work? Certain application services have knowledge of the
underlying protocols used by the applications they support. This
knowledge allows Microsoft Proxy Server to offer additional
features, such as user authentication, protocol conversions, and
local caching of retrieved content. These features add security,
improve response time and access control, and decrease network
usage. </font></p>

<p><font size="2" face="Verdana, Arial, Helvetica">A Web proxy performs
functions associated with both clients and servers. As a server,
it receives WWW requests from private network clients; as a
client, it responds to private network clients&#146; requests by
issuing the appropriate requests to a WWW server on the Internet.
The interface between the client and server components of the Web
Proxy Service provides opportunities to add value to the
connections it services. By increasing security and functionality
for client connections, the Web Proxy Service do much more that
simply relay data for between servers and clients. </font></p>

<p><font size="2" face="Verdana, Arial, Helvetica">The Web Proxy Service
runs as an extension to Microsoft Internet Information Server
(IIS) version&nbsp;2.0. It is implemented as a dynamic-link
library (DLL) that uses the Internet Server Application
Programming Interface (ISAPI), and therefore runs within the
process of the IIS WWW service. </font></p>

<p><font size="2" face="Verdana, Arial, Helvetica">The WWW service must be
installed and running in order for proxy requests to be
processed. Because all proxy requests for Web, Gopher, or FTP
resources are sent from the client to the proxy by using the HTTP
protocol, it is both convenient and efficient for the IIS WWW
service to receive these requests and pass them on to the Web
Proxy Service DLL by means of the ISAPI interface. </font></p>

<p><font size="2" face="Verdana, Arial, Helvetica"><strong>Note</strong>&nbsp;&nbsp;&nbsp;In
order to install Microsoft Proxy Server, you must have both
Windows&nbsp;NT Server&nbsp;4.0 and Internet Information
Server&nbsp;2.0 installed. For more information on installing
either of these products, see the product documentation.</font></p>

<p><font size="2" face="Verdana, Arial, Helvetica">Functionally, the Web
Proxy Service consists of two components, the Proxy ISAPI Filter
and the Proxy ISAPI application. </font></p>

<p align="left"><font size="2" face="Verdana, Arial, Helvetica"><img
src="xag_f05.gif" width="465" height="208"></font></p>

<h3><a href="#Top"><font size="2" face="Verdana, Arial, Helvetica"><img
src="up.gif" alt="To Top" align="middle" border="0" width="14"
height="11"></font></a><a name="1h3"><font size="2"
face="Verdana, Arial, Helvetica">Proxy ISAPI Filter </font></a></h3>

<p><font size="2" face="Verdana, Arial, Helvetica">The ISAPI filter
interface allows for registration of an extension that the Web
server calls whenever it receives an HTTP request from a client.
An ISAPI filter is called for every request, regardless of such
details as the identity of the resource requested in the URL.
Thus, an ISAPI filter can monitor, log, modify, redirect, or
authenticate requests sent to the Web server. </font></p>

<p><font size="2" face="Verdana, Arial, Helvetica">The process of calling
an ISAPI filter in an HTTP request can be described as follows:</font></p>

<ol>
    <li><font size="2" face="Verdana, Arial, Helvetica">The HTTP client
        browser forms and passes a URL request on to the network
        for forwarding to a server running IIS.</font></li>
    <li><font size="2" face="Verdana, Arial, Helvetica">The IIS server
        receives the request and calls an ISAPI filter DLL.</font></li>
    <li><font size="2" face="Verdana, Arial, Helvetica">The ISAPI filter
        DLL loads and registers with the WWW service.</font></li>
    <li><font size="2" face="Verdana, Arial, Helvetica">The request is
        filtered for notification points (such as monitor, log,
        modify, redirect, or authenticate requests).</font></li>
    <li><font size="2" face="Verdana, Arial, Helvetica">The request is
        then forwarded back to the WWW service for response
        action.</font></li>
    <li><font size="2" face="Verdana, Arial, Helvetica">A response is
        issued by the WWW service and the ISAPI filter DLL is
        called again.</font></li>
    <li><font size="2" face="Verdana, Arial, Helvetica">The response is
        filtered for notification points (monitoring, logging,
        and so on).</font></li>
    <li><font size="2" face="Verdana, Arial, Helvetica">The response is
        then returned to the client.</font></li>
</ol>

<p><font size="2" face="Verdana, Arial, Helvetica">The WWW service can
call the ISAPI filter DLL&#146;s entry point at various times
during a request-and-response sequence. When the ISAPI filter is
loaded, it programmatically registers the notification points in
which it is interested. The WWW service then starts calling the
ISAPI filter DLL&#146;s entry point at each requested
notification point for each HTTP request. </font></p>

<p><font size="2" face="Verdana, Arial, Helvetica"><strong>Note</strong>&nbsp;&nbsp;&nbsp;For
more information about:</font></p>

<ul>
    <li><font size="2" face="Verdana, Arial, Helvetica">The ISAPI filter
        interface, see the <i>ActiveX Development Kit</i>,
        available at </font><a
        href="http://www.microsoft.com/intdev/"><font size="2"
        face="Verdana, Arial, Helvetica">http://www.microsoft.com/intdev/</font></a><font
        size="2" face="Verdana, Arial, Helvetica">.</font></li>
    <li><font size="2" face="Verdana, Arial, Helvetica">The ISAPI
        interface and the IIS WWW service, see the <i>Installation
        and Administration Guide</i> For Microsoft Internet
        Information Server, an online guide installed with the
        product.</font></li>
</ul>

<p><font size="2" face="Verdana, Arial, Helvetica">The Proxy ISAPI filter
is contained within an additional DLL (W3proxy.dll) that examines
each request to determine if the request is either a proxy
request or a standard HTTP request. </font></p>

<p><font size="2" face="Verdana, Arial, Helvetica">It registers itself to
use the SF_NOTIFY_PREPROC_HEADERS notification point, because
when called at this notification point for a request, the Proxy
ISAPI filter can see the URL sent by the client (and can modify
the URL), before the Web server processes the request. </font></p>

<p><font size="2" face="Verdana, Arial, Helvetica">Once the Proxy ISAPI
filter examines each request, it can modify the header in one of
the following ways:</font></p>

<ul>
    <li><p align="left"><font size="2" face="Verdana, Arial, Helvetica">If
        the request is a proxy request&#151;that is, if the
        request contains a URL complete with protocol and domain
        name as described in </font><a href="#3h2"><font size="2"
        face="Verdana, Arial, Helvetica">The CERN-Proxy Protocol,</font></a><font
        size="2" face="Verdana, Arial, Helvetica"> earlier in this
        chapter&#151;the Proxy ISAPI filter adds the name of the
        Proxy ISAPI application (W3proxy.dll) to the URL. This
        causes the WWW service to forward the request to the
        Proxy ISAPI application for processing. </font></p>
    </li>
    <li><font size="2" face="Verdana, Arial, Helvetica">If the request is
        not a proxy request&#151;that is, if the request does not
        contain a protocol and a domain name&#151;then the
        request is assumed to be for a Web resource on a Web
        server. The Proxy ISAPI filter does not modify the
        request, allowing ordinary Web publishing to occur
        between the Web server and client.<br>
        <br>
        </font></li>
</ul>

<h3><a href="#Top"><font size="2" face="Verdana, Arial, Helvetica"><img
src="up.gif" alt="To Top" align="middle" border="0" width="14"
height="11"></font></a><a name="2h3"><font size="2"
face="Verdana, Arial, Helvetica">Proxy ISAPI Application</font></a></h3>

<p><font size="2" face="Verdana, Arial, Helvetica">The ISAPI application
interface uses an in-process mechanism to extend Web server
functionality. Unlike Common Gateway Interface (CGI), another
mechanism for extending Web server functionality, an ISAPI
application does not initiate a new process for every request.
ISAPI applications can create dynamic HTML and integrate the Web
with other service applications, such as databases. </font></p>

<p><font size="2" face="Verdana, Arial, Helvetica">An ISAPI application
DLL loads once; thereafter, the Web server calls the DLL whenever
it receives a client request for that application. The Proxy
ISAPI application is contained within W3proxy.dll, which also
contains the Proxy ISAPI filter. Because both application and
filter reside in W3proxy.dll, all necessary initialization for
both is done when the server is started. </font></p>

<p><font size="2" face="Verdana, Arial, Helvetica">Every time it receives
a request, the Proxy ISAPI application does the following: </font></p>

<ol>
    <li><font size="2" face="Verdana, Arial, Helvetica">Authenticates the
        client. </font></li>
    <li><font size="2" face="Verdana, Arial, Helvetica">Applies the domain
        filter. </font></li>
    <li><font size="2" face="Verdana, Arial, Helvetica">Looks for objects
        in the cache and returns objects from there, first
        checking that the cached object is current to its source.
        </font></li>
    <li><font size="2" face="Verdana, Arial, Helvetica">Gets the objects
        from the Internet, sends them to the client, and adds
        them to the cache if appropriate. </font></li>
</ol>

<p><font size="2" face="Verdana, Arial, Helvetica">If a request is valid,
and it is necessary to issue the request to an Internet site, the
ISAPI application parses the URL to extract the protocol
(typically HTTP, FTP, or Gopher), and the domain name. For HTTP
requests, the ISAPI application calls the appropriate Windows
Sockets APIs directly to process file requests. </font></p>

<p><font size="2" face="Verdana, Arial, Helvetica">For HTTP requests, all
input/output (I/O) is done asynchronously after the domain name
has been resolved. If possible, the Domain Name System (DNS) is
used to resolve the domain name. (DNS is used to resolve Internet
or UNIX system names. Microsoft TCP/IP includes DNS support.) </font></p>

<p><font size="2" face="Verdana, Arial, Helvetica">Issuing the request to
the Internet site includes the following steps: </font></p>

<ol>
    <li><font size="2" face="Verdana, Arial, Helvetica">Resolve the domain
        name to an IP address (if possible, the DNS cache is
        used). </font></li>
    <li><font size="2" face="Verdana, Arial, Helvetica">Connect to the
        remote site. </font></li>
    <li><font size="2" face="Verdana, Arial, Helvetica">Send the request
        to the remote site. </font></li>
    <li><font size="2" face="Verdana, Arial, Helvetica">Receive the
        response header from remote site. </font></li>
    <li><font size="2" face="Verdana, Arial, Helvetica">Receive the data
        (send to the client and save in the cache). </font></li>
</ol>

<p><font size="2" face="Verdana, Arial, Helvetica">The ISAPI Proxy
application uses a small set of reusable worker threads and
asynchronous I/O to achieve very high performance. An
Asynchronous Thread Queue (ATQ) and the TransmitFile API further
enhance thread efficiency. The Proxy ISAPI application benefits
from the high performance and scalability built into IIS, as well
as its own architecture. </font></p>

<h3><a href="#Top"><font size="2" face="Verdana, Arial, Helvetica"><img
src="up.gif" alt="To Top" align="middle" border="0" width="14"
height="11"></font></a><a name="4h3"><font size="2"
face="Verdana, Arial, Helvetica"><strong>Advantages of the Web Proxy
Service</strong></font></a></h3>

<p><font size="2" face="Verdana, Arial, Helvetica">By running as an ISAPI
application, the Microsoft Proxy Server benefits from many other
functional and performance features of IIS. An example is the Web
server&#146;s support for HTTP Keep-Alives. </font></p>

<p><font size="2" face="Verdana, Arial, Helvetica">Keep-Alives is a
feature that when supported by both browser and server allows TCP
connections to remain intact after a request and response are
completed. This significantly improves performance if another
request is made from the same client to the same server within a
time limit for connections. Support for Keep-Alives requires that
the Web server be able to return the byte size of responses to
clients, and that time outs are used by client and server so as
to efficiently manage Windows Sockets connections. </font></p>

<p><font size="2" face="Verdana, Arial, Helvetica">Because individual Web
pages can often contain numerous links to separate graphic image
files on the Web server, Keep-Alives can often improve
performance for non-proxy environments. The speed with which Web
page contents can be accessed is vastly improved, even when
another HTML page is not requested.</font></p>

<p><font size="2" face="Verdana, Arial, Helvetica">For a Microsoft Proxy
Server, the Keep-Alives mechanism is much more valuable. In a
typical scenario, a company has a small number of computers
running Microsoft Proxy Server for Internet access. Every attempt
within the company to access Internet Web, Gopher, and FTP sites
requires a connection from a browser on the internal network to
the Microsoft Proxy Server. The probability of reusing a
connection between the same client and the same Microsoft Proxy
Server, is very high. For Internet Explorer version&nbsp;3.0,
support for Keep-Alives to a proxy server is a feature.</font></p>

<h2><a href="#Top"><font size="2" face="Verdana, Arial, Helvetica"><img
src="up.gif" alt="To Top" align="middle" border="0" width="14"
height="11"></font></a><a name="5h2"><font size="2"
face="Verdana, Arial, Helvetica">Caching Mechanisms</font></a></h2>

<blockquote>
    <p><a href="#30h3"><font size="2" face="Verdana, Arial, Helvetica">About
    Caching</font></a><font size="2" face="Verdana, Arial, Helvetica"><br>
    </font><a href="#31h3"><font size="2" face="Verdana, Arial, Helvetica">Passive
    Caching</font></a><font size="2" face="Verdana, Arial, Helvetica"><br>
    </font><a href="#32h3"><font size="2" face="Verdana, Arial, Helvetica">Active
    Caching</font></a></p>
</blockquote>

<h3><a href="#Top"><font size="2" face="Verdana, Arial, Helvetica"><img
src="up.gif" alt="To Top" align="middle" border="0" width="14"
height="11"></font></a><a name="30h3"><font size="2"
face="Verdana, Arial, Helvetica">About Caching</font></a></h3>

<p><font size="2" face="Verdana, Arial, Helvetica">The Web Proxy Service
uses caching to maintain a local copy of HTTP objects. This
allows subsequent requests for these objects to be serviced from
a local disk copy, rather than issuing the request over the
Internet, thereby improving user-perceived performance and
reducing bandwidth consumption on the site&#146;s Internet
connection. </font></p>

<p><font size="2" face="Verdana, Arial, Helvetica">Not all objects that
pass through Web Proxy Service can or should be cached. Some
objects are dynamic and change frequently, some change every time
they are accessed. Other objects require authentication of the
requesting client and cannot be cached for security reasons. </font></p>

<p><font size="2" face="Verdana, Arial, Helvetica">A Web object must
satisfy the following criteria in order to be cached: </font></p>

<ul>
    <li><font size="2" face="Verdana, Arial, Helvetica">The request must
        be a GET. </font></li>
    <li><font size="2" face="Verdana, Arial, Helvetica">There may be no <tt>?</tt>
        keywords, which are typically used for basic logons. </font></li>
    <li><font size="2" face="Verdana, Arial, Helvetica">The file must be
        served by the HTTP protocol (objects associated with
        other protocols are not cached). </font></li>
    <li><font size="2" face="Verdana, Arial, Helvetica">The HTTP response
        header must not include <code>WWW-Authenticate</code>, <code>Pragma:
        no-cache</code>, <code>Cache-control: Private</code>, <code>Cache-control:
        no-cache</code>, or <code>Set-Cookie</code>.</font></li>
    <li><font size="2" face="Verdana, Arial, Helvetica">The date in the
        Expires: header field must be later than the one in the
        Date: header. The Expires: header is used in all HTTP
        requests to indicate a date and time for the request to
        expire on the network.The Date: header is used to
        indicate the date and time that the Web server received
        the request. Both fields are generically returned in
        almost all HTTP requests. Some Web servers indicate to
        downstream caches that a page should not be cached by
        setting the Expires: header equal to the Date: header,
        indicating that the page expires immediately. Also,
        setting this field to &#147;Expires: 0&#148; will prevent
        caching as well. </font></li>
    <li><font size="2" face="Verdana, Arial, Helvetica">The HTTP Result
        code must be 200 (success). </font></li>
    <li><font size="2" face="Verdana, Arial, Helvetica">The object must
        not be encrypted or protected by Secure Sockets Layer
        (SSL). </font></li>
    <li><font size="2" face="Verdana, Arial, Helvetica">There cannot be an
        <code>Authorization</code> header in the HTTP request
        header, or <code>Vary</code> in the response header. </font></li>
</ul>

<p><font size="2" face="Verdana, Arial, Helvetica">The HTTP header may
include &#147;cookies,&#148; which allow a server to customize a
response for a particular user. Cookies are increasingly used for
custom pages or for informal (that is, not very secure)
authentication. Microsoft Proxy Server will treat cookies as
another optional HTTP header that will be disregarded, with the
exception of the <tt>Set-Cookie</tt> header. It will be assumed
that subsequent transactions after the cookie has been set can be
cached, unless any of the subsequent objects requested include
headers with cache ineligible exception values based on the
criteria in the preceding list. </font></p>

<p><font size="2" face="Verdana, Arial, Helvetica">Microsoft Proxy Server
caches data by means of two different types of caching processes:
passive caching and active caching. The remainder of this section
discusses each of these processes in further detail. </font></p>

<h3><a href="#Top"><font size="2" face="Verdana, Arial, Helvetica"><img
src="up.gif" alt="To Top" align="middle" border="0" width="14"
height="11"></font></a><a name="31h3"><font size="2"
face="Verdana, Arial, Helvetica">Passive Caching</font></a></h3>

<p><font size="2" face="Verdana, Arial, Helvetica">Passive caching, also
referred to as &#147;on-demand&#148; caching, is the most basic
mode of caching. The following figure depicts passive caching. </font></p>

<p align="left"><font size="2" face="Verdana, Arial, Helvetica"><img
src="xag_f01.gif" width="467" height="267"></font></p>

<p><font size="2" face="Verdana, Arial, Helvetica">Microsoft Proxy Server
interposes itself between the client and local or remote Web and
intercepts requests (for example, HTTP GET requests) from the
client. Before forwarding the request on to the Web, Microsoft
Proxy Server first calls into its cache (Urlcache.dll) to
determine if the cache can satisfy the request by using the
RetrieveUrlFile API. If the data is in the cache and has not
expired, it is returned immediately to the client by using the
Windows Sockets TransmitFile API. </font></p>

<p><font size="2" face="Verdana, Arial, Helvetica">If the object is not
cached or if the cached copy of the object has expired, Microsoft
Proxy Server retrieves the object from the Web, returns it to the
user, and inserts it into the cache (by using the CreateUrlFile
and CacheUrlFile APIs). If the local disk space reserved for the
cache is too full to hold the new data, older objects are removed
from the cache using a formula that evaluates age, popularity,
and size. </font></p>

<p><font size="2" face="Verdana, Arial, Helvetica">The Microsoft Proxy
Server cache APIs are documented in the <i>ActiveX Development
Kit,</i> available at </font><a
href="http://www.microsoft.com/intdev/"><font size="2"
face="Verdana, Arial, Helvetica">http://www.microsoft.com/intdev/</font></a><font
size="2" face="Verdana, Arial, Helvetica">. </font></p>

<h3><a href="#Top"><font size="2" face="Verdana, Arial, Helvetica"><img
src="up.gif" alt="To Top" align="middle" border="0" width="14"
height="11"></font></a><a name="32h3"><font size="2"
face="Verdana, Arial, Helvetica">Active Caching</font></a></h3>

<p><font size="2" face="Verdana, Arial, Helvetica">Microsoft Proxy Server
uses active caching to improve the retrieval performance by
increasing the likelihood that a requested object will be found
in the cache. Active caching works as a superset to passive
caching.</font></p>

<p><font size="2" face="Verdana, Arial, Helvetica">Typically, in <i>passive</i>
caching, an object is placed in the cache and a Time-To-Live
(TTL) expiration value is associated with that object. During
this TTL, all requests for the object are serviced from the cache
without generating traffic back to the upstream Web server. After
the TTL has expired, subsequent client requests for the object
will generate traffic to and from the Web server. The response
from the server will be stored in the cache and a new TTL will be
calculated.</font></p>

<p><font size="2" face="Verdana, Arial, Helvetica"><i>Active</i> caching
augments this system by having the server automatically generate
requests for a specified subset of objects. Microsoft Proxy
Server optimizes the choice of objects for active caching on the
basis of the following qualities:</font></p>

<ul>
    <li><p align="left"><font size="2" face="Verdana, Arial, Helvetica"><b>Popularity&nbsp;&nbsp;&nbsp;</b>Ensures
        that requests made by Microsoft Proxy Server are likely
        to be requested by clients as well. </font></p>
    </li>
    <li><p align="left"><font size="2" face="Verdana, Arial, Helvetica"><b>TTL&nbsp;&nbsp;&nbsp;</b>Longer
        TTLs are more valuable to cache than shorter TTLs;
        Microsoft Proxy Server will also check objects that are
        close to expiration. </font></p>
    </li>
    <li><p align="left"><font size="2" face="Verdana, Arial, Helvetica"><b>Server
        load&nbsp;&nbsp;&nbsp;</b>Microsoft Proxy Server performs
        more aggressive active caching during periods of low
        server load than when the server is heavily loaded. </font></p>
    </li>
</ul>

<p><font size="2" face="Verdana, Arial, Helvetica">Active caching results
in:</font></p>

<ul>
    <li><p align="left"><font size="2" face="Verdana, Arial, Helvetica"><b>Better
        Client Performance</b>&nbsp;&nbsp;&nbsp;Clients are more
        likely to find their URL in the cache, resulting in lower
        latency (the amount of time clients wait for a response)
        and better throughput. </font></p>
    </li>
    <li><p align="left"><font size="2" face="Verdana, Arial, Helvetica"><b>Even
        Load Distribution&nbsp;&nbsp;&nbsp;</b>Active caching has
        the effect of balancing the request load for the server
        across time, by rescheduling some cache update requests
        from high-peak periods of server activity to off-peak
        periods. </font></p>
    </li>
    <li><p align="left"><font size="2" face="Verdana, Arial, Helvetica"><b>More
        Accurate Data&nbsp;&nbsp;&nbsp;</b>By checking unexpired
        objects during off-peak periods, the likelihood of
        returning stale data to clients is reduced. </font></p>
    </li>
</ul>

<hr>

<h1><a href="#Top"><font size="2" face="Verdana, Arial, Helvetica"><img
src="up.gif" alt="To Top" align="middle" border="0" width="14"
height="11"></font></a><a name="3h1"><font size="2"
face="Verdana, Arial, Helvetica">How the WinSock Proxy Service Works</font></a></h1>

<blockquote>
    <p><a href="#30h2"><font size="2" face="Verdana, Arial, Helvetica">Understanding
    Windows Sockets and WinSock Proxy</font></a><font size="2"
    face="Verdana, Arial, Helvetica"><br>
    </font><a href="#31h2"><font size="2" face="Verdana, Arial, Helvetica">WinSock
    Proxy Architecture</font></a><font size="2"
    face="Verdana, Arial, Helvetica"><br>
    </font><a href="#32h2"><font size="2" face="Verdana, Arial, Helvetica">Windows
    Sockets APIs</font></a><font size="2" face="Verdana, Arial, Helvetica"><br>
    </font><a href="#33h2"><font size="2" face="Verdana, Arial, Helvetica">WinSock
    Proxy Limitations</font></a><font size="2"
    face="Verdana, Arial, Helvetica"><br>
    </font></p>
</blockquote>

<h2><a href="#Top"><font size="2" face="Verdana, Arial, Helvetica"><img
src="up.gif" alt="To Top" align="middle" border="0" width="14"
height="11"></font></a><a name="30h2"><font size="2"
face="Verdana, Arial, Helvetica">Understanding Windows Sockets and WinSock
Proxy</font></a></h2>

<blockquote>
    <p><a href="#301h3"><font size="2" face="Verdana, Arial, Helvetica">About
    Windows Sockets</font></a><font size="2"
    face="Verdana, Arial, Helvetica"><br>
    </font><a href="#302h3"><font size="2"
    face="Verdana, Arial, Helvetica">About WinSock Proxy</font></a></p>
</blockquote>

<h3><a href="#Top"><font size="2" face="Verdana, Arial, Helvetica"><img
src="up.gif" alt="To Top" align="middle" border="0" width="14"
height="11"></font></a><a name="301h3"><font size="2"
face="Verdana, Arial, Helvetica">About Windows Sockets</font></a></h3>

<p><font size="2" face="Verdana, Arial, Helvetica">Windows Sockets is a
mechanism for interprocess communication between network
applications running on the same computer, or on different
computers connected using a local area network (LAN) or wide area
network (WAN). It defines a set of standard APIs that an
application uses to communicate with one or more other
applications, usually across a network.</font></p>

<p><font size="2" face="Verdana, Arial, Helvetica">The Windows Sockets
APIs support:</font></p>

<ul>
    <li><font size="2" face="Verdana, Arial, Helvetica">Initiating an
        outbound connection for a client application.</font></li>
    <li><font size="2" face="Verdana, Arial, Helvetica">Accepting an
        inbound connection for server application.</font></li>
    <li><font size="2" face="Verdana, Arial, Helvetica">Sending and
        receiving data on a client/server connection. </font></li>
    <li><font size="2" face="Verdana, Arial, Helvetica">Terminating a
        client/server connection.</font></li>
</ul>

<p><font size="2" face="Verdana, Arial, Helvetica">The specification
includes a standard set of APIs supported by all Windows-based
TCP/IP protocol stacks, and to be used by network applications.
Support for other transport protocols is included in Windows
Sockets with some implementations supporting IPX/SPX and NetBEUI
protocols. </font></p>

<p><font size="2" face="Verdana, Arial, Helvetica">In Windows Sockets,
application communications channels are represented by data
structures called <em>sockets</em>. A socket is identified by two
items: </font></p>

<ul>
    <li><font size="2" face="Verdana, Arial, Helvetica">An IP address</font></li>
    <li><font size="2" face="Verdana, Arial, Helvetica">A port number</font></li>
</ul>

<p><font size="2" face="Verdana, Arial, Helvetica">Windows Sockets can
support both point-to-point connected service (also referred to
as stream-oriented communications), and multipoint connectionless
service (referred to as datagram-oriented communications). When
using the TCP/IP protocol suite, stream-oriented communications
use TCP and datagram-oriented communications use UDP. </font></p>

<h4><a name="ConnectedServiceusingTCPSockets"><font size="2"
face="Verdana, Arial, Helvetica"><strong>Connected Service using TCP
Sockets</strong></font></a></h4>

<p><font size="2" face="Verdana, Arial, Helvetica">Most Internet
application protocols, including HTTP, Gopher, and FTP, are
connection-oriented client/server protocols. A client typically
initiates a connection to a server in order to process a specific
client request. A server waits for connections initiated by
clients, accepts those connections, and begins communicating with
each client following the rules of the specific application
protocol. Communications managed expressly between a server and
its clients in this manner form what is known as <em>connected
service</em>. </font></p>

<p><font size="2" face="Verdana, Arial, Helvetica">For application
protocols that use connected service, the Transmission Control
Protocol (TCP) has been long established as the transport-level
protocol of choice. TCP supports the use of sockets as well to
form connected communications between computers on a network.</font></p>

<p><font size="2" face="Verdana, Arial, Helvetica">For example, a TCP
socket can be formed by first associating an IP address and a TCP
port. The IP address is a 32-bit number that uniquely identifies
the local IP network interface. The port identifies a virtual
channel used for communications at the TCP level. A
stream-oriented connection is then formed by associating a local
IP address-TCP port pair with a remote IP address-TCP port pair. </font></p>

<p><font size="2" face="Verdana, Arial, Helvetica">A server goes through
the following steps to create a TCP socket with a client: </font></p>

<ul>
    <li><p align="left"><font size="2" face="Verdana, Arial, Helvetica">The
        <b>socket()</b> API is used to establish a socket and
        associate it with a specific streaming protocol, such as
        TCP. </font></p>
    </li>
    <li><p align="left"><font size="2" face="Verdana, Arial, Helvetica">The
        <b>bind()</b> API is used to associate a local IP address
        and port with the socket. Most servers specify that they
        want to bind the socket to all local IP addresses, and
        indicate the well-known port for the application protocol
        (port 80 for HTTP, port 21 for FTP, and so on). </font></p>
    </li>
    <li><p align="left"><font size="2" face="Verdana, Arial, Helvetica">The
        <strong>listen()</strong> API is used to enable inbound
        connections on the IP/port pair. </font></p>
    </li>
    <li><p align="left"><font size="2" face="Verdana, Arial, Helvetica">When
        a client connection is received, the server uses the <strong>accept()</strong>
        API to complete the connection process, associate a
        different socket with the connection, and go back to the
        listening stage on the original socket to handle future
        client connections. </font></p>
    </li>
    <li><p align="left"><font size="2" face="Verdana, Arial, Helvetica">The
        server uses the <b>recv()</b> and <b>send()</b> APIs to
        communicate with the client. </font></p>
    </li>
    <li><p align="left"><font size="2" face="Verdana, Arial, Helvetica">The
        server can use the <b>getsockname()</b> API to query the
        local and remote IP address-port pairs. </font></p>
    </li>
</ul>

<p><font size="2" face="Verdana, Arial, Helvetica">A client typically
initiates a TCP socket connection to a server in order to process
a user request. With stream-oriented TCP connections, the client
executes the following steps: </font></p>

<ul>
    <li><p align="left"><font size="2" face="Verdana, Arial, Helvetica">The
        <b>socket()</b> API is used to establish a socket and
        associate it with a specific streaming protocol, such as
        TCP. </font></p>
    </li>
    <li><p align="left"><font size="2" face="Verdana, Arial, Helvetica">The
        <b>bind()</b> API is used to associate a local IP address
        and port with the socket. Most clients specify that they
        are willing to use any local IP address and port. </font></p>
    </li>
    <li><p align="left"><font size="2" face="Verdana, Arial, Helvetica">The
        <b>connect()</b> API is used to initiate a connection to
        a specified IP address/port pair. The remote IP address
        specified identifies the server, and the port identifies
        the service (80 for HTTP, 21 for FTP, and so on). </font></p>
    </li>
    <li><p align="left"><font size="2" face="Verdana, Arial, Helvetica">The
        client uses the <b>recv()</b> and <b>send()</b> APIs to
        communicate with the server. </font></p>
    </li>
    <li><p align="left"><font size="2" face="Verdana, Arial, Helvetica">The
        client can use the <b>getsockname()</b> API to query the
        local and remote IP address-port pairs. <br>
        <br>
        </font></p>
    </li>
</ul>

<h4><a name="ConnectionlessServiceusingUDPSockets"><font size="2"
face="Verdana, Arial, Helvetica"><strong>Connectionless Service using UDP
Sockets</strong></font></a></h4>

<p><font size="2" face="Verdana, Arial, Helvetica">Some Internet
applications can use User Datagram Protocol (UDP), a transport
protocol that delivers server data in a form that offers higher
throughput performance than TCP. UDP is very effective for
delivering data from servers to clients at the highest possible
speeds by using unacknowledged delivery and packaging data into
small uniform-length packets called <em>datagrams</em>.
Communications that consist of UDP datagrams sent from a server
to clients on a network in this manner form what is known as <em>connectionless
service</em>. This type of service is useful for real-time
applications such as streaming audio and video. For example,
RealAudio and VDOLive both use UDP to offer connectionless
service to clients. </font></p>

<p><font size="2" face="Verdana, Arial, Helvetica">For UDP, the client and
server each establish a UDP socket in the following way:</font></p>

<ul>
    <li><font size="2" face="Verdana, Arial, Helvetica">The <b>socket()</b>
        API is used to establish a socket and associate it with a
        specific datagram protocol, such as UDP. </font></li>
    <li><font size="2" face="Verdana, Arial, Helvetica">The <b>bind()</b>
        API is used to bind the socket to a local IP address-port
        pair. </font></li>
    <li><font size="2" face="Verdana, Arial, Helvetica">The <b>sendto()</b>
        and <b>recvfrom()</b> APIs are then used to begin
        immediately sending and receiving data. These APIs
        specify the IP port to send to, and return the IP port
        received from. </font></li>
</ul>

<p><font size="2" face="Verdana, Arial, Helvetica">While most UDP
implementations consist of a client communicating with a single
server at a time, UDP is a connectionless protocol and supports
communications between a client application and multiple servers
over a single socket. </font></p>

<h3><a href="#Top"><font size="2" face="Verdana, Arial, Helvetica"><img
src="up.gif" alt="To Top" align="middle" border="0" width="14"
height="11"></font></a><a name="302h3"><font size="2"
face="Verdana, Arial, Helvetica">About WinSock Proxy</font></a></h3>

<p><font size="2" face="Verdana, Arial, Helvetica">WinSock Proxy allows a
Windows Sockets application running on a private network client
to perform as though it is directly connected to a remote
Internet server application, when in actuality, the Microsoft
Proxy Server serves as the proxy host for this connection.
WinSock Proxy consists of two parts: a service running on a
gateway computer, and a DLL installed on each client computer. </font></p>

<p><font size="2" face="Verdana, Arial, Helvetica">The WinSock Proxy
service runs on Windows&nbsp;NT Server version&nbsp;4.0 only. It
runs as a stand-alone Windows&nbsp;NT service, and is responsible
for creating virtual connections between internal applications
and Internet applications. The WinSock Proxy service is also
responsible for doing &#147;data pumping&#148; between the two
actual communications channels set up for a virtual connection,
and acting as a TCP/IP protocol gateway if the internal network
runs IPX/SPX. </font></p>

<p><font size="2" face="Verdana, Arial, Helvetica">One of the benefits of
this type of design is that all application-level communications
are channeled through a single secured computer&#151;the gateway
computer running Microsoft Proxy Server. The WinSock Proxy
service can also provide application-level event monitoring for
redirected Windows Sockets applications on the private network. </font></p>

<p><font size="2" face="Verdana, Arial, Helvetica">With WinSock Proxy,
client applications send Windows Sockets APIs to communicate with
server applications running on Internet computers, and the
WinSock Proxy service on the Microsoft Proxy Server intercepts
these calls. The Microsoft Proxy Server then handles redirecting
these APIs to the remote server on the Internet. This establishes
a logical communications path from the internal client
application to the Internet server application by way of the
computer running Microsoft Proxy Server.</font></p>

<p><font size="2" face="Verdana, Arial, Helvetica">The gateway process is
not visible to either the internal network client or the remote
server. Both client and server computers appear to share only a
single connection to each other. In truth, both maintain separate
connections to the computer running Microsoft Proxy Server
through separate network hardware interfaces on the computer
running Microsoft Proxy Server.</font></p>

<p><font size="2" face="Verdana, Arial, Helvetica">There are some side
effects to using the proxy server to access the Internet. </font></p>

<ul>
    <li><font size="2" face="Verdana, Arial, Helvetica">External servers
        see different users coming from the same address.</font></li>
    <li><font size="2" face="Verdana, Arial, Helvetica">A client
        application that binds a socket to a specific port may
        fail when the requested port is already assigned to
        another client. To avoid this, the client software can
        either request PORT_ANY (0), or try a range of ports when
        a bind fails with the error WSAEADDRINUSE. (Note that the
        socket option SO_REUSEADDR will not work in this case.)</font></li>
</ul>

<p><font size="2" face="Verdana, Arial, Helvetica">The WinSock Proxy
service offers client and server support for most standard and
custom Internet applications that communicate using Windows
Sockets&nbsp;1.1. Almost all Windows Sockets&nbsp;1.1 TCP/IP
applications can be redirected using WinSock Proxy. However,
redirection of Windows Sockets&nbsp;2.0 APIs or applications is
not supported at this time. The WinSock Proxy service works with
Windows-based TCP/IP applications on the private network, and any
TCP/IP applications platform on the Internet. </font></p>

<h2><a href="#Top"><font size="2" face="Verdana, Arial, Helvetica"><img
src="up.gif" alt="To Top" align="middle" border="0" width="14"
height="11"></font></a><a name="31h2"><font size="2"
face="Verdana, Arial, Helvetica">WinSock Proxy Architecture</font></a></h2>

<blockquote>
    <p><a href="#311h2"><font size="2" face="Verdana, Arial, Helvetica">WinSock
    Proxy Client Components</font></a><font size="2"
    face="Verdana, Arial, Helvetica"><br>
    </font><a href="#312h2"><font size="2"
    face="Verdana, Arial, Helvetica">WinSock Proxy Control Channel</font></a><font
    size="2" face="Verdana, Arial, Helvetica"><br>
    </font><a href="#313h2"><font size="2"
    face="Verdana, Arial, Helvetica">TCP Redirection</font></a><font
    size="2" face="Verdana, Arial, Helvetica"><br>
    </font><a href="#314h2"><font size="2"
    face="Verdana, Arial, Helvetica">UPD Redirection</font></a><font
    size="2" face="Verdana, Arial, Helvetica"><br>
    </font><a href="#315h2"><font size="2"
    face="Verdana, Arial, Helvetica">Using TCP/IP on the Internal Network</font></a><font
    size="2" face="Verdana, Arial, Helvetica"><br>
    </font><a href="#316h2"><font size="2"
    face="Verdana, Arial, Helvetica">Using IPX/SPX on the Internal Network</font></a></p>
</blockquote>

<h3><a href="#Top"><font size="2" face="Verdana, Arial, Helvetica"><img
src="up.gif" alt="To Top" align="middle" border="0" width="14"
height="11"></font></a><a name="311h2"><font size="2"
face="Verdana, Arial, Helvetica">WinSock Proxy Client Components</font></a></h3>

<p><font size="2" face="Verdana, Arial, Helvetica">On client computers,
the WinSock Proxy uses a specially designed DLL to redirect
Windows Sockets API calls from the client to remote servers. When
this DLL is installed, it renames the standard Windows Sockets
DLLs, and the WinSock Proxy DLL is given the name of the
corresponding Windows Sockets DLL (Winsock.dll for 16-bit;
Wsock32.dll for 32-bit). This results in all Windows Sockets API
calls being forwarded to the WinSock Proxy DLL first, and then
the WinSock Proxy DLL redirecting calls to the renamed Windows
Sockets DLL as needed, or processing the call itself.</font></p>

<p><font size="2" face="Verdana, Arial, Helvetica">Once the WinSock Proxy
DLL is actively installed on the client, it intercepts all
Windows Sockets API calls made by applications on the client
computer. Depending on the API, and the current socket status,
the client WinSock Proxy DLL may:</font></p>

<ul>
    <li><p align="left"><font size="2" face="Verdana, Arial, Helvetica">Completely
        process the client&#146;s request. </font></p>
    </li>
    <li><font size="2" face="Verdana, Arial, Helvetica">Pass the request
        to the (renamed) actual Windows Sockets DLL on the local
        computer (after possibly making changes to the request).</font></li>
</ul>

<blockquote>
    <p><font size="2" face="Verdana, Arial, Helvetica">&#150;Or&#150;</font></p>
</blockquote>

<ul>
    <li><font size="2" face="Verdana, Arial, Helvetica">Need to pass
        control information (by use of the WinSock Proxy Control
        Channel) to the WinSock Proxy service on the computer
        running Microsoft Proxy Server. </font></li>
</ul>

<p><font size="2" face="Verdana, Arial, Helvetica">For network
communication between local applications on the internal network,
the WinSock Proxy client DLL passes Windows Sockets API calls to
the previously installed (and renamed) Windows Sockets DLL. This
allows Windows Sockets communications to continue to work
normally. Also, this is true regardless of whether the previous
Windows Sockets DLL was obtained from a third-party TCP/IP stack
or directly from Microsoft. In all cases, the Windows Sockets DLL
that was installed prior to WinSock Proxy client setup is
maintained for forwarding local network calls.</font></p>

<p><font size="2" face="Verdana, Arial, Helvetica">There are two versions
of the WinSock Proxy client DLL: a 16-bit version and a 32-bit
version. The 16-bit version is installed on Windows&nbsp;3.1 and
Windows For Workgroups&nbsp;3.11. The 32-bit version is installed
on Windows&nbsp;NT. Both versions are installed on
Windows&nbsp;95. </font></p>

<h3><a href="#Top"><font size="2" face="Verdana, Arial, Helvetica"><img
src="up.gif" alt="To Top" align="middle" border="0" width="14"
height="11"></font></a><a name="312h2"><font size="2"
face="Verdana, Arial, Helvetica">WinSock Proxy Control Channel</font></a></h3>

<p><font size="2" face="Verdana, Arial, Helvetica">The WinSock Proxy
service and client DLLs communicate by using a control channel
that is set up when the client DLL is first loaded. The control
channel uses the connectionless UDP protocol. UDP allows a single
socket on the gateway computer to be used for communications with
all WinSock Proxy clients, and is faster than TCP. A simple
acknowledgment protocol is used between WinSock Proxy client and
service to add reliability to the control channel. </font></p>

<p><font size="2" face="Verdana, Arial, Helvetica">The goal is to use the
control channel as infrequently as possible, and to have as few
Windows Sockets APIs that require special processing on the
client computer as possible. For example, for TCP connection
requests, the control channel is used to set up the virtual
connection, but once the connection is set up, sending and
receiving data (<b>send()</b> and <b>recv()</b> APIs) requires no
special processing on the client: the WinSock Proxy DLL simply
forwards these requests to the (renamed) Windows Sockets DLL.
This also means that the Win32 APIs ReadFile and WriteFile, which
bypass Windows Sockets, will work with redirected connections. </font></p>

<p><font size="2" face="Verdana, Arial, Helvetica">The WinSock Proxy
control channel is used for the following purposes: </font></p>

<ul>
    <li><font size="2" face="Verdana, Arial, Helvetica"><b>To set up TCP
        connections for WinSock Proxy clients to remote servers</b></font><p><font
        size="2" face="Verdana, Arial, Helvetica">When a connection with a
        remote application is being established, the control
        channel is used in establishing the virtual connection.
        Once the connection is established, sending and receiving
        data will not require use of the control channel. </font></p>
    </li>
    <li><font size="2" face="Verdana, Arial, Helvetica"><b>To maintain UDP
        communications between WinSock Proxy clients and WinSock
        Proxy servers</b></font><p><font size="2"
        face="Verdana, Arial, Helvetica">The control channel is used by
        WinSock Proxy clients to contact the WinSock Proxy server
        when the UDP socket is bound. Additionally, in order to
        support multiple remote applications communicating with
        the internal application, port-mapping information is
        sent to the client DLL each time a new remote peer sends
        data. Sending and receiving data to and from known peers
        does not require the control channel. </font></p>
    </li>
    <li><font size="2" face="Verdana, Arial, Helvetica"><b>To manage
        database requests between WinSock Proxy clients and
        WinSock Proxy servers</b> </font><p><font size="2"
        face="Verdana, Arial, Helvetica">Redirection of the Windows
        Sockets database requests, such as DNS name resolution (<b>gethostbyname()</b>,
        and so on) is handled by passing the client request to
        the WinSock Proxy service by using the control channel,
        and the response is forwarded to the client DLL by using
        the control channel. </font></p>
    </li>
</ul>

<p><font size="2" face="Verdana, Arial, Helvetica">When the first
application on a client attempts to make its first Windows
Sockets connection, the WinSock Proxy DLL is loaded and
initialized. At this time, the WinSock Proxy DLL does the
following:</font></p>

<ol>
    <li><p align="left"><font size="2" face="Verdana, Arial, Helvetica">It
        establishes its own WinSock Proxy control channel with
        the WinSock Proxy service, and notifies the service, by
        using the control channel, that it is active. </font></p>
    </li>
    <li><font size="2" face="Verdana, Arial, Helvetica">The WinSock Proxy
        service then downloads the Local Address Table (LAT). The
        LAT is a routing table that consists of a list of IP
        address pairs, each pair indicating a range of addresses
        located on the internal (private) network. The LAT is
        used by the client to determine which requests need to be
        redirected. </font><p><font size="2"
        face="Verdana, Arial, Helvetica"><b>Note&nbsp;&nbsp;&nbsp;</b>Routing
        information is updated by copying files over the network
        using Windows&nbsp;NT file sharing protocols (server
        message block, or SMB). The control channel is not used
        for this purpose. </font></p>
    </li>
</ol>

<p><font size="2" face="Verdana, Arial, Helvetica"><strong>Note</strong>&nbsp;&nbsp;&nbsp;LAT
information is stored in the Msplat.txt file, located by default
at C:\Msp\clients. It is initially configured by the Microsoft
Proxy Server <b>Setup</b> program. It can be modified or changed
later by using Internet Service Manager.</font></p>

<p><font size="2" face="Verdana, Arial, Helvetica">Once the WinSock Proxy
DLL has initialized service, for future connection attempts by
applications, the WinSock Proxy DLL attempts to determine if the
application is trying to communicate with a local computer
(private network) or remote computer (Internet). </font></p>

<p><font size="2" face="Verdana, Arial, Helvetica">For connection attempts
and Windows Sockets APIs destined for a local computer, the
WinSock Proxy DLL simply forwards the API calls to the (renamed)
Windows Sockets DLL, for normal processing. If a Windows Sockets
API call contains no information about the destination (and
therefore no indication as to whether it should be redirected),
the WinSock Proxy component assumes it is a local request, and
forwards the request to the standard Windows Sockets DLL. </font></p>

<p><font size="2" face="Verdana, Arial, Helvetica">When a Windows Sockets
database API is called by an application (<b>gethostbyname()</b>,
and so on) to resolve an Internet name or address, the WinSock
Proxy components work together, using the control channel, to
redirect the request to the gateway computer, and have the
request processed on the Internet. </font></p>

<p><font size="2" face="Verdana, Arial, Helvetica">The architecture of
WinSock Proxy requires special processing by the client&#146;s
WinSock Proxy DLL when establishing a connection with an Internet
site, but once a communication channel is established, standard
Windows Sockets and Win32 APIs for reading and writing a socket
or file can be used with no special processing on the client. The
application performs as if it is reading and writing to the
Internet site, while it is actually communicating with the
WinSock Proxy service, which forwards the requests. </font></p>

<p><font size="2" face="Verdana, Arial, Helvetica">The WinSock Proxy
control channel uses UDP port number 1745 on the WinSock Proxy
server and client computers. </font></p>

<p><font size="2" face="Verdana, Arial, Helvetica">The following
illustration depicts the WinSock Proxy components on an IPX/SPX
private network. </font></p>

<p align="left"><font size="2" face="Verdana, Arial, Helvetica"><img
src="xag_e02.gif" width="425" height="252"></font></p>

<h3><a href="#Top"><font size="2" face="Verdana, Arial, Helvetica"><img
src="up.gif" alt="To Top" align="middle" border="0" width="14"
height="11"></font></a><a name="313h2"><font size="2"
face="Verdana, Arial, Helvetica">TCP Redirection</font></a></h3>

<p><font size="2" face="Verdana, Arial, Helvetica">TCP handles
point-to-point, connection-oriented communications. For each TCP
connection requested by an internal application, two actual
connections are set up by WinSock Proxy service:</font></p>

<ul>
    <li><p align="left"><font size="2" face="Verdana, Arial, Helvetica">A
        connection between the client application and the WinSock
        Proxy service using the WinSock Proxy Microsoft Proxy
        Server&#146;s internal network port interface. </font></p>
    </li>
    <li><font size="2" face="Verdana, Arial, Helvetica">A connection
        between the WinSock Proxy service and the Internet
        application using the WinSock Proxy Microsoft Proxy
        Server&#146;s external (Internet) port interface.</font></li>
</ul>

<p><font size="2" face="Verdana, Arial, Helvetica">Data received from
either connection is forwarded to the other connection, and both
applications perform as though they are communicating directly
with each other. </font></p>

<p><font size="2" face="Verdana, Arial, Helvetica">A TCP redirected
connection is managed in the following way:</font></p>

<ol>
    <li><p align="left"><font size="2" face="Verdana, Arial, Helvetica">The
        WinSock Proxy control channel is used to set up a TCP
        redirected connection. Once the TCP redirected connection
        is set up, the control channel is not used for data
        transfer. </font></p>
    </li>
    <li><p align="left"><font size="2" face="Verdana, Arial, Helvetica">The
        internal application then initiates an outbound TCP
        connection to an Internet site. </font></p>
    </li>
    <li><p align="left"><font size="2" face="Verdana, Arial, Helvetica">The
        <b>send()</b> and <b>recv()</b> APIs are then called on
        the client and server. The WinSock Proxy client DLL
        forwards <strong>send()</strong> calls to the real
        Windows Sockets DLL (these APIs do not contain addresses,
        they simply refer to a socket), and all data is identical
        to data sent in a normal (non-redirected) socketed
        connection.<strong> (</strong>The <b>ReadFile()</b> and <b>WriteFile()</b>
        Win32 APIs work on TCP redirected connections as well.
        For Windows&nbsp;NT, these APIs are not handled by
        Windows Sockets and therefore are not intercepted by the
        WinSock Proxy DLL.) </font></p>
    </li>
</ol>

<p><font size="2" face="Verdana, Arial, Helvetica">Once an internal
application&#146;s socket has been remotely bound, WinSock Proxy
makes it appear that the socket is bound to the proxy
computer&#146;s Internet interface. If the internal application
calls the <b>getsockname()</b> API, the data returned will
indicate that the socket&#146;s local IP address is that of the
proxy computer. Thus, it appears to the application that it is on
the Internet. This is necessary for protocols such as FTP, in
which the client sends its local IP address to a server, in order
for the server to initiate a new TCP connection back to the
client. </font></p>

<p><font size="2" face="Verdana, Arial, Helvetica">When an internal
application attempts to listen for a TCP connection initiated by
an Internet application, WinSock Proxy uses the local IP address
to which the application&#146;s socket is bound to determine
whether the listen should be redirected. If the local IP address
is that of the Internal computer&#146;s interface (a private
network IP address), the listen will be local (passed to the
Winsock DLL). If the IP address bound to the socket is that of
the Microsoft Proxy Server&#146;s Internet interface, the listen
will be redirected. </font></p>

<p><font size="2" face="Verdana, Arial, Helvetica">When a <b>listen()</b>
API is redirected, WinSock Proxy does the following: </font></p>

<ul>
    <li><p align="left"><font size="2" face="Verdana, Arial, Helvetica">Listens
        for a socket connection on the WinSock Proxy
        service&#146;s Internet IP address and the same port
        specified as the local port in the internal
        application&#146;s socket bind. </font></p>
    </li>
    <li><font size="2" face="Verdana, Arial, Helvetica">When an external
        site connects to the port, creates a socket connection
        between the internal application (on the local port
        specified by the application), and the WinSock Proxy
        service (on its internal IP address and an arbitrary
        port). This connection is initiated by the WinSock Proxy
        service, because the internal application is listening
        for an incoming connection.</font></li>
</ul>

<p><font size="2" face="Verdana, Arial, Helvetica">Once an internal
application&#146;s socket is bound to the Microsoft Proxy
Server&#146;s Internet IP address and an inbound connection is
established, a <strong>getsockname()</strong> API call by the
application will return the proxy&#146;s Internet IP address as
the local IP address, and the Internet site&#146;s IP address and
port as the remote IP and port. </font></p>

<p><font size="2" face="Verdana, Arial, Helvetica">The following
illustration shows WinSock Proxy redirecting a TCP connection. </font></p>

<p align="left"><font size="2" face="Verdana, Arial, Helvetica"><img
src="xag_e03.gif" width="455" height="195"></font></p>

<h3><a href="#Top"><font size="2" face="Verdana, Arial, Helvetica"><img
src="up.gif" alt="To Top" align="middle" border="0" width="14"
height="11"></font></a><a name="314h2"><font size="2"
face="Verdana, Arial, Helvetica">UDP Redirection</font></a></h3>

<p><font size="2" face="Verdana, Arial, Helvetica">UDP offers
connectionless communications, and supports multiple applications
communicating with an application over the same UDP socket. A
UDP-based application uses <b>sendto()</b> to send data,
specifying the destination IP address, and <b>recvfrom()</b> to
receive data, returning the source IP address. </font></p>

<p><font size="2" face="Verdana, Arial, Helvetica">When an internal
application binds a UDP socket, the WinSock Proxy service binds a
UDP socket to its Internet IP address, and the same local port as
used by the client. This is the socket used for communications
between all Internet peers for the internal application. </font></p>

<p><font size="2" face="Verdana, Arial, Helvetica">When an internal client
computer receives a packet over UDP from the Internet:</font></p>

<ul>
    <li><p align="left"><font size="2" face="Verdana, Arial, Helvetica">The
        packet was actually forwarded by the WinSock Proxy
        service, and the source address will be that of the
        computer running Microsoft Proxy Server. </font></p>
    </li>
    <li><font size="2" face="Verdana, Arial, Helvetica">The WinSock Proxy
        client DLL needs to change the source port and IP address
        to that of the actual Internet source before the internal
        application receives the data. However, the problem is
        that for UDP there can be multiple sources of data sent
        to one destination socket. </font></li>
</ul>

<p><font size="2" face="Verdana, Arial, Helvetica">In other
implementations, this problem is sometimes handled by having the
Web Proxy Service add a header to the data (which contains the
original source port and IP address) before forwarding it to the
internal client. The client DLL would then strip off this header
and modify the source IP address and port passed to the
application. This solution requires much work on every data
packet, including a buffer copy, and may even result in the
buffer size being larger than the maximum allowed. In this case,
splitting the data into multiple packets needs to be supported,
as well as ordering and recombining at the destination. Also,
this solution prevents Win32 APIs from working. (On
Windows&nbsp;NT, Win32 APIs are not passed to Windows Sockets.) </font></p>

<p><font size="2" face="Verdana, Arial, Helvetica">Instead, the problem of
multiple-source IP addresses is solved by creating a separate UDP
socket in Microsoft Proxy Server for each Internet peer sending
data to the client. Each time the first data packet is received
from a new Internet port and IP address, WinSock Proxy service
creates a new UDP socket on a different local port, in Microsoft
Proxy Server (bound to the proxy&#146;s internal IP interface).
The WinSock Proxy service maintains a table that maps Internet
ports and IP addresses to the port number of the WinSock Proxy
server&#146;s socket for that Internet site. Each time it
changes, the mapping table is forwarded to the WinSock Proxy
client DLL by using the control channel. </font></p>

<p><font size="2" face="Verdana, Arial, Helvetica">When the WinSock Proxy
service receives data from an Internet application destined for
the client, it sends the data to the client by using the
associated socket on the Microsoft Proxy Server. The WinSock
Proxy client DLL looks at the source (remote) port number of the
data packet (proxy-server port number), and uses the table to map
that to an Internet application&#146;s port and IP address. The
internal application is handed the Internet port and IP address
as the source. </font></p>

<p><font size="2" face="Verdana, Arial, Helvetica">The result is that
handling UDP communications:</font></p>

<ul>
    <li><font size="2" face="Verdana, Arial, Helvetica">Does not require
        extra control channels. </font></li>
    <li><font size="2" face="Verdana, Arial, Helvetica">Does not cause
        data packets to be modified. </font></li>
    <li><font size="2" face="Verdana, Arial, Helvetica">Does not require
        use of the control channel when data is sent from an
        Internet peer that the WinSock Proxy service already
        knows about.</font></li>
</ul>

<p><font size="2" face="Verdana, Arial, Helvetica">Win32 APIs also work
for reading and writing the socket. </font></p>

<p><font size="2" face="Verdana, Arial, Helvetica">When the internal
application sends data to one of the remote peers, the WinSock
Proxy DLL uses the mapping table to map the destination port and
IP address (specified by the internal application) to an WinSock
Proxy server port, and sends the data to the appropriate UDP
socket (port) on the WinSock Proxy server computer. </font></p>

<p><font size="2" face="Verdana, Arial, Helvetica">Because this mechanism
requires a new socket for each Internet peer application, extra
resources are used in the Microsoft Proxy Server when an internal
application uses UDP to communicate with many remote peers. Most
Internet client applications that use UDP (RealAudio, VDOLive,
and so on), communicate with a single server application, so this
is an efficient trade-off. For other UDP client applications, the
number of servers communicating with the client is usually small.
(WinSock Proxy will limit the number of mappings per socket,
keeping the most recently used, and re-establishing mappings as
needed.)</font></p>

<p><font size="2" face="Verdana, Arial, Helvetica">When an internal
application calls <b>getsockname()</b> for a remoted UDP socket,
the local IP address returned is that of the proxy&#146;s
Internet interface. </font></p>

<p><font size="2" face="Verdana, Arial, Helvetica">The following
illustration depicts redirected UDP communications that use
WinSock Proxy. </font></p>

<p align="left"><font size="2" face="Verdana, Arial, Helvetica"><img
src="xag_e04.gif" width="405" height="329"></font></p>

<h3><a href="#Top"><font size="2" face="Verdana, Arial, Helvetica"><img
src="up.gif" alt="To Top" align="middle" border="0" width="14"
height="11"></font></a><a name="315h2"><font size="2"
face="Verdana, Arial, Helvetica">Using TCP/IP on the Internal Network</font></a></h3>

<p><font size="2" face="Verdana, Arial, Helvetica">When the internal
network runs TCP/IP, a TCP/IP application could try to
communicate with a local (internal network) or remote (Internet)
application. When the WinSock Proxy client DLL initializes, it
receives from the WinSock Proxy service, using the control
channel, a Local Address Table, which contains a list of IP
addresses and subnets that are located on the private network.
Future communication attempts by applications on the client
computer with a specific IP address can be routed locally or
remotely by the WinSock Proxy DLL, as appropriate. If
communication is attempted with a local IP address, the WinSock
Proxy DLL simply forwards the request to the real Window Sockets
DLL, with no special processing. </font></p>

<p><font size="2" face="Verdana, Arial, Helvetica">In some cases an
application attempts to communicate, but the WinSock Proxy DLL
cannot determine whether the application is trying to communicate
with a local computer or a remote computer. For example, a
typical server application binds a socket to all local IP
addresses (IP_ANY), and then listens on that socket. If WinSock
Proxy cannot in any way determine if a <b>listen()</b> API should
be local or remote, it will assume local (the more secure of the
two). </font></p>

<p><font size="2" face="Verdana, Arial, Helvetica">If multiple internal
servers are to be set up to do redirected <b>listen()</b> APIs on
the same port at the same time, they must use different IP
addresses on the Internet interface of the computer running
Microsoft Proxy Server. For example, if two servers running
Microsoft Exchange (IMC) internally will be listening on the SMTP
port (port 25), the Microsoft Proxy Server must have two IP
addresses assigned to its Internet: one for each computer running
Exchange (IMC) server. Because both internal servers <b>listen()</b>
on the same port, and the two <b>listen()</b> instances must be
redirected to the same port on the proxy computer, the only way
to distinguish them on the proxy is by using different IP
addresses. </font></p>

<h3><a href="#Top"><font size="2" face="Verdana, Arial, Helvetica"><img
src="up.gif" alt="To Top" align="middle" border="0" width="14"
height="11"></font></a><a name="316h2"><font size="2"
face="Verdana, Arial, Helvetica">Using IPX/SPX on the Internal Network</font></a></h3>

<p><font size="2" face="Verdana, Arial, Helvetica">If the internal network
does not run TCP/IP, it is assumed that all attempts by Windows
Sockets applications to communicate over TCP/IP are to be
redirected to the Internet. </font></p>

<p><font size="2" face="Verdana, Arial, Helvetica">When the internal
network runs IPX/SPX, the principle of how communications are
redirected is identical to that used when the internal network
runs TCP/IP. When an internal application attempts to establish
communications over TCP/IP, the WinSock Proxy DLL changes the
Windows Sockets API parameters to those appropriate for IPX/SPX
(address reformatting, and so on), and the communications between
client and WinSock Proxy server are handled over IPX/SPX. The
WinSock Proxy server acts as a protocol gateway, converting
between IPX/SPX on the private network and TCP/IP on the
Internet. In addition to standard redirection functionality, the
following tasks are accomplished by the WinSock Proxy DLL when
establishing remote communications with IPX/SPX: </font></p>

<ul>
    <li><p align="left"><font size="2" face="Verdana, Arial, Helvetica"><b>socket()</b>
        API. When an application specifies a protocol of TCP or
        UDP in a socket API call, the WinSock Proxy DLL changes
        this to the appropriate IPX/SPX protocol. </font></p>
    </li>
    <li><p align="left"><font size="2" face="Verdana, Arial, Helvetica"><b>bind()</b>
        API. When an application specifies a local IP address to
        bind a socket to, WinSock Proxy converts this to a local
        IPX/SPX address. A request to bind to IP_ANY is also
        converted. </font></p>
    </li>
    <li><p align="left"><font size="2" face="Verdana, Arial, Helvetica"><b>connect()</b>
        API. When an application attempts to connect to an
        Internet application, the address passed to the Windows
        Sockets DLL needs to be the IPX address of the Microsoft
        Proxy Server&#146;s internal interface. </font></p>
    </li>
    <li><p align="left"><font size="2" face="Verdana, Arial, Helvetica"><b>sendto()</b>
        API. The destination IP address needs to be converted to
        IPX address of the internal interface of the computer
        running Microsoft Proxy Server. </font></p>
    </li>
    <li><p align="left"><font size="2" face="Verdana, Arial, Helvetica"><b>recvfrom()</b>
        API. The source IP address returned needs to be converted
        from IPX address of the computer running Microsoft Proxy
        Server to IP address of the Internet application. </font></p>
    </li>
    <li><p align="left"><font size="2" face="Verdana, Arial, Helvetica">The
        control channel uses IPX instead of UDP.<br>
        <br>
        </font></p>
    </li>
</ul>

<h2><a href="#Top"><font size="2" face="Verdana, Arial, Helvetica"><img
src="up.gif" alt="To Top" align="middle" border="0" width="14"
height="11"></font></a><a name="32h2"><font size="2"
face="Verdana, Arial, Helvetica">Windows Sockets APIs</font></a></h2>

<blockquote>
    <p><a href="#321h3"><font size="2" face="Verdana, Arial, Helvetica">socket()</font></a><font
    size="2" face="Verdana, Arial, Helvetica"><br>
    </font><a href="#322h3"><font size="2"
    face="Verdana, Arial, Helvetica">bind()</font></a><font size="2"
    face="Verdana, Arial, Helvetica"><br>
    </font><a href="#323h3"><font size="2"
    face="Verdana, Arial, Helvetica">connect()</font></a><font size="2"
    face="Verdana, Arial, Helvetica"><br>
    </font><a href="#324h3"><font size="2"
    face="Verdana, Arial, Helvetica">listen() and accept()</font></a><font
    size="2" face="Verdana, Arial, Helvetica"><br>
    </font><a href="#325h3"><font size="2"
    face="Verdana, Arial, Helvetica">recv() and send()</font></a><font
    size="2" face="Verdana, Arial, Helvetica"><br>
    </font><a href="#326h3"><font size="2"
    face="Verdana, Arial, Helvetica">recvfrom() and sendto()</font></a><font
    size="2" face="Verdana, Arial, Helvetica"><br>
    </font></p>
</blockquote>

<h3><a href="#Top"><font size="2" face="Verdana, Arial, Helvetica"><img
src="up.gif" alt="To Top" align="middle" border="0" width="14"
height="11"></font></a><a name="321h3"><font size="2"
face="Verdana, Arial, Helvetica">socket()</font></a></h3>

<p><font size="2" face="Verdana, Arial, Helvetica">The <b>socket()</b> API
is used by applications to establish a socket and associate it
with a protocol (TCP, UDP, and so on) The <b>socket()</b> API
requires no special processing by the WinSock Proxy DLL if the
internal network runs TCP/IP; the API is simply passed to the
standard Windows Sockets DLL for the local creation of the
socket. If the local network runs IPX/SPX, the WinSock Proxy DLL
needs to change the protocol specified in the <b>socket()</b> API
call (UDP or TCP), to the appropriate IPX/SPX protocol. </font></p>

<h3><a href="#Top"><font size="2" face="Verdana, Arial, Helvetica"><img
src="up.gif" alt="To Top" align="middle" border="0" width="14"
height="11"></font></a><a name="322h3"><font size="2"
face="Verdana, Arial, Helvetica">bind()</font></a></h3>

<p><font size="2" face="Verdana, Arial, Helvetica">After calling the <b>socket()</b>
API, clients may call the <b>bind()</b> API to bind the socket to
a specific local interface (IP address) and port. This API is
intercepted by the WinSock Proxy DLL and forwarded to the WinSock
Proxy service using the control channel, when one of the
following is true:</font></p>

<ul>
    <li><font size="2" face="Verdana, Arial, Helvetica">The private
        network is running IPX, and not TCP/IP.</font></li>
    <li><font size="2" face="Verdana, Arial, Helvetica">The private
        network is running TCP/IP, but the specified IP address
        is not in the LAT, and is not ADDR_ANY.</font></li>
    <li><font size="2" face="Verdana, Arial, Helvetica">The application
        configuration specifies that bind is remote.</font></li>
    <li><font size="2" face="Verdana, Arial, Helvetica">The application
        already has a connection using the proxy server, and the
        bind is not to PORT_ANY and ADDR_ANY. (Note that some FTP
        clients can redirect even when they bind to PORT_ANY and
        ADDR_ANY.)</font></li>
</ul>

<p><font size="2" face="Verdana, Arial, Helvetica">The WinSock Proxy
service, in preparation of an attempt by the application to
create a remote connection using this socket, creates one socket
on the gateway computer for a UDP socket, and two sockets on the
gateway computer for a TCP socket. This is done by calling the <b>socket()</b>
and <b>bind()</b> APIs for the one or two new sockets. One new
socket will be bound to the same port number that the client
specified in its <b>bind()</b>, and the IP address of the gateway
computer&#146;s Internet interface. For TCP, the second socket is
bound to the IP address of the gateway computer&#146;s internal
interface (and an arbitrary port). The client&#146;s socket <b>bind()</b>
request will then be passed to the Winsock DLL on the client
computer, for normal processing. </font></p>

<h3><a href="#Top"><font size="2" face="Verdana, Arial, Helvetica"><img
src="up.gif" alt="To Top" align="middle" border="0" width="14"
height="11"></font></a><a name="323h3"><font size="2"
face="Verdana, Arial, Helvetica">connect()</font></a></h3>

<p><font size="2" face="Verdana, Arial, Helvetica">An application uses the
<b>connect()</b> API to initiate an outbound TCP connection to a
remote IP address and port pair. If the WinSock Proxy DLL
determines, by looking up the IP address in the downloaded Local
Address Table, that the application is attempting to connect to a
remote (Internet) site (or if the local network runs IPX/SPX),
the DLL forwards the request to the WinSock Proxy service using
the control channel. </font></p>

<p><font size="2" face="Verdana, Arial, Helvetica">The WinSock Proxy
service performs these actions: </font></p>

<ul>
    <li><font size="2" face="Verdana, Arial, Helvetica">A <b>connect()</b>
        API (on the socket that was previously bound to the
        Internet interface).</font></li>
    <li><p align="left"><font size="2" face="Verdana, Arial, Helvetica">For
        the other socket, which was bound to the interface on the
        internal network, the <b>listen()</b> and <b>accept()</b>
        APIs are used to establish the connection with the
        client. </font></p>
    </li>
</ul>

<p><font size="2" face="Verdana, Arial, Helvetica">The WinSock Proxy DLL
passes the <b>connect()</b> API to the Windows Sockets DLL, but
first changes the IP address of the remote computer to that of
the gateway computer&#146;s internal interface (or converts it to
the gateway computer&#146;s IPX address, if the local network
runs IPX/SPX). The <b>listen()</b> and <b>accept()</b> APIs used
by the WinSock Proxy service will complete the establishment of
this connection. </font></p>

<p><font size="2" face="Verdana, Arial, Helvetica">The result is that the
WinSock Proxy service on the gateway computer has two socket
endpoints that represent communications channels with the two
communicating applications. </font></p>

<h3><a href="#Top"><font size="2" face="Verdana, Arial, Helvetica"><img
src="up.gif" alt="To Top" align="middle" border="0" width="14"
height="11"></font></a><a name="324h3"><font size="2"
face="Verdana, Arial, Helvetica">listen() and accept()</font></a></h3>

<p><font size="2" face="Verdana, Arial, Helvetica">When a client allows an
inbound connection from a remote computer, it calls the <b>listen()</b>
API. If the WinSock Proxy DLL determines from the Local Address
Table, or configuration information, that the client is
attempting to establish a connection with an Internet computer,
the DLL forwards the <b>listen()</b> API to the WinSock Proxy
service by using the control channel. <strong>listen()</strong>
will be redirected only if the <strong>bind()</strong> call was
remoted. </font></p>

<p><font size="2" face="Verdana, Arial, Helvetica">The WinSock Proxy
service will do a <b>listen()</b> on the socket bound to its
Internet interface when the client did its <b>bind()</b>. When
the remote application attempts to connect to the WinSock Proxy
service&#146;s socket, the service will do an <b>accept()</b> to
complete the connection process. The service will then do a <b>connect()</b>
on the internal socket to establish a connection with the
internal client application. The client application will then
call the <b>accept()</b> API to complete the connection process. </font></p>

<p><font size="2" face="Verdana, Arial, Helvetica">The result is that the
WinSock Proxy service on the gateway computer has two socket
endpoints that represent the two communicating applications. </font></p>

<p><font size="2" face="Verdana, Arial, Helvetica">Note that if inbound
access is not allowed, or if a site attempts to connect and that
site is filtered (by using Microsoft Proxy Server Internet site
filtering), the connection is discarded and will not reach the
client.</font></p>

<h3><a href="#Top"><font size="2" face="Verdana, Arial, Helvetica"><img
src="up.gif" alt="To Top" align="middle" border="0" width="14"
height="11"></font></a><a name="325h3"><font size="2"
face="Verdana, Arial, Helvetica">recv() and send()</font></a></h3>

<p><font size="2" face="Verdana, Arial, Helvetica">Once a TCP socket
connection is established between internal application and the
WinSock Proxy service, and a corresponding connection is
established between WinSock Proxy service and remote application,
the client can receive and send data with the <b>recv()</b> and <b>send()</b>
APIs. </font></p>

<p><font size="2" face="Verdana, Arial, Helvetica">The WinSock Proxy
service uses the <b>recv()</b> API on both connections for
receiving data packets. When a client sends data, the data is
actually sent to the WinSock Proxy service, because it has the
socket endpoint of the client&#146;s connection. The WinSock
Proxy service simply receives the data on that connection, and
sends it to the remote computer using the other connection. </font></p>

<p><font size="2" face="Verdana, Arial, Helvetica">When the remote
application sends data to the client, the WinSock Proxy service
receives this data and sends it to the client application. </font></p>

<p><font size="2" face="Verdana, Arial, Helvetica">Receiving and sending
data on the client computer requires no special handling on the
part of the WinSock Proxy DLL. The DLL simply passes these API
calls on to the (renamed) Windows Sockets DLL. The WinSock Proxy
service does all of the special handling, by passing the data to
the associated connection. This results in high performance when
sending and receiving data on the client. The Win32 APIs for
reading and writing files, when applied to a redirected socket,
will work successfully. </font></p>

<h3><a href="#Top"><font size="2" face="Verdana, Arial, Helvetica"><img
src="up.gif" alt="To Top" align="middle" border="0" width="14"
height="11"></font></a><a name="326h3"><font size="2"
face="Verdana, Arial, Helvetica">recvfrom() and sendto()</font></a></h3>

<p><font size="2" face="Verdana, Arial, Helvetica">The <b>recvfrom()</b>
and <b>sendto()</b> APIs are most often used with UDP
connectionless communications. The <b>sendto()</b> API requires
an IP address and port destination, and the <b>recvfrom()</b> API
returns an IP address and port of the originator of the data. </font></p>

<p><font size="2" face="Verdana, Arial, Helvetica">When the internal
application does a <b>bind()</b> on a UDP socket, the WinSock
Proxy service binds a socket on the gateway computer&#146;s
external (Internet) interface, to send and receive data to and
from remote applications. Once this socket is bound, remote
servers can send data, destined for the internal application.
Each time a UDP data packet is received from a new IP address and
port pair, the WinSock Proxy service creates a new UDP socket on
the gateway computer and binds it to a different port on the
gateway&#146;s internal interface. </font></p>

<p><font size="2" face="Verdana, Arial, Helvetica">The WinSock Proxy
service maintains a mapping table of remote IP address and port
pairs (that have sent data) with the port number of the
corresponding internal-interface socket in the gateway computer.
This mapping table is downloaded to the WinSock Proxy DLL on the
client computer by using the control channel. </font></p>

<p><font size="2" face="Verdana, Arial, Helvetica">When a UDP data packet
is received from a remote computer, the WinSock Proxy service
looks up the internal socket (based on the remote computer&#146;s
IP address and port) to use for that remote computer, and sends
the data to the internal computer by using the corresponding
socket. The WinSock Proxy DLL on the client computer will receive
the data packet from the gateway computer&#146;s IP address, and
the port that it was sent from can be used to look up the IP
address, and port, of the originating remote computer. The
WinSock Proxy DLL will replace the source information, making it
appear that the data came directly from the remote computer. </font></p>

<p><font size="2" face="Verdana, Arial, Helvetica">When the client
(internal) application sends data to a remote computer, the
WinSock Proxy DLL intercepts the request and modifies the
destination to send it to the WinSock Proxy service by using one
of the WinSock Proxy service&#146;s sockets bound to the internal
IP interface. In order to determine which WinSock Proxy service
socket to use, the WinSock Proxy DLL looks up the final
destination IP address and port pair in the UDP mapping table,
and that indicates which WinSock Proxy service socket (port) to
send to. </font></p>

<h2><a href="#Top"><font size="2" face="Verdana, Arial, Helvetica"><img
src="up.gif" alt="To Top" align="middle" border="0" width="14"
height="11"></font></a><a name="33h2"><font size="2"
face="Verdana, Arial, Helvetica">WinSock Proxy Limitations</font></a></h2>

<p><font size="2" face="Verdana, Arial, Helvetica">Version&nbsp;1.0 of
Microsoft Proxy Server can redirect Windows Sockets&nbsp;1.1
applications. Redirection of Windows Sockets&nbsp;2.0 APIs or
applications is not supported. Almost all Windows
Sockets&nbsp;1.1 TCP/IP applications can be redirected. This
section describes limitations that may prevent specific protocols
or applications from working through the WinSock Proxy service. </font></p>

<p><font size="2" face="Verdana, Arial, Helvetica">When an internal
application receives an inbound TCP connection from an Internet
site, the internal application&#146;s <b>bind()</b> API needs to
be redirected to the WinSock Proxy service computer&#146;s
Internet interface. If multiple internal computers will be
running that same application, and therefore listening on the
same port at the same time, each one needs to use a different
Internet IP address on the WinSock Proxy server in order to
distinguish them (because the port is the same). </font></p>

<p><font size="2" face="Verdana, Arial, Helvetica">There are a small
number of APIs that cannot be handled properly in a redirected
environment. Following is a list of APIs that will not be
redirected properly: </font></p>

<ul>
    <li><font size="2" face="Verdana, Arial, Helvetica"><b>duplicatehandle()</b>
        </font></li>
    <li><font size="2" face="Verdana, Arial, Helvetica"><b>getsockopt()</b>
        </font></li>
</ul>

<p><font size="2" face="Verdana, Arial, Helvetica"><strong>Note</strong>&nbsp;&nbsp;&nbsp;The
<strong>getsockopt()</strong> API returns the local information,
which is usually equal to the remote information.</font></p>

<p><font size="2" face="Verdana, Arial, Helvetica">Also, WinSock Proxy
does not support Out-Of-Band (OOB) data transfer. In general, OOB
is implementation-dependent and may not work between different
network stacks.</font></p>

<hr>

<p align="center"><font size="2" face="Verdana, Arial, Helvetica"><i>
1996 by Microsoft Corporation. All rights reserved.</i> </font></p>
</FONT>
</FONT>
</BODY>
</html>
