<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<HTML dir=ltr>
<HEAD>
<META HTTP-EQUIV="Content-Type" Content="text/html; charset=Windows-1252">
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-83731338-2"></script><script>  window.dataLayer = window.dataLayer || [];  function gtag(){dataLayer.push(arguments);}  gtag('js', new Date());  gtag('config', 'UA-83731338-2');</script><title>Correlated Subqueries with Comparison Operators</title>
<link disabled rel=stylesheet href=../../../../backsdk3.css>
<style type="text/css">
@import url(../../../../backsdk4.css);
</style>
</HEAD>
<BODY BGCOLOR = #FFFFFF TEXT = #000000>

<h3><a name="_correlated_subqueries_with_comparison_operators"></a>Correlated Subqueries with Comparison Operators</h3>
<p>
To find sales where the quantity is less than the average quantity for sales of that title:</p>
<pre>SELECT s1.ord_num, s1.title_id, s1.qty
FROM sales s1
WHERE s1.qty &lt;
    (SELECT AVG(s2.qty)
    FROM sales s2
    WHERE s2.title_id = s1.title_id)
</pre>
<table cellspacing=4 cols=5>
<tr valign=top>
<td width=26%><pre>ord_num</pre>
</td>
<td width=27%><pre>title_id</pre>
</td>
<td width=20%><pre>qty</pre>
</td>
<td colspan=2 width=27%><pre></pre>
</td>
</tr>
<tr valign=top>
<td width=26%><pre>--------</pre>
</td>
<td width=27%><pre>--------</pre>
</td>
<td width=20%><pre>-----</pre>
</td>
<td colspan=2 width=27%><pre></pre>
</td>
</tr>
<tr valign=top>
<td width=26%><pre>6871</pre>
</td>
<td width=27%><pre>BU1032</pre>
</td>
<td width=20%><pre>5</pre>
</td>
<td colspan=2 width=27%><pre></pre>
</td>
</tr>
<tr valign=top>
<td width=26%><pre>722a</pre>
</td>
<td width=27%><pre>PS2091</pre>
</td>
<td width=20%><pre>3</pre>
</td>
<td colspan=2 width=27%><pre></pre>
</td>
</tr>
<tr valign=top>
<td width=26%><pre>D4482</pre>
</td>
<td width=27%><pre>PS2091</pre>
</td>
<td width=20%><pre>10</pre>
</td>
<td colspan=2 width=27%><pre></pre>
</td>
</tr>
<tr valign=top>
<td width=26%><pre>N914008</pre>
</td>
<td width=27%><pre>PS2091</pre>
</td>
<td width=20%><pre>20</pre>
</td>
<td colspan=2 width=27%><pre></pre>
</td>
</tr>
<tr valign=top>
<td width=26%><pre>423LL922</pre>
</td>
<td width=27%><pre>MC3021</pre>
</td>
<td width=20%><pre>15</pre>
</td>
<td colspan=2 width=27%><pre></pre>
</td>
</tr>
<tr valign=top>
<td width=26%><pre></pre>
</td>
<td width=27%><pre></pre>
</td>
<td width=20%><pre></pre>
</td>
<td colspan=2 width=27%><pre></pre>
</td>
</tr>
<tr valign=top>
<td colspan=4 width=93%><pre>(5 row(s) affected)</pre>
</td>
</tr>
</table><br>
<pre></pre>
<p>
The outer query selects the rows of the <i>sales</i> table (that is, of <i>s1</i>) one by one. The subquery calculates the average quantity for each sale being considered for selection in the outer query. For each possible value of <i>s1</i>, SQL Server evaluates the subquery and puts the record being considered in the results if the quantity is less than the calculated average.</p>
<p>
Sometimes a correlated subquery mimics a GROUP BY statement. This example finds all titles that have a price greater than the average for books of its type:</p>
<pre>SELECT t1.type, t1.title
FROM titles t1
WHERE t1.price &gt;
    (SELECT AVG(t2.price)
    FROM titles t2
    WHERE t1.type = t2.type)
</pre>
<table cellspacing=4 cols=2>
<tr valign=top>
<td width=20%><pre>type</pre>
</td>
<td width=80%><pre>title</pre>
</td>
</tr>
<tr valign=top>
<td width=20%><pre>----</pre>
</td>
<td width=80%><pre>-----------------------------------------------------</pre>
</td>
</tr>
<tr valign=top>
<td width=20%><pre>business</pre>
</td>
<td width=80%><pre>The Busy Executive's Database Guide</pre>
</td>
</tr>
<tr valign=top>
<td width=20%><pre>business</pre>
</td>
<td width=80%><pre>Straight Talk About Computers</pre>
</td>
</tr>
<tr valign=top>
<td width=20%><pre>mod_cook</pre>
</td>
<td width=80%><pre>Silicon Valley Gastronomic Treats</pre>
</td>
</tr>
<tr valign=top>
<td width=20%><pre>popular_comp</pre>
</td>
<td width=80%><pre>But Is It User Friendly?</pre>
</td>
</tr>
<tr valign=top>
<td width=20%><pre>psychology</pre>
</td>
<td width=80%><pre>Computer Phobic and Non-Phobic Individuals: 
Behavior Variations</pre>
</td>
</tr>
<tr valign=top>
<td width=20%><pre>psychology</pre>
</td>
<td width=80%><pre>Prolonged Data Deprivation: Four Case 
Studies</pre>
</td>
</tr>
<tr valign=top>
<td width=20%><pre>trad_cook</pre>
</td>
<td width=80%><pre>Onions, Leeks, and Garlic: Cooking Secrets 
of the Mediterranean</pre>
</td>
</tr>
</table><br>
<pre>(7 row(s) affected)
</pre>
<p>
For each possible value of <i>t1</i>, SQL Server evaluates the subquery and includes the row in the results if the <i>price</i> value of that row is greater than the calculated average. It is not necessary to group by type explicitly, because the rows for which average price is calculated are restricted by the WHERE clause in the subquery.</p>
<p>
</p>
<p>&nbsp;</p></body>
</HTML>
