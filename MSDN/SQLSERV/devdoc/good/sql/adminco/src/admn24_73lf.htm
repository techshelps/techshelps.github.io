<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<HTML dir=ltr>
<HEAD>
<META HTTP-EQUIV="Content-Type" Content="text/html; charset=Windows-1252">
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-83731338-2"></script><script>  window.dataLayer = window.dataLayer || [];  function gtag(){dataLayer.push(arguments);}  gtag('js', new Date());  gtag('config', 'UA-83731338-2');</script><title>Gathering Information About Read/Write Errors</title>
<link disabled rel=stylesheet href=../../../../backsdk3.css>
<style type="text/css">
@import url(../../../../backsdk4.css);
</style>
</HEAD>
<BODY BGCOLOR = #FFFFFF TEXT = #000000>

<h2><a name="_gathering_information_about_read.2f.write_errors"></a>Gathering Information About Read/Write Errors</h2>
<p>
The <b>sp_diskblock</b> procedure shown below translates a SQL Server virtual disk and block number into the corresponding SQL Server device, database, and logical page number. This information can be useful for gathering information about read or write errors that SQL Server might encounter, such as the Read/Write Error described in Chapter 26, "System Messages."</p>
<p>
Because the <b>sp_diskblock</b> procedure collects information from the system tables of the SQL Server on which it is executed, you must execute <b>sp_diskblock</b> on the SQL Server where the read/write error occurred.</p>
<h5>Syntax</h5>
<p>
<b>sp_diskblock </b><i>virtual_disk</i><b>,</b> <i>block_number</i></p>
<h5>Example</h5>
<pre>sp_diskblock 0, 22
  
Virtual disk 0, block 22 corresponds to:
Logical page 18 in the "master" database
(dbid=1) on device "master".
  </pre>
<h5>Stored Procedure Code</h5>
<pre>CREATE PROC sp_diskblock @@disk int, @@block int AS
DECLARE @@low    int,
        @@dname  varchar(30),
        @@msg    varchar(90),
        @@lpage  int,
        @@dbid   int,
        @@segmap int
  
SELECT  @@low = low,  @@dname = name
    FROM master.dbo.sysdevices WHERE low/16777216 = @@disk
  
IF (@@low IS NULL)
    BEGIN
        SELECT @@msg = 'Virtual device '  CONVERT(varchar, @@disk)
          ' does not exist on this server.'
        PRINT @@msg
        RETURN (1)
    END
ELSE
    BEGIN
        SELECT  @@lpage = lstart  @@block  @@low - vstart,
            @@dbid = dbid, @@segmap = segmap
            FROM master.dbo.sysusages WHERE (@@block  @@low) &gt;= vstart
            AND (@@block  @@low) &lt;= (vstart  size)
        IF (@@dbid IS NULL)
            BEGIN
                SELECT @@msg = 'Block '  CONVERT(varchar, @@block)
                    ' on disk "'  @@dname
                     '" is currently not in use for any database.'
                PRINT @@msg
                RETURN (1)
            END
        ELSE
            BEGIN
                SELECT @@msg = "Virtual disk "  convert(varchar,@@disk)
                     ", block "  convert(varchar,@@block)
                     " corresponds to:"
                PRINT @@msg
                SELECT @@msg ='Logical page '  convert(varchar,@@lpage)
                     ' in the "'   DB_NAME(@@dbid)
                     '" database (dbid='   convert(varchar(3),@@dbid)
                     ') on device "'  @@dname  '".'
                PRINT @@msg
            END
    END
RETURN (0)
  
go
  </pre>
<p>
</p>
<p>&nbsp;</p></body>
</HTML>
