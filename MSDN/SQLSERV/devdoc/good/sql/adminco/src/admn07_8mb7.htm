<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<HTML dir=ltr>
<HEAD>
<META HTTP-EQUIV="Content-Type" Content="text/html; charset=Windows-1252">
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-83731338-2"></script><script>  window.dataLayer = window.dataLayer || [];  function gtag(){dataLayer.push(arguments);}  gtag('js', new Date());  gtag('config', 'UA-83731338-2');</script><title>Example of Using Segments</title>
<link disabled rel=stylesheet href=../../../../backsdk3.css>
<style type="text/css">
@import url(../../../../backsdk4.css);
</style>
</HEAD>
<BODY BGCOLOR = #FFFFFF TEXT = #000000>

<h2><a name="_example_of_using_segments"></a>Example of Using Segments</h2>
<p>
Segments provide a flexible way to assign objects to a particular database device. For example, you can add a database device to a database, and then improve your system performance by assigning a particular high-use table to that database device. To improve performance, no other database objects should use the new segment.</p>
<p>
The preceding topics presented the individual tasks performed to manage segments. The following example puts together some of these individual tasks to show you how to create a segment and remove all other segment mappings from the database device:
<ol>
<li>
Create a new database called <i>mydata</i> with one database device for objects and another for the transaction log:<pre>create database mydata on bigdevice = 4 log on logdev = 2</pre>
</li>
<li>
Switch to <i>mydata</i>, and run <b>sp_helpdb</b> to view the segments the database contains:<pre>use mydata
&lt;execute&gt;
sp_helpdb mydata</pre>
</li>
</ol>
<table cellspacing=4 cols=6>
<tr valign=top>
<td width=14%><pre>name</pre>
</td>
<td width=19%><pre>db_size</pre>
</td>
<td width=12%><pre>owner</pre>
</td>
<td width=14%><pre>dbid</pre>
</td>
<td width=17%><pre>created</pre>
</td>
<td width=24%><pre>status </pre>
</td>
</tr>
<tr valign=top>
<td width=14%><pre>-----</pre>
</td>
<td width=19%><pre>---------</pre>
</td>
<td width=12%><pre>-----</pre>
</td>
<td width=14%><pre>-------</pre>
</td>
<td width=17%><pre>---------</pre>
</td>
<td width=24%><pre>-------</pre>
</td>
</tr>
<tr valign=top>
<td width=14%><pre>mydata</pre>
</td>
<td width=19%><pre>6 MB</pre>
</td>
<td width=12%><pre>SA</pre>
</td>
<td width=14%><pre>4 </pre>
</td>
<td width=17%><pre>May 5 1995</pre>
</td>
<td width=24%><pre>no options set </pre>
</td>
</tr>
</table><br>
<pre></pre>
<table cellspacing=4 cols=3>
<tr valign=top>
<td width=33%><pre>device_fragments</pre>
</td>
<td width=26%><pre>size</pre>
</td>
<td width=41%><pre>usage</pre>
</td>
</tr>
<tr valign=top>
<td width=33%><pre>-------------------</pre>
</td>
<td width=26%><pre>------------</pre>
</td>
<td width=41%><pre>--------------</pre>
</td>
</tr>
<tr valign=top>
<td width=33%><pre>bigdevice</pre>
</td>
<td width=26%><pre>4 MB</pre>
</td>
<td width=41%><pre>data only</pre>
</td>
</tr>
<tr valign=top>
<td width=33%><pre>logdev</pre>
</td>
<td width=26%><pre>2 MB</pre>
</td>
<td width=41%><pre>log only</pre>
</td>
</tr>
</table><br>
<pre></pre>
<table cellspacing=4 cols=2>
<tr valign=top>
<td width=33%><pre>device</pre>
</td>
<td width=67%><pre>segment</pre>
</td>
</tr>
<tr valign=top>
<td width=33%><pre>----------------</pre>
</td>
<td width=67%><pre>-----------------------------</pre>
</td>
</tr>
<tr valign=top>
<td width=33%><pre>bigdevice</pre>
</td>
<td width=67%><pre>default</pre>
</td>
</tr>
<tr valign=top>
<td width=33%><pre>bigdevice</pre>
</td>
<td width=67%><pre>system</pre>
</td>
</tr>
<tr valign=top>
<td width=33%><pre>logdev</pre>
</td>
<td width=67%><pre>logsegment</pre>
</td>
</tr>
</table><br>
<pre></pre>
<p class=indent1>
Like all newly created databases, <i>mydata</i> has segments named DEFAULT, SYSTEM, and LOGSEGMENT. Since the CREATE DATABASE statement used LOG ON, the transaction log segment is mapped to its own device (<i>logdev</i>). The DEFAULT and SYSTEM segments are both mapped to <i>bigdevice</i>.</p>
<ol start=3>
<li>
Expand the space allocated for <i>mydata</i> on the database devices, and run <b>sp_helpdb</b> again to display the entries for the added space:<pre>use master 
&lt;execute&gt;
alter database mydata on bigdevice = 2, logdev = 1 
&lt;execute&gt;
use mydata
&lt;execute&gt;

sp_helpdb mydata
</pre>
</li>
</ol>
<table cellspacing=4 cols=6>
<tr valign=top>
<td width=14%><pre>name</pre>
</td>
<td width=17%><pre>db_size</pre>
</td>
<td width=10%><pre>owner</pre>
</td>
<td width=12%><pre>dbid</pre>
</td>
<td width=20%><pre>created</pre>
</td>
<td width=27%><pre>status </pre>
</td>
</tr>
<tr valign=top>
<td width=14%><pre>--------</pre>
</td>
<td width=17%><pre>---------</pre>
</td>
<td width=10%><pre>------</pre>
</td>
<td width=12%><pre>------</pre>
</td>
<td width=20%><pre>-----------</pre>
</td>
<td width=27%><pre>------------</pre>
</td>
</tr>
<tr valign=top>
<td width=14%><pre>mydata</pre>
</td>
<td width=17%><pre>9 MB</pre>
</td>
<td width=10%><pre>SA</pre>
</td>
<td width=12%><pre>4</pre>
</td>
<td width=20%><pre>May 5 1995</pre>
</td>
<td width=27%><pre>no options set </pre>
</td>
</tr>
</table><br>
<pre></pre>
<table cellspacing=4 cols=4>
<tr valign=top>
<td width=29%><pre>device_fragments</pre>
</td>
<td width=18%><pre>size</pre>
</td>
<td width=6%><pre></pre>
</td>
<td width=47%><pre>usage  </pre>
</td>
</tr>
<tr valign=top>
<td width=29%><pre>----------------</pre>
</td>
<td width=18%><pre>------</pre>
</td>
<td width=6%><pre></pre>
</td>
<td width=47%><pre>-----------------------</pre>
</td>
</tr>
<tr valign=top>
<td width=29%><pre>bigdevice</pre>
</td>
<td width=18%><pre>2 MB</pre>
</td>
<td width=6%><pre></pre>
</td>
<td width=47%><pre>data only</pre>
</td>
</tr>
<tr valign=top>
<td width=29%><pre>bigdevice</pre>
</td>
<td width=18%><pre>4 MB</pre>
</td>
<td width=6%><pre></pre>
</td>
<td width=47%><pre>data only</pre>
</td>
</tr>
<tr valign=top>
<td width=29%><pre>logdev</pre>
</td>
<td width=18%><pre>1 MB</pre>
</td>
<td width=6%><pre></pre>
</td>
<td width=47%><pre>log only</pre>
</td>
</tr>
<tr valign=top>
<td width=29%><pre>logdev</pre>
</td>
<td width=18%><pre>2 MB</pre>
</td>
<td width=6%><pre></pre>
</td>
<td width=47%><pre>log only</pre>
</td>
</tr>
</table><br>
<pre></pre>
<table cellspacing=4 cols=2>
<tr valign=top>
<td width=26%><pre>device        </pre>
</td>
<td width=74%><pre>segment   </pre>
</td>
</tr>
<tr valign=top>
<td width=26%><pre>------------ </pre>
</td>
<td width=74%><pre>----------------------------------------</pre>
</td>
</tr>
<tr valign=top>
<td width=26%><pre>bigdevice     </pre>
</td>
<td width=74%><pre>default</pre>
</td>
</tr>
<tr valign=top>
<td width=26%><pre>bigdevice     </pre>
</td>
<td width=74%><pre>system</pre>
</td>
</tr>
<tr valign=top>
<td width=26%><pre>logdev        </pre>
</td>
<td width=74%><pre>logsegment</pre>
</td>
</tr>
</table><br>
<pre></pre>
<p class=indent1>
When additional fragments of disk space are allocated to a database on a device, the segments from the other fragments of the database device are mapped to the new fragments. Segments are mapped to the entire amount of space on a device used by the database, not just to the space fragments. If fragments are added, all segments are mapped to those fragments.</p>
<p class=indent1>
When a new database device is used (one that's not already in use by the database), the SYSTEM and DEFAULT segments are automatically mapped to the new device. Step 4 allocates a new database device that has not been used by <i>mydata</i>.</p>
<ol start=4>
<li>
Allocate space for <i>mydata</i> on a new database device, and then run <b>sp_helpdb</b> again:<pre>use master
&lt;execute&gt;    
alter database mydata on newdevice = 3 
&lt;execute&gt;

use mydata 
&lt;execute&gt;

sp_helpdb mydata
</pre>
</li>
</ol>
<table cellspacing=4 cols=6>
<tr valign=top>
<td width=11%><pre>name</pre>
</td>
<td width=16%><pre>db_size</pre>
</td>
<td width=12%><pre>owner</pre>
</td>
<td width=17%><pre>dbid</pre>
</td>
<td width=19%><pre>created</pre>
</td>
<td width=25%><pre>status</pre>
</td>
</tr>
<tr valign=top>
<td width=11%><pre>------</pre>
</td>
<td width=16%><pre>--------</pre>
</td>
<td width=12%><pre>-----</pre>
</td>
<td width=17%><pre>---------</pre>
</td>
<td width=19%><pre>----------</pre>
</td>
<td width=25%><pre>-------------</pre>
</td>
</tr>
<tr valign=top>
<td width=11%><pre>mydata</pre>
</td>
<td width=16%><pre>12 MB</pre>
</td>
<td width=12%><pre>SA</pre>
</td>
<td width=17%><pre>4</pre>
</td>
<td width=19%><pre>Dec 2 1991</pre>
</td>
<td width=25%><pre>no options set</pre>
</td>
</tr>
</table><br>
<pre></pre>
<table cellspacing=4 cols=3>
<tr valign=top>
<td width=38%><pre>device_fragments</pre>
</td>
<td width=16%><pre>size</pre>
</td>
<td width=46%><pre>usage </pre>
</td>
</tr>
<tr valign=top>
<td width=38%><pre>----------------------</pre>
</td>
<td width=16%><pre>-----</pre>
</td>
<td width=46%><pre>------------</pre>
</td>
</tr>
<tr valign=top>
<td width=38%><pre>bigdevice</pre>
</td>
<td width=16%><pre>2 MB</pre>
</td>
<td width=46%><pre>data only</pre>
</td>
</tr>
<tr valign=top>
<td width=38%><pre>bigdevice</pre>
</td>
<td width=16%><pre>4 MB</pre>
</td>
<td width=46%><pre>data only</pre>
</td>
</tr>
<tr valign=top>
<td width=38%><pre>logdev</pre>
</td>
<td width=16%><pre>1 MB</pre>
</td>
<td width=46%><pre>log only</pre>
</td>
</tr>
<tr valign=top>
<td width=38%><pre>logdev</pre>
</td>
<td width=16%><pre>2 MB</pre>
</td>
<td width=46%><pre>log only</pre>
</td>
</tr>
<tr valign=top>
<td width=38%><pre>newdevice</pre>
</td>
<td width=16%><pre>3 MB</pre>
</td>
<td width=46%><pre>data only</pre>
</td>
</tr>
</table><br>
<pre></pre>
<table cellspacing=4 cols=2>
<tr valign=top>
<td width=26%><pre>device</pre>
</td>
<td width=74%><pre>segment</pre>
</td>
</tr>
<tr valign=top>
<td width=26%><pre>------------</pre>
</td>
<td width=74%><pre>------------------------------</pre>
</td>
</tr>
<tr valign=top>
<td width=26%><pre>bigdevice</pre>
</td>
<td width=74%><pre>default</pre>
</td>
</tr>
<tr valign=top>
<td width=26%><pre>bigdevice</pre>
</td>
<td width=74%><pre>system</pre>
</td>
</tr>
<tr valign=top>
<td width=26%><pre>logdev</pre>
</td>
<td width=74%><pre>logsegment</pre>
</td>
</tr>
<tr valign=top>
<td width=26%><pre>newdevice</pre>
</td>
<td width=74%><pre>default </pre>
</td>
</tr>
<tr valign=top>
<td width=26%><pre>newdevice</pre>
</td>
<td width=74%><pre>system </pre>
</td>
</tr>
</table><br>
<pre></pre>
<p class=indent1>
The DEFAULT and SYSTEM segments are mapped to the new space. In some cases, you might want to use the new space as default storage space for CREATE TABLE or CREATE INDEX statements. However, if you are adding space to assign a table or index to a specific segment (and therefore to specific devices), you will want to add your own segment and then drop the SYSTEM and DEFAULT segments.</p>
<ol start=5>
<li>
Create a new segment, NEW_SPACE, on NEWDEVICE:<pre>sp_addsegment new_space, newdevice</pre>
<p>
Here is just the portion of the <b>sp_helpdb</b> report that has changed (the portion that lists segment mapping):
</li>
</ol>
<table cellspacing=4 cols=2>
<tr valign=top>
<td width=31%><pre>device</pre>
</td>
<td width=69%><pre>segment</pre>
</td>
</tr>
<tr valign=top>
<td width=31%><pre>-----------------</pre>
</td>
<td width=69%><pre>------------------------------</pre>
</td>
</tr>
<tr valign=top>
<td width=31%><pre>bigdevice</pre>
</td>
<td width=69%><pre>default</pre>
</td>
</tr>
<tr valign=top>
<td width=31%><pre>bigdevice</pre>
</td>
<td width=69%><pre>system</pre>
</td>
</tr>
<tr valign=top>
<td width=31%><pre>logdev</pre>
</td>
<td width=69%><pre>logsegment</pre>
</td>
</tr>
<tr valign=top>
<td width=31%><pre>newdevice</pre>
</td>
<td width=69%><pre>default</pre>
</td>
</tr>
<tr valign=top>
<td width=31%><pre>newdevice</pre>
</td>
<td width=69%><pre>new_space</pre>
</td>
</tr>
<tr valign=top>
<td width=31%><pre>newdevice</pre>
</td>
<td width=69%><pre>system</pre>
</td>
</tr>
</table><br>
<pre></pre>
<p class=indent1>
Note that the DEFAULT and SYSTEM segments are still mapped to NEWDEVICE. If you are planning to use NEW_SPACE to store a specific user table or index for improved performance and you want to ensure that other user and system objects are not stored on the database device you just created, use <b>sp_dropsegment</b> to drop the DEFAULT and SYSTEM segments. </p>
<ol start=6>
<li>
Drop the SYSTEM and DEFAULT segments:<pre>sp_dropsegment system, newdevice 
&lt;execute&gt;    
sp_dropsegment 'default', newdevice</pre>
<p>
The quotation marks around DEFAULT are needed because it is a reserved word.
<p>
Here is the portion of the <b>sp_helpdb</b> report that shows the segment mapping:
<pre>device         segment 
-------------  --------------   
bigdevice      default   
bigdevice      system   
logdev         logsegment
newdevice      new_space</pre>
<p>
Now only NEW_SPACE is mapped to NEWDEVICE. Users who create objects can use ON NEW_SPACE to place a table or index on the database device that corresponds to that segment (NEWDEVICE). Since the DEFAULT segment is not using that database device, users who create tables and indexes without using the ON clause will not be placing them on NEWDEVICE.
<p>
If the ALTER DATABASE statement is used on NEWDEVICE again, the new fragment acquires the same segment mapping as the existing fragment of that database device ¾ the NEW_SPACE segment only.
<p>
At this point, if you use CREATE TABLE and name NEW_SPACE as the segment, you will get results such as the following from <b>sp_help</b> and <b>sp_helpsegment</b>:
<pre>create table mytable (c1 int, c2 datetime) on new_space 

sp_help mytable
Name      Owner         Type           When_created   
--------  ------------- -------------  --------------------   
mytable   dbo           user table     May 05 1995   3:21PM


Data_located_on_segment  
----------------------    
new_space                


Column_name  Type      Length  Prec   Scale  Nullable
-----------  ------    ------  -----  -----  ------------
c1           int       4                     yes   
c2           datetime  8                     yes


Identity                       Seed      Increment
-----------------------------  --------  -----------
No identity column defined     (null)    (null)

Object does not have any indexes.

constraint_type    constraint_name    constraint_keys
-----------------  -----------------  -----------------

FOREIGN KEYS
No defined keys for this object.


sp_helpsegment new_space

segment    name            status
--------- --------------- --------
  3        new_space       0


device         size   
---------      --------------
newdevice      3MB


table_name   index_name  indid 
-----------  ----------- -------   
mytable      mytable     0</pre>
</li>
</ol>
<p>
For more information about the system stored procedures and Transact-SQL statements used in this example, see the <i>Microsoft SQL Server Transact-SQL Reference</i>.</p>
<p>
</p>
<p>&nbsp;</p></body>
</HTML>
