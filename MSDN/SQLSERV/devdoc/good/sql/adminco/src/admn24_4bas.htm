<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<HTML dir=ltr>
<HEAD>
<META HTTP-EQUIV="Content-Type" Content="text/html; charset=Windows-1252">
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-83731338-2"></script><script>  window.dataLayer = window.dataLayer || [];  function gtag(){dataLayer.push(arguments);}  gtag('js', new Date());  gtag('config', 'UA-83731338-2');</script><title>Marking a Database Suspect</title>
<link disabled rel=stylesheet href=../../../../backsdk3.css>
<style type="text/css">
@import url(../../../../backsdk4.css);
</style>
</HEAD>
<BODY BGCOLOR = #FFFFFF TEXT = #000000>

<h2><a name="_marking_a_database_suspect"></a>Marking a Database Suspect</h2>
<p>
The <b>sp_marksuspect</b> procedure shown below turns on the suspect status bit on a particular database. Use this procedure to prepare a damaged database so that it can be dropped using DBCC DBREPAIR.</p>
<p>
Because this procedure modifies system tables, the system administrator must enable updates to the system tables before creating the procedure. To enable updates, use this procedure.</p>
<pre>use master
go
  
sp_configure 'allow updates',1
go
  
reconfigure with override
go
  </pre>
<p>
After the procedure is created, immediately disable updates to the system tables.</p>
<pre>sp_configure 'allow updates',0
go
  
reconfigure with override
go
  </pre>
<h5>Syntax</h5>
<p>
<b>sp_marksuspect</b> <i>database_name</i></p>
<h5>Example</h5>
<pre>sp_marksuspect PRODUCTION
  
Database 'PRODUCTION' status reset!
WARNING: You must reboot SQL Server prior to
         accessing this database!
  </pre>
<h5>Stored Procedure Code</h5>
<pre>CREATE PROC sp_marksuspect @dbname varchar(30) AS
    DECLARE @msg     varchar(80)
    IF @@trancount &gt; 0
        BEGIN
            PRINT "Can't run sp_marksuspect from within a transaction."
            RETURN (1)
        END
    IF suser_id() != 1
        BEGIN
            SELECT @msg = "You must be the System Administrator (SA) "
            SELECT @msg = @msg + "to execute this procedure."
            PRINT @msg
             RETURN (1)
        END
    IF (SELECT COUNT(*) FROM master..sysdatabases
             WHERE name = @dbname) != 1
         BEGIN
            SELECT @msg = "Database '" + @dbname + "' does not exist!"
            PRINT @msg
            RETURN (1)
        END 
IF (SELECT COUNT(*) FROM master..sysdatabases
                WHERE name = @dbname and status &amp; 256 = 256) = 1
        BEGIN
                SELECT @msg = "Database '" + @dbname + "' "
                SELECT @msg = @msg + "is already marked suspect."
                PRINT @msg
                RETURN (1)
        END
  
    BEGIN TRAN
        update master..sysdatabases set status = status | 256
            WHERE name = @dbname
    IF @@error != 0 or @@rowcount != 1 ROLLBACK TRAN
    ELSE
        BEGIN
            COMMIT TRAN
            SELECT @msg = "Database '" + @dbname + "' has been marked "                SELECT @msg = @msg + "suspect!"
            PRINT @msg
            PRINT " "
            SELECT @msg = "WARNING: This database should now be "
            SELECT @msg = @msg + "dropped via DBCC DBREPAIR."
            PRINT @msg
            PRINT " "
        END
go
  </pre>
<p>
</p>
<p>&nbsp;</p></body>
</HTML>
