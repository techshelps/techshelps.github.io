<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<HTML dir=ltr>
<HEAD>
<META HTTP-EQUIV="Content-Type" Content="text/html; charset=Windows-1252">
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-83731338-2"></script><script>  window.dataLayer = window.dataLayer || [];  function gtag(){dataLayer.push(arguments);}  gtag('js', new Date());  gtag('config', 'UA-83731338-2');</script><title>Manual Horizontal Partitioning</title>
<link disabled rel=stylesheet href=../../../../backsdk3.css>
<style type="text/css">
@import url(../../../../backsdk4.css);
</style>
</HEAD>
<BODY BGCOLOR = #FFFFFF TEXT = #000000>

<h2><a name="_manual_horizontal_partitioning"></a>Manual Horizontal Partitioning</h2>
<p>
Horizontal partitioning¾the replication of selected rows from the base table¾can easily be accomplished using SQL Enterprise Manager. However, as an option, you can create your own stored procedure to implement horizontal partitioning. The filter stored procedure must follow this format:</p>
<pre>CREATE PROCEDURE replica_filter FOR REPLICATION
AS

IF <i>sql_statement</i>
RETURN1
ELSE
RETURN 0</pre>
<p>
Using this procedure format, you could add partitioning to the examples provided in <a href="admn15_5a49.htm">Setting Up Replication Manually</a>.  </p>
<p>
For example, a horizontally partitioned article that published only the authors who live in California could be added to the <i>authors_publication</i> article. To do this, add the following steps to the replication setup script created in <a href="admn15_5a49.htm">Setting Up Replication Manually</a>. 
<ol>
<li>
Create the stored procedure used to qualify rows for publication. For example:<pre>use pubs
go
create procedure ca_authors_filter for replication as
if exists (select state from authors (NOLOCK) where state = 'CA')
return 1
else
return 0
go</pre>
</li>
<li>
Create a view that will be used to bulk copy out the data during synchronization. For example:<pre>create view ca_authors_view as select * from authors where state ='CA'
go</pre>
</li>
<li>
Add the article to the appropriate publication. For example:<pre>sp_addarticle authors_publication,ca_authors,authors, 
@creation_script = '\\WOLFHOUND\PUBLIC\ca_authors.sch',
@sync_object = ca_authors_view,
@filter = ca_authors_filter,
@dest_tab = ca_authors,
@description = "Horizontal partition of Authors where state = CA"
@type = 7
go</pre>
</li>
</ol>
<p>
Note that in this example, since both articles come from the same source table, it is necessary to define a separate destination table for the article. The creation script in this case is a modified copy of <i>authors.sch</i> with the table name changed to <i>ca_authors</i>. </p>
<p>
If desired, the results can be checked using <b>sp_helparticle</b> and <b>sp_helparticlecolumns</b>. For example:</p>
<pre>sp_helparticle
go
sp_helparticlecolumns authors_publication, ca_authors
go
</pre>
<p>
Additionally, in the creation script, you may want to take advantage of the NOT FOR REPLICATION constraint. For example, in the CREATE TABLE statement, you may want to add:</p>
<pre>CONSTRAINT ca_constraint CHECK NOT FOR REPLICATION (state &lt;&gt; 'CA')
</pre>
<p>
For information about using NOT FOR REPLICATION, see the <i>Microsoft SQL Server Transact-SQL Reference</i>. </p>
<p>
When a replication filter is executed, it requests a lock on the published table. This lock can cause a replication deadlock situation. Therefore, when setting up manual horizontal partitioning, create the filter with the optimizer hint NOLOCK on the published table.</p>
<p>
</p>
<p>&nbsp;</p></body>
</HTML>
