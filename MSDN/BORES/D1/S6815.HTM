<HTML><head><style>@import url(msdn_ie4.css);</style>
<link disabled rel="stylesheet" href="msdn_ie3.css"></HEAD>

<script async src="https://www.googletagmanager.com/gtag/js?id=UA-83731338-2"></script><script>  window.dataLayer = window.dataLayer || [];  function gtag(){dataLayer.push(arguments);}  gtag('js', new Date());  gtag('config', 'UA-83731338-2');</script><title>Replication Questions</TITLE><BODY BGCOLOR="#FFFFFF">


<H2 CLASS="h1">Replication Questions</H2><P CLASS="t">The following are questions commonly asked by SQL Server customers when installing and using the replication feature.</P>
<P CLASS="term1"><B>What are all the tasks in replication and how many can I expect to have on a distribution server?</B></P>
<P CLASS="dt1">A LogReader task exists for each published database on each publication server. This task is created when the database is marked as "published." Either the stored procedure <B>sp_dboption</B> or SQL Enterprise Manager can be used to mark a database as "published."</P>
<P CLASS="dt1">A Sync task exists for every publication created. This task is created by default when a publication is created using SQL Enterprise Manager. The task must be manually added if the publication is created outside SQL Enterprise Manager. One Sync task is used no matter how many articles exist in a given publication.</P>
<P CLASS="dt1">A Cleanup task is created for every publication server/subscription server combination. This task is created when a subscription server is enabled on the publication server. This task is created by the <B>sp_addsubscriber</B> stored procedure.</P>
<P CLASS="dt1">A Distribution task is created for every published database/subscribed database combination. This task is created when the first publication in a published database is subscribed to by a given subscription server. This task is created by either the <B>sp_addsubscription</B> or <B>sp_subscribe</B> stored procedure.</P>
<P CLASS="dt1">Remember that all tasks run on the distribution server, even if the distribution server and published database(s) are on different computers. </P>
<P CLASS="dt1">The example below explains how many distribution tasks can be created.</P>
<P CLASS="dt1">Assume that a distribution server is configured to handle five publication servers, each with one published database. Three subscription servers are configured to subscribe to at least one publication for each published database for each publication server. All publications are placed in the same database on each subscription server. </P>
<P CLASS="dt1">Based on this description, 15 distribution tasks will be required on the distribution server to handle this environment. If a given publication was subscribed to more than one time into a different database on the subscription server, this will increase the number of tasks required by the number of databases. In the example above, if each subscription server pulls each publication into five different databases, the number of tasks increases to 75. </P>
<P CLASS="lt1">The following table summarizes the expected number of tasks.</P>

<TABLE COLS="2" BORDER="0" CELLPADDING="7"><COLGROUP><COL WIDTH="111pt" VALIGN="TOP"><COL WIDTH="223pt" VALIGN="TOP"></COLGROUP><TBODY><TR><TD VALIGN="TOP"><P CLASS="thf">Task type</P></TD><TD VALIGN="TOP"><P CLASS="th">Number of tasks</P></TD></TR><TR><TD COLSPAN="2" VALIGN="TOP"><P CLASS="tr"></P></TD></TR><TR><TD VALIGN="TOP"><P CLASS="tt">LogReader </P></TD><TD VALIGN="TOP"><P CLASS="tt">1 per published database</P></TD></TR><TR><TD VALIGN="TOP"><P CLASS="tt">Sync </P></TD><TD VALIGN="TOP"><P CLASS="tt">1 per publication</P></TD></TR><TR><TD VALIGN="TOP"><P CLASS="tt">Distribution </P></TD><TD VALIGN="TOP"><P CLASS="tt">1 per published database/subscribed database combination</P></TD></TR><TR><TD VALIGN="TOP"><P CLASS="tt">Cleanup (<B>sp_replcleanup</B>)</P></TD><TD VALIGN="TOP"><P CLASS="tt">1 per publication server/subscription server combination</P></TD></TR></TBODY></TABLE>
<P CLASS="spacing"><BR></P><P CLASS="term1"><B>What is the difference between a "filter stored procedure" and a "custom stored procedure"?</B></P>
<P CLASS="dt1">A filter stored procedure, created to support horizontal partitioning, allows changes to be filtered before they are stored in the distribution database. A filter stored procedure can be generated by SQL Enterprise Manager or created manually by using the CREATE PROCEDURE FOR REPLICATION Transact-SQL statement. A filter stored procedure is executed in the context of the LogReader task and is applied against the changes read from the published database transaction log before jobs are placed in the distribution database.</P>
<P CLASS="dt1">A custom stored procedure is a hook provided for advanced replication situations. This is a procedure created by an application developer to replace a standard INSERT, UPDATE, or DELETE statement that will be executed against the subscription server. A procedure of this type should be used if you need to perform any special processing on the subscription server instead of the standard INSERT, UPDATE, or DELETE statement.</P>
<P CLASS="dt1">The custom procedure is specified when defining an article and must be created on the subscription server. When a job is placed in the distribution database for an article with a custom stored procedure, the procedure name will be placed in the <B>MSjob_commands</B> table as the command to run for the job in the distribution database. The distribution task will then execute the procedure on the subscription server.</P>
<P CLASS="dt1">Here is an example that uses the INSERT statement to create a custom stored procedure for the <B>employee</B> table in the <B>pubs</B> database. More code could be added to this example to customize it for your needs.</P>
<P>create procedure myinsert @emp_id char(9), @fname varchar(20), </P>
<p>&nbsp;&nbsp;&nbsp;&nbsp;@minit char(1), @lname varchar(30), @job_id smallint, </P>
<p>&nbsp;&nbsp;&nbsp;&nbsp;@job_lvl tinyint, @pub_id char(4), @hire_date datetime</P>
<P>as</P>
<P>insert into employee values (@emp_id, @fname, @minit, @lname, @job_id,     @job_lvl, @pub_id, @hire_date)</P>
<P></P>
<P CLASS="term1"><B>Does SQL Server support multiple publication servers of the same table?</B></P>
<P CLASS="dt1">One of the most common questions is how many servers can modify and publish the same table. While SQL Server replication is a strategic component of Microsoft's distributed computing platform, it is not designed to be a fully distributed database management system.</P>
<P CLASS="dt1">SQL Server replication is not designed to handle collisions between two publishing servers. If one server updates a row that another server is trying to delete and the changes are replicated to each other, a collision can result. One possible result of the collision is that the distribution task of the server trying to replicate the update command will fail because the row it is trying to update no longer exists on the subscription server. Even worse, infinite loops of changes could result if publications are not properly defined. </P>
<P CLASS="dt1">Replication can support multiple publishers of the same table provided that each publisher owns a unique or discrete set of rows within the table. Each publisher would provide a method, such as a stored procedure, to prevent any modifications or inserts of rows outside the set it owns. This can easily be accomplished by including in the table a column that designates ownership and then using an horizontally partitioned article to publish that table.</P>
<P CLASS="term1"><B>What is the best way to monitor replication of changes to subscription servers?</B></P>
<P CLASS="dt1">There is no one "best" method to monitor proper replication of changes to a subscription server. Devising your own method to fit your environment is the recommended approach. Provided that the LogReader, Sync, and Distribution tasks are not encountering any errors, all changes should be replicated properly. If you suspect a particular transaction was not executed on a subscription server, it might be helpful to examine rows in the <B>MSjob_commands</B> table of the distribution database. This table contains all SQL statements that will be executed against subscription servers. The syntax of these commands may appear to be unusual under certain circumstances because all commands adhere to the ODBC SQL Grammar specifications.</P>
<P CLASS="dt1">Another table that is useful for monitoring replication is the <B>MSlast_job_info</B> table that is created on the subscription server database. This table will contain the last successful job that was applied to a subscription server for a given publication server. It can be compared with the <B>MSjobs</B>, <B>MSjob_commands</B>, and <B>MSsubscriber_jobs</B> tables to determine what jobs have and have not been applied to the subscription server.</P>
<P CLASS="term1"><B>Can Windows NT Server names conflict with replication?</B></P>
<P CLASS="dt1">If the characters in the name of your Windows NT server conflict with the valid list of characters that SQL Server supports for an identifier, you will run into problems when setting up replication. The SQL Server program issues a warning when installing the product if the Windows NT server name will cause problems when setting up replication.</P>
<P CLASS="dt1">The most common cause of this problem is a hyphen [-] or space character in the Windows NT computer name as defined in the Networks application in Control Panel.</P>
<P CLASS="term1"><B>What are "job batch size" and "commit batch size"?</B></P>
<P CLASS="dt1">Job batch size is parameter <B>-b</B> that can be configured for both a LogReader and Distribution task to control the maximum number of jobs processed by both tasks. For a LogReader task, this is the maximum number of jobs, or transactions, that will be read out of the transaction log and placed into the distribution database. This parameter is actually called <I>transbatchsize</I>. The default is 100 and is passed as a parameter to <B>sp_replcmds</B> to extract, at most, this number of committed transactions from the published database transaction log. The commit batch size <B>-c</B> is by default the same as the job batch size for the LogReader unless explicitly specified. It defines the maximum number of jobs that are applied to the distribution database before a COMMIT TRAN statement is executed. Decreasing this value from its default may help reduce deadlock contention between LogReader and Distribution tasks, but this could also affect the performance of a LogReader task.</P>
<P CLASS="dt1">The job batch size for the distribution task defines the maximum number of jobs that will be read from the distribution database to execute on a subscription server. The commit batch size defines the maximum number of jobs that will be executed on a subscription server before a COMMIT TRAN statement is executed on the subscription server.</P>
<P CLASS="dt1">An example may help clarify these terms. If the LogReader were configured with a job batch size of ten, it would read at most ten jobs, or transactions, at a time from the published database transaction log, and add these to the distribution database. If the commit batch size is not explicitly specified, all ten jobs would be added to the distribution database in one logical transaction—the BEGIN/COMMIT block. However, if the commit batch size were reduced to five, then five jobs at a time would be committed in one logical transaction against the distribution database. This same concept applies to the Distribution task against the subscription server. If the subscription server republishes the changes from the Distribution server, what was originally ten transactions from the publication server may now appear to be one transaction because the Distribution task committed the ten jobs as one logical transaction. Large commit batch sizes from the Distribution task can result in very large transactions to process for subscription servers that republish.</P>
<P CLASS="dt1">Be careful when reducing these parameters to extremely low numbers if the volume of replicated transactions is high. This may help to reduce deadlock situations, but it could decrease performance. Only proper testing for your environment will indicate what the optimal setting should be. For most users, the defaults provide a good base to work from.</P></BODY></HTML>
