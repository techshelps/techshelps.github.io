<HTML><head><style>@import url(msdn_ie4.css);</style>
<link disabled rel="stylesheet" href="msdn_ie3.css"></HEAD>

<script async src="https://www.googletagmanager.com/gtag/js?id=UA-83731338-2"></script><script>  window.dataLayer = window.dataLayer || [];  function gtag(){dataLayer.push(arguments);}  gtag('js', new Date());  gtag('config', 'UA-83731338-2');</script><title>Orphaned Connections</TITLE><BODY BGCOLOR="#FFFFFF">


<H2 CLASS="h1">Orphaned Connections</H2><P CLASS="t"><B><I>When orphaned processes occur, here's how to troubleshoot the problem.</I></B></P>
<P CLASS="t">When a SQL Server client disconnects from a SQL Server, the connection process should be cleared up on the server side. If the connection processes are not cleared up, they become <I>orphaned</I> or <I>ghost</I> processes that use up valuable resources like locks and user connections. The orphaned processes are typically caused by improper closing of client applications and network-related problems, and the remedies usually require troubleshooting client applications and fine-tuning network configurations.</P>
<P CLASS="t">When you troubleshoot this problem, keep the following in mind:</P>
<SPAN CLASS="list"><UL><LI CLASS="ULI1">SQL Server does not and should not proactively probe the client connection to determine its current status.
<P CLASS="lt1">The lower-level IPCs such as named pipes, SPX/IPX, or TCP/IP sockets are responsible for managing the client connections.</P></LI><LI CLASS="ULI1">An IPC typically has its own mechanism to manage the client connections.
<P CLASS="lt1">When client connections are nonresponsive for a certain amount of time, the Windows NT Server typically will either detect this by sending the "keep alive" probes or clear the connection after it idles for a configured amount of time.</P></LI><LI CLASS="ULI1">Under certain situations, such as client GP-fault or hang, the client may still respond to server probes even if the application is already dead.
<P CLASS="lt1">In this case, the Windows NT Server may keep this client connection indefinitely, as long as the client is not shut down.</P></LI><LI CLASS="ULI1">If a Windows NT Server does not terminate a dead connection, SQL Server assumes the connection is still active and does not clear it up.</LI><LI CLASS="ULI1">If the Windows NT Server has successfully terminated the connection but the client connection still exists on the SQL Server (indicated by <B>sp_who</B>), there may be a problem with SQL Server's connection management.
<P CLASS="lt1">Contact your primary support provider to resolve this issue.</P></LI></UL></SPAN><P CLASS="t">If you suspect orphaned processes exist on your SQL Server, the following are steps you can take to troubleshoot the problem:</P>
<P CLASS="ls">Identify the orphaned processes using <B>sp_who</B>.</P>
<P CLASS="lt1">This will indicate the applications that were associated with these processes.</P>
<P CLASS="ls">After you identify the orphaned processes, you can choose to either ignore them (if they are not holding any locks or using many connections) or kill them using the SQL Server KILL statement.</P>
<P CLASS="ls">Check with application users to ascertain if they have closed applications incorrectly; correct any improper procedures.</P>
<P CLASS="lt1">An example of incorrectly closing an application is doing a warm or cold reboot of a workstation without first exiting all applications.</P>
<P CLASS="ls">Check the history of the workstation and correct stability problems.</P>
<P CLASS="lt1">Some examples of an unstable workstation are hangs and GP-faults.</P>
<P CLASS="ls">Check whether the IPC session is still active on the Windows NT Server where SQL Server is running.</P>
<P CLASS="lt1">Depending on which IPC you use, the commands for using it are different. For example, if you are using named pipes, the command is NET SESSION or NET FILES. If you are using TCP/IP sockets, you can use NETSTAT to display active TCP sessions. If you are using SPX/IPX, you may have to use Performance Monitor to monitor the open connections<B> </B>for NWLink<B> </B>SPX.</P>
<SPAN CLASS="list"><UL><LI CLASS="ULI2">named pipes: Windows NT Server depends on clients to initiate "keep alive" traffic. If the client stops sending "keep alive" packets, Windows NT Server clears the client session after waiting for a configured amount of idle time. The idle time is configured in the <B>autodisconnect</B> parameter of the Windows NT Registry:</LI></UL></SPAN><p>&nbsp;&nbsp;&nbsp;&nbsp;HKEY_LOCAL_MACHINE</P>
<p>&nbsp;&nbsp;&nbsp;&nbsp;  \SYSTEM</P>
<p>&nbsp;&nbsp;&nbsp;&nbsp;    \CurrentControlSet</P>
<p>&nbsp;&nbsp;&nbsp;&nbsp;      \Services</P>
<p>&nbsp;&nbsp;&nbsp;&nbsp;        \LanmanServer</P>
<p>&nbsp;&nbsp;&nbsp;&nbsp;          \Parameters</P>
<P></P>
<SPAN CLASS="list"><UL><LI CLASS="ULI2">TCP/IP sockets: Windows NT Server periodically sends "keep alive" packets to clients, and clients are expected to respond. If the client fails to respond to those packets, Windows NT clears the TCP session after trying for a configured number of times. The parameters involved are <B>KeepaliveInterval</B> and <B>KeepaliveTime</B> in the Windows NT Registry:</LI></UL></SPAN><p>&nbsp;&nbsp;&nbsp;&nbsp;HKEY_LOCAL_MACHINE</P>
<p>&nbsp;&nbsp;&nbsp;&nbsp;  \SYSTEM</P>
<p>&nbsp;&nbsp;&nbsp;&nbsp;    \CurrentControlSet</P>
<p>&nbsp;&nbsp;&nbsp;&nbsp;      \Services</P>
<p>&nbsp;&nbsp;&nbsp;&nbsp;        \Tcpip</P>
<p>&nbsp;&nbsp;&nbsp;&nbsp;          \Parameters</P>
<P></P>
<SPAN CLASS="list"><UL><LI CLASS="ULI2">SPX/IPX: Similar to its behavior with TCP/IP, Windows NT Server periodically sends "keep alive" packets and clients respond. Windows NT clears the SPX connections if no responses are received after the configured number of "keep alive" packets are sent. The parameters involved are <B>KeepAliveCount</B> and <B>KeepAliveTime-out</B> in the Windows NT Registry:</LI></UL></SPAN><p>&nbsp;&nbsp;&nbsp;&nbsp;HKEY_LOCAL_MACHINE</P>
<p>&nbsp;&nbsp;&nbsp;&nbsp;  \SYSTEM</P>
<p>&nbsp;&nbsp;&nbsp;&nbsp;    \CurrentControlSet</P>
<p>&nbsp;&nbsp;&nbsp;&nbsp;      \Services</P>
<p>&nbsp;&nbsp;&nbsp;&nbsp;        \NWLnkSPX</P>
<p>&nbsp;&nbsp;&nbsp;&nbsp;          \Parameters</P>
<P></P>
<P CLASS="lt1"><B>Note</B>   If the "keep alive" parameters for your IPCs are configured to never time out, Windows NT keeps the IPC sessions indefinitely, even if the clients are completely shut down. In this case, SQL Server also keeps these client processes indefinitely.</P>
<P CLASS="lt1">For more information about the parameters, see your Windows NT documentation or your Windows NT Resource Kit. If you suspect your Windows NT Server does not clear those sessions according to your configuration parameters, contact your primary support provider.</P>
<P CLASS="ls">If the IPC session no longer exists on the Windows NT Server but SQL Server still keeps client processes (shown by <B>sp_who</B>), you can use the KILL statement to clear the process as a temporary solution, and then contact your primary support provider for further assistance.</P></BODY></HTML>
