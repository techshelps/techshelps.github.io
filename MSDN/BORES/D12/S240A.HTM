<HTML><head><style>@import url(msdn_ie4.css);</style>
<link disabled rel="stylesheet" href="msdn_ie3.css"></HEAD>

<script async src="https://www.googletagmanager.com/gtag/js?id=UA-83731338-2"></script><script>  window.dataLayer = window.dataLayer || [];  function gtag(){dataLayer.push(arguments);}  gtag('js', new Date());  gtag('config', 'UA-83731338-2');</script><title>Routing to a Different Site or Foreign System</TITLE><BODY BGCOLOR="#FFFFFF">


<H3 CLASS="h2">Routing to a Different Site or Foreign System</H3><P CLASS="t">Messages sent to recipients in other sites or systems are delivered through connectors. Understanding how routing works helps you determine how many connectors to use and how to configure them for efficient delivery. The Microsoft Exchange Server MTA can route messages to the following:</P>
<UL><LI>Another Microsoft Exchange Server MTA in a different site using a Site Connector or a Dynamic RAS Connector.</LI><LI>A remote X.400 MTA using the X.400 Connector.</LI><LI>Other connectors or gateways that connect to foreign systems, such as the Microsoft Mail Connector or the Internet Mail Connector.</LI></UL><P CLASS="t">Two processes are used to determine which connector a message is sent through: <I>routing</I> determines all the connectors that can deliver the message and s<I>election</I> determines the most efficient connector to use.</P>
<P CLASS="t"><B>Connector Routing</B></P>
<P CLASS="t">Messages to other systems are routed using the appropriate address for the system, such as an SMTP address for a message traveling through the Internet.</P>
<P CLASS="t">Each connector has at least one address space and can have one or more connected sites associated with it. Address space and connected sites information is defined on the <B>Address Space</B> and <B>Connected Sites</B> property pages in the Microsoft Exchange Server Administrator program. These associations create the Gateway Routing Table (GWART). The GWART is replicated throughout the organization, so each server is aware of all possible routes.</P>
<P CLASS="t">When a message is sent, the MTA compares the recipient's address type with the GWART to determine the connectors that can deliver the message. There are three groups of address types.</P>
<P CLASS="t"><B>Distinguished Name (DN)    </B>This address type is only searched when a DN for the recipient is found in the directory. This Microsoft Exchange Server address type is EX.</P>
<H4 CLASS="h4"><A NAME="sec0"></A>Domain Defined Attribute (DDA)</H4><P CLASS="t">The DDA is the format for a custom recipient address. The address types MS and SMTP are created automatically. Other DDA addresses can be used with custom or third-party gateways.</P>
<H4 CLASS="h4"><A NAME="sec1"></A>O/R Address</H4><P CLASS="t">This is the X.400 address. The address type is X400.</P>
<P CLASS="t">Each line of the GWART indicates an available path the MTA can use to route messages. The MTA scans the GWART to find an address space that matches the recipient's address and chooses connectors with address spaces similar to the recipient's address. You can view the contents of the GWART, including the address type each connector routes, in the <B>Routing</B> property page of the Site Addressing object as shown in the following illustration.</P>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<img src="xerk_e05.gif"></P>
<P></P>
<P CLASS="t">If more than one connector can send the message, a connector selection process determines the most efficient connector to use. If no connectors can service the address space, the message is returned to the originator as nondeliverable.</P>
<P CLASS="t"><B>Connector Selection</B></P>
<P CLASS="t">A selection process is used to identify the connector that can most efficiently deliver the message. Each time a connector or group of connectors meets the connector selection criteria, it is passed to the next step. Each of these steps applies to MTA-to-MTA connections, which includes the X.400 Connector, the Dynamic RAS Connector, and the Site Connector. Connectors and gateways for foreign systems are chosen based only on the address spaces they process and the address space cost. You can influence which connectors are chosen by adjusting some of the settings used in the process.</P>
<P CLASS="t">The following illustration shows the steps the MTA uses to select a connector.</P>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<img src="xerk_e06.gif"></P>
<P CLASS="t">A description of each step follows.</P>
<H4 CLASS="h4"><A NAME="sec2"></A>Comparing open retry count to max open retries</H4><P CLASS="t">The <I>open retry count</I> is the number of times the MTA has attempted to transfer a message using a specific connector. <I>Max open retries</I> is a setting on each connector, except foreign system connectors. It specifies the number of times a message can attempt to be transferred through that connector. Connectors that have an open retry count less than the max open retry value are chosen.</P>
<H4 CLASS="h4"><A NAME="sec3"></A>Choosing active connectors</H4><P CLASS="t">Site Connectors, Internet Mail Connectors, and Microsoft Mail Connectors are always active. X.400 Connectors and Dynamic RAS Connectors have activation schedules. There are four settings for the activation schedules: active now, active in the future, never active, and remote initiated.</P>
<P CLASS="t">All active connectors are chosen first, and then a group of connectors that will become active next is chosen. If no connectors are active and none will become active, connectors that are initiated remotely are chosen.</P>
<H4 CLASS="h4"><A NAME="sec4"></A>Choosing connectors with low retry counts</H4><P CLASS="t">The open retry count starts when the connection to the remote MTA fails. The connector attempts to establish the connection again when the open retry timer expires. The number of times the connector attempts the connection is based on how the max open retries setting is configured. The open retry counters are compared to each other, and connectors with the lowest number of open retries are chosen.</P>
<H4 CLASS="h4"><A NAME="sec5"></A>Choosing connectors that have not failed</H4><P CLASS="t">Each MTA maintains an open retry timer for each connector that is on the same server. Connectors on other servers skip this step. The open retry timer begins as soon as a connection fails. Any connector that is not in a retry state is chosen. The open interval value determines how long the connector waits before attempting the connection again. This prevents the MTA from routing a message to a connector that failed the last time it tried to establish a connection.</P>
<P CLASS="t">For example, if you are using a Site Connector and Dynamic RAS Connector and the local area network (LAN) is down, a message is routed to the Site Connector because it has a lower cost. The connection fails because the LAN is down so the message is routed to the Dynamic RAS Connector. The next message to arrive before the open retry timer expires on the Site Connector is routed directly to the Dynamic RAS Connector.</P>
<H4 CLASS="h4"><A NAME="sec6"></A>Comparing costs</H4><P CLASS="t">You specify costs when the address space is determined for each connector. Connectors with the lowest cost are chosen first.</P>
<H4 CLASS="h4"><A NAME="sec7"></A>Choosing local connectors</H4><P CLASS="t">A local connector can send the message directly to the remote site, as in a messaging bridgehead server. Remote connectors require the MTA to pass the message to a messaging bridgehead server before the message can be passed to the remote site. Using local connectors reduces the need for additional processing power and increased bandwidth required to transmit the message.</P>
<H4 CLASS="h4"><A NAME="sec8"></A>Load Balancing</H4><P CLASS="t">If more than one connector is chosen to deliver a message, load balancing is implemented. In load balancing, one of the connectors is chosen randomly, rather than by queue size, message size, or other variables.</P>
<P CLASS="t">If more than one Site Connector is selected, the MTA chooses a connector based on cost. Target MTAs with a cost of 0 are tried first, and target MTAs with a cost of 100 are tried last. Random selection is used only after all target MTAs with a cost of 0 have been tried. All target MTAs are tried before the message is rerouted. You can influence which Site Connectors are used more frequently by adjusting the cost value assigned to each connector.</P>
<P CLASS="t">For more information about using target MTAs and connection costs, see the <I>Microsoft Exchange Server Concepts and Planning Guide</I> and the <I>Microsoft Exchange Server Administrator's Guide</I>.</P>
<P CLASS="t"><B>Rerouting and Retries</B></P>
<P CLASS="t">If the message is not sent to the connector, the MTA attempts to reroute the message. When a message is rerouted, the MTA performs routing and selection again to find the most efficient connector.</P>
<P CLASS="t">When a message is sent to a connector or gateway for a foreign system, such as the Microsoft Mail Connector or the Internet Mail Connector, the MTA considers the message delivered when it reaches the connector. Rerouting does not occur, even if the foreign system connector cannot deliver the message.</P>
<P CLASS="t">A message routed to a connector with an activation schedule of never active or remote initiated is not rerouted unless the activation schedule is changed while the message is waiting to be delivered.</P>
<P CLASS="t">The max transfer retries and transfer interval settings in the <B>Override</B> property page for the Site Connector, Dynamic RAS Connector, and X.400 Connector determine how many times and at what interval the MTA sends a message through the connector. A retry count is stored on each message for each connector that has been tried.</P>
<P CLASS="t">When a message is routed to a connector that fails to connect to the other MTA, the retry count is incremented and the message is immediately rerouted. If the message cannot be delivered after all the connectors have been tried, the message is returned with a non-delivery report (NDR).</P>
<P CLASS="t"></P></BODY></HTML>
