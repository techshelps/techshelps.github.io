<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<HTML dir=ltr>
<HEAD>
<META HTTP-EQUIV="Content-Type" Content="text/html; charset=Windows-1252">
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-83731338-2"></script><script>  window.dataLayer = window.dataLayer || [];  function gtag(){dataLayer.push(arguments);}  gtag('js', new Date());  gtag('config', 'UA-83731338-2');</script><title>Nondelivery Report Envelope Properties</title>
<link disabled rel=stylesheet href=../../backsdk3.css>
<style type="text/css">
@import url(../../backsdk4.css);
</style>
</HEAD>
<BODY BGCOLOR = #FFFFFF TEXT = #000000>

<h3><a name="_gdk_nondelivery_report_envelope_properties"></a>Nondelivery Report Envelope Properties</h3>
<p>
The envelope is a MAPI message that contains the following properties.</p>
<h4>PR_MESSAGE_CLASS</h4>
<p>
PR_MESSAGE_CLASS is used for the message class. This property should be in the form REPORT.<i>X</i>.NDR, where <i>X</i> is the message class of the original message. If the original message is unavailable, this property should be set to REPORT.IPM.Note.NDR.</p>
<h4>PR_REPORT_DESTINATION NAME and PR_DESTINATION_ENTRY_ID</h4>
<p>
PR_REPORT_DESTINATION NAME and  PR_DESTINATION_ENTRY_ID are address properties for the recipient of the nondelivery report. These properties should always be available on the original message. If the original message is unavailable, they can be determined through the same mechanism that the gateway uses to map recipient addresses on incoming mail, such as proxy address lookup.</p>
<p>
Microsoft Exchange Server reports can only be sent to a single recipient. If a gateway receives a nondelivery report that must go to multiple recipients, the gateway must create and submit several messages.</p>
<h4>PR_MTS_SUBJECT_ID</h4>
<p>
PR_MTS_SUBJECT_ID is used for the Message Transfer System (MTS) identifier from the original message. In the X.400 model, a message is given an MTS identifier when it enters the MTS for delivery. When a Microsoft Exchange Server message is submitted to a gateway, the MTS identifier is written into the message’s PR_MTS_ID property.</p>
<p>
If the original message and its envelope are available when a nondelivery report is created, the PR_MTS_SUBJECT_ID property on the report should be copied from the PR_MTS_ID property of the original message.</p>
<p>
If the original message and its envelope are unavailable, there are two alternatives:
<ul>
<li>
The PR_MTS_ID value from the original message can be saved through some other mechanism such as a database local to the gateway.</li>
<li>
A value for PR_MTS_SUBJECT_ID on the report can be invented. To successfully send a Microsoft Exchange Server nondelivery report, PR_MTS_SERVER_ID must have the correct format, but the actual content is not validated.</li>
</ul>
<p>
PR_MTS_SUBJECT_ID is a binary MAPI property that it must contain a null-terminated string. The data pointer of a PR_MTS_SUBJECT_ID <b>SPropValue</b> structure must point to a null-terminated string and the byte count must include the terminating null.</p>
<p>
The correct format for PR_MTS_SUBJECT_ID is:</p>
<p>
c=country name;a=ADMD name;p=PRMD ID;l=local ID\0</p>
<p>
where the parameters can be anything that meets the requirements for X.400 MTS identifiers. </p>
<p>
An invented value for PR_MTS_SUBJECT_ID should contain a reasonable approximation of true MTS ID values. The gateway can obtain correct values for <i>country name</i>, <i>ADMD name</i>, and <i>PRMD ID</i> in several ways:
<ul>
<li>
Read them from the gateway’s Mail-Gateway directory object.</li>
<li>
Extract them from the gateway’s X.400 Gateway-Proxy attribute.</li>
<li>
Extract them from the PR_MTS_ID property of a message sent to the gateway.</li>
<li>
Extract them from the first trace entry of a message sent to the gateway.</li>
</ul>
<p>
The value for <i>Local ID</i> in an MTS ID should be chosen so that it encapsulates whatever identifying information was available from the foreign system. This could be a correlation identifier, a foreign message identifier, or other information.</p>
<p>
For example, the following value is a syntactically correct PR_MTS_SUBJECT_ID string:</p>
<p>
c=US;a= ;p=Microsoft;l=&lt;"Hui-z2.0.v54.7xA4o"@xyz-corp.com&gt;\0</p>
<p>&nbsp;</p></body>
</HTML>
