<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<HTML dir=ltr>
<HEAD>
<META HTTP-EQUIV="Content-Type" Content="text/html; charset=Windows-1252">
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-83731338-2"></script><script>  window.dataLayer = window.dataLayer || [];  function gtag(){dataLayer.push(arguments);}  gtag('js', new Date());  gtag('config', 'UA-83731338-2');</script><title>Using MAPI in Multithreaded Applications</title>
<link disabled rel=stylesheet href=../../backsdk3.css>
<style type="text/css">
@import url(../../backsdk4.css);
</style>
</HEAD>
<BODY BGCOLOR = #FFFFFF TEXT = #000000>

<h1><a name="_edk_using_mapi_in_multithreaded_applications"></a>Using MAPI in Multithreaded Applications</h1>
<p>
A thread is the basic entity to which a 32-bit operating system allocates CPU time. A thread has its own registers, stack, priority, and storage, but shares an address space and process resources such as access tokens. Threads also share memory, with one thread reading what another thread has written. </p>
<p>
MAPI clients and <a href="glossary_1ooj.htm#_edk_service_provider">service providers</a> such as Microsoft Exchange Server use the following generic threading models.</p>
<table cellspacing=4 cols=2>
<tr valign=top>
<th align=left width=47%>Threading model</th>
<th align=left width=53%>Description</th>
</tr>
<tr valign=top>
<td width=47%>Single threading model</td>
<td width=53%>All objects are used on the single thread.</td>
</tr>
<tr valign=top>
<td width=47%>Apartment threading model</td>
<td width=53%>An object is used only on the thread that created it.</td>
</tr>
<tr valign=top>
<td width=47%>Free threading (thread-party) model</td>
<td width=53%>An object is used on any thread.</td>
</tr>
</table><br>
<p>
<a href="glossary_1ood.htm#_edk_mapi">MAPI</a> and MAPI service providers use the free threading model, supporting thread-safe objects that can be used on any thread at any time. The current version of OLE uses the apartment threading model. The apartment threading model supports objects that must be explicitly transferred when a thread that did not create an object uses that object.</p>
<p>
The mechanism used by OLE to transfer objects from one thread to another is known as marshaling. Marshaling involves a stub object and a proxy object. These objects package the parameters of the interface in the object to be marshaled, transfer these parameters to the other thread, and unpackage them upon arrival. Conflict between the two multithreaded models arises when a free-threading MAPI object is sent to another process using OLE LRPC (Lightweight Remote Procedure Call). LRPC changes the object’s semantics from free threading to apartment threading by interposing stub and proxy interfaces with apartment threading behavior between the object and its caller. Awareness of the situations in MAPI that lead to this conflict helps prevent problems between clients and service providers. </p>
<p>
A MAPI object can be accessed in the following ways:
<ul>
<li>
Through direct calls to its methods using an interface pointer returned by a service provider or MAPI linked to the client’s process, such as the session object returned from <b>MAPILogonEx</b>.</li>
<li>
Through indirect calls to its methods using an interface pointer returned by any service provider, such as the folder object copied from another folder in <b>IMAPIFolder::CopyFolder</b>.</li>
<li>
Through a callback function, such as the <b>IMAPIAdviseSink::OnNotify</b> method passed to a service provider or to MAPI in an <b>Advise</b> call or the methods that can show progress on a lengthy operation.</li>
</ul>
<p>
</p>
<p>&nbsp;</p></body>
</HTML>
