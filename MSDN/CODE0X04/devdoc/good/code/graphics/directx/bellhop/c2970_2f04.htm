<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<HTML dir=ltr>
<HEAD>
<META HTTP-EQUIV="Content-Type" Content="text/html; charset=Windows-1252">
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-83731338-2"></script><script>  window.dataLayer = window.dataLayer || [];  function gtag(){dataLayer.push(arguments);}  gtag('js', new Date());  gtag('config', 'UA-83731338-2');</script><title>CONNSET.CPP</title>
<link disabled rel=stylesheet href=../../../../../backsdk3.css>
<style type="text/css">
@import url(../../../../../backsdk4.css);
</style>
</HEAD>
<BODY BGCOLOR = #FFFFFF TEXT = #000000>
<h2><a name="_code_context2974"></a>CONNSET.CPP</h2>
<pre><code>/*========================================================================== <br> * <br> *  Copyright (C) 1997 Microsoft Corporation.  All Rights Reserved. <br> * <br> *  File:       ConnSet.cpp <br> *  Content:A dialog to set and get Group connection settings for a lobby <br> * <br> ***************************************************************************/ <br> <br>#include "Bellhop.h" <br> <br>HRESULTGetConnectionSPGuid(HWND hWnd, int idCombo, GUID *lpGuidSP); <br>HRESULTGetComboBoxGuid(HWND hWnd, LONG iDialogItem, LPGUID lpguidReturn); <br>HRESULT SetGroupConnection(HWND hWnd, LPLOBBYGROUPCONTEXT lpContext); <br>BOOL CALLBACK LobbyGroupWndProc(HWND hWnd, UINT uMsg, WPARAM wParam, LPARAM lParam); <br>BOOL InitConnectionSettingsDialog(  HWND hWnd, LPLOBBYGROUPCONTEXT lpContext); <br>BOOL FAR PASCALEnumApp(LPCDPLAPPINFO lpAppInfo, LPVOID lpContext, DWORD dwFlags); <br>BOOL FAR PASCAL DirectPlayEnumConnectionsCallback( <br>LPCGUIDlpguidSP, <br>LPVOIDlpConnection, <br>DWORDdwSize, <br>LPCDPNAMElpName, <br>DWORDdwFlags, <br>LPVOIDlpContext); <br> <br> <br>/////////////////////////////////////////////////////////////////////////////////////// <br>BOOL InitConnectionSettingsDialog( HWND hWnd, LPLOBBYGROUPCONTEXT lpContext) <br>{ <br>BOOLbRet= FALSE, <br>bFound; <br>intiNum= 0, <br>i, <br>lParam; <br>LPCONNECTIONINFOlpci= NULL; <br>LPGUIDlpGuid= NULL; <br>LPDPLCONNECTIONlpdpconn = NULL; <br>HRESULThr; <br>ENUMCONNSTRUCTenStruct; <br>DWORDdwSize; <br> <br>HWNDhSPComboBox = GetDlgItem( hWnd, IDC_GROUPCONNECTIONSPCOMBO );  <br>HWNDhAppComboBox = GetDlgItem( hWnd, IDC_APPCOMBO );  <br> <br>// put all the DirectPlay applications in a combo box <br>lpContext-&gt;lpDPInfo-&gt;lpDirectPlayLobby2A-&gt;EnumLocalApplications(EnumApp, hWnd, 0); <br> <br>// put all the available connections in a combo box <br>enStruct.hWnd = hWnd; <br>enStruct.idCombo = IDC_GROUPCONNECTIONSPCOMBO; <br> <br>hr = IDirectPlay3_EnumConnections(lpContext-&gt;lpDPInfo-&gt;lpDirectPlay3A,  <br>&amp;BELLHOP_GUID,  <br>DirectPlayEnumConnectionsCallback, <br>&amp;enStruct, DPCONNECTION_DIRECTPLAY ); <br>if (FAILED(hr)) <br>goto FAILURE; <br> <br>dwSize = 0; <br>hr = IDirectPlay3_GetGroupConnectionSettings( lpContext-&gt;lpDPInfo-&gt;lpDirectPlay3A,  <br>0, lpContext-&gt;dpidRoom, lpdpconn, &amp;dwSize ); <br> <br>if (DPERR_BUFFERTOOSMALL != hr) <br>goto FAILURE; <br> <br>lpdpconn = (LPDPLCONNECTION) GlobalAllocPtr( GHND, dwSize ); <br>if (NULL == lpdpconn) <br>goto FAILURE; <br> <br>hr = IDirectPlay3_GetGroupConnectionSettings( lpContext-&gt;lpDPInfo-&gt;lpDirectPlay3A,  <br>0, lpContext-&gt;dpidRoom, lpdpconn, &amp;dwSize ); <br> <br>if (FAILED(hr)) <br>goto FAILURE; <br> <br> <br>iNum = ComboBox_GetCount( hSPComboBox ); <br> <br>bFound = FALSE; <br>for (i=0; i&lt;iNum; i++) <br>{ <br>lParam =  ComboBox_GetItemData( hSPComboBox, i ); <br> <br>if ((lParam) &amp;&amp; (CB_ERR != lParam)) <br>{ <br>lpci = (LPCONNECTIONINFO) lParam; <br>if (IsEqualGUID( lpci-&gt;guidSP, lpdpconn-&gt;guidSP )) <br>{ <br>bFound = TRUE; <br>ComboBox_SetCurSel( hSPComboBox, i ); <br>break; <br>} <br>lpci = NULL; <br>} <br> <br>lParam = NULL; <br>} <br> <br>if (FALSE == bFound) <br>{ <br>//No match. <br>ComboBox_AddString( hSPComboBox, "&lt;Unknown Service Provider&gt;"); <br>ComboBox_SetItemData( hSPComboBox, 0, 0); <br>ComboBox_SetCurSel( hSPComboBox, 0 ); <br>} <br> <br>iNum = ComboBox_GetCount( hAppComboBox ); <br> <br>bFound = FALSE; <br>for (i=0; i&lt;iNum; i++) <br>{ <br>lParam = ComboBox_GetItemData( hAppComboBox, i ); <br> <br>if ((lParam) &amp;&amp; (CB_ERR != lParam)) <br>{ <br>lpGuid = (LPGUID) lParam; <br>if (IsEqualGUID( *lpGuid, lpdpconn-&gt;lpSessionDesc-&gt;guidApplication )) <br>{ <br>bFound = TRUE; <br>ComboBox_SetCurSel( hAppComboBox, i ); <br>break; <br>} <br>lpGuid = NULL; <br>} <br> <br>lParam = NULL; <br> <br>} <br> <br>if (FALSE == bFound) <br>{ <br>//No match. <br>ComboBox_AddString( hAppComboBox, "&lt;Unknown Application&gt;"); <br>ComboBox_SetItemData( hAppComboBox, 0, 0); <br>ComboBox_SetCurSel( hAppComboBox, 0 ); <br>} <br> <br>bRet = TRUE; <br> <br>// initialize max players <br>SetDlgItemInt(hWnd, IDC_MAXPLAYERSEDIT, 0, FALSE); <br>SetDlgItemText( hWnd, IDC_PASSWORDEDIT,lpdpconn-&gt;lpSessionDesc-&gt;lpszPasswordA ); <br> <br>FAILURE: <br>return bRet; <br>} <br> <br> <br>/////////////////////////////////////////////////////////////////////////////////////// <br>HRESULT SetGroupConnection(HWND hWnd, LPLOBBYGROUPCONTEXT lpContext) <br>{ <br>CHARszPassword[MAXSTRLEN]; <br>DWORDdwMaxPlayers; <br>LPDPLCONNECTIONlp = NULL; <br>HRESULThr; <br>GUIDguidApplication, <br>guidSP; <br>DWORDdwSize = 0; <br> <br>//Pull the info from the dialog <br>GetDlgItemText(hWnd, IDC_PASSWORDEDIT, szPassword, MAXSTRLEN); <br>dwMaxPlayers = GetDlgItemInt(hWnd, IDC_MAXPLAYERSEDIT, NULL, FALSE); <br>hr = GetComboBoxGuid(hWnd, IDC_APPCOMBO, &amp;guidApplication); <br> <br>if (FAILED( hr)) <br>{ <br>ErrorBox( "Please select a different application.", hr ); <br>return hr; <br>} <br> <br>GetConnectionSPGuid(hWnd, IDC_GROUPCONNECTIONSPCOMBO, &amp;guidSP); <br> <br>if (FAILED( hr)) <br>{ <br>ErrorBox( "Please select a different service provider.", hr ); <br>return hr; <br>} <br> <br> <br>//Get the old connection settings. <br>hr = IDirectPlay3_GetGroupConnectionSettings(lpContext-&gt;lpDPInfo-&gt;lpDirectPlay3A, <br> 0, lpContext-&gt;dpidRoom, NULL, &amp;dwSize ); <br> <br>lp = (LPDPLCONNECTION) GlobalAllocPtr( GHND, dwSize ); <br> <br>if (lp) <br>{ <br>hr = IDirectPlay3_GetGroupConnectionSettings(lpContext-&gt;lpDPInfo-&gt;lpDirectPlay3A, <br> 0, lpContext-&gt;dpidRoom, (LPVOID) lp, &amp;dwSize ); <br> <br>lp-&gt;lpSessionDesc-&gt;dwMaxPlayers = dwMaxPlayers; <br>lp-&gt;lpSessionDesc-&gt;lpszPasswordA = szPassword; <br>lp-&gt;lpSessionDesc-&gt;guidApplication = guidApplication; <br>lp-&gt;guidSP = guidSP; <br> <br>hr = IDirectPlay3_SetGroupConnectionSettings(lpContext-&gt;lpDPInfo-&gt;lpDirectPlay3A, <br> 0, lpContext-&gt;dpidRoom, lp ); <br>} <br>else <br>{ <br>hr = DPERR_OUTOFMEMORY; <br>} <br> <br>return (hr); <br>} <br> <br> <br>/////////////////////////////////////////////////////////////////////////////////////// <br>BOOL CALLBACK ConnectionSettingsDialogProc(HWND hWnd, UINT uMsg, WPARAM wParam, LPARAM lParam) <br>{ <br>LPLOBBYGROUPCONTEXTlpContext = (LPLOBBYGROUPCONTEXT) GetWindowLong(hWnd, DWL_USER); <br>HRESULThr; <br> <br>    switch(uMsg) <br>    { <br>        case WM_INITDIALOG: <br> <br>// context passed in lParam <br>lpContext = (LPLOBBYGROUPCONTEXT) lParam; <br> <br>            // save the globals with the window <br>SetWindowLong(hWnd, DWL_USER, (LONG) lpContext); <br>InitConnectionSettingsDialog( hWnd, lpContext );   <br>            break; <br> <br>        case WM_DESTROY: <br>{ <br>WPARAMindex; <br>LRESULTlpData; <br> <br>// destroy the GUID's stored with each app name <br>index = 0; <br>while (TRUE) <br>{ <br>lpData = SendDlgItemMessage(hWnd, IDC_APPCOMBO, CB_GETITEMDATA, (WPARAM) index, 0); <br>if ((lpData == CB_ERR) || (lpData == 0)) <br>break; <br> <br>GlobalFreePtr((LPVOID) lpData); <br>index += 1; <br>} <br> <br>// destroy the connection info in the combo box. <br>index = 0; <br>while (TRUE) <br>{ <br>lpData = SendDlgItemMessage(hWnd, IDC_GROUPCONNECTIONSPCOMBO, CB_GETITEMDATA, (WPARAM) index, 0); <br>if ((lpData == CB_ERR) || (lpData == 0)) <br>break; <br> <br>GlobalFreePtr((LPVOID) lpData); <br>index += 1; <br>} <br>} <br>            break; <br> <br>        case WM_COMMAND: <br>            switch(LOWORD(wParam)) <br>            { <br>case IDOK: <br>// save changes they made <br>hr = SetGroupConnection( hWnd, lpContext); <br> <br>if (SUCCEEDED(hr)) <br>{ <br>// Return success <br>EndDialog(hWnd, TRUE); <br>} <br>                    break; <br> <br>case IDCANCEL: <br>                    // Return failure <br>                    EndDialog(hWnd, FALSE); <br> <br>                    break; <br> <br>case IDC_STAGINGAREA: <br>{ <br>int i = SendDlgItemMessage( hWnd, IDC_STAGINGAREA, BM_GETCHECK, 0, 0 ); <br>EnableWindow( GetDlgItem( hWnd, IDC_PASSWORDEDIT ), (BST_CHECKED==i)); <br>EnableWindow( GetDlgItem( hWnd, IDC_APPCOMBO ), (BST_CHECKED==i)); <br>EnableWindow( GetDlgItem( hWnd, IDC_MAXPLAYERSEDIT ), (BST_CHECKED==i)); <br>EnableWindow( GetDlgItem( hWnd, IDC_GROUPCONNECTIONSPCOMBO ), (BST_CHECKED==i)); <br>} <br>break; <br> <br>            } <br> <br>            break; <br>    } <br> <br>    // Allow for default processing <br>    return FALSE; <br>} <br> </code></pre>
<p>&nbsp;</p></body>
</HTML>
