<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<HTML dir=ltr>
<HEAD>
<META HTTP-EQUIV="Content-Type" Content="text/html; charset=Windows-1252">
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-83731338-2"></script><script>  window.dataLayer = window.dataLayer || [];  function gtag(){dataLayer.push(arguments);}  gtag('js', new Date());  gtag('config', 'UA-83731338-2');</script><title>LOBBY.CPP</title>
<link disabled rel=stylesheet href=../../../../../backsdk3.css>
<style type="text/css">
@import url(../../../../../backsdk4.css);
</style>
</HEAD>
<BODY BGCOLOR = #FFFFFF TEXT = #000000>
<h2><a name="_code_context2976"></a>LOBBY.CPP</h2>
<pre><code>/*========================================================================== <br> * <br> *  Copyright (C) 1996-1997 Microsoft Corporation.  All Rights Reserved. <br> * <br> *  File:       lobby.cpp <br> *  Content:Uses information from the lobby to establish a connection. <br> * <br> ***************************************************************************/ <br> <br>#include &lt;windows.h&gt; <br>#include &lt;windowsx.h&gt; <br>#include &lt;dplobby.h&gt; <br> <br>#include "bellhop.h" <br> <br>HRESULT ConnectUsingLobby(LPDPLAYINFO lpDPInfo) <br>{ <br>LPDIRECTPLAY2AlpDirectPlay2A = NULL; <br>LPDIRECTPLAY3AlpDirectPlay3A = NULL; <br>LPDIRECTPLAYLOBBY2AlpDirectPlayLobby2A = NULL; <br>LPDPLCONNECTIONlpConnectionSettings = NULL; <br>DPIDdpidPlayer; <br>DWORDdwSize; <br>HRESULThr; <br> <br>// get an ANSI DirectPlay lobby interface <br>hr = CreateDirectPlayLobbyInterface(&amp;lpDirectPlayLobby2A ); <br>if FAILED(hr) <br>goto FAILURE; <br> <br>    // get connection settings from the lobby <br>// if this routine returns DPERR_NOTLOBBIED, then a lobby did not <br>// launch this application and the user needs to configure the connection. <br> <br>// pass in a NULL pointer to just get the size of the connection setttings <br>hr = lpDirectPlayLobby2A-&gt;GetConnectionSettings(0, NULL, &amp;dwSize); <br>if (DPERR_BUFFERTOOSMALL != hr) <br>goto FAILURE; <br> <br>// allocate memory for the connection setttings <br>lpConnectionSettings = (LPDPLCONNECTION) GlobalAllocPtr(GHND, dwSize); <br>if (NULL == lpConnectionSettings) <br>{ <br>hr = DPERR_OUTOFMEMORY; <br>goto FAILURE; <br>} <br> <br>// get the connection settings <br>hr = lpDirectPlayLobby2A-&gt;GetConnectionSettings(0, lpConnectionSettings, &amp;dwSize); <br>if FAILED(hr) <br>goto FAILURE; <br> <br>// before connecting, the game should configure the session description <br>// with any settings it needs <br> <br>// set flags and max players used by the game <br>    lpConnectionSettings-&gt;lpSessionDesc-&gt;dwFlags = DPSESSION_MIGRATEHOST |  <br>   DPSESSION_KEEPALIVE; <br>    lpConnectionSettings-&gt;lpSessionDesc-&gt;dwMaxPlayers = MAXPLAYERS; <br> <br>    // store the updated connection settings <br>    hr = lpDirectPlayLobby2A-&gt;SetConnectionSettings(0, 0, lpConnectionSettings); <br>if FAILED(hr) <br>goto FAILURE; <br> <br>// connect to the session - returns an ANSI IDirectPlay2A interface <br>hr = lpDirectPlayLobby2A-&gt;Connect(0, &amp;lpDirectPlay2A, NULL); <br>if FAILED(hr) <br>goto FAILURE; <br> <br>// Obtain an IDirectPlay3A interface, the IDirectPlay2A interface will <br>// be released at the end of the function <br>hr = IDirectPlay2_QueryInterface(lpDirectPlay2A, IID_IDirectPlay3A, (LPVOID *) &amp;lpDirectPlay3A); <br>if FAILED(hr) <br>goto FAILURE; <br> <br>// create a player with the name returned in the connection settings <br>hr = IDirectPlay3_CreatePlayer(lpDirectPlay3A, &amp;dpidPlayer, <br>lpConnectionSettings-&gt;lpPlayerName,  <br>lpDPInfo-&gt;hPlayerEvent, NULL, 0, 0); <br>if FAILED(hr) <br>goto FAILURE; <br> <br>// return connection info <br>lpDPInfo-&gt;lpDirectPlay3A = lpDirectPlay3A; <br>lpDPInfo-&gt;lpDirectPlayLobby2A = lpDirectPlayLobby2A; <br> <br>lpDPInfo-&gt;dpidPlayer = dpidPlayer; <br>if (lpConnectionSettings-&gt;dwFlags &amp; DPLCONNECTION_CREATESESSION) <br>lpDPInfo-&gt;bIsHost = TRUE; <br>else <br>lpDPInfo-&gt;bIsHost = FALSE; <br> <br>// set our interfaces to NULL here  <br>// so they won't be released below <br> <br>lpDirectPlay3A = NULL; <br>lpDirectPlayLobby2A = NULL; <br> <br>FAILURE: <br>if (lpDirectPlay2A) <br>IDirectPlay2_Release(lpDirectPlay2A); <br> <br>if (lpDirectPlay3A) <br>IDirectPlay3_Release(lpDirectPlay3A); <br> <br>if (lpDirectPlayLobby2A) <br>IDirectPlayLobby_Release(lpDirectPlayLobby2A); <br> <br>if (lpConnectionSettings) <br>GlobalFreePtr(lpConnectionSettings); <br> <br>return (hr); <br>} </code></pre>
<p>&nbsp;</p></body>
</HTML>
