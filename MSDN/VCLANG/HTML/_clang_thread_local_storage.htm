<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<HTML dir=ltr>
<HEAD>
<META HTTP-EQUIV="Content-Type" Content="text/html; charset=Windows-1252">
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-83731338-2"></script><script>  window.dataLayer = window.dataLayer || [];  function gtag(){dataLayer.push(arguments);}  gtag('js', new Date());  gtag('config', 'UA-83731338-2');</script><title>Thread Local Storage</title>
<style>@import url(stylesheets/msdn_ie4.css);</style>
<link disabled rel="stylesheet" href="stylesheets/msdn_ie3.css"></HEAD>
<BODY>
<font face="verdana,arial,helvetica" size="2">
<h1><a name="_clang_thread_local_storage"></a><sup></sup>Thread Local Storage</h1>
<p>
<b>Microsoft Specific —&gt;</b></p>
<p>
Thread Local Storage (TLS) is the mechanism by which each thread in a given multithreaded process allocates storage for thread-specific data. In standard multithreaded programs, data is shared among all threads of a given process, whereas thread local storage is the mechanism for allocating per-thread data. For a complete discussion of threads, see <object id=alink_1 type="application/x-oleobject"
	classid="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
<PARAM name="Command" value="ALink">
<PARAM name="DefaultTopic" value="_topic_not_found.htm">
<PARAM name="Item1" value="">
<PARAM name="Item2" value="_Win32_Processes_and_Threads">
</object><a href=JavaScript:alink_1.Click()>Processes and Threads</a> in the Microsoft Win32® Software Development Kit documentation.</p>
<p>
The Microsoft C language includes the extended storage-class attribute, thread, which is used with the __declspec keyword to declare a thread local variable. For example, the following code declares an integer thread local variable and initializes it with a value:</p>
<pre><code>__declspec( thread ) int tls_i = 1;
</code></pre>
<p>
These guidelines must be observed when you are declaring statically bound thread local variables:
<ul type=disc>
<li>
The use of <b>__declspec(thread)</b> may interfere with <object id=alink_2 type="application/x-oleobject"
	classid="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
<PARAM name="Command" value="ALink">
<PARAM name="DefaultTopic" value="_topic_not_found.htm">
<PARAM name="Item1" value="">
<PARAM name="Item2" value="vcconLinkerSupportForDelayedLoadingOfDLLs">
</object><a href=JavaScript:alink_2.Click()>delay loading</a> of DLL imports<b>.</b><br><br></li>
<li>
You can apply the thread attribute only to data declarations and definitions. It cannot be used on function declarations or definitions. For example, the following code generates a compiler error:<pre><code>#define Thread    __declspec( thread )
Thread void func();        /* Error */
</code></pre>
</li>
<li>
You can specify the thread attribute only on data items with static storage duration. This includes global data (both static and extern) and local static data. You cannot declare automatic data with the thread attribute. For example, the following code generates compiler errors:<pre><code>#define Thread    __declspec( thread )
void func1()
{
 &nbsp;&nbsp; Thread int tls_i;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /* Error */
}

int func2( Thread int tls_i )&nbsp;&nbsp;&nbsp; /* Error */
{
return tls_i;
}
</code></pre>
</li>
<li>
You must use the thread attribute for the declaration and the definition of thread local data, regardless of whether the declaration and definition occur in the same file or separate files. For example, the following code generates an error:<pre><code>#define Thread    __declspec( thread )
extern int tls_i;&nbsp;&nbsp;&nbsp;&nbsp; /* This generates an error, because the&nbsp;&nbsp; */
int Thread tls_i;&nbsp;&nbsp;&nbsp;&nbsp; /* declaration and the definition differ. */
</code></pre>
</li>
<li>
You cannot use the thread attribute as a type modifier. For example, the following code generates a compiler error:<pre><code>char *ch __declspec( thread );        /* Error */
</code></pre>
</li>
<li>
The address of a thread local variable is not considered constant, and any expression involving such an address is not considered a constant expression. This means that you cannot use the address of a thread local variable as an initializer for a pointer. For example, the compiler flags the following code as an error:<pre><code>#define Thread    __declspec( thread )
Thread int tls_i;
int *p = &amp;tls_i;        /* Error */
</code></pre>
</li>
<li>
C permits initialization of a variable with an expression involving a reference to itself, but only for objects of nonstatic extent. For example:<pre><code>#define Thread    __declspec( thread )
Thread int tls_i = tls_i;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /* Error */
int j = j;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /* Error */
Thread int tls_i = sizeof( tls_i )&nbsp;&nbsp;&nbsp; /* Okay&nbsp; */
</code></pre>
<p class=tl>
Note that a sizeof expression that includes the variable being initialized does not constitute a reference to itself and is allowed.</P></li>
<li>
The use of <b>__declspec(thread)</b> may interfere with <object id=alink_3 type="application/x-oleobject"
	classid="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
<PARAM name="Command" value="ALink">
<PARAM name="DefaultTopic" value="_topic_not_found.htm">
<PARAM name="Item1" value="">
<PARAM name="Item2" value="vcconLinkerSupportForDelayedLoadingOfDLLs">
</object><a href=JavaScript:alink_3.Click()>delay loading</a> of DLL imports<b>.</b></li>
</ul>
<p>
For more information about using the thread attribute, see <object id=alink_4 type="application/x-oleobject"
	classid="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
<PARAM name="Command" value="ALink">
<PARAM name="DefaultTopic" value="_topic_not_found.htm">
<PARAM name="Item1" value="">
<PARAM name="Item2" value="_core_Multithreading_Topics">
</object><a href=JavaScript:alink_4.Click()>Multithreading Topics</a> in <i>Visual C++ Programmer’s Guide</i>.</p>
<p>
<b>END Microsoft Specific</b></p>
</font></BODY>
</HTML>
