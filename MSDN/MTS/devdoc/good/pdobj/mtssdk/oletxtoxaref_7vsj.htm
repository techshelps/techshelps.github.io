<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<HTML dir=ltr>
<HEAD>
<META HTTP-EQUIV="Content-Type" Content="text/html; charset=Windows-1252">
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-83731338-2"></script><script>  window.dataLayer = window.dataLayer || [];  function gtag(){dataLayer.push(arguments);}  gtag('js', new Date());  gtag('config', 'UA-83731338-2');</script><title>Transaction States</title>
<link disabled rel=stylesheet href=../../../backsdk3.css>
<style type="text/css">
@import url(../../../backsdk4.css);
</style>
</HEAD>
<BODY BGCOLOR=#FFFFFF TEXT=#000000>

<p>
<a name="astransactionstates"></a>Transaction States</p>
<p>
When the ODBC connection is initially obtained, it is in a local transaction state. An application enlists in a distributed transaction by setting the connection attribute SQL_ENLIST_IN_DTC and passing in a non-null transaction pointer. It remains in that state until the application sets the connection attribute SQL_ENLIST_IN_DTC with a null transaction pointer.</p>
<p>
<img src="images/virm43.gif" border=0></p>
<p>
<b>Transaction State Machine</b></p>
<p>
When the connection transitions from the local transaction state to the distributed transaction state, the ODBC driver should call the <b>RequestNewResourceManager</b> method to obtain a RM cookie for the resource manager. The resource manager in this case is defined by the Data Source Name (DSN).</p>
<p>
<b>Note</b>   Driver implementers shouldn’t use the same RM cookie for two separate ODBC connections if the DSN on both connections is the same.</p>
<p>
Calling <b>RequestNewResourceManager</b> results in a message from the DTC proxy to the XA TM. When the XA TM receives a message that contains the DSN and the name of the client DLL, it first checks to see if it already has an XA connection to the resource manager with the same DSN. If not, then the XA TM does the following:
<ol>
<li>
Loads the client DLL.</li>
<li>
Gets the address of the <b>GetXaSwitch</b> function.</li>
<li>
Calls the <b>GetXaSwitch</b> function to obtain the <b>XA_Switch</b>.</li>
<li>
Calls the <b>xa_open</b> function to open an XA connection with the resource manager.</li>
</ol>
<p>
<b>Note</b>   In step 4, when the RM's <b>xa_open</b> function is called, the DTC TM passes in the DSN as the OPEN_STRING. The implementation of the <b>xa_open</b> function should create the appropriate OPEN_STRING based on the DSN. For example, if it needs any user id or security information, it can get that from the registry or anywhere else where it would have been stored at the time the DSN was created.</p>
<p>
When the <b>RequestNewResourceManager</b> method call returns with a success two things are TRUE:
<ol>
<li>
There is an XA Connection open from the XA TM to the ODBC driver for the resource manager.</li>
<li>
There is an RM cookie to DSN entry available in the mapping table which maps an RM cookie to a DSN.</li>
</ol>
<p>&nbsp; </p></body>
</HTML>
