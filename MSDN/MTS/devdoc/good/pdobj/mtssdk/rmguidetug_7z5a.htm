<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<HTML dir=ltr>
<HEAD>
<META HTTP-EQUIV="Content-Type" Content="text/html; charset=Windows-1252">
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-83731338-2"></script><script>  window.dataLayer = window.dataLayer || [];  function gtag(){dataLayer.push(arguments);}  gtag('js', new Date());  gtag('config', 'UA-83731338-2');</script><title>How SQL Server Explicitly Initiates a Transaction</title>
<link disabled rel=stylesheet href=../../../backsdk3.css>
<style type="text/css">
@import url(../../../backsdk4.css);
</style>
</HEAD>
<BODY BGCOLOR=#FFFFFF TEXT=#000000>

<h1><a name="ashowsqlserverexplicitlyinitiatesatransaction"></a>How SQL Server Explicitly Initiates a Transaction</h1>
<p>
SQL Server’s Transact-SQL programming language has been extended to include the <b>Begin Distributed Transaction</b> statement. A SQL Server explicitly initiated transaction works as follows:
<ol>
<li>
When a stored procedure invokes the Transact-SQL <b>Begin Distributed Transaction </b>statement, SQL Server invokes the MS DTC <b>BeginTransaction</b> method and obtains a transaction object representing the transaction. After obtaining the transaction object, SQL Server enlists in the transaction with its local MS DTC transaction manager. This permits SQL Server to participate in the two-phase commit protocol and to receive transaction commit or abort notifications from MS DTC.</li>
<li>
All database updates, inserts, and deletes performed by the stored procedure are done under the auspices of the MS DTC transaction. If the stored procedure invokes a remote stored procedure in another database, SQL Server propagates the MS DTC transaction with the call to the remote stored procedure. All updates to both databases are protected by the MS DTC transaction.</li>
<li>
When the work of the transaction is complete, the stored procedure that initiated the transaction calls the Transact-SQL COMMIT<b> </b>TRANSACTION statement. In response to the COMMIT<b> </b>TRANSACTION call, SQL Server invokes the MS DTC <b>Commit</b> method. MS DTC uses the two-phase commit protocol to coordinate commitment of the transaction. Alternatively, the stored procedure could call the Transact-SQL ROLLBACK TRANSACTION statement. In this case, SQL Server calls the MS DTC <b>Abort</b> method to undo the effects of the transaction.</li>
<li>
The stored procedure may then go on to perform more transactions.</li>
</ol>
<p>
A resource manager that initiates and participates in MS DTC transactions must reside on a system on which the Complete MS DTC Service has been installed. For information on installation and configuration of MS DTC, refer to "Setting Up an MS DTC System” in the<i> MS DTC Administrator’s Guide and Programmer’s Reference</i>.</p>
<p>
The following example illustrates how a distributed MS DTC transaction can be used within a stored procedure to ensure that two SQL Server databases are updated consistently. The stored procedure explicitly initiates the distributed transaction using the Transact-SQL BEGIN DISTRIBUTED TRANSACTION statement.</p>
<pre><code>/*******************************************************/
/* Using BEGIN DISTRIBUTED TRANSACTION for explicit    */
/* server initiated transactions.                      */
/*******************************************************/
CREATE PROCEDURE change_addr(@au_id varchar(11),
                             @addr varchar(40),
                             @toserver varchar(12) ) AS
declare @execstr varchar(200)
<b><i> </i></b>
-- 1. Start a Transaction
BEGIN DISTRIBUTED TRANSACTION
<b><i> </i></b>
-- 2. Change local author information
update authors set address = @addr where au_id = @au_id
<b><i> </i></b>
-- 3. Make a string with the server name, procedure to
--    execute and parameters
select @execstr = @toserver  '.pubs..update_addr '
<b><i> </i></b>
-- 4. Update remote server
--     ( Note that these servers must be added to each
--      other via sp_addserver and sp_addremotelogin )
exec @execstr @au_id, @addr
<b><i> </i></b>
-- 5. Commit the MS DTC transaction
COMMIT TRANSACTION
<b><i> </i></b>
/*******************************************************/
/* Stored procedure to update an author's address on   */
/* the remote server.</code>                                            <code>*/</code>
<code>/*******************************************************/</code>
<code>CREATE PROCEDURE update_addr(@au_id varchar(11),</code>
                                <code>@addr varchar(40)) AS</code>
    <code>update authors set address = @addr</code>
    <code>where au_id = @au_id</code></pre>
<p>&nbsp; </p></body>
</HTML>
