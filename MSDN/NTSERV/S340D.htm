<HTML><HEAD><script async src="https://www.googletagmanager.com/gtag/js?id=UA-83731338-2"></script><script>  window.dataLayer = window.dataLayer || [];  function gtag(){dataLayer.push(arguments);}  gtag('js', new Date());  gtag('config', 'UA-83731338-2');</script><title>Automatic Recovery from Disk Errors</title>
<style>@import url(msdn_ie4.css);</style>
	<link disabled rel="stylesheet" href="msdn_ie3.css"><META HTTP-EQUIV="CONTENT-TYPE" CONTENT="text/html; charset= iso-8859-1"></HEAD><BODY BGCOLOR="#FFFFFF">
<H3 CLASS="h2">Automatic Recovery from Disk Errors</H3><P CLASS="t">This section discusses how Windows&nbsp;NT automatically recovers from some kinds of disk errors. You do not even know that an error occurred.</P>
<P CLASS="t">Windows&nbsp;NT provides two kinds of disk error recovery:</P>
<UL><LI>Dynamic data recovery by using sector sparing, which is only available on SCSI disks that are configured as part of a fault-tolerant volume. Sector sparing works on fault-tolerant volumes because a copy of the data on the sector with the error can be regenerated.</LI><LI>NTFS cluster remapping. </LI></UL><P CLASS="t">Windows&nbsp;NT Server provides additional recovery mechanisms for fault-tolerant volumes (mirror sets and stripe sets with parity). For more information about fault-tolerant volumes, see Chapter 5, "Preparing for and Performing Recovery."</P>
<P CLASS="t">The following table summarizes what happens if a sector goes bad on a computer running Windows&nbsp;NT Server. There is more information about sector sparing and cluster remapping following the table. For more details, see Chapter 5, "Volume Management and Fault Tolerance" in the book <I>Inside the Windows&nbsp;NT File System</I>.</P>

<TABLE COLS="4" BORDER="0" CELLPADDING="7"><COLGROUP><COL WIDTH="78pt" VALIGN="TOP"><COL WIDTH="90pt" VALIGN="TOP"><COL WIDTH="90pt" VALIGN="TOP"><COL WIDTH="90pt" VALIGN="TOP"></COLGROUP><TBODY><TR><TD VALIGN="TOP"><P CLASS="th"><B><BR><BR><BR>Description</B></P></TD><TD VALIGN="TOP"><P CLASS="th"><B>FtDisk installed with a SCSI disk that has spare sectors</B></P></TD><TD VALIGN="TOP"><P CLASS="th"><B>FtDisk installed with a non-SCSI disk or disk with no spare sectors</B></P></TD><TD VALIGN="TOP"><P CLASS="th"><B><BR>FtDisk not installed with any kind of disk</B></P></TD></TR><TR><TD COLSPAN="4" VALIGN="TOP"><P></P></TD></TR><TR><TD VALIGN="TOP"><P CLASS="tt">Fault-tolerant volume (Windows&nbsp;NT Server only) </P></TD><TD VALIGN="TOP"><P CLASS="tt">1. FtDisk recovers the data.<BR>2. FtDisk replaces the bad sector.<BR>3. File system doesn't know about the error.</P></TD><TD VALIGN="TOP"><P CLASS="tt">1. FtDisk recovers the data.<BR>2. FtDisk sends the data and bad-sector error to the file system.<BR>3. NTFS performs cluster remapping.<BR>4. FAT doesn't do anything about the error.</P></TD><TD VALIGN="TOP"><P CLASS="tt">N/A</P></TD></TR><TR><TD COLSPAN="4" VALIGN="TOP"><P CLASS="tt"></P></TD></TR><TR><TD VALIGN="TOP"><P CLASS="tt">Non-fault-tolerant volume</P></TD><TD VALIGN="TOP"><P CLASS="tt">1. FtDisk can't recover the data.<BR>2. FtDisk sends a bad-sector error to the file system.<BR>3. NTFS performs cluster remapping. On a read operation, data are lost.<BR>4. FAT loses the data on both read and write.</P></TD><TD VALIGN="TOP"><P CLASS="tt">1. FtDisk can't recover the data.<BR>2. FtDisk sends a bad-sector error to the file system.<BR>3. NTFS performs cluster remapping. On a read operation, data are lost.<BR>4. FAT loses the data on both read and write.</P></TD><TD VALIGN="TOP"><P CLASS="tt">1. Disk driver returns a bad-sector error to the file system.<BR>2. NTFS performs cluster remapping. On a read operation, data are lost.<BR>3. FAT loses the data on both read and write.</P></TD></TR></TBODY></TABLE>
<P CLASS="spacing"><BR></P><P CLASS="t"><B>Note</B></P>
<P>FtDisk is the device driver that handles I/O to volume sets, stripe sets, mirror sets, and stripe sets with parity. However, volume sets and stripe sets are not fault tolerant, so processing of an error on one of these volumes falls into the non-fault-tolerant volume category.</P>
<H4 CLASS="h3"><A NAME="sec0"></A>Sector Sparing</H4><P CLASS="t">If a disk read error occurs on a file on a fault-tolerant volume on a hard disk connected to a SCSI controller, Windows NT Server uses a technique called <I>sector sparing</I> to recover the data. Windows NT Server obtains a spare sector from the disk device driver to replace the bad sector. It then recovers the data by reading the sector from the mirror disk or recalculating the data from a stripe set with parity, and writes the data to the new sector.</P>
<P CLASS="t">This processing is transparent to any applications performing disk I/O. Sector sparing eliminates error messages such as the "Abort, Retry, or Fail?" that occur when a file system encounters a bad sector.</P>
<H4 CLASS="h3"><A NAME="sec1"></A>Cluster Remapping</H4><P CLASS="t">With transaction logging and recovery, NTFS guarantees that the volume structure will not be corrupted, so all files remain accessible after a system crash. However, user data can be lost because of a system crash or a bad sector.</P>
<P CLASS="t">The NTFS file system implements a recovery technique called cluster remapping. When Windows NT returns a bad sector error to the NTFS file system, NTFS dynamically replaces the cluster containing the bad sector and allocates a new cluster for the data. If the error occurred during a read on a non-fault-tolerant volume, NTFS returns a read error to the calling program, and the data are lost. When the error occurs during a write, NTFS writes the data to the new cluster, and no data are lost.</P>
<P CLASS="t">NTFS puts the address of the cluster containing the bad sector in its Bad Cluster File so the bad sector will not be reused. </P></BODY></HTML>
