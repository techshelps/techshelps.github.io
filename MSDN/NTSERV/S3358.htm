<HTML><HEAD><script async src="https://www.googletagmanager.com/gtag/js?id=UA-83731338-2"></script><script>  window.dataLayer = window.dataLayer || [];  function gtag(){dataLayer.push(arguments);}  gtag('js', new Date());  gtag('config', 'UA-83731338-2');</script><title>Internet Control Message Protocol</title>
<style>@import url(msdn_ie4.css);</style>
	<link disabled rel="stylesheet" href="msdn_ie3.css"><META HTTP-EQUIV="CONTENT-TYPE" CONTENT="text/html; charset= iso-8859-1"></HEAD><BODY BGCOLOR="#FFFFFF">
<H3 CLASS="h2">Internet Control Message Protocol </H3><P CLASS="t">Internet Control Message Protocol (ICMP) is a maintenance protocol specified in RFC 792 and is normally considered to be part of the IP layer. ICMP messages are encapsulated within IP datagrams, so they can be routed throughout an internetwork. ICMP is used by Windows NT to:</P>
<UL><LI>Build and maintain route tables.</LI><LI>Assist in Path Maximum Transfer Unit (PMTU) discovery.</LI><LI>Diagnose problems (using the utilities <B>ping</B> and <B>tracert</B>).</LI><LI>Adjust flow control to prevent link or router saturation.</LI></UL><H4 CLASS="h3"><A NAME="sec0"></A>Maintaining Route Tables</H4><P CLASS="t">When a Windows NT computer is initialized, the route table normally contains only a few entries. One of those specifies a <I>default gateway</I>. Datagrams that have a destination IP address with no match in the route table are sent to the default gateway. </P>
<P CLASS="t">However, because routers share information about network topology with each other, the default gateway may know of a better route to a given address. When this is the case, upon receiving a datagram that could be taking the better path, the router forwards the datagram normally, then advises the sender of the better route using an <I>ICMP redirect</I> message. </P>
<P CLASS="t">These messages can specify redirection for one host, a subnet, or for an entire network. When a Windows NT computer receives an ICMP redirect, a check is performed to be sure that it came from the first-hop gateway in the current route, and that the gateway is on a directly connected network. If so, the route table is adjusted accordingly.</P>
<P CLASS="t">If the ICMP redirect did not come from the first-hop gateway in the current route, or if that gateway is not on a directly connected network, then the ICMP redirect is ignored.</P>
<H4 CLASS="h3"><A NAME="sec1"></A>Path Maximum Transfer Unit Discovery</H4><P CLASS="t">TCP uses Path Maximum Transfer Unit (PMTU) discovery. The mechanism relies on ICMP destination unreachable<I> </I>messages.</P>
<H4 CLASS="h3"><A NAME="sec2"></A>Using ICMP to Diagnose Problems</H4><P CLASS="t">The <B>ping</B> utility is used to send ICMP echo requests to an IP address, and wait for ICMP echo responses. <B>Ping</B> reports on the number of responses received and the time interval between sending the request and receiving the response. There are many different options that can be used with the <B>ping</B> utility. </P>
<P CLASS="t"><B>Tracert</B> is a route-tracing utility that can be very useful. <B>Tracert</B> works by sending ICMP echo requests to an IP address, while incrementing the time-to-live (TTL) field in the IP header by one starting at 1, and analyzing the ICMP errors that get returned. Each succeeding echo request should get one hop further into the network before the TTL field reaches 0 and an ICMP Time Exceeded error is returned by the router attempting to forward it. <B>Tracert</B> simply prints out an ordered list of the routers in the path that returned these error messages. If the <I>-d</I> switch is used (meaning do not do a DNS lookup on each IP address), then the IP address of the near-side interface of the routers is reported. </P>
<H4 CLASS="h3"><A NAME="sec3"></A>Adjusting Flow Control by Using ICMP</H4><P CLASS="t">If a host is sending datagrams to another computer at a rate that is saturating the routers or links between them, it may receive an <I>ICMP Source Quench</I> message asking it to slow down. The TCP/IP stack in Windows NT honors a source quench message as long as it contains the header fragment of one of its own datagrams from an active TCP connection. If a Windows NT computer is being used as a router, and it is unable to forward datagrams at the rate they are arriving, it drops any datagrams that cannot be buffered but does not send ICMP source quench messages to the senders.</P></BODY></HTML>
