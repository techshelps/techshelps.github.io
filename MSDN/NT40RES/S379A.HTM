<HTML><HEAD><script async src="https://www.googletagmanager.com/gtag/js?id=UA-83731338-2"></script><script>  window.dataLayer = window.dataLayer || [];  function gtag(){dataLayer.push(arguments);}  gtag('js', new Date());  gtag('config', 'UA-83731338-2');</script><title>Hives and Files</TITLE><META HTTP-EQUIV="CONTENT-TYPE" CONTENT="text/html; charset= iso-8859-1"><style>@import url(msdn_ie4.css);</style>
<link disabled rel="stylesheet" href="msdn_ie3.css"></HEAD>
<BODY BGCOLOR="#FFFFFF"><FONT FACE="Verdana, Arial, Helvetica" SIZE="2"><FORM NAME="x"><OBJECT CLASSID="clsid:9c2ac687-ceef-11cf-96d9-00a0c903b016" NAME="iv"></OBJECT></FORM>
<H3>Hives and Files</H3><P CLASS="t">The Registry is divided into parts called <I>hives</I>. A hive is a discrete body of keys, subkeys, and values rooted at the top of the Registry hierarchy. Hives are distinguished from other groups of keys in that they are permanent components of the Registry; they are not created dynamically when the system starts and deleted when it stops. Thus, HKEY_LOCAL_MACHINE\Hardware, which is built dynamically by the Hardware Recognizer when Windows&nbsp;NT starts, is not a hive.</P>
<P CLASS="t">Data in the hives is supported by files in the <I>Systemroot</I>\System32\Config and <I>Systemroot</I>\Profiles\<I>Username</I> subdirectories. Figure 23.7 shows the relationship between the hives and their supporting files.</P>
<P><img src="xwr_v09.gif"></P>
<P>Figure 23.7    Hives and files in the Windows NT Registry </P>
<P CLASS="t">Each hive in the Windows&nbsp;NT Registry is associated with a set of standard files. Table 23.3 lists the standard hives for a computer running Windows&nbsp;NT.</P>
<P>Table 23.3    Standard Hive Files</P>

<TABLE COLS="2" BORDER="0" CELLPADDING="7"><COLGROUP><COL WIDTH="168pt" VALIGN="TOP"><COL WIDTH="180pt" VALIGN="TOP"></COLGROUP><TBODY><TR><TD COLSPAN="2" VALIGN="TOP"><P></P></TD></TR><TR><TD VALIGN="TOP"><P CLASS="th"><B>Registry hive</B></P></TD><TD VALIGN="TOP"><P CLASS="th"><B>Filenames</B></P></TD></TR><TR><TD COLSPAN="2" VALIGN="TOP"><P></P></TD></TR><TR><TD VALIGN="TOP"><P>HKEY_LOCAL_MACHINE\SAM</P></TD><TD VALIGN="TOP"><P>Sam, Sam.log, Sam.sav</P></TD></TR><TR><TD VALIGN="TOP"><P>HKEY_LOCAL_MACHINE\Security</P></TD><TD VALIGN="TOP"><P>Security, Security.log, Security.sav</P></TD></TR><TR><TD VALIGN="TOP"><P>HKEY_LOCAL_MACHINE\Software</P></TD><TD VALIGN="TOP"><P>Software, Software.log, Software.sav</P></TD></TR><TR><TD VALIGN="TOP"><P>HKEY_LOCAL_MACHINE\System</P></TD><TD VALIGN="TOP"><P>System, System.alt, System.log, System.sav</P></TD></TR><TR><TD VALIGN="TOP"><P>HKEY_CURRENT_CONFIG </P></TD><TD VALIGN="TOP"><P>System, System.alt, System.log, System.sav</P></TD></TR><TR><TD VALIGN="TOP"><P>HKEY_USERS\.DEFAULT</P></TD><TD VALIGN="TOP"><P>Default, Default.log, Default.sav</P></TD></TR><TR><TD VALIGN="TOP"><P>(Not associated with a hive)</P></TD><TD VALIGN="TOP"><P>Userdiff, Userdiff.log</P></TD></TR><TR><TD VALIGN="TOP"><P>HKEY_CURRENT_USER</P></TD><TD VALIGN="TOP"><P>Ntuser.dat, Ntuser.dat.log</P></TD></TR></TBODY></TABLE>
<P CLASS="spacing"><BR></P><P></P>
<P CLASS="t">By default, the supporting files for all hives except HKEY_CURRENT_USER are in <I>Systemroot</I>\System32\Config. </P>
<P CLASS="t">The HKEY_CURRENT_USER support files are stored in all subdirectories of <I>Systemroot</I>\Profiles, except for the All Users subdirectory. The Ntuser.dat files store user profiles; the Ntuser.dat.log files track changes to Ntuser.dat.</P>
<P CLASS="t">The Ntuser and Userdiff files are new to Windows&nbsp;NT&nbsp;4.0:</P>
<UL><LI>The Ntuser.dat file, which stores the user profile, replaces the <I>usernamexxx</I> and <I>adminxxx</I> files in previous versions of Windows&nbsp;NT. </LI><LI>The Ntuser.dat file in <I>Systemroot</I>\Profiles\DefaultUser replaces the Userdef file in previous versions of Windows&nbsp;NT. This profile is used to create the HKEY_CURRENT_USER hive when a new user logs on to Windows&nbsp;NT for the first time.</LI><LI>The Userdiff files, which are only in <I>Systemroot</I>\System32\Config, are not associated with any hive. They are used to upgrade existing user profiles from previous versions of Windows&nbsp;NT to Windows&nbsp;NT&nbsp;4.0. The user profiles are upgraded the first time the user logs on to Windows&nbsp;NT&nbsp;4.0.</LI></UL><P></P>
<P CLASS="t">Four types of files are associated with hives. Table 23.4 describes each file type by its filename extension.</P>
<P>Table 23.4    File Types and Filename Extensions</P>
<P></P>

<TABLE COLS="2" BORDER="0" CELLPADDING="7"><COLGROUP><COL WIDTH="40pt" VALIGN="TOP"><COL WIDTH="308pt" VALIGN="TOP"></COLGROUP><TBODY><TR><TD VALIGN="TOP"><P CLASS="th"><B>File type</B></P></TD><TD VALIGN="TOP"><P CLASS="th"><B>Description</B></P></TD></TR><TR><TD COLSPAN="2" VALIGN="TOP"><P></P></TD></TR><TR><TD VALIGN="TOP"><P>No filename extension</P></TD><TD VALIGN="TOP"><P>Contains a copy of the hive.</P></TD></TR><TR><TD VALIGN="TOP"><P>.alt</P></TD><TD VALIGN="TOP"><P>Contains a backup copy of the critical HKEY_LOCAL_MACHINE\System hive. Only the System key has an .alt file.</P></TD></TR><TR><TD VALIGN="TOP"><P>.log</P></TD><TD VALIGN="TOP"><P>Contains a transaction log of changes to the keys and value entries in the hive.</P></TD></TR><TR><TD VALIGN="TOP"><P>.sav</P></TD><TD VALIGN="TOP"><P>Contains copies of the hive files as they looked at the end of the text mode stage in Setup. There are .sav files for Software, SAM, Security, System, and .Default.</P>
<P>A new feature of Windows&nbsp;NT&nbsp;4.0 backs up the contents of the hives during setup. Setup has two stages: text mode and graphics mode. The hive is copied to a .sav file after the text-mode stage of setup to protect it from errors that might occur if the graphics-mode stage of setup fails. If setup fails during the graphics-mode stage, only the graphics-mode stage is repeated when the computer is restarted; the .sav file is used to rebuild the hives.</P></TD></TR></TBODY></TABLE>
<P CLASS="spacing"><BR></P><P></P>
<P CLASS="t">The next section discusses features that, along with the supporting files, help to preserve the integrity of the Windows&nbsp;NT Registry.</P>
<H4><A NAME="sec0"></A>Atomicity and Hive Recovery in the Registry</H4><P CLASS="t">The Registry ensures <I>atomicity</I> of individual actions. This means that any change made to a value (to set, delete, or save) either works or does not work: The result will not be a corrupted combination of the old and new configuration even if the system stops unexpectedly because of power failure, hardware failure, or software problems. For example, if an application sets a value for an entry and the system shuts down while this change is being made, when the system restarts, the entry will have either the old value or the new value, but not a meaningless combination of both values. In addition, the size and time data for the key containing the affected entry will be accurate whether the value was changed or not changed.</P>
<H5 CLASS="h4"><A NAME="sec1"></A>Flushing Data</H5><P CLASS="t">In Windows&nbsp;NT, data is written to the Registry only when a <I>flush</I> occurs, which happens after changed data ages past a few seconds, or when an application intentionally flushes the data to the hard disk.</P>
<P CLASS="t">The system performs the following flush process for all hives (except for the System hive):</P>
<P>    1.    All changed data is written to the hive's .log file along with a map of where it is in the hive, and then a flush is performed on the .log file. All changed data has now been written in the .log file.</P>
<P>    2.    The first sector of the hive file is marked to indicate that the file is in transition.</P>
<P>    3.    The changed data is written to the hive file.</P>
<P>    4.    The hive file is marked as completed.</P>
<P></P>
<P></P>
<P CLASS="t"><B>Note</B></P>
<P>If the system shuts down between steps 2 and 4, when the hive is next loaded at startup (unless it's a profile hive that is loaded at logon), the system sees the mark left in step 2, and proceeds to recover the hive using the changes contained in the .log file. That is, the .log files are not used if the hive is not in transition. If the hive is in transition, it cannot be loaded without the .log file.</P>
<P></P>
<P CLASS="t">A different flush process is used for the System hive because it is an important element during system startup and is used too early during startup to be recovered as described in the previous flush process.</P>
<P CLASS="t">The System.alt file contains a copy of the data contained in the System file. During the flush process, changes are marked, written, and then marked as done. Then the same flush process is followed for the System.alt file. If there is a power failure, hardware failure, or software problems at any point during the process, either the System or System.alt file contains the correct information.</P>
<P></P>
<P CLASS="t">The System.alt file is similar to a .log file except that at load time, rather than having to reapply the logged changes, the system just switches to System.alt. The System.alt file is not needed unless the System hive is in transition.</P>
<H5 CLASS="h4"><A NAME="sec2"></A>User Profile Hives</H5><P CLASS="t">Each time a new user logs on to a computer, a new hive is created for that user with a separate file for the user profile. The system administrator can copy a user profile file to a different directory and view, repair, or copy entries to another computer by using Registry Editor. For specific information on this feature, see "Managing User Profiles Through the Registry" in Chapter 25, "Configuration Management and the Registry." For information about the hive for the default profile, see "HKEY_USERS" later in this chapter.</P>
<H4><A NAME="sec3"></A>Registry Size Limit </H4><P CLASS="t">Registry data is stored in the paged pool, an area of physical memory used for system data that can be written to disk when not in use. The <B>RegistrySizeLimit</B> value establishes the maximum amount of paged pool space (and disk paging file space) that can be consumed by Registry data from all applications. It is designed to prevent the Registry from consuming space needed by processes.</P>
<P CLASS="t">The <B>RegistrySizeLimit</B> value establishes a maximum size for the Registry. It does not allocate space in the paged pool, nor does it assure that the space will be available if needed. </P>
<P CLASS="t">By default, <B>RegistrySizeLimit</B> is set to 25 percent of the size of the paged pool. When the paged pool size changes, either because it is adjusted by Windows&nbsp;NT or because an administrator changes it, the value of <B>RegistrySizeLimit</B> changes, too. (Typically, the paged pool is set at 32 MB, so the <B>RegistrySizeLimit</B> value is 8 MB.) </P>
<P CLASS="t">The system ensures that the minimum value for <B>RegistrySizeLimit</B> is 4&nbsp;MB, and the maximum is approximately 80 percent of the <B>PagedPoolSize</B> value. Thus, the paged pool is limited to a maximum size of 128&nbsp;MB, and the <B>RegistrySizeLimit</B> value cannot exceed 102&nbsp;MB (80 percent of 128 MB).</P>
<P CLASS="t">To view or change the value of <B>RegistrySizeLimit</B>, edit the entry under the following subkey:</P>
<P CLASS="t">HKEY_LOCAL_MACHINE\System\CurrentControlSet\Control</P>
<P CLASS="t"><B>RegistrySizeLimit</B> must have a type of REG_DWORD and a data length of 4&nbsp;bytes, or it will be ignored. The <B>RegistrySizeLimit</B> value is approximate.</P>
<P CLASS="t">To view or change the size of the paged pool, use the <B>PagedPoolSize</B> value entry under the following subkey:</P>
<P CLASS="t">HKEY_LOCAL_MACHINE\System\CurrentControlSet\Control\Session Manager\Memory Management</P>
<P></P>
<P CLASS="t">The space controlled by <B>RegistrySizeLimit</B> includes the hive space, as well as some of the Registry's run-time structures. Other Registry run-time structures are protected by their own size limits or by other means. </P>
<P CLASS="t">To ensure that a user can always start the system and edit the Registry, the Registry is not subject to the value set in <B>RegistrySizeLimit</B> until after the first successful loading of a hive (that is, the loading of a user profile). For more details about <B>RegistrySizeLimit</B>, see Regentry.hlp, the Registry Help file on the <I>Windows&nbsp;NT Workstation Resource Kit</I> CD.</P></BODY></HTML>
