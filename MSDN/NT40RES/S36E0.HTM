<HTML><HEAD><script async src="https://www.googletagmanager.com/gtag/js?id=UA-83731338-2"></script><script>  window.dataLayer = window.dataLayer || [];  function gtag(){dataLayer.push(arguments);}  gtag('js', new Date());  gtag('config', 'UA-83731338-2');</script><title>Optimizing 16-bit Windows Applications</TITLE><META HTTP-EQUIV="CONTENT-TYPE" CONTENT="text/html; charset= iso-8859-1"><style>@import url(msdn_ie4.css);</style>
<link disabled rel="stylesheet" href="msdn_ie3.css"></HEAD>
<BODY BGCOLOR="#FFFFFF"><FONT FACE="Verdana, Arial, Helvetica" SIZE="2"><FORM NAME="x"><OBJECT CLASSID="clsid:9c2ac687-ceef-11cf-96d9-00a0c903b016" NAME="iv"></OBJECT></FORM>
<H3>Optimizing 16-bit Windows Applications</H3><P CLASS="t">In Windows&nbsp;NT&nbsp;4.0 Workstation and Server, by default, all active 16-bit Windows applications run as separate threads in a single multithreaded process called <I>NT Virtual DOS Machine</I> (NTVDM). The NTVDM process simulates a 16-bit Windows environment complete with all of the DLLs called by 16-bit Windows applications.</P>
<P CLASS="t">This configuration poses two challenges for running 16-bit applications:</P>
<UL><LI>It prevents 16-bit applications from running simultaneously, which might impede their performance.</LI></UL><UL><LI>It makes monitoring a bit trickier.</LI></UL><P></P>
<P CLASS="t">As a result, Windows&nbsp;NT&nbsp;4.0 includes an option to run a 16-bit application in its own separate NTVDM process with its own address space.</P>
<P CLASS="t">You can monitor 16-bit Windows applications by identifying them by their Thread&nbsp;ID while they are running, or by running each application in a separate address space.</P>
<P CLASS="t">In addition to the 16-bit applications, each NTVDM process includes a <I>heartbeat thread</I> that interrupts every 55 milliseconds to simulate a processor timer-tic, and the Wowexec.exe thread, which helps to create 16-bit tasks and to handle the delivery of the 16-bit interrupt. You will see the heartbeat and Wowexec threads when monitoring 16-bit applications.</P>
<H4><A NAME="sec0"></A>Win16 Application Performance</H4><P CLASS="t">The NTVDM process is <I>multitasking</I>: A thread in the process (in this case, a 16-bit Windows application) can run at the same time as threads of other processes if the computer has more than one processor. It is also <I>preemptible</I>: Threads can be interrupted and resumed to allow virtual multitasking on a single-processor computer.</P>
<P CLASS="t">However, only one 16-bit Windows application thread in an NTVDM can run at one time and, if an application thread is preempted, the NTVDM always resumes with the same thread. This limits the performance of multiple 16-bit applications running in the same NTVDM process, although this limitationMESMES becomes an issue only when the processor is very busy.</P>
<H4><A NAME="sec1"></A>Monitoring Win16 Applications</H4><P CLASS="t">Almost all performance monitoring tools can monitor 16-bit applications on Windows&nbsp;NT&nbsp;4.0 Server and Workstation. However, because they run in the same process, the trick to monitoring more than one 16-bit application is to distinguish among the threads of the NTVDM process.</P>
<P CLASS="t">To monitor one 16-bit application, simply select the NTVDM process in Performance Monitor, Task Manager, Process Explode, Process Viewer, Process Monitor, or another tool. If you have multiple 16-bit processes running in NTVDM, you can distinguish them by their thread IDs in all tools except Process Monitor. You might have to start and stop the 16-bit process to determine which thread ID is associated with which 16-bit process.MESMES</P>
<P><img src="xwr_h04.gif"></P>
<P CLASS="t">This figure is a Performance Monitor report on an a single NTVDM process (Process ID 105) with three threads. One of the threads is the heartbeat thread (Thread #0, Thread ID 118), one is the Wowexec thread (Thread #1, Thread ID 140), one is a 16-bit application, Write.exe (Thread #2, Thread ID 46).</P>
<P CLASS="t">Performance Monitor identifies threads by the process name and a thread number. The thread numbers are ordinal numbers (beginning with 0) that represent the order in which the threads started. The thread number of a running thread changes when a thread with a lower number stops; all threads with higher number move up in order to close the gap. For example, if thread 1 stopped, thread 2 becomes thread 1. Therefore, thread numbers are not reliable indicators of thread identity.</P>
<P CLASS="t">Performance Monitor can monitor the Process ID and Thread ID of a thread. The Process ID is the ID of the process in which the thread runs. Thread ID is the ID of the thread. Unlike thread number, it is assigned when the thread starts and remains with it until the thread stops.</P>
<P CLASS="t">The Process and Thread IDs are just ordinal numbers that are associated with the process or thread only for a single run. On subsequent runs, they just as likely to be assigned a different ID. However, you can use the ID to track them during execution.</P>
<P><img src="xwr_h05.gif"></P>
<P CLASS="t">This figure shows Process Explode monitoring a 16-bit Windows application running in a single process (Ntvdm.exe). The three threads displayed in the Thread ID box (midway down the first column) represent the heartbeat thread, the Wowexec thread, and the thread of the 16-bit Windows application.</P>
<P CLASS="t">To see information about the thread in Process Explode, click on the Thread ID of the thread in the Thread ID box.</P>
<P><img src="xwr_h06.gif"></P>
<P CLASS="t">Task Manager makes it easy to identify 16-bit applications, because it displays the names of the executable files indented below the NTVDM process name. To monitor 16-bit processes in Task Manager, click the Processes tab, and from the <B>Options</B> menu click <B>Show 16-bit Tasks</B>.</P>
<P CLASS="t">In this example, you can see the Wowexec and Write threads. The heartbeat thread is not an executable and does not appear in Task Manager. However, the Thread Count column on the far right shows that all three threads are running in the NTVDM process.</P>
<H4><A NAME="sec2"></A>Running Win16 Applications in a Separate Process</H4><P CLASS="t">Windows&nbsp;NT&nbsp;4.0 lets you opt to run a 16-bit Windows application in separate, unshared NTVDM process with its own memory space. This eliminates competition between NTVDM threads in a single process, making the 16-bit application thread fully multitasking and preemptible. It also simplifies monitoring.</P>
<H5 CLASS="h4"><A NAME="sec3"></A>To run a 16-bit application in its own address space, you can do any of the following:</H5><OL><LI>Click <B>Start</B>, then click <B>Run</B>.MESMES  When you enter the name of the 16-bit process, the <B>Run in a Separate Memory Space</B> option is enabled. Click the option and click <B>OK</B>.</LI></OL><P><img src="xwr_h07.gif"></P>
<OL><LI>From the command line, type
<P CLASS="spacing"><BR></P>
<PRE>start /separate <I>processname</I>
</PRE></LI></OL><P>You can also type:</P>
<P CLASS="spacing"><BR></P>
<PRE>start /shared <I>processname</I></PRE>
<P></P>
<P>to run in the shared NTVDM process.</P>
<OL><LI>Create a shortcut to the process:  Click the right mouse button on the shortcut, then click Properties. Click the Shortcut tab, then click the <B>Run in Separate Memory Space</B> option.</LI></OL><P></P>
<P><img src="xwr_h08.gif"></P>
<P><B>Tip   </B>Create two shortcuts to each of your 16-bit processes: One to run it in a separate memory space and one to run it in the shared memory space.</P>
<P></P>
<P CLASS="t">In Task Manager and Performance Monitor, two instances of the NTVDM process appear in the Process object Instances box. You can use their process IDs to distinguish between them.</P>
<P><img src="xwr_h09.gif"></P>
<P CLASS="t">This example shows Task Manager monitoring two copies of 16-bit Write, each in its own NTVDM process.</P>
<P CLASS="t">When a 16-bit process runs in its own memory space, Performance Monitor shows two instances of the NTVDM process. You need to use process IDs to distinguish between them. (You might have to stop and start the processes to make the distinction.)</P>
<P><img src="xwr_h10.gif"></P></BODY></HTML>
