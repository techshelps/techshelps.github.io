<HTML><HEAD><script async src="https://www.googletagmanager.com/gtag/js?id=UA-83731338-2"></script><script>  window.dataLayer = window.dataLayer || [];  function gtag(){dataLayer.push(arguments);}  gtag('js', new Date());  gtag('config', 'UA-83731338-2');</script><title>Creating a Custom Startup Verification Program</TITLE><META HTTP-EQUIV="CONTENT-TYPE" CONTENT="text/html; charset= iso-8859-1"><style>@import url(msdn_ie4.css);</style>
<link disabled rel="stylesheet" href="msdn_ie3.css"></HEAD>
<BODY BGCOLOR="#FFFFFF"><FONT FACE="Verdana, Arial, Helvetica" SIZE="2"><FORM NAME="x"><OBJECT CLASSID="clsid:9c2ac687-ceef-11cf-96d9-00a0c903b016" NAME="iv"></OBJECT></FORM>
<H3>Creating a Custom Startup Verification Program</H3><P CLASS="t">System startup is usually declared "good" if the following two procedures are complete:</P>
<UL><LI>All startup drivers are loaded.</LI></UL><P>When a service fails to load during startup, its <B>ErrorControl</B> value is checked, as defined in the CurrentControlSet\Services\<I>Servicename</I> subkeys. Whether the system startup process continues or halts depends on this value.</P>
<UL><LI>At least one user successfully logs on to the computer by pressing <B>CTRL+ALT+DELETE</B> and supplying a valid user name, domain, and password. </LI></UL><P></P>
<P CLASS="t">This basic standard for verifying system startup suits the needs of most situations; however, your site might require additional steps before considering a computer to be successfully started and ready to participate in the network.</P>
<P CLASS="t">For example, you can redefine startup validation for a server no one normally logs on to, or for which you want system startup to be validated as successful only after a particular process has started. </P>
<P></P>
<P CLASS="t">Or, for a server running Microsoft SQL Server, you might want a system startup to&nbsp;be marked as good only after the server responds to a request. To do this, you can write a program that queries the SQL database and checks the response. If&nbsp;the response is not as expected, the program can call the <B>NotifyBootConfigStatus()</B> function with a value of FALSE, prompting the system to restart by using the LastKnownGood control set. Or, the program can direct the system to run without saving the current configuration as the LastKnownGood control set. Conversely, if SQL Server responds as expected, the program can call the <B>NotifyBootConfigStatus()</B> function with a value of TRUE, which prompts the system to save the current configuration as the LastKnownGood control.</P>
<P CLASS="t">You can run such a verification program from the command prompt. Or you can have the program run automatically during startup by specifying value entries under the BootVerificationProgram subkey in the Registry.</P>
<H4><A NAME="sec0"></A>To create a custom startup verification program</H4><P>    1.    Change the value of <B>ReportBootOK </B>to 0 under the following Registry path:</P>
<P>HKEY_LOCAL_MACHINE\Software<BR>    \Microsoft<BR>        \Windows&nbsp;NT<BR>            \CurrentVersion<BR>                \WinLogon</P>
<P></P>
<P>The data type for <B>ReportBootOK </B>is REG_SZ. When the value of <B>ReportBootOK </B>is set to 0, it disables the automatic acceptance of startup after the first successful logon.</P>
<P>    2.    Create the executable program that you want to run as part of startup verification. Then specify its filename as a value for <B>ImagePath </B>in the BootVerificationProgram subkey under this Registry path:</P>
<P>HKEY_LOCAL_MACHINE\System<BR>    \CurrentControlSet<BR>        \Control<BR>            \BootVerificationProgram</P>
<P></P>
<P>The data type for <B>ImagePath </B>must be REG_SZ or REG_EXPAND_SZ.</P>
<P></P>
<P CLASS="t">As another example, a computer setup for a turnkey application is a candidate for a custom startup verification routine: The computer does not usually interact directly with users and you therefore do not want a successful user logon to be part of the system startup. </P>
<P></P>
<P CLASS="t">If you want a good system startup to be accepted from a remote computer (either manually or automatically), you can use the <B>Bootvrfy.exe</B> program that is supplied with Windows&nbsp;NT. In this case, the remote computer accepts the system startup by starting the Bootvrfy service. You can also write your own verification service, which can reject the system startup and revert to the LastKnownGood control set to restart the computer.</P>
<H4><A NAME="sec1"></A>To verify system startup from a remote computer</H4><P>    1.    For the local computer, add a BootVerification subkey under the following Registry path:</P>
<P>HKEY_LOCAL_MACHINE\System<BR>    \CurrentControlSet<BR>        \Services</P>
<P></P>
<P>    2.    Add the following value entries under this new BootVerification key:</P>
<P CLASS="spacing"><BR></P>
<PRE>Start : REG_DWORD : 0x00000003
Type : REG_DWORD : 0x00000020
ErrorControl : REG_DWORD : 0x00000001
ImagePath : REG_EXPAND_SZ : bootvrfy.exe
ObjectName : REG_SZ : LocalSystem</PRE>
<P></P>
<P>For more information about these entries, see Regentry.hlp, the Registry Help file on the <I>Windows&nbsp;NT Workstation Resource Kit</I> CD.</P>
<P>    3.    Change the value of <B>ReportBootOK </B>to 0 under the following Registry path:</P>
<P>HKEY_LOCAL_MACHINE\Software<BR>    \Microsoft<BR>        \Windows&nbsp;NT<BR>            \CurrentVersion<BR>                \WinLogon</P>
<P></P>
<P>    4.    Start the Bootvrfy service from a remote computer.</P>
<P>This service tells the service controller on the local computer to save the current startup configuration as the LastKnownGood configuration, and then the service terminates itself.</P>
<P></P>
<P></P>
<P CLASS="t"><B>Important</B></P>
<P>You cannot use the Bootvrfy service in conjunction with settings in the BootVerificationProgram subkey. These are mutually exclusive methods.</P>
<P></P>
<P CLASS="t">You might also want a good system startup to depend on whether a specific service or driver loads. For example, for a server you can program the Boot Loader to choose the LastKnownGood control set if the Server service doesn't start on the computer. </P>
<P></P>
<H4><A NAME="sec2"></A>To change system startup to depend on a service or driver </H4><P>    1.    Select the subkey for the service under the following Registry path:</P>
<P>HKEY_LOCAL_MACHINE\System<BR>    \CurrentControlSet<BR>        \Services<BR>            \<I>Servicename</I></P>
<P></P>
<P><I>Servicename</I> can be any service you want successful system startup to depend on.</P>
<P>    2.    Double-click the service's <B>ErrorControl </B>entry, then change its value to 0x2 (which specifies to switch to LastKnownGood if the service does not start).</P>
<P>On rare occasions, you might want to change the <B>ErrorControl</B> value to 0x3 (which specifies to stop the attempted startup if the service does not start); however, this <B>ErrorControl </B>value is usually reserved for critical services such as file system drivers.</P>
<P>    3.    To put the new values into effect, close Registry Editor, shut down the system, and restart the computer.</P>
<P>    4.    If you do not get the intended effect, restart the computer and manually select the LastKnownGood control set as described in "Starting a System with Configuration Problems," earlier in this chapter. (All changes in the last session will be discarded.)</P>
<P></P></BODY></HTML>
