<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<HTML dir=ltr>
<HEAD>
<META HTTP-EQUIV="Content-Type" Content="text/html; charset=Windows-1252">
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-83731338-2"></script><script>  window.dataLayer = window.dataLayer || [];  function gtag(){dataLayer.push(arguments);}  gtag('js', new Date());  gtag('config', 'UA-83731338-2');</script><title>Building and Registering a Proxy DLL</title>
<link disabled rel=stylesheet href=../../backsdk3.css>
<style type="text/css">
@import url(../../backsdk4.css);
</style>
</HEAD>
<BODY BGCOLOR = #FFFFFF TEXT = #000000>

<h1><a name="_com_building_and_registering_a_proxy_dll"></a>Building and Registering a Proxy DLL</h1>
<p>
If you chose proxy/stub marshaling for your application, the .c and .h files that MIDL generated must be compiled and linked to create a proxy DLL, and that DLL must be entered into the system registry so that clients can locate your interfaces. The MIDL-generated file Dlldata.c contains the necessary routines and other information to build and register a proxy/stub DLL. </p>
<p>
The first step in building the DLL is to write a module definition file for the linker, as shown in this example: </p>
<pre><code>LIBRARY        example.dll
DESCRIPTION    'generic proxy/stub DLL'
EXPORTS        DllGetClassObject      @1 PRIVATE
               DllCanUnloadNow        @2 PRIVATE
               DllRegisterServer      @4 PRIVATE
               DllUnregisterServer    @5 PRIVATE
 </code></pre>
<p>
Alternatively, you can specify these exported functions on the LINK command line of your makefile.</p>
<p>
The exported functions are declared in Rpcproxy.h, which Dlldata.c includes, and default implementations are part of the RPC run-time library. COM uses these functions to create a class factory, unload DLLs (after making sure that no objects or locks exist), retrieve information about the proxy DLL, and to self-register and unregister the proxy DLL. To take advantage of these predefined functions, you need to invoke the Cpreprocessor /D (or -D) option when you compile the Dlldata.c and Example_p.c files, as shown in the following makefile:</p>
<pre><code>example.h example.tlb example_p.c example_i.c dlldata.c : example.idl
    midl example.idl
dlldata.obj : dlldata.c
    CL /c /DWIN32 /DREGISTER_PROXY_DLL dlldata.c
example.obj : example_p.c
    CL .c.DWIN32 /DREGISTER_PROXY_DLL example_p.c
iids.obj : example_i.c
PROXYSTUBOBJS = dlldata.obj example.obj iids.obj
PROXYSTUBLIBS = kernel32.lib rpcndr.lib rpcns4.lib rpcrt4.lib uuid.lib
proxy.dll : $(PROXYSTUBOBJX) example.def
    link /dll /out:proxy.dll /def:example.def
        $(PROXYSTUBOBJS) $(ORIXYSTUBLIBS)
    regsvr32 /s proxy.dll
 </code></pre>
<p>
If you do not specify these preprocessor definitions at compile time, these functions are not automatically defined (that is, the macros in Rpcproxy.c expand to nothing). You would have to have defined them explicitly in another source file, whose module would also be included in the final linking and compilation on the C compiler command line. </p>
<p>
When REGISTER_PROXY_DLL is defined, Rpcproxy.h provides for additional conditional compilation control with PROXY_CLSID=&lt;<i>guid</i>&gt;, PROXY_CLSID_IS=&lt;<i>explicit value of guid</i>&gt;, and ENTRY_PREFIX=&lt;<i>prefix string</i>&gt;. These macro definitions are described in greater detail in <object id=alink_1 type="application/x-oleobject"
	classid="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
<PARAM name="Command" value="ALink,MENU">
<PARAM name="DefaultTopic" value="../../notopic_0pk4.htm">
<PARAM name="Item1" value="">
<PARAM name="Item2" value="_rpc_c_compiler_definitions_for_proxy_stubs">
</object><a href=JavaScript:alink_1.Click()>C-Compiler Definitions for Proxy/Stubs</a> in the MIDL Programmer's Guide. Also, the sample programs Marshal and Marshal2, in the COM Tutorial section of the Platform SDK use these macros to register the Proxy DLL.</p>
<h4>Manually Registering the Proxy DLL</h4>
<p>
If, for some reason, you cannot use the default proxy stub registration routines, you can manually register the DLL by adding the following entries to the system registry, using Regedit.exe (for Windows® 95) or Regedt32.exe (for Windows NT®). </p>
<pre><code>\HKEY_CLASSES_ROOT\Interface\{&lt;iid&gt;}
    =ICustomInterfaceName 
\HKEY_CLASSES_ROOT\Interface\{&lt;iid&gt;}\ProxyStubClsid32 
    ={&lt;clsid&gt;} 
\HKEY_CLASSES_ROOT\CLSID\{&lt;clsid&gt;} 
    =ICustomInterfaceName_PSFactory 
\HKEY_CLASSES_ROOT\CLSID\{&lt;clsid&gt;}\InprocServer32
    =proxstub.dll 
 </code></pre>
<h4>See Also</h4>
<p>
Registering COM Servers, Self-Registration, C-Compiler Definitions for Proxy/Stubs </p>
<p>&nbsp;</p></body>
</HTML>
