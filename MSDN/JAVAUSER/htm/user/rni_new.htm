<!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML//EN">
<HTML>
<HEAD><script async src="https://www.googletagmanager.com/gtag/js?id=UA-83731338-2"></script><script>  window.dataLayer = window.dataLayer || [];  function gtag(){dataLayer.push(arguments);}  gtag('js', new Date());  gtag('config', 'UA-83731338-2');</script><title>Raw Native Interface Enhancements</TITLE>
<META HTTP-EQUIV="Content-Type" CONTENT="text/html; CHARSET=iso8859-1">
<META NAME="MS.LOCALE" CONTENT="EN-US">
<META NAME="ROBOTS" CONTENT="all">
</HEAD>
<BODY BGCOLOR="White" TOPMARGIN=0 LEFTMARGIN=0 VLINK="#006699" ALINK="#006699">
<A NAME="top"></A>
<!--TOOLBAR_START-->
<!--TOOLBAR_END-->

<TABLE BORDER=0 CELLPADDING=0 CELLSPACING=0 WIDTH="98%">
<TR>
<TD ROWSPAN=2 WIDTH=114 ALIGN="LEFT" VALIGN="TOP">
<IMG SRC="art/title_x3.gif" WIDTH="112" HEIGHT="108"  BORDER=0 ALT="Introduction to Using the Raw Native Interface"><TABLE CELLPADDING=0 CELLSPACING=0 BORDER=0 WIDTH="100%">
<TR><TD WIDTH=10>&nbsp;</TD><TD VALIGN="top"><FONT FACE="Verdana,Arial,Helvetica" SIZE=1><B STYLE="color:#006699">In this topic</B><P><IMG SRC="art/linkbull.gif" WIDTH="10" HEIGHT="8"  BORDER=0 ALT="*"><A STYLE="color: #333366;text-decoration:none" HREF="rni_new.htm#rniintro_0008010202010000">Reflection APIs</A>
<P><IMG SRC="art/linkbull.gif" WIDTH="10" HEIGHT="8"  BORDER=0 ALT="*"><A STYLE="color: #333366;text-decoration:none" HREF="rni_new.htm#rniintro_0008010202020000">Future Garbage Collection Performance Enhancements</A>
<P><IMG SRC="art/linkbull.gif" WIDTH="10" HEIGHT="8"  BORDER=0 ALT="*"><A STYLE="color: #333366;text-decoration:none" HREF="rni_new.htm#rniintro_0008010202030000">RNIGetCompatibleVersion Requirement</A>
<P><IMG SRC="art/linkbull.gif" WIDTH="10" HEIGHT="8"  BORDER=0 ALT="*"><A STYLE="color: #333366;text-decoration:none" HREF="rni_new.htm#rniintro_0008010202040000">RNI Invocation APIs</A>
<P><IMG SRC="art/linkbull.gif" WIDTH="10" HEIGHT="8"  BORDER=0 ALT="*"><A STYLE="color: #333366;text-decoration:none" HREF="rni_new.htm#rniintro_0008010202050000">Details of the New GC Model</A>
</FONT></TD></TR></TABLE>
</TD>
<TD WIDTH=20>&nbsp;</TD>
<TD ALIGN="LEFT" VALIGN="TOP">
<P>
<TABLE BORDER="0" CELLPADDING="0" CELLSPACING="0">
<TR>
<TD WIDTH="365" VALIGN="bottom"><IMG SRC="art/jnative2.gif" WIDTH="365" HEIGHT="27"  BORDER=0 ALT="Java & Native Code"></TD>
<TD WIDTH=20>&nbsp;</TD>
<TD ALIGN="center" VALIGN="bottom">&nbsp;</TD><TD ALIGN="center" VALIGN="bottom"><A HREF="rni_introduction.htm"><IMG SRC="art/prevnrm.gif" WIDTH="51" HEIGHT="38"  BORDER=0 ALT="Previous"></A></TD><TD ALIGN="center" VALIGN="bottom"><A HREF="rni_introduction.htm"><IMG SRC="art/homenrm.gif" WIDTH="51" HEIGHT="38"  BORDER=0 ALT="RNI"></A></TD><TD ALIGN="center" VALIGN="bottom"><A HREF="rni_Simple_Example.htm"><IMG SRC="art/nextnrm.gif" WIDTH="51" HEIGHT="38"  BORDER=0 ALT="Next"></A></TD></TR>
<TR>
<TD WIDTH="365" ALIGN="right" VALIGN="top"><FONT COLOR="#006699" SIZE="4" FACE="VERDANA,ARIAL,HELVETICA"><B>Introduction to Using the Raw Native Interface</B></FONT></TD>
<TD WIDTH=20>&nbsp;</TD>
<TD ALIGN="center" VALIGN="top"><FONT FACE="VERDANA,ARIAL,HELVETICA" SIZE="1">&nbsp;</FONT></TD>
<TD ALIGN="center" VALIGN="top"><FONT FACE="VERDANA,ARIAL,HELVETICA" SIZE="1">Previous</FONT></TD>
<TD ALIGN="center" VALIGN="top"><FONT FACE="VERDANA,ARIAL,HELVETICA" SIZE="1">RNI</FONT></TD>
<TD ALIGN="center" VALIGN="top"><FONT FACE="VERDANA,ARIAL,HELVETICA" SIZE="1">Next</FONT></TD>
</TR>
</TABLE>
</TD>
</TR>
<TR>
<TD WIDTH=20>&nbsp;</TD>
<TD>
<BR>
<FONT FACE="VERDANA,ARIAL,HELVETICA" SIZE="2">
<BR><BR><H2 STYLE="color:#333366">Raw Native Interface Enhancements</H2>
<P>The Raw Native Interface (RNI) has been extended as a result of feedback and performance enhancements. The enhancements made to RNI are in the following four primary areas:

<UL><LI><A HREF="rni_new.htm#rniintro_0008010202010000">Additional APIs to enable reflection from native code</A>
<LI><A HREF="rni_new.htm#rniintro_0008010202020000">Changes to support future garbage collection performance enhancements</A>
<LI><A HREF="rni_new.htm#rniintro_0008010202030000">RNIGetCompatibleVersion requirement for RNI DLLs</A>
<LI><A HREF="rni_new.htm#rniintro_0008010202040000">RNI invocation APIs</A>
</UL>
<H3 STYLE="color:#333366"><A NAME="rniintro_0008010202010000">Reflection APIs</A></H3><P>A number of native reflection APIs have been added to improve accessibility of an object's methods and fields. Using these APIs insulates DLLs from changes to the underlying object model or changes in the class hierarchy. 

<P>Users of RNI should use the new write barrier support functions to set an object field inside another object. These APIs are <A HREF="rniref.htm#rniref_0008010401003100">GCSetObjectReferenceForObject</A> and <A HREF="rniref.htm#rniref_0008010401003000">GCSetObjectReferenceForHandle</A>. Also, <B>Field_SetValue</B>, already in Internet Explorer 3.x (the VM version in SDK 1.5), will support the write barrier. RNI developers are encouraged to use the "Field_" reflection APIs added in Internet Explorer 3.x because these APIs abstract the object layout. Since these APIs are available on Internet Explorer 3.x, it should be possible to make a single DLL that will work on Internet Explorer 3.x and Internet Explorer 4.0.

<H3 STYLE="color:#333366"><A NAME="rniintro_0008010202020000">Future Garbage Collection Performance Enhancements</A></H3><P>To support future garbage collection enhancements, the internal object model was changed to enable more effective garbage collection, and enable future write-barrier support in the garbage collector (see <A HREF="rni_new.htm#rniintro_0008010202050000">Details of the New GC Model</A> below for details). To insulate code from these or future changes to the object model, developers are encouraged to use the reflection APIs described previously. A Java object may still be accessed as a C structure, but code will need to be recompiled using the updated msjavah tool provided in this SDK. 

<H3 STYLE="color:#333366"><A NAME="rniintro_0008010202030000">RNIGetCompatibleVersion Requirement</A></H3><P>Due to the object model changes described previously, many RNI DLLs designed for earlier versions of the Microsoft virtual machine need to be recompiled. To identify whether an RNI DLL is compatible with the current version of the VM, it will call the RNI DLL's <A HREF="rniref.htm#rniref_0008010401004f00">RNIGetCompatibleVersion</A> export. RNI DLLs that do not export this API will not be loaded by the current VM.

<H3 STYLE="color:#333366"><A NAME="rniintro_0008010202040000">RNI Invocation APIs</A></H3><P>The virtual machine supports two new invocation APIs, <A HREF="rniref.htm#rniref_0008010401004e00">PrepareThreadForJava</A> and <A HREF="rniref.htm#rniref_0008010401005300">UnprepareThreadForJava</A>, which can be used to execute RNI APIs on any Win32 thread. An invocation sample is provided in this SDK. 

<H3 STYLE="color:#333366"><A NAME="rniintro_0008010202050000">Details of the New GC Model</A></H3><P>The ordering of values laid out within objects has changed.

<P>Previously, if you had a class A with a string, an int and a string, followed by class B with an int
and a string, the object layout in memory is as follows:

<PRE><FONT FACE="Courier" SIZE="2">
From A string (can be garbage collected)
    int (atomic non-collectable)
    string
From B int
    string
</FONT></PRE>
<P>The new Garbage Collection model reduces the number of GC roots (in this example there are three).

<P>The new object layout coalesces collectable objects within a class, and alternates
object location from beginning to end, to coalesce between classes. The object layout for
this would be as follows:
<PRE><FONT FACE="Courier" SIZE="2">
From A  int (atomic non-collectable)
    string (can be garbage collected)
    string
From B  string
    int
</FONT></PRE>
<P>This gives just one GC root rather than three.

<P>Because of this model change, all code that uses RNI needs to be rebuilt and recompiled with the new <B>msjavah</B> tool. Existing code that hasn't been recompiled will not run on existing VMs. Also, existing code that relies on accessing strings directly, rather than using a provided API, will not function.


<P>
</FONT>
</TD>
</TR>
</TABLE>
<CENTER>
<P><TABLE WIDTH="95%"><TR><TD HEIGHT=1 BGCOLOR="RED"></TD></TR></TABLE>
<TABLE WIDTH="100%"><TR>
<TD ALIGN="left"><A HREF="#top"><IMG SRC="art/upnrm.gif" WIDTH="51" HEIGHT="38"  BORDER=0 ALT="Top"></A></TD>
<TD ALIGN="right">
<FONT FACE="VERDANA,ARIAL,HELVETICA" SIZE="1"><A HREF="cpyright.htm">&#169; 1998 Microsoft Corporation. All rights reserved. Terms of use.</A></FONT></TD></TR></TABLE>
</CENTER>
</BODY></HTML>
