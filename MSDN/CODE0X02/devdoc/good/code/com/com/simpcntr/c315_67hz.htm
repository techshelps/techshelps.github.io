<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<HTML dir=ltr>
<HEAD>
<META HTTP-EQUIV="Content-Type" Content="text/html; charset=Windows-1252">
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-83731338-2"></script><script>  window.dataLayer = window.dataLayer || [];  function gtag(){dataLayer.push(arguments);}  gtag('js', new Date());  gtag('config', 'UA-83731338-2');</script><title>DOC.CPP</title>
<link disabled rel=stylesheet href=../../../../../backsdk3.css>
<style type="text/css">
@import url(../../../../../backsdk4.css);
</style>
</HEAD>
<BODY BGCOLOR = #FFFFFF TEXT = #000000>
<h2><a name="_code_context317"></a>DOC.CPP</h2>
<pre><code>//********************************************************************** <br>// File name: DOC.CPP <br>// <br>//      Implementation file for CSimpleDoc. <br>// <br>// Functions: <br>// <br>//      See DOC.H for Class Definition <br>// <br>// Copyright 1992 - 1998 Microsoft Corporation. All rights reserved. <br>//********************************************************************** <br> <br>#include "pre.h" <br>#include "iocs.h" <br>#include "ias.h" <br>#include "ioipf.h" <br>#include "ioips.h" <br>#include "app.h" <br>#include "site.h" <br>#include "doc.h" <br> <br>//********************************************************************** <br>// <br>// CSimpleDoc::Create <br>// <br>// Purpose: <br>// <br>//      Creation for the CSimpleDoc Class <br>// <br>// Parameters: <br>// <br>//      CSimpleApp FAR * lpApp  -   Pointer to the CSimpleApp Class <br>// <br>//      LPRECT lpRect           -   Client area rect of "frame" window <br>// <br>//      HWND hWnd               -   Window Handle of "frame" window <br>// <br>// Return Value: <br>// <br>//      None <br>// <br>// Function Calls: <br>//      Function                    Location <br>// <br>//      StgCreateDocfile            OLE API <br>//      CreateWindow                Windows API <br>//      ShowWindow                  Windows API <br>//      UpdateWindow                Windows API <br>// <br>// Comments: <br>// <br>//      This routine was added so that failure could be returned <br>//      from object creation. <br>// <br>//******************************************************************** <br> <br>CSimpleDoc FAR * CSimpleDoc::Create(CSimpleApp FAR *lpApp, LPRECT lpRect,HWND hWnd) <br>{ <br>        CSimpleDoc FAR * lpTemp = new CSimpleDoc(lpApp, hWnd); <br> <br>        if (!lpTemp) <br>                return NULL; <br> <br>        // create storage for the doc. <br>        HRESULT hErr = StgCreateDocfile (NULL, STGM_READWRITE | STGM_TRANSACTED | STGM_SHARE_EXCLUSIVE, <br>                                                                         0, &amp;lpTemp-&gt;m_lpStorage); <br> <br>        if (hErr != NOERROR) <br>                goto error; <br> <br>        // create the document Window <br>        lpTemp-&gt;m_hDocWnd = CreateWindow( <br>                        "SimpCntrDocWClass", <br>                        NULL, <br>                        WS_CHILD | WS_CLIPCHILDREN, <br>                        lpRect-&gt;left, <br>                        lpRect-&gt;top, <br>                        lpRect-&gt;right, <br>                        lpRect-&gt;bottom, <br>                        hWnd, <br>                        NULL, <br>                        lpApp-&gt;m_hInst, <br>                        NULL); <br> <br>        if (!lpTemp-&gt;m_hDocWnd) <br>                goto error; <br> <br>        ShowWindow(lpTemp-&gt;m_hDocWnd, SW_SHOWNORMAL);  // Show the window <br>        UpdateWindow(lpTemp-&gt;m_hDocWnd);               // Sends WM_PAINT message <br> <br>        // Ensable InsertObject menu choice <br>        EnableMenuItem( lpApp-&gt;m_hEditMenu, 0, MF_BYPOSITION | MF_ENABLED); <br> <br>        // we will add one ref count on our document. later in CSimpleDoc::Close <br>        // we will release this  ref count. when the document's ref count goes <br>        // to 0, the document will be deleted. <br>        lpTemp-&gt;AddRef(); <br> <br>        return (lpTemp); <br> <br>error: <br>        delete (lpTemp); <br>        return NULL; <br> <br>} <br> <br>//********************************************************************** <br>// <br>// CSimpleDoc::Close <br>// <br>// Purpose: <br>// <br>//      Close CSimpleDoc object. <br>//      when the document's reference count goes to 0, the document <br>//      will be destroyed. <br>// <br>// Parameters: <br>// <br>// <br>// Return Value: <br>// <br>//      None <br>// <br>// Function Calls: <br>//      Function                    Location <br>// <br>//      RevokeDragDrop              OLE API <br>//      CoLockObjectExternal        OLE API <br>//      OleFlushClipboard           OLE API <br>//      ShowWindow                  Windows API <br>// <br>// Comments: <br>// <br>//******************************************************************** <br> <br>void CSimpleDoc::Close(void) <br>{ <br>        OutputDebugString("In CSimpleDoc::Close\r\n"); <br> <br>        ShowWindow(m_hDocWnd, SW_HIDE);  // Hide the window <br> <br>        // Close the OLE object in our document <br>        if (m_lpSite) <br>                m_lpSite-&gt;CloseOleObject(); <br> <br>        // Release the ref count added in CSimpleDoc::Create. this will make <br>        // the document's ref count go to 0, and the document will be deleted. <br>        Release(); <br>} <br> <br>//********************************************************************** <br>// <br>// CSimpleDoc::CSimpleDoc <br>// <br>// Purpose: <br>// <br>//      Constructor for the CSimpleDoc Class <br>// <br>// Parameters: <br>// <br>//      CSimpleApp FAR * lpApp  -   Pointer to the CSimpleApp Class <br>// <br>//      HWND hWnd               -   Window Handle of "frame" window <br>// <br>// Return Value: <br>// <br>//      None <br>// <br>// Function Calls: <br>//      Function                    Location <br>// <br>//      OutputDebugString           Windows API <br>//      GetMenu                     Windows API <br>//      GetSubMenu                  Windows API <br>// <br>// Comments: <br>// <br>//******************************************************************** <br> <br>CSimpleDoc::CSimpleDoc(CSimpleApp FAR * lpApp,HWND hWnd) <br>{ <br>        OutputDebugString("In CSimpleDoc's Constructor\r\n"); <br>        m_lpApp = lpApp; <br>        m_lpSite = NULL; <br>        // set up menu handles <br>        m_lpApp-&gt;m_hMainMenu = GetMenu(hWnd); <br>        m_lpApp-&gt;m_hFileMenu = GetSubMenu(m_lpApp-&gt;m_hMainMenu, 0); <br>        m_lpApp-&gt;m_hEditMenu = GetSubMenu(m_lpApp-&gt;m_hMainMenu, 1); <br>        m_lpApp-&gt;m_hHelpMenu = GetSubMenu(m_lpApp-&gt;m_hMainMenu, 2); <br>        m_lpApp-&gt;m_hCascadeMenu = NULL; <br> <br>        m_lpActiveObject = NULL; <br> <br>        // flags <br>        m_fInPlaceActive = FALSE; <br>        m_fAddMyUI = FALSE; <br>        m_fModifiedMenu = FALSE; <br>} <br> <br>//********************************************************************** <br>// <br>// CSimpleDoc::~CSimpleDoc <br>// <br>// Purpose: <br>// <br>//      Destructor for CSimpleDoc <br>// <br>// Parameters: <br>// <br>//      None <br>// <br>// Return Value: <br>// <br>//      None <br>// <br>// Function Calls: <br>//      Function                    Location <br>// <br>//      OutputDebugString           Windows API <br>//      CSimpleSite::Release        SITE.CPP <br>//      IStorage::Release           OLE API <br>// <br>// Comments: <br>// <br>//******************************************************************** <br> <br>CSimpleDoc::~CSimpleDoc() <br>{ <br>        OutputDebugString("In CSimpleDoc's Destructor\r\n"); <br> <br>        // Release all pointers we hold to the OLE object. also release <br>        // the ref count added in CSimpleSite::Create. this will make <br>        // the Site's ref count go to 0, and the Site will be deleted. <br>        if (m_lpSite) { <br>                m_lpSite-&gt;UnloadOleObject(); <br>                m_lpSite-&gt;Release(); <br>                m_lpSite = NULL; <br>        } <br> <br>        // Release the Storage <br>        if (m_lpStorage) { <br>                m_lpStorage-&gt;Release(); <br>                m_lpStorage = NULL; <br>        } <br> <br>        // if the edit menu was modified, remove the menu item and <br>        // destroy the popup if it exists <br>        if (m_fModifiedMenu) <br>                { <br>                int nCount = GetMenuItemCount(m_lpApp-&gt;m_hEditMenu); <br>                RemoveMenu(m_lpApp-&gt;m_hEditMenu, nCount-1, MF_BYPOSITION); <br>                if (m_lpApp-&gt;m_hCascadeMenu) <br>                        DestroyMenu(m_lpApp-&gt;m_hCascadeMenu); <br>                } <br> <br>        DestroyWindow(m_hDocWnd); <br>} <br> <br> <br>//********************************************************************** <br>// <br>// CSimpleDoc::QueryInterface <br>// <br>// Purpose: <br>// <br>//      Return a pointer to a requested interface <br>// <br>// Parameters: <br>// <br>//      REFIID riid         -   ID of interface to be returned <br>//      LPVOID FAR* ppvObj  -   Location to return the interface <br>// <br>// Return Value: <br>// <br>//      S_FALSE -   Always <br>// <br>// Function Calls: <br>//      Function                    Location <br>// <br>//      OutputDebugString           Windows API <br>//                   OLE API <br>// <br>// Comments: <br>// <br>//      In this implementation, there are no doc level interfaces. <br>//      In an MDI application, there would be an IOleInPlaceUIWindow <br>//      associated with the document to provide document level tool <br> //     space negotiation. <br>// <br>//******************************************************************** <br> <br>STDMETHODIMP CSimpleDoc::QueryInterface(REFIID riid, LPVOID FAR* ppvObj) <br>{ <br>        OutputDebugString("In CSimpleDoc::QueryInterface\r\n"); <br> <br>        *ppvObj = NULL;     // must set out pointer parameters to NULL <br> <br>        // Not a supported interface <br>        return E_NOINTERFACE; <br>} <br> <br>//********************************************************************** <br>// <br>// CSimpleDoc::AddRef <br>// <br>// Purpose: <br>// <br>//      Increments the document reference count <br>// <br>// Parameters: <br>// <br>//      None <br>// <br>// Return Value: <br>// <br>//      UINT    -   The current reference count on the document <br>// <br>// Function Calls: <br>//      Function                    Location <br>// <br>//      OutputDebugString           Windows API <br>//      CSimpleApp::AddRef          APP.CPP <br>// <br>// Comments: <br>// <br>//******************************************************************** <br> <br>STDMETHODIMP_(ULONG) CSimpleDoc::AddRef() <br>{ <br>        OutputDebugString("In CSimpleDoc::AddRef\r\n"); <br>        return SafeAddRef(); <br>} <br> <br>//********************************************************************** <br>// <br>// CSimpleDoc::Release <br>// <br>// Purpose: <br>// <br>//      Decrements the document reference count <br>// <br>// Parameters: <br>// <br>//      None <br>// <br>// Return Value: <br>// <br>//      UINT    -   The current reference count on the document <br>// <br>// Function Calls: <br>//      Function                    Location <br>// <br>//      OutputDebugString           Windows API <br>// <br>// Comments: <br>// <br>//******************************************************************** <br> <br>STDMETHODIMP_(ULONG) CSimpleDoc::Release() <br>{ <br>        OutputDebugString("In CSimpleDoc::Release\r\n"); <br> <br>        return SafeRelease(); <br>} <br> <br>//********************************************************************** <br>// <br>// CSimpleDoc::InsertObject <br>// <br>// Purpose: <br>// <br>//      Inserts a new object to this document <br>// <br>// Parameters: <br>// <br>//      None <br>// <br>// Return Value: <br>// <br>//      None <br>// <br>// Function Calls: <br>//      Function                    Location <br>// <br>//      CSimpleSite::CSimpleSite    SITE.CPP <br>//      CSimpleSite::InitObject     SITE.CPP <br>//      memset                      C Runtime <br>//      OleUIInsertObject           OUTLUI function <br>//      CSimpleDoc::DisableInsertObject DOC.CPP <br>// <br>// Comments: <br>// <br>//      This implementation only allows one object to be inserted <br>//      into a document.  Once the object has been inserted, then <br>//      the Insert Object menu choice is greyed out, to prevent <br>//      the user from inserting another. <br>// <br>//******************************************************************** <br> <br>void CSimpleDoc::InsertObject() <br>{ <br>        CStabilize stabilize(this); <br>        OLEUIINSERTOBJECT io; <br>        UINT iret; <br>  //@@WTK WIN32, UNICODE <br>        //char szFile[MAX_PATH]; <br>        TCHAR szFile[MAX_PATH]; <br> <br>        m_lpSite = CSimpleSite::Create(this); <br> <br>        // clear the structure <br>        memset(&amp;io, 0, sizeof(OLEUIINSERTOBJECT)); <br> <br>        // fill the structure <br>        io.cbStruct = sizeof(OLEUIINSERTOBJECT); <br>        io.dwFlags = IOF_SELECTCREATENEW | <br>                                        IOF_DISABLELINK | IOF_DISABLEDISPLAYASICON | <br>                                        IOF_CREATENEWOBJECT | IOF_CREATEFILEOBJECT; <br>        io.hWndOwner = m_hDocWnd; <br>  //@@WTK WIN32, UNICODE <br>        //io.lpszCaption = (LPSTR)"Insert Object"; <br>        io.lpszCaption = _T("Insert Object"); <br>        io.iid = IID_IOleObject; <br>        io.oleRender = OLERENDER_DRAW; <br>        io.lpIOleClientSite = &amp;m_lpSite-&gt;m_OleClientSite; <br>        io.lpIStorage = m_lpSite-&gt;m_lpObjStorage; <br>        io.ppvObj = (LPVOID FAR *)&amp;m_lpSite-&gt;m_lpOleObject; <br>        io.lpszFile = szFile; <br>  //@@WTK WIN32, UNICODE <br>        //io.cchFile = sizeof(szFile); <br>        io.cchFile = sizeof(szFile) / sizeof *szFile; <br>  //@@WTK WIN32, UNICODE <br>        //_fmemset((LPSTR)szFile, 0, sizeof(szFile)); <br>        memset(szFile, 0, sizeof(szFile)); <br> <br>        // call OUTLUI to do all the hard work <br>        iret = OleUIInsertObject(&amp;io); <br> <br>        if (iret == OLEUI_OK) <br>                { <br>                m_lpSite-&gt;InitObject((BOOL)(io.dwFlags &amp; IOF_SELECTCREATENEW)); <br>                // disable Insert Object menu item <br>                DisableInsertObject(); <br>                } <br>        else <br>                { <br>                m_lpSite-&gt;Release(); <br>                m_lpSite = NULL; <br>                m_lpStorage-&gt;Revert(); <br>                } <br> <br>} <br> <br>//********************************************************************** <br>// <br>// CSimpleDoc::lResizeDoc <br>// <br>// Purpose: <br>// <br>//      Resizes the document <br>// <br>// Parameters: <br>// <br>//      LPRECT lpRect   -   The size of the client are of the "frame" <br>//                          Window. <br>// <br>// Return Value: <br>// <br>//      NULL <br>// <br>// Function Calls: <br>//      Function                                Location <br>// <br>//      IOleInPlaceActiveObject::ResizeBorder   Object <br>//      MoveWindow                              Windows API <br>// <br>// Comments: <br>// <br>//******************************************************************** <br> <br>long CSimpleDoc::lResizeDoc(LPRECT lpRect) <br>{ <br>        CStabilize stabilize(this); <br>        // if we are InPlace, then call ResizeBorder on the object, otherwise <br>        // just move the document window. <br>        if (m_fInPlaceActive) <br>                m_lpActiveObject-&gt;ResizeBorder(lpRect, &amp;m_lpApp-&gt;m_OleInPlaceFrame, TRUE); <br>        else <br>                MoveWindow(m_hDocWnd, lpRect-&gt;left, lpRect-&gt;top, lpRect-&gt;right, lpRect-&gt;bottom, TRUE); <br> <br>        return NULL; <br>} <br> <br>//********************************************************************** <br>// <br>// CSimpleDoc::lAddVerbs <br>// <br>// Purpose: <br>// <br>//      Adds the objects verbs to the edit menu. <br>// <br>// Parameters: <br>// <br>//      None <br>// <br>// Return Value: <br>// <br>//      NULL <br>// <br>// Function Calls: <br>//      Function                    Location <br>// <br>//      GetMenuItemCount            Windows API <br>//      OleUIAddVerbMenu            OUTLUI function <br>// <br>// Comments: <br>// <br>//******************************************************************** <br> <br>long CSimpleDoc::lAddVerbs(void) <br>{ <br>        CStabilize stabilize(this); <br>        // m_fModifiedMenu is TRUE if the menu has already been modified <br>        // once.  Since we only support one obect every time the application <br>        // is run, then once the menu is modified, it doesn't have <br>        // to be done again. <br>        if (m_lpSite &amp;&amp; !m_fInPlaceActive  &amp;&amp; !m_fModifiedMenu) <br>                { <br>                int nCount = GetMenuItemCount(m_lpApp-&gt;m_hEditMenu); <br> <br>                OleUIAddVerbMenu ( m_lpSite-&gt;m_lpOleObject, <br>                                                   NULL, <br>                                                   m_lpApp-&gt;m_hEditMenu, <br>                                                   nCount + 1, <br>                                                   IDM_VERB0, <br>                                                   0,           // no maximum verb IDM enforced <br>                                                   FALSE, <br>                                                   0, <br>                                                   &amp;m_lpApp-&gt;m_hCascadeMenu); <br> <br>                m_fModifiedMenu = TRUE; <br>                } <br>        return (NULL); <br>} <br> <br>//********************************************************************** <br>// <br>// CSimpleDoc::PaintDoc <br>// <br>// Purpose: <br>// <br>//      Paints the Document <br>// <br>// Parameters: <br>// <br>//      HDC hDC -   hDC of the document Window <br>// <br>// Return Value: <br>// <br>//      None <br>// <br>// Function Calls: <br>//      Function                    Location <br>// <br>//      CSimpleSite::PaintObj       SITE.CPP <br>// <br>// Comments: <br>// <br>//******************************************************************** <br> <br>void CSimpleDoc::PaintDoc (HDC hDC) <br>{ <br>        CStabilize stabilize(this); <br>        // if we supported multiple objects, then we would enumerate <br>        // the objects and call paint on each of them from here. <br> <br>        if (m_lpSite) <br>                m_lpSite-&gt;PaintObj(hDC); <br> <br>} <br> <br>//********************************************************************** <br>// <br>// CSimpleDoc::DisableInsertObject <br>// <br>// Purpose: <br>// <br>//      Disable the ability to insert a new object in this document. <br>// <br>// Parameters: <br>// <br>//      None <br>// <br>// Return Value: <br>// <br>//      None <br>// <br>// Function Calls: <br>//      Function                    Location <br>// <br>//      EnableMenuItem              Windows API <br>// <br>// Comments: <br>// <br>//      This implementation only allows one object to be inserted <br>//      into a document.  Once the object has been inserted, then <br>//      the Insert Object menu choice is greyed out, to prevent <br>//      the user from inserting another. <br>// <br>//******************************************************************** <br> <br>void CSimpleDoc::DisableInsertObject(void) <br>{ <br>        // Disable InsertObject menu choice <br>        EnableMenuItem( m_lpApp-&gt;m_hEditMenu, 0, MF_BYPOSITION | MF_DISABLED | MF_GRAYED); <br>} </code></pre>
<p>&nbsp;</p></body>
</HTML>
