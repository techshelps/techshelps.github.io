<!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML//EN">
<HTML>
<HEAD><META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=Windows-1252">
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-83731338-2"></script><script>  window.dataLayer = window.dataLayer || [];  function gtag(){dataLayer.push(arguments);}  gtag('js', new Date());  gtag('config', 'UA-83731338-2');</script><title>A.2.5  SCSI Filter Driver’s IoCompletion Routines</TITLE>
<style>@import url(/msdn_ie4.css);</style>
<link disabled rel="stylesheet" href="/msdn_ie3.css"></HEAD>
<BODY BGPROPERTIES="FIXED" TEXT="#000000" BGCOLOR="#FFFFFF">

<FONT FACE="ARIAL,HELVETICA" SIZE="2">
<H3><A NAME="DDK_SCSI_Filter_Drivers_IoCompletion_Routines_KG"></A>A.2.5  SCSI Filter Driver’s IoCompletion Routines</H3>
<P>
A SCSI filter driver’s IoCompletion routine is called when lower (class and
port) drivers have called <B>IoCompleteRequest</B>. The SFD’s IoCompletion
routine should return STATUS_MORE_PROCESSING_REQUIRED to prevent completion
processing of a driver-allocated IRP. If the SFD will reuse the original IRP
before the SFD completes it, the SFD’s IoCompletion routine also should return
STATUS_MORE_PROCESSING_REQUIRED. 
<P>
Like any other higher-level driver, an SFD’s IoCompletion routine is
responsible for calling <B>IoFreeIrp</B>&nbsp;to release any IRP the driver’s
Dispatch routine(s) created with <B>IoAllocateIrp</B>&nbsp;or <B>IoBuildAsynchronousFsdRequest</B>.
<P>
Depending on its device, an SFD might supply an IoCompletion routine for IRPs
it sends to the class driver from its Dispatch routines. In particular, a
device that retrieves and processes data in a nonstandard format might require
the SFD to have a TranslateDataIn routine called from its IoCompletion routine
for transfer requests from such a device to system memory. 
<P>
Note that such a TranslateDataIn routine would be called at IRQL
DISPATCH_LEVEL and in an arbitrary thread context. Therefore, the buffer into
which the driver returns data either must be located in nonpaged pool or must
be locked down and accessible using mapped, nonpaged system-space virtual
addresses. For more information about accessing user-supplied buffers at
raised IRQL safely, see Chapter 16. 
<P>
In general, a SCSI filter driver should supply an IoCompletion routine with
the same functionality as a class driver’s IoCompletion routine for IRPs that
the filter driver sets up with SRBs and CDBs. Consequently, a SCSI filter
driver might have any or all of the ReleaseQueue, InterpretRequestSense, or
RetryRequest routines that can be called from a SCSI class driver’s
IoCompletion routine(s). 
<P>
For more information about InterpretRequestSense, RetryRequest, and
ReleaseQueue routines, see <A HREF="appascsi_16.htm">Sections
A.1.5.1</A>, <A HREF="appascsi_17.htm">A.1.5.2</A>,
and <A HREF="appascsi_18.htm">A.1.5.3</A>. For more
information about general requirements for IoCompletion routines, see Chapter
13. 
<P></FONT>
</BODY>
</HTML>
