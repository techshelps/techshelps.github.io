<!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML//EN">
<HTML>
<HEAD><META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=Windows-1252">
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-83731338-2"></script><script>  window.dataLayer = window.dataLayer || [];  function gtag(){dataLayer.push(arguments);}  gtag('js', new Date());  gtag('config', 'UA-83731338-2');</script><title>16.8.3  Claiming Hardware Resources</TITLE>
<style>@import url(/msdn_ie4.css);</style>
<link disabled rel="stylesheet" href="/msdn_ie3.css"></HEAD>
<BODY BGPROPERTIES="FIXED" TEXT="#000000" BGCOLOR="#FFFFFF">

<FONT FACE="ARIAL,HELVETICA" SIZE="2">
<H3><A NAME="DDK_Claiming_Hardware_Resources_KG"></A>16.8.3  Claiming Hardware Resources</H3>
<P>
When a device driver’s ConfigCallback routine returns, its DriverEntry routine
can use the configuration information collected from its subkeys under <B>\Registry\Machine\Hardware\Description</B>,
from calls to <B>HalGetBusData</B>&nbsp;or <B>HalGetBusDataByOffset</B>, and/or
from its <B>Parameters</B>&nbsp;subkey(s) under <B>\Registry\Machine\System\CurrentControlSet\Services\</B><I>DriverName</I>
in calls to one or more of <B>HalTranslateBusAddress</B>, <B>HalGetInterruptVector</B>,
and <B>HalGetAdapter</B>. The driver can use the values returned by these HAL
support routines as parameters to “higher-level” NT routines such as <B>MmMapIoSpace</B>,
<B>IoConnectInterrupt</B>, <B>HalAllocateCommonBuffer</B>,<B>&nbsp;</B>and, after
initialization <B>IoAllocateAdapterChannel</B>.
<P>
When an NT device driver has set up any NT objects that it needs, such as
device objects, but <I>before</I>&nbsp;the driver attempts to access its device(s)
registers or I/O ports, the DriverEntry routine must call one of the following
support routines one or more times to write configuration information about
the hardware resources the driver and its device(s) will be using into the
registry:
<UL>
<LI>
<B>IoReportResourceUsage</B>, which returns information about whether the
input hardware resources have already been claimed by a previously loaded
driver so NT device drivers can determine whether it is possible to initialize
their devices.
<P>
Usually, device drivers that call <B>IoQueryDeviceDescription</B>&nbsp;also call <B>IoReportResourceUsage</B>,
possibly after supplementing the returned hardware configuration information
in a buffered CM_RESOURCE_LIST that includes <B>DeviceSpecificData</B>.
<P>
<LI>
<B>IoAssignResources</B>&nbsp;with a buffered, driver-constructed
IO_RESOURCE_REQUIREMENTS_LIST that specifies set(s) of hardware resources the
driver (for all its devices) or a particular device can use, from which <B>IoAssignResources</B>
returns a buffered CM_RESOURCE_LIST describing the set of resources it claimed
in the registry.
<P>
Usually, device drivers that call <B>HalGetBusData</B>&nbsp;also call <B>IoAssignResources</B>.
Such a driver also might call <B>IoReportResourceUsage</B>&nbsp;with the
CM_RESOURCE_LIST returned by <B>IoAssignResources</B>&nbsp;to which the driver has
appended its <B>DeviceSpecificData</B>&nbsp;before calling <B>IoReportResourceUsage</B>.
<P>
<LI>
<B>HalAssignSlotResources</B>&nbsp;to build, on behalf of the caller, an
IO_RESOURCE_REQUIREMENTS_LIST that specifies sets of hardware resources the
driver of a device at a particular slot on a dynamically configurable bus with
a published, standard interface, such as PCI, can use and to return a buffered
CM_RESOURCE_LIST describing the set of configuration resources it claimed in
the registry for the device.
<P>
Device drivers that call <B>HalGetBusDataByOffset</B>&nbsp;or <B>HalGetBusData</B>
with an input <I>BusDataType</I>&nbsp;for such a dynamically configurable I/O bus
can call <B>HalAssignSlotResources</B>. Such a driver also might call <B>HalSetBusDataByOffset</B>
or <B>HalSetBusData</B>&nbsp;to configure its device on the bus.
</UL>
<P>
A successful call to <B>IoReportResourceUsage</B>, <B>IoAssignResources</B>,
or <B>HalAssignSlotResources</B>&nbsp;claims a set of hardware resources for the
caller in the <B>\Registry\Machine\Hardware\ResourceMap</B>&nbsp;tree. Making such
a call prevents device drivers that load later from trying to use the hardware
resources already claimed by a loaded driver.
<H5><IMG SRC="../../../wedge.gif" BORDER=0>&nbsp; &nbsp; NT device driver writers should consider the following fact about calls to IoReportResourceUsage, IoAssignResources, or HalAssignSlotResources: </H5>
<P>
A subsequent call to any of the preceding support routines to claim resources
for the same device(s) overwrites the existing resource claims for the driver
or for the particular device in the registry <B>ResourceMap</B>.
<P>
Any NT device driver can call one or more of these routines more than once to
claim resources for itself or for a particular device. If it does, the caller
cannot attempt to claim a single resource at a time, assuming that its
previously claimed resources remain claimed. Instead, such a caller must
augment the list of claimed resources for the driver or for any particular
device at each call to these support routines.
<P></FONT>
</BODY>
</HTML>
