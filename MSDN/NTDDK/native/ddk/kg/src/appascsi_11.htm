<!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML//EN">
<HTML>
<HEAD><META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=Windows-1252">
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-83731338-2"></script><script>  window.dataLayer = window.dataLayer || [];  function gtag(){dataLayer.push(arguments);}  gtag('js', new Date());  gtag('config', 'UA-83731338-2');</script><title>A.1.4.2  Handling SCSI Pass-Through Requests</TITLE>
<style>@import url(/msdn_ie4.css);</style>
<link disabled rel="stylesheet" href="/msdn_ie3.css"></HEAD>
<BODY BGPROPERTIES="FIXED" TEXT="#000000" BGCOLOR="#FFFFFF">

<FONT FACE="ARIAL,HELVETICA" SIZE="2">
<H4><A NAME="DDK_Handling_SCSI_Pass_Through_Requests_KG"></A>A.1.4.2  Handling SCSI Pass-Through Requests</H4>
<P>
A class driver does not necessarily set up an SRB when it sets up an
IRP_MJ_DEVICE_CONTROL request for an I/O control code supported by the port
driver, such as IOCTL_SCSI_GET_CAPABILITIES, IOCTL_SCSI_PASS_THROUGH, or
IOCTL_SCSI_PASS_THROUGH_DIRECT. 
<P>
The class driver’s DispatchDeviceControl routine is responsible for the
following on receipt of a IOCTL_SCSI_PASS_THROUGH or
IOCTL_SCSI_PASS_THROUGH_DIRECT request: 
<UL>
<LI>
Checking that the length of the user buffer at <B>Parameters.DeviceIoControl.InputBufferLength</B>
is at least <B>sizeof</B>(SCSI_PASS_THROUGH) or <B>sizeof</B>(SCSI_PASS_THROUGH_DIRECT),
respectively, and for failing the IRP with STATUS_INVALID_PARAMETER if is not 
<P>
<LI>
Ensuring that certain fields in the SCSI_PASS_THROUGH or
SCSI_PASS_THROUGH_DIRECT structure contain correct values by setting the
pointer to the structure itself to <B>Irp-&gt;AssociatedIrp.SystemBuffer</B>,
and setting its <B>PathId</B>, <B>TargetId</B>, and <B>Lun</B>&nbsp;members to the
corresponding values from the driver’s device extension 
<P>
<LI>
Setting up the port driver’s I/O stack location as usual and also setting the <B>MinorFunction</B>
field to IRP_MN_SCSI_CLASS, which marks the request as having been processed
by a SCSI class driver 
</UL>
<P>
If the port driver’s I/O stack location for an IOCTL_SCSI_PASS_THROUGH or
IOCTL_SCSI_PASS_THROUGH_DIRECT request does not have its <B>MinorFunction</B>
field set with IRP_MN_SCSI_CLASS, the port driver assumes the request came
directly from an application and that no class driver exists for the target
device type. It is an application error to send such a request directly to the
port driver for a device that has been claimed by a SCSI class driver. 
<P></FONT>
</BODY>
</HTML>
