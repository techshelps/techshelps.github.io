<!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML//EN">
<HTML>
<HEAD><META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=Windows-1252">
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-83731338-2"></script><script>  window.dataLayer = window.dataLayer || [];  function gtag(){dataLayer.push(arguments);}  gtag('js', new Date());  gtag('config', 'UA-83731338-2');</script><title>16.4.2  Using the Kernel Stack</TITLE>
<style>@import url(/msdn_ie4.css);</style>
<link disabled rel="stylesheet" href="/msdn_ie3.css"></HEAD>
<BODY BGPROPERTIES="FIXED" TEXT="#000000" BGCOLOR="#FFFFFF">

<FONT FACE="ARIAL,HELVETICA" SIZE="2">
<H3><A NAME="DDK_Using_the_Kernel_Stack_KG"></A>16.4.2  Using the Kernel Stack</H3>
<P>
While an NT driver can pass data to its internal routines, the NT kernel-mode
stack size is around two pages. Consequently, NT drivers cannot pass large
amounts of data on the kernel stack. 
<H5><IMG SRC="../../../wedge.gif" BORDER=0>&nbsp; &nbsp; NT driver writers should take care not to run out of kernel-mode stack space by following these design guidelines: </H5>
<UL>
<LI>
Avoid making deeply nested calls from one internal driver routine to another
if each routine passes data on the kernel stack. 
<P>
<LI>
Take care to limit the number of recursive calls that can occur if you design
a driver with a recursive routine. 
</UL>
<P>
In other words, the call-tree structure of an NT driver should be relatively
flat. While nonpaged pool is also a limited system resource, it is better for
an NT driver to allocate a system-space buffer, as described in <A HREF="16issues_13.htm">Section
16.4.1.3</A>, than to run out of kernel stack space. 
<P>
The NT kernel-mode stack is in cached memory. Consequently, NT drivers cannot
transfer data on the stack using DMA. 
<H5><IMG SRC="../../../wedge.gif" BORDER=0>&nbsp; &nbsp; NT driver writers should avoid DMA data alignment and/or data integrity problems by following this design guideline: </H5>
<P>
<I>Never</I>&nbsp;attempt to transfer data on the kernel stack using DMA. 
<P>
Drivers of devices that use DMA can buffer data to be transferred, if
necessary, either by calling <B>ExAllocatePool</B>&nbsp;or <B>ExAllocatePoolWithTag</B>
for a <B>NonPagedPoolCacheAligned</B>-type buffer or, for some drivers, by
using common-buffer DMA, as described in the section on adapter objects in
Chapter 3. 
<P></FONT>
</BODY>
</HTML>
