<!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML//EN">
<HTML>
<HEAD><META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=Windows-1252">
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-83731338-2"></script><script>  window.dataLayer = window.dataLayer || [];  function gtag(){dataLayer.push(arguments);}  gtag('js', new Date());  gtag('config', 'UA-83731338-2');</script><title>A.4.6  SCSI Miniport Driver’s HwScsiDmaStarted Routine</TITLE>
<style>@import url(/msdn_ie4.css);</style>
<link disabled rel="stylesheet" href="/msdn_ie3.css"></HEAD>
<BODY BGPROPERTIES="FIXED" TEXT="#000000" BGCOLOR="#FFFFFF">

<FONT FACE="ARIAL,HELVETICA" SIZE="2">
<H3><A NAME="DDK_SCSI_Miniport_Drivers_HwScsiDmaStarted_Routine_KG"></A>A.4.6  SCSI Miniport Driver’s HwScsiDmaStarted Routine</H3>
<P>
A miniport driver of an HBA that uses the system DMA controller must have a
HwScsiDmaStarted routine. 
<P>
For a data transfer operation, such a miniport driver must call <B>ScsiPortIoMapTransfer</B>,
passing in the pointers to its device extension for per-HBA data and to the
SRB requesting the transfer, along with a range of logical addresses for the
buffer from which or into which the data will be transferred. 
<P>
Note that the logical address range passed to <B>ScsiPortIoMapTransfer</B>
either must be the mapped values for the input SRB’s <B>DataBuffer</B>&nbsp;and <B>DataTransferLength</B>
or a proper subset of this range. For most transfer requests, a miniport
driver writer can assume that all data specified in the input SRB can be
transferred in a single DMA operation. 
<P>
In particular, a miniport driver might have to carry out more than one slave
DMA transfer operation to satisfy a given SRB only if the HBA provides
application-dedicated support and the application sends large transfer
requests directly to the miniport driver. Otherwise, it is the responsibility
of the Windows NT SCSI class drivers to split up large transfer requests into
a set of partial transfer requests, each sized to suit the capabilities of the
HBA (see <A HREF="appascsi_14.htm">Section
A.1.4.5</A>). 
<P>
<B>ScsiPortIoMapTransfer</B>&nbsp;calls the miniport’s HwScsiDmaStarted routine
when the system DMA controller is ready to transfer data between system memory
and the HBA. HwScsiDmaStarted must set up the HBA for the transfer operation. 
<P>
When a transfer operation is complete, the miniport driver must call <B>ScsiPortFlushDma</B>
before it calls <B>ScsiPortNotification</B>&nbsp;with the SRB and/or calls <B>ScsiPortIoMapTransfer</B>
to set up the DMA controller again for a subrange in an application-supplied
buffer if the HBA is dedicated to the support of a user-mode application. 
<P>
<B>ScsiPortFlushDma</B>&nbsp;flushes any remaining data cached in the DMA
controller. Note that <B>ScsiPortFlushDma</B>&nbsp;also can be called to cancel a
system DMA transfer, even if the miniport’s HwScsiDmaStarted routine has not
yet been called. 
<P>
For more information about <B>ScsiPortIoMapTransfer</B>&nbsp;and <B>ScsiPortFlushDma</B>,
see the <I>Kernel-Mode</I>&nbsp;<I>Driver Reference</I>. 
<P></FONT>
</BODY>
</HTML>
