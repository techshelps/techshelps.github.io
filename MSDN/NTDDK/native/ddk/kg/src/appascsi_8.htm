<!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML//EN">
<HTML>
<HEAD><META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=Windows-1252">
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-83731338-2"></script><script>  window.dataLayer = window.dataLayer || [];  function gtag(){dataLayer.push(arguments);}  gtag('js', new Date());  gtag('config', 'UA-83731338-2');</script><title>A.1.3.4  Setting up Device Extensions</TITLE>
<style>@import url(/msdn_ie4.css);</style>
<link disabled rel="stylesheet" href="/msdn_ie3.css"></HEAD>
<BODY BGPROPERTIES="FIXED" TEXT="#000000" BGCOLOR="#FFFFFF">

<FONT FACE="ARIAL,HELVETICA" SIZE="2">
<H4><A NAME="DDK_Setting_up_Device_Extensions_KG"></A>A.1.3.4  Setting up Device Extensions</H4>
<P>
In the device extension of each device object, the class driver provides
storage for whatever driver-determined data it uses to manage I/O requests for
the device, such as the pointer to the port driver’s HBA-specific device
object, a back pointer to its own device object, and so forth. 
<P>
Most SCSI class drivers also provide storage for the following SCSI-specific
information: 
<UL>
<LI>
A device-type-specific time-out value 
<P>
The class driver can pass the time-out value in SRBs it sends to the port
driver, which optionally times requests on behalf of each class driver. The
port driver returns an SRB with its <B>SrbStatus</B>&nbsp;member set to
SRB_STATUS_TIMEOUT if the interval between when the port driver sends the
request to the miniport driver and when the request completes exceeds the
specified time-out value. 
<P>
<LI>
A pointer to the class driver’s error-handling routine 
<P>
See <A HREF="appascsi_15.htm">Section A.1.5</A>
for more information about error-handling in SCSI class drivers. 
<P>
<LI>
A count that the driver maintains of SCSI protocol errors on the device 
<P>
<LI>
The <B>PathId</B>&nbsp;value 
<P>
This identifies the SCSI bus on which the device is attached. It is a required
value in SRBs. 
<P>
<LI>
The <B>TargetId</B>&nbsp;value 
<P>
This identifies the TID of the controller or device. It is a required value in
SRBs. 
<P>
<LI>
The <B>Lun</B>&nbsp;value 
<P>
This identifies the logical unit number of the device. It is a required value
in SRBs. 
<P>
<LI>
A pointer to a driver-allocated buffer for SCSI request-sense data 
<P>
A class driver must allocate memory for returned request-sense data from
cache-aligned, nonpaged pool. For more information about allocating memory for
driver buffers, see Chapter 16. 
<P>
<LI>
A driver-determined default value for <B>SrbFlags</B>&nbsp;that the class driver
sets in SRBs 
<P>
<LI>
A pointer to a zone header if the driver sets up a zone buffer for the SRBs it
allocates 
<P>
If the driver calls the <B>ExInterlocked..Zone</B>&nbsp;routines for its SRBs, it
also must provide storage for and initialize a spin lock that protects the
zone’s free list. For more information about using zones and spin locks, see
Chapter 16. 
<P>
<LI>
A spin lock used to guarantee multiprocessor-safe access to a count of
driver-allocated IRPs for partial transfer requests 
<P>
<LI>
A pointer to the IO_SCSI_CAPABILITIES-type data that the port driver collected
from the miniport driver of the HBA 
<P>
How class drivers get and use this data was described in <A HREF="appascsi_7.htm">Section
A.1.3.3</A>. 
</UL>
<P>
Note that a SCSI class driver’s original call to <B>IoGetDeviceObjectPointer</B>
creates a reference to the handle of the file object associated with the port
driver’s generic device object. The class driver must call <B>ObDereferenceObject</B>
to release this reference if the class driver is unloaded. 
<P>
A Windows NT SCSI class driver cannot send requests through the
system-supplied port driver to its device without using the port driver’s
HBA-specific device object pointer that was stored in the device extension by
the ClaimDevice routine. 
<P></FONT>
</BODY>
</HTML>
