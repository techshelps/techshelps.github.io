<!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML//EN">
<HTML>
<HEAD><META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=Windows-1252">
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-83731338-2"></script><script>  window.dataLayer = window.dataLayer || [];  function gtag(){dataLayer.push(arguments);}  gtag('js', new Date());  gtag('config', 'UA-83731338-2');</script><title>A.3.12  Unloading and Deregistering Drivers</TITLE>
<style>@import url(/msdn_ie4.css);</style>
<link disabled rel="stylesheet" href="/msdn_ie3.css"></HEAD>
<BODY BGPROPERTIES="FIXED" TEXT="#000000" BGCOLOR="#FFFFFF">

<FONT FACE="ARIAL,HELVETICA" SIZE="2">
<H2><A NAME="DDK_A.3.12_Unloading_and_Deregistering_Drivers_NG"></A>A.3.12  Unloading and Deregistering Drivers</H2>
<P>
When the NDIS interface library calls <B><A HREF="../../nr/src/appdxa_24.htm">MacUnload</A></B>,
as Figure A.3.12 shows, the function frees allocated resources and decrements
the reference count in the NIC driver block to zero. <B>MacUnload</B>&nbsp;then
calls <B><A HREF="../../nr/src/appdxa_76.htm">NdisDeregisterMac</A></B>&nbsp;to remove
the NIC driver from the NDIS interface library wrapper connection. <B>MacUnload</B>
passes a network interface card handle to the NIC driver descriptor block and <B><A HREF="../../nr/src/appdxa_76.htm">NdisDeregisterMac</A></B>
sets the driver state to closing to prevent the NIC driver from registering
additional network interface cards. 
<P>
If the NIC driver is the last driver being unloaded and the network is
shutting down, <B>MacUnload</B>&nbsp;makes a final call to <B><A HREF="../../nr/src/103ndisx_209.htm">NdisTerminateWrapper</A></B>
to close the NDIS interface library wrapper. <B>Ndis TerminateWrapper</B>&nbsp;is
also called if, during driver initialization, <B><A HREF="../../nr/src/appdxa_85.htm">NdisInitializeWrapper</A></B>
is successful but <B><A HREF="../../nr/src/appdxa_98.htm">NdisRegisterMac</A></B>
fails to register any network interface cards.
<P>
When transports wish to unload, they call <B><A HREF="../../nr/src/103ndisx_27.htm">NdisDeregisterProtocol</A></B>
to remove themselves from the wrapper connection. For each call, this function
decrements the reference count included in the transport driver block. When
the count reaches zero, the transport driver block is freed. 
<P>
<IMG SRC="../art/215-12.gif" BORDER=0>
<P>
<B>Figure A.3.12  Unloading and deregistering drivers and terminating wrapper </B>
<P>
&nbsp;
<P></FONT>
</BODY>
</HTML>
