<!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML//EN">
<HTML>
<HEAD><META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=Windows-1252">
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-83731338-2"></script><script>  window.dataLayer = window.dataLayer || [];  function gtag(){dataLayer.push(arguments);}  gtag('js', new Date());  gtag('config', 'UA-83731338-2');</script><title>5.5  Making an Endpoint-to-Endpoint Connection</TITLE>
<style>@import url(/msdn_ie4.css);</style>
<link disabled rel="stylesheet" href="/msdn_ie3.css"></HEAD>
<BODY BGPROPERTIES="FIXED" TEXT="#000000" BGCOLOR="#FFFFFF">

<FONT FACE="ARIAL,HELVETICA" SIZE="2">
<H2><A NAME="DDK_Making_an_Endpoint_to_Endpoint_Connection_NG"></A>5.5  Making an Endpoint-to-Endpoint Connection</H2>
<P>
TDI clients on separate nodes of the network and their respective transports
cooperate to establish an endpoint-to-endpoint connection between them. Before
such a connection can be attempted, each client on its own node must do the
following:
<OL>
<LI>
Open a transport address, as already described in <A HREF="305toper_1.htm">Section
5.1</A>.
<P>
<LI>
Open a connection endpoint, as already described in <A HREF="305toper_2.htm">Section
5.2</A>. 
<P>
<LI>
Associate its open connection with the open address by submitting a
TDI_ASSOCIATE_ADDRESS IOCTL request to its underlying transport, as mentioned
in Section 5.2 and described in <A HREF="305toper_3.htm">Section
5.3</A>. 
</OL>
<P>
Then, one of the clients makes a connection offer to the other, while the
other usually listens (passively) for the connection offer to come in. 
<P>
Either client also might have registered its ClientEventConnect handler with
its underlying transport (see <A HREF="305toper_1.htm">Section
5.1</A>). The transport driver calls <A HREF="../../nr/src/25tdicli_1.htm">ClientEventConnect</A>
when any connection offer directed to its client&#39;s open transport address
comes in from a remote node. 
<H3>Requesting a Connection to a Remote Node</H3>
<P>
Figure 5.5 shows how a local-node TDI client initiates a connection offer to a
remote-node peer process.
<P>
<IMG SRC="../art/426-04.gif" BORDER=0>
<P>
<B>Figure 5.5    Requesting a Connection</B>
<P>
The local-node client makes a connection offer to a remote-node peer process
by submitting a <A HREF="../../nr/src/22ioctl_4.htm">TDI_CONNECT</A>&nbsp;request, set up with <B><A HREF="../../nr/src/24bldmac_4.htm">TdiBuildConnect</A></B>,
to its underlying transport. 
<P>
The local-node transport determines the client-specified target remote-node
address from its client’s connect request and transmits the connection offer
to the corresponding remote-node transport. 
<P>
The remote-node transport notifies its client of the incoming connection
offer, either by satisfying a TDI_LISTEN request previously submitted by its
client or by calling the previously registered ClientEventConnect handler. 
<P>
The local-node transport fails the connect IRP if the remote-node client is
not listening or if the remote-node transport does not respond. The
remote-node client can accept or reject the offered connection if both
transports support <I>delayed-connection acceptance</I>, as described next.
<H3>Accepting a Connection Offer from a Remote Node</H3>
<P>
Figure 5.6 shows how a local-node client listens for a connection offer from a
remote-node peer process.
<P>
<IMG SRC="../art/426-05.gif" BORDER=0>
<P>
<B>Figure 5.6    Accepting a Connection (Listen Operation)</B>
<P>
To establish an endpoint-to-endpoint connection, one client makes a connection
offer, and the other indicates to its underlying transport that it is waiting
for a connection offer to occur.
<P>
A local-node client can passively listen for such an incoming connection offer
by submitting a <A HREF="../../nr/src/22ioctl_7.htm">TDI_LISTEN</A>&nbsp;request, set up with <B><A HREF="../../nr/src/24bldmac_8.htm">TdiBuildListen</A></B>,
to its underlying transport. The client can specify the remote-node transport
address from which an acceptable offer can occur when it sets up the listen
IRP. If the transports support delayed-connection acceptances, the client can
direct the transport to either accept an offer from a particular remote-node
address immediately or allow the client to inspect the offer and decide
whether to accept it. 
<P>
When the transport receives a TDI_LISTEN request, it monitors connection
offers coming from remote nodes that are directed to the transport address
opened by the client. When it receives such a connection offer from an
acceptable remote-node address, the transport copies information transmitted
with the offer into a buffer the local-node client supplied with its
TDI_LISTEN request and completes the IRP back to the listening client. 
<P>
If the client directed the transport to accept the incoming connection offer
immediately, completion of the listen request occurs as the transport notifies
the remote-node transport that an endpoint-to-endpoint connection has been
established with the remote-node client. In effect, the local-node client has
made an endpoint-to-endpoint connection with its remote-node peer even before
it &quot;knows&quot; that its listen IRP has been completed, and the
local-node client can receive data on that endpoint-to-endpoint connection at
once. Otherwise, the transport&#39;s completion of the listen request notifies
the local-node client of the offer to connect, and the client either accepts
or rejects the request by issuing <A HREF="../../nr/src/22ioctl_1.htm">TDI_ACCEPT</A>&nbsp;or <A HREF="../../nr/src/22ioctl_6.htm">TDI_DISCONNECT</A>
request, respectively. The local-node client uses <B><A HREF="../../nr/src/24bldmac_1.htm">TdiBuildAccept</A></B>
or <B><A HREF="../../nr/src/24bldmac_6.htm">TdiBuildDisconnect</A></B>&nbsp;to set up the
IRP it submits to its underlying transport for a delayed-connection acceptance
operation. 
<P>
Accepting a connection is even simpler if the local-node client is using event
handling to communicate with the underlying TDI transport driver. When its
transport receives a connection offer from a remote-node client that is
directed to the open transport address of the local-node client, the transport
calls the registered <A HREF="../../nr/src/25tdicli_1.htm">ClientEventConnect</A>
handler of the local-node client, passing in the transport address of the
offering client and any connect data the transport received with the
connection offer. ClientEventConnect then accepts or rejects the connection
offer immediately.
<P></FONT>
</BODY>
</HTML>
