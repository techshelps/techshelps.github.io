<!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML//EN">
<HTML>
<HEAD><META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=Windows-1252">
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-83731338-2"></script><script>  window.dataLayer = window.dataLayer || [];  function gtag(){dataLayer.push(arguments);}  gtag('js', new Date());  gtag('config', 'UA-83731338-2');</script><title>5.12  Closing a Connection Endpoint</TITLE>
<style>@import url(/msdn_ie4.css);</style>
<link disabled rel="stylesheet" href="/msdn_ie3.css"></HEAD>
<BODY BGPROPERTIES="FIXED" TEXT="#000000" BGCOLOR="#FFFFFF">

<FONT FACE="ARIAL,HELVETICA" SIZE="2">
<H2><A NAME="DDK_Closing_a_Connection_Endpoint_NG"></A>5.12  Closing a Connection Endpoint</H2>
<P>
Figure 5.13 shows how a kernel-mode client closes a connection endpoint.
<P>
<IMG SRC="../art/426-11.gif" BORDER=0>
<P>
<B>Figure 5.13    Closing a Local-Node Connection Endpoint</B>
<P>
After an endpoint-to-endpoint connection has been disconnected, as already
described in <A HREF="305toper_11.htm">Section
5.11</A>, a client can close the connection endpoint. 
<P>
When a client no longer has any use for an open connection endpoint, it <I>must</I>
close that connection endpoint as follows:
<UL>
<LI>
Pass the file object pointer returned by <B>ObReferenceObjectByHandle</B>&nbsp;to <B>ObDereferenceObject</B>.
<P>
<LI>
Pass the file handle that was returned by <B>ZwCreateFile</B>&nbsp;when the
connection endpoint was opened to <B>ZwClose</B>. 
</UL>
<P>
Then, the I/O Manager submits IRPs to the transport’s <A HREF="../../nr/src/21tddisp_1.htm">TdiDispatchCleanup</A>
and, subsequently, <A HREF="../../nr/src/21tddisp_2.htm">TdiDispatchClose</A>
routines.
<P>
These transport routines immediately close the connection endpoint and free
all associated transport driver resources. TdiDispatchCleanup also terminates
any active connection involved with the endpoint by sending a disconnect
notification to the corresponding remote-node transport.
<P>
As the preceding sentence implies, it is unnecessary for a TDI client to
disassociate the connection endpoint from its associated transport address
before making a close-connection-endpoint request. If necessary, the
underlying transport driver simulates the effects of a disassociation. 
<P>
However, a client can explicitly disassociate a connection endpoint from an
open transport address before closing the connection endpoint by making a <A HREF="../../nr/src/22ioctl_5.htm">TDI_DISSOCIATE_ADDRESS</A>
request to the transport, set up with <B><A HREF="../../nr/src/24bldmac_5.htm">TdiBuildDisassociateAddress</A></B>.
<P>
For example, a client might make a disassociate-address request and
reassociate the open connection endpoint with another open transport address. 
<P></FONT>
</BODY>
</HTML>
