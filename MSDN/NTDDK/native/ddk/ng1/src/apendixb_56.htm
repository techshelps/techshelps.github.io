<!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML//EN">
<HTML>
<HEAD><META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=Windows-1252">
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-83731338-2"></script><script>  window.dataLayer = window.dataLayer || [];  function gtag(){dataLayer.push(arguments);}  gtag('js', new Date());  gtag('config', 'UA-83731338-2');</script><title>B.10.4  Spin Lock Usage</TITLE>
<style>@import url(/msdn_ie4.css);</style>
<link disabled rel="stylesheet" href="/msdn_ie3.css"></HEAD>
<BODY BGPROPERTIES="FIXED" TEXT="#000000" BGCOLOR="#FFFFFF">

<FONT FACE="ARIAL,HELVETICA" SIZE="2">
<H3><A NAME="DDK_B.10.4_Spin_Lock_Usage_NG"></A>B.10.4  Spin Lock Usage</H3>
<P>
Spin lock usage can be traced using a method similar to the pool-allocation
logging. This facility is useful for finding code that returns without
releasing a lock. A log of recent <B>p_lock</B>&nbsp;and <B>v_lock</B>&nbsp;activity is
kept in the kernel data location <B>StrmLockLogList,</B>&nbsp;a circular buffer.
The log can be dumped using the Windows NT kernel debugger commands:
<PRE><FONT FACE="Courier" SIZE="2">&nbsp; &nbsp; da streams!StrmLockLogList
&nbsp; &nbsp; da
&nbsp; &nbsp; da
&nbsp; &nbsp; ...
&nbsp;</FONT></PRE>
<P>
Spin-lock tracing is not actually part of the <B>strmdbg</B>&nbsp;services. The
“-l” switch displayed by the command line help of <B>strmdbg </B>turns on lock
tracing only for <I>streams.sys </I>and has no effect on transport drivers. To
make use of the spin lock tracing facility, you must include macros similar to
the following in your code:
<PRE><FONT FACE="Courier" SIZE="2">#if DBG
&nbsp;
#define KeAcquireSpinLock(PSpinLock, POldIrql)                 \
&nbsp; &nbsp; ( (TcpDebugBits &amp; DBG_TCP_LOCKTRACE) ?                     \
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;StrmAcquireSpinLock(PSpinLock, POldIrql, __LINE__, __FILE__) \
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;\
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;StrmAcquireSpinLock(PSpinLock, POldIrql, 0, NULL)   \
&nbsp; &nbsp; )
&nbsp;
#define KeReleaseSpinLock(PSpinLock, OldIrql)                  \
&nbsp; &nbsp; ( (TcpDebugBits &amp; DBG_TCP_LOCKTRACE) ?                     \
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;StrmReleaseSpinLock(PSpinLock, OldIrql, __LINE__, __FILE__)  \
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;\
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;StrmReleaseSpinLock(PSpinLock, OldIrql, 0, NULL)    \
&nbsp; &nbsp; )
&nbsp;
#endif
&nbsp;</FONT></PRE>
<P>
The <B>Strm..SpinLock</B>&nbsp;functions export by STREAMS.SYS will log an
operation if their fourth argument is nonNULL.
<P>
&nbsp;
<P></FONT>
</BODY>
</HTML>
