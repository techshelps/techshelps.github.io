<!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML//EN">
<HTML>
<HEAD><META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=Windows-1252">
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-83731338-2"></script><script>  window.dataLayer = window.dataLayer || [];  function gtag(){dataLayer.push(arguments);}  gtag('js', new Date());  gtag('config', 'UA-83731338-2');</script><title>1.2.5  Controlling Driver Load Order</TITLE>
<style>@import url(/msdn_ie4.css);</style>
<link disabled rel="stylesheet" href="/msdn_ie3.css"></HEAD>
<BODY BGPROPERTIES="FIXED" TEXT="#000000" BGCOLOR="#FFFFFF">

<FONT FACE="ARIAL,HELVETICA" SIZE="2">
<H3><A NAME="DDK_Controlling_Driver_Load_Order_PG"></A>1.2.5  Controlling Driver Load Order</H3>
<P>
The first driver to claim a device obtains ownership of that device, either
shared or exclusive.
<P>
Driver load order is determined by entries in the <B>\Machine\System\CurrentControlSet</B>
key in the registry. This key has a <B>Control</B>&nbsp;subkey containing
system-wide information and a <B>Services</B>&nbsp;subkey containing
driver-specific information.
<P>
During system initialization, when a driver is loaded depends on the following
characteristics:
<UL>
<LI>
During which phase does it load (<B>Services\</B><I>DriverName</I><B>\Start</B>
value in the registry)?
<P>
<LI>
During a given phase, in which group does it reside (<B>\Services\</B><I>DriverName</I><B>\Group</B>)
and in what order does its group load (<B>\Control\ServiceGroupOrder</B>)?
<P>
<LI>
Within a given group, in what order does this driver load (<B>\Services\</B><I>DriverName</I><B>\Tag</B>
and <B>\Control\GroupOrderList</B>)?
<P>
<LI>
Does the driver require that any prerequisite drivers or services be loaded (<B>\Services\</B><I>DriverName</I><B>\DependOnGroup</B>
and <B>DependOnService</B>)?
</UL>
<H4>Driver Start Value</H4>
<P>
A driver can have one of the following values in <B>\Machine\System\CurrentControlSet\Services\</B><I>DriverName</I><B>\Start</B>:
<TABLE>
<TR VALIGN=top>
<TD><FONT FACE="ARIAL,HELVETICA" SIZE="2">
<P>
<B>Start Value</B>
</FONT><TD><FONT FACE="ARIAL,HELVETICA" SIZE="2">
<P>
<B>When Started</B>
</FONT><TR VALIGN=top>
<TD><FONT FACE="ARIAL,HELVETICA" SIZE="2">
<P>
SERVICE_BOOT_START (0x0)
</FONT><TD><FONT FACE="ARIAL,HELVETICA" SIZE="2">
<P>
By OS loader (Phase 2)
</FONT><TR VALIGN=top>
<TD><FONT FACE="ARIAL,HELVETICA" SIZE="2">
<P>
SERVICE_SYSTEM_START (0x01)
</FONT><TD><FONT FACE="ARIAL,HELVETICA" SIZE="2">
<P>
During OS initialization (Phase 5)
</FONT><TR VALIGN=top>
<TD><FONT FACE="ARIAL,HELVETICA" SIZE="2">
<P>
SERVICE_AUTO_START (0x02)
</FONT><TD><FONT FACE="ARIAL,HELVETICA" SIZE="2">
<P>
By Service Control Manager during startup (Phase 8)
</FONT><TR VALIGN=top>
<TD><FONT FACE="ARIAL,HELVETICA" SIZE="2">
<P>
SERVICE_DEMAND_START (0x03)
</FONT><TD><FONT FACE="ARIAL,HELVETICA" SIZE="2">
<P>
On demand, by Service Control Manager
</FONT><TR VALIGN=top>
<TD><FONT FACE="ARIAL,HELVETICA" SIZE="2">
<P>
SERVICE_DISABLED (0x04)
</FONT><TD><FONT FACE="ARIAL,HELVETICA" SIZE="2">
<P>
Not started
</FONT></TABLE>
<H4>Driver Load Service Group</H4>
<P>
Drivers with start values of SERVICE_BOOT_START and SERVICE_SYSTEM_START can
be organized into groups to further structure the order in which they are
loaded.
<P>
<B>\Machine\System\CurrentControlSet\Control\ServiceGroupOrder</B>&nbsp;contains a
list of the driver load service groups. The list is scanned twice. First, all
drivers with start value SERVICE_BOOT_START are loaded; then all drivers with
start value SERVICE_SYSTEM_START are loaded.
<DL>
<DT>
The ServiceGroupOrder list looks something like the following:
<DD>
<PRE><FONT FACE="Courier" SIZE="2">System Bus Extender
Scsi miniport
port
Primary disk
SCSI class
SCSI CDROM class
filter
boot file system
Base
Pointer Port
Keyboard Port
Pointer Class
Keyboard Class
Video Init
Video
Video Save
file system
Event log
Streams Drivers
PNP_TDI
NDIS
TDI
NetBIOSGroup
SpoolerGroup
NetDDEGroup
Parallel Arbitrator
extended base
RemoteValidation
PCI Configuration
</FONT></PRE>
</DL>
<P>
If a driver is a member of a load service group, the group name is listed in
the driver’s services subkey in the registry (<B>\Machine\Hardware\System\<BR>
CurrentControlSet\Services\</B><I>DriverName</I><B>\Group</B>).
<P>
After all <B>ServiceGroupOrder</B>&nbsp;groups of a given Start value have been
loaded, the system loads all groups not in the list and then all drivers
without a group.
<H4>Load Order Within a Group</H4>
<P>
Drivers that are in a load group and have a start value of SERVICE_BOOT_START
or SERVICE_SYSTEM_START can use tags to indicate their load order within the
group.
<DL>
<DT>
The services registry entry for the disk class driver looks something like the
following:
<DD>
<PRE><FONT FACE="Courier" SIZE="2">\Machine\Hardware\System\CurrentControlSet\Services\Disk                 
&nbsp; &nbsp; DependOnGroup:REG_MULTI_SZ:SCSI miniport 
&nbsp; &nbsp; ErrorControl:REG_DWORD:0  // = SERVICE_ERROR_IGNORE
&nbsp; &nbsp; Group:REG_SZ:SCSI class 
&nbsp; &nbsp; Start:REG_DWORD:0     // = SERVICE_BOOT_START 
&nbsp; &nbsp; Type:REG_DWORD:0x1    // = SERVICE_KERNEL_DRIVER 
&nbsp; &nbsp; Tag:REG_DWORD:0x2
&nbsp; &nbsp; :
</FONT></PRE>
</DL>
<P>
The disk class driver is in the SCSI class group and its group tag is 2.
<DL>
<DT>
The registry key <B>\Machine\Hardware\System\CurrentControlSet\Control\<BR>
GroupOrderList</B>&nbsp;defines the number of tags in each group and the order in
which tagged drivers are loaded within a group. An excerpt of this key
including the SCSI class group looks something like the following:
<DD>
<PRE><FONT FACE="Courier" SIZE="2">\Machine\Hardware\System\CurrentControlSet\Control\GroupOrderList 
&nbsp; &nbsp; &nbsp; &nbsp; :
&nbsp; &nbsp; SCSI CDROM Class:REG_BINARY:02 00 00 00 01 00 00 00 02 00 00 00
&nbsp; &nbsp; SCSI Class:REG_BINARY:03 00 00 00 01 00 00 00 02 00 00 00 03...
&nbsp; &nbsp; SCSI miniport:REG_BINARY:24 00 00 00 00 01 00 00 01 ...
&nbsp; &nbsp; &nbsp; &nbsp; :
</FONT></PRE>
</DL>
<P>
Within the SCSI class group, drivers with tag 1 are loaded first, then drivers
with tag 2, and then drivers with tag 3. Drivers without a tag are loaded last
in their group.
<P>
Not every group is included in the <B>GroupOrderList</B>. When a group is not
in the <B>GroupOrderList</B>, the order in which the drivers load within the
group cannot be guaranteed.
<H4>Dependencies</H4>
<P>
Prerequisite drivers are listed in a driver’s services subkey in the <B>DependOnGroup</B>
and <B>DependOnService </B>entries. The services subkey for the disk class
driver shown above indicates that this driver cannot be loaded until at least
one driver from the SCSI miniport group has been loaded.
<H4>Defining Driver Load Order for New Drivers</H4>
<P>
To define the load order for a new driver, assign the driver a start value, a
service group (optional), a group tag (optional), and prerequisite drivers
(optional).
<P>
The start value must be one of the system-defined SERVICE_xxx values.
<P>
The service group can be an existing system-defined group or a new group. If
you define a new group, add it to <B>\Machine\System\CurrentControlSet<BR>
\Control\ServiceGroupOrder</B>. Note that <B>ServiceGroupOrder</B>&nbsp;is reset
during a system upgrade, so drivers that modify this registry key may need to
be reinstalled after an upgrade.
<P>
Use an existing group tag, or define a new one in <B>\Machine\System<BR>
\CurrentControlSet\Control\GroupOrderList</B>.
<P>
List prerequisite drivers in <B>DependOnGroup</B>&nbsp;and <B>DependOnService</B>
in the driver’s services key.
<P>
A driver writer can modify the registry using routines, INF files, or the
Windows NT registry editor (<B>regedt32</B>). During driver development it may
be convenient to edit the registry manually with the registry editor. When the
driver is nearing completion, it is best for the driver to make any necessary
registry changes using routines (<B>RtlCreateRegistryKey</B>&nbsp;and <B>RtlWriteRegistryValue</B>)
or through the driver’s INF file. For more information on runtime library
routines, see the <I>Kernel-Mode Driver Reference</I>. For more information on
INF files, see Chapter 2. 
<P>
&nbsp;
<P></FONT>
</BODY>
</HTML>
