<!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML//EN">
<HTML>
<HEAD><META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=Windows-1252">
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-83731338-2"></script><script>  window.dataLayer = window.dataLayer || [];  function gtag(){dataLayer.push(arguments);}  gtag('js', new Date());  gtag('config', 'UA-83731338-2');</script><title>HalAllocateCommonBuffer</TITLE>
<style>@import url(/msdn_ie4.css);</style>
<link disabled rel="stylesheet" href="/msdn_ie3.css"></HEAD>
<BODY BGPROPERTIES="FIXED" TEXT="#000000" BGCOLOR="#FFFFFF">

<FONT FACE="ARIAL,HELVETICA" SIZE="2">
<H2><A NAME="DDK_HalAllocateCommonBuffer_KR"></A>HalAllocateCommonBuffer</H2>
<P>
<B>PVOID <BR>
&nbsp; &nbsp; HalAllocateCommonBuffer(</B><BR>
&nbsp; &nbsp; &nbsp; &nbsp; <B>IN PADAPTER_OBJECT</B>&nbsp; <I>AdapterObject</I><B>,<BR>
</B>&nbsp; &nbsp; &nbsp; &nbsp; <B>IN ULONG</B>&nbsp; <I>Length</I><B>,<BR>
</B>&nbsp; &nbsp; &nbsp; &nbsp; <B>OUT PPHYSICAL_ADDRESS</B>&nbsp; <I>LogicalAddress</I><B>,<BR>
</B>&nbsp; &nbsp; &nbsp; &nbsp; <B>IN BOOLEAN</B>&nbsp; <I>CacheEnabled</I><BR>
&nbsp; &nbsp; &nbsp; &nbsp; <B>);</B>
<P>
<B>HalAllocateCommonBuffer</B>&nbsp;allocates memory and maps it so that it is
simultaneously accessible from both the processor and a device for DMA
operations.
<H3>Parameters</H3>
<DL>
<DT>
<I>AdapterObject</I>
<DD>
Points to the adapter object representing the busmaster adapter or DMA
controller channel. This pointer was returned by <B>HalGetAdapter</B>.
<BR>
<DT>
<I>Length</I>
<DD>
Specifies the number of bytes to allocate.
<BR>
<DT>
<I>LogicalAddress</I>
<DD>
Points to a variable that receives the logical address the device can use to
access the allocated buffer. Use this address rather than calling <B>MmGetPhysicalAddress</B>
because the HAL can take into account any platform-specific memory
restrictions.
<BR>
<DT>
<I>CacheEnabled</I>
<DD>
Specifies whether the allocated memory can be cached.
</DL>
<H3>Return Value</H3>
<P>
<B>HalAllocateCommonBuffer</B>&nbsp;returns the base virtual address of the
allocated range. If the buffer cannot be allocated, it returns NULL.
<H3>Comments</H3>
<P>
<B>HalAllocateCommonBuffer</B>&nbsp;supports DMA in which the device and the
processor are continuously communicating through system memory, as in a
control structure for a busmaster DMA device.
<P>
<B>HalAllocateCommonBuffer</B>&nbsp;also supports slave devices whose drivers use a
system DMA controller’s autoinitialize mode.
<P>
<B>HalAllocateCommonBuffer</B>&nbsp;does the following:
<UL>
<LI>
Allocates memory that can be reached from both the processor and the device.
This memory appears contiguous to the device.
<P>
<LI>
Allocates map registers to map the buffer, if required by the system.
<P>
<LI>
Sets up a translation for the device, including loading map registers if
necessary.
</UL>
<P>
To use resident system memory economically, drivers should allocate as few of
these buffers per device as possible. <B>HalAllocateCommonBuffer</B>&nbsp;allocates
at least a page of memory, whatever the requested <I>Length</I>. For
successful allocations requesting less than PAGE_SIZE, only the given <I>Length</I>
can be accessed by the caller. For successful allocations requesting more than
an integral multiple of PAGE_SIZE, any remaining bytes on the last allocated
page are inaccessible to the caller.
<P>
If a driver needs several pages of common buffer space, but the pages need not
be contiguous, the driver should make several one-page requests to <B>HalAllocateCommonBuffer</B>
rather than one large request. This approach conserves contiguous memory.
<P>
Drivers typically call <B>HalAllocateCommonBuffer</B>&nbsp;during driver
initialization. After initialization, it is possible that only one-page
requests will succeed, if any.
<P>
Callers of <B>HalAllocateCommonBuffer</B>&nbsp;are typically running at IRQL
PASSIVE_LEVEL. When called from IRQL_PASSIVE_LEVEL, <B>HalAllocateCommonBuffer</B>
makes several attempts to locate the requested memory. <B>HalAllocateCommonBuffer</B>
can be called from IRQL_DISPATCH_LEVEL, but less effort is made to locate the
requested memory, and it is possible that only one-page requests will succeed,
if any.
<H3>See Also</H3>
<P>
<B><A HREF="k103_4.htm">HalFreeCommonBuffer</A></B>, <B><A HREF="k103_5.htm">HalGetAdapter</A></B>
<P></FONT>
</BODY>
</HTML>
