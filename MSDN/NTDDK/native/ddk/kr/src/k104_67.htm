<!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML//EN">
<HTML>
<HEAD><META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=Windows-1252">
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-83731338-2"></script><script>  window.dataLayer = window.dataLayer || [];  function gtag(){dataLayer.push(arguments);}  gtag('js', new Date());  gtag('config', 'UA-83731338-2');</script><title>IoSetCancelRoutine</TITLE>
<style>@import url(/msdn_ie4.css);</style>
<link disabled rel="stylesheet" href="/msdn_ie3.css"></HEAD>
<BODY BGPROPERTIES="FIXED" TEXT="#000000" BGCOLOR="#FFFFFF">

<FONT FACE="ARIAL,HELVETICA" SIZE="2">
<H2><A NAME="DDK_IoSetCancelRoutine_KR"></A>IoSetCancelRoutine</H2>
<P>
<B>PDRIVER_CANCEL <BR>
&nbsp; &nbsp; IoSetCancelRoutine(</B><BR>
&nbsp; &nbsp; &nbsp; &nbsp; <B>IN PIRP</B>&nbsp; <I>Irp</I><B>,<BR>
</B>&nbsp; &nbsp; &nbsp; &nbsp; <B>IN PDRIVER_CANCEL</B>&nbsp; <I>CancelRoutine</I><BR>
&nbsp; &nbsp; &nbsp; &nbsp; <B>);</B>
<P>
<B>IoSetCancelRoutine</B>&nbsp;sets up a driver-supplied Cancel routine to be
called if a given IRP is canceled. This routine can disable the Cancel routine
currently set in an IRP.
<H3>Parameters</H3>
<DL>
<DT>
<I>Irp</I>
<DD>
Points to the IRP being put into or removed from a cancelable state.
<BR>
<DT>
<I>CancelRoutine</I>
<DD>
Specifies the entry point of the caller-supplied Cancel routine to be called
if the specified IRP is canceled or is NULL if the given IRP is being removed
from the cancelable state. This routine is declared as follows:
<PRE><FONT FACE="Courier" SIZE="2">VOID
(*PDRIVER_CANCEL)(
&nbsp; &nbsp; IN PDEVICE_OBJECT DeviceObject,
&nbsp; &nbsp; IN PIRP Irp
&nbsp; &nbsp; );
</FONT></PRE>
</DL>
<H3>Return Value</H3>
<P>
<B>IoSetCancelRoutine</B>&nbsp;returns the previous value of <B>Irp</B>-&gt;<B>CancelRoutine</B>.
<H3>Comments</H3>
<P>
A driver must hold the system cancel spin lock when calling this routine if
the driver uses the I/O-manager-supplied device queue in the device object.
The driver executes at IRQL DISPATCH_LEVEL after calling <B>IoAcquireCancelSpinLock</B>
until it releases the cancel spin lock with <B>IoReleaseCancelSpinLock</B>. 
<P>
If the driver manages its own queue(s) of IRPs, then the driver need not hold
the cancel spin lock when calling this routine. <B>IoSetCancelSpinLock</B>
uses an interlocked exchange intrinsic to set the address of the Cancel
routine as an atomic operation. Reduced usage of the cancel spin lock can
improve driver performance and overall system performance.
<P>
Driver Cancel routines are called at IRQL DISPATCH_LEVEL with the cancel spin
lock held. The Cancel routine must release the cancel spin lock before it
returns control.
<H3>See Also</H3>
<P>
<B><A HREF="k104_1.htm">IoAcquireCancelSpinLock</A></B>, <B><A HREF="k104_63.htm">IoReleaseCancelSpinLock</A></B>
<P></FONT>
</BODY>
</HTML>
