<!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML//EN">
<HTML>
<HEAD><META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=Windows-1252">
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-83731338-2"></script><script>  window.dataLayer = window.dataLayer || [];  function gtag(){dataLayer.push(arguments);}  gtag('js', new Date());  gtag('config', 'UA-83731338-2');</script><title>IoAllocateAdapterChannel</TITLE>
<style>@import url(/msdn_ie4.css);</style>
<link disabled rel="stylesheet" href="/msdn_ie3.css"></HEAD>
<BODY BGPROPERTIES="FIXED" TEXT="#000000" BGCOLOR="#FFFFFF">

<FONT FACE="ARIAL,HELVETICA" SIZE="2">
<H2><A NAME="DDK_IoAllocateAdapterChannel_KR"></A>IoAllocateAdapterChannel</H2>
<P>
<B>NTSTATUS <BR>
&nbsp; &nbsp; IoAllocateAdapterChannel(</B><BR>
&nbsp; &nbsp; &nbsp; &nbsp; <B>IN PADAPTER_OBJECT</B>&nbsp; <I>AdapterObject</I><B>,<BR>
</B>&nbsp; &nbsp; &nbsp; &nbsp; <B>IN PDEVICE_OBJECT</B>&nbsp; <I>DeviceObject</I><B>,<BR>
</B>&nbsp; &nbsp; &nbsp; &nbsp; <B>IN ULONG</B>&nbsp; <I>NumberOfMapRegisters</I><B>,<BR>
</B>&nbsp; &nbsp; &nbsp; &nbsp; <B>IN PDRIVER_CONTROL</B>&nbsp; <I>ExecutionRoutine</I><B>,<BR>
</B>&nbsp; &nbsp; &nbsp; &nbsp; <B>IN PVOID</B>&nbsp; <I>Context</I><BR>
&nbsp; &nbsp; &nbsp; &nbsp; <B>);</B>
<P>
<B>IoAllocateAdapterChannel</B>&nbsp;allocates an adapter object for a DMA
operation on the target device object and calls a driver-supplied routine to
carry out an I/O operation through the system DMA controller or a busmaster
adapter as soon as the appropriate DMA channel is available and/or any
necessary map registers are available.
<H3>Parameters</H3>
<DL>
<DT>
<I>AdapterObject</I>
<DD>
Points to an adapter object, representing the adapter channel or busmaster
adapter to be allocated. The driver obtained this pointer by calling <B>HalGetAdapter</B>.
<BR>
<DT>
<I>DeviceObject</I>
<DD>
Points to the device object, representing the target device for a requested
DMA operation.
<BR>
<DT>
<I>NumberOfMapRegisters</I>
<DD>
Specifies the number of map registers. This value is the lesser of (the number
of map registers needed to satisfy the current transfer request) or (the
number of available map registers returned when the driver called <B>HalGetAdapter</B>).
<BR>
<DT>
<I>ExecutionRoutine</I>
<DD>
Points to a driver-supplied AdapterControl routine to be called as soon the
system DMA controller or busmaster adapter is available. This routine is
declared as follows:
<PRE><FONT FACE="Courier" SIZE="2">IO_ALLOCATION_ACTION
(*PDRIVER_CONTROL)(
&nbsp; &nbsp; IN PDEVICE_OBJECT DeviceObject,
&nbsp; &nbsp; IN PIRP Irp,
&nbsp; &nbsp; IN PVOID MapRegisterBase,
&nbsp; &nbsp; IN PVOID Context
&nbsp; &nbsp; );
</FONT></PRE>
<DT>
<I>Context</I>
<DD>
Points to the driver-determined context passed to the driver’s AdapterControl
routine when it is called.
</DL>
<H3>Return Value</H3>
<P>
This routine can return one of the following NTSTATUS values: 
<TABLE>
<TR VALIGN=top>
<TD><FONT FACE="ARIAL,HELVETICA" SIZE="2">
<P>
<B>Value</B>
</FONT><TD><FONT FACE="ARIAL,HELVETICA" SIZE="2">
<P>
<B>Meaning</B>
</FONT><TR VALIGN=top>
<TD><FONT FACE="ARIAL,HELVETICA" SIZE="2">
<P>
STATUS_SUCCESS
</FONT><TD><FONT FACE="ARIAL,HELVETICA" SIZE="2">
<P>
The adapter object has been allocated.
</FONT><TR VALIGN=top>
<TD><FONT FACE="ARIAL,HELVETICA" SIZE="2">
<P>
STATUS_INSUFFICIENT_RESOURCES
</FONT><TD><FONT FACE="ARIAL,HELVETICA" SIZE="2">
<P>
The <I>NumberOfMapRegisters</I>&nbsp;is larger than the value returned by <B>HalGetAdapter</B>.
</FONT></TABLE>
<H3>Comments</H3>
<P>
This routine reserves exclusive access to a DMA controller channel and/or map
registers for the one or more DMA operations required to satisfy the current
IRP’s transfer request for the specified device.
<P>
If the system DMA controller or busmaster adapter is already busy, the
driver-supplied AdapterControl routine is queued. Otherwise, the driver
supplied AdapterControl routine is called immediately.
<P>
<B>IoAllocateAdapterChannel</B>&nbsp;passes an <I>Irp</I>&nbsp;to the caller’s
AdapterControl routine only if this routine is called from the StartIo routine
to process the same IRP passed in to the StartIo routine. Otherwise, the <I>Irp</I>
has no meaning, and a driver should consider the <I>Irp</I>&nbsp;a system-reserved
parameter to its AdaperControl routine.
<P>
The return value of the AdapterControl routine depends on whether the device
is a busmaster or uses system DMA. Drivers of busmaster devices return <B>DeallocateObjectKeepRegisters</B>;
drivers of slave devices return <B>KeepObject</B>.
<P>
Callers of <B>IoAllocateAdapterChannel</B>&nbsp;must be running at IRQL
DISPATCH_LEVEL.
<H3>See Also</H3>
<P>
<B><A HREF="k103_5.htm">HalGetAdapter</A></B>, <B><A HREF="k103_11.htm">HalReadDmaCounter</A></B>,
<B><A HREF="k104_33.htm">IoFlushAdapterBuffers</A></B>, <B><A HREF="k104_34.htm">IoFreeAdapterChannel</A></B>,
<B><A HREF="k104_37.htm">IoFreeMapRegisters</A></B>, <B><A HREF="k104_55.htm">IoMapTransfer</A></B>,
<B><A HREF="k105_10.htm">KeFlushIoBuffers</A></B>&nbsp;
<P></FONT>
</BODY>
</HTML>
