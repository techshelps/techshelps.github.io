<!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML//EN">
<HTML>
<HEAD><META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=Windows-1252">
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-83731338-2"></script><script>  window.dataLayer = window.dataLayer || [];  function gtag(){dataLayer.push(arguments);}  gtag('js', new Date());  gtag('config', 'UA-83731338-2');</script><title>RtlQueryRegistryValues</TITLE>
<style>@import url(/msdn_ie4.css);</style>
<link disabled rel="stylesheet" href="/msdn_ie3.css"></HEAD>
<BODY BGPROPERTIES="FIXED" TEXT="#000000" BGCOLOR="#FFFFFF">

<FONT FACE="ARIAL,HELVETICA" SIZE="2">
<H2><A NAME="DDK_RtlQueryRegistryValues_KR"></A>RtlQueryRegistryValues</H2>
<P>
<B>NTSTATUS <BR>
&nbsp; &nbsp; RtlQueryRegistryValues(</B><BR>
&nbsp; &nbsp; &nbsp; &nbsp; <B>IN ULONG</B>&nbsp; <I>RelativeTo</I><B>,<BR>
</B>&nbsp; &nbsp; &nbsp; &nbsp; <B>IN PWSTR</B>&nbsp; <I>Path</I><B>,<BR>
</B>&nbsp; &nbsp; &nbsp; &nbsp; <B>IN PRTL_QUERY_REGISTRY_TABLE</B>&nbsp; <I>QueryTable</I><B>,<BR>
</B>&nbsp; &nbsp; &nbsp; &nbsp; <B>IN PVOID</B>&nbsp; <I>Context</I><B>,<BR>
</B>&nbsp; &nbsp; &nbsp; &nbsp; <B>IN PVOID</B>&nbsp; <I>Environment</I>&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* optional */<BR>
&nbsp; &nbsp; &nbsp; &nbsp; <B>);</B>
<P>
<B>RtlQueryRegistryValues</B>&nbsp;allows the caller to query several values from
the registry subtree with a single call.
<H3>Parameters</H3>
<DL>
<DT>
<I>RelativeTo</I>
<DD>
Specifies whether <I>Path</I>&nbsp;is an absolute registry path or is relative to a
predefined path as one of the following:
<TABLE>
<TR VALIGN=top>
<TD><FONT FACE="ARIAL,HELVETICA" SIZE="2">
<P>
<B>Value</B>
</FONT><TD><FONT FACE="ARIAL,HELVETICA" SIZE="2">
<P>
<B>Meaning</B>
</FONT><TR VALIGN=top>
<TD><FONT FACE="ARIAL,HELVETICA" SIZE="2">
<P>
RTL_REGISTRY_ABSOLUTE
</FONT><TD><FONT FACE="ARIAL,HELVETICA" SIZE="2">
</FONT><TR VALIGN=top>
<TD><FONT FACE="ARIAL,HELVETICA" SIZE="2">
</FONT><TD><FONT FACE="ARIAL,HELVETICA" SIZE="2">
<P>
Path is an absolute registry path.
</FONT><TR VALIGN=top>
<TD><FONT FACE="ARIAL,HELVETICA" SIZE="2">
<P>
RTL_REGISTRY_SERVICES
</FONT><TD><FONT FACE="ARIAL,HELVETICA" SIZE="2">
</FONT><TR VALIGN=top>
<TD><FONT FACE="ARIAL,HELVETICA" SIZE="2">
</FONT><TD><FONT FACE="ARIAL,HELVETICA" SIZE="2">
<P>
Path is relative to <B>\Registry\Machine\System\CurrentControlSet\Services</B>.
</FONT><TR VALIGN=top>
<TD><FONT FACE="ARIAL,HELVETICA" SIZE="2">
<P>
RTL_REGISTRY_CONTROL
</FONT><TD><FONT FACE="ARIAL,HELVETICA" SIZE="2">
</FONT><TR VALIGN=top>
<TD><FONT FACE="ARIAL,HELVETICA" SIZE="2">
</FONT><TD><FONT FACE="ARIAL,HELVETICA" SIZE="2">
<P>
Path is relative to <B>\Registry\Machine\System\CurrentControlSet\Control</B>.
</FONT><TR VALIGN=top>
<TD><FONT FACE="ARIAL,HELVETICA" SIZE="2">
<P>
RTL_REGISTRY_WINDOWS_NT
</FONT><TD><FONT FACE="ARIAL,HELVETICA" SIZE="2">
</FONT><TR VALIGN=top>
<TD><FONT FACE="ARIAL,HELVETICA" SIZE="2">
</FONT><TD><FONT FACE="ARIAL,HELVETICA" SIZE="2">
<P>
Path is relative to <B>\Registry\Machine\Software\Microsoft\<BR>
Windows NT\CurrentVersion</B>.
</FONT><TR VALIGN=top>
<TD><FONT FACE="ARIAL,HELVETICA" SIZE="2">
<P>
RTL_REGISTRY_DEVICEMAP
</FONT><TD><FONT FACE="ARIAL,HELVETICA" SIZE="2">
</FONT><TR VALIGN=top>
<TD><FONT FACE="ARIAL,HELVETICA" SIZE="2">
</FONT><TD><FONT FACE="ARIAL,HELVETICA" SIZE="2">
<P>
Path is relative to <B>\Registry\Machine\Hardware\DeviceMap</B>.
</FONT><TR VALIGN=top>
<TD><FONT FACE="ARIAL,HELVETICA" SIZE="2">
<P>
RTL_REGISTRY_USER
</FONT><TD><FONT FACE="ARIAL,HELVETICA" SIZE="2">
</FONT><TR VALIGN=top>
<TD><FONT FACE="ARIAL,HELVETICA" SIZE="2">
</FONT><TD><FONT FACE="ARIAL,HELVETICA" SIZE="2">
<P>
Path is relative to <B>\Registry\User\CurrentUser</B>.
</FONT><TR VALIGN=top>
<TD><FONT FACE="ARIAL,HELVETICA" SIZE="2">
<P>
RTL_REGISTRY_OPTIONAL
</FONT><TD><FONT FACE="ARIAL,HELVETICA" SIZE="2">
</FONT><TR VALIGN=top>
<TD><FONT FACE="ARIAL,HELVETICA" SIZE="2">
</FONT><TD><FONT FACE="ARIAL,HELVETICA" SIZE="2">
<P>
Specifies that the key referenced by this parameter and the <I>Path</I>
parameter are optional.
</FONT><TR VALIGN=top>
<TD><FONT FACE="ARIAL,HELVETICA" SIZE="2">
<P>
RTL_REGISTRY_HANDLE
</FONT><TD><FONT FACE="ARIAL,HELVETICA" SIZE="2">
</FONT><TR VALIGN=top>
<TD><FONT FACE="ARIAL,HELVETICA" SIZE="2">
<P>
&nbsp;
</FONT><TD><FONT FACE="ARIAL,HELVETICA" SIZE="2">
<P>
Specifies that the <I>Path</I>&nbsp;parameter is actually a registry handle to use.
This value is optional.
</FONT></TABLE>
<DT>
<I>Path</I>
<DD>
Points to either an absolute registry path or a path relative to the known
location specified by the <I>RelativeTo</I>&nbsp;parameter. Note that the names of
keys in such a path must be known to the caller, including the last key in the
path. If the RTL_REGISTRY_HANDLE flag is specified, this parameter is a
registry handle for an already opened key to be queried directly.
<BR>
<DT>
<I>QueryTable</I>
<DD>
Points to a table of one or more value names and subkey names in which the
caller is interested. Each table entry contains a caller-supplied <B>QueryRoutine</B>
that will be called for each value name that exists in the registry. The table
must be terminated with a NULL table entry, which is a table entry with a NULL
<B>QueryRoutine</B>&nbsp;and a NULL <B>Name</B>&nbsp;field. The <I>QueryTable</I>
structure is defined as follows:
<PRE><FONT FACE="Courier" SIZE="2">typedef struct _RTL_QUERY_REGISTRY_TABLE {
&nbsp; &nbsp; PRTL_QUERY_REGISTRY_ROUTINE QueryRoutine;
&nbsp; &nbsp; ULONG Flags;
&nbsp; &nbsp; PWSTR Name;
&nbsp; &nbsp; PVOID EntryContext;
&nbsp; &nbsp; ULONG DefaultType;
&nbsp; &nbsp; PVOID DefaultData;
&nbsp; &nbsp; ULONG DefaultLength;
} RTL_QUERY_REGISTRY_TABLE, *PRTL_QUERY_REGISTRY_TABLE;
</FONT></PRE>
<P>
This routine is called with the name, type, data, and data length of a
registry value. If this field is NULL, it marks the end of the table.
<P>
A caller-supplied <B>QueryRoutine</B>&nbsp;is declared as follows:
<PRE><FONT FACE="Courier" SIZE="2">NTSTATUS
(*PRTL_QUERY_REGISTRY_ROUTINE)(
&nbsp; &nbsp; IN PWSTR ValueName,
&nbsp; &nbsp; IN ULONG ValueType,
&nbsp; &nbsp; IN PVOID ValueData,
&nbsp; &nbsp; IN ULONG ValueLength,
&nbsp; &nbsp; IN PVOID Context,
&nbsp; &nbsp; IN PVOID EntryContext
&nbsp; &nbsp; );
</FONT></PRE>
<P>
The remaining members of the <I>QueryTable</I>&nbsp;structure include the
following.
<BR>
<DT>
<B>Flags</B>
<DD>
Control how the remaining fields are to be interpreted, as follows:
<TABLE>
<TR VALIGN=top>
<TD><FONT FACE="ARIAL,HELVETICA" SIZE="2">
<P>
<B>Value</B>
</FONT><TD><FONT FACE="ARIAL,HELVETICA" SIZE="2">
<P>
<B>Meaning</B>
</FONT><TR VALIGN=top>
<TD><FONT FACE="ARIAL,HELVETICA" SIZE="2">
<P>
RTL_QUERY_REGISTRY_SUBKEY
</FONT><TD><FONT FACE="ARIAL,HELVETICA" SIZE="2">
</FONT><TR VALIGN=top>
<TD><FONT FACE="ARIAL,HELVETICA" SIZE="2">
</FONT><TD><FONT FACE="ARIAL,HELVETICA" SIZE="2">
<P>
The <B>Name</B>&nbsp;of this table entry is another path to a registry key, and all
following table entries are for that key rather than the key specified by the <I>Path</I>
parameter. This change in focus lasts until the end of the table or until
another RTL_REGISTRY_SUBKEY or RTL_QUERY_REGISTRY_TOPKEY entry is seen. Each
such entry must specify a path that is relative to the <I>Path</I>&nbsp;specified
in the call to <B>RtlQueryRegistryValues</B>.
</FONT><TR VALIGN=top>
<TD><FONT FACE="ARIAL,HELVETICA" SIZE="2">
<P>
RTL_QUERY_REGISTRY_TOPKEY
</FONT><TD><FONT FACE="ARIAL,HELVETICA" SIZE="2">
</FONT><TR VALIGN=top>
<TD><FONT FACE="ARIAL,HELVETICA" SIZE="2">
</FONT><TD><FONT FACE="ARIAL,HELVETICA" SIZE="2">
<P>
Resets the current registry key handle to the original one specified by the <I>RelativeTo</I>
and <I>Path</I>&nbsp;parameters. This is useful for getting back to the original
node after descending into subkeys with the RTL_QUERY_REGISTRY SUBKEY flag.
</FONT><TR VALIGN=top>
<TD><FONT FACE="ARIAL,HELVETICA" SIZE="2">
<P>
RTL_QUERY_REGISTRY_REQUIRED
</FONT><TD><FONT FACE="ARIAL,HELVETICA" SIZE="2">
</FONT><TR VALIGN=top>
<TD><FONT FACE="ARIAL,HELVETICA" SIZE="2">
</FONT><TD><FONT FACE="ARIAL,HELVETICA" SIZE="2">
<P>
Specifies that this value is required and, if it is not found,
STATUS_OBJECT_NAME_NOT_FOUND is returned. This is used for a table entry that
specifies a NULL <B>Name</B>&nbsp;so that <B>RtlQueryRegistryValues</B>&nbsp;will
enumerate all of the value names under a key and return
STATUS_OBJECT_NAME_NOT_FOUND only if there are no value keys under the current
key.
</FONT><TR VALIGN=top>
<TD><FONT FACE="ARIAL,HELVETICA" SIZE="2">
<P>
RTL_QUERY_REGISTRY_NOVALUE
</FONT><TD><FONT FACE="ARIAL,HELVETICA" SIZE="2">
</FONT><TR VALIGN=top>
<TD><FONT FACE="ARIAL,HELVETICA" SIZE="2">
</FONT><TD><FONT FACE="ARIAL,HELVETICA" SIZE="2">
<P>
Specifies that even though there is no <B>Name</B>&nbsp;for this table entry, all
the caller wants is a callback: that is, the caller does <I>not</I>&nbsp;want to
enumerate all the values under the current key. The <B>QueryRoutine</B>&nbsp;is
called with NULL for <I>ValueData</I>, REG_NONE for <I>ValueType</I>, and zero
for <I>ValueLength</I>.
</FONT><TR VALIGN=top>
<TD><FONT FACE="ARIAL,HELVETICA" SIZE="2">
<P>
RTL_QUERY_REGISTRY_NOEXPAND
</FONT><TD><FONT FACE="ARIAL,HELVETICA" SIZE="2">
</FONT><TR VALIGN=top>
<TD><FONT FACE="ARIAL,HELVETICA" SIZE="2">
</FONT><TD><FONT FACE="ARIAL,HELVETICA" SIZE="2">
<P>
Specifies that, if the type of this registry value is REG_EXPAND_SZ or
REG_MULTI_SZ, <B>RtlQueryRegistryValues</B>&nbsp;is <I>not</I>&nbsp;to do any
preprocessing of these registry values before calling the <B>QueryRoutine</B>.
By default, <B>RtlQueryRegistryValues</B>&nbsp;expands environment variable
references into REG_EXPAND_SZ values, enumerates each zero-terminated string
in a REG_MULTI_SZ value, and calls the <B>QueryRoutine</B>&nbsp;once with each,
making it look like there is more than one REG_SZ value with the same <I>ValueName</I>.
</FONT><TR VALIGN=top>
<TD><FONT FACE="ARIAL,HELVETICA" SIZE="2">
<P>
RTL_QUERY_REGISTRY_DIRECT
</FONT><TD><FONT FACE="ARIAL,HELVETICA" SIZE="2">
</FONT><TR VALIGN=top>
<TD><FONT FACE="ARIAL,HELVETICA" SIZE="2">
</FONT><TD><FONT FACE="ARIAL,HELVETICA" SIZE="2">
<P>
The <B>QueryRoutine</B>&nbsp;is ignored, and the <B>EntryContext</B>&nbsp;points to the
location to store the value. For zero-terminated strings, <B>EntryContext</B>
points to a UNICODE_STRING structure that describes the maximum size of the
buffer. If the <B>Buffer</B>&nbsp;is NULL, a buffer is allocated.
</FONT><TR VALIGN=top>
<TD><FONT FACE="ARIAL,HELVETICA" SIZE="2">
<P>
RTL_QUERY_REGISTRY_DELETE
</FONT><TD><FONT FACE="ARIAL,HELVETICA" SIZE="2">
</FONT><TR VALIGN=top>
<TD><FONT FACE="ARIAL,HELVETICA" SIZE="2">
</FONT><TD><FONT FACE="ARIAL,HELVETICA" SIZE="2">
<P>
This is used to delete value keys after they have been queried.
</FONT></TABLE>
<DT>
<B>Name</B>
<DD>
This is the name of a Value that the caller queried. If <B>Name</B>&nbsp;is NULL,
the <B>QueryRoutine</B>&nbsp;specified for this table entry is called for all
values associated with the current registry key.
<BR>
<DT>
<B>EntryContext</B>
<DD>
This is an arbitrary 32-bit field that is passed uninterpreted each time the <B>QueryRoutine</B>
is called.
<BR>
<DT>
<B>DefaultType</B>
<DD>
Specifies the REG_<I>xxx</I>&nbsp;type of the data to be queried if <B>Flags</B>&nbsp;is
not set with RTL_REGISTRY_REQUIRED; otherwise, zero.
<BR>
<DT>
<B>DefaultData</B>
<DD>
Points to default value(s) for a named value entry of the <B>DefaultType</B>
if it is not already in the registry under <B>Name</B>&nbsp;and if <B>Flags</B>&nbsp;is
not set with RTL_REGISTRY_REQUIRED; otherwise, NULL.
<BR>
<DT>
<B>DefaultLength</B>
<DD>
If there is no value name that matches the name given by the <B>Name</B>, and
the <B>DefaultType</B>&nbsp;field is not REG_NONE, the <B>QueryRoutine</B>&nbsp;for this
table entry is called with the contents of the following fields as if the
value had been found in the registry. If the <B>DefaultType</B>&nbsp;is REG_SZ,
REG_EXPANDSZ, or REG_MULTI_SZ and the <B>DefaultLength</B>&nbsp;is zero, the value
of <B>DefaultLength</B>&nbsp;will be computed based on the length of the Unicode
string pointed to by <B>DefaultData</B>.
<BR>
<DT>
<I>Context</I>
<DD>
Points to a context that is passed, uninterpreted, when each <B>QueryRoutine</B>
is called.
<BR>
<DT>
<I>Environment</I>
<DD>
Points to the environment used when expanding variable values in REG_EXPAND_SZ
registry values, or a NULL pointer (optional).
</DL>
<H3>Return Value</H3>
<P>
<B>RtlQueryRegistryValues</B>&nbsp;returns STATUS_SUCCESS if the entire <I>QueryTable</I>
was processed successfully. If an error occurs, <B>RtlQueryRegistryValues</B>
returns an error status such as:
<P>
STATUS_INVALID_PARAMETER<BR>
STATUS_OBJECT_NAME_NOT_FOUND<BR>
STATUS_<I>XXX</I>&nbsp;(an error status from a user-supplied <B>QueryRoutine</B>)
<H3>Comments</H3>
<P>
The caller specifies an initial key path and a table. The table contains one
or more entries that describe the key values and subkey names in which the
caller is interested. <B>RtlQueryRegistryValues</B>&nbsp;starts at the initial key
and enumerates the entries in the table.
<P>
For each entry specifying a value name or subkey name that exists in the
registry, <B>RtlQueryRegistryValues </B>calls the <B>QueryRoutine</B>
associated with each table entry. Each entry’s caller-supplied <B>QueryRoutine</B>
is passed the value name, type, data, and data length.
<P>
When building the <I>QueryTable</I>, be sure to allocate an entry for each
value being queried, plus a NULL entry at the end. Zero the table and then
initialize the entries.
<P>
If an error occurs at any stage of processing the <I>QueryTable</I>, <B>RtlQueryRegistryValues</B>
stops processing the table and returns the error status.
<P>
Callers of <B>RtlQueryRegistryValues</B>&nbsp;must be running at IRQL
PASSIVE_LEVEL.
<H3>See Also</H3>
<P>
<B><A HREF="k109_80.htm">RtlZeroMemory</A></B>, <B><A HREF="k111_6.htm">ZwEnumerateKey</A></B>,
<B><A HREF="k111_11.htm">ZwOpenKey</A></B>&nbsp;
<P></FONT>
</BODY>
</HTML>
