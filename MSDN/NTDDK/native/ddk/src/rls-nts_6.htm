<!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML//EN">
<HTML>
<HEAD><META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=Windows-1252">
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-83731338-2"></script><script>  window.dataLayer = window.dataLayer || [];  function gtag(){dataLayer.push(arguments);}  gtag('js', new Date());  gtag('config', 'UA-83731338-2');</script><title>IRPs and I/O Cancellation</TITLE>
<style>@import url(/msdn_ie4.css);</style>
<link disabled rel="stylesheet" href="/msdn_ie3.css"></HEAD>
<BODY BGPROPERTIES="FIXED" TEXT="#000000" BGCOLOR="#FFFFFF">

<FONT FACE="ARIAL,HELVETICA" SIZE="2">
<H4><A NAME="DDK_IRPs_and_I_O_Cancellation_RN"></A>IRPs and I/O Cancellation</H4>
<UL>
<LI>
<I>Change in Spin Lock Usage and Return Value for <B>IoSetCancelRoutine</I></B>
<P>
If a driver manages its own queue(s) of IRPs, it does not need to hold the
cancel spin lock when calling <B>IoSetCancelRoutine</B>. <B>IoSetCancelRoutine</B>
now uses an interlocked exchange intrinsic to set the address of a cancel
routine in an IRP as an atomic operation. Drivers that manage their own queues
should move calls to <B>IoSetCancelRoutine</B>&nbsp;out of code holding the cancel
spin lock, to reduce contention for the spin lock and possibly improve
performance.
<P>
If a driver uses the I/O-manager-supplied device queue in the device object
and uses the <B>IoStart..Packet..</B>routines, then the driver must still hold
the system cancel spin lock when calling <B>IoSetCancelRoutine</B>.
<P>
<B>IoSetCancelRoutine</B>&nbsp;now returns the previous value of <BR>
<B>Irp</B>-&gt;<B>CancelRoutine</B>, which is of type PDRIVER_CANCEL.
<P>
<LI>
<I>Optional Additional Pointers in IRP When Not Using the Device Queue</I>
<P>
If a driver is not using the <B>DeviceQueueEntry</B>&nbsp;field in the IRP, it can
use that field to store up to four pointers. The driver can use those pointers
for any purpose as long as it owns the IRP. For example, one pointer could
point to the listhead for the queue in which the IRP resides. The definition
of that field in the IRP has been expanded as follows:
</UL>
<PRE><FONT FACE="Courier" SIZE="2">&nbsp; &nbsp; union {
&nbsp; &nbsp; &nbsp; &nbsp; KDEVICE_QUEUE_ENTRY DeviceQueueEntry;
&nbsp; &nbsp; &nbsp; &nbsp; struct {
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; PVOID DriverContext[4];
&nbsp; &nbsp; &nbsp; &nbsp; };
&nbsp; &nbsp; };
</FONT></PRE>
<P></FONT>
</BODY>
</HTML>
