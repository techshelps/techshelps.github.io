<!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML//EN">
<HTML>
<HEAD><META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=Windows-1252">
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-83731338-2"></script><script>  window.dataLayer = window.dataLayer || [];  function gtag(){dataLayer.push(arguments);}  gtag('js', new Date());  gtag('config', 'UA-83731338-2');</script><title>NdisReturnPackets</TITLE>
<style>@import url(/msdn_ie4.css);</style>
<link disabled rel="stylesheet" href="/msdn_ie3.css"></HEAD>
<BODY BGPROPERTIES="FIXED" TEXT="#000000" BGCOLOR="#FFFFFF">

<FONT FACE="ARIAL,HELVETICA" SIZE="2">
<H2><A NAME="DDK_NdisReturnPackets_NR"></A>NdisReturnPackets</H2>
<P>
<B>VOID</B><BR>
&nbsp; &nbsp;<B>&nbsp;NdisReturnPackets(</B><BR>
&nbsp; &nbsp; &nbsp; &nbsp; <B>IN PNDIS_PACKET</B>&nbsp; <B>*</B><I>PacketsToReturn</I><B>,</B><BR>
&nbsp; &nbsp; &nbsp; &nbsp;<B>&nbsp;IN UINT</B>&nbsp; <I>NumberOfPackets</I><BR>
&nbsp; &nbsp; &nbsp; &nbsp; <B>);</B>
<P>
<B>NdisReturnPackets</B>&nbsp;releases ownership of one or more packets after a
protocol has consumed the received data. 
<H3>Parameters</H3>
<DL>
<DT>
<I>PacketsToReturn</I>
<DD>
Points to an array of pointers to packet descriptors to be returned to the
underlying driver that allocated them for a receive indication. 
<BR>
<DT>
<I>NumberOfPackets</I>
<DD>
Specifies the number of pointers in the array. 
</DL>
<H3>Comments</H3>
<P>
An NDIS intermediate driver should call <B>NdisReturnPackets</B>&nbsp;as soon as
possible after its ProtocolReceivePacket function has returned control.
Otherwise, both the underlying driver that supports multipacket receive
indications and the bound protocol driver that processes them suffer a
performance degradation. 
<P>
When an underlying NIC driver runs low on available packet pool for receive
indications or its NIC runs low on empty receive buffers, the miniport can
force the NDIS library to call every bound protocol driver’s ProtocolReceive
function with a single packet descriptor at a time until the miniport has
regained ownership of its packet descriptors and the NIC has receive buffers
available for incoming net packets. A ProtocolReceive function cannot begin
postprocessing a packet of received data and forwarding the processed data to
clients until the driver’s ProtocolReceiveComplete function is called. 
<P>
For a packet descriptor passed in to its ProtocolReceivePacket function, a
highest level protocol driver can process its copy of received data and
forward the processed data to clients immediately because the protocol can
control how long it retains ownership of the resources allocated by the
indicating driver. Assuming a highest level protocol driver does not massage
the data it indicates to its clients, the protocol can even set up the range
of data within the receive buffer of interest to its client, and make a
receive indication to its client(s) by forwarding the input packet descriptor
to those clients. 
<P>
If an intermediate protocol driver’s ProtocolReceivePacket function returns a
nonzero reference count to an input packet descriptor, that driver must call <B>NdisReturnPackets</B>
one or more times. When it has called <B>NdisReturnPackets</B>&nbsp;with a
particular packet descriptor as many times as the value returned by
ProtocolReceivePacket, the NDIS library returns the packet descriptor to the
driver that made the indication. For a highest level protocol that forwards an
input packet descriptor to its clients, those clients return the packet
descriptor to the NDIS driver that allocated it by making calls to <B>TdiReturnChainedReceives</B>.
<P>
A protocol driver can rely on NDIS to manage the reference count for every
receive packet passed to the ProtocolReceivePacket function. When the
reference count for a packet descriptor originally set to the return from
ProtocolReceivePacket goes to zero, the NDIS library calls the indicating
driver’s MiniportReturnPacket function with the released packet descriptor. 
<P>
<B>NdisReturnPackets</B>&nbsp;cannot be called from a ProtocolReceivePacket
function. 
<P>
Callers of <B>NdisReturnPackets</B>&nbsp;run at IRQL &lt;= DISPATCH_LEVEL. 
<H3>See Also</H3>
<P>
<B><A HREF="101mini_13.htm">MiniportReturnPacket</A></B>, <B><A HREF="103ndisx_11.htm">NdisAllocatePacket</A></B>,
<B><A HREF="103ndisx_40.htm">NdisFreePacket</A></B>, <B><A HREF="103ndisx_107.htm">NdisMIndicateReceivePacket</A></B>,
<B><A HREF="106nstru_4.htm">NDIS_PACKET</A></B>, <B><A HREF="106nstru_5.htm">NDIS_PACKET_OOB_DATA</A></B>,
<B><A HREF="104tdlow_7.htm">ProtocolReceivePacket</A></B>, <B><A HREF="23tdifun_7.htm">TdiReturnChainedReceives</A></B>
<P></FONT>
</BODY>
</HTML>
