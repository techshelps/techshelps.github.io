<!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML//EN">
<HTML>
<HEAD><META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=Windows-1252">
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-83731338-2"></script><script>  window.dataLayer = window.dataLayer || [];  function gtag(){dataLayer.push(arguments);}  gtag('js', new Date());  gtag('config', 'UA-83731338-2');</script><title>TdiBuildListen</TITLE>
<style>@import url(/msdn_ie4.css);</style>
<link disabled rel="stylesheet" href="/msdn_ie3.css"></HEAD>
<BODY BGPROPERTIES="FIXED" TEXT="#000000" BGCOLOR="#FFFFFF">

<FONT FACE="ARIAL,HELVETICA" SIZE="2">
<H2><A NAME="DDK_TdiBuildListen_NR"></A>TdiBuildListen</H2>
<P>
<B>VOID <BR>
&nbsp; &nbsp; TdiBuildListen (<BR>
</B>&nbsp; &nbsp; &nbsp; &nbsp; <B>IN PIRP</B>&nbsp; <I>Irp</I><B>,<BR>
</B>&nbsp; &nbsp; &nbsp; &nbsp; <B>IN PDEVICE_OBJECT</B>&nbsp; <I>DevObj</I><B>,<BR>
</B>&nbsp; &nbsp; &nbsp; &nbsp; <B>IN PFILE_OBJECT</B>&nbsp; <I>FileObj</I><B>,<BR>
</B>&nbsp; &nbsp; &nbsp; &nbsp; <B>IN PVOID</B>&nbsp; <I>CompRoutine</I><B>,<BR>
</B>&nbsp; &nbsp; &nbsp; &nbsp; <B>IN PVOID</B>&nbsp; <I>Contxt</I><B>,<BR>
</B>&nbsp; &nbsp; &nbsp; &nbsp; <B>IN ULONG</B>&nbsp; <I>Flags</I><B>,<BR>
</B>&nbsp; &nbsp; &nbsp; &nbsp; <B>IN PTDI_CONNECTION_INFORMATION</B>&nbsp; <I>RequestConnectionInfo</I><B>,<BR>
</B>&nbsp; &nbsp; &nbsp; &nbsp; <B>OUT PTDI_CONNECTION_INFORMATION</B>&nbsp; <I>ReturnConnectionInfo<BR>
</I>&nbsp; &nbsp; &nbsp; &nbsp; <B>);</B>
<P>
<B>TdiBuildListen</B>&nbsp;sets up an internal device control IRP for a TDI_LISTEN
request to the underlying transport in which the local-node client has already
associated an address and a connection endpoint. 
<H3>Parameters</H3>
<DL>
<DT>
<I>Irp</I>
<DD>
Points to a client-supplied IRP, either originating in a higher level network
component or allocated with <B>TdiBuildInternalDeviceControlIrp</B>. 
<BR>
<DT>
<I>DevObj</I>
<DD>
Points to the device object created by the next lower TDI transport driver.
<BR>
<DT>
<I>FileObj</I>
<DD>
Points to a file object representing the connection endpoint. The client
previously made a successful request, set up with <B>TdiBuildAssociateAddress</B>,
to the transport to set up an association between this connection and a
local-node address. 
<BR>
<DT>
<I>CompRoutine</I>
<DD>
Specifies the entry point of a client-supplied IoCompletion routine or NULL.
The I/O Manager calls this routine when the given IRP is completed, unless the
client sets this parameter to NULL. 
<BR>
<DT>
<I>Contxt</I>
<DD>
Points to a client-determined context. This client-supplied pointer is passed
in to the client&#39;s IoCompletion routine when it is called with the
completed IRP. <I>Contxt</I>&nbsp;should be NULL if <I>CompRoutine</I>&nbsp;is NULL.
<BR>
<DT>
<I>Flags</I>
<DD>
Specifies zero or, possibly, TDI_QUERY_ACCEPT if the underlying transport
supports delayed-connection acceptances. 
<P>
If <I>Flags</I>&nbsp;is zero, the underlying transport accepts the connection from
the remote node as soon as it is offered. The client can assume the
endpoint-to-endpoint connection is fully operational when its listen request
completes. In fact, receives on the connection endpoint can occur even before
this listen IRP is fully completed back to the client. 
<P>
If the transport supports delayed-connection acceptances and its client sets
TDI_QUERY_ACCEPT, that client must either accept or reject the offered
connection as quickly as possible when the listen request completes. That is,
on completion of this IRP, the client must set up another request to the
transport with either <B>TdiBuildAccept</B>&nbsp;or <B>TdiBuildDisconnect</B>,
respectively. 
<BR>
<DT>
<I>RequestConnectionInfo</I>
<DD>
Points to a client-supplied buffer containing a TDI_CONNECTION_INFORMATION
structure that specifies the remote-node client address from which the
local-node client expects an endpoint-to-endpoint connection offer. 
<P>
Depending on the value of <I>Flags</I>, the client also provides additional
information in the following members of this structure:
<DL>
<DT>
<B>UserData</B>
<DD>
Points to a buffer of data the client wants sent with an acceptance of the
connection from the remote node if <I>Flags</I>&nbsp;is zero. 
<P>
A client sets this member to NULL if the underlying transport supports
delayed-connection acceptances and the client sets <I>Flags</I>&nbsp;to
TDI_QUERY_ACCEPT. Such a client can provide accept data when it subsequently
accepts an offered connection, assuming it does. 
<BR>
<DT>
<B>UserDataLength</B>
<DD>
Specifies the size in bytes of the buffer at <B>UserData</B>. This member is
zero if <B>UserData</B>&nbsp;is NULL. 
<BR>
<DT>
<B>Options</B>
<DD>
Set to the same value as <I>Flags</I>. 
<BR>
<DT>
<B>OptionsLength</B>
<DD>
Set to <B>sizeof(</B>ULONG<B>)</B>. 
<BR>
<DT>
<B>RemoteAddress</B>
<DD>
Points to a buffer specifying the remote-node client transport address from
which the local-node client expects a connection offer that the local-node
client will accept. This member can be NULL if an offered connection from any
remote node is acceptable to the client. 
<P>
For some transports, a local-node client can specify a partial address.
However, TDI drivers vary in their ability to handle partial addresses.
Because the syntax of any transport address is TDI-driver-specific, the
underlying transport defines the conventions for specifying a partial address
if it supports partial-address specifications.
<BR>
<DT>
<B>RemoteAddressLength</B>
<DD>
Specifies the size in bytes of the buffer at <B>RemoteAddress</B>. This member
should be set to zero if <B>RemoteAddress</B>&nbsp;is NULL. 
</DL>
<DT>
<I>ReturnConnectionInfo</I>
<DD>
Points to a caller<FONT FACE="Symbol">&#45;</FONT>supplied buffer in which the
transport returns the remote-node address from which a connection offer was
made. This buffer is also formatted as TDI_CONNECTION_INFORMATION structure. 
<P>
If the local-node client set <I>Flags</I>&nbsp;to TDI_QUERY_ACCEPT, it examines the
returned information to determine whether to accept or reject the connection
when this listen request completes. 
<P>
If the client requires no output information or if the underlying transport
does not return such information, this parameter should be NULL.
</DL>
<H3>Comments</H3>
<P>
<B>TdiBuildListen </B>sets IRP_MJ_INTERNAL_DEVICE_CONTROL as the <B>MajorFunction</B>
and TDI_LISTEN as the <B>MinorFunction</B>&nbsp;codes in the transport&#39;s I/O
stack location of the given IRP.
<P>
Before it calls the underlying transport with the IRP set up by <B>TdiBuildListen</B>,
a client must make a preceding associate-address request, set up with <B>TdiBuildAssociateAddress</B>,
that succeeded in associating an idle connection endpoint with a local-node
address. After this association is established, a client can issue numerous
listen requests until it accepts an offered endpoint-to-endpoint connection.
<P>
The underlying transport usually processes each client&#39;s listen requests
in FIFO order unless it supports quality-of-service (QOS) for its clients and,
therefore, prioritizes incoming listen requests. However, a client cannot make
assumptions about the order in which the underlying transport processes
requests from all its current clients.
<P>
Client-supplied addressing information at <I>RequestConnectionInfo</I>&nbsp;acts as
a filter that the underlying transport driver applies, before checking whether
the client set TDI_QUERY_ACCEPT if the transport supports delayed-connection
acceptances. If an incoming connection offer does not match an address
specified in the client&#39;s listen request, the transport cannot complete
the listen request for the client. Otherwise, when an incoming connection
offer is made from a specified remote-node address, the local-node
client&#39;s listen request is completed in one of the following ways:
<UL>
<LI>
If the client set <I>Flags</I>&nbsp;to TDI_QUERY_ACCEPT indicating
delayed-connection acceptance, the transport completes the listen request, and
the client must either accept or reject the offered endpoint-to-endpoint
connection by issuing a TDI_ACCEPT or TDI_DISCONNECT request to the transport
immediately. 
<P>
<LI>
If the client set <I>Flags</I>&nbsp;to zero, possibly because the underlying
transport does not support delayed-connection acceptances, the transport
transmits an acceptance, along with any accept data the client supplied, to
the remote node and completes the listen request.
</UL>
<P>
Before making a listen request, a client can set up one or more IRPs with <B>TdiBuildSetEventHandler</B>
and register its ClientEvent(Chained)Receive(Expedited) handler(s) for the
local address associated with the connection endpoint. If it does this, the
ClientEvent(Chained)Receive(Expedited) routine(s) can receive TSDUs before the
client&#39;s listen request completes. Such a client must be prepared to
accept an immediate connection when it makes a listen request.
<P>
While a listen for a client&#39;s connection endpoint is pending on a
particular local-node address, that client&#39;s ClientEventConnect function
cannot be called except under special circumstances. That is, the underlying
transport can call ClientEventConnect if a listen operation is pending and the
transport determines that the remote address acceptance criteria would prevent
the listen operation from being completed.
<P>
As mentioned previously, some transports support the specification of
remote-node partial addresses on listens. A transport also might support the
specification of QOS options. For example, such a TDI transport&#39;s clients
might specify the QOS for a listen using a variable-length counted string with
transport-defined syntax and semantics.
<H3>See Also</H3>
<P>
<B><A HREF="25tdicli_2.htm">ClientEventChainedReceive</A></B>, <B><A HREF="25tdicli_4.htm">ClientEventChainedReceiveExpedited</A></B>,
<B><A HREF="25tdicli_1.htm">ClientEventConnect</A></B>, <B><A HREF="25tdicli_7.htm">ClientEventReceive</A></B>,
<B><A HREF="25tdicli_9.htm">ClientEventReceiveExpedited</A></B>,
<B><A HREF="24bldmac_1.htm">TdiBuildAccept</A></B>, <B><A HREF="24bldmac_6.htm">TdiBuildDisconnect</A></B>,
<B><A HREF="24bldmac_7.htm">TdiBuildInternalDeviceControlIrp</A></B>,
<B><A HREF="24bldmac_16.htm">TdiBuildSetEventHandler</A></B>, <B><A HREF="22ioctl_7.htm">TDI_LISTEN</A></B>,
<B><A HREF="26tdstrc_21.htm">TDI_CONNECTION_INFORMATION</A></B>&nbsp;
<P></FONT>
</BODY>
</HTML>
