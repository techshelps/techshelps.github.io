<!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML//EN">
<HTML>
<HEAD><META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=Windows-1252">
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-83731338-2"></script><script>  window.dataLayer = window.dataLayer || [];  function gtag(){dataLayer.push(arguments);}  gtag('js', new Date());  gtag('config', 'UA-83731338-2');</script><title>WSHOpenSocket2</TITLE>
<style>@import url(/msdn_ie4.css);</style>
<link disabled rel="stylesheet" href="/msdn_ie3.css"></HEAD>
<BODY BGPROPERTIES="FIXED" TEXT="#000000" BGCOLOR="#FFFFFF">

<FONT FACE="ARIAL,HELVETICA" SIZE="2">
<H2><A NAME="DDK_WSHOpenSocket2_NR"></A>WSHOpenSocket2</H2>
<P>
<B>INT<BR>
&nbsp; &nbsp; WSHOpenSocket2(<BR>
&nbsp; &nbsp; &nbsp; &nbsp; IN OUT PINT </B><I>AddressFamily</I><B>,</B><BR>
<B>&nbsp; &nbsp; &nbsp; &nbsp; IN OUT PINT </B><I>SocketType</I><B>,</B><BR>
<B>&nbsp; &nbsp; &nbsp; &nbsp; IN OUT PINT </B><I>Protocol</I><B>,</B><BR>
<B>&nbsp; &nbsp; &nbsp; &nbsp; IN GROUP </B><I>Group</I><B>,</B><BR>
<B>&nbsp; &nbsp; &nbsp; &nbsp; IN DWORD </B><I>Flags</I><B>,</B><BR>
<B>&nbsp; &nbsp; &nbsp; &nbsp; OUT PUNICODE_STRING </B><I>TransportDeviceName</I><B>,</B><BR>
<B>&nbsp; &nbsp; &nbsp; &nbsp; OUT PVOID </B><I>*HelperDllSocketContext</I><B>,</B><BR>
<B>&nbsp; &nbsp; &nbsp; &nbsp; OUT PDWORD </B><I>NotificationEvents</I><BR>
<B>&nbsp; &nbsp; &nbsp; &nbsp; );</B>
<P>
<B>WSHOpenSocket2</B>&nbsp;is called by the MSAFD support DLL in response to an
application call to <B>WSASocket</B>.
<H3>Parameters</H3>
<DL>
<DT>
<I>AddressFamily</I>
<DD>
On input, points to a variable that is set to the address family as specified
in the <B>WSASocket</B>&nbsp;call. On output, the variable should be set to the
canonicalized value for the address family.
<BR>
<DT>
<I>SocketType</I>
<DD>
On input, points to a variable that is set to the socket type as specified in
the <B>WSASocket</B>&nbsp;call. On output, the variable should be set to the
canonicalized value for the socket type.
<BR>
<DT>
<I>Protocol</I>
<DD>
On input, points to a variable that is set to the protocol as specified in the
<B>WSASocket</B>&nbsp;call. On output, the variable should be set to the
canonicalized value for the protocol.
<BR>
<DT>
<I>Group</I>
<DD>
Identifies the group to which the socket that is being opened should belong if
nonzero. (For more information about socket grouping, see the Win32 SDK.)
Alternatively, this can be one of the following constants to create a new
group of sockets.
<DL>
<DT>
SG_UNCONSTRAINED_GROUP
<DD>
Create an new unconstrained group of sockets and have this socket become the
first member of that group.
<BR>
<DT>
SG_CONSTRAINED_GROUP
<DD>
Create a new constrained group of sockets and have this socket become the
first member of that group.
</DL>
<P>
MSAFD will handle all group mechanisms. The group number, if specified instead
of one of the preceding flags, is provided for informational purposes.
<BR>
<DT>
<I>Flags</I>
<DD>
Specifies attributes for the new socket that is to be created. (For more
information about Windows Sockets 2 multipoint and root/leaf sockets, see the
Win32 SDK.) The following lists valid flags that can be specified:
<DL>
<DT>
WSA_FLAG_OVERLAPPED
<DD>
Indicates that a socket capable of handing overlapped I/O should be created.
If this flag is set, overlapped I/O can be further utilized on calls to <B>WSASend</B>,
<B>WSASendTo</B>, <B>WSARecv</B>, <B>WSARecvFrom</B>&nbsp;and <B>WSAIoctl</B>.
<BR>
<DT>
WSA_FLAG_MULTIPOINT_C_ROOT
<DD>
Indicates that the socket should be created as a c_root in a multipoint
session.
<BR>
<DT>
WSA_FLAG_MULTIPOINT_C_LEAF
<DD>
Indicates that the socket should be created as a c_leaf in a multipoint
session.
<BR>
<DT>
WSA_FLAG_MULTIPOINT_D_ROOT
<DD>
Indicates that the socket should be created as a d_root in a multipoint
session.
<BR>
<DT>
WSA_FLAG_MULTIPOINT_D_LEAD
<DD>
Indicates that the socket should be created as a d_leaf in a multipoint
session.
</DL>
<DT>
<I>TransportDeviceName</I>
<DD>
Points to a buffered Unicode string that specifies the device name of the
transport driver that will support this socket type. Storage for the
UNICODE_STRING structure is allocated by the caller, and the string
initialized with the transport device name, such as \\Device\\Tcp.
<BR>
<DT>
<I>HelperDllSocketContext</I>
<DD>
Points to a variable in which <B>WSHOpenSocket2</B>&nbsp;returns the address of a
memory block that can be dynamically allocated. The returned pointer is passed
to the helper DLL in all subsequent calls regarding the newly created socket.
The helper DLL can use this block of memory to maintain per-socket
information.
<BR>
<DT>
<I>Notification Events</I>
<DD>
Points to a bitmask variable that the helper DLL sets to specify the
state-change events for which the Windows Sockets DLL should call the helper
DLL&#39;s <B>WSHNotify</B>&nbsp;function. A helper DLL can request notifications by
setting this variable to a combination (ORed) of the following, as defined in <I>wsahelp.h</I>:
<DL>
<DT>
WSH_NOTIFY_BIND
<DD>
Call <B>WSHNotify</B>&nbsp;on a successful call to <B>bind</B>.
<BR>
<DT>
WSH_NOTIFY_LISTEN
<DD>
Call <B>WSHNotify</B>&nbsp;on a successful call to <B>listen</B>.
<BR>
<DT>
WSH_NOTIFY_ACCEPT
<DD>
Call <B>WSHNotify</B>&nbsp;when a socket handle is being returned from the <B>WSAAccept</B>
or <B>accept</B>&nbsp;function.
<BR>
<DT>
WSH_NOTIFY_CONNECT
<DD>
Call <B>WSHNotify</B>&nbsp;on a successful call to <B>WSAConnect </B>or <B>connect</B>.
<BR>
<DT>
WSH_NOTIFY_SHUTDOWN_RECEIVE
<DD>
Call <B>WSHNotify</B>&nbsp;on a successful call to <B>shutdown </B>for the receive
side of the socket.
<BR>
<DT>
WSH_NOTIFY_SHUTDOWN_SEND
<DD>
Call <B>WSHNotify</B>&nbsp;on a successful call to <B>shutdown </B>for the send
side of the socket.
<BR>
<DT>
WSH_NOTIFY_SHUTDOWN_ALL
<DD>
Call <B>WSHNotify</B>&nbsp;on a successful call to <B>shutdown </B>for both sides
of the socket.
<BR>
<DT>
WSH_NOTIFY_CLOSE
<DD>
Call <B>WSHNotify</B>&nbsp;when the socket is being closed.
<BR>
<DT>
WSH_NOTIFY_CONNECT_ERROR
<DD>
Call <B>WSHNotify</B>&nbsp;when a socket fails a call to <B>WSAConnect</B>&nbsp;or <B>connect
</B>occurred.
</DL>
</DL>
<H3>Return Value</H3>
<P>
<B>WSHOpenSocket2</B>&nbsp;returns zero to indicate a successful creation of a
socket. If this function returns a nonzero value, the corresponding call to <B>WSASocket</B>
or <B>WSAAccept </B>fails. If so, the helper DLL should return an appropriate
Windows Sockets error code as defined in <I>winsock2.h</I>.
<H3>Comments</H3>
<P>
<B>WSHOpenSocket2</B>&nbsp;is called by the sockets service provider, such as
MSAFD.DLL, to create a new socket. A new socket will be created by a call to <B>WSASocket</B>
or by <B>WSAAccept</B>.
<P>
The helper DLL should canonicalize and verify the input parameters so that
Windows Sockets 2 can rely on a unique triple for each type of socket. The
parameters for creating a root or leaf depend on the underlying protocol. 
<P>
Before it returns control, <B>WSHOpenSocket2</B>&nbsp;should allocate necessary
memory for a socket-specific context structure, set a notification bitmask,
and set the name of the transport driver that handles this socket. 
<P>
A WSH DLL <I>must</I>&nbsp;set <I>NotificationEvents</I>&nbsp;with WSH_NOTIFY_CLOSE if
it allocates memory for per-socket context and returns a pointer at <I>HelperDllSocketContext</I>.
Otherwise, a memory leak can occur.
<H3>See Also</H3>
<P>
<B><A HREF="27wshfun_13.htm">WSHNotify</A></B>&nbsp;
<P></FONT>
</BODY>
</HTML>
