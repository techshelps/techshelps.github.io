<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<HTML dir=ltr>
<HEAD>
<META HTTP-EQUIV="Content-Type" Content="text/html; charset=Windows-1252">
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-83731338-2"></script><script>  window.dataLayer = window.dataLayer || [];  function gtag(){dataLayer.push(arguments);}  gtag('js', new Date());  gtag('config', 'UA-83731338-2');</script><title>Retrieving PROPID_Q_TRANSACTION</title>
<link disabled rel=stylesheet href=../../backsdk3.css>
<style type="text/css">
@import url(../../backsdk4.css);
</style>
</HEAD>
<BODY BGCOLOR = #FFFFFF TEXT = #000000>

<h3><a name="_mq_retrieving_propid_q_transaction"></a>Retrieving PROPID_Q_TRANSACTION</h3>
<p>
The queue's transaction level specifies whether the queue accepts <a href="msmqglos_3wvo.htm#_mq_transaction_message_gly">transaction messages</a> or <a href="msmqglos_3wvi.htm#_mq_non_transaction_message_gly">non-transaction messages</a>. It cannot accept both. By default, a queue is created as a non-transaction queue. </p>
<p>
Unlike most queue properties, PROPID_Q_TRANSACTION can be set only when the queue is created.</p>
<h5><img src="../../images/wedge.gif" border=0>To retrieve PROPID_Q_TRANSACTION</h5>
<ol>
<li>
Define the structures needed to retrieve the properties. This includes the <b>MQQUEUEPROPS</b> structure.<pre><code>// Define number of properties to be retrieved.
#define NumberOfProperties 1

// Define property counter.
DWORD PropIdCount = 0;

// Define the MQQUEUPROPS structure.
MQQUEUEPROPS QueueProps;
PROPVARIANT aQueuePropVar[NumberOfProperties];
QUEUEPROPID aQueuePropId[NumberOfProperties];
HRESULT aQueueStatus[NumberOfProperties];

// Define results.
HRESULT hr;

// Define format name buffer.
DWORD dwFormatNameBufferLength = 256;
WCHAR szFormatNameBuffer[256];
</code></pre>
</li>
<li>
Specify PROPID_Q_TRANSACTION. <pre><code>aQueuePropId[PropIdCount] = PROPID_Q_TRANSACTION;  //Property ID
aQueuePropVar[PropIdCount].vt = VT_UI1;            //Type indicator
PropIdCount++;
</code></pre>
</li>
<li>
Add any additional queue properties. When adding properties, increment the <i>NumberOfProperties</i> variable to reflect the number of properties added.</li>
<li>
Set the <b>MQQUEUEPROPS </b>structure.<pre><code>QueueProps.cProp = PropIdCount;           // Number of properties
QueueProps.aPropID = aQueuePropId;        // Ids of properties
QueueProps.aPropVar = aQueuePropVar;      // Values of properties
QueueProps.aStatus = aQueueStatus;        // Error reports
</code></pre>
</li>
<li>
Obtain the format name of the queue. The example below uses <a href="mqfunc_95t1.htm"><b>MQPathNameToFormatName</b></a> to obtain the format name of a known queue. Other functions that can be used are <a href="mqfunc_5zj9.htm"><b>MQHandleToFormatName</b></a> and <a href="mqfunc_925h.htm"><b>MQInstanceToFormatName</b></a>.<pre><code>hr = MQPathNameToFormatName(L"machinename\\queuename",
                              szFormatNameBuffer,
                                  &amp;dwFormatNameBufferLength);
if (FAILED(hr))
   {
   fprintf(stderr, "Failed in MQPathNameToFormatName, error = 0x%x\n",hr);
   return -1;
   }</code></pre>
</li>
<li>
Call <a href="mqfunc_8b03.htm"><b>MQGetQueueProperties</b></a>.<pre><code>hr = MQGetQueueProperties(szFormatNameBuffer, &amp;QueueProps);
if (FAILED(hr))
   {
   fprintf(stderr, "Failed in MQGetQueueProperties, error = 0x%x\n",hr);
   return -1;
   }
 </code></pre>
</li>
<li>
Examine the value of the returned property. In this example, the transaction level of the queue is printed to the screen.<pre><code>if (aQueuePropVar[0].bVal == MQ_TRANSACTIONAL)
 printf("PROPID_Q_TRANSACTION is set to MQ_TRANSACTIONAL.\n");
 else
 printf("PROPID_Q_TRANSACTION is set to MQ_TRANSACTIONAL_NONE.\n");
 </code></pre>
</li>
</ol>
<h4>Example Code</h4>
<p>
The following example retrieves the PROPID_Q_TRANSACTION property for a known queue and then prints the returned value to the screen.</p>
<pre><code>#include &lt;windows.h&gt;
#include &lt;stdio.h&gt;
#include &lt;mq.h&gt;                       // MSMQ header file


int main(int arg, char *argv[])

{
  ///////////////////////////
  //  Define structures.
  ////////////////////////////

  // Define number of properties to be retrieved.
  #define NumberOfProperties 1

  // Define property counter.
  DWORD PropIdCount = 0;

  // Define the MQQUEUPROPS structure.
  MQQUEUEPROPS QueueProps;
  PROPVARIANT aQueuePropVar[NumberOfProperties];
  QUEUEPROPID aQueuePropId[NumberOfProperties];
  HRESULT aQueueStatus[NumberOfProperties];
  
  // Define results.
  HRESULT hr;
  
  // Define format name buffer.
  DWORD dwFormatNameBufferLength = 256;
  WCHAR szFormatNameBuffer[256];
  
  
  ///////////////////////////////////
  // Specify PROPID_Q_TRANSACTION.
  ///////////////////////////////////
  
  aQueuePropId[PropIdCount] = PROPID_Q_TRANSACTION; // Property ID
  aQueuePropVar[PropIdCount].vt = VT_UI1;            // Type indicator
  PropIdCount++;
  
  
  ///////////////////////////////////////////////////////
  // Add additional queue properties here. When adding 
  // properties, increment NumberOfProperties to 
  // reflect total number of properties.
  ///////////////////////////////////////////////////////
  
  
  ////////////////////////////////
  // Set the MQQUEUEPROPS structure.
  /////////////////////////////////
  
  QueueProps.cProp = PropIdCount;           // Number of properties
  QueueProps.aPropID = aQueuePropId;        // Ids of properties
  QueueProps.aPropVar = aQueuePropVar;      // Values of properties
  QueueProps.aStatus = aQueueStatus;        // Error reports
  
  
  ////////////////////////////
  //Get format name of queue.
  ////////////////////////////
 
  hr = MQPathNameToFormatName(L"computername\\queuename",
                              szFormatNameBuffer,
                                  &amp;dwFormatNameBufferLength);
  if (FAILED(hr))
  {
    fprintf(stderr, "Failed in MQPathNameToFormatName, error = 0x%x\n",hr);
  return -1;
  }
 
 
  ////////////////////////////
  // Get queue property.
  ////////////////////////////
  
  hr = MQGetQueueProperties(szFormatNameBuffer, &amp;QueueProps);
  if (FAILED(hr))
  {
    fprintf(stderr, "Failed in MQGetQueueProperties, error = 0x%x\n",hr);
    return -1;
  }
  
  
  //////////////////////////////////////////////
  // Review returned value. This example prints 
  // out the authentication level of the queue.
  //////////////////////////////////////////////
  
  if (aQueuePropVar[0].bVal == MQ_TRANSACTIONAL)
        printf("PROPID_Q_TRANSACTION is set to MQ_TRANSACTIONAL.\n");
    else
    printf("PROPID_Q_TRANSACTION is set to MQ_TRANSACTIONAL_NONE.\n");
  
  
  return 0;
 
}
 </code></pre>
<p>&nbsp;</p></body>
</HTML>
