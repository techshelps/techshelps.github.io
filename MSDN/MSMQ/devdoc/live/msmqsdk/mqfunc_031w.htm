<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<HTML dir=ltr>
<HEAD>
<META HTTP-EQUIV="Content-Type" Content="text/html; charset=Windows-1252">
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-83731338-2"></script><script>  window.dataLayer = window.dataLayer || [];  function gtag(){dataLayer.push(arguments);}  gtag('js', new Date());  gtag('config', 'UA-83731338-2');</script><title>MQGetSecurityContext</title>
<link disabled rel=stylesheet href=../../backsdk3.css>
<style type="text/css">
@import url(../../backsdk4.css);
</style>
</HEAD>
<BODY BGCOLOR = #FFFFFF TEXT = #000000>

<h1><a name="_mq_mqgetsecuritycontext"></a>MQGetSecurityContext</h1>
<p>
The <b>MQGetSecurityContext</b> function retrieves security information needed to authenticate messages.</p>
<pre><code><b>VOID APIENTRY MQGetSecurityContext(
  LPVOID</b><i> lpCertBuffer</i><b>,      </b>
<b>  DWORD</b><i> dwCertBufferLength</i><b>,  </b>
<b>  HANDLE </b><i>*hSecurityContext  </i>
<b>);</b>
 </code></pre>
<h4>Parameters</h4>
<dl>
<dt>
<i>lpCertBuffer</i></dt>
<dd>
[In] Pointer to the security certificate buffer. External certificates must be in ASN.1 DER encoded format. If this parameter is NULL, the internal security certificate provided by MSMQ is used.</dd>
<dt>
<i>dwCertBufferLength</i></dt>
<dd>
[In] Length of the security certificate buffer pointed to by <i>lpCertBuffer</i>. For internal certificates, set to 0.</dd>
<dt>
<i>hSecurityContext</i></dt>
<dd>
[Out] Handle to the security context buffer allocated by MSMQ.
</dd>
</dl>
<h4>Return Values</h4>
<dl>
<dt>
MQ_OK</dt>
<dd>
Indicates success.</dd>
<dt>
MQ_ERROR_COULD_NOT_GET_USER_SID</dt>
<dd>
MSMQ could not get the specified sender identifier.</dd>
<dt>
MQ_ERROR_NO_DS</dt>
<dd>
Only Windows 95. Cannot access <a href="msmqglos_3wv5.htm#_mq_active_directory_gly">Active Directory</a>.</dd>
<dt>
MQ_ERROR_INVALID_PARAMETER</dt>
<dd>
One of the IN parameters supplied by the operation is not valid.</dd>
<dt>
MQ_ERROR_INSUFFICIENT_RESOURCES</dt>
<dd>
Insufficient resources to complete operation (for example, not enough memory). Operation failed.</dd>
<dt>
MQ_ERROR_INVALID_CERTIFICATE</dt>
<dd>
Security certificate specified by <a href="mqprop_2nsk.htm">PROPID_M_SENDER_CERT</a> is invalid, or the certificate is not correctly placed in the Microsoft® Internet Explorer personal certificate store.</dd>
<dt>
MQ_ERROR_CORRUPTED_INTERNAL_CERTIFICATE</dt>
<dd>
MSMQ-supplied internal certificate is corrupted.</dd>
<dt>
MQ_ERROR_CORRUPTED_SECURITY_DATA</dt>
<dd>
Cryptographic function (CryptoAPI) has failed.
</dd>
</dl>
<h4>Remarks</h4>
<p>
The <b>MQGetSecurityContext</b> function retrieves the information MSMQ needs to authenticate messages from the supplied certificate. It provides a way to send messages that require authentication in a more efficient way. <b>MQGetSecurityContext</b> should be used when the same certificate is used to send multiple messages and when impersonating another user.</p>
<p>
Although the security information in the certificate can be retrieved directly by the sending application, this function retrieves and caches the needed information using a single function call. When <b>MQGetSecurityContext</b> is used, the sending application is only responsible for passing the security context buffer (<a href="mqprop_27lg.htm">PROPID_M_SECURITY_CONTEXT</a>) to <a href="mqfunc_8ip1.htm"><b>MQSendMessage</b></a>. </p>
<p>
When authenticating messages, MSMQ must track which sender certificate is associated with which message. Consequently, calling <b>MQSendMessage</b> must be done in the same user context as the call to <b>MQGetSecurityContext</b>. If <b>MQGetSecurityContext</b> is not called before the message is sent (or <a href="mqprop_27lg.htm">PROPID_M_SECURITY_CONTEXT</a> is not passed to <a href="mqfunc_8ip1.htm"><b>MQSendMessage</b></a>) the security context of the user who originally ran the process is used.</p>
<p>
When more than one certificate is used,<b> MQGetSecurityContext</b> must be called for each certificate the sending application wants to use.</p>
<p>
When impersonating another user, <b>MQGetSecurityContext</b> must be called before a message is sent. Once the security information for the impersonated user is retrieved, the sending application can revert to the original user and later use the impersonated security context to send the message without the need to impersonate the user again.</p>
<p>
To retrieve the security information of an impersonated user, HKEY_CURRENT_USER must point to the registry of the impersonated user. To do this, call the Win32 API function RegLoadKey() to load the impersonated user's registry <a href="msmqglos_3wvc.htm#_mq_hive_gly">hive</a>. Call RegCloseKey (HKEY_CURRENT_USER) to close the current user registry, then call ImpersonateLoggedOnUser() and <b>MQGetSecurityContext</b> to access the impersonated user registry and retrieve information about the impersonated user. The calls to RegCloseKey(), ImpersonateLoggedOnUser (), <b>MQGetSecurityContext</b>, and any other calls that may access the registry under HKEY_CURRENT_USER must be protected by the same <a href="msmqglos_3wv7.htm#_mq_critical_section_object_gly">critical section object</a>.</p>
<p>
<b>Note</b>&nbsp;&nbsp;For information on RegLoadKey(), RegCloseKey(), ImpersonateLoggedOnUser(), and critical section objects, see the Microsoft Platform SDK.</p>
<p>
After the security certificate is no longer needed, free the memory allocated for the security context buffer by calling <a href="mqfunc_7x84.htm"><b>MQFreeSecurityContext</b></a>.</p>
<p>
The security context of a certificate cannot be retrieved if there is no connection to <a href="msmqglos_3wv5.htm#_mq_active_directory_gly">Active Directory</a>. This restriction applies to <a href="msmqglos_3wv8.htm#_mq_dependent_client_gly">dependent client</a> computers, <a href="msmqglos_3wvd.htm#_mq_independent_client_gly">independent client</a> computers (working offline), and MSMQ routing servers (FRS). (For information on offline operations, see <a href="msmq_guide_72es.htm">MSMQ Offline Support</a>.)</p>
<p>
Windows 95-based applications cannot retrieve the security context of the certificate when operating on an <a href="msmqglos_3wvd.htm#_mq_independent_client_gly">independent client</a> computer running offline. For information on offline operations, see <a href="msmq_guide_72es.htm">MSMQ Offline Support</a>.</p>
<h4>QuickInfo</h4>
<p>
<b>&nbsp;&nbsp;Windows NT: </b>Requires version 4.0 SP3 or later.<br>
<b>&nbsp;&nbsp;Windows: </b>Requires Windows 95 or later.<br>
<b>&nbsp;&nbsp;Windows CE: </b>Unsupported.<br>
<b>&nbsp;&nbsp;Header: </b>Declared in mq.h.<br>
<b>&nbsp;&nbsp;Import Library: </b>Use mqrt.lib.<br>
<b>&nbsp;&nbsp;Unicode: </b>Defined only as Unicode.</p>
<h4>See Also</h4>
<p>
<a href="mqfunc_7x84.htm"><b>MQFreeSecurityContext</b></a>, <a href="mqfunc_8ip1.htm"><b>MQSendMessage</b></a>, <a href="mqprop_27lg.htm">PROPID_M_SECURITY_CONTEXT</a> </p>
<p>&nbsp;</p></body>
</HTML>
