<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<HTML dir=ltr>
<HEAD>
<META HTTP-EQUIV="Content-Type" Content="text/html; charset=Windows-1252">
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-83731338-2"></script><script>  window.dataLayer = window.dataLayer || [];  function gtag(){dataLayer.push(arguments);}  gtag('js', new Date());  gtag('config', 'UA-83731338-2');</script><title>Using Structures in ICM 2.0</title>
<link disabled rel=stylesheet href=../../backsdk3.css>
<style type="text/css">
@import url(../../backsdk4.css);
</style>
</HEAD>
<BODY BGCOLOR = #FFFFFF TEXT = #000000>

<h3><a name="_win32_using_structures_in_icm_2.0"></a>Using Structures in ICM 2.0</h3>
<p>
<span style=color:#FF0000>[This is preliminary documentation and subject to change.]</span> </p>
<p>
Most of the structures used by ICM 2.0 are very straightforward and require little explanation. They are documented in the ICM 2.0 Reference section entitled <a href="icm_0reb.htm">ICM 2.0 Structures</a>.</p>
<p>
Exceptions are the <a href="icm_9bhu.htm"><b>COLORMATCHSETUP</b></a> structure used by the <a href="icm_2zc7.htm"><b>SetupColorMatching</b></a> function, and the following Windows structures defined in Wingdi.h:
<ul>
<li>
<a href="#_win32_windows_bitmap_header_structures"><b>BITMAPV5HEADER</b></a></li>
<li>
<a href="icm_2lf6.htm"><b>LOGCOLORSPACE</b></a></li>
<li>
<a href="icm_1qpe.htm"><b>CIEXYZ</b></a> </li>
<li>
<a href="icm_69rm.htm"><b>CIEXYZTRIPLE</b></a></li>
</ul>
<p>
The following topics are discussed at greater length:
<ul>
<li>
<a href="#_win32_windows_bitmap_header_structures">Windows Bitmap Header Structures</a></li>
<li>
<a href="#_win32_differences_between_v4_and_v5_headers">Differences Between V4 and V5 Headers</a></li>
<li>
<a href="#_win32_bitmap.exe_a_command_line_utility_for_converting_bitmap_headers">Bitmap.exe: a Command-Line Utility for Converting Bitmap Headers</a></li>
</ul>

<h4><a name="_win32_windows_bitmap_header_structures"></a>Windows Bitmap Header Structures</h4>
<p>
<span style=color:#FF0000>[This is preliminary documentation and subject to change.]</span> </p>
<p>
ICM 2.0 allows ICC color profiles to be linked or embedded in device-independent bitmaps (DIBs). This allows DIB colors to be characterized more accurately than was possible using ICM in Windows 95. <object id=alink_1 type="application/x-oleobject"
	classid="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
<PARAM name="Command" value="ALink,MENU">
<PARAM name="DefaultTopic" value="../../notopic_0pk4.htm">
<PARAM name="Item1" value="">
<PARAM name="Item2" value="_win32_bitmapv5header_str">
</object><a href=JavaScript:alink_1.Click()><b>BITMAPV5HEADER</b></a>, the new bitmap header structure, is defined in Wingdi.h in the release of Windows 98. For development purposes, it is also included in the file Icm.h with this Programmer's Reference. The <b>BITMAPV5HEADER</b> structure is as follows:</p>
<pre><code>typedef struct {
   DWORD        bV5Size;
   LONG         bV5Width;
   LONG         bV5Height;
   WORD         bV5Planes;
   WORD         bV5BitCount;
   DWORD        bV5Compression;
   DWORD        bV5SizeImage;
   LONG         bV5XPelsPerMeter;
   LONG         bV5YPelsPerMeter;
   DWORD        bV5ClrUsed;
   DWORD        bV5ClrImportant;
   DWORD        bV5RedMask;
   DWORD        bV5GreenMask;
   DWORD        bV5BlueMask;
   DWORD        bV5AlphaMask;
   DWORD        bV5CSType;
   CIEXYZTRIPLE bV5Endpoints;
   DWORD        bV5GammaRed;
   DWORD        bV5GammaGreen;
   DWORD        bV5GammaBlue;
   DWORD        bV5Intent;         // Rendering intent for bitmap
   DWORD        bV5ProfileData;    // Offset to profile data
   DWORD        bV5ProfileSize;    // Size of embedded profile data
   DWORD        bV5Reserved;       // For future use - should be zero
} BITMAPV5HEADER, FAR *LPBITMAPV5HEADER, *PBITMAPV5HEADER;
 </code></pre>
<p>
The member <b>bV5CSType</b> can have the values PROFILE_EMBEDDED or PROFILE_LINKED to specify whether a profile is embedded or linked with the DIB. The member <b>bV5ProfileData</b> is the offset in bytes from the beginning of the <b>BITMAPV5HEADER</b> structure to the start of the profile data. If the profile is embedded, profile data is the actual profile, and if it is linked, the profile data is the null-terminated file name of the profile. This cannot be a Unicode string. It must be composed exclusively of characters from the Windows character set (code page 1252).</p>
<p>
When a DIB is loaded into memory, the profile data (if present) should follow the color table, and <b>bV5ProfileData</b> should give the offset of the profile data from the beginning of the <b>BITMAPV5HEADER</b> structure. The value of this member will be different now, as the bitmap bits do not follow the color table in memory. Applications should modify the <b>bV5ProfileData</b> member after loading the DIB into memory.</p>
<p>
For packed DIBs, the profile data should follow the bitmap bits similar to the file format. The <b>bV5ProfileData</b> member should still give the offset of the profile data from the beginning of the <b>BITMAPV5HEADER</b> structure.</p>
<p>
Applications should access the profile data only when <b>bV5Size</b> == <b>sizeof</b>(<b>BITMAPV5HEADER</b>) <b>AND</b> <b>bV5CSType</b> is PROFILE_EMBEDDED or PROFILE_LINKED. </p>
<p>
If a profile is linked, the path of the profile can be any fully qualified name (including a network path) that can be opened using the Win32 <b>CreateFile</b> function.</p>

<h4><a name="_win32_differences_between_v4_and_v5_headers"></a>Differences Between V4 and V5 Headers</h4>
<p>
In working with the new bitmap structure, it is useful to recognize differences in how <b>BITMAPV4HEADER</b> and <b>BITMAPV5HEADER</b> structures are set up:</p>
<h4>V4 Header</h4>
<ol>
<li>
<b>bV4CSType</b> = LCS_CALIBRATED_RGB. This value implies that end points and gammas are given in the appropriate fields. Bogus values cause trouble.</li>
<li>
<b>bV4CSType</b> = LCS_sRGB. This value implies that the bitmap is in sRGB color space (gammas and endpoints ignored).</li>
<li>
<b>bV4CSType</b> = LCS_WINDOWS_COLOR_SPACE. This value implies that the bitmap is in Windows default color space.</li>
</ol>
<h4>V5 Header</h4>
<ol>
<li>
<b>bV5CSType</b> = LCS_CALIBRATED_RGB. This value implies that end points and gammas are given in the appropriate fields. Bogus values cause trouble.</li>
<li>
<b>bV5CSType</b> = LCS_sRGB. This value implies that the bitmap is in sRGB color space (gammas and endpoints ignored).</li>
<li>
<b>bV5CSType</b> = PROFILE_EMBEDDED. This value implies that <b>bV5ProfileData</b> points to a memory buffer that contains the profile to use (gammas and endpoints are ignored).</li>
<li>
<b>bV5CSType</b> = PROFILE_LINKED. This value implies that <b>bV5ProfileData</b> points to the file name of the profile to use (gammas and endpoints are ignored).</li>
<li>
<b>bV5CSType</b> = LCS_WINDOWS_COLOR_SPACE. This value implies that the bitmap is in Windows default color space.</li>
</ol>
<p>
In order to convert older bitmaps to and from the new <b>BITMAPV5HEADER</b> structure, a command-line conversion utility file named Bitmap.exe is included in the ICM 2.0 Programmer's Reference.</p>

<h4><a name="_win32_bitmap.exe_a_command_line_utility_for_converting_bitmap_headers"></a>BitMap.exe: a Command-Line Utility for Converting Bitmap Headers</h4>
<p>
Bitmap.exe is a command-line utility located in the \Bin folder under the installation folder that you specified. It modifies the headers of Windows bitmaps, allowing you to convert existing bitmaps from <b>BITMAPINFOHEADER</b> and <b>BITMAPV4HEADER</b> header structures to the newer <b>BITMAPV5HEADER</b> structure and back again. The command-line syntax is as follows:</p>
<pre><code><b>BITMAP [/d] [/1|4|5] [/s] [/f] <i>filename</i>
</b> </code></pre>
<p>
The command-line switches have the following effects.</p>
<table cellspacing=4 cols=2>
<tr valign=top>
<th align=left width=8%></th>
<th align=left width=92%>Meaning</th>
</tr>
<tr valign=top>
<td width=8%>/d</td>
<td width=92%>Default values are automatically entered in the converted headers.</td>
</tr>
<tr valign=top>
<td width=8%>/1</td>
<td width=92%>Convert the specified bitmaps to <b>BITMAPINFOHEADER</b></td>
</tr>
<tr valign=top>
<td width=8%>/4</td>
<td width=92%>Convert the specified bitmaps to <b>BITMAPV4HEADER</b></td>
</tr>
<tr valign=top>
<td width=8%>/5</td>
<td width=92%>Convert the specified bitmaps to <b>BITMAPV5HEADER</b></td>
</tr>
<tr valign=top>
<td width=8%>/f</td>
<td width=92%>Forces conversion, even if the bitmap already has the right header </td>
</tr>
<tr valign=top>
<td width=8%>/s</td>
<td width=92%>Converts bitmaps in the specified folder and all subdirectories under it</td>
</tr>
</table><br>
<p>&nbsp;</p></body>
</HTML>
