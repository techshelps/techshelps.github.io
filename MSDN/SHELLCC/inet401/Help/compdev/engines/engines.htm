<!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML//EN">
<HTML>
<HEAD><script async src="https://www.googletagmanager.com/gtag/js?id=UA-83731338-2"></script><script>  window.dataLayer = window.dataLayer || [];  function gtag(){dataLayer.push(arguments);}  gtag('js', new Date());  gtag('config', 'UA-83731338-2');</script><title>ActiveX Scripting Engines</TITLE>

<META NAME=MS-HKWD CONTENT="ActiveX Scripting Engines">
<META NAME="Keywords" CONTENT="Component Development">
<META NAME="Platform" CONTENT="Windows, Win95, WinNT">
<META HTTP-EQUIV="Content-Type" CONTENT="text/html; CHARSET=iso8859-1">
<META NAME="MS.LOCALE" CONTENT="EN-US">
<META NAME="ROBOTS" CONTENT="all">


<SCRIPT>
//<!--
var g_isIE = false, g_isNav = false, g_iMaj = 0, g_sPlat = "";
// -->
</SCRIPT>
<SCRIPT SRC="../../code/ver.js"></SCRIPT>


<SCRIPT DEFER SRC="../../code/common.js"></SCRIPT>
<SCRIPT DEFER>
//<!--
function InitPage()
{
	if (g_isIE && g_iMaj >= 4)	
	{
		SetTOC();
	}
}
//-->
</SCRIPT>

<LINK REL="stylesheet" HREF="/msdn/sdk/inetsdk/help/basicsdkIE4.css" TYPE="text/css">
<!-- STYLE_START -->


<SCRIPT>
//<!--
   var sVR = '../../'	// Set root for the style sheet
   var sCSS = '<LINK REL="stylesheet" HREF="' + sVR;

   if(g_isIE)
   {
	   if (g_iMaj >= 4) // For MSIE 4.0 or later
	   {
		   sCSS += 'basicSDKIE4';
		   if (g_sPlat == "Win") // Windows only for now
		   {
			   document.createStyleSheet(sVR + 'advSDKIE4.css');
		   }
	   }
	   else // For MSIE 3.0 or earlier
	   {
		   sCSS += 'basicSDKIE3';
	   }
   }
   else if (g_isNav) // For all Nav versions
   {
	   sCSS += 'basicSDKNAV';
   }
   else
   {
	   sCSS += 'basicSDKIE3'; // default to IE3 sheet
   }

   sCSS += (sCSS == '' ? '' : '.css" TYPE="text/css">');

   document.write(sCSS);
//-->
</SCRIPT>
<!-- STYLE_END -->
</HEAD>
<BODY onload="InitPage()" BGCOLOR="#FFFFFF">

<A NAME="pagetop"></A><A NAME="ch_script_engine"></A>
<!-- NAV_LINKS_START -->
<TABLE class=main BORDER=0 CELLSPACING="0" CELLPADDING="0" WIDTH="10%"><TR><TD ROWSPAN="3" VALIGN="TOP" WIDTH="121"><IMG SRC="../../art/headbar2.gif" WIDTH="121" HEIGHT="82" BORDER=0 ALT="ActiveX Scripting Engines"></TD><TD ROWSPAN="2" VALIGN="TOP" WIDTH="186"><IMG SRC="../../art/headbarc.gif" WIDTH="186" HEIGHT="44" BORDER=0 ALT="ActiveX Scripting Engines"></TD><TD VALIGN="TOP" WIDTH="470"><IMG SRC="../../art/replace1.gif" WIDTH="470" HEIGHT="17" BORDER=0 ALT="*"></TD></TR><TR><TD><PRE><IMG SRC="../../art/arrowrht.gif" WIDTH="14" HEIGHT="14" ALIGN="MIDDLE" BORDER=0 ALT="*"><object id="hhal_1" type="application/x-oleobject"
	classid="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
<PARAM name="Command" value="ALink">
<PARAM name="Item1" value="">
<PARAM name="Item2" value=_win32_Contents>
</object><A STYLE="color:black" ID=TOC HREF=JavaScript:hhal_1.Click()>Contents</A>  <IMG SRC="../../art/arrowrht.gif" WIDTH="14" HEIGHT="14" ALIGN="MIDDLE" BORDER=0 ALT="*"><object id="hhal_2" type="application/x-oleobject"
	classid="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
<PARAM name="Command" value="ALink">
<PARAM name="Item1" value="">
<PARAM name="Item2" value=_win32_Index_1sz1>
</object><A STYLE="color:black" HREF=JavaScript:hhal_2.Click()>Index</A>  <IMG SRC="../../art/arrowrht.gif" WIDTH="14" HEIGHT="14" ALIGN="MIDDLE" BORDER=0 ALT="*"><A STYLE="color:black" HREF="../compdev.htm#set_components">Topic Contents</A>
</PRE></TD></TR>
<TR><TD COLSPAN="2"><PRE><IMG SRC="../../art/arrowlft.gif" WIDTH="17" HEIGHT="15" ALIGN="MIDDLE" BORDER=0 ALT="*"><B>Previous Topic:</B> <A STYLE="color:black" HREF="../scripting/references/IActiveScriptSiteWindow_GetWindow.htm">IActiveScriptSiteWindow::GetWindow</A>
<IMG SRC="../../art/arrownxt.gif" WIDTH="17" HEIGHT="16" ALIGN="MIDDLE" BORDER=0 ALT="*"><B>Next Topic:</B> <A  STYLE="color:black" HREF="references/reference.htm">Scripting Engine Reference</A>
</PRE></TD></TR>
</TABLE>
<!-- NAV_LINKS_END -->
<BLOCKQUOTE class="body">
<!-- CONTENTS_START -->
<h1>ActiveX Scripting Engines</h1>

<P>To implement an ActiveX&#153; Scripting engine, create an OLE COM object that supports the following interfaces.

<TABLE>
<TR><TD><B>Interface
 </B></TD><TD><B>Description
</B></TD></TR><TR><TD><A HREF="references/IActiveScript.htm#IActiveScript">IActiveScript</A>
 </TD><TD>Provides the basic scripting ability. Implementation of this interface is required.
</TD></TR><TR><TD><A HREF="references/IActiveScriptParse.htm#IActiveScriptParse">IActiveScriptParse</A>
 </TD><TD>Provides the ability to add script text, evaluate expressions, and so on. Implementation of this interface is optional; however, if it is not implemented, the script engine must implement one of the <B>IPersist*</B> interfaces in order to load a script.
</TD></TR><TR><TD><B>IPersist*</B>
 </TD><TD>Provides persistence support. Implementation of at least one of the following interfaces is required if <A HREF="references/IActiveScriptParse.htm#IActiveScriptParse">IActiveScriptParse</A> is not implemented.
 <TABLE>
<TR><TD><B>Interface
 </B></TD><TD><B>Description
 </B></TD></TR><TR><TD><object id="hhal_3" type="application/x-oleobject"
	classid="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
<PARAM name="Command" value="ALink">
<PARAM name="Item1" value="">
<PARAM name="Item2" value=_win32_Further_Reading>
</object><A HREF=JavaScript:hhal_3.Click()>IPersistStorage</A>
 </TD><TD>Provides support for the <B>DATA=</B><I>{url}</I> attribute in the OBJECT tag.
 </TD></TR><TR><TD><object id="hhal_4" type="application/x-oleobject"
	classid="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
<PARAM name="Command" value="ALink">
<PARAM name="Item1" value="">
<PARAM name="Item2" value=_win32_Further_Reading>
</object><A HREF=JavaScript:hhal_4.Click()>IPersistStreamInit</A>
 </TD><TD>Provides support for the same as
<object id="hhal_5" type="application/x-oleobject"
	classid="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
<PARAM name="Command" value="ALink">
<PARAM name="Item1" value="">
<PARAM name="Item2" value=_win32_Further_Reading>
</object><A HREF=JavaScript:hhal_5.Click()>IPersistStorage</A> as well as the <B>DATA=</B><I>"string-encoded byte stream"</I> attribute in the OBJECT tag.
 </TD></TR><TR><TD><A HREF="../comobj/reference/IPersistPropertyBag.htm#IPersistPropertyBag">IPersistPropertyBag</A>
 </TD><TD>Provides support for the <B>PARAM=</B> attribute in the OBJECT tag.
 </TD></TR></TABLE>
</TD></TR></TABLE>

<P><B>Note</B>  It is possible that the scripting engine will never be called upon to save or restore a script state through <B>IPersist*</B>. Instead, <A HREF="references/IActiveScriptParse.htm#IActiveScriptParse">IActiveScriptParse</A> is used by calling <A HREF="references/IActiveScriptParse_InitNew.htm#IActiveScriptParse__">IActiveScriptParse::InitNew</A> to create a blank script, then scriptlets are added and connected to events with <A HREF="references/IActiveScriptParse_AddScriptlet.htm#IActiveScriptParse__">IActiveScriptParse::AddScriptlet</A> and general code is added with <A HREF="references/IActiveScriptParse_ParseScriptText.htm#IActiveScriptParse__">IActiveScriptParse::ParseScriptText</A>. Nonetheless, a scripting engine should fully implement at least one <B>IPersist*</B> interface (preferably
<object id="hhal_6" type="application/x-oleobject"
	classid="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
<PARAM name="Command" value="ALink">
<PARAM name="Item1" value="">
<PARAM name="Item2" value=_win32_Further_Reading>
</object><A HREF=JavaScript:hhal_6.Click()>IPersistStreamInit</A>), because other host applications may try to make use of them.

<P><A CLASS=tctop HREF="engines.htm#Registry_Standard"><IMG SRC="../../art/arrowg.gif" WIDTH="6" HEIGHT="11" BORDER=0 ALT="arrowg.gif">Registry Standard</A><BR>

<P><A CLASS=tctop HREF="engines.htm#Engine_States"><IMG SRC="../../art/arrowg.gif" WIDTH="6" HEIGHT="11" BORDER=0 ALT="arrowg.gif">Script Engine States</A><BR>

<P><A CLASS=tctop HREF="engines.htm#Scripting_Engine_Thr"><IMG SRC="../../art/arrowg.gif" WIDTH="6" HEIGHT="11" BORDER=0 ALT="arrowg.gif">Scripting Engine Threading</A><BR>

<P><A CLASS=tctop HREF="references/reference.htm#ref_engines"><IMG SRC="../../art/arrowg.gif" WIDTH="6" HEIGHT="11" BORDER=0 ALT="arrowg.gif">Scripting Engine Reference</A><BR>
<!--************************************************************--><!-- *************************************************************** --><h2><A NAME="Registry_Standard">Registry Standard</A></h2>

<P>An ActiveX Scripting engine can identify itself using component categories. ActiveX Scripting currently defines two component categories.

<TABLE>
<TR><TD><B>Category
 </B></TD><TD><B>Description
</B></TD></TR><TR><TD>CATID_ActiveScript
 </TD><TD>Indicates that the class identifiers (CLSIDs) are ActiveX Scripting engines that support, at a minimum, the <A HREF="references/IActiveScript.htm#IActiveScript">IActiveScript</A> interface and a persistence mechanism (the
<object id="hhal_7" type="application/x-oleobject"
	classid="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
<PARAM name="Command" value="ALink">
<PARAM name="Item1" value="">
<PARAM name="Item2" value=_win32_Further_Reading>
</object><A HREF=JavaScript:hhal_7.Click()>IPersistStorage</A>,
<object id="hhal_8" type="application/x-oleobject"
	classid="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
<PARAM name="Command" value="ALink">
<PARAM name="Item1" value="">
<PARAM name="Item2" value=_win32_Further_Reading>
</object><A HREF=JavaScript:hhal_8.Click()>IPersistStreamInit</A>, or <A HREF="../comobj/reference/IPersistPropertyBag.htm#IPersistPropertyBag">IPersistPropertyBag</A> interface).
</TD></TR><TR><TD>CATID_ActiveScriptParse
 </TD><TD>Indicates that the CLSIDs are ActiveX Scripting engines that support, at a minimum, the <A HREF="references/IActiveScript.htm#IActiveScript">IActiveScript</A> and <A HREF="references/IActiveScriptParse.htm#IActiveScriptParse">IActiveScriptParse</A> interfaces.
</TD></TR></TABLE>

<P>Although <A HREF="references/IActiveScriptParse.htm#IActiveScriptParse">IActiveScriptParse</A> is not a true persistence mechanism, it does support the <A HREF="references/IActiveScriptParse_InitNew.htm#IActiveScriptParse__">IActiveScriptParse::InitNew</A> method that is functionally equivalent to <B>IPersist*::InitNew</B>.

<!-- *************************************************************** -->
<!-- *************************************************************** -->
<h2><A NAME="Engine_States">Script Engine States</A></h2>

<P>At any given time, an ActiveX Scripting engine can be in one of several states.

<TABLE>
<TR><TD><B>State
 </B></TD><TD><B>Description

</B></TD></TR><TR><TD>uninitialized
 </TD><TD>The script has not been initialized or loaded using an <B>IPersist*</B> interface, or does not have an <A HREF="../scripting/references/IActiveScriptSite.htm#IActiveScriptSite">IActiveScriptSite</A> interface set. The scripting engine is generally not usable from this state until the script is loaded. 
</TD></TR><TR><TD>initialized
 </TD><TD>The script has been initialized with an <B>IPersist*</B> interface and has an <A HREF="../scripting/references/IActiveScriptSite.htm#IActiveScriptSite">IActiveScriptSite</A> interface set, but is not connected to host objects and sinking events. Note that this state simply means that the <B>IPersist*::Load</B>, <B>IPersist*::InitNew</B>, or <A HREF="references/IActiveScriptParse_InitNew.htm#IActiveScriptParse__">IActiveScriptParse::InitNew</A> method has been completed, and that the <A HREF="references/IActiveScript_SetScriptSite.htm#IActiveScript__SetSc">IActiveScript::SetScriptSite</A> method has been called. The engine cannot run code in this mode. The engine queues code that the host passes to it through the <A HREF="references/IActiveScriptParse_ParseScriptText.htm#IActiveScriptParse__">IActiveScriptParse::ParseScriptText</A> method, and executes the code after transitioning to the started state. 
 <P>Because languages can vary widely in semantics, scripting engines are not required to support this state transition. Engines that support the <A HREF="references/IActiveScript_Clone.htm#IActiveScript__Clone">IActiveScript::Clone</A> method must, however, support this state transition. Hosts must prepare for this transition and take the appropriate action: release the current scripting engine, create a new scripting engine, and call
<object id="hhal_9" type="application/x-oleobject"
	classid="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
<PARAM name="Command" value="ALink">
<PARAM name="Item1" value="">
<PARAM name="Item2" value=_win32_Further_Reading>
</object><A HREF=JavaScript:hhal_9.Click()>IPersist*::Load</A>,
<object id="hhal_10" type="application/x-oleobject"
	classid="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
<PARAM name="Command" value="ALink">
<PARAM name="Item1" value="">
<PARAM name="Item2" value=_win32_Further_Reading>
</object><A HREF=JavaScript:hhal_10.Click()>IPersist*::InitNew</A>, or <A HREF="references/IActiveScriptParse_InitNew.htm#IActiveScriptParse__">IActiveScriptParse::InitNew</A> (and possibly also call <A HREF="references/IActiveScriptParse_ParseScriptText.htm#IActiveScriptParse__">IActiveScriptParse::ParseScriptText</A>). Use of this transition should be considered an optimization of the above steps. Note that any information the scripting engine has obtained about the names of Named Items and the type information describing Named Items remains valid.

 <P>Because languages vary widely, defining the exact semantics of this transition is difficult. At a minimum, the scripting engine must disconnect from all events, and release all of the SCRIPTINFO_IUNKNOWN pointers obtained by calling the <A HREF="../scripting/references/IActiveScriptSite_GetItemInfo.htm#IActiveScriptSite__G">IActiveScriptSite::GetItemInfo</A> method. The engine must re-obtain these pointers after the script is run again. The scripting engine should also reset the script back to an initial state that is appropriate for the language. VBScript, for example, resets all variables and retains any code added dynamically by calling <A HREF="references/IActiveScriptParse_ParseScriptText.htm#IActiveScriptParse__">IActiveScriptParse::ParseScriptText</A> with the SCRIPTTEXT_ISPERSISTENT flag set. Other languages may need to retain current values (such as Lisp because there is no code/data separation) or reset to a well-known state (this includes languages with statically initialized variables). 

 <P>Note that the transition to the started state should have the same semantics (that is, it should leave the scripting engine in the same state) as calling <B>IPersist*::Save</B> to save the scripting engine, and then calling <B>IPersist*::Load</B> to load a new scripting engine; these actions should have the same semantics as <A HREF="references/IActiveScript_Clone.htm#IActiveScript__Clone">IActiveScript::Clone</A>. Scripting engines that do not yet support <B>IActiveScript::Clone</B> or <B>IPersist*</B> should carefully consider how the transition to the started state should behave, so that such a transition would not violate the above conditions if <B>IActiveScript::Clone</B> or <B>IPersist*</B> support was later added.

 <P>During this transition to the started state, the scripting engine will disconnect from event sinks after the appropriate destructors, and so on, are executed in the script. To avoid having these destructors executed, the host can first move the script into the disconnected state before moving into the started state.

 <P>Use <A HREF="references/IActiveScript_InterruptScriptThread.htm#IActiveScript__Inter">IActiveScript::InterruptScriptThread</A> to cancel a running script thread without waiting for current events, and so on, to finish running. </TD></TR><TR><TD>started
 </TD><TD>The transition from the initialized state to the started state causes the engine to execute any code that was queued in the initialized state. The engine can execute code while in the started state, but it is not connected to any events added through the <A HREF="references/IActiveScript_AddNamedItem.htm#IActiveScript__AddNa">IActiveScript::AddNamedItem</A> method. The engine can execute code by calling the <A HREF="../idispatchex/references/IDispatch.htm#IDispatch">IDispatch</A> interface obtained from the <A HREF="references/IActiveScript_GetScriptDispatch.htm#IActiveScript__GetSc">IActiveScript::GetScriptDispatch</A> method, or by calling <A HREF="references/IActiveScriptParse_ParseScriptText.htm#IActiveScriptParse__">IActiveScriptParse::ParseScriptText</A>. It is possible that further background initialization (progressive loading) is still ongoing, and that calling the <A HREF="references/IActiveScript_SetScriptState.htm#IActiveScript__SetSc">IActiveScript::SetScriptState</A> method with the SCRIPTSTATE_CONNECTED flag set may cause the script to block until initialization is complete.</TD></TR><TR><TD>connected
 </TD><TD>The script is loaded and connected for sinking events from host objects. If this is a transition from the initialized state, the scripting engine should transition through the started state, performing the necessary actions, before entering the connected state and connecting to events.</TD></TR><TR><TD>disconnected
 </TD><TD>The script is loaded and has a run-time state, but is temporarily disconnected from sinking events from host objects. This can be done either logically (ignoring events received) or physically (calling
<object id="hhal_11" type="application/x-oleobject"
	classid="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
<PARAM name="Command" value="ALink">
<PARAM name="Item1" value="">
<PARAM name="Item2" value=_win32_Further_Reading>
</object><A HREF=JavaScript:hhal_11.Click()>IConnectionPoint::Unadvise</A> on the appropriate connection points). If this is a transition from the initialized state, the scripting engine should transition through the started state, performing the necessary actions, before entering the disconnected state. Event sinks that are in progress are completed before the state changes (use <A HREF="references/IActiveScript_InterruptScriptThread.htm#IActiveScript__Inter">IActiveScript::InterruptScriptThread</A> to cancel a running script thread). This state is distinguished from the initialized state in that the transition to this state does not cause the script to reset, the run-time state of the script is not reset, and a script initialization procedure is not executed.</TD></TR><TR><TD>closed
 </TD><TD>The script has been closed. The scripting engine no longer works and returns errors for most methods.
</TD></TR></TABLE>

<P>The following illustration shows the relationships between the various scripting engine states, and shows the methods that cause transitions from one state to another.

<P>

<P><IMG SRC="../../art/olescr02.gif" WIDTH="386" HEIGHT="299" ALT="" >

<P> 

<P>The following illustration shows the actions that the scripting engine performs during the various state transitions.

<P>

<P><IMG SRC="../../art/olescr03.gif" WIDTH="390" HEIGHT="358" ALT="" >

<P>
<!-- *************************************************************** -->
<!-- *************************************************************** -->
<h2><A NAME="Scripting_Engine_Thr">Scripting Engine Threading</A></h2>

<P>Because an ActiveX Scripting engine can be used in many environments, it is important to keep its execution model as flexible as possible. For example, a server-based host may need to preserve a multithreaded design while using ActiveX Scripting in an efficient manner. At the same time, a host that does not use threading, such as a typical application, should not be burdened with threading management. ActiveX Scripting achieves this balance by restricting the ways a free-threaded scripting engine can call back to the host, freeing hosts from this burden. 

<P>Scripting engines used on servers are typically implemented as free-threading COM objects. This means that methods on the <A HREF="references/IActiveScript.htm#IActiveScript">IActiveScript</A> interface and its associated interfaces can be called from any thread in the process, without marshaling. (Unfortunately, this also means that the scripting engine must be implemented as an in-process server, because OLE does not currently support interprocess marshaling of free-threaded objects.) Synchronization is the responsibility of the scripting engine. For scripting engines that are not internally reentrant, or for language models that are not multithreaded, synchronization could be as simple as serializing access to the scripting engine with a mutex. Of course certain methods, such as <A HREF="references/IActiveScript_InterruptScriptThread.htm#IActiveScript__Inter">IActiveScript::InterruptScriptThread</A>, should not be serialized in this way so that a stuck script can be terminated from another thread.

<P>The fact that <A HREF="references/IActiveScript.htm#IActiveScript">IActiveScript</A> is typically free-threaded generally implies that the <A HREF="../scripting/references/IActiveScriptSite.htm#IActiveScriptSite">IActiveScriptSite</A> interface and the host's object model should be free-threaded as well. This would make implementation of the host quite difficult, particularly in the common case where the host is a single-threaded Microsoft Windows&#174;-based application with single-threaded or apartment-model ActiveX Controls in its object model. For this reason, the following constraints are placed on the scripting engine's use of <B>IActiveScriptSite</B>:

<UL>
<LI>The script site is always called in the context of a host thread. That is, the scripting engine never calls the script site in the context of a thread that the scripting engine created, but only from within a scripting engine method that was called from the host through <A HREF="references/IActiveScript.htm#IActiveScript">IActiveScript</A> and its derivatives, through the exposed scripting engine's dispatch object, through a Windows message, or from an event source in the host's object model. 
<LI>The script site is never called from within the context of a simple thread state control method (for example, the <A HREF="references/IActiveScript_InterruptScriptThread.htm#IActiveScript__Inter">IActiveScript::InterruptScriptThread</A> method) or from the <A HREF="references/IActiveScript_Clone.htm#IActiveScript__Clone">IActiveScript::Clone</A> method.
</UL>
<!-- *************************************************************** --><!-- *************************************************************** --><!-- CONTENTS_END -->
<!-- START PAGE FOOTER -->
<H6><HR size=1></H6>
<P><A ID=line HREF="#pagetop"><IMG src="../../art/arrowup1.gif" WIDTH="17" HEIGHT="16" ALIGN="MIDDLE" BORDER="0" ALT="Up">&nbsp;Top of Page</A>
<BR><A ID=line HREF="http://www.microsoft.com/misc/cpyright.htm" TARGET="_top">&#169; 1997 Microsoft Corporation. All rights reserved. Terms of Use.</A>
<!-- END PAGE FOOTER -->
</BLOCKQUOTE>
</BODY>
</HTML>
