<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<HTML dir=ltr>
<HEAD>
<META HTTP-EQUIV="Content-Type" Content="text/html; charset=Windows-1252">
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-83731338-2"></script><script>  window.dataLayer = window.dataLayer || [];  function gtag(){dataLayer.push(arguments);}  gtag('js', new Date());  gtag('config', 'UA-83731338-2');</script><title>Building an ISO7816-4 ADPU Command</title>
<link disabled rel=stylesheet href=../../backsdk3.css>
<style type="text/css">
@import url(../../backsdk4.css);
</style>
</HEAD>
<BODY BGCOLOR = #FFFFFF TEXT = #000000>

<h2><a name="_smart_building_an_iso7816_4_adpu_command"></a>Building an ISO7816-4 ADPU Command</h2>
<p>
To add functionality to a service provider, you need to know how an ISO7816-4 ADPU is built within the base service provider DLLs. The following procedure gives a brief overview of the build process.</p>
<p>
<b>Note</b>  The code segments included here are not necessarily complete; refer to the example applications and DLLs for more information.</p>
<h5><img src="../../images/wedge.gif" border=0>&nbsp;&nbsp;&nbsp;&nbsp;To Build an ISO7816-4 APDU Command</h5>
<ol>
<li>
Create an instance of <a href="scspint1_35lw.htm"><b>ISCardCmd</b></a> and <a href="scspint4_1trq.htm"><b>ISCardISO7816</b></a> interface/objects. <p>

<pre><code>// Create an ISCardCmd object
// Note: To use CoCreateInstance on Windows 95, make sure no Distributed COM 
// flags are included in the API call or during build. Do not define flags
// _WIN32_DCOM or _WIN32_WINNT &gt;= 0x0400.
        hresult = CoCreateInstance(    CLSID_CSCardCmd,
                        NULL,
                        CLSCTX_ALL,
                        IID_ISCardCmd,
                        (LPVOID*) &amp;g_pISCardCmd);
    //Create an ISCardISO7816 object
    hresult = CoCreateInstance(    CLSID_CSCardISO7816,
                        NULL,
                        CLSCTX_ALL,
                        IID_ISCardISO7816,
                        (LPVOID*) &amp;g_pISCardISO7816);
 </code></pre>
<p>
The <b>ISCardCmd</b> object contains two IByteBuffer buffers. One buffer contains the actual <a href="scgloss_7mw1.htm#_smart_apdu_gly">APDU</a> command string (plus any data to send with the command). The other contains any reply information returned by the card after command execution.
</li>
<li>
Using these objects, we can now create a valid ISO7816-4 command as follows:<pre><code>// Do challenge
        hresult = g_pISCardISO7816-&gt;GetChallenge(    dwLengthOfChallenge,
                                &amp;g_pISCardCmd);
 </code></pre>
<p>
Here is the code used in the <b>GetChallenge</b> method:
<pre><code>STDMETHODIMP CSCardISO7816::GetChallenge(    IN DWORD dwBytesExpected /*= 0*/,
                                IN OUT LPSCARDCMD *ppCmd)
{
    // Locals.
    HRESULT hr = S_OK;
    
    try
    {
        // Is the ISCardCmd object ok?
        hr = IsSCardCmdValid(ppCmd);
        if (FAILED(hr))
            throw (hr);

                // Do it!
        hr = (*ppCmd)-&gt;BuildCmd(    m_byClassId,
                                (BYTE) INS_GET_CHALLENGE),
                                (BYTE) INS_NULL),// P1 = 0x00
                                (BYTE) INS_NULL),// P2 = 0x00
                        NULL,
                                &amp;dwBytesExpected);
        if (FAILED(hr))
            throw (hr);        
    }
 </code></pre>
<p>
The <a href="scspint4_1h2d.htm"><b>ISCardISO7816::GetChallenge</b></a> method simply uses the <a href="scspint1_6jl0.htm"><b>ISCardCmd::BuildCmd</b></a> to build the requested APDU. This is done by writing the appropriate information into the <b>ISCardCmd</b> APDU buffer in the <i>hr = (*ppCmd)-&gt;BuildCmd</i> line above.
</li>
<li>
Using the built <b>ISCardCmd</b> object, do a transaction with the card, interpret the results, and continue.</li>
</ol>
<h4>Expanding beyond ISO7816-4</h4>
<p>
The recommended way to expand the service provider build-execute process described above is to create a new COM object. This COM object should support a new interface that allows creation of non-ISO7816-4 commands and should aggregate the ISCardISO7816 interface.</p>
<p>&nbsp;</p></body>
</HTML>
