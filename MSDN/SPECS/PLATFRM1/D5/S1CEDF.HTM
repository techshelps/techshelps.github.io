<HTML><HEAD><META HTTP-EQUIV="Content-Type" Content="text/html; charset=Windows-1252"><script async src="https://www.googletagmanager.com/gtag/js?id=UA-83731338-2"></script><script>  window.dataLayer = window.dataLayer || [];  function gtag(){dataLayer.push(arguments);}  gtag('js', new Date());  gtag('config', 'UA-83731338-2');</script><title>2.1 COM Enumerator Detection</TITLE><style>@import url(msdn_ie4.css);</style>
<link disabled rel="stylesheet" href="msdn_ie3.css"></HEAD><BODY BGCOLOR="#FFFFFF">

</OBJECT></FORM>
<H2>2.1 COM Enumerator Detection</H2>  </P>
The COM Enumerator software shall do the following things visible on the COM port:</P>
<SPAN CLASS="list"><UL><LI>Initialize the COM port, with DTR ON , RTS OFF, and TXD set to Mark Idle.</LI><LI>Wait for DSR=1 to indicate presence of COM device.</LI><LI>Stimulate the COM port control leads in a defined manner.</LI><LI>Collect the ID information if available.</LI></UL></SPAN>(Optional) Monitor the port when idle to detect device attach/detach.</P>
The COM Enumerator will make two attempts to elicit a PnP ID:</P>
<SPAN CLASS="list"><UL><LI>First, it will try a means with a DTR-RTS time signature, so that devices like modems (which have traditional uses for DTR and RTS) are not confused.</LI><LI>If the first try does not generate a reponse, it will assume it is a device that will begin to respond within 200ms of being powered (e.g. COM port powered mice, non-modems).</LI></UL></SPAN>The entire interval can be drawn as follows:</P>
<B>Figure 1 - Example COM Enumerator External Timing Diagram</B></P>
  </P>
<BR></P>
<pre><code>interval----&gt;|check|&lt;---1st---&gt;|&lt;1st&gt;|&lt;2nd&gt;|&lt;2nd&gt;|&lt;--Idle----
             | dev |   Setup   | Wait|Setup| Wait|
             |     |     |     |     |     |     |
time         |  T1 |  T2 |  T3 |  T4 |  T2 |  T4 |
             ______       ___________       _____________
DTR(108)  XXX      \_____/           \_____/        
             |     |     |     |     |     |     |
                                _____       _____
RTS(105)  XXX__________________/     \_____/     \_________
             |     |           |     |     |
reference    |2.1.2|   2.1.3   |2.1.4|2.1.5|2.1.6|</code></pre>
  </P>
T1: minimum interval to hold DTR high while waiting for DSR</P>
T2: minimum interval for external device to power down or detect the port state</P>
T3: DTR-RTS enumerator signature delay  </P>
T4: maximum interval to wait for DSR and/or first received character</P>
T5: PNP COM ID per/character timeout (not shown)</P>
T6: PNP COM ID EndPNP timeout (not shown)</P>
T7: Disconnect Verification timout (not shown)</P>
  </P>
<B>Note</B>   Figure 1 is drawn with characters to survive translation to plain ASCII.</P>
  </P>
<A NAME="PT2"></A>2.1.1 COM port initialization, check for port availible</P>
<SPAN CLASS="list"><UL><LI>Attempt to acquire the port via defined operating system services.</LI><LI>If the port is busy (e.g. the modem or mouse is in use), don't enumerate this port.</LI></UL></SPAN>If the port IRQ is in use by another device driver, don't enumerate this port.</P>
<A NAME="PT3"></A>2.1.2 COM port initialization, check for device enumerate</P>
<SPAN CLASS="list"><UL><LI>leave TXD = mark idle.</LI><LI>set DTR=1, set RTS=0, start T1 = 200 ms (+/- 35 ms tolerance).</LI><LI>If T1 expires and DSR=0, go to Disconnect Idle.</LI><LI>else, go to Com port Setup, 1st phase.</LI></UL></SPAN><A NAME="PT4"></A>2.1.3 COM port Setup, 1st phase</P>
<SPAN CLASS="list"><UL><LI>Set the serial port for 1200 bit/s, 7 data bits, no parity, one stop bit.</LI><LI>set DTR=0, set RTS=0, start T2 = 200 ms (+/- 35 ms tolerance).</LI><LI>When T2 expires, set DTR=1, start T3 = 200 ms (+/- 35 ms tolerance).</LI><LI>When T3 expires go to Wait for response, 1st phase.</LI></UL></SPAN><A NAME="PT5"></A>2.1.4 Wait for response, 1st phase</P>
<SPAN CLASS="list"><UL><LI>set RTS=1, start T4 = 200 ms (+/- 35 ms tolerance).</LI><LI>If any character received, go to Collect PnP COM device ID(s).</LI><LI>If T4 expires and no character received, go to COM Port Setup, 2nd Phase.</LI></UL></SPAN><A NAME="PT6"></A>2.1.5 COM port Setup, 2nd phase</P>
<SPAN CLASS="list"><UL><LI>Set DTR=0, RTS=0, start T2 200ms (+/- 35 ms tolerance).</LI><LI>When T2 expires go to Wait for response, 2nd phase</LI></UL></SPAN><A NAME="PT7"></A>2.1.6 Wait for response, 2nd phase</P>
<SPAN CLASS="list"><UL><LI>set DTR=1 and RTS=1, start T4 = 200 ms (+/- 35 ms tolerance).</LI><LI>If any character received, go to Collect PnP COM device ID(s)</LI><LI>If T4 expires and DSR=0, go to Verify Disconnect</LI><LI>If T4 expires and DSR=1, go to Connect Idle</LI></UL></SPAN><A NAME="PT8"></A>2.1.7 Collect PnP COM device ID(s)</P>
<SPAN CLASS="list"><UL><LI>Set T5 = 200ms (-0ms/+40ms), for per-character timeout.</LI><LI>Set T6= 2.2 seconds; (256 char x 10bits/char)/(1200 bit/s) = 2.13 seconds.</LI><LI>Receive and buffer any characters (see section 3.3 and section 4).  Each time a new character is received, reset T5=200ms.</LI><LI>If bit errors or framing errors are detected after the first character go to Connect Idle.</LI><LI>If T5 expires after the first character, check for valid PnP ID string.  If valid notify appropriate operating system service of the new device.  If invalid go to Connect Idle.</LI><LI>If <B>End ID</B> character detected, check for valid PnP ID string.  If valid notify appropriate operating system service of the new device.  If invalid go to Connect Idle.</LI><LI>If T4 expires without <B>Begin ID</B> character detection go to Connect Idle.</LI><LI>If T6 expires without <B>End ID</B> character detection go to Connect Idle.</LI><LI>If DSR=0, go to Verify Disconnect.</LI></UL></SPAN><A NAME="PT9"></A>2.1.8 Verify Disconnect</P>
This step verifies that the device has actually been removed.  This accounts for modems and other devices that lower DSR briefly when DTR drops in order to reset, etc.  The enumerator assumes the device is not present if DSR is low after a timeout.</P>
<SPAN CLASS="list"><UL><LI>Set DTR=1; set RTS=0.</LI><LI>Set T7 = 5 seconds.</LI><LI>When T7 expires, if DSR=1 go to Disconnect Idle.</LI><LI>IF T7 expires and DSR=0, go to Disconnect Idle.</LI></UL></SPAN><A NAME="PT10"></A>2.1.9 Connect Idle</P>
<SPAN CLASS="list"><UL><LI>Set DTR=1; set RTS=0.</LI><LI>Set the serial port for 300 bit/s, 7 data bits, No parity, one stop bit.</LI><LI>Wait (forever): If DSR=0, notify appropriate operating system service of device removal, go to Disconnect Idle.</LI><LI>(Optional)  Monitor port for events caused by miscellaneous non-Plug and Play devices, e.g. GIDEI input devices (not documented here).</LI></UL></SPAN>  </P>
<B>Note</B>   GIDEI = General Input Device Emulating Interface.  These devices are used to provide accessibility for some computer users with disabilities.</P>
  </P>
<A NAME="PT11"></A>2.1.10 Disconnect Idle</P>
This step is optional, if the enumerator software is going to monitor idle ports for dynamic device removal, or attempt to detect non-Plug and Play devices.</P>
<SPAN CLASS="list"><UL><LI>Notify appropriate operating system service of device removal, if a device was previously present.  </LI><LI>Set DTR=1; set RTS=0.</LI><LI>Set the serial port for 300 bit/s, 7 data bits, No parity, one stop bit.</LI><LI>Wait (forever): If DSR=1, go to COM port Setup, first phase.</LI><LI>(Optional)  Monitor port for events caused by miscellaneous non-Plug and Play devices.</LI></UL></SPAN> </P></BODY></HTML>
