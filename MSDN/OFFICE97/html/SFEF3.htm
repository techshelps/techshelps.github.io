<HTML><HEAD><script async src="https://www.googletagmanager.com/gtag/js?id=UA-83731338-2"></script><script>  window.dataLayer = window.dataLayer || [];  function gtag(){dataLayer.push(arguments);}  gtag('js', new Date());  gtag('config', 'UA-83731338-2');</script><title>Advanced Flow Control in Macro Sheets</TITLE><META HTTP-EQUIV="CONTENT-TYPE" CONTENT="text/html; charset= iso-8859-1"><style>@import url(msdn_ie4.css);</style>
<link disabled rel="stylesheet" href="msdn_ie3.css"></HEAD><BODY bgcolor="#FFFFFF" link=#003399 vlink=#996699><FONT FACE="Verdana, Arial, Helvetica" SIZE="2">
	<FONT FACE="Verdana, Arial, Helvetica" SIZE="2">
<FORM NAME="x"><OBJECT CLASSID="clsid:9c2ac687-ceef-11cf-96d9-00a0c903b016" NAME="iv"></OBJECT></FORM>
<H1>Advanced Flow Control in Macro Sheets </H1><P CLASS="t">Ordinarily, when Microsoft Excel runs a macro, it does so by evaluating successive cells, one at a time, from top to bottom. However, simple top-to-bottom execution does not allow for any of the flow-control constructs that are essential in a high-level language. Microsoft Excel solves this problem by using the flow-control XLOPER, named xltypeFlow. If a function on the sheet returns a flow-control XLOPER, then instead of going on to the next cell, Microsoft Excel executes the flow-control command contained in that XLOPER.</P>
<P CLASS="a">    <img src="CH07_22.gif"></P>
<P CLASS="t">This is how Microsoft Excel controls all flow on macro sheets. It means that functions such as GOTO and RETURN can be implemented as first-class functions. Therefore, you can write your own versions of GOTO and HALT. This&nbsp;capability also explains how statements such as the following work:</P>
<P CLASS="t">=IF(Boolean,GOTO(A3),GOTO(A4))</P>
<P></P>
<P></P>
<P></P>
<P CLASS="t">This capability allows you to write and understand flow-control functions. For example, suppose you want a function that checks the sign of a number and then performs one action if the sign is negative, another action if it is zero, and yet another action if it is positive. The macro could look like the following example.</P>
<P CLASS="a">    <img src="CH07_23.gif"></P>
<P CLASS="t">You can use flow-control XLOPERs to write this function, as shown in the following code example.</P>

<pre><code><FONT FACE="Courier" SIZE="2">#include &lt;windows.h&gt;
#include &lt;xlcall.h&gt;

LPXLOPER WINAPI SwitchSign(double d, LPXLOPER pxNeg,
    LPXLOPER pxZero, LPXLOPER pxPos)
{
    // pxNeg, pxZero, and pxPos must be local references.

    static XLOPER xGoto, xError, xSheet;
    LPXLOPER pxChosen;

    if (d &lt; 0)
        pxChosen = pxNeg;
    else if (d == 0)
        pxChosen = pxZero;
    else
        pxChosen = pxPos;

    if (pxChosen-&gt;xltype != xltypeSRef)     
    {
        xError.xltype = xltypeErr;
        xError.val.err = xlerrValue;
        return &amp;xError;
    }
</FONT></code></pre>
<P></P>
<P></P>
<P></P>

<pre><code><FONT FACE="Courier" SIZE="2">    // Figure out the Sheet ID of the current sheet, which we need
    // to make xGoto

    Excel4(xlSheetId, &amp;xSheet, 0);

    xGoto.xltype = xltypeFlow;
    xGoto.val.flow.xlflow = xlflowGoto;
    xGoto.val.flow.valflow.idSheet = xSheet.val.mref.idSheet;
    xGoto.val.flow.rw = pxChosen-&gt;val.sref.ref.rwFirst;
    xGoto.val.flow.col = pxChosen-&gt;val.sref.ref.colFirst;

    return &amp;xGoto;
}
</FONT></code></pre>
<P CLASS="t">This sample code is in the SWITCHSN directory or SwitchSn folder.</P>
<P></P>
<P CLASS="nh"><B>Note</B></P>
<P CLASS="nt">You can return flow control XLOPERs from your C functions, and you can pass them to Excel4. The only thing you can't do with flow-control XLOPERs is pass them into C functions from Microsoft Excel. In other words, you cannot pass the return value from the GOTO function to one of your own functions. This means you can't write IF in C.</P>
<P></P></FONT>
</FONT></BODY></HTML>
