<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<HTML dir=ltr>
<HEAD>
<META HTTP-EQUIV="Content-Type" Content="text/html; charset=Windows-1252">
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-83731338-2"></script><script>  window.dataLayer = window.dataLayer || [];  function gtag(){dataLayer.push(arguments);}  gtag('js', new Date());  gtag('config', 'UA-83731338-2');</script><title>RAS and Authentication Protocol Interaction During Authentication</title>
<link disabled rel=stylesheet href=../../backsdk3.css>
<style type="text/css">
@import url(../../backsdk4.css);
</style>
</HEAD>
<BODY BGCOLOR = #FFFFFF TEXT = #000000>

<h2><a name="_mpr_ras_and_authentication_protocol_interaction_during_authentication"></a>RAS and Authentication Protocol Interaction During Authentication</h2>
<p>
<span style=color:#FF0000>[This is preliminary documentation and subject to change.]</span> </p>
<p>
The <a href="eapref_2tgl.htm"><b>RasEapMakeMessage</b></a> function, is where the majority of the interaction takes place between the authentication protocol and the RAS Connection Manager Service. <b>RasEapMakeMessage</b> is used to process incoming EAP packets and to create EAP packets for transmission to the remote peer. It is also used to process events such as timeouts and authentication completion.</p>
<p>
If a message is received from the remote peer, RAS will call <b>RasEapMakeMessage</b>, with the <i>pReceivePacket</i> parameter pointing to the received message. </p>
<p>
If RAS calls <a href="eapref_2tgl.htm"><b>RasEapMakeMessage</b></a> with <i>pReceivePacket</i> set to NULL, RAS is either initiating the dialog with the authentication protocol, or requesting that the protocol resend the last packet. The authentication protocol should determine which is the case from its state and from the message context.</p>
<p>
On return from the <a href="eapref_2tgl.htm"><b>RasEapMakeMessage</b></a> call, the value of the <b>Action</b> member of the <a href="eapref_94xg.htm"><b>PPP_EAP_OUTPUT</b></a> structure indicates what action, if any, the RAS Connection Manager should take. The <b>Action</b> member takes values from the <a href="eapref_9mpa.htm">PPP_EAP_ACTION</a> enumerated type.</p>
<p>
If <b>Action</b> is <b>EAPACTION_Send</b>, <b>EAPACTION_SendAndDone</b>, <b>EAPACTION_SendWithTimeout</b>, or <b>EAPACTION_SendWithTimeoutInteractive</b>, the RAS Connection Manager will transmit the packet pointed to by the <i>pSendPacket</i> parameter to the remote peer. </p>
<p>
If <b>Action</b> is <b>EAPACTION_SendWithTimeout</b>, or <b>EAPACTION_SendWithTimeoutInteractive</b>, the authentication protocol should set the <b>dwIdExpected </b>member of the <a href="eapref_94xg.htm"><b>PPP_EAP_OUTPUT</b></a> structure to the identifier of the next packet expected from the remote peer. Regardless of whether the next packet received from the peer matches this value, RAS will pass the packet to the authentication protocol in a subsequent call to <b>RasEapMakeMessage</b>. The authentication protocol may silently discard the packet by simply returning ERROR_PPP_INVALID_PACKET. If a packet with the expected identifier, is not received within the configured timeout period, RAS will call <b>RasEapMakeMessage</b> with <i>pReceivePacket</i> set to NULL, to indicate that the previous packet needs to be resent.</p>
<p>
The <b>EAPACTION_SendWithTimeout</b> value allows for a timeout, after which the RAS Connection Manager Service will assume the link was lost, and the session will be disconnected. The <b>EAPACTION_SendWithTimeoutInteractive</b> value allows an infinite amount of timeout to occur. The authenticator should use this value when expecting user input on the client. This timeout allows the user an unspecified amount of time to complete the required input.</p>
<p>
If the <b>Action</b> member is <b>EAPACTION_Done</b> or <b>EAPACTION_SendAndDone</b>, RAS will examine the <b>dwAuthResultCode</b> member of <a href="eapref_94xg.htm"><b>PPP_EAP_OUTPUT</b></a>. If <b>dwAuthResultCode</b> is NO_ERROR, the authentication succeeded. If <b>dwAuthResultCode</b> is a value other than NO_ERROR, the authentication failed. The error code returned for the failure case should come from raserror.h, mprerror.h, or winerror.h. Possible return codes include (but aren't limited to): ERROR_NO_DIALIN_PERMISSION, ERROR_PASSWD_EXPIRED, ERROR_ACCT_DISABLED, ERROR_RESTRICTED_LOGON_HOURS or ERROR_AUTH_INTERNAL.</p>
<p>
The EAP success packet is a non-acknowledged packet. Therefore, it may be lost and not resent by the server. If the RAS Connection Manager on the client receives an NCP packet, RAS will assume that authentication was successful, but that the EAP success packet was lost, since the server has moved on to the NCP phase of PPP. In this case, RAS will call <a href="eapref_2tgl.htm"><b>RasEapMakeMessage</b></a> with the <b>fSuccessPacketReceived</b> member of the <a href="eapref_9xo4.htm"><b>PPP_EAP_INPUT</b></a> structure to TRUE. </p>
<p>
Upon successful authentication, the authentication protocol on the server (the authenticator) should set the value of the <b>szIdentity</b> member of the <a href="eapref_94xg.htm"><b>PPP_EAP_OUTPUT</b></a> structure. This value represents the identity of the authenticated user on the server.</p>
<p>
During the course of the authentication session, the authentication protocol may need to interact directly with the user on the client. The authentication protocol vendor can provide an interactive user interface for this purpose. The authentication protocol can request that RAS display the interactive UI by setting the <b>fInvokeInteractiveUI</b>, <b>pUIContextData</b>, and <b>dwSizeOfUIContextData</b> members in the <a href="eapref_94xg.htm"><b>PPP_EAP_OUTPUT</b></a> structure. For more information on using an interactive UI, see <a href="eapover_7w6d.htm">Interactive User Interface</a>.</p>
<p>
If during the authentication process, <a href="eapref_2tgl.htm"><b>RasEapMakeMessage</b></a> returns any value other than NO_ERROR or ERROR_PPP_INVALID_PACKET, the session will be disconnected and the error will be logged (on the server) or displayed to the user (on the client). </p>
<p>&nbsp;</p></body>
</HTML>
