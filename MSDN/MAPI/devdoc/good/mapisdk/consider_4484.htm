<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<HTML dir=ltr>
<HEAD>
<META HTTP-EQUIV="Content-Type" Content="text/html; charset=Windows-1252">
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-83731338-2"></script><script>  window.dataLayer = window.dataLayer || [];  function gtag(){dataLayer.push(arguments);}  gtag('js', new Date());  gtag('config', 'UA-83731338-2');</script><title>Sending or Receiving a Message on Demand</title>
<link disabled rel=stylesheet href=../../backsdk3.css>
<style type="text/css">
@import url(../../backsdk4.css);
</style>
</HEAD>
<BODY BGCOLOR = #FFFFFF TEXT = #000000>

<h2><a name="_mapi1book_sending_or_receiving_a_message_on_demand"></a>Sending or Receiving a Message on Demand</h2>
<p>
Clients typically rely on the MAPI subsystem — the MAPI spooler and the service providers — to handle the timing of message transmission and reception. However, you can alter this timing by using the status object of either the MAPI spooler or a transport provider. The <a href="inter024_8c37.htm"><b>IMAPIStatus::FlushQueues</b></a> method removes all messages from one or more transport provider's incoming or outgoing queues. The following procedures describe two techniques for sending or receiving messages on demand. The first procedure uses the MAPI spooler's status object to flush the queues of every transport provider in the profile; the second procedure flushes the queue of a single transport provider.</p>
<h5><img src="../../images/wedge.gif" border=0>&nbsp;&nbsp;&nbsp;&nbsp;To flush all incoming or outgoing queues in a single operation</h5>
<ol>
<li>
Call <a href="inter023_04md.htm"><b>IMAPISession::GetStatusTable</b></a> to access the status table.</li>
<li>
Call the status table's <a href="inter026_7x83.htm"><b>IMAPITable::SetColumns</b></a> method to limit the column set to <a href="propa_8cv8.htm">PR_ENTRYID</a> and <a href="propb_0oh1.htm">PR_RESOURCE_TYPE</a>.</li>
<li>
Build a property restriction using an <a href="structyp_6fxq.htm"><b>SPropertyRestriction</b></a> structure to match PR_RESOURCE_TYPE with MAPI_SPOOLER. </li>
<li>
Call <a href="function_0dgz.htm"><b>HrQueryAllRows</b></a>, passing in the <a href="structyp_6fxq.htm"><b>SPropertyRestriction</b></a> structure, to retrieve the row that represents the status of the MAPI spooler.</li>
<li>
Pass the <a href="propa_8cv8.htm">PR_ENTRYID</a> column to <a href="inter023_146x.htm"><b>IMAPISession::OpenEntry</b></a> to open the MAPI spooler's status object.</li>
<li>
Call the MAPI spooler's <a href="inter024_8c37.htm"><b>IMAPIStatus::FlushQueues</b></a> method, passing the FLUSH_NO_UI flag to suppress the user interface and either the FLUSH_DOWNLOAD or FLUSH_UPLOAD flag to flush the outgoing or incoming queues. </li>
<li>
Release the status object and the status table, as well as the <a href="structyp_2378.htm"><b>SRowSet</b></a> structure that is allocated for the table.</li>
</ol>
<h5><img src="../../images/wedge.gif" border=0>&nbsp;&nbsp;&nbsp;&nbsp;To flush incoming or outgoing queues individually by transport provider</h5>
<ol>
<li>
Call <a href="inter023_04md.htm"><b>IMAPISession::GetStatusTable</b></a> to access the status table.</li>
<li>
Call the status table's <a href="inter026_7x83.htm"><b>IMAPITable::SetColumns</b></a> method to limit the column set to <a href="propa_8cv8.htm">PR_ENTRYID</a> and <a href="propb_0oh1.htm">PR_RESOURCE_TYPE</a>.</li>
<li>
Build a property restriction using an <a href="structyp_6fxq.htm"><b>SPropertyRestriction</b></a> structure to match <a href="propb_0oh1.htm">PR_RESOURCE_TYPE</a> with MAPI_TRANSPORT_PROVIDER. </li>
<li>
Call <a href="function_0dgz.htm"><b>HrQueryAllRows</b></a>, passing in the <b>SPropertyRestriction</b> structure, to retrieve the rows that are supplied by transport providers.</li>
<li>
For each row returned from <b>HrQueryAllRows</b>:<ol type=a>
<li>
Pass the PR_ENTRYID column to <a href="inter023_146x.htm"><b>IMAPISession::OpenEntry</b></a> to open the transport provider's status object.</li>
<li>
Check that the transport status object supports the <b>FlushQueues</b> method by checking that its <a href="propb_3lkj.htm">PR_RESOURCE_METHODS</a> property has the STATUS_FLUSH_QUEUES flag set. </li>
<li>
If supported, call <a href="inter024_8c37.htm"><b>IMAPIStatus::FlushQueues</b></a>. If unsupported, call the MAPI spooler's <b>IMAPIStatus::FlushQueues</b> method, passing the entry identifier of the transport in the <i>lpTargetTransport</i> parameter. See the preceding procedure for instructions on accessing the MAPI spooler's status object. Set the FLUSH_DOWNLOAD flag to flush the outgoing queues or the FLUSH_UPLOAD flag to flush the incoming queues. </li>
<li>
Release the status object and the status table, as well as the <a href="structyp_2378.htm"><b>SRowSet</b></a> structure that is allocated for the table.</li>
</ol>
</li>
</ol>
<p>
The MAPI spooler honors the FLUSH_NO_UI flag as do most LAN transport providers. However, not all transport providers honor this flag, particularly those that use a modem explicitly and the Remote Access Service (RAS). RAS was not designed to allow clients to suppress the user interface. It is possible for a client to be configured so that it can connect without requiring the interaction of a user, but it is difficult and requires intimate knowledge of the client's message services.</p>
<p>&nbsp;</p></body>
</HTML>
