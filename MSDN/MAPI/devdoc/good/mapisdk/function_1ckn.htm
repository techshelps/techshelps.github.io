<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<HTML dir=ltr>
<HEAD>
<META HTTP-EQUIV="Content-Type" Content="text/html; charset=Windows-1252">
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-83731338-2"></script><script>  window.dataLayer = window.dataLayer || [];  function gtag(){dataLayer.push(arguments);}  gtag('js', new Date());  gtag('config', 'UA-83731338-2');</script><title>OpenIMsgOnIStg</title>
<link disabled rel=stylesheet href=../../backsdk3.css>
<style type="text/css">
@import url(../../backsdk4.css);
</style>
</HEAD>
<BODY BGCOLOR = #FFFFFF TEXT = #000000>

<h2><a name="_mapi1book_openimsgonistg"></a>OpenIMsgOnIStg</h2>
<p>
The <b>OpenIMsgOnIStg</b> function builds a new <a href="inter029_525s.htm"><b>IMessage</b></a> object on top of an existing OLE <b>IStorage</b> object, to be used within a message session. </p>
<h4>Quick Info </h4>
<table cellspacing=4 cols=2>
<tr valign=top>
<td width=48%>Header file: </td>
<td width=52%>IMESSAGE.H </td>
</tr>
<tr valign=top>
<td width=48%>Implemented by: </td>
<td width=52%>MAPI </td>
</tr>
<tr valign=top>
<td width=48%>Called by: </td>
<td width=52%>Client applications and service providers </td>
</tr>
</table><br>
<pre><code><b>SCODE OpenIMsgOnIStg(
  LPMSGSESS</b><i> lpMsgSess</i><b>,</b>                      
<b>  LPALLOCATEBUFFER</b><i> lpAllocateBuffer</i><b>,</b>        
<b>  LPALLOCATEMORE</b><i> lpAllocateMore</i><b>,</b>            
<b>  LPFREEBUFFER</b><i> lpFreeBuffer</i><b>,</b>                
<b>  LPMALLOC</b><i> lpmalloc</i><b>,</b>                        
<b>  LPVOID</b><i> lpMapiSup</i><b>,</b>                         
<b>  LPSTORAGE</b><i> lpStg</i><b>,</b>                          
<b>  MSGCALLRELEASE FAR *</b><i> lpfMsgCallRelease</i><b>,</b>   
<b>  ULONG</b><i> ulCallerData</i><b>,</b>                       
<b>  ULONG</b><i> ulFlags</i><b>,</b>                            
<b>  LPMESSAGE FAR *</b><i> lppMsg                    </i>
<b>);</b>
 </code></pre>
<h4>Parameters </h4>
<dl>
<dt>
<i>lpMsgSess </i></dt>
<dd>
[in] Pointer to a message session object within which the new <b>IMessage</b>-on-<b>IStorage</b> object is to be created. </dd>
<dt>
<i>lpAllocateBuffer </i></dt>
<dd>
[in] Pointer to the <a href="function_8z3m.htm"><b>MAPIAllocateBuffer</b></a> function, to be used where required by MAPI to allocate memory. </dd>
<dt>
<i>lpAllocateMore </i></dt>
<dd>
[in] Pointer to the <a href="function_11wl.htm"><b>MAPIAllocateMore</b></a> function, to be used where required by MAPI to allocate additional memory. </dd>
<dt>
<i>lpFreeBuffer </i></dt>
<dd>
[in] Pointer to the <a href="function_85yq.htm"><b>MAPIFreeBuffer</b></a> function, to be used where required by MAPI to free memory. </dd>
<dt>
<i>lpMalloc </i></dt>
<dd>
[in] Pointer to a memory allocator object exposing the OLE <b>IMalloc</b> interface. The <b>IMessage</b> interface needs to use this allocation method when working with interfaces such as <b>IStorage</b> and <b>IStream</b>. </dd>
<dt>
<i>lpMapiSup </i></dt>
<dd>
[in] Optional pointer to a MAPI support object that a service provider can use to call the methods of the <a href="inter025_8uge.htm"><b>IMAPISupport : IUnknown</b></a> interface. </dd>
<dt>
<i>lpStg </i></dt>
<dd>
[in, out] Pointer to an OLE <b>IStorage</b> object that is open and has read-only or read/write access. Because <b>IMessage</b> does not support write-only access, <b>OpenIMsgOnIStg</b> does not accept a storage object opened in write-only mode. </dd>
<dt>
<i>lpfMsgCallRelease </i></dt>
<dd>
[in] Optional pointer to a callback function based on the <a href="function_1vz9.htm"><b>MSGCALLRELEASE</b></a> prototype that MAPI is to call following the last release on the <b>IMessage</b>-on-<b>IStorage</b> object. </dd>
<dt>
<i>ulCallerData </i></dt>
<dd>
[in] 32-bit caller data saved by MAPI with the <b>IMessage</b>-on-<b>IStorage</b> object and passed to the <b>MSGCALLRELEASE</b> based callback function. The data provides context about the <b>IMessage</b> object being released and the <b>IStorage</b> object it was built on top of. </dd>
<dt>
<i>ulFlags </i></dt>
<dd>
[in] Bitmask of flags used to control whether the OLE <b>IStorage::Commit</b> method is called when the client application or service provider calls the <b>IMessage::SaveChanges</b> method. The following flag can be set: 
<dl>
<dt>
IMSG_NO_ISTG_COMMIT </dt>
<dd>
The OLE method <b>IStorage::Commit</b> is not to be called when the client or provider calls <a href="inter022_5rqr.htm"><b>SaveChanges</b></a>. </dd>
</dl>
</dd>
<dt>
<i>lppMsg </i></dt>
<dd>
[out] Pointer to a pointer to the opened <b>IMessage</b> object. 
</dd>
</dl>
<h4>Return Values </h4>
<dl>
<dt>
S_OK </dt>
<dd>
The call succeeded and has returned the expected value or values. 
</dd>
</dl>
<h4>Remarks </h4>
<p>
Property attributes can only be accessed on property objects, that is, objects implementing the <a href="inter022_00tq.htm"><b>IMAPIProp : IUnknown</b></a> interface. To make MAPI properties available on an OLE structured storage object, <b>OpenIMsgOnIStg</b> builds an <a href="inter029_525s.htm"><b>IMessage : IMAPIProp</b></a> object on top of the OLE <b>IStorage</b> object. The property attributes on such objects can be set or altered with <a href="function_22jr.htm"><b>SetAttribIMsgOnIStg</b></a> and retrieved with <a href="function_53af.htm"><b>GetAttribIMsgOnIStg</b></a>. </p>
<h4>Notes to Callers </h4>
<p>
A message session should be opened with <a href="function_2q7i.htm"><b>OpenIMsgSession</b></a> before <b>OpenIMsgOnIStg</b> is called. Supplying a valid <i>lpMsgSess</i> parameter ensures that the new message is created within a message session so that it is closed when the session is closed. If <i>lpMsgSess</i> is NULL, the message is created independently of any message session. If the client application or service provider that created the message does not release it, as well as all its attachments and open tables, memory is leaked and may cause the application to terminate. </p>
<p>
MAPI uses the functions pointed to by <i>lpAllocateBuffer</i>, <i>lpAllocateMore</i>, and <i>lpFreeBuffer</i> for most memory allocation and deallocation, in particular to allocate memory for use by client applications when calling object interfaces such as <a href="inter022_44c3.htm"><b>IMAPIProp::GetProps</b></a> and <a href="inter026_7wkz.htm"><b>IMAPITable::QueryRows</b></a>. The <i>lpAllocateBuffer</i>, <i>lpAllocateMore</i>, and <i>lpFreeBuffer </i>pointers are optional when the <b>OpenIMsgOnIStg</b> function is called with a valid <i>lpMapiSup</i> parameter. </p>
<p>
Because it is dealing with an underlying OLE object, MAPI also needs to use OLE memory allocation. For more information on OLE structured storage objects and OLE memory allocation, see the <i>OLE Programmer's Reference</i>. </p>
<p>
If a valid value is supplied for <i>lpMapiSup</i>, <b>IMessage</b> supports the MAPI_DIALOG and ATTACH_DIALOG flags by calling the <a href="inter025_3i1z.htm"><b>IMAPISupport::DoProgressDialog</b></a> method to supply a progress user interface for the <a href="inter022_83qn.htm"><b>IMAPIProp::CopyTo</b></a> and <a href="inter029_63vs.htm"><b>IMessage::DeleteAttach</b></a> methods. Also, the <a href="inter029_8vw3.htm"><b>IMessage::ModifyRecipients</b></a> method attempts to convert short-term entry identifiers to long-term entry identifiers by calling the <a href="inter025_6nmz.htm"><b>IMAPISupport::OpenAddressBook</b></a> method and making calls on the resulting address book object. If NULL is passed for <i>lpMapiSup</i>, <b>IMessage</b> ignores MAPI_DIALOG and ATTACH_DIALOG and stores short-term entry identifiers without conversion. </p>
<p>
The <b>IStorage</b> object pointed to by the <i>lpStg</i> parameter must be opened in either the STGM_READ or STGM_READWRITE mode. If the STGM_READWRITE mode is used, the STGM_TRANSACTED mode must also be set. </p>
<p>
The callback function pointed to by the <i>lpfMsgCallRelease </i>parameter is optional; if provided, it should be based on the <a href="function_1vz9.htm"><b>MSGCALLRELEASE</b></a> function prototype. The <b>IMessage</b> interface calls it when the reference count of the <b>IMessage</b>-on-<b>IStorage</b> object is set to zero by the last call to its <b>Release</b> method. The callback function is commonly used to free the underlying <b>IStorage</b> interface. <b>IMessage</b> will not attempt to access the <b>IStorage</b> object pointed to by the <i>lpStg</i> parameter after making the callback. </p>
<p>
Some clients or providers might write additional data to the <b>IStorage</b> object beyond what <b>IMessage</b> itself writes when its <a href="inter022_5rqr.htm"><b>SaveChanges</b></a> method is called. The client or provider can use the IMSG_NO_ISTG_COMMIT flag to prevent <b>IMessage</b> from calling the OLE <b>IStorage::Commit</b> method while processing a <b>SaveChanges</b> call; in this case the client or provider must itself commit the <b>IStorage</b> object when the additional data is written. To aid in this, the <b>IMessage</b> implementation guarantees to name all substorages it creates in the <b>IStorage</b> object starting with the string "__", that is, with two underscores. The client or provider can avoid name collisions by keeping its substorage names out of this namespace. </p>
<p>
MAPI does not define the behavior of multiple open operations performed on a subobject of a message, such as an attachment, a stream, or an embedded message. MAPI currently allows a subobject that is already open to be opened once more, but MAPI performs the open operation by incrementing the reference count for the existing open object and returning it to the client or provider that called the <a href="inter029_7qco.htm"><b>IMessage::OpenAttach</b></a> or <a href="inter022_15vd.htm"><b>IMAPIProp::OpenProperty</b></a> method. This means the access requested for the first open operation on a subobject is the access provided for all subsequent open operations, regardless of the access requested by the operations. </p>
<p>
The correct procedure for placing a message into an attachment is to call the <a href="inter022_15vd.htm"><b>IMAPIProp::OpenProperty</b></a> method with an interface identifier of IID_IMessage. <b>OpenProperty</b> currently also supports creation of message attachments accessible directly on the OLE <b>IStorage</b> interface, that is, using the IID_IStorage interface identifier. <b>IStorage</b> access is supported to allow an easy way to put a Microsoft Word for Windows document into an attachment without converting it to or from the OLE <b>IStream</b> interface. However, <b>IMessage</b> may not behave predictably if <b>OpenIMsgOnIStg</b> is passed an <b>IStorage</b> pointer to the attachment data and then the objects are released in the wrong order. </p>
<h4>See Also</h4>
<p>
<a href="groups_2vhv.htm">IMessage-On-IStorage Functions</a> </p>
<p>&nbsp;</p></body>
</HTML>
