<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<HTML dir=ltr>
<HEAD>
<META HTTP-EQUIV="Content-Type" Content="text/html; charset=Windows-1252">
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-83731338-2"></script><script>  window.dataLayer = window.dataLayer || [];  function gtag(){dataLayer.push(arguments);}  gtag('js', new Date());  gtag('config', 'UA-83731338-2');</script><title>Implementing an Advise Sink Object</title>
<link disabled rel=stylesheet href=../../backsdk3.css>
<style type="text/css">
@import url(../../backsdk4.css);
</style>
</HEAD>
<BODY BGCOLOR = #FFFFFF TEXT = #000000>

<h2><a name="_mapi1book_implementing_an_advise_sink_object"></a>Implementing an Advise Sink Object</h2>
<p>
A client can either implement it's own advise sink objects or use a utility function, <a href="function_9bhn.htm"><b>HrAllocAdviseSink</b></a>. <b>HrAllocAdviseSink</b> creates an advise sink object with an implementation of <b>OnNotify</b> that invokes a callback function. </p>
<p>
There are advantages and disadvantages to using <b>HrAllocAdviseSink</b>. It can save work, but it provides no control over reference counting the advise sink object that it creates. Therefore, clients that need to carefully control their advise sink's release or that have interdependencies between their advise sink and another client object should construct their own <b>IMAPIAdviseSink</b> implementation and avoid using <b>HrAllocAdviseSink </b>altogether.</p>
<p>
A client implementing its own advise sink should make it an independent object not related to or dependent upon any other objects so as to eliminate potential complications in reference counting and object release. However, if you must implement your advise sink as part of another object or include a back pointer to another object as a data member, it is recommended that two separate reference counts be maintained: one for the object referenced by the advise sink and one for the advise sink. </p>
<p>
When the reference count of the referenced object falls to zero, all of its methods can fail and its vtable can be destroyed, but the memory for the advise sink must remain intact until after its reference count also falls to zero. This means that the advise sink's <b>Release </b>method must decrement its reference count and finish destroying the object when that count reaches zero. If two separate reference counts are not maintained, it would be easy to inadvertently destroy the advise sink as part of the encompassing object's <b>Release</b> process. </p>
<p>
Clients using <b>HrAllocAdviseSink</b> to implement an advise sink must be equally careful not to include their callback function as a method in another advise sink object. For C++ clients, it is tempting to do this and pass the <i>this</i> pointer as a parameter. This is a dangerous strategy because clients typically free an object when its reference count reaches zero. Freeing the memory for the advise sink object would render the <i>this</i> pointer invalid.</p>
<p>
Depending on the type of event and the advise source, your <b>OnNotify</b> method can handle events in various ways. The following table offers suggestions in how to handle some of the standard events.</p>
<table cellspacing=4 cols=2>
<tr valign=top>
<th align=left width=35%>Type of event</th>
<th align=left width=65%>Handling in OnNotify </th>
</tr>
<tr valign=top>
<td width=35%>Object moved</td>
<td width=65%>If the moved object's original parent is related to the new parent, update the view beginning with the folder or address book container highest in the hierarchy. <br>
If the two parent containers are unrelated, update both of their views.</td>
</tr>
<tr valign=top>
<td width=35%>New message</td>
<td width=65%>Change the user interface to inform the user of the arrival of one or more new messages.<br>
Place the receive folder in the current view.</td>
</tr>
<tr valign=top>
<td width=35%>Error </td>
<td width=65%>For all objects except the session, log the error if necessary and return.<br>
For the session object, log off if possible.</td>
</tr>
<tr valign=top>
<td width=35%>Search complete</td>
<td width=65%>No processing necessary.</td>
</tr>
</table><br>
<p>
<b>Note</b>  Notification handlers must be reentrant if they explicitly yield control of the computer.</p>
<p>&nbsp;</p></body>
</HTML>
