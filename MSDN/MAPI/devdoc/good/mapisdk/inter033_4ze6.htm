<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<HTML dir=ltr>
<HEAD>
<META HTTP-EQUIV="Content-Type" Content="text/html; charset=Windows-1252">
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-83731338-2"></script><script>  window.dataLayer = window.dataLayer || [];  function gtag(){dataLayer.push(arguments);}  gtag('js', new Date());  gtag('config', 'UA-83731338-2');</script><title>IMSProvider::Logon</title>
<link disabled rel=stylesheet href=../../backsdk3.css>
<style type="text/css">
@import url(../../backsdk4.css);
</style>
</HEAD>
<BODY BGCOLOR = #FFFFFF TEXT = #000000>

<h2><a name="_mapi1book_imsprovider_logon"></a>IMSProvider::Logon</h2>
<p>
The <b>IMSProvider::Logon</b> method logs MAPI on to one instance of a message store provider.</p>
<h4>Quick Info</h4>
<p>
See <a href="inter033_42pa.htm"><b>IMSProvider : IUnknown</b></a>.</p>
<pre><code><b>HRESULT Logon(
  LPMAPISUP</b><i> lpMAPISup</i><b>,</b>          
<b>  ULONG</b><i> ulUIParam</i><b>,</b>              
<b>  LPTSTR</b><i> lpszProfileName</i><b>,</b>       
<b>  ULONG</b><i> cbEntryID</i><b>,</b>              
<b>  LPENTRYID</b><i> lpEntryID</i><b>,</b>          
<b>  ULONG</b><i> ulFlags</i><b>,</b>                
<b>  LPCIID</b><i> lpInterface</i><b>,</b>           
<b>  ULONG FAR *</b><i> lpcbSpoolSecurity</i><b>,</b>   
<b>  LPBYTE FAR *</b><i> lppbSpoolSecurity</i><b>,</b>   
<b>  LPMAPIERROR FAR *</b><i> lppMAPIError</i><b>,</b>   
<b>  LPMSLOGON FAR *</b><i> lppMSLogon</i><b>,</b>   
<b>  LPMDB FAR *</b><i> lppMDB            </i>
<b>);</b>
 </code></pre>
<h4>Parameters</h4>
<dl>
<dt>
<i>lpMAPISup</i></dt>
<dd>
[in] Pointer to the current MAPI support object for the message store.</dd>
<dt>
<i>ulUIParam</i></dt>
<dd>
[in] Handle of the parent window for any dialog boxes or windows this method displays. </dd>
<dt>
<i>lpszProfileName</i></dt>
<dd>
[in] Pointer to a string containing the name of the profile being used for store provider logon. This string can be displayed in dialog boxes, written out to a log file, or simply ignored. It must be in Unicode format if the MAPI_UNICODE flag is set in the <i>ulFlags</i> parameter.</dd>
<dt>
<i>cbEntryID</i></dt>
<dd>
[in] Size, in bytes, of the entry identifier pointed to by the <i>lpEntryID</i> parameter.</dd>
<dt>
<i>lpEntryID</i></dt>
<dd>
[in] Pointer to the entry identifier for the message store. Passing NULL in <i>lpEntryID</i> indicates that a message store has not yet been selected and that dialog boxes enabling the user to select a message store can be presented.</dd>
<dt>
<i>ulFlags</i></dt>
<dd>
[in] Bitmask of flags that controls how the logon is performed. The following flags can be set:
<dl>
<dt>
MAPI_DEFERRED_ERRORS</dt>
<dd>
The call is allowed to succeed even if the underlying object is not accessible to the calling implementation. If the object is not accessible, some subsequent call to the object might return an error.</dd>
<dt>
MAPI_UNICODE</dt>
<dd>
The passed-in strings are in Unicode format. If MAPI_UNICODE is not set, the strings are in ANSI format.</dd>
<dt>
MDB_NO_DIALOG</dt>
<dd>
Prevents display of logon dialog boxes. If this flag is set, the error value MAPI_E_LOGON_FAILED is returned if logon is unsuccessful. If this flag is not set, the message store provider can prompt the user to correct a name or password, to insert a disk, or to perform other actions necessary to establish connection to the store.</dd>
<dt>
MDB_NO_MAIL</dt>
<dd>
The message store should not be used for sending or receiving mail. The flag signals MAPI not to notify the MAPI spooler that this message store is being opened. If this flag is set, and the message store is tightly coupled with a transport provider, then the provider does not need to call the <a href="inter025_5b7d.htm"><b>IMAPISupport::SpoolerNotify</b></a> method.</dd>
<dt>
MDB_TEMPORARY</dt>
<dd>
Logs on the store so that information can be retrieved programmatically from the profile section, without use of dialog boxes. This flag instructs MAPI that the store is not to be added to the message store table and that the store cannot be made permanent. If this flag is set, message store providers do not need to call the <a href="inter025_5eud.htm"><b>IMAPISupport::ModifyProfile</b></a> method.</dd>
<dt>
MDB_WRITE</dt>
<dd>
Requests read/write access.</dd>
</dl>
</dd>
<dt>
<i>lpInterface</i></dt>
<dd>
[in] Pointer to the interface identifier (IID) for the message store to log on to. Passing NULL indicates the MAPI interface for the message store is returned — that is, the <a href="inter031_1jg0.htm"><b>IMsgStore</b></a><b> </b>interface. The <i>lpInterface </i>parameter can also be set to an identifier for an appropriate interface for the message store, for example IID_IUnknown or IID_IMAPIProp.</dd>
<dt>
<i>lpcbSpoolSecurity</i></dt>
<dd>
[out] Pointer to the variable where the store provider returns the size, in bytes, of the validation data in the <i>lppbSpoolSecurity </i>parameter.</dd>
<dt>
<i>lppbSpoolSecurity</i></dt>
<dd>
[out] Pointer to the pointer to the returned validation data. This validation data is provided so the <a href="inter033_36em.htm"><b>IMSProvider::SpoolerLogon</b></a> method can log the MAPI spooler on to the same store as the message store provider.</dd>
<dt>
<i>lppMAPIError</i></dt>
<dd>
[out] Pointer to a pointer to the returned <a href="structyp_0qpe.htm"><b>MAPIERROR</b></a> structure, if any, containing version, component, and context information for an error. The <i>lppMAPIError </i>parameter can be set to NULL if there is no <b>MAPIERROR</b> structure to return.</dd>
<dt>
<i>lppMSLogon</i></dt>
<dd>
[out] Pointer to the pointer to the message store logon object for MAPI to log on to.</dd>
<dt>
<i>lppMDB</i></dt>
<dd>
[out] Pointer to the pointer to the message store object for the MAPI spooler and client applications to log on to.
</dd>
</dl>
<h4>Return Values</h4>
<dl>
<dt>
S_OK</dt>
<dd>
The call succeeded and has returned the expected value or values.</dd>
<dt>
MAPI_E_FAILONEPROVIDER</dt>
<dd>
This provider cannot log on, but this error should not disable the service. </dd>
<dt>
MAPI_E_LOGON_FAILED</dt>
<dd>
A logon session could not be established.</dd>
<dt>
MAPI_E_UNCONFIGURED</dt>
<dd>
The profile does not contain enough information for the logon to complete. When this value is returned, MAPI calls the message store provider's message-service entry point function.</dd>
<dt>
MAPI_E_USER_CANCEL</dt>
<dd>
The user canceled the operation, typically by clicking the <b>Cancel</b> button in a dialog box.</dd>
<dt>
MAPI_E_UNKNOWN_CPID</dt>
<dd>
The server is not configured to support the client's code page.</dd>
<dt>
MAPI_E_UNKNOWN_LCID</dt>
<dd>
The server is not configured to support the client's locale information.</dd>
<dt>
MAPI_W_ERRORS_RETURNED</dt>
<dd>
The call succeeded, but the message store provider has error information available. When this warning is returned, the call should be handled as successful. To test for this warning, use the <b>HR_FAILED</b> macro. See <a href="extend_5k9z.htm">Using Macros for Error Handling</a>.To get the error information from the provider, call the <a href="inter023_8lde.htm"><b>IMAPISession::GetLastError</b></a> method.
</dd>
</dl>
<h4>Remarks</h4>
<p>
MAPI calls the <b>IMSProvider::Logon</b> method to do the majority of processing necessary to obtain access to a message store. Message store providers validate any user credentials necessary to access a particular store and return a message store object in the <i>lppMDB</i> parameter that the MAPI spooler and client applications can log on to.</p>
<p>
In addition to the message store object returned for client and MAPI spooler use, the provider also returns a message store logon object for MAPI to use in controlling the opened store. The message store logon object and the message store object should be tightly linked inside the message store provider so each can affect the other. Usage of the store object and the logon object should be identical; there should be a one-to-one correspondence between the logon object and the store object such that the objects act as if they are one object exposing two interfaces. The two objects should also be created together and freed together.</p>
<p>
The MAPI support object, created by MAPI and passed to the provider in the <i>lpMAPISup</i> parameter, provides access to functions in MAPI required by the provider. These include functions that save and retrieve profile information, access address books, and so on. The <i>lpMAPISup</i> pointer can be different for each store that is opened. While processing calls for a message store after logon, the store provider should use the <i>lpMAPISup</i> variable specific to that store. For any <b>Logon</b> call that opens a message store and succeeds in creating a message store logon object, the provider must save a pointer to the MAPI support object in the store logon object and must call the <b>IUnknown::AddRef</b> method to add a reference for the support object.</p>
<p>
The <i>ulUIParam</i> parameter should be used if the provider presents dialog boxes during the <b>Logon</b> call. However, dialog boxes should not be presented if <i>ulFlags</i> contains the MDB_NO_DIALOG flag. If a user interface needs to be called but <i>ulFlags</i> does not allow it, or if for some other reason a user interface cannot be displayed, the provider should return MAPI_E_LOGON_FAILED. If <b>Logon</b> displays a dialog box and the user cancels logon, typically by clicking the dialog box's <b>Cancel</b> button, the provider should return MAPI_E_USER_CANCEL.</p>
<p>
The <i>lpEntryID</i> parameter can either be NULL or point to an unwrapped store entry identifier previously created by this message store. If <i>lpEntryID</i> points to an unwrapped entry identifier, that entry identifier can come from one of several places:
<ul>
<li>
It can be an entry identifier that the store provider previously wrapped and wrote to the profile section as a <a href="propa_8cv8.htm">PR_ENTRYID</a> property.</li>
<li>
It can be an entry identifier that the provider previously wrapped and returned to a calling client as a <a href="propb_2vqc.htm">PR_STORE_ENTRYID</a> property. </li>
<li>
It can be an entry identifier that the provider previously wrapped and returned to a calling client as the PR_ENTRYID property of a message store object. </li>
</ul>
<p>
In any of these cases, it is possible that the entry identifier was created on a different computer than the one currently being used.</p>
<p>
When <i>lpEntryID</i> is not NULL, it should contain all of the information needed to identify and locate the message store. This information can include network volume names, phone numbers, user account names, and so on. If the connection to the store cannot be made using the data in the entry identifier, then the store provider should display a dialog box that enables the user to select the store to be opened. A dialog box might be required, for example, if a server has been renamed, an account name has changed, or portions of the network are not available.</p>
<p>
When <i>lpEntryID</i> is NULL, the message store to use has not yet been selected. The provider can still access a store without displaying a dialog box if it supports further methods to specify the store. For example, the provider can check its initialization file, or it can look for additional properties that were placed in its or its message service's profile section at configuration.</p>
<p>
If a provider finds that all the required information is not in the profile, it should return MAPI_E_UNCONFIGURED so that MAPI calls the provider's message service entry point function to enable the user to select a store, or even to create one, and to enter an account name and password as needed. MAPI automatically creates a new profile section for a new store; this new profile section can be temporary or permanent, depending on how it has been added. If the store provider calls the <a href="inter025_5eud.htm"><b>IMAPISupport::ModifyProfile</b></a> method, the new profile section becomes permanent and the store is added to the list of message stores returned by the <a href="inter023_9f8l.htm"><b>IMAPISession::GetMsgStoresTable</b></a> method.</p>
<p>
The <i>lpInterface</i> parameter specifies the IID of the interface required for the newly opened store object. Passing NULL in <i>lpInterface</i> specifies that the MAPI message store interface, <a href="inter031_1jg0.htm"><b>IMsgStore</b></a>, is required. Passing the message store object, IID_IMsgStore, also specifies that <b>IMsgStore</b> is required. If IID_IUnknown is passed in <i>lpInterface</i>, the provider should open the store using whatever interface derived from <b>IUnknown </b>that is best for the provider; again, this is typically <b>IMsgStore</b>. When IID_IUnknown is passed, after the store open operation succeeds the calling implementation uses the <b>IUnknown::QueryInterface</b> method to select an interface.</p>
<p>
The <b>IMSProvider::Logon</b> call should return sufficient information, such as a path to the store and credentials for accessing the store, to allow the MAPI spooler to log on to the same store the store provider does without presenting a dialog box. The <i>lpcbSpoolSecurity</i> and <i>lppbSpoolSecurity</i> parameters are used to return this information. The provider allocates the memory for this data by passing a pointer to a buffer in the <a href="function_7zxw.htm"><b>MSProviderInit</b></a> function's <i>lpfAllocateBuffer</i> parameter; the provider places the size of this buffer in <i>lpcbSpoolSecurity</i>. </p>
<p>
MAPI frees this buffer when appropriate. If the MAPI spooler's logon to the store can be accomplished from the information in the profile section alone, the provider can return NULL in <i>lppbSpoolSecurity</i> and zero for the information's size in <i>lpcbSpoolSecurity</i>. The MAPI spooler logon occurs as part of a different process than the store logon; because the buffer holding the passed information gets copied between processes, it might not be in memory at the same location for the MAPI spooler process as for the store provider process. Therefore, a provider shouldn't put addresses into this buffer. For more information on MAPI spooler logon, see <a href="inter033_36em.htm"><b>IMSProvider::SpoolerLogon</b></a>. </p>
<p>
Most store providers use the <a href="inter023_4ofi.htm"><b>IMAPISession::OpenProfileSection</b></a> method of the support object passed in the <i>lpMAPISup</i> parameter for saving and retrieving user credentials and options. <b>OpenProfileSection</b> enables a store provider to save additional arbitrary information in a profile section and associate it with a particular resource. For example, a store provider can save the user account name and password associated with a resource and any paths or other necessary information needed to access that resource.</p>
<p>
Properties with property identifiers 0x6600 through 0x67FF are secure properties available to the provider for its own use to store private data in profile sections. For more information on the uses of properties in profile section objects, see <a href="inter036_11v4.htm"><b>IProfSect : IMAPIProp</b></a>.</p>
<p>
In addition to any private data in properties with identifiers 0x6600 through 0x67FF, the store provider should provide information for the <a href="propa_1yjp.htm">PR_DISPLAY_NAME</a> property in its profile section. It should place in PR_DISPLAY_NAME the display name of the provider itself — an identifying string displayed to users so they can distinguish this message store from others they might have access to — for example, "Microsoft Personal Information Store." PR_DISPLAY_NAME commonly contains a server name, user account name, or path.</p>
<p>
Some profile section properties are visible in the message store table; others are visible during setup, installation, and configuration of the MAPI subsystem. The provider typically provides information for these visible properties both for a new profile section, which does not yet include saved credentials or private information, and when it finds that property information has changed. For more information on profile sections, see <a href="inter025_6rvy.htm"><b>IMAPISupport::OpenProfileSection</b></a>.</p>
<p>
After successfully logging a user on, and before returning to MAPI, the store provider should create the array of properties for the status row for the resource and call <a href="inter025_0oxj.htm"><b>IMAPISupport::ModifyStatusRow</b></a>. </p>
<p>
<b>Logon</b> calls that open message stores already open for the current MAPI session skip much of the processing described previously. These calls do not create status rows, do not return message store logon objects, do not call <b>AddRef</b> for the MAPI support object, and do not return data for MAPI spooler logon. These calls do return S_OK and do return a message store object with the interface requested.</p>
<p>
To detect such calls, the provider should maintain a list in the message store provider object of stores already open for this provider object. When processing a <b>Logon</b> call, the provider should scan this list of open stores and determine if the store to be logged onto is already open. If it is, user credentials do not need to be checked and dialog box display should be avoided if possible. If dialog boxes must be displayed, the provider should check information returned to see whether a store has been opened a second time. In addition, the provider should check for duplicate openings using <i>lpEntryID</i> at the beginning of <b>Logon</b> call processing.</p>
<p>
Standard processing for a <b>Logon</b> call that accesses an open store is as follows:
<ol>
<li>
The store provider calls <b>AddRef</b> for the existing store object if the new interface being requested is the same as the interface for the existing store. Otherwise, it calls <b>QueryInterface</b> to get the new interface. If the new interface isn't one the store supports, the provider should return the error value MAPI_E_INTERFACE_NOT_SUPPORTED.</li>
<li>
The provider returns a pointer to the required interface of the existing store object in <i>lppMDB</i>.</li>
<li>
The provider returns NULL in <i>lppMSLogon</i>.</li>
<li>
The provider should not open the profile for the support object passed in the call. Neither should it register a provider unique identifier, register a status row, nor return MAPI spooler logon data.</li>
<li>
The provider should not call <b>AddRef</b> for the support object, because it does not require a pointer to the object.</li>
</ol>
<p>
Whenever possible, providers should return appropriate error and warning strings for <b>Logon</b> calls because doing so greatly eases the burden of users determining why something did not work. To do so, a provider sets the members in the <a href="structyp_0qpe.htm"><b>MAPIERROR</b></a> structure. MAPI looks for, uses, and releases the <b>MAPIERROR</b> structure if it is returned by a provider.</p>
<p>
Memory for this <b>MAPIERROR</b> structure should be allocated using the buffer passed in <i>lpfAllocateBuffer</i> on the <b>MSProviderInit</b> call. Any error strings contained in the returned structure should be in Unicode format if MAPI_UNICODE is set in the <b>Logon</b> <i>ulFlags;</i> otherwise, they should be in the ANSI character set.</p>
<p>
For most error values returned from <b>Logon</b>, MAPI disables the message services to which the failing provider belongs. MAPI will not call any providers belonging to those services for the rest of the life of the MAPI session. In contrast, when <b>Logon</b> returns the MAPI_E_FAILONEPROVIDER error value from its logon, MAPI does not disable the message service to which the provider belongs. <b>Logon</b> should return MAPI_E_FAILONEPROVIDER if it encounters an error that does not warrant disabling the entire service for the life of the session. For example, a provider might return this error when it does not allow the display of a user interface and a required password is unavailable. </p>
<p>
If a provider returns MAPI_E_UNCONFIGURED from its logon, MAPI will call the provider's message service entry function and then retry the logon. MAPI passes MSG_SERVICE_CONFIGURE as the context, to give the service a chance to configure itself. If the client has chosen to allow a user interface on the logon, the service can present its configuration property sheet so the user can enter configuration information.</p>
<h4>See Also</h4>
<p>
<a href="inter023_9f8l.htm"><b>IMAPISession::GetMsgStoresTable</b></a>, <a href="inter023_59id.htm"><b>IMAPISession::OpenMsgStore</b></a>, <a href="inter023_4ofi.htm"><b>IMAPISession::OpenProfileSection</b></a>, <a href="inter025_5eud.htm"><b>IMAPISupport::ModifyProfile</b></a>, <a href="inter025_0oxj.htm"><b>IMAPISupport::ModifyStatusRow</b></a>, <a href="inter031_1jg0.htm"><b>IMsgStore : IMAPIProp</b></a>, <a href="inter033_36em.htm"><b>IMSProvider::SpoolerLogon</b></a>, <a href="inter036_11v4.htm"><b>IProfSect : IMAPIProp</b></a>, <a href="structyp_0qpe.htm"><b>MAPIERROR</b></a>, <a href="function_7zxw.htm"><b>MSProviderInit</b></a></p>
<p>&nbsp;</p></body>
</HTML>
