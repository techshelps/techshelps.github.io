<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<HTML dir=ltr>
<HEAD>
<META HTTP-EQUIV="Content-Type" Content="text/html; charset=Windows-1252">
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-83731338-2"></script><script>  window.dataLayer = window.dataLayer || [];  function gtag(){dataLayer.push(arguments);}  gtag('js', new Date());  gtag('config', 'UA-83731338-2');</script><title>Structured Storage</title>
<link disabled rel=stylesheet href=../../backsdk3.css>
<style type="text/css">
@import url(../../backsdk4.css);
</style>
</HEAD>
<BODY BGCOLOR = #FFFFFF TEXT = #000000>

<h1><a name="_mapi1book_structured_storage"></a>Structured Storage</h1>
<p>
Structured storage refers to the hierarchical organization of storage introduced with OLE. In a structured storage environment, storage is organized into two or three types of objects:
<ul>
<li>
Stream objects</li>
<li>
Lock bytes objects</li>
<li>
Storage objects</li>
</ul>
<p>
Stream and lock bytes are lower-level objects that directly access the data. Stream objects implement the <b>IStream</b> interface which defines methods for reading, writing, positioning, and copying bytes of data. Lock bytes objects implement another OLE interface, <b>ILockBytes</b>, to access data with a byte array. Byte arrays are typically used to provide customized access to underlying storage.</p>
<p>
Storage objects are layered on top of the stream or lock bytes objects; they can contain one or more of these objects as well as other storage objects. Storage objects implement the <b>IStorage</b> interface which defines methods for creating, accessing, and maintaining nested objects. </p>
<p>
Because <b>IStream</b>, <b>ILockBytes</b>, and <b>IStorage</b> are OLE interfaces rather than MAPI interfaces, their methods return OLE error values rather than MAPI values. Clients and service providers calling methods in these interfaces must use the API function <a href="function_94dh.htm"><b>MapStorageSCode</b></a> to translate these values into MAPI error values.</p>
<p>
Clients and service providers use structured storage for working with properties that are too large to maintain with the <b>IMAPIProp</b> methods, typically large string and binary properties. One of the common ways that clients or service providers access them is by specifying <b>IStream</b> or <b>IStorage</b> as the interface identifier in a call to the <a href="inter022_15vd.htm"><b>IMAPIProp::OpenProperty</b></a> method. For example, clients call <b>OpenProperty</b> with PR_ATTACH_DATA_BIN as the property tag and IID_IStream as the interface identifier to access a binary attachment in a message.</p>
<p>
Clients and service providers can implement their own stream and storage objects or call API functions to access implementations supplied by MAPI or OLE. Because the supplied implementations serve most purposes, clients and service providers rarely need to create their own. </p>
<p>
When a client calls <b>OpenProperty</b> on a MAPI object to access one of its properties through a storage object, the service provider will typically open the storage object in direct mode. However, this is typical rather than required behavior. Clients should assume that all storage objects opened or created by service providers are transacted and require a call to <b>IStorage::Commit</b>. They should also remember that changes to storage objects will not be made permanent until they call <a href="inter022_5rqr.htm"><b>IMAPIProp::SaveChanges</b></a> after the final <b>Commit</b> to save the MAPI object.</p>
<p>
MAPI and OLE provide several API functions for defining or accessing storage and stream objects. The commonly used functions are described in the following table.</p>
<table cellspacing=4 cols=2>
<tr valign=top>
<th align=left width=48%>Function</th>
<th align=left width=52%>Description</th>
</tr>
<tr valign=top>
<td width=48%><b>CreateDocfile</b></td>
<td width=52%>Creates a general purpose storage object.</td>
</tr>
<tr valign=top>
<td width=48%><a href="function_5cfh.htm"><b>HrIStorageFromStream</b></a></td>
<td width=52%>Creates a storage object to access a stream or lock bytes object.</td>
</tr>
<tr valign=top>
<td width=48%><a href="function_1ckn.htm"><b>OpenIMsgOnIStg</b></a> </td>
<td width=52%>Creates a message object to access a storage object.</td>
</tr>
<tr valign=top>
<td width=48%><a href="function_8xyd.htm"><b>OpenStreamOnFile</b></a></td>
<td width=52%>Creates a stream object to access a file.</td>
</tr>
<tr valign=top>
<td width=48%><a href="function_8lv1.htm"><b>WrapCompressedRTFStream</b></a></td>
<td width=52%>Creates a stream object that contains the compressed or uncompressed version of a stream holding the rich text of a message.</td>
</tr>
</table><br>
<p>
<b>CreateDocfile</b> is used frequently in OLE and in MAPI to create a storage object. For more information on this function, refer to the OLE documentation.</p>
<h5><img src="../../images/wedge.gif" border=0>&nbsp;&nbsp;&nbsp;&nbsp;To retrieve the names of the streams in a given substorage</h5>
<ol>
<li>
Call the substorage's <b>IStorage::EnumElements</b> method to get an <b>IEnumSTATSTG</b> interface.</li>
<li>
Call <b>IEnumSTATSTG::Next </b>with as many <b>STATSTG</b> structures at a time as you can. If you ask for 100 at a time, <b>Next</b> will usually return S_FALSE with the contents of <i>pceltFetched</i> set to the number that were actually retrieved. </li>
<li>
Check for the <b>STATSTG</b> structures that are flagged with STGTY_STREAM.</li>
<li>
Release the <i>pwcsName</i> parameter. </li>
</ol>
<h5><img src="../../images/wedge.gif" border=0>&nbsp;&nbsp;&nbsp;&nbsp;To create a storage object to access an existing stream or lock bytes object</h5>
<ul>
<li>
Clients call <a href="function_5cfh.htm"><b>HrIStorageFromStream</b></a>. </li>
</ul>
<h5><img src="../../images/wedge.gif" border=0>&nbsp;&nbsp;&nbsp;&nbsp;To create a message object to access an existing storage object</h5>
<ul>
<li>
Service providers and clients call <a href="function_1ckn.htm"><b>OpenIMsgOnIStg</b></a>. The message object that is created differs from the message objects typically created by message store providers in that it does not support all of the <a href="inter029_525s.htm"><b>IMessage</b></a> interface methods, such as <b>IMessage::SubmitMessage</b>.<p>
An optional input parameter to <b>OpenIMsgOnIStg</b> is a callback function that conforms to the <a href="function_1vz9.htm"><b>MSGCALLRELEASE</b></a> prototype. This function is called by the new message object when the message's reference count reaches zero. Implementing a <b>MSGCALLRELEASE</b> function can be useful for performing final processing before the new message is completely removed.
</li>
</ul>
<p>
<a href="function_8xyd.htm"><b>OpenStreamOnFile</b></a> is commonly used for storing file attachments because it creates a stream that reads from and writes to a file. <b>OpenProperty</b> with PR_ATTACH_DATA_BIN as the property tag creates a stream for storing binary attachment data.</p>
<h5><img src="../../images/wedge.gif" border=0>&nbsp;&nbsp;&nbsp;&nbsp;To compress or uncompress a stream containing message text in the Rich Text Format</h5>
<ul>
<li>
Clients call <a href="function_8lv1.htm"><b>WrapCompressedRTFStream</b></a>. <b>WrapCompressedRTFStream</b> creates a stream that wraps the RTF stream. The wrapper stream does not implement all of the <b>IStream</b> methods; the following methods are excluded:<p>
<b>Seek</b>
<p>
<b>SetSize</b>
<p>
<b>Revert</b>
<p>
<b>LockRegion</b>
<p>
<b>UnlockRegion</b>
<p>
<b>Stat</b>
<p>
<b>Clone</b>
<p>
Because the stream objects created by <b>WrapCompressedRTFStream</b> do not support either <b>SetSize</b> or <b>Stat</b>, there is not an easy way to either extend or retrieve their size. The best strategy is to pick a reasonable buffer size and read or write in a loop.
</li>
</ul>
<p>
<b>Note</b>  OLE has a storage object implementation based on a byte array that returns an <b>IEnumSTATSTG</b> object from the <b>EnumElements</b> method that is problematic. In particular, the <b>QueryInterface</b> method does not work correctly. Service providers that implement their own storage objects using the OLE implementation should create a thin wrapper for the <b>IEnumSTATSTG</b> object that forwards calls on to the underlying <b>IEnumSTATSTG</b> methods but implements its own <b>AddRef</b>, <b>Release</b>, <b>QueryInterface</b>, and <b>Clone</b> methods.</p>
<p>&nbsp;</p></body>
</HTML>
