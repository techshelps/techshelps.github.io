<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<HTML dir=ltr>
<HEAD>
<META HTTP-EQUIV="Content-Type" Content="text/html; charset=Windows-1252">
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-83731338-2"></script><script>  window.dataLayer = window.dataLayer || [];  function gtag(){dataLayer.push(arguments);}  gtag('js', new Date());  gtag('config', 'UA-83731338-2');</script><title>Sending Messages: Message Store Provider Tasks</title>
<link disabled rel=stylesheet href=../../backsdk3.css>
<style type="text/css">
@import url(../../backsdk4.css);
</style>
</HEAD>
<BODY BGCOLOR = #FFFFFF TEXT = #000000>

<h2><a name="_mapi1book_sending_messages_message_store_provider_tasks"></a>Sending Messages: Message Store Provider Tasks</h2>
<p>
A message store provider gets involved with the message sending process when a client calls the message's <a href="inter029_65ut.htm"><b>IMessage::SubmitMessage</b></a> method. If multiple messages are to be sent, the message store must send them in the same order that the client used for its <b>SubmitMessage</b> calls.</p>
<p>
The message store provider determines whether or not to involve the MAPI spooler. If the message store provider is not tightly coupled, the message requires preprocessing, or the tightly coupled store and transport cannot handle all of the recipients, the MAPI spooler must be involved. </p>
<p>
The following procedure describes the tasks required of a message store provider for sending a message. </p>
<h5><img src="../../images/wedge.gif" border=0>In IMessage::SubmitMessage, the message store provider</h5>
<ol>
<li>
Calls <a href="inter025_5q5w.htm"><b>IMAPISupport::PrepareSubmit</b></a> if the message has the MSGFLAG_RESEND flag set in its <a href="propa_95wz.htm">PR_MESSAGE_FLAGS</a> property and returns any errors to the client. <b>PrepareSubmit</b> checks the <a href="propb_0n6t.htm">PR_RECIPIENT_TYPE</a> property of each recipient in the message's recipient list. <ul>
<li>
If the MAPI_SUBMITTED flag is set, indicating that the recipient did not receive the original message, <b>PrepareSubmit</b> clears the flag and sets the <a href="propb_92pl.htm">PR_RESPONSIBILITY</a> property to TRUE. </li>
<li>
If the MAPI_SUBMITTED flag is not set, indicating that the recipient did receive the original messsage, <b>PrepareSubmit</b> changes the PR_RECIPIENT_TYPE property to MAPI_P1 and sets the PR_RESPONSIBILITY property to TRUE and returns any error generated by <b>PrepareSubmit</b> to the client. </li>
</ul>
</li>
<li>
Sets the MSGFLAG_SUBMIT flag in the message's <a href="propa_95wz.htm">PR_MESSAGE_FLAGS</a> property.</li>
<li>
Makes sure that there is a column for <a href="propb_92pl.htm">PR_RESPONSIBILITY</a> in the recipient table and sets it to FALSE to indicate that no transport has of yet assumed responsibility for transmitting the message.</li>
<li>
Sets the date and time of origination in the <a href="propa_7pr9.htm">PR_CLIENT_SUBMIT_TIME</a> property.</li>
<li>
Calls <a href="inter025_52pf.htm"><b>IMAPISupport::ExpandRecips</b></a> to:<ul>
<li>
Expand all personal distribution lists and custom recipients and replace all changed display names with their original names.</li>
<li>
Remove duplicate names.</li>
<li>
Check for any required preprocessing, and if preprocessing is required, set the NEEDS_PREPROCESSING flag and the <a href="propb_8aib.htm">PR_PREPROCESS</a> property, a property reserved for MAPI. </li>
<li>
Set the NEEDS_SPOOLER flag if the message store is tightly coupled with a transport and it cannot handle all of the recipients. </li>
</ul>
</li>
<li>
Performs the following tasks if the NEEDS_PREPROCESSING message flag is set:<ul>
<li>
Puts the message in the outgoing queue with the SUBMITFLAG_PREPROCESS bit set in the <a href="propb_2tgz.htm">PR_SUBMIT_FLAGS</a> property.</li>
<li>
Notifies the MAPI spooler that the queue has changed.</li>
<li>
Returns control to the client, and message flow continues in the MAPI spooler. The MAPI spooler performs the following tasks: </li>
</ul>
</li>
</ol>
<table cellspacing=4 cols=1>
<tr valign=top>
<td width=100%>&nbsp;&nbsp;&nbsp;&nbsp;1.&nbsp;&nbsp;&nbsp;&nbsp;Locks the message by calling <a href="inter031_8j51.htm"><b>IMsgStore::SetLockState</b></a>.</td>
</tr>
<tr valign=top>
<td width=100%>&nbsp;&nbsp;&nbsp;&nbsp;2.&nbsp;&nbsp;&nbsp;&nbsp;Performs the needed preprocessing by calling all of the preprocessing functions in the order of registration. Transport providers call <a href="inter025_53qq.htm"><b>IMAPISupport::RegisterPreprocessor</b></a> to register preprocessing functions.</td>
</tr>
<tr valign=top>
<td width=100%>&nbsp;&nbsp;&nbsp;&nbsp;3.&nbsp;&nbsp;&nbsp;&nbsp;Calls <a href="inter029_65ut.htm"><b>IMessage::SubmitMessage</b></a> on the open message to indicate to the message store that preprocessing is complete.</td>
</tr>
</table><br>
<p>
<b>Note</b>  The following two steps will occur in the client process if there was no preprocessing and will occur when the MAPI spooler calls <b>SubmitMessage</b> if there was preprocessing.</p>
<ol start=7>
<li>
Performs the following tasks if the message store is tightly coupled to a transport and the NEEDS_SPOOLER flag was returned from <a href="inter025_52pf.htm"><b>IMAPISupport::ExpandRecips</b></a>:<ul>
<li>
Handles any recipients that it can handle.</li>
<li>
Sets the <a href="propb_92pl.htm">PR_RESPONSIBILITY</a> property to TRUE for any recipients that it handles.</li>
<li>
Performs the following tasks if all recipients are known to this tightly coupled store and transport:</li>
</ul>
</li>
</ol>
<table cellspacing=4 cols=1>
<tr valign=top>
<td width=100%>&nbsp;&nbsp;&nbsp;&nbsp;1.&nbsp;&nbsp;&nbsp;&nbsp;Calls <a href="inter025_2bl3.htm"><b>IMAPISupport::CompleteMsg</b></a> if the message was preprocessed or the message store provider wants the MAPI spooler to complete message processing which is recommended so that messaging hooks can be invoked. Message flow continues with the MAPI spooler as described in the following procedure.</td>
</tr>
<tr valign=top>
<td width=100%>&nbsp;&nbsp;&nbsp;&nbsp;2.&nbsp;&nbsp;&nbsp;&nbsp;Performs the following tasks if the message was not preprocessed or the message store provider does not want the MAPI spooler to complete message processing:</td>
</tr>
<tr valign=top>
<td width=100%><font face="Symbol">·</font>&nbsp;&nbsp;&nbsp;&nbsp;Copies the message to the folder identified by the entry identifier in the <a href="propb_4s2s.htm">PR_SENTMAIL_ENTRYID</a> property, if set.</td>
</tr>
<tr valign=top>
<td width=100%><font face="Symbol">·</font>&nbsp;&nbsp;&nbsp;&nbsp;Deletes the message if the <a href="propa_57zo.htm">PR_DELETE_AFTER_SUBMIT</a> property has been set to TRUE.</td>
</tr>
<tr valign=top>
<td width=100%><font face="Symbol">·</font>&nbsp;&nbsp;&nbsp;&nbsp;Unlocks the message if it is locked.</td>
</tr>
<tr valign=top>
<td width=100%><font face="Symbol">·</font>&nbsp;&nbsp;&nbsp;&nbsp;Returns to the client. Message flow is complete.</td>
</tr>
</table><br>
<ol start=8>
<li>
Performs the following tasks if the message store is not tightly coupled to a transport, not all of the recipients were known to the message store, or the NEEDS_SPOOLER flag is set:<ul>
<li>
Puts the message in the outgoing queue without setting the SUBMITFLAG_PREPROCESS bit in the <a href="propb_2tgz.htm">PR_SUBMIT_FLAGS</a> property.</li>
<li>
Notifies the MAPI spooler that the outgoing queue has changed by generating a table notification. </li>
<li>
Returns to the client, and message flow continues with a set of tasks performed by the MAPI spooler.</li>
</ul>
</li>
</ol>
<p>
When a message is to be handled by the MAPI spooler, the message store provider sets the message's <a href="propb_2tgz.htm">PR_SUBMIT_FLAGS</a> property to SUBMITFLAG_LOCKED. The SUBMITFLAG_LOCKED flag indicates that the MAPI spooler has locked the message for its exclusive use. The other value for PR_SUBMIT_FLAGS, SUBMITFLAG_PREPROCESS, is set when the message requires preprocessing by one or more preprocessor functions registered by a transport provider.</p>
<p>&nbsp;</p></body>
</HTML>
