<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<HTML dir=ltr>
<HEAD>
<META HTTP-EQUIV="Content-Type" Content="text/html; charset=Windows-1252">
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-83731338-2"></script><script>  window.dataLayer = window.dataLayer || [];  function gtag(){dataLayer.push(arguments);}  gtag('js', new Date());  gtag('config', 'UA-83731338-2');</script><title>Implementing the FlushQueues Method</title>
<link disabled rel=stylesheet href=../../backsdk3.css>
<style type="text/css">
@import url(../../backsdk4.css);
</style>
</HEAD>
<BODY BGCOLOR = #FFFFFF TEXT = #000000>

<h2><a name="_mapi1book_implementing_the_flushqueues_method"></a>Implementing the FlushQueues Method</h2>
<p>
The MAPI spooler uses the <a href="inter042_8vn7.htm"><b>IXPLogon::FlushQueues</b></a> method to download and upload any pending messages to and from a transport provider. Typically, the MAPI spooler will flush the queues for all transport providers that are logged on to the session, starting with the first transport provider as set in the transport order section of the user's profile. Flushing queues is almost always the result of a direct request by the user, so the sending and receiving of messages while queues are flushing is synchronous to the MAPI spooler. Because these calls are synchronous, the transport provider should process them as quickly as possible.</p>
<p>
Transport providers must handle the <b>FlushQueues</b> call as described in the following sequence of steps to enable proper message processing and to enable external resources such as modems to be used by other transport providers as part of the MAPI spooler's <b>FlushQueues</b> operation. </p>
<table cellspacing=4 cols=3>
<tr valign=top>
<th align=left width=7%>Step</th>
<th align=left width=26%>Component</th>
<th align=left width=67%>Implementation</th>
</tr>
<tr valign=top>
<td width=7%>1.</td>
<td width=26%>MAPI spooler</td>
<td width=67%>Calls the <b>IXPLogon::FlushQueues</b> method for the first transport provider listed in the transport order of the user's profile, passing the requested flags in the <i>ulFlags</i> parameter. <b>FlushQueues</b> is called once with all flags set for the entire upload and download operation.</td>
</tr>
<tr valign=top>
<td width=7%>2.</td>
<td width=26%>Transport Provider</td>
<td width=67%>Needs to do a number of things before returning from the <b>FlushQueues</b> call.<br>
If previously submitted messages are being deferred, the <a href="inter025_5b7d.htm"><b>IMAPISupport::SpoolerNotify</b></a> method should be called with the NOTIFY_SENT_DEFERRED flag set. Note that it is possible for the MAPI spooler to cancel a message that has been deferred before the transport provider has a chance to finish processing the message.<p>
If the transport provider uses an external resource such as a modem, the connection to the external resource should be established.</p>
<p>
The STATUS_OUTBOUND_FLUSH bit in the <a href="propb_2zj9.htm">PR_STATUS_CODE</a> property of the transport provider's status row must be set using the <a href="inter025_0oxj.htm"><b>IMAPISupport::ModifyStatusRow</b></a> method.</p>
<p>
The transport provider should then return S_OK for the <b>FlushQueues</b> call.</p>
</td>
</tr>
<tr valign=top>
<td width=7%>3.</td>
<td width=26%>MAPI spooler</td>
<td width=67%>Checks the transport provider's status row for the STATUS_OUTBOUND_FLUSH bit and calls <a href="inter042_18v9.htm"><b>IXPLogon::SubmitMessage</b></a> for the first message in the queue.</td>
</tr>
<tr valign=top>
<td width=7%>4.</td>
<td width=26%>Transport provider</td>
<td width=67%>Handles the message and returns from the <b>SubmitMessage</b> call.</td>
</tr>
<tr valign=top>
<td width=7%>5.</td>
<td width=26%>MAPI spooler</td>
<td width=67%>If the transport provider returns S_OK from <b>SubmitMessage</b>, the MAPI spooler calls <a href="inter042_576t.htm"><b>IXPLogon::EndMessage</b></a> for the message as it does with regular message sending.<p>
If the transport provider returns a value other than S_OK from <b>SubmitMessage</b>, the MAPI spooler handles the value appropriately before calling <b>EndMessage</b>, or before calling <b>SubmitMessage</b> again.</p>
</td>
</tr>
<tr valign=top>
<td width=7%>6.</td>
<td width=26%>Transport provider</td>
<td width=67%>Returns from <b>EndMessage</b> with its message processing status in the <i>lpulFlags</i> parameter. </td>
</tr>
<tr valign=top>
<td width=7%>7.</td>
<td width=26%>MAPI spooler and transport provider</td>
<td width=67%>The <b>SubmitMessage</b>-<b>EndMessage</b> loop continues until all messages in the queue have been downloaded.</td>
</tr>
<tr valign=top>
<td width=7%>8.</td>
<td width=26%>MAPI spooler</td>
<td width=67%>Notifies the transport provider that it has finished downloading messages by calling the transport provider's<b> <a href="inter042_5cah.htm">IXPLogon::TransportNotify</a></b> method with the NOTIFY_END_OUTBOUND_FLUSH flag set.</td>
</tr>
<tr valign=top>
<td width=7%>9.</td>
<td width=26%>Transport provider</td>
<td width=67%>Frees any external resources used in sending outbound messages so they can be used by other transport providers to flush their queues.<p>
The STATUS_INBOUND_FLUSH bit in the PR_STATUS_CODE property of the transport provider's status row must be set using <b>ModifyStatusRow</b>.</p>
</td>
</tr>
<tr valign=top>
<td width=7%>10.</td>
<td width=26%>MAPI spooler</td>
<td width=67%>Checks the transport provider's status row for the STATUS_INBOUND_FLUSH bit and calls <a href="inter042_1a1x.htm"><b>IXPLogon::StartMessage</b></a> if it is set.</td>
</tr>
<tr valign=top>
<td width=7%>11.</td>
<td width=26%>Transport provider</td>
<td width=67%>Processes the message and returns from <b>StartMessage</b>. If the transport provider has other messages to upload, it should call <b>SpoolerNotify</b> with the NOTIFY_NEWMAIL flag set. <p>
If the transport provider has no messages to upload, it should call <a href="inter022_5rqr.htm"><b>IMAPIProp::SaveChanges</b></a> on the message the MAPI spooler passed in <b>StartMessage</b> and return. </p>
</td>
</tr>
<tr valign=top>
<td width=7%>12.</td>
<td width=26%>MAPI spooler</td>
<td width=67%>Continues calling <b>StartMessage</b> until <b>SaveChanges</b> is called on a message. After the transport provider has finished uploading, the MAPI spooler calls <b>TransportNotify</b> with the NOTIFY_END_INBOUND_FLUSH flag set.</td>
</tr>
<tr valign=top>
<td width=7%>13.</td>
<td width=26%>Transport provider</td>
<td width=67%>Clears the STATUS_INBOUND_FLUSH bit in the <a href="propb_2zj9.htm">PR_STATUS_CODE</a> property of its status row using <b>ModifyStatusRow</b> and releases all external resources that have been released so they are available for use by other transport providers.</td>
</tr>
<tr valign=top>
<td width=7%>14.</td>
<td width=26%>MAPI spooler</td>
<td width=67%>Calls <b>FlushQueues</b> for the next transport provider listed in the transport order of the user's profile.</td>
</tr>
</table><br>
<p>
If a client application calls <a href="inter024_8c37.htm"><b>IMAPIStatus::FlushQueues</b></a> on a transport provider's status object, the transport provider should set the appropriate bit in its status row with <b>ModifyStatusRow</b>. The MAPI spooler then calls the provider's <a href="inter042_8vn7.htm"><b>IXPLogon::FlushQueues</b></a> method at the MAPI spooler's convenience. When the provider's <b>IXPLogon::FlushQueues</b> method is called as a result of a client application's <b>IMAPIStatus::FlushQueues</b> call, the operation occurs asynchronously to the client application. Otherwise <b>IXPLogon::FlushQueues</b> works synchronously with the MAPI spooler.</p>
<p>
For performance reasons, the MAPI spooler will only call a transport provider's <b>FlushQueues</b> method if the STATUS_INBOUND_FLUSH and STATUS_OUTBOUND_FLUSH flags are set in the transport provider's status row. Consequently, a transport provider can stop the <b>FlushQueues</b> operation at any time by clearing the STATUS_OUTBOUND_FLUSH and STATUS_INBOUND_FLUSH flags in its status row. If the MAPI spooler is shutting down and needs to end the <b>FlushQueues</b> operation, it calls <b>TransportNotify</b> with both the NOTIFY_END_INBOUND_FLUSH and NOTIFY_END_OUTBOUND_FLUSH flags set. The transport provider should release all external resources and return.</p>
<p>&nbsp;</p></body>
</HTML>
