<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<HTML dir=ltr>
<HEAD>
<META HTTP-EQUIV="Content-Type" Content="text/html; charset=Windows-1252">
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-83731338-2"></script><script>  window.dataLayer = window.dataLayer || [];  function gtag(){dataLayer.push(arguments);}  gtag('js', new Date());  gtag('config', 'UA-83731338-2');</script><title>Supporting Event Notification</title>
<link disabled rel=stylesheet href=../../backsdk3.css>
<style type="text/css">
@import url(../../backsdk4.css);
</style>
</HEAD>
<BODY BGCOLOR = #FFFFFF TEXT = #000000>

<h1><a name="_mapi1book_supporting_event_notification"></a>Supporting Event Notification</h1>
<p>
Because supporting event notification can be complicated, MAPI supplies three support object methods that implement the most difficult parts of the process. These methods work as a unit, and a provider must use all three or none of them. </p>
<p>
The MAPI support methods use notification keys to manage the connections between the advise sinks and the objects that generate the notifications. A notification key is a <a href="structyp_5cc9.htm"><b>NOTIFKEY</b></a> structure containing binary data that identifies an object across processes. It is typically copied from the long-term entry identifier of the advise source object. If the client has supplied an entry identifier in the call to <b>Advise</b>, you can use it for the notification key. If the <i>lpEntryID</i> parameter to <b>Advise</b> is NULL, use the entry identifier of the outermost possible container object, such as the message store. </p>
<p>
To use the support methods, call <a href="inter025_56xx.htm"><b>IMAPISupport::Subscribe</b></a> whenever a client calls your <b>Advise</b> method to register for a notification. Allocate a <a href="structyp_5cc9.htm"><b>NOTIFKEY</b></a> structure and create a unique notification key for your advise source object. For example, a message store provider prompted to notify a client when a message is received into a particular folder creates a notification key for that folder. Pass a pointer to the <b>NOTIFKEY</b> structure in the call to <b>Subscribe</b> along with a pointer to the client's advise sink. <b>Subscribe</b> calls the advise sink's <b>IUnknown::AddRef</b> method to increment its reference count and MAPI retains the pointer until the registration is canceled. </p>
<p>
You can pass the NOTIFY_SYNC flag to <b>Subscribe</b> to request that <b>Notify</b> behave synchronously and not return until it has made all calls to the <b>IMAPIAdviseSink::OnNotify</b> methods of registered advise sinks. Set this flag only for your own internal use. Do not set it when responding to a client <b>Advise</b> call. Event notification between clients and providers is always asynchronous. That is, MAPI guarantees that the call during which an event happens will return to the client before any of the <b>OnNotify</b> calls are made. </p>
<p>
If you set the NOTIFY_SYNC flag, do not make any changes to any of the advise sink objects and do not pass a wrapper advise sink created by <a href="function_1fxn.htm"><b>HrThisThreadAdviseSink</b></a> to <b>Subscribe</b>. <b>HrThisThreadAdviseSink</b> creates a thread-safe version of an advise sink to be used with asynchronous notification only. </p>
<p>
If an advise sink registered for synchronous notification returns from <b>OnNotify</b> with the CALLBACK_DISCONTINUE flag set, <b>IMAPISupport::Notify </b>sets the NOTIFY_CANCELED flag and returns without making any calls to <b>OnNotify</b>. </p>
<p>
Once <b>Subscribe</b> has returned, you will no longer have any need to hold onto your copy of the client's advise sink. Call its <b>IUnknown::Release</b> method to release it. <b>Subscribe</b> returns a nonzero connection number that you should return to the client. The connection number represents the link between the advise source and the advise sink. It remains valid until the client makes a successful call to <b>Unadvise</b>. </p>
<p>
When the client is ready to cancel a registration, it calls your <b>Unadvise</b> method. Pass the connection number from the <b>Unadvise</b> call to <a href="inter025_3rhh.htm"><b>IMAPISupport::Unsubscribe</b></a>. <b>Unsubscribe</b> calls the advise sink's <b>IUnknown::Release</b> method. As with <b>Advise</b> and <b>Unadvise</b>, calls to <b>Subscribe</b> and <b>Unsubscribe</b> must be paired. You must make one call to <b>Unsubscribe</b> for every call that is made to <b>Subscribe</b>. However, you do not have to call <b>Subscribe</b> every time your <b>Advise</b> method is called. Conversely, you can call it for setting up internal notifications. </p>
<p>
When an event occurs, allocate one or more <a href="structyp_5dbi.htm"><b>NOTIFICATION</b></a> structures of the type appropriate for the event and call <a href="inter025_8fax.htm"><b>IMAPISupport::Notify</b></a>. <b>Notify</b> generates a notification for each registered advise sink. It is recommended that all the unused members of the <a href="structyp_5dbi.htm"><b>NOTIFICATION</b></a> structure be set to zero. This technique for initializing the <b>NOTIFICATION</b> structure can help clients create smaller, faster, and less error-prone <b>OnNotify</b> implementations. </p>
<p>
Note that a separate <b>NOTIFICATION</b> structure is necessary for each event, even for multiple events of the same type. For example, if three clients are registered for table notification on a particular table and five rows are added to the table, you must create five <b>OBJECT_NOTIFICATION</b> structures for your <b>Notify</b> call. A batch notification such as this results in better performance than calling <b>Notify</b> five times. For each <b>Notify</b> call, MAPI calls the <a href="inter010_4y2h.htm"><b>IMAPIAdviseSink::OnNotify</b></a> method of every registered advise sink. If there are no registered advise sinks, MAPI ignores the call. </p>
<p>
Service providers that send batched notifications must order them so that they can be interpreted from the first notification to the last. This ordering is especially necessary when a notification batch contains a series of events such as TABLE_ROW_ADDED and one event refers to a prior row that was added in another event in the same batch.</p>
<p>&nbsp;</p></body>
</HTML>
