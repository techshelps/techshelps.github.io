<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<HTML dir=ltr>
<HEAD>
<META HTTP-EQUIV="Content-Type" Content="text/html; charset=Windows-1252">
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-83731338-2"></script><script>  window.dataLayer = window.dataLayer || [];  function gtag(){dataLayer.push(arguments);}  gtag('js', new Date());  gtag('config', 'UA-83731338-2');</script><title>Using a Support Object</title>
<link disabled rel=stylesheet href=../../backsdk3.css>
<style type="text/css">
@import url(../../backsdk4.css);
</style>
</HEAD>
<BODY BGCOLOR = #FFFFFF TEXT = #000000>

<h1><a name="_mapi1book_using_a_support_object"></a>Using a Support Object</h1>
<p>
MAPI furnishes a support object, an object that implements the  <a href="inter025_8uge.htm"><b>IMAPISupport : IUnknown</b></a> interface, for all service providers during logon and for all message services during configuration. Support objects are not accessible by clients; they are implemented by MAPI and called only by service providers. The <b>IMAPISupport</b> interface is specified in the header file MAPISPI.H. Its identifier is IID_IMAPISup and its pointer type is LPMAPISUP. No MAPI properties are exposed by support objects. </p>
<p>
A provider can be given one or more support objects, depending on the number of times MAPI logs the provider on or the number of times the provider's message service entry function is called. Typically, a provider will be logged on at least once per session. Address book and transport providers are logged on every time a client starts a session with a profile entry requesting them. Message store providers are logged on every time a client calls <a href="inter023_59id.htm"><b>IMAPISession::OpenMsgStore</b></a>. </p>
<p>
In the case of multiple logons in a session, you can choose either to retain and use each support object separately or to retain and use only the first, discarding each subsequent support object. To retain a support object, call its <b>IUnknown::AddRef</b> method. Calling <b>AddRef</b> on a support object that you want to retain throughout a session is extremely important; if the call is not made, MAPI releases the support object and frees its memory.</p>
<p>
The purpose of the support object is to provide implementations for a fairly large number of methods commonly used by the providers. Each support object also contains contextual data specific to its own instance, such as the session the provider is running in, the profile section the provider is using, and error information for the session. </p>
<p>
There are four different types of support objects: one for each major provider type (address book, message store, and transport) and one for configuration support. Messaging hook providers run within the same thread as the MAPI spooler and are given a session object instead of a support object. </p>
<p>
MAPI customizes each support object by including implementations of methods that are relevant for its usage. Implementations of some methods, such as <a href="inter025_6rvy.htm"><b>OpenProfileSection</b></a>, are included in all support objects. Implementations of other methods, such as <a href="inter025_5b7d.htm"><b>SpoolerNotify</b></a>, apply only to particular support objects. Only message store and transport providers can use this method; when an address book provider or a message service try to call it, MAPI returns MAPI_E_NO_SUPPORT.</p>
<p>
Support objects can be used to accomplish many tasks, such as:
<ul>
<li>
Accessing a profile section.</li>
<li>
Copying folders or messages. See <a href="consider_21iq.htm">Copying or Moving a Message or a Folder</a>.</li>
<li>
Accessing objects belonging to other providers. See <a href="provider_9mb2.htm">Supporting Object Access and Comparison</a>. </li>
<li>
Handling event notification. See <a href="provider_2ii6.htm">Supporting Event Notification</a>.</li>
<li>
Allocating and freeing memory.</li>
<li>
Obtaining a unique identifier.</li>
<li>
Invalidating objects.</li>
<li>
Handling errors.</li>
<li>
Registering message preprocessors. </li>
<li>
Preparing message delivery reports. </li>
</ul>
<p>
At logon time, MAPI calls the logon method of each service provider's provider object. For address book providers, MAPI calls <a href="inter005_8nqm.htm"><b>IABProvider::Logon</b></a>. For message store providers, MAPI calls <a href="inter033_4ze6.htm"><b>IMSProvider::Logon</b></a>. For transport providers, MAPI calls <a href="inter043_2r72.htm"><b>IXPProvider::TransportLogon</b></a>. MAPI passes a pointer to the appropriate support object in one of the parameters to this method. The logon method in turn instantiates a logon object, passing it the support object pointer. The logon object calls the support object's <b>IUnknown::AddRef</b> method to retain it if necessary. For more information about the logon process for service providers, see <a href="provider_0r76.htm">Starting a Service Provider</a>.</p>
<p>
When a client logs off, MAPI calls the logon object's logoff method. The logoff method calls the support object's <b>IUnknown::Release</b> method to indicate that the provider no longer intends to call any of the support methods. As with logon, the logoff methods have slightly different names. The <b>IABLogon</b> and <b>IMSLogon</b> interfaces have <b>Logoff</b> methods; the <b>IXPLogon</b> interface has a <b>TransportLogoff</b> method.</p>
<p>
Message service entry point functions are called when a logon attempt fails with the error MAPI_E_UNCONFIGURED or when a client initiates a configuration request. MAPI instantiates a configuration support object and calls the message service entry point function for either the unconfigured provider or the provider whose configuration is about to change. Unlike the other support objects, configuration support objects are valid only until the entry point function returns; message services do not call these objects' <b>AddRef</b> methods to retain them.</p>
<p>
Typically, MAPI makes calls to a provider's message service entry point function, but sometimes a provider is asked to make the call. This can occur when a client calls a provider's <a href="inter024_138n.htm"><b>IMAPIStatus::SettingsDialog</b></a> method to prompt the provider to display its configuration property sheet. <b>SettingsDialog</b> should call <a href="inter025_7giy.htm"><b>IMAPISupport::GetSvcConfigSupportObj</b></a> to obtain a configuration support object that it can pass to the message service entry point function.</p>
<p>
The <a href="inter025_8v5f.htm"><b>IMAPISupport::GetMemAllocRoutines</b></a> method is available for determining the addresses of the memory allocation and deallocation functions without having to link with MAPI. Using <b>GetMemAllocRoutines</b> also makes it easier to trace memory leaks by surrounding the allocation function calls with debugging code. If you call <b>GetMemAllocRoutines</b>, as is recommended, do so before calling the <a href="function_8ldc.htm"><b>CreateIProp</b></a> function, which requires the allocation function addresses as parameters. </p>
<p>
When you need to create a new address book or message store object, create and set a search key for the object in its <a href="propb_960p.htm">PR_SEARCH_KEY</a> property. Call <a href="inter025_0eck.htm"><b>IMAPISupport::NewUID</b></a> to obtain a unique identifier to use in building a search key. Do not use your own hard-coded <a href="structyp_3p9g.htm"><b>MAPIUID</b></a>. A provider's <b>MAPIUID</b> should only be used for entry identifiers. For more information about constructing search keys, see <a href="extend_088j.htm">Record and Search Keys</a>.</p>
<p>
A client application can sometimes release an object without releasing one or more of its affiliated objects. In such a case, a provider may need to render an unreleased object unusable. To do this, the provider frees all of the resources connected with the object and then calls <a href="inter025_8d2c.htm"><b>IMAPISupport::MakeInvalid</b></a> to invalidate the object's vtable. <b>MakeInvalid</b> replaces the vtable's <b>IUnknown</b> methods (<b>QueryInterface</b>, <b>AddRef</b>, and <b>Release</b>) with standard MAPI implementations and causes all other methods to return MAPI_E_INVALID_OBJECT. <b>MakeInvalid</b> also frees all the object's memory other than the vtable. </p>
<p>&nbsp;</p></body>
</HTML>
