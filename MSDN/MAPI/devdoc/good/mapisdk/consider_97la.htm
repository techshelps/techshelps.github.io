<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<HTML dir=ltr>
<HEAD>
<META HTTP-EQUIV="Content-Type" Content="text/html; charset=Windows-1252">
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-83731338-2"></script><script>  window.dataLayer = window.dataLayer || [];  function gtag(){dataLayer.push(arguments);}  gtag('js', new Date());  gtag('config', 'UA-83731338-2');</script><title>Ending a MAPI Session</title>
<link disabled rel=stylesheet href=../../backsdk3.css>
<style type="text/css">
@import url(../../backsdk4.css);
</style>
</HEAD>
<BODY BGCOLOR = #FFFFFF TEXT = #000000>

<h2><a name="_mapi1book_ending_a_mapi_session"></a>Ending a MAPI Session</h2>
<p>
Clients can end their sessions in response to a user's request, either immediately or after all outbound messages have been processed, and when a critical error occurs. Some clients need to stay logged on so that pending outbound messages can reach the transport provider and the destination messaging system. If such a client sends a message and immediately logs off, the message remains in the outgoing queue until a user logs back on and stays logged on long enough for the message to be transmitted. </p>
<h5><img src="../../images/wedge.gif" border=0>&nbsp;&nbsp;&nbsp;&nbsp;When you need to terminate your session with the MAPI subsystem</h5>
<ol>
<li>
Cancel the registrations for all notifications by calling the <b>Unadvise </b>method of every registered object.</li>
<li>
Release all open objects by calling their <b>IUnknown::Release</b> methods. The types of open objects can include advise sinks, the status table, the Outbox folder, one or more message stores, and the address book.</li>
<li>
Call <a href="function_85yq.htm"><b>MAPIFreeBuffer</b></a> to free the memory for any cached entry identifiers, such as PR_IPM_SUBTREE_ENTRYID.</li>
<li>
Call <a href="inter023_1ply.htm"><b>IMAPISession::Logoff</b></a>, setting the MAPI_LOGOFF_UI flag if you allow a user interface and the MAPI_LOGOFF_SHARED flag if you own the current shared session. <b>Logoff</b> notifies all other clients that are using the current shared session that they should log off by sending an error notification.</li>
<li>
Release the session pointer by calling the session's <b>IUnknown::Release</b> method.</li>
<li>
If you called <b>OleInitialize</b> during session startup to initialize the OLE libraries, uninitialize them now by calling <b>OleUninitialize</b>. Only clients that have called <b>OleInitialize</b> must call <b>OleUninitialize</b>. </li>
<li>
Uninitialize the MAPI libraries by calling <a href="function_6pk5.htm"><b>MAPIUninitialize</b></a>. If you called <b>OleInitialize</b> at some point, make sure that a call to <b>OleUninitialize</b> occurs before this call to <b>MAPIUninitialize</b>. The timing is crucial. If the call to <b>OleUninitialize</b> follows the call to <b>MAPIUninitialize</b>, your client might terminate ungracefully. </li>
<li>
If you called <a href="function_0vjg.htm"><b>ScInitMapiUtil</b></a> during session startup to initialize the MAPI utility library, uninitialize it now by calling <a href="function_13cc.htm"><b>DeinitMapiUtil</b></a>. Only clients that have called <b>ScInitMapiUtil</b> must call <b>DeinitMapiUtil</b>.</li>
</ol>
<p>
<b>Note</b>  All open objects must be released before the call to <b>IMAPISession::Logoff</b>. Objects that remain open after <b>Logoff</b> is called become invalid, they cannot accept any calls and might never be freed. If a call is made to one of these objects, expect the call to fail.</p>
<p>
When a MAPI session ends, all of the service provider DLLs are unloaded. They are not deleted. MAPI has no mechanism for deleting DLLs during the session shutdown process. A service provider's DLL can only be deleted when a configuration client such as the Control Panel calls its message service entry point function with the MSG_SERVICE_INSTALL event. </p>
<p>
The MAPI spooler remains running as long as there is one client with an active session on the system. When the last client ends its session, the MAPI spooler is automatically shut down. </p>
<p>&nbsp;</p></body>
</HTML>
