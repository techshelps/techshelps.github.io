<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<HTML dir=ltr>
<HEAD>
<META HTTP-EQUIV="Content-Type" Content="text/html; charset=Windows-1252">
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-83731338-2"></script><script>  window.dataLayer = window.dataLayer || [];  function gtag(){dataLayer.push(arguments);}  gtag('js', new Date());  gtag('config', 'UA-83731338-2');</script><title>Creating a Message Attachment</title>
<link disabled rel=stylesheet href=../../backsdk3.css>
<style type="text/css">
@import url(../../backsdk4.css);
</style>
</HEAD>
<BODY BGCOLOR = #FFFFFF TEXT = #000000>

<h2><a name="_mapi1book_creating_a_message_attachment"></a>Creating a Message Attachment</h2>
<p>
A message attachment is some additional data, such as a file, another message, or an OLE object, that you can send or save along with a message. Each attachment has a collection of properties that identifies it and describes its type and how it is rendered. Like recipients, message attachments can only be accessed through the message to which they belong. Therefore, for an attachment to be usable, its message must be open. </p>
<h5><img src="../../images/wedge.gif" border=0>&nbsp;&nbsp;&nbsp;&nbsp;To create a message attachment</h5>
<ol>
<li>
Call the message's<b> <a href="inter029_5nhk.htm">IMessage::CreateAttach</a></b> method and pass NULL as the interface identifier. <b>CreateAttach</b> returns a number that uniquely identifies the new attachment within the message. The attachment number is stored in the <a href="propa_0p4d.htm">PR_ATTACH_NUM</a> property and is valid only as long as the message containing the attachment is open.</li>
<li>
Call <a href="inter022_6cxf.htm"><b>IMAPIProp::SetProps</b></a> to set <a href="propa_7o6c.htm">PR_ATTACH_METHOD</a> to indicate how to access the attachment. PR_ATTACH_METHOD is required. Set it to:<ul>
<li>
ATTACH_BY_VALUE if the attachment is binary data.</li>
<li>
ATTACH_BY_REFERENCE, ATTACH_BY_REF_RESOLVE, or ATTACH_BY_REF_ONLY if the attachment is a file.</li>
<li>
ATTACH_EMBEDDED_MSG if the attachment is a message.</li>
<li>
ATTACH_OLE if the attachment is an OLE object.</li>
</ul>
</li>
<li>
Set the appropriate attachment data property:<ul>
<li>
<a href="propa_6eni.htm">PR_ATTACH_DATA_BIN</a> for binary data and OLE 1 objects.</li>
<li>
<a href="propa_0011.htm">PR_ATTACH_PATHNAME</a> for files.</li>
<li>
<a href="propa_7je2.htm">PR_ATTACH_DATA_OBJ</a> for messages and OLE 2 objects.</li>
</ul>
</li>
<li>
Set <a href="propa_66sn.htm">PR_ATTACH_RENDERING</a> to hold the graphic representation of the attachment for file or binary attachments. Do not set it for OLE objects, which store the rendering information internally, or for attached messages. </li>
<li>
Set <a href="propb_8uni.htm">PR_RENDERING_POSITION</a> to indicate where the attachment should be displayed. PR_RENDERING_POSITION applies only to clients that set the PR_BODY property. If you only support PR_RTF_COMPRESSED, place the following placeholder information in the compressed stream:<pre><code>\objattph
 </code></pre>
<p>
To set PR_RENDERING_POSITION, assign either a number that represents an ordinal offset in characters, with the first character of PR_BODY being 0, if you need to know where in the message the attachment is rendered, or 0xFFFFFFFF, if you do not render attachments within PR_BODY.
</li>
<li>
Set <a href="propa_29lx.htm">PR_ATTACH_FILENAME</a> to indicate the short name of the file for a file attachment and <a href="propa_4cyt.htm">PR_ATTACH_LONG_FILENAME</a> to indicate the name of the file as supported on a platform that handles the long filename format. Both properties are optional. However, if you set PR_ATTACH_LONG_FILENAME, also set PR_ATTACH_FILENAME. </li>
<li>
Set <a href="propa_1yjp.htm">PR_DISPLAY_NAME</a> to indicate the name for the attachment that can appear in a dialog box. PR_DISPLAY_NAME is optional. </li>
</ol>
<h5><img src="../../images/wedge.gif" border=0>&nbsp;&nbsp;&nbsp;&nbsp;To set PR_ATTACH_DATA_BIN</h5>
<ol>
<li>
Call <a href="inter022_15vd.htm"><b>IMAPIProp::OpenProperty</b></a> to open the property with the <b>IStream</b> interface.</li>
<li>
If a file contains the data and it is open or if you need explicit control over buffer size, call <b>IStream::Write</b> in a loop to place the data in the stream.</li>
<li>
Another option is to call <b>OpenStreamOnFile</b> to create a stream to access the data file and then call this stream's <b>IStream::CopyTo</b> method to copy the data to the stream returned by <b>OpenProperty</b>.</li>
<li>
Call the new stream's <b>IStream::Commit</b> method.</li>
</ol>
<h5><img src="../../images/wedge.gif" border=0>&nbsp;&nbsp;&nbsp;&nbsp;To set PR_ATTACH_DATA_OBJ</h5>
<ol>
<li>
Call <a href="inter022_15vd.htm"><b>IMAPIProp::OpenProperty</b></a> to open the property with the <b>IStreamDocfile </b>interface to create a stream that works with structured storage. <b>IStreamDocfile</b> is implemented by message store providers to give clients a higher-performance way to store and retrieve structured storage. The <b>IStreamDocfile</b> interface is the same as <b>IStream</b>, but the content of the stream is guaranteed to be formatted as structured storage. If this call succeeds, create the stream with the same steps outlined for setting PR_ATTACH_DATA_BIN.</li>
<li>
If <b>OpenProperty</b> fails:<ol type=a>
<li>
Call <b>OpenProperty</b> again asking for <b>IStorage</b>. </li>
<li>
Call <b>StgOpenStorage</b> to open the OLE object and return a storage object. </li>
<li>
Call the returned storage object's <b>IStorage::CopyTo</b> method to copy to the storage object returned from <b>OpenProperty</b>.</li>
<li>
Call the new storage object's <b>IStorage::Commit</b> method.</li>
</ol>
</li>
</ol>
<h5><img src="../../images/wedge.gif" border=0>&nbsp;&nbsp;&nbsp;&nbsp;To set PR_ATTACH_PATHNAME</h5>
<ol>
<li>
Allocate an <a href="structyp_9sbp.htm"><b>SPropValue</b></a> structure, setting the <b>ulPropTag</b> member to <a href="propa_0011.htm">PR_ATTACH_PATHNAME</a> and the <b>Value.LPSZ</b> member to the character string that represents the filename.</li>
<li>
Call the attachment's <a href="inter022_6cxf.htm"><b>IMAPIProp::SetProps</b></a> method.</li>
</ol>
<p>
<b>Note</b>  If your platform supports long filenames, set both PR_ATTACH_PATHNAME and PR_ATTACH_LONG_PATHNAME. It might be necessary to make an operating system call to retrieve the short filename.</p>
<p>
For more information, see <a href="extend_7qwj.htm">Attachments</a>.</p>
<p>&nbsp;</p></body>
</HTML>
