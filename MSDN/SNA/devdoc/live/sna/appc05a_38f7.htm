<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<HTML dir=ltr>
<HEAD>
<META HTTP-EQUIV="Content-Type" Content="text/html; charset=Windows-1252">
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-83731338-2"></script><script>  window.dataLayer = window.dataLayer || [];  function gtag(){dataLayer.push(arguments);}  gtag('js', new Date());  gtag('config', 'UA-83731338-2');</script><title>MC_ALLOCATE</title>
<link disabled rel=stylesheet href=../../backsdk3.css>
<style type="text/css">
@import url(../../backsdk4.css);
</style>
</HEAD>
<BODY BGCOLOR = #FFFFFF TEXT = #000000>

<h1><a name="_sna_mc_allocate_appc"></a>MC_ALLOCATE</h1>
<p>
The <b>MC_ALLOCATE</b> verb is issued by the invoking TP. It allocates a session between the local LU and partner LU and (in conjunction with <a href="appc05b_0m77.htm"><b>RECEIVE_ALLOCATE</b></a>) establishes a conversation between the invoking TP and the invoked TP. After this verb executes successfully, APPC generates a conversation identifier (<b>conv_id</b>). The <b>conv_id</b> is a required parameter for all other APPC conversation verbs.</p>
<p>
For the Microsoft® Windows® version 3<i>.x</i> system, it is recommended that you use <a href="appc06_66sj.htm"><b>WinAsyncAPPC</b></a> rather than the blocking version of this call.</p>
<p>
The following structure describes the verb control block used by the <b>MC_ALLOCATE</b> verb.</p>
<pre><code>struct mc_allocate {
    unsigned short   opcode;
    unsigned char    opext;
    unsigned char    reserv2;
    unsigned short   primary_rc;
    unsigned long    secondary_rc;
    unsigned char    tp_id[8];
    unsigned long    conv_id;
    unsigned char    reserv3;
    unsigned char    synclevel;
    unsigned char    reserv4[2];
    unsigned char    rtn_ctl;
    unsigned char    reserv5;
    unsigned long    conv_group_id;
    unsigned long    sense_data;
    unsigned char    plu_alias[8];
    unsigned char    mode_name[8];
    unsigned char    tp_name[64];
    unsigned char    security;
    unsigned char    reserv6[11];
    unsigned char    pwd[10];
    unsigned char    user_id[10];
    unsigned short   pip_dlen;
    unsigned char FAR * pip_dptr;
    unsigned char    reserv7;
    unsigned char    fqplu_name[17];
    unsigned char    reserv8[8];
    unsigned long    proxy_user;
    unsigned long    proxy_domain;
    unsigned char    reserv9[16];
}; 
 </code></pre>
<h4>Members</h4>
<dl>
<dt>
<b>opcode</b></dt>
<dd>
Supplied parameter. Specifies the verb operation code; AP_M_ALLOCATE.</dd>
<dt>
<b>opext</b></dt>
<dd>
Supplied parameter. Specifies the verb operation extension, AP_MAPPED_CONVERSATION. If the AP_EXTD_VCB bit is set, this indicates that an extended version of the verb control block is used. In this case, the <b>MC_ALLOCATE</b> structure includes Sync Point support or privileged proxy feature support.</dd>
<dt>
<b>primary_rc</b></dt>
<dd>
Returned parameter. Specifies the primary return code set by APPC at the completion of the verb. The valid return codes vary depending on the APPC verb issued. See Return Codes for valid error codes for this verb.</dd>
<dt>
<b>secondary_rc</b></dt>
<dd>
Returned parameter. Specifies the secondary return code set by APPC at the completion of the verb. The valid return codes vary depending on the APPC verb issued. See Return Codes for valid error codes for this verb.</dd>
<dt>
<b>tp_id</b></dt>
<dd>
Supplied parameter. Identifies the local TP. The value of this parameter was returned by <a href="appc04_0fs3.htm"><b>TP_STARTED</b></a>.</dd>
<dt>
<b>conv_id</b></dt>
<dd>
Returned parameter. Identifies the conversation established between the two TPs.</dd>
<dt>
<b>synclevel</b></dt>
<dd>
Supplied parameter. Specifies the synchronization level of the conversation. It determines whether the TPs can request confirmation of receipt of data and confirm receipt of data.
<ul>
<li>
AP_NONE specifies that confirmation processing will not be used in this conversation.</li>
<li>
AP_CONFIRM_SYNC_LEVEL specifies that the TPs can use confirmation processing in this conversation. </li>
<li>
AP_SYNCPT specifies that TPs can use Sync Point Level 2 confirmation processing in this conversation. </li>
</ul>
</dd>
<dt>
<b>rtn_ctl</b></dt>
<dd>
Supplied parameter. Specifies when the local LU, acting on a session request from the local TP, should return control to the local TP. For information about sessions, see <a href="appc02wr_457n.htm">About Transaction Programs</a>.
<ul>
<li>
AP_IMMEDIATE specifies that the LU allocates a contention-winner session, if one is immediately available, and returns control to the TP.</li>
<li>
AP_WHEN_SESSION_ALLOCATED specifies that the LU does not return control to the TP until it allocates a session or encounters one of the errors documented in Return Codes in this topic. (If the session limit is zero, the LU returns control immediately.) If a session is not available, the TP waits for one.</li>
<li>
AP_WHEN_SESSION_FREE specifies that the LU allocates a contention-winner or contention-loser session, if one is available or able to be activated, and returns control to the TP. If an error occurs, (as documented in Return Codes in this topic) the call will return immediately with the error in the <b>primary_rc</b> and <b>secondary_rc</b> fields.</li>
<li>
AP_WHEN_CONWINNER_ALLOC specifies that the LU does not return control until it allocates a contention-winner session or encounters one of the errors documented in Return Codes in this topic. (If the session limit is zero, the LU returns control immediately.) If a session is not available, the TP waits for one.</li>
<li>
AP_WHEN_CONV_GROUP_ALLOC specifies that the LU does not return control to the TP until it allocates the session specified by <b>conv_group_id</b><i> </i>or encounters one of the errors documented in Return Codes in this topic. If a session is not available, the TP waits for it to become free.</li>
</ul>

<p>
Note that AP_IMMEDIATE is the only value for <b>rtn_ctl</b> that will never cause a new session to start. For values other than AP_IMMEDIATE, if an appropriate session is not immediately available, Microsoft® SNA Server will try to start one. This will cause the on-demand connection to be activated.
</dd>
<dt>
<b>conv_group_id</b></dt>
<dd>
Supplied/returned parameter. Specifies the identifier of the conversation group from which the session should be allocated. The <b>conv_group_id</b> is required only if<b> rtn_ctl</b><i> </i>is set to WHEN_CONV_GROUP_ALLOC. When<i> </i><b>rtn_ctl</b> specifies a different value and the <b>primary_rc</b> is ap_ok, this is a returned value.</dd>
<dt>
<b>sense_data</b></dt>
<dd>
Returned parameter. Indicates an allocation error (retry or no-retry) and contains sense data. </dd>
<dt>
<b>plu_alias</b></dt>
<dd>
Supplied parameter. Specifies the alias by which the partner LU is known to the local TP.
<p>
The <b>plu_alias</b> must match the name of a partner LU established during configuration.

<p>
The parameter is an 8-byte ASCII character string. It can consist of the following ASCII characters:

<ul>
<li>
Uppercase letters</li>
<li>
Numerals 0 through 9</li>
<li>
Spaces</li>
<li>
Special characters $, #, %, and @</li>
</ul>

<p>
The first character of this string cannot be a space.

<p>
If the value of this parameter is fewer than eight bytes, pad it on the right with ASCII spaces (0x20).

<p>
If you want to specify the partner LU with the <b>fqplu_name</b> parameter, fill this parameter with binary zeros.

<p>
For a user or group using TPs, 5250 emulators, and/or APPC applications, the system administrator can assign default local and remote LUs. In this case, the field is left blank or null and the default LUs are accessed when the user or group member starts an APPC program. For more information on default LUs, see the <i>Microsoft SNA Server Administration Guide</i>.
</dd>
<dt>
<b>mode_name</b></dt>
<dd>
Supplied parameter. Specifies the name of a set of networking characteristics defined during configuration.
<p>
The value of <b>mode_name</b> must match the name of a mode associated with the partner LU during configuration.

<p>
The parameter is an 8-byte EBCDIC character string. It can consist of characters from the type A EBCDIC character set:

<ul>
<li>
Uppercase letters</li>
<li>
Numerals 0 through 9</li>
<li>
Special characters $, #, and @</li>
</ul>

<p>
The first character in the string must be an uppercase letter or a special character.

<p>
Do not use SNASVCMG in a mapped conversation. SNASVCMG is a reserved <b>mode_name</b> used internally by APPC.
</dd>
<dt>
<b>tp_name</b></dt>
<dd>
Supplied parameter. Specifies the name of the invoked TP. The value of <b>tp_name</b> specified by <b>MC_ALLOCATE </b>in the invoking TP must match the value of <b>tp_name</b> specified by <a href="appc05b_0m77.htm"><b>RECEIVE_ALLOCATE</b></a> in the invoked TP.
<p>
The parameter is a 64-byte EBCDIC character string and is case-sensitive. The <b>tp_name</b> parameter can consist of the following EBCDIC characters:

<ul>
<li>
Uppercase and lowercase letters</li>
<li>
Numerals 0 through 9</li>
<li>
Special characters $, #, @, and period (.)</li>
</ul>

<p>
If <b>tp_name</b> is fewer than 64 bytes, use EBCDIC spaces (0x40) to pad it on the right.

<p>
The SNA convention is that a service TP name can have up to four characters. The first character is a hexadecimal byte between 0x00 and 0x3F. The other characters are from the type AE EBCDIC character set.
</dd>
<dt>
<b>security</b></dt>
<dd>
Supplied parameter. Provides the information that the partner LU requires to validate access to the invoked TP.
<p>
Based on the conversation security established for the invoked TP during configuration, use one of the following values:

<ul>
<li>
AP_NONE for an invoked TP that uses no conversation security.</li>
<li>
AP_PGM for an invoked TP that uses conversation security and thus requires a user identifier and password. Supply this information through the <b>user_id</b> and <b>pwd</b> parameters.</li>
<li>
AP_PROXY_PGM for an invoked TP with privileged proxy that uses conversation security and thus requires a user identifier and password. Pointers must be set up for <b>proxy_user</b> and <b>proxy_domain</b> to point to UNICODE strings containing the user name and domain name of the user to be impersonated. The application does not need to set the <b>user_id</b> and <b>pwd</b> fields. </li>
<li>
AP_PROXY_SAME for a TP that has been invoked using privileged proxy with a valid user identifier and password supplied by the proxy, which in turn invokes another TP. Pointers must be set up for <b>proxy_user</b> and <b>proxy_domain</b> to point to UNICODE strings containing the user name and domain name of the user to be impersonated. The application does not need to set the <b>user_id</b> and <b>pwd</b> fields. <p>
For example, assume that TP A invokes TP B with a valid user identifier and password supplied by the privileged proxy, and TP B in turn invokes TP C. If TP B specifies the value AP_PROXY_SAME, APPC will send the LU for TP C the user identifier from TP A and an already-verified indicator. This indicator tells TP C to not require the password (if TP C is configured to accept an already-verified indicator).
</li>
<li>
AP_PROXY_STRONG for an invoked TP with privileged proxy that uses conversation security and thus requires a user identifier and password provided by the privileged proxy mechanism. Pointers must be set up for <b>proxy_user</b> and <b>proxy_domain</b> to point to UNICODE strings containing the user name and domain name of the user to be impersonated. The application does not need to set the <b>user_id</b> and <b>pwd</b> fields. AP_PROXY_STRONG differs from AP_PROXY_PGM in that AP_PROXY_STRONG does not allow clear-text passwords. If the remote system does not support encrypted passwords (strong conversation security), then this call fails. </li>
<li>
AP_SAME for a TP that has been invoked with a valid user identifier and password, which in turn invokes another TP.<p>
For example, assume that TP A invokes TP B with a valid user identifier and password, and TP B in turn invokes TP C. If TP B specifies the value AP_SAME, APPC will send the LU for TP C the user identifier from TP A and an already-verified indicator. This indicator tells TP C to not require the password (if TP C is configured to accept an already-verified indicator).
</li>
<li>
AP_STRONG for an invoked TP that uses conversation security and thus requires a user identifier and password. Supply this information through the <b>user_id</b> and <b>pwd</b> parameters. AP_STRONG differs from AP_PGM in that AP_STRONG does not allow clear-text passwords. If the remote system does not support encrypted passwords (strong conversation security), then this call fails. </li>
</ul>

<p>
If the APPC automatic logon feature is to be used, <b>security</b> must be set to AP_PGM. See the Remarks section for details.

</dd>
<dt>
<b>pwd</b></dt>
<dd>
Supplied parameter. Specifies the password associated with <b>user_id</b>.
<p>
The <b>pwd</b> parameter is required only if <b>security</b> is set to AP_PGM. It must match the password for <b>user_id</b> that was established during configuration.

<p>
The <b>pwd</b> parameter is a 10-byte EBCDIC character string and is case-sensitive. It can consist of the following EBCDIC characters:

<ul>
<li>
Uppercase and lowercase letters</li>
<li>
Numerals 0 through 9</li>
<li>
Special characters $, #, @, and period (.)</li>
</ul>

<p>
If the password is fewer than 10 bytes, use EBCDIC spaces (0x40) to pad it on the right.

<p>
If the APPC automatic logon feature is to be used, the <b>pwd</b> character string must be hard-coded to MS$SAME. See the Remarks section for details.
</dd>
<dt>
<b>user_id</b></dt>
<dd>
Supplied parameter. Specifies the user identifier required to access the partner TP. It is required only if the security parameter is set to AP_PGM.
<p>
The <b>user_id</b> parameter is a 10-byte EBCDIC character string and is case-sensitive. It must match one of the user identifiers configured for the partner TP.

<p>
The parameter can consist of the following EBCDIC characters:

<ul>
<li>
Uppercase and lowercase letters</li>
<li>
Numerals 0 through 9</li>
<li>
Special characters $, #, @, and period (.)</li>
</ul>

<p>
If <b>user_id</b> is fewer than 10 bytes, use EBCDIC spaces (0x40) to pad it on the right.

<p>
If the APPC automatic logon feature is to be used, the <b>user_id </b>character string must be hard-coded to MS$SAME. See the Remarks section for details.
</dd>
<dt>
<b>pip_dlen</b></dt>
<dd>
Supplied parameter. Specifies the length of the program initialization parameters (PIP) to be passed to the partner TP. The range is from 0 through 32767.</dd>
<dt>
<b>pip_dptr</b></dt>
<dd>
Supplied parameter. Specifies the address of the buffer containing PIP data. Use this parameter only if <b>pip_dlen</b> is greater than zero.
<p>
PIP data can consist of initialization parameters or environmental setup information required by a partner TP or remote operating system. The PIP data must follow the general data stream (GDS) format. For more information, see your IBM SNA manual(s).

<p>
For Windows NT, Windows 95, and Windows 3.x, the data buffer can reside in a static data area or in a globally allocated area. The data buffer must fit entirely within this area.

<p>
For OS/2, the PIP data buffer must reside on an unnamed, shared segment, which is allocated by the function <b>DosAllocSeg </b>with <b>Flags</b> equal to 1. The PIP data buffer must fit entirely on the segment.
</dd>
<dt>
<b>fqplu_name</b></dt>
<dd>
Supplied parameter. Specifies the fully qualified name of the partner LU. This must match the fully qualified name of the local LU defined in the remote node. The parameter consists of two type A EBCDIC character strings for the NETID and the LU name of the partner LU. The names are separated by an EBCDIC period (.). 
<p>
This name must be provided if no <b>plu_alias</b> is specified. It can consist of the following EBCDIC characters:

<ul>
<li>
Uppercase letters</li>
<li>
Numerals 0 through 9</li>
<li>
Special characters $, #, and @</li>
</ul>

<p>
If the value of this parameter is fewer than 17 bytes, pad it on the right with EBCDIC spaces (0x40).

</dd>
</dl>
<h4>Return Codes</h4>
<dl>
<dt>
ap_ok</dt>
<dd>
Primary return code; the verb executed successfully.</dd>
<dt>
ap_unsuccessful</dt>
<dd>
Primary return code; the supplied parameter <b>rtn_ctl</b> specified immediate (AP_IMMEDIATE) return of control to the TP, and the local LU did not have an available contention-winner session.</dd>
<dt>
ap_parameter_check</dt>
<dd>
Primary return code; the verb did not execute because of a parameter error.
<dl>
<dt>
ap_bad_return_control</dt>
<dd>
Secondary return code; the value specified for <b>rtn_ctl</b> was invalid.</dd>
<dt>
ap_bad_security</dt>
<dd>
Secondary return code; the value specified for <b>security</b> was invalid.</dd>
<dt>
ap_bad_sync_level</dt>
<dd>
Secondary return code; the value specified for <b>sync_level</b> was invalid.</dd>
<dt>
ap_bad_tp_id</dt>
<dd>
Secondary return code; the value specified for <b>tp_id</b> was invalid.</dd>
<dt>
ap_pip_len_incorrect</dt>
<dd>
Secondary return code; the value of <b>pip_dlen</b> was greater than 32767.</dd>
<dt>
ap_unknown_partner_mode</dt>
<dd>
Secondary return code; the value specified for <b>mode_name</b> was invalid.</dd>
<dt>
ap_bad_partner_lu_alias</dt>
<dd>
Secondary return code; APPC did not recognize the supplied <b>partner_lu_alias</b>.</dd>
<dt>
ap_no_use_of_snasvcmg</dt>
<dd>
Secondary return code; SNASVCMG is not a valid value for <b>mode_name</b>.</dd>
<dt>
ap_invalid_data_segment</dt>
<dd>
Secondary return code; the PIP data was longer than the allocated data segment, or the address of the PIP data buffer was wrong.
</dd>
</dl>
</dd>
<dt>
ap_allocation_error</dt>
<dd>
Primary return code; APPC has failed to allocate a conversation. The conversation state is set to RESET.
<p>
This code can be returned through a verb issued after <b>MC_ALLOCATE</b>.

<dl>
<dt>
ap_allocation_failure_no_retry</dt>
<dd>
Secondary return code; the conversation cannot be allocated because of a permanent condition, such as a configuration error or session protocol error. To determine the error, the system administrator should examine the error log file. Do not retry the allocation until the error has been corrected.</dd>
<dt>
ap_allocation_failure_retry</dt>
<dd>
Secondary return code; the conversation could not be allocated because of a temporary condition, such as a link failure. The reason for the failure is logged in the system error log. Retry the allocation.
</dd>
</dl>
</dd>
<dt>
ap_comm_subsystem_abended</dt>
<dd>
Primary return code; indicates one of the following conditions:
<ul>
<li>
The node used by this conversation encountered an ABEND.</li>
<li>
The connection between the TP and the PU 2.1 node has been broken (a LAN error).</li>
<li>
The SnaBase at the TP's computer encountered an ABEND.</li>
</ul>

<p>
The system administrator should examine the error log to determine the reason for the ABEND.
</dd>
<dt>
ap_comm_subsystem_not_loaded</dt>
<dd>
Primary return code; a required component could not be loaded or terminated while processing the verb. Thus, communication could not take place. Contact the system administrator for corrective action.
<p>
When this return code is used with <b>MC_ALLOCATE</b>, it can indicate that no communications subsystem could be found to support the local LU. (For example, the local LU alias specified with <a href="appc04_0fs3.htm"><b>TP_STARTED</b></a> is incorrect or has not been configured.) Note that if <b>lu_alias</b> or <b>mode_name</b> is fewer than eight characters, you must ensure that these fields are filled with spaces to the right. This error is returned if these parameters are not filled with spaces, since there is no node available that can satisfy the <b>MC_ALLOCATE</b> request.

<p>
When <b>MC_ALLOCATE</b> produces this return code for an SNA Server system configured with multiple nodes, there are two secondary return codes as follows:

<dl>
<dt>
0xF0000001</dt>
<dd>
Secondary return code; no nodes have been started.</dd>
<dt>
0x<small>f0000002</small></dt>
<dd>
Secondary return code; at least one node has been started, but the local LU (when <b>TP_STARTED</b> is issued) is not configured on any active nodes. The problem could be either of the following:
<table cellspacing=4 cols=1>
<tr valign=top>
<td width=100%><font face="Symbol">·</font>&nbsp;&nbsp;&nbsp;&nbsp;The node with the local LU is not started.</td>
</tr>
<tr valign=top>
<td width=100%><font face="Symbol">·</font>&nbsp;&nbsp;&nbsp;&nbsp;The local LU is not configured.</td>
</tr>
</table><br>

</dd>
</dl>
</dd>
<dt>
ap_invalid_verb_segment</dt>
<dd>
Primary return code; the VCB extended beyond the end of the data segment.</dd>
<dt>
ap_stack_too_small</dt>
<dd>
Primary return code; the stack size of the application is too small to execute the verb. Increase the stack size of your application.</dd>
<dt>
ap_conv_busy</dt>
<dd>
Primary return code; there can only be one outstanding conversation verb at a time on any conversation. This can occur if the local TP has multiple threads, and more than one thread is issuing APPC calls using the same <b>conv_id</b>.</dd>
<dt>
ap_thread_blocking</dt>
<dd>
Primary return code; the calling thread is already in a blocking call.</dd>
<dt>
ap_unexpected_dos_error</dt>
<dd>
Primary return code; the operating system has returned an error to APPC while processing an APPC call from the local TP. The operating system return code is returned through the <b>secondary_rc</b>. It appears in Intel byte-swapped order. If the problem persists, consult the system administrator.
</dd>
</dl>
<h4>Remarks</h4>
<p>
<b>MC_ALLOCATE</b> establishes a mapped conversation.</p>
<p>
The conversation state is RESET when the TP issues this verb. After successful execution (<b>primary_rc</b> is ap_ok), the state changes to SEND. If the verb does not execute, the state remains unchanged.</p>
<p>
Several parameters of <b>MC_ALLOCATE</b> are EBCDIC or ASCII strings. A TP can use the CSV <a href="appc08c_2vvn.htm"><b>CONVERT</b></a> to translate a string from one character set to the other.</p>
<p>
To send the <b>MC_ALLOCATE</b> request immediately, the invoking TP can issue <a href="appc05a_0axv.htm"><b>MC_FLUSH</b></a> or <a href="appc05a_0b8j.htm"><b>MC_CONFIRM</b></a> immediately after <b>MC_ALLOCATE</b>. Otherwise, the <b>MC_ALLOCATE</b> request accumulates with other data in the local LU's send buffer until the buffer is full.</p>
<p>
By issuing <b>MC_CONFIRM</b> after <b>MC_ALLOCATE</b>, the invoking TP can immediately determine whether the allocation was successful (if <b>synclevel</b> is set to AP_CONFIRM_SYNC_LEVEL).</p>
<p>
Normally, the value of the <b>MC_ALLOCATE</b> verb's <b>mode_name</b> parameter must match the name of a mode configured for the invoked TP's node and associated during configuration with the partner LU.</p>
<p>
If one of the modes associated with the partner LU on the invoked TP's node is an implicit mode, the session established between the two LUs will be of the implicit mode when no mode name associated with the partner LU matches the value of <b>mode_name</b>.</p>
<p>
SNA Server supports a feature called password substitution. This is a security feature supported by the latest version of the OS/400 operating system (V3R1) which encrypts any password that flows between two nodes on an Attach message. A password flows on an Attach whenever someone invokes an APPC transaction program specifying a user identifier and password. For example, this happens whenever anyone logs on to an AS/400.</p>
<p>
Support for password substitution is indicated by setting bit 5 in byte 23 of the BIND request to 1 (which indicates that password substitution is supported). If the remote system sets this bit in the BIND response, SNA Server automatically encrypts the LU 6.2 conversation security password included in the FMH-5 Attach message. SNA Server APPC applications automatically take advantage of this feature by setting the <b>security</b> field of the VCB to AP_PGM or AP_STRONG in the <b>MC_ALLOCATE</b> request.</p>
<p>
If an APPC application wants to force an encrypted password to flow, the application can specify AP_STRONG for the <b>security</b> field in the VCB in the <b>MC_ALLOCATE</b> request. This option is implemented as defined in OS/400 V3R1, and is documented in the OS/400 CPIC programmer reference as CM_SECURITY_PROGRAM_STRONG, where the LU 6.2 <b>pwd</b> (password) field is encrypted before it flows over the physical network.</p>
<p>
The password substitution features is currently only supported by OS/400 V3R1 or later. If the remote system does not support this feature, SNA Server will UNBIND the session with the sense code of 10060006. The two nodes negotiate whether or not they support this feature in the BIND exchange. SNA Server sets a bit in the BIND, and also adds some random data on the BIND for encryption. If the remote node supports password substitution, it sets the same bit in the BIND response, and adds some (different) random data for decryption. </p>
<p>
SNA Server version 3.0 with Service Pack 1 or later and SNA Server version 4.0 support automatic logon for APPC applications. This feature requires specific configuration by the network administrator: The APPC application must be invoked on the LAN side from a client of SNA Server. The client must be logged into a Windows NT domain, but can be any platform that supports SNA Server's APPC APIs.</p>
<p>
The client application is coded to use "program" level security, with a special hard-coded APPC user name MS$SAME and password MS$SAME. When this session allocation flows from client to SNA Server, the SNA Server looks up the host account and password corresponding to the Windows NT account under which the client is logged in, and substitutes the host account information into the APPC attach message it sends to the host.</p>
<p>
<b>Note</b>&nbsp;&nbsp;It is illegal for the remote node to set the bit specifying password substitution and not add the random data.</p>
<p>
According to IBM, there are implementations of LU 6.2 password substitution that do not support password substitution but do echo the password substitution bit back to SNA Server, without specifying any random data. When they do this, SNA Server will UNBIND the session with the sense code 10060006.This sense code is interpreted as:
<ul>
<li>
1006 = Required field or parameter missing.</li>
<li>
0006 = A required subfield of a control vector was omitted.</li>
</ul>
<p>
SNA Server should also log an Event 17 (APPC session activation failure: BIND negative response sent).</p>
<p>
The correct solution is for the failing implementation to be fixed. However, as a short-term workaround, the following SNA Server service registry setting can be set: </p>
<p>
<b>HKEY_LOCAL_MACHINE\\SYSTEM\CurrentControlSet\Services\snaservr\parameters</b>\NOPWDSUB: REG_SZ: YES</p>
<p>
When this parameter is specified in the registry, SNA Server's password substitution support will be disabled.</p>
<p>
Several updates have been made to SNA Server to allow a privileged APPC application to open an APPC conversation using the Single Signon feature on behalf of any defined Windows NT user. This is referred to as the privileged proxy feature. An extension has been added to the APPC <b>MC_ALLOCATE</b> verb to invoke this feature. </p>
<p>
An APPC application becomes privileged by being started in a Windows NT user account that is a member of a special Windows NT group. When a Host Security Domain is configured, SNA Server Manager will define a second Windows NT group for use with the host security features of SNA Server. If the user account under which the actual client is running is a member of this second Windows NT group, the client is privileged to initiate an APPC conversation on behalf of any user account defined in the Host Account Cache.</p>
<p>
The following illustrates how the privileged proxy feature works:</p>
<p class=indent1>
The SNA Server administrator creates a Host Security Domain called APP. SNA Server Manager now creates two Windows NT groups. The first group is called APP and the second is called APP_PROXY for this example. Users that are assigned to the APP group are enabled for single signon. Users assigned to the APP_PROXY group are privileged proxies. The administrator adds the Windows NT user AppcUser to the APP_PROXY group using the Users button on the Host Security Domain property dialog box in SNA Server Manager.</p>
<p class=indent1>
The administrator then sets up an APPC application on the SNA Server to run as a Windows NT service called APPCAPP and that service has been setup to operate under the AppcUser user account. When APPCAPP runs, it opens an APPC session via an ALLOCATE verb using the extended VCB format and specifies the Windows NT username of the desired user, UserA (for example).</p>
<p class=indent1>
The SNA Server service sees the session request coming from a connection that is a member of the Host Security Domain APP. The Client/Server interface tells the SNA Server service that the actual client is AppcUser.</p>
<p class=indent1>
The SNA Server service checks to see if AppcUser is a member of the APP_PROXY group. Because AppcUser is a member of APP_PROXY, the SNA Server service inserts the Username/Password for UserA in the APPC Attach (FMH-5) command and sends it off to the partner TP.</p>
<p>
In order to support the privileged proxy feature, the APPC application must implement the following program logic: </p>
<p class=indent1>
The APPC application must determine the Windows NT user ID and domain name that it wishes to impersonate.</p>
<p class=indent1>
The APPC application must set the following parameters before calling the <b>MC_ALLOCATE</b> verb:</p>
<p>
Enable the use of the extended <b>MC_ALLOCATE</b> verb control block structure by setting the AP_EXTD_VCB flag in the <b>opext</b> field.</p>
<p>
Set <b>security</b> to AP_PROXY_SAME, AP_PROXY_PGM or AP_PROXY_STRONG.</p>
<p>
Set up the pointers for <b>proxy_user</b> and <b>proxy_domain</b> to point to UNICODE strings containing the user name and domain name of the user to be impersonated.</p>
<p>
NOTE: The application does not need to set up the <b>user_id</b> and <b>pwd</b> fields in the <b>MC_ALLOCATE</b> VCB.</p>
<p>
When the APPC application performs the above steps and issues the <b>MC_ALLOCATE</b> verb, the SNA Server will perform a lookup in the host security domain for the specified Windows NT user and set the user ID and password fields in the FMH-5 Attach message sent to the remote system.</p>
<p>&nbsp;</p></body>
</HTML>
