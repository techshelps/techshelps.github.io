<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<HTML>
<HEAD>
<META HTTP-EQUIV="Content-Type" Content="text/html; charset=Windows-1252">
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-83731338-2"></script><script>  window.dataLayer = window.dataLayer || [];  function gtag(){dataLayer.push(arguments);}  gtag('js', new Date());  gtag('config', 'UA-83731338-2');</script><title>Windows Sockets: How Sockets with Archives Work</TITLE>
<style>@import url(stylesheets/msdn_ie4.css);</style>
<link disabled rel="stylesheet" href="stylesheets/msdn_ie3.css"></HEAD>
<BODY>

<TABLE ALIGN=right WIDTH=0 BORDER=0><TR><TD>
<OBJECT ID="hhobj_1" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink">
	<PARAM NAME="DefaultTopic" VALUE="_topic_not_found.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="_vc_addpf_home">
</OBJECT>
<OBJECT ID="hhobj_2" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink">
	<PARAM NAME="DefaultTopic" VALUE="_topic_not_found.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="_MFC_CSocket">
</OBJECT>
<OBJECT ID="hhobj_3" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink">
	<PARAM NAME="DefaultTopic" VALUE="_topic_not_found.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="_MFC_CSocketFile">
</OBJECT>
<OBJECT ID="hhobj_4" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink">
	<PARAM NAME="DefaultTopic" VALUE="_topic_not_found.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="_MFC_CArchive">
</OBJECT>
<OBJECT ID="hhobj_5" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink">
	<PARAM NAME="DefaultTopic" VALUE="_topic_not_found.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="_mfc_CObject.3a3a.Serialize">
</OBJECT>
<OBJECT ID="hhobj_6" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink">
	<PARAM NAME="DefaultTopic" VALUE="_topic_not_found.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="_MFC_CFile">
</OBJECT>
<OBJECT ID="hhobj_7" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink">
	<PARAM NAME="DefaultTopic" VALUE="_topic_not_found.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="_MFC_CFile">
</OBJECT>
<OBJECT ID="hhobj_8" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink">
	<PARAM NAME="DefaultTopic" VALUE="_topic_not_found.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="_MFC_CSocketFile">
</OBJECT>
<OBJECT ID="hhobj_9" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink">
	<PARAM NAME="DefaultTopic" VALUE="_topic_not_found.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="_MFC_CNotSupportedException">
</OBJECT>
<OBJECT ID="hhobj_10" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink">
	<PARAM NAME="DefaultTopic" VALUE="_topic_not_found.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="_MFC_CArchive">
</OBJECT>
<OBJECT ID="hhobj_11" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink">
	<PARAM NAME="DefaultTopic" VALUE="_topic_not_found.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="_MFC_CSocketFile">
</OBJECT>
<OBJECT ID="hhobj_12" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink">
	<PARAM NAME="DefaultTopic" VALUE="_topic_not_found.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="_MFC_CSocket">
</OBJECT>
<OBJECT ID="hhobj_13" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink">
	<PARAM NAME="DefaultTopic" VALUE="_topic_not_found.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="_sample_mfc_CHATTER">
</OBJECT>
<OBJECT ID="hhobj_14" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink">
	<PARAM NAME="DefaultTopic" VALUE="_topic_not_found.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="_sample_mfc_CHATSRVR">
</OBJECT>
<OBJECT ID="hhobj_15" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink">
	<PARAM NAME="DefaultTopic" VALUE="_topic_not_found.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="MFC Samples">
</OBJECT>
<OBJECT ID="hhobj_16" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink">
	<PARAM NAME="DefaultTopic" VALUE="_topic_not_found.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="_mfc_CArchive.3a3a.IsBufferEmpty">
</OBJECT>
<OBJECT ID="hhobj_17" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink">
	<PARAM NAME="DefaultTopic" VALUE="_topic_not_found.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="_mfc_CObject.3a3a.Serialize">
</OBJECT>
</TD></TR></TABLE>


<font face="verdana,arial,helvetica" size="2">
<H1><A NAME="_core_windows_sockets.3a_.how_sockets_with_archives_work"></A>Windows Sockets: How Sockets with Archives Work</H1>

<P><A HREF="JavaScript:hhobj_1.Click()">Home</A>  |&nbsp; <A HREF="_core_windows_sockets_for_network_programming.3a_.overview.htm">Overview</A>  |&nbsp; <A HREF="_core_windows_sockets_tasks.htm">How Do I</A>  |&nbsp; <A HREF="_core_windows_sockets_sample_list.htm">Sample</A></P>

<P>This article explains how a <A HREF="JavaScript:hhobj_2.Click()">CSocket</A> object, a <A HREF="JavaScript:hhobj_3.Click()">CSocketFile</A> object, and a <A HREF="JavaScript:hhobj_4.Click()">CArchive</A> object are combined to simplify sending and receiving data via a Windows socket.</P>

<P>The article <A HREF="_core_windows_sockets.3a_.example_of_sockets_using_archives.htm">Windows Sockets: Example of Sockets Using Archives</A> presents the <CODE>PacketSerialize</CODE> function. The archive object in the <CODE>PacketSerialize</CODE> example works much like an archive object passed to an MFC <A HREF="JavaScript:hhobj_5.Click()">Serialize</A> function. The essential difference is that for sockets, the archive is attached not to a standard <A HREF="JavaScript:hhobj_6.Click()">CFile</A> object (typically associated with a disk file) but to a <B>CSocketFile</B> object. Rather than connecting to a disk file, the <B>CSocketFile</B> object connects to a <B>CSocket</B> object.</P>

<P>A <B>CArchive</B> object manages a buffer. When the buffer of a storing (sending) archive is full, an associated <B>CFile</B> object writes out the buffer’s contents. Flushing the buffer of an archive attached to a socket is equivalent to sending a message. When the buffer of a loading (receiving) archive is full, the <B>CFile</B> object stops reading until the buffer is available again. </P>

<P>Class <B>CSocketFile</B> derives from <B>CFile</B>, but it doesn’t support <A HREF="JavaScript:hhobj_7.Click()">CFile</A> member functions such as the positioning functions (<B>Seek</B>, <B>GetLength</B>, <B>SetLength</B>, and so on), the locking functions (<B>LockRange</B>, <B>UnlockRange</B>), or the <B>GetPosition</B> function. All the <A HREF="JavaScript:hhobj_8.Click()">CSocketFile</A> object must do is write or read sequences of bytes to or from the associated <B>CSocket</B> object. Because a file is not involved, operations such as <B>Seek</B> and <B>GetPosition</B> make no sense. <B>CSocketFile</B> is derived from <B>CFile</B>, so it would normally inherit all of these member functions. To prevent this, the unsupported <B>CFile</B> member functions are overridden in <B>CSocketFile</B> to throw a <A HREF="JavaScript:hhobj_9.Click()">CNotSupportedException</A>.</P>

<P>The <B>CSocketFile</B> object calls member functions of its <B>CSocket</B> object to send or receive data.</P>

<P>The following figure shows the relationships among these objects on both sides of the communication. </P>

<P class=label><B>CArchive, CSocketFile, and CSocket</B></P>

<P><IMG SRC="mwsarch.gif" ALT="" BORDER=0></P>

<P>The purpose of this apparent complexity is to shield you from the necessity of managing the details of the socket yourself. You simply create the socket, the file, and the archive, then begin sending or receiving data by inserting it to the archive or extracting it from the archive. <A HREF="JavaScript:hhobj_10.Click()">CArchive</A>, <A HREF="JavaScript:hhobj_11.Click()">CSocketFile</A>, and <A HREF="JavaScript:hhobj_12.Click()">CSocket</A> manage the details behind the scenes.</P>

<P>A <B>CSocket</B> object is actually a two-state object: sometimes asynchronous (the usual state) and sometimes synchronous. In its asynchronous state, a socket can receive asynchronous notifications from the framework. But during an operation such as receiving or sending data the socket becomes synchronous. This means the socket will receive no further asynchronous notifications until the synchronous operation has completed. Because it switches modes, you can, for example, do something like the following:</P>

<PRE><CODE>CMySocket::OnReceive( )
{
    // ...
    ar &gt;&gt; str;
    // ...
}
</CODE></PRE>

<P>If <B>CSocket</B> were not implemented as a two-state object, it might be possible to receive additional notifications for the same kind of event while you were processing a previous notification. For example, you might get an <CODE>OnReceive</CODE> notification while processing an <CODE>OnReceive</CODE>. In the code fragment above, extracting <CODE>str</CODE> from the archive might lead to recursion. By switching states, <B>CSocket</B> prevents recursion by preventing additional notifications. The general rule is: no notifications within notifications.</P>

<P>The <A HREF="JavaScript:hhobj_13.Click()">CHATTER</A> and <A HREF="JavaScript:hhobj_14.Click()">CHATSRVR</A> sample applications illustrate such usage. For source code and information about MFC samples, see <A HREF="JavaScript:hhobj_15.Click()">MFC Samples</A>. </P>

<P class=indent><B><B>Note</B></B>&nbsp;&nbsp;&nbsp;A <B>CSocketFile</B> can also be used as a (limited) file without a <B>CArchive</B> object. By default, the <B>CSocketFile</B> constructor’s <I>bArchiveCompatible</I> parameter is <B>TRUE</B>. This specifies that the file object is for use with an archive. To use the file object without an archive, pass <B>FALSE</B> in the <I>bArchiveCompatible</I> parameter. </P>

<P class=indent>In its “archive compatible” mode, a <B>CSocketFile</B> object provides better performance and reduces the danger of a “deadlock.” A deadlock occurs when both the sending and receiving sockets are waiting on each other, or waiting for a common resource. This situation might occur if the <B>CArchive</B> object worked with the <B>CSocketFile</B> the way it does with a <B>CFile</B> object. With <B>CFile</B>, the archive can assume that if it receives fewer bytes than it requested, the end of file has been reached. With <B>CSocketFile</B>, however, data is message based; the buffer can contain multiple messages, so receiving fewer than the number of bytes requested does not imply end of file. The application doesn’t block in this case as it might with <B>CFile</B>, and it can continue reading messages from the buffer until the buffer is empty. The <A HREF="JavaScript:hhobj_16.Click()">IsBufferEmpty</A> function in <B>CArchive</B> is useful for monitoring the state of the archive’s buffer in such a case.</P>

<H3>What do you want to know more about?</H3>

<UL type=disc>
	<LI><A HREF="_core_windows_sockets.3a_.using_sockets_with_archives.htm">Windows Sockets: Using Sockets with Archives</A></LI>
</UL>

<P><B>See Also</B>&nbsp;&nbsp;&nbsp;<A HREF="JavaScript:hhobj_17.Click()">CObject::Serialize</A> </P>
</font>
</BODY>
</HTML>
