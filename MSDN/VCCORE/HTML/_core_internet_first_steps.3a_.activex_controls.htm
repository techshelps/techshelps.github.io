<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<HTML>
<HEAD>
<META HTTP-EQUIV="Content-Type" Content="text/html; charset=Windows-1252">
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-83731338-2"></script><script>  window.dataLayer = window.dataLayer || [];  function gtag(){dataLayer.push(arguments);}  gtag('js', new Date());  gtag('config', 'UA-83731338-2');</script><title>Internet First Steps: ActiveX Controls</TITLE>
<style>@import url(stylesheets/msdn_ie4.css);</style>
<link disabled rel="stylesheet" href="stylesheets/msdn_ie3.css"></HEAD>
<BODY>

<TABLE ALIGN=right WIDTH=0 BORDER=0><TR><TD>
<OBJECT ID="hhobj_1" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink">
	<PARAM NAME="DefaultTopic" VALUE="_topic_not_found.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="_vc_addpf_home">
</OBJECT>
<OBJECT ID="hhobj_2" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink">
	<PARAM NAME="DefaultTopic" VALUE="_topic_not_found.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="_mfc_COleControl.3a3a.DoPropExchange">
</OBJECT>
<OBJECT ID="hhobj_3" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink">
	<PARAM NAME="DefaultTopic" VALUE="_topic_not_found.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="_mfc_CDataPathProperty.3a3a.ResetData">
</OBJECT>
<OBJECT ID="hhobj_4" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink">
	<PARAM NAME="DefaultTopic" VALUE="_topic_not_found.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="_mfc_COleControl.3a3a.InternalSetReadyState">
</OBJECT>
</TD></TR></TABLE>


<font face="verdana,arial,helvetica" size="2">
<H1><A NAME="_core_internet_first_steps.3a_.activex_controls"></A>Internet First Steps: ActiveX Controls</H1>

<P><A HREF="JavaScript:hhobj_1.Click()">Home</A>  |&nbsp; <A HREF="_core_internet_support.3a_.overview.htm">Overview</A>  |&nbsp; <A HREF="_core_internet_tasks.htm">How Do I</A></P>

<P>To be an ActiveX control, your control must be a COM object, export <B>DLLRegisterServer </B>and <B>DLLUnRegisterServer</B>, and implement the <B>IUnknown</B> interface.</P>

<P>ActiveX controls are not limited to the Internet. An ActiveX control can also be used in any container, as long as the control supports the interfaces required by that container. Topics included in this article that describe how to create ActiveX controls for the Internet are:

<UL type=disc>
	<LI><A HREF="#_core_making_your_existing_controls_internet.2d.friendly">Making Your Existing Controls Internet-Friendly</A><BR><BR></LI>

	<LI><A HREF="#_core_how_do_i_create_a_new_activex_control.3f">How Do I Create a New ActiveX Control?</A><BR><BR></LI>

	<LI><A HREF="#_core_how_do_i_update_an_existing_ole_control_to_use_new_activex_control_features.3f">How Do I Update an Existing OLE Control to Use New ActiveX Control Features?</A><BR><BR></LI>

	<LI><A HREF="#_core_displaying_a_control_on_a_web_page">Displaying a Control on a Web Page</A><BR><BR></LI>

	<LI><A HREF="#_core_how_do_i_decide_whether_to_derive_from_cdatapathproperty_or_ccacheddatapathproperty.3f">How Do I Decide Whether to Derive from CDataPathProperty or CCachedDataPathProperty?</A></LI>
</UL>

<H2><A NAME="_core_making_your_existing_controls_internet.2d.friendly"></A>Making Your Existing Controls Internet-Friendly</H2>

<P>You can use your existing controls on the Internet. However, there are steps you should take to make your code size smaller and to make your control properties download asynchronously.</P>

<P>The following tips will make your applications run better on the Internet.

<UL type=disc>
	<LI>Be asynchronous; don't hold up other programs.<BR><BR></LI>

	<LI>Download code and properties in the background.<BR><BR></LI>

	<LI>Download data in small blocks.<BR><BR></LI>

	<LI>Become user-interface active as quickly as possible.<BR><BR></LI>

	<LI>Write efficient routines to keep code size and run time down.</LI>
</UL>

<P>For more information on increasing your control's performance, see <A HREF="_core_activex_controls.3a_.optimization.htm">ActiveX Controls: Optimization</A>. </P>

<H2><A NAME="_core_how_do_i_create_a_new_activex_control.3f"></A>Creating a New ActiveX Control</H2>

<P>When creating a new control using AppWizard, you can choose to enable support for asynchronous monikers as well as other optimizations. To add support to download control properties asynchronously, follow these steps:</P>

<P class=label><B>To create your project using the MFC ActiveX ControlWizard</B>

<OL>
	<LI>Select <B>New</B> on the <B>File</B> menu.<BR><BR></LI>

	<LI>Click the <B>Projects</B> tab, select <B>MFC ActiveX ControlWizard</B>, and name your project.<BR><BR></LI>

	<LI>In Step 2 of the <B>MFC ActiveX ControlWizard</B>, click the <B>Advanced</B> button.
<P class=tl>In the <B>Advanced ActiveX Features</B> dialog box, select <B>Loads Properties Asynchronously</B>. Selecting this option sets up the ready state property and the ready state changed event for you.</P>
<P class=tl>You can also select other optimizations, such as Windowless Activation, which is described in <A HREF="_core_activex_controls.3a_.optimization.htm">ActiveX Controls: Optimization</A>. </P></LI>

	<LI>In the <B>Advanced ActiveX Features</B> dialog box, click <B>OK</B>.<BR><BR></LI>

	<LI>Choose <B>Finish </B>to create the project.</LI>
</OL>

<P class=label><B>To create a class derived from CDataPathProperty</B>

<OL>
	<LI>Create a class derived from <B>CDataPathProperty</B>.<BR><BR></LI>

	<LI>In each of your source files that includes the header file for your control, add the header file for this class before it.<BR><BR></LI>

	<LI>In this class, override <B>OnDataAvailable</B>. This function is called whenever data is available for display. As data becomes available, you can handle it any way you choose, for example by progressively rendering it.
<P class=tl>The code excerpt below is a simple example of progressively displaying data in an edit control. Note the use of flag <B>BSCF_FIRSTDATANOTIFICATION</B> to clear the edit control.</P>
<PRE><CODE>void CMyDataPathProperty::OnDataAvailable(DWORD dwSize, DWORD bscfFlag)
{
        CListCtrl list_ctrl;
        CEdit* edit=list_ctrl.GetEditControl();
        if (bscfFlag &amp; BSCF_FIRSTDATANOTIFICATION &amp;&amp; edit-&gt;m_hWnd)
        {
            edit-&gt;SetSel(0, -1);
            edit-&gt;Clear();
        }
        if (!dwSize)
            return;

    CString string;
    LPTSTR str=string.GetBuffer(dwSize);
    UINT nBytesRead=Read(str, dwSize);
    if (!nBytesRead)
            return;
        string.ReleaseBuffer(nBytesRead);
        edit-&gt;SetSel(-1, -1);
        edit-&gt;ReplaceSel(string);
}
</CODE></PRE>

<P class=tl>Note that you must include AFXCMN.H to use the <B>CListCtrl</B> class.</P></LI>

	<LI>When your control's overall state changes (for example, from loading to initialized or user interactive), call&nbsp; <B>COleControl::InternalSetReadyState</B>. If your control has only one data path property, you can add code on <B>BSCF_LASTDATANOTIFICATION </B>to notify the container that your download is complete. For example:
<PRE><CODE>if (bscfFlag == BSCF_LASTDATANOTIFICATION)
{
    GetControl()-&gt;InternalSetReadyState(READYSTATE_COMPLETE);
}
</CODE></PRE>
</LI>

	<LI>Override <B>OnProgress</B>. In <B>OnProgress</B>, you are passed a number showing the maximum range and a number showing how far along the current download is. You can use these numbers to display status such as percent complete to the user.</LI>
</OL>

<P>In the next procedure, you will be adding a property to your control to use the class you just derived.</P>

<P class=label><B>To add a property using ClassWizard</B>

<OL>
	<LI>In the <B>MFC ClassWizard </B>dialog box, click the <B>Automation</B> tab and make sure your control class (the class derived from <B>COleControl</B>) is selected.<BR><BR></LI>

	<LI>Choose <B>Add Property</B>, and in the<B> Add Property</B> dialog box select <B>Get/Set methods</B>. <BR><BR></LI>

	<LI>Type a variable name in the <B>External name</B> box, for example, <CODE>EditControlText</CODE>, and select <CODE>BSTR </CODE>as its type.
<P class=tl>This adds the member variable, modifies the IDL, and adds the dispatch map and <B>Get/Set</B> functions.</P></LI>

	<LI>Declare a member variable of your <CODE>CDataPathProperty</CODE> derived class to your ActiveX control class. 
<PRE><CODE>CMyDataPathProperty EditControlText;
</CODE></PRE>
</LI>

	<LI>Implement the <B>Get/Set</B> member functions. For the <B>Get </B>function, return the string. For <B>Set</B>, load the property and call <B>SetModifiedFlag</B>.
<PRE><CODE>BSTR CDataPathCtrl::GetDataPath() 
{    
    CString strResult;
    strResult = EditControlText.GetPath();
    return strResult.AllocSysString();
}
void CDataPathCtrl::SetDataPath(LPCTSTR lpszNewValue) 
{
    Load(lpszNewValue, EditControlText);
    SetModifiedFlag();
}
</CODE></PRE>
</LI>

	<LI>In <A HREF="JavaScript:hhobj_2.Click()">DoPropExchange</A>, add the following line:
<PRE><CODE>PX_DataPath(pPX, _T("DataPath"), EditControlText);
</CODE></PRE>
</LI>

	<LI>Override <A HREF="JavaScript:hhobj_3.Click()">ResetData</A> to notify the property to reset its control by adding this line:
<PRE><CODE>EditControlText.ResetData();
</CODE></PRE>
</LI>
</OL>

<H2><A NAME="_core_how_do_i_decide_whether_to_derive_from_cdatapathproperty_or_ccacheddatapathproperty.3f"></A>Deciding Whether to Derive from CDataPathProperty or CCachedDataPathProperty</H2>

<P>The previous example describes steps for deriving your control's property from <B>CDataPathProperty</B>. This is a good choice if you are downloading real-time data that frequently changes, and for which you do not need to keep all the data, but only the current value. An example is a stock ticker control.</P>

<P>You can also derive from <B>CCachedDataPathProperty</B>. In this case, the downloaded data is cached in a memory file. This is a good choice if you need to keep all the downloaded data — for example, a control that progressively renders a bitmap. In this case, the class has a member variable containing your data:</P>

<PRE><CODE>    CMemFile m_Cache;
</CODE></PRE>

<P>In your ActiveX control class, you can use this memory mapped file in <B>OnDraw</B> to display the data. In your ActiveX control <B>CCachedDataPathProperty</B> derived class, override the member function <B>OnDataAvailable</B> and invalidate the control, after calling the base class implementation.</P>

<PRE><CODE>COleControl OLEctrl;

void CMyCachedDataPathProperty::OnDataAvailable(DWORD dwSize, DWORD bscfFlag)
{
    CCachedDataPathProperty:OnDataAvailable(dwSize, bscfFlag);
    OLEctrl.InvalidateControl(NULL);
}
</CODE></PRE>



<H2><A NAME="vccondownloadingdataasynchronouslyusingactivexcontrols"></A>Downloading Data Asynchronously Using ActiveX Controls</H2>

<P>Downloading data over a network should be done asynchronously. The advantage of doing so is that if a large amount of data is transferred or if the connection is slow, the download process will not block other processes on the client.</P>

<P>Asynchronous monikers provide a way to download data asynchronously over a network. A Read operation on an Asynchronous moniker returns immediately, even if the operation has not been completed.</P>

<P>For example, if only 10 bytes are available and Read is called asynchronously on a 1K file, Read does not block, but returns with the currently available 10 bytes.</P>

<P>You implement <A HREF="_core_internet_first_steps.3a_.asynchronous_monikers.htm">asynchronous monikers</A> using the <B>CAsyncMonikerFile</B> class. However, ActiveX controls can use the <B>CDataPathProperty</B> class, which is derived from <B>CAsyncMonikerFile</B>, to help implement asynchronous control properties.</P>

<P>The ASYNDOWN sample demonstrates how to set up an asynchronous loop using timers to read the data. ASYNDOWN is described in detail in the KB article "FILE: AsyncDown Demonstrates Asynchronous Data Download" (006415), and is available for download from the Microsoft Software Library. (For more information about downloading files from the Microsoft Software Library, please see the article How to Obtain Microsoft Support Files from Online Services (Q119591) in the Microsoft Knowledge Base.)</P>

<P>The basic technique used in ASYNDOWN is to set a timer in <B>CDataPathProperty::OnDataAvailable</B> to indicate when data is available. When the timer message is received, the application reads in 128-byte blocks of data and fills an edit control. If data is not available when the timer message is handled, the timer is turned off. <B>OnDataAvailable</B> turns on the timer if more data arrives later.</P>

<H2><A NAME="_core_displaying_a_control_on_a_web_page"></A>Displaying a Control on a Web Page</H2>

<P>Here is an example of an object tag and attributes for inserting a control on a Web page.</P>

<PRE><CODE>&lt;OBJECT
CLASSID="clsid:FC25B780-75BE-11CF-8B01-444553540000"
CODEBASE="/ie/download/activex/iechart.ocx"
ID=chart1
WIDTH=400
HEIGHT=200
ALIGN=center
HSPACE=0
VSPACE=0
&gt;
&lt;PARAM NAME="BackColor" value="#ffffff"&gt;
&lt;PARAM NAME="ForeColor" value="#0000ff"&gt;
&lt;PARAM NAME="url" VALUE="/ie/controls/chart/mychart.txt"&gt;
&lt;/OBJECT&gt;
</CODE></PRE>

<P>A W3C Working Draft is currently under review for the object tag. See the draft for details of object tags and attributes. A list of current W3C working drafts, including this one, can be found at:</P>

<P class=indent>http://www.w3.org/pub/WWW/TR</P>

<P><B>See Also</B>&nbsp;&nbsp;&nbsp;<A HREF="_core_internet.3a_.where_is.......htm">Internet: Where Is...</A>, <A HREF="_core_activex_controls_on_the_internet.htm">ActiveX Controls on the Internet</A></P>

<H2><A NAME="_core_how_do_i_update_an_existing_ole_control_to_use_new_activex_control_features.3f"></A>Updating an Existing OLE Control to Use New ActiveX Control Features</H2>

<P>If your OLE control was created with a version of Visual C++ prior to 4.2, there are steps you can take to improve its performance and enhance its functionality. For a detailed discussion of these changes, see <A HREF="_core_activex_controls.3a_.optimization.htm">ActiveX Controls: Optimization</A>.</P>

<P>If you are adding asynchronous property support to an existing control, you will need to add the ready state property and the <CODE>ReadyStateChange</CODE> event yourself. ClassWizard provides stock implementation of these. In the constructor for your control, add:</P>

<PRE><CODE>m_lReadyState = READYSTATE_LOADING;
</CODE></PRE>

<P>You will update the ready state as your code is downloaded by calling <A HREF="JavaScript:hhobj_4.Click()">COleControl::InternalSetReadyState</A>. One place you could call <B>InternalSetReadyState</B> is from the <B>OnProgress</B> override of <B>CDataPathProperty</B> derived class.</P>

<P>Then, follow the steps in <A HREF="#_core_how_do_i_create_a_new_activex_control.3f">How do I create a new ActiveX control?</A></P>
</font>
</BODY>
</HTML>
