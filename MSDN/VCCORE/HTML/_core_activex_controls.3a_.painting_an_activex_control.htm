<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<HTML>
<HEAD>
<META HTTP-EQUIV="Content-Type" Content="text/html; charset=Windows-1252">
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-83731338-2"></script><script>  window.dataLayer = window.dataLayer || [];  function gtag(){dataLayer.push(arguments);}  gtag('js', new Date());  gtag('config', 'UA-83731338-2');</script><title>ActiveX Controls: Painting an ActiveX Control</TITLE>
<style>@import url(stylesheets/msdn_ie4.css);</style>
<link disabled rel="stylesheet" href="stylesheets/msdn_ie3.css"></HEAD>
<BODY>

<TABLE ALIGN=right WIDTH=0 BORDER=0><TR><TD>
<OBJECT ID="hhobj_1" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink">
	<PARAM NAME="DefaultTopic" VALUE="_topic_not_found.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="_vc_addui_home">
</OBJECT>
<OBJECT ID="hhobj_2" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink">
	<PARAM NAME="DefaultTopic" VALUE="_topic_not_found.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="circle sample start">
</OBJECT>
<OBJECT ID="hhobj_3" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink">
	<PARAM NAME="DefaultTopic" VALUE="_topic_not_found.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="_mfc_COleControl">
</OBJECT>
<OBJECT ID="hhobj_4" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink">
	<PARAM NAME="DefaultTopic" VALUE="_topic_not_found.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="_mfc_COleControl.3a3a.OnDrawMetafile">
</OBJECT>
<OBJECT ID="hhobj_5" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink">
	<PARAM NAME="DefaultTopic" VALUE="_topic_not_found.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="_MFC_CDC">
</OBJECT>
<OBJECT ID="hhobj_6" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink">
	<PARAM NAME="DefaultTopic" VALUE="_topic_not_found.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="_MFC_CPalette.3a3a.AnimatePalette">
</OBJECT>
<OBJECT ID="hhobj_7" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink">
	<PARAM NAME="DefaultTopic" VALUE="_topic_not_found.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="_MFC_CFont.3a3a.CreateFontIndirect">
</OBJECT>
<OBJECT ID="hhobj_8" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink">
	<PARAM NAME="DefaultTopic" VALUE="_topic_not_found.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="_MFC_CBrush.3a3a.CreateBrushIndirect">
</OBJECT>
<OBJECT ID="hhobj_9" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink">
	<PARAM NAME="DefaultTopic" VALUE="_topic_not_found.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="_MFC_CBrush.3a3a.CreateDIBPatternBrush">
</OBJECT>
<OBJECT ID="hhobj_10" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink">
	<PARAM NAME="DefaultTopic" VALUE="_topic_not_found.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="_MFC_CBrush.3a3a.CreatePatternBrush">
</OBJECT>
</TD></TR></TABLE>


<font face="verdana,arial,helvetica" size="2">
<H1><A NAME="_core_activex_controls.3a_.painting_an_activex_control"></A>ActiveX Controls: Painting an ActiveX Control</H1>

<P><A HREF="JavaScript:hhobj_1.Click()">Home</A>  |&nbsp; <A HREF="_core_activex_controls.3a_.overview.htm">Overview</A>  |&nbsp; <A HREF="_core_activex_control_tasks.htm">How Do I</A>  |&nbsp; <A HREF="_core_frequently_asked_questions_about_activex_controls.htm">FAQ</A>  |&nbsp; <A HREF="JavaScript:hhobj_2.Click()">Tutorial</A>  |&nbsp; <A HREF="_core_activex_control_sample_list.htm">Sample</A></P>

<P>This article describes the ActiveX control painting process and how you can alter paint code to optimize the process. (See <A HREF="_core_optimizing_control_drawing.htm">Optimizing Control Drawing</A> for techniques on how to optimize drawing by not having controls individually restore previously selected GDI objects. After all of the controls have been drawn, the container can automatically restore the original objects.)</P>

<P>Examples in this article are from a control created by ControlWizard with default settings. For more information on creating a skeleton control application using ControlWizard, see the article <A HREF="_core_create_a_program_with_the_mfc_activex_controlwizard.htm">Createa Program with the MFC ActiveX ControlWizard</A>.</P>

<P>The following topics are covered:

<UL type=disc>
	<LI><A HREF="#_core_the_painting_process_of_an_activex_control">The overall process for painting a control and the code created by ControlWizard to support painting</A><BR><BR></LI>

	<LI><A HREF="#_core_optimizing_your_paint_code">How to optimize the painting process</A><BR><BR></LI>

	<LI><A HREF="#_core_painting_your_control_using_metafiles">How to paint your control using metafiles</A></LI>
</UL>



<H2><A NAME="_core_the_painting_process_of_an_activex_control"></A>The Painting Process of an ActiveX Control</H2>

<P>When ActiveX controls are initially displayed or are redrawn, they follow a painting process similar to other applications developed using MFC, with one important distinction: ActiveX controls can be in an active or an inactive state.</P>

<P>An active control is represented in an ActiveX control container by a child window. Like other windows, it is responsible for painting itself when a <B>WM_PAINT</B> message is received. The control’s base class, <A HREF="JavaScript:hhobj_3.Click()">COleControl</A>, handles this message in its <B>OnPaint</B> function. This default implementation calls the <CODE>OnDraw</CODE> function of your control.</P>

<P>An inactive control is painted differently. When the control is inactive, its window is either invisible or nonexistent, so it can not receive a paint message. Instead, the control container directly calls the <CODE>OnDraw</CODE> function of the control. This differs from an active control’s painting process in that the <B>OnPaint</B> member function is never called.</P>

<P>As discussed in the preceding paragraphs, how an ActiveX control is updated depends on the state of the control. However, because the framework calls the <CODE>OnDraw</CODE> member function in both cases, you add the majority of your painting code in this member function.</P>

<P>The <CODE>OnDraw</CODE> member function handles control painting. When a control is inactive, the control container calls <CODE>OnDraw</CODE>, passing the device context of the control container and the coordinates of the rectangular area occupied by the control.</P>

<P>The rectangle passed by the framework to the <CODE>OnDraw</CODE> member function contains the area occupied by the control. If the control is active, the upper-left corner is (0, 0) and the device context passed is for the child window that contains the control. If the control is inactive, the upper-left coordinate is not necessarily (0, 0) and the device context passed is for the control container containing the control.</P>

<P class=indent><B><B>Note</B></B>  It is important that your modifications to <CODE>OnDraw </CODE>do not depend on the rectangle’s upper-left point being equal to (0, 0) and that you draw only inside the rectangle passed to <CODE>OnDraw</CODE>. Unexpected results can occur if you draw beyond the rectangle’s area.</P>

<P>The default implementation provided by ControlWizard in the control implementation file (.CPP), shown below, paints the rectangle with a white brush and fills the ellipse with the current background color.</P>

<PRE><CODE>void CSampleCtrl::OnDraw( CDC* pdc, const CRect&amp; rcBounds, const CRect&amp; rcInvalid )
{
    pdc-&gt;FillRect( rcBounds, 
        CBrush::FromHandle((HBRUSH)GetStockObject(WHITE_BRUSH)));
    pdc-&gt;Ellipse( rcBounds );
}
</CODE></PRE>

<P class=indent><B><B>Note</B></B>&nbsp;&nbsp;&nbsp;When painting a control, you should not make assumptions about the state of the device context that is passed as the <I>pdc</I> parameter to the <CODE>OnDraw</CODE> function. Occasionally the device context is supplied by the container application and will not necessarily be initialized to the default state. In particular, explicitly select the pens, brushes, colors, fonts, and other resources that your drawing code depends upon.</P>



<H2><A NAME="_core_optimizing_your_paint_code"></A>Optimizing Your Paint Code</H2>

<P>Once the control is successfully painting itself, the next step is to optimize the <CODE>OnDraw</CODE> function.</P>

<P>The default implementation of ActiveX control painting simply paints the entire control area. This is sufficient for simple controls, but in many cases repainting the control would be faster if only the portion that needed updating was repainted, instead of the entire control.</P>

<P>The <CODE>OnDraw</CODE> function provides an easy method of optimization by passing <CODE>rcInvalid</CODE>, the rectangular area of the control that needs redrawing. Use this area, usually smaller than the entire control area, to speed up the painting process.</P>



<H2><A NAME="_core_painting_your_control_using_metafiles"></A>Painting Your Control Using Metafiles</H2>

<P>In most cases the <CODE>pdc</CODE> parameter to the <CODE>OnDraw</CODE> function points to a screen device context (DC). However, when printing images of the control or during a print preview session, the DC received for rendering is a special type called a “metafile DC”. Unlike a screen DC, which immediately handles requests sent to it, a metafile DC stores requests to be played back at a later time. Some container applications, such as Microsoft Access 2.0, may also choose to render the control image using a metafile DC when in design mode.</P>

<P>Drawing requests can be made by the container through two interface functions: <B>IViewObject::Draw</B> (this function can also be called for non-metafile drawing) and <B>IDataObject::GetData</B>. When a metafile DC is passed as one of the parameters, the MFC framework makes a call to <A HREF="JavaScript:hhobj_4.Click()">COleControl::OnDrawMetafile</A>. Because this is a virtual member function, override this function in the control class to do any special processing. The default behavior calls <B>COleControl::OnDraw</B>.</P>

<P>To make sure the control can be drawn in both screen and metafile device contexts, you must use only member functions that are supported in both a screen and a metafile DC. Be aware that the coordinate system may not be measured in pixels.</P>

<P>Because the default implementation of <B>OnDrawMetafile</B> calls the control’s <CODE>OnDraw</CODE> function, use only member functions that are suitable for both a metafile and a screen device context, unless you override <B>OnDrawMetafile</B>. The following lists the subset of <B>CDC</B> member functions that can be used in both a metafile and a screen device context. For more information on these functions, see class <A HREF="JavaScript:hhobj_5.Click()">CDC</A> in the <I>Class Library Reference</I>.</P>

<TABLE border=1 cellpadding=5 cols=3 frame=below rules=rows>

<TR VALIGN="top">
<TD width=33%><B>Arc</B></TD>
<TD width=33%><B>Pie</B></TD>
<TD width=34%><B>SetMapMode</B></TD>
</TR>

<TR VALIGN="top">
<TD width=33%><B>Chord</B></TD>
<TD width=33%><B>Polygon</B></TD>
<TD width=34%><B>SetMapperFlags</B></TD>
</TR>

<TR VALIGN="top">
<TD width=33%><B>Ellipse</B></TD>
<TD width=33%><B>Polyline</B></TD>
<TD width=34%><B>SetPixel</B></TD>
</TR>

<TR VALIGN="top">
<TD width=33%><B>Escape</B></TD>
<TD width=33%><B>PolyPolygon</B></TD>
<TD width=34%><B>SetPolyFillMode</B></TD>
</TR>

<TR VALIGN="top">
<TD width=33%><B>BibBlt</B></TD>
<TD width=33%><B>RealizePalette</B></TD>
<TD width=34%><B>SetROP2</B></TD>
</TR>

<TR VALIGN="top">
<TD width=33%><B>ExcludeClipRect</B></TD>
<TD width=33%><B>RestoreDC</B></TD>
<TD width=34%><B>SetStretchBltMode</B></TD>
</TR>

<TR VALIGN="top">
<TD width=33%><B>ExtTextOut</B></TD>
<TD width=33%><B>RoundRect</B></TD>
<TD width=34%><B>SetTextColor</B></TD>
</TR>

<TR VALIGN="top">
<TD width=33%><B>FloodFill</B></TD>
<TD width=33%><B>SaveDC</B></TD>
<TD width=34%><B>SetTextJustification</B></TD>
</TR>

<TR VALIGN="top">
<TD width=33%><B>IntersectClipRect</B></TD>
<TD width=33%><B>ScaleViewportExt</B></TD>
<TD width=34%><B>SetViewportExt</B></TD>
</TR>

<TR VALIGN="top">
<TD width=33%><B>LineTo</B></TD>
<TD width=33%><B>ScaleWindowExt</B></TD>
<TD width=34%><B>SetViewportOrg</B></TD>
</TR>

<TR VALIGN="top">
<TD width=33%><B>MoveTo</B></TD>
<TD width=33%><B>SelectClipRgn</B></TD>
<TD width=34%><B>SetWindowExt</B></TD>
</TR>

<TR VALIGN="top">
<TD width=33%><B>OffsetClipRgn</B></TD>
<TD width=33%><B>SelectObject</B></TD>
<TD width=34%><B>SetWindowORg</B></TD>
</TR>

<TR VALIGN="top">
<TD width=33%><B>OffsetViewportOrg</B></TD>
<TD width=33%><B>SelectPalette</B></TD>
<TD width=34%><B>StretchBlt</B></TD>
</TR>

<TR VALIGN="top">
<TD width=33%><B>OffsetWindowOrg</B></TD>
<TD width=33%><B>SetBkColor</B></TD>
<TD width=34%><B>TextOut</B></TD>
</TR>

<TR VALIGN="top">
<TD width=33%><B>PatBlt</B></TD>
<TD width=33%><B>SetBkMode</B></TD>
<TD width=34%>&nbsp;</TD>
</TR>
</TABLE><BR>

<P>In addition to <B>CDC</B> member functions, there are several other functions that are compatible in a metafile DC. These include <A HREF="JavaScript:hhobj_6.Click()">CPalette::AnimatePalette</A>, <A HREF="JavaScript:hhobj_7.Click()">CFont::CreateFontIndirect</A>, and three member functions of <B>CBrush</B>: <A HREF="JavaScript:hhobj_8.Click()">CreateBrushIndirect</A>, <A HREF="JavaScript:hhobj_9.Click()">CreateDIBPatternBrush</A>, and <A HREF="JavaScript:hhobj_10.Click()">CreatePatternBrush</A>.</P>

<P>Another point to consider when using a metafile DC is that the coordinate system may not be measured in pixels. For this reason, all your drawing code should be adjusted to fit in the rectangle passed to <CODE>OnDraw </CODE>in the <I>rcBounds</I> parameter. This prevents accidental painting outside the control because <I>rcBounds</I> represents the size of the control’s window.</P>

<P>Once you have implemented metafile rendering for the control, use Test Container to test the metafile.</P>

<P class=label><B>To test the control’s metafile using Test Container</B>

<OL>
	<LI>On the <B>Tools</B> menu, click <B>ActiveX Control Test Container</B>.<BR><BR></LI>

	<LI>On the Test Container’s<B> Edit</B> menu, click <B>Insert ActiveX Control</B>.<BR><BR></LI>

	<LI>In the <B>Insert ActiveX Control </B>box, select the desired control and click <B>OK</B>.
<P class=tl>The control will appear in Test container.</P></LI>

	<LI>On the <B>Control </B>menu, click <B>Draw Metafile</B>.
<P class=tl>A separate window appears in which the metafile is displayed. You can change the size of this window to see how scaling affects the control’s metafile. You can close this window at any time.</P></LI>
</OL>
</font>
</BODY>
</HTML>
