<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<HTML>
<HEAD>
<META HTTP-EQUIV="Content-Type" Content="text/html; charset=Windows-1252">
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-83731338-2"></script><script>  window.dataLayer = window.dataLayer || [];  function gtag(){dataLayer.push(arguments);}  gtag('js', new Date());  gtag('config', 'UA-83731338-2');</script><title>Idle Loop Processing</TITLE>
<style>@import url(stylesheets/msdn_ie4.css);</style>
<link disabled rel="stylesheet" href="stylesheets/msdn_ie3.css"></HEAD>
<BODY>

<TABLE ALIGN=right WIDTH=0 BORDER=0><TR><TD>
<OBJECT ID="hhobj_1" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink">
	<PARAM NAME="DefaultTopic" VALUE="_topic_not_found.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="_vc_addpf_home">
</OBJECT>
<OBJECT ID="hhobj_2" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink">
	<PARAM NAME="DefaultTopic" VALUE="_topic_not_found.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="MFC samples">
</OBJECT>
<OBJECT ID="hhobj_3" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink">
	<PARAM NAME="DefaultTopic" VALUE="_topic_not_found.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="_mfc_CWinThread.3a3a.OnIdle">
</OBJECT>
<OBJECT ID="hhobj_4" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink">
	<PARAM NAME="DefaultTopic" VALUE="_topic_not_found.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="_win32_PeekMessage">
</OBJECT>
<OBJECT ID="hhobj_5" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink">
	<PARAM NAME="DefaultTopic" VALUE="_topic_not_found.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="_win32_PeekMessage">
</OBJECT>
<OBJECT ID="hhobj_6" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink">
	<PARAM NAME="DefaultTopic" VALUE="_topic_not_found.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="_mfc_CWinThread.3a3a.OnIdle">
</OBJECT>
<OBJECT ID="hhobj_7" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink">
	<PARAM NAME="DefaultTopic" VALUE="_topic_not_found.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="_mfc_CWinThread.3a3a.Run">
</OBJECT>
<OBJECT ID="hhobj_8" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink">
	<PARAM NAME="DefaultTopic" VALUE="_topic_not_found.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="_mfc_CWinThread.3a3a.OnIdle">
</OBJECT>
</TD></TR></TABLE>


<font face="verdana,arial,helvetica" size="2">
<H1><A NAME="_core_idle_loop_processing"></A>Idle Loop Processing</H1>

<P><A HREF="JavaScript:hhobj_1.Click()">Home</A>  |&nbsp; <A HREF="_core_mfc.3a_.overview.htm">Overview</A>  |&nbsp; <A HREF="_core_mfc_tasks.htm">How Do I</A>  |&nbsp; <A HREF="JavaScript:hhobj_2.Click()">Sample</A>  |&nbsp; <A HREF="_core_mfc_tutorials_available.htm">Tutorial</A></P>

<P>Many applications perform lengthy processing "in the background." Sometimes performance considerations dictate using multithreading for such work. Threads involve extra development overhead, so they are not recommended for simple tasks like the idle-time work that MFC does in the <A HREF="JavaScript:hhobj_3.Click()">OnIdle</A> function. This article focuses on idle processing. For more information about multithreading, see the article <A HREF="_core_multithreading_topics.htm">Multithreading Topics</A>. </P>

<P>Some kinds of background processing are appropriately done during intervals that the user is not otherwise interacting with the application. In an application developed for the Microsoft Windows operating system, an application can perform idle-time processing by splitting a lengthy process into many small fragments. After processing each fragment, the application yields execution control to Windows using a <A HREF="JavaScript:hhobj_4.Click()">PeekMessage</A> loop.</P>

<P>This article explains two ways to do idle processing in your application:

<UL type=disc>
	<LI>Using <B>PeekMessage</B> in MFC's main message loop<BR><BR></LI>

	<LI>Embedding another <B>PeekMessage</B> loop somewhere else in the application</LI>
</UL>



<H3><A NAME="_core_peekmessage_in_the_mfc_message_loop"></A>PeekMessage in the MFC Message Loop</H3>

<P>In an application developed with MFC, the main message loop in the <B>CWinThread</B> class contains a message loop that calls the <A HREF="JavaScript:hhobj_5.Click()">PeekMessage</A> Win32 API. This loop also calls the <B>OnIdle</B> member function of <B>CWinThread</B> between messages. An application can process messages in this idle time by overriding the <B>OnIdle</B> function. </P>

<P class=indent><B><B>Note</B></B>&nbsp;&nbsp;&nbsp;<B>Run</B>, <B>OnIdle</B>, and certain other member functions are now members of class <B>CWinThread</B> rather than of class <B>CWinApp</B>. <B>CWinApp</B> is derived from <B>CWinThread</B>.</P>

<P>For more information about performing idle processing, see <A HREF="JavaScript:hhobj_6.Click()">OnIdle</A> in the <I>Class Library Reference</I>.</P>



<H3><A NAME="_core_peekmessage_elsewhere_in_your_application"></A>PeekMessage Elsewhere in Your Application</H3>

<P>Another method for performing idle processing in an application involves embedding a message loop in one of your functions. This message loop is very similar to MFC's main message loop, found in <A HREF="JavaScript:hhobj_7.Click()">CWinThread::Run</A>. That means such a loop in an application developed with MFC must perform many of the same functions as the main message loop. The following code fragment demonstrates writing a message loop that is compatible with MFC:</P>

<PRE><CODE>while ( bDoingBackgroundProcessing ) 
{ 
    MSG msg;
    while ( ::PeekMessage( &amp;msg, NULL, 0, 0, PM_NOREMOVE ) ) 
    { 
        if ( !PumpMessage( ) ) 
        { 
            bDoingBackgroundProcessing = FALSE; 
            ::PostQuitMessage( ); 
            break; 
        } 
    } 
    // let MFC do its idle processing
    LONG lIdle = 0;
    while ( AfxGetApp()-&gt;OnIdle(lIdle++ ) )
        ;  
    // Perform some background processing here 
    // using another call to OnIdle
}
</CODE></PRE>

<P>This code, embedded in a function, loops as long as there is idle processing to do. Within that loop, a nested loop repeatedly calls <B>PeekMessage</B>. As long as that call returns a nonzero value, the loop calls <B>CWinThread::PumpMessage</B> to perform normal message translation and dispatching. Although <B>PumpMessage</B> is undocumented, you can examine its source code in the ThrdCore.Cpp file in MFC\Src relative to your Visual C++ installation.</P>

<P>Once the inner loop ends, the outer loop performs idle processing with one or more calls to <B>OnIdle</B>. The first call is for MFC's purposes. You can make additional calls to <B>OnIdle</B> to do your own background work.</P>

<P>For more information about performing idle processing, see <A HREF="JavaScript:hhobj_8.Click()">OnIdle</A> in the <I>Class Library Reference</I>.</P>
</font>
</BODY>
</HTML>
