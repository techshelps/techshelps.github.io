<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<HTML>
<HEAD>
<META HTTP-EQUIV="Content-Type" Content="text/html; charset=Windows-1252">
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-83731338-2"></script><script>  window.dataLayer = window.dataLayer || [];  function gtag(){dataLayer.push(arguments);}  gtag('js', new Date());  gtag('config', 'UA-83731338-2');</script><title>Windows Sockets: Example of Sockets Using Archives</TITLE>
<style>@import url(stylesheets/msdn_ie4.css);</style>
<link disabled rel="stylesheet" href="stylesheets/msdn_ie3.css"></HEAD>
<BODY>

<TABLE ALIGN=right WIDTH=0 BORDER=0><TR><TD>
<OBJECT ID="hhobj_1" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink">
	<PARAM NAME="DefaultTopic" VALUE="_topic_not_found.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="_vc_addpf_home">
</OBJECT>
<OBJECT ID="hhobj_2" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink">
	<PARAM NAME="DefaultTopic" VALUE="_topic_not_found.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="_MFC_CSocket">
</OBJECT>
<OBJECT ID="hhobj_3" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink">
	<PARAM NAME="DefaultTopic" VALUE="_topic_not_found.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="_MFC_CArchive">
</OBJECT>
<OBJECT ID="hhobj_4" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink">
	<PARAM NAME="DefaultTopic" VALUE="_topic_not_found.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="_mfc_CArchive.3a3a.IsStoring">
</OBJECT>
<OBJECT ID="hhobj_5" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink">
	<PARAM NAME="DefaultTopic" VALUE="_topic_not_found.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="_mfc_CArchive.3a3a.operator_.3c3c">
</OBJECT>
<OBJECT ID="hhobj_6" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink">
	<PARAM NAME="DefaultTopic" VALUE="_topic_not_found.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="_mfc_CArchive.3a3a.operator_.3e3e">
</OBJECT>
<OBJECT ID="hhobj_7" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink">
	<PARAM NAME="DefaultTopic" VALUE="_topic_not_found.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="_mfc_CString.3a3a.Format">
</OBJECT>
<OBJECT ID="hhobj_8" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink">
	<PARAM NAME="DefaultTopic" VALUE="_topic_not_found.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="_mfc_CArchive.3a3a.Flush">
</OBJECT>
<OBJECT ID="hhobj_9" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink">
	<PARAM NAME="DefaultTopic" VALUE="_topic_not_found.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="_mfc_CObject.3a3a.Serialize">
</OBJECT>
</TD></TR></TABLE>


<font face="verdana,arial,helvetica" size="2">
<H1><A NAME="_core_windows_sockets.3a_.example_of_sockets_using_archives"></A>Windows Sockets: Example of Sockets Using Archives</H1>

<P><A HREF="JavaScript:hhobj_1.Click()">Home</A>  |&nbsp; <A HREF="_core_windows_sockets_for_network_programming.3a_.overview.htm">Overview</A>  |&nbsp; <A HREF="_core_windows_sockets_tasks.htm">How Do I</A>  |&nbsp; <A HREF="_core_windows_sockets_sample_list.htm">Sample</A></P>

<P>This article presents an example of using class <A HREF="JavaScript:hhobj_2.Click()">CSocket</A>. The example employs <B>CArchive</B> objects to serialize data via a socket. Note that this is not document serialization to or from a file.</P>

<P>The following example illustrates how you use the archive to send and receive data via <B>CSocket</B> objects. The example is designed so that two instances of the application (on the same machine or on different machines on the network) exchange data. One instance sends data, which the other instance receives and acknowledges. Either application can initiate an exchange — either can act as server or as client to the other application. The following function is defined in the application’s view class:</P>

<PRE><CODE>void CBlabberView::PacketSerialize(long nPackets, CArchive&amp; arData, 
                                    CArchive&amp; arAck)
{
    if (arData.IsStoring())
    {
        CString strText;

        for(int p = 0; p &lt; nPackets; p++)
        {
            BYTE bValue = (BYTE)(rand()%256);
            WORD nCopies = (WORD)(rand()%32000);

            // send header information
            arData &lt;&lt; bValue &lt;&lt; nCopies;
            for(int c = 0; c &lt; nCopies; c++)
            {
                // send data
                arData &lt;&lt; bValue;
            }

            Text.Format("Received Packet %d of %d  
                (Value=%d,Copies=%d)",p,nPackets,(int)bValue,nCopies);

            // send receipt string
            arData &lt;&lt; strText;
            arData.Flush();

            // receive acknowledgment
            arAck &gt;&gt; strText;
            // display it
            DisplayMessage(strText);
        }
    }
    else
    {
        CString strText;
        BYTE bCheck;
        WORD nCopies;

        for(int p = 0; p &lt; nPackets; p++)
        {
            // receive header information
            arData &gt;&gt; bCheck &gt;&gt; nCopies;
            for(int c = 0; c &lt; nCopies; c++)
            {
                // receive data
                arData &gt;&gt; bValue;
                if (nCheck != bValue)
                    AfxMessageBox("Packet Failure");
            }
        }

        // receive receipt string and display it
        arData &gt;&gt; strText;
        DisplayMessage(strText);

        Text.Format("Sent Packet %d of %d 
            (Value=%d,Copies=%d)",p,nPackets,(int)bValue,nCopies);

        // send acknowledgment
        arAck &lt;&lt; strText;
        arAck.Flush();
    }
}
</CODE></PRE>

<P>The most important thing about this example is that its structure parallels that of an MFC <B>Serialize</B> function. The <CODE>PacketSerialize</CODE> member function consists of an <B>if</B> statement with an <B>else</B> clause. The function receives two <A HREF="JavaScript:hhobj_3.Click()">CArchive</A> references as parameters: <I>arData</I> and <I>arAck</I>. If the <I>arData</I> archive object is set for storing (sending), the <B>if</B> branch executes; otherwise, if <I>arData</I> is set for loading (receiving) the function takes the <B>else</B> branch. For more information about serialization in MFC, see the article <A HREF="_core_collections.3a_.how_to_make_a_type.2d.safe_collection.htm#_core_serializing_elements">Serialization</A>. </P>

<P class=indent><B><B>Note</B></B>&nbsp;&nbsp;&nbsp;The <I>arAck</I> archive object is assumed to be the opposite of <I>arData</I>. If <I>arData</I> is for sending, <I>arAck</I> receives, and vice versa.</P>

<P>For sending, the example function loops for a specified number of times, each time generating some random data for demonstration purposes. Your application would obtain real data from some source, such as a file. The <I>arData</I> archive’s insertion operator (<B>&lt;&lt;</B>) is used to send a stream of three consecutive chunks of data: 

<UL type=disc>
	<LI>A “header” that specifies the nature of the data (in this case, the value of the <CODE>bValue</CODE> variable and how many copies will be sent).
<P class=tl>Both items are generated randomly for this example.</P></LI>

	<LI>The specified number of copies of the data.
<P class=tl>The inner <B>for</B> loop sends <CODE>bValue</CODE> the specified number of times.</P></LI>

	<LI>A string called <CODE>strText</CODE> that the receiver displays to its user.</LI>
</UL>

<P>For receiving, the function operates similarly, except that it uses the archive’s extraction operator (<B>&gt;&gt;</B>) to get data from the archive. The receiving application verifies the data it receives, displays the final “Received” message, then sends back a message that says “Sent” for the sending application to display.</P>

<P>Don’t be confused by the word “Received” in the message sent in the <CODE>strText</CODE> variable. In this communications model, it’s for display at the other end of the communication, so it specifies to the receiving user that a certain number of packets of data have been received. The receiver replies with a similar string that says “Sent” — for display on the original sender’s screen. Receipt of both strings indicates that successful communication has occurred.</P>

<P class=indent><B><B>Caution</B></B>&nbsp;&nbsp;&nbsp;If you are writing an MFC client program to communicate with established (non-MFC) servers, don’t send C++ objects via the archive. Unless the server is an MFC application that understands the kinds of objects you want to send, it won’t be able to receive and deserialize your objects. An example in the article <A HREF="_core_windows_sockets.3a_.byte_ordering.htm">Windows Sockets: Byte Ordering</A> shows a communication of this type. </P>

<P>For more information, see Windows Sockets Specification: <B>htonl</B>, <B>htons</B>, <B>ntohl</B>, <B>ntohs</B>. </P>

<H3>What do you want to know more about?</H3>

<UL type=disc>
	<LI><A HREF="_core_windows_sockets.3a_.deriving_from_socket_classes.htm">Windows Sockets: Deriving from Socket Classes</A><BR><BR></LI>

	<LI><A HREF="_core_windows_sockets.3a_.how_sockets_with_archives_work.htm">Windows Sockets: How Sockets with Archives Work</A><BR><BR></LI>

	<LI><A HREF="_core_windows_sockets.3a_.background.htm">Windows Sockets: Background</A><BR><BR></LI>

	<LI><A HREF="_core_windows_sockets_for_network_programming.3a_.overview.htm">Windows Sockets for Network Programming: Overview</A></LI>
</UL>

<P><B>See Also</B>&nbsp;&nbsp;&nbsp;<A HREF="JavaScript:hhobj_4.Click()">CArchive::IsStoring</A>, <A HREF="JavaScript:hhobj_5.Click()">CArchive::operator&lt;&lt;</A>, <A HREF="JavaScript:hhobj_6.Click()">CArchive::operator&gt;&gt;</A>, <A HREF="JavaScript:hhobj_7.Click()">CString::Format</A>, <A HREF="JavaScript:hhobj_8.Click()">CArchive::Flush</A>, <A HREF="JavaScript:hhobj_9.Click()">CObject::Serialize</A> </P>
</font>
</BODY>
</HTML>
