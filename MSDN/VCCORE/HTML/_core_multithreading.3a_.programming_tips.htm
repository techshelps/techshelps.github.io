<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<HTML>
<HEAD>
<META HTTP-EQUIV="Content-Type" Content="text/html; charset=Windows-1252">
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-83731338-2"></script><script>  window.dataLayer = window.dataLayer || [];  function gtag(){dataLayer.push(arguments);}  gtag('js', new Date());  gtag('config', 'UA-83731338-2');</script><title>Multithreading: Programming Tips</TITLE>
<style>@import url(stylesheets/msdn_ie4.css);</style>
<link disabled rel="stylesheet" href="stylesheets/msdn_ie3.css"></HEAD>
<BODY>

<TABLE ALIGN=right WIDTH=0 BORDER=0><TR><TD>
<OBJECT ID="hhobj_1" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink">
	<PARAM NAME="DefaultTopic" VALUE="_topic_not_found.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="_vc_addpf_home">
</OBJECT>
<OBJECT ID="hhobj_2" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink">
	<PARAM NAME="DefaultTopic" VALUE="_topic_not_found.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="_win32_Synchronization">
</OBJECT>
<OBJECT ID="hhobj_3" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink">
	<PARAM NAME="DefaultTopic" VALUE="_topic_not_found.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="_MFC_CWinThread">
</OBJECT>
<OBJECT ID="hhobj_4" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink">
	<PARAM NAME="DefaultTopic" VALUE="_topic_not_found.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="_MFCNOTES_TN003">
</OBJECT>
<OBJECT ID="hhobj_5" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink">
	<PARAM NAME="DefaultTopic" VALUE="_topic_not_found.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="_win32_Thread_Local_Storage">
</OBJECT>
<OBJECT ID="hhobj_6" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink">
	<PARAM NAME="DefaultTopic" VALUE="_topic_not_found.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="_win32_Using_Thread_Local_Storage">
</OBJECT>
<OBJECT ID="hhobj_7" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink">
	<PARAM NAME="DefaultTopic" VALUE="_topic_not_found.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="_win32_Synchronization">
</OBJECT>
</TD></TR></TABLE>


<font face="verdana,arial,helvetica" size="2">
<H1><A NAME="_core_multithreading.3a_.programming_tips"></A>Multithreading: Programming Tips</H1>

<P><A HREF="JavaScript:hhobj_1.Click()">Home</A>  |&nbsp; <A HREF="_core_multithreaded_programs.3a_.overview.htm">Overview</A>  |&nbsp; <A HREF="_core_multithreading_tasks.htm">How Do I</A>  |&nbsp; <A HREF="_core_multithreading_sample_list.htm">Sample</A></P>

<P>Multithreaded applications require stricter care than single-threaded applications when accessing data. Because there are multiple, independent paths of execution in use simultaneously in multithreaded applications, either the algorithms, the data, or both must be aware that data could be used by more than one thread at a time. This article explains techniques for avoiding potential problems when programming multithreaded applications with the Microsoft Foundation Class Library (MFC).

<UL type=disc>
	<LI>Accessing Objects from Multiple Threads<BR><BR></LI>

	<LI><A HREF="#_core_accessing_mfc_objects_from_non.2d.mfc_threads">Accessing MFC Objects from Non-MFC Threads</A><BR><BR></LI>

	<LI><A HREF="#_core_windows_handle_maps">Windows Handle Maps</A><BR><BR></LI>

	<LI><A HREF="#_core_communicating_between_threads">Communicating Between Threads</A></LI>
</UL>



<H2><A NAME="_core_accessing_objects_from_multiple_threads"></A>Accessing Objects from Multiple Threads</H2>

<P>For size and performance reasons, MFC objects are not thread-safe at the object level, only at the class level. This means that you can have two separate threads manipulating two different <B>CString</B> objects, but not two threads manipulating the same <B>CString</B> object. If you absolutely must have multiple threads manipulating the same object, protect such access with appropriate Win32 synchronization mechanisms, such as critical sections. For more information on critical sections and other related objects, see <A HREF="JavaScript:hhobj_2.Click()">Synchronization</A> in the Win32 SDK.</P>

<P>The class library uses critical sections internally to protect global data structures, such as those used by the debug memory allocation.</P>



<H2><A NAME="_core_accessing_mfc_objects_from_non.2d.mfc_threads"></A>Accessing MFC Objects from Non-MFC Threads</H2>

<P>If you have a multithreaded application that creates a thread in a way other than using a <A HREF="JavaScript:hhobj_3.Click()">CWinThread</A> object, you cannot access other MFC objects from that thread. In other words, if you want to access any MFC object from a secondary thread, you must create that thread with one of the methods described in the <A HREF="_core_multithreading.3a_.creating_user.2d.interface_threads.htm">Multithreading: Creating User-Interface Threads</A> or <A HREF="_core_multithreading.3a_.creating_worker_threads.htm">Multithreading: Creating Worker Threads</A> articles. These methods are the only ones that allow the class library to initialize the internal variables necessary to handle multithreaded applications.</P>



<H2><A NAME="_core_windows_handle_maps"></A>Windows Handle Maps</H2>

<P>As a general rule, a thread can access only MFC objects that it created. This is because temporary and permanent Windows handle maps are kept in thread local storage to ensure protection from simultaneous access from multiple threads. For example, a worker thread cannot perform a calculation and then call a document’s <B>UpdateAllViews</B> member function to have the windows that contain views on the new data modified. This will have no effect at all, because the map from <B>CWnd</B> objects to <B>HWND</B>s is local to the primary thread. This means that one thread may have a mapping from a Windows handle to a C++ object, but another thread may map that same handle to a different C++ object. Changes made in one thread would not be reflected in the other.</P>

<P>There are several ways around this problem. The first is to pass individual handles (such as an <B>HWND</B>) rather than C++ objects to the worker thread. The worker thread then adds these objects to its temporary map by calling the appropriate <B>FromHandle</B> member function. You could also add the object to the thread’s permanent map by calling <B>Attach</B>, but this should be done only if you are guaranteed that the object will exist longer than the thread.</P>

<P>Another method is to create new user-defined messages corresponding to the different tasks your worker threads will be performing and post these messages to the application’s main window using <B>::PostMessage</B>. This method of communication is similar to two different applications conversing except that both threads are executing in the same address space. </P>

<P>For more information on handle maps, see <A HREF="JavaScript:hhobj_4.Click()">Technical Note 3</A>. For more information on thread local storage, see <A HREF="JavaScript:hhobj_5.Click()">Thread Local Storage</A> and <A HREF="JavaScript:hhobj_6.Click()">Using Thread Local Storage</A> in the <I>Win32 Programmer’s Reference</I>.</P>



<H2><A NAME="_core_communicating_between_threads"></A>Communicating Between Threads</H2>

<P>MFC provides a number of classes that allow threads to synchronize access to objects to maintain thread safety. Usage of these classes is described in the articles <A HREF="_core_multithreading.3a_.how_to_use_the_synchronization_classes.htm">Multithreading: How to Use the Synchronization Classes</A> and <A HREF="_core_multithreading.3a_.when_to_use_the_synchronization_classes.htm">Multithreading: When to Use the Synchronization Classes</A>. More information on these objects can be found in <A HREF="JavaScript:hhobj_7.Click()">Synchronization</A> in the <I>Win32 Programmer’s Reference</I>.</P>
</font>
</BODY>
</HTML>
