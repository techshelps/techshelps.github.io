<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<HTML>
<HEAD>
<META HTTP-EQUIV="Content-Type" Content="text/html; charset=Windows-1252">
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-83731338-2"></script><script>  window.dataLayer = window.dataLayer || [];  function gtag(){dataLayer.push(arguments);}  gtag('js', new Date());  gtag('config', 'UA-83731338-2');</script><title>ActiveX Controls: Serializing</TITLE>
<style>@import url(stylesheets/msdn_ie4.css);</style>
<link disabled rel="stylesheet" href="stylesheets/msdn_ie3.css"></HEAD>
<BODY>

<TABLE ALIGN=right WIDTH=0 BORDER=0><TR><TD>
<OBJECT ID="hhobj_1" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink">
	<PARAM NAME="DefaultTopic" VALUE="_topic_not_found.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="_vc_addui_home">
</OBJECT>
<OBJECT ID="hhobj_2" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink">
	<PARAM NAME="DefaultTopic" VALUE="_topic_not_found.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="circle sample start">
</OBJECT>
<OBJECT ID="hhobj_3" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink">
	<PARAM NAME="DefaultTopic" VALUE="_topic_not_found.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="_MFC_COleControl.3a3a.DoPropExchange">
</OBJECT>
<OBJECT ID="hhobj_4" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink">
	<PARAM NAME="DefaultTopic" VALUE="_topic_not_found.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="_MFC_COleControl.3a3a.DoPropExchange">
</OBJECT>
<OBJECT ID="hhobj_5" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink">
	<PARAM NAME="DefaultTopic" VALUE="_topic_not_found.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="_MFC_persistence_of_OLE_controls">
</OBJECT>
<OBJECT ID="hhobj_6" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink">
	<PARAM NAME="DefaultTopic" VALUE="_topic_not_found.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="_MFC_COleControl.3a3a.ExchangeVersion">
</OBJECT>
<OBJECT ID="hhobj_7" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink">
	<PARAM NAME="DefaultTopic" VALUE="_topic_not_found.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="_MFC_CPropExchange.3a3a.GetVersion">
</OBJECT>
</TD></TR></TABLE>


<font face="verdana,arial,helvetica" size="2">
<H1><A NAME="_core_activex_controls.3a_.serializing"></A>ActiveX Controls: Serializing</H1>

<P><A HREF="JavaScript:hhobj_1.Click()">Home</A>  |&nbsp; <A HREF="_core_activex_controls.3a_.overview.htm">Overview</A>  |&nbsp; <A HREF="_core_activex_control_tasks.htm">How Do I</A>  |&nbsp; <A HREF="_core_frequently_asked_questions_about_activex_controls.htm">FAQ</A>  |&nbsp; <A HREF="JavaScript:hhobj_2.Click()">Tutorial</A>  |&nbsp; <A HREF="_core_activex_control_sample_list.htm">Sample</A></P>

<P>This article discusses how to serialize an ActiveX control. Serialization is the process of reading from or writing to a persistent storage medium, such as a disk file. The Microsoft Foundation Class Library (MFC) provides built-in support for serialization in class <B>CObject</B>. <B>COleControl</B> extends this support to ActiveX controls through the use of a property exchange mechanism.</P>

<P>Serialization for ActiveX controls is implemented by overriding <A HREF="JavaScript:hhobj_3.Click()">COleControl::DoPropExchange</A>. This function, called during the loading and saving of the control object, stores all properties implemented with a member variable or a member variable with change notification.</P>

<P>The following topics cover the main issues related to serializing an ActiveX control:

<UL type=disc>
	<LI>Implementing <CODE>DoPropExchange </CODE>to serialize your control object<BR><BR></LI>

	<LI><A HREF="#_core_customizing_the_default_behavior_of_dopropexchange">Customizing the serialization process</A><BR><BR></LI>

	<LI><A HREF="#_core_implementing_version_support">Implementing version support</A></LI>
</UL>



<H2><A NAME="_core_implementing_the_dopropexchange_function"></A>Implementing the DoPropExchange Function</H2>

<P>When you use ControlWizard to generate the control project, several default handler functions are automatically added to the control class, including the default implementation of <A HREF="JavaScript:hhobj_4.Click()">COleControl::DoPropExchange</A>. The following example shows the code added to classes created with ControlWizard:</P>

<PRE><CODE>void CSampleCtrl::DoPropExchange( CPropExchange* pPX)
{
   ExchangeVersion(pPX, MAKELONG(_wVerMinor, _wVerMajor));
   COleControl::DoPropExchange(pPX);

   // TODO: Call PX_ functions for each persistent custom property.
}
</CODE></PRE>

<P>If you want to make a property persistent, modify <CODE>DoPropExchange</CODE> by adding a call to the property exchange function. The following example demonstrates the serialization of a custom boolean CircleShape property:</P>

<PRE><CODE>void CSampleCtrl::DoPropExchange(CPropExchange* pPX)
{
   ExchangeVersion(pPX, MAKELONG(_wVerMinor, _wVerMajor));
   COleControl::DoPropExchange(pPX);

   PX_Bool(pPX, "CircleShape", m_bCircleShape, TRUE);
}
</CODE></PRE>

<P>The following table lists the possible property exchange functions you can use to serialize the control’s properties:</P>

<TABLE border=1 cellpadding=5 cols=2 frame=below rules=rows>

<TR VALIGN="top">
<TD class=label width=48%><B>Property Exchange Functions</B></TD>
<TD class=label width=52%><B>Purpose</B></TD>
</TR>

<TR VALIGN="top">
<TD width=48%><B>PX_Blob( )</B></TD>
<TD width=52%>Serializes a type Binary Large Object (BLOB) data property.</TD>
</TR>

<TR VALIGN="top">
<TD width=48%><B>PX_Bool( )</B></TD>
<TD width=52%>Serializes a type Boolean property.</TD>
</TR>

<TR VALIGN="top">
<TD width=48%><B>PX_Color( )</B></TD>
<TD width=52%>Serializes a type color<B> </B>property.</TD>
</TR>

<TR VALIGN="top">
<TD width=48%><B>PX_Currency( )</B></TD>
<TD width=52%>Serializes a type <B>CY</B> (currency) property.</TD>
</TR>

<TR VALIGN="top">
<TD width=48%><B>PX_Double( )</B></TD>
<TD width=52%>Serializes a type <B>double</B> property.</TD>
</TR>

<TR VALIGN="top">
<TD width=48%><B>PX_Font( )</B></TD>
<TD width=52%>Serializes a Font type property.</TD>
</TR>

<TR VALIGN="top">
<TD width=48%><B>PX_Float( )</B></TD>
<TD width=52%>Serializes a type <B>float</B> property.</TD>
</TR>

<TR VALIGN="top">
<TD width=48%><B>PX_IUnknown( )</B></TD>
<TD width=52%>Serializes a property of type <B>LPUNKNOWN</B>.</TD>
</TR>

<TR VALIGN="top">
<TD width=48%><B>PX_Long( )</B></TD>
<TD width=52%>Serializes a type <B>long</B> property.</TD>
</TR>

<TR VALIGN="top">
<TD width=48%><B>PX_Picture( )</B></TD>
<TD width=52%>Serializes a type Picture property.</TD>
</TR>

<TR VALIGN="top">
<TD width=48%><B>PX_Short( )</B></TD>
<TD width=52%>Serializes a type <B>short</B> property.</TD>
</TR>

<TR VALIGN="top">
<TD width=48%><B>PX_String( )</B></TD>
<TD width=52%>Serializes a type <B>CString</B> property.</TD>
</TR>

<TR VALIGN="top">
<TD width=48%><B>PX_ULong( )</B></TD>
<TD width=52%>Serializes a type <B>ULONG</B> property.</TD>
</TR>

<TR VALIGN="top">
<TD width=48%><B>PX_UShort( )</B></TD>
<TD width=52%>Serializes a type <B>USHORT</B> property.</TD>
</TR>
</TABLE><BR>

<P>For more information on these property exchange functions, see <A HREF="JavaScript:hhobj_5.Click()">Persistence of OLE (ActiveX) Controls</A> in the <I>Class Library Reference</I>.</P>



<H2><A NAME="_core_customizing_the_default_behavior_of_dopropexchange"></A>Customizing the Default Behavior of DoPropExchange</H2>

<P>The default implementation of <B>DoPropertyExchange</B> (as shown in the previous topic) makes a call to base class <B>COleControl</B>. This serializes the set of properties automatically supported by <B>COleControl</B>, which uses more storage space than serializing only the custom properties of the control. Removing this call allows your object to serialize only those properties you consider important. Any stock property states the control has implemented will not be serialized when saving or loading the control object unless you explicitly add <B>PX_</B> calls for them.</P>



<H2><A NAME="_core_implementing_version_support"></A>Implementing Version Support</H2>

<P>Version support enables a revised ActiveX control to add new persistent properties, and still be able to detect and load the persistent state created by an earlier version of the control. To make a control’s version available as part of the its persistent data, call <A HREF="JavaScript:hhobj_6.Click()">COleControl::ExchangeVersion</A> in the control’s <CODE>DoPropExchange</CODE> function. This call is automatically inserted if the ActiveX control was created using ControlWizard. It can be removed if version support is not desired. However, the cost in control size is very small (4 bytes) for the added flexibility that version support provides.</P>

<P>If the control was not created with ControlWizard, add a call to <B>COleControl::ExchangeVersion</B> by inserting the following line at the beginning of your <CODE>DoPropExchange</CODE> function (before the call to <B>COleControl::DoPropExchange</B>):</P>

<PRE><CODE>void CSampleCtrl::DoPropExchange(CPropExchange* pPX)
{
 ExchangeVersion(pPX, MAKELONG(_wVerMinor, _wVerMajor));
 COleControl::DoPropExchange(pPX);
...
}
</CODE></PRE>

<P>You can use any <B>DWORD</B> as the version number. Projects generated by ControlWizard use <B>_wVerMinor</B> and <B>_wVerMajor</B> as the default. These are global constants defined in the implementation file of the project’s ActiveX control class. Within the remainder of your <CODE>DoPropExchange</CODE> function, you can call <A HREF="JavaScript:hhobj_7.Click()">CPropExchange::GetVersion</A> at any time to retrieve the version you are saving or retrieving.</P>

<P>In the following example, version 1 of this sample control has only a “ReleaseDate” property. Version 2 adds an “OriginalDate” property. If the control is instructed to load the persistent state from the old version, it initializes the member variable for the new property to a default value.</P>

<PRE><CODE>void CSampleCtrl::DoPropExchange(CPropExchange* pPX)
{
    ExchangeVersion(pPX, MAKELONG(_wVerMinor, _wVerMajor));
    COleControl::DoPropExchange(pPX);
    PX_Long(pPX, "ReleaseDate", m_releaseDate);
    if (pPX-&gt;GetVersion() &gt;= MAKELONG(0, 2))
    {
        PX_Long(pPX, "OriginalDate", m_originalDate);
    }
    else
    {
        if (pPX-&gt;IsLoading())
            m_originalDate = 0;
    }
}
</CODE></PRE>

<P>By default, a control “converts” old data to the latest format. For example, if version 2 of a control loads data that was saved by version 1, it will write the version 2 format when it is saved again. If you want the control to save data in the format last read, pass <B>FALSE</B> as a third parameter when calling <B>ExchangeVersion</B>. This third parameter is optional and is <B>TRUE</B> by default.</P>
</font>
</BODY>
</HTML>
