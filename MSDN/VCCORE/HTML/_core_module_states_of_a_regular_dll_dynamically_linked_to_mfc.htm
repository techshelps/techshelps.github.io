<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<HTML>
<HEAD>
<META HTTP-EQUIV="Content-Type" Content="text/html; charset=Windows-1252">
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-83731338-2"></script><script>  window.dataLayer = window.dataLayer || [];  function gtag(){dataLayer.push(arguments);}  gtag('js', new Date());  gtag('config', 'UA-83731338-2');</script><title>Module States of a Regular DLL Dynamically Linked to MFC</TITLE>
<style>@import url(stylesheets/msdn_ie4.css);</style>
<link disabled rel="stylesheet" href="stylesheets/msdn_ie3.css"></HEAD>
<BODY>

<TABLE ALIGN=right WIDTH=0 BORDER=0><TR><TD>
<OBJECT ID="hhobj_1" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink">
	<PARAM NAME="DefaultTopic" VALUE="_topic_not_found.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="_vc_addpf_home">
</OBJECT>
<OBJECT ID="hhobj_2" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink">
	<PARAM NAME="DefaultTopic" VALUE="_topic_not_found.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="_MFCNOTES_TN058">
</OBJECT>
</TD></TR></TABLE>


<font face="verdana,arial,helvetica" size="2">
<H1><A NAME="_core_module_states_of_a_regular_dll_dynamically_linked_to_mfc"></A>Module States of a Regular DLL Dynamically Linked to MFC</H1>

<P><A HREF="JavaScript:hhobj_1.Click()">Home</A>  |&nbsp; <A HREF="_core_dlls.3a_.overview.htm">Overview</A>  |&nbsp; <A HREF="_core_dll_tasks.htm">How Do I</A>  |&nbsp; <A HREF="_core_dlls.3a_.frequently_asked_questions.htm">FAQ</A>  |&nbsp; <A HREF="_core_dll_topics.htm">Details</A>  |&nbsp; <A HREF="_core_dll_sample_programs.htm">Sample</A></P>

<P>The ability to dynamically link a regular DLL to the MFC DLL allows some configurations which are very complicated. For example, a regular DLL and the executable that uses it can both dynamically link to the MFC DLL and to any extension DLLs. </P>

<P>This configuration poses a problem with regard to MFC's global data — things like the pointer to the current <B>CWinApp</B> object, handle maps, etc. </P>

<P>Before MFC version 4.0, this global data resided in the MFC DLL itself and was shared by all the modules in the process. Since each process using a Win32 DLL gets its own copy of the DLL's data, this scheme provided an easy way to track per-process data, and since the AFXDLL model presumed that there would be only one <B>CWinApp</B> object and only one set of handle maps in the process, these items could be tracked in the MFC DLL itself. </P>

<P>But with the ability to dynamically link a regular DLL to the MFC DLL, it is now possible to have two or more <B>CWinApp</B> objects in a process — and also two or more sets of handle maps, etc. How does MFC keep track of which ones it should be using? </P>

<P>The solution is to give each module (application or regular DLL) its own copy of this global state information. Thus, a call to <B>AfxGetApp </B>in the regular DLL returns a pointer to the <B>CWinApp</B> object in the DLL, not the one in the executable. This per-module copy of MFC's global data is known as a "module state" and is described in <A HREF="JavaScript:hhobj_2.Click()">MFC TechNote 58</A>.</P>

<P>MFC's common window procedure automatically switches to the correct module state, so you don't need to worry about it in any message handlers implemented in your regular DLL. But when your executable calls into the regular DLL, you do need to explicitly set the current module state to the one for the DLL. To do this, use the <B>AFX_MANAGE_STATE </B>macro in every function exported from the DLL. This is done by adding the following line of code to the beginning of functions exported from the DLL:</P>

<PRE><CODE>AFX_MANAGE_STATE(AfxGetStaticModuleState( ))
</CODE></PRE>

<H3>What do you want to know more about?</H3>

<UL type=disc>
	<LI><A HREF="_core_managing_the_state_data_of_mfc_modules.htm">Managing the state data of MFC modules</A><BR><BR></LI>

	<LI><A HREF="_core_regular_dlls_dynamically_linked_to_mfc.htm">Regular DLLs dynamically linked to MFC</A><BR><BR></LI>

	<LI><A HREF="_core_extension_dlls.3a_.overview.htm">Extension DLLs</A></LI>
</UL>
</font>
</BODY>
</HTML>
