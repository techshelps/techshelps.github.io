<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<HTML>
<HEAD>
<META HTTP-EQUIV="Content-Type" Content="text/html; charset=Windows-1252">
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-83731338-2"></script><script>  window.dataLayer = window.dataLayer || [];  function gtag(){dataLayer.push(arguments);}  gtag('js', new Date());  gtag('config', 'UA-83731338-2');</script><title>Using TCHAR.H Data Types with _MBCS</TITLE>
<style>@import url(stylesheets/msdn_ie4.css);</style>
<link disabled rel="stylesheet" href="stylesheets/msdn_ie3.css"></HEAD>
<BODY>


<font face="verdana,arial,helvetica" size="2">
<H1><A NAME="_crt_using_tchar.h_data_types_with__mbcs"></A><SUP></SUP>Using TCHAR.H Data Types with _MBCS</H1>

<P><B>Microsoft Specific —&gt;</B></P>

<P>As the table of generic-text routine mappings indicates (see Appendix B, <A HREF="_crt_generic.2d.text_mappings.htm">Generic-Text Mappings</A>), when the manifest constant <B>_MBCS</B> is defined, a given generic-text routine maps to one of the following kinds of routines:

<UL type=disc>
	<LI>An SBCS routine that handles multibyte bytes, characters, and strings appropriately. In this case, the string arguments are expected to be of type <B>char*</B>. For example, <B>_tprintf</B> maps to <B>printf</B>; the string arguments to <B>printf</B> are of type <B>char*</B>. If you use the <B>_TCHAR</B> generic-text data type for your string types, the formal and actual parameter types for <B>printf</B> match because <B>_TCHAR</B>* maps to <B>char*</B>.<BR><BR></LI>

	<LI>An MBCS-specific routine. In this case, the string arguments are expected to be of type <B>unsigned</B> <B>char*</B>. For example, <B>_tcsrev</B> maps to <B>_mbsrev</B>, which expects and returns a string of type <B>unsigned</B> <B>char*</B>. Again, if you use the <B>_TCHAR</B> generic-text data type for your string types, there is a potential type conflict because <B>_TCHAR</B> maps to type <B>char</B>. </LI>
</UL>

<P>Following are three solutions for preventing this type conflict (and the C compiler warnings or C++ compiler errors that would result):

<UL type=disc>
	<LI>Use the default behavior. TCHAR.H provides generic-text routine prototypes for routines in the run-time libraries, as in the following example.
<PRE><CODE>char *_tcsrev(char *);
</CODE></PRE>

<P class=tl>In the default case, the prototype for <B>_tcsrev</B> maps to <B>_mbsrev</B> through a thunk in LIBC.LIB. This changes the types of the <B>_mbsrev</B> incoming parameters and outgoing return value from <B>_TCHAR</B> <B>*</B> (i.e., <B>char</B> <B>*</B>) to <B>unsigned</B> <B>char</B> <B>*</B>. This method ensures type matching when you are using <B>_TCHAR</B>, but it is relatively slow because of the function call overhead.</P></LI>

	<LI>Use function inlining by incorporating the following preprocessor statement in your code.
<PRE><CODE>#define _USE_INLINING
</CODE></PRE>

<P class=tl>This method causes an inline function thunk, provided in TCHAR.H, to map the generic-text routine directly to the appropriate MBCS routine. The following code excerpt from TCHAR.H provides an example of how this is done.</P>
<PRE><CODE>__inline char *_tcsrev(char *_s1)
{return (char *)_mbsrev((unsigned char *)_s1);}
</CODE></PRE>

<P class=tl>If you can use inlining, this is the best solution, because it guarantees type matching and has no additional time cost.</P></LI>

	<LI>Use “direct mapping” by incorporating the following preprocessor statement in your code.
<PRE><CODE>#define _MB_MAP_DIRECT
</CODE></PRE>

<P class=tl>This approach provides a fast alternative if you do not want to use the default behavior or cannot use inlining. It causes the generic-text routine to be mapped by a macro directly to the MBCS version of the routine, as in the following example from TCHAR.H.</P>
<PRE><CODE>#define _tcschr _mbschr
</CODE></PRE>
</LI>
</UL>

<P>When you take this approach, you must be careful to ensure that appropriate data types are used for string arguments and string return values. You can use type casting to ensure proper type matching or you can use the <B>_TXCHAR</B> generic-text data type. <B>_TXCHAR</B> maps to type <B>char</B> in SBCS code but maps to type <B>unsigned</B> <B>char</B> in MBCS code. For more information about generic-text macros, see Appendix B, <A HREF="_crt_generic.2d.text_mappings.htm">Generic-Text Mappings</A>.</P>

<P><B>END Microsoft Specific</B></P>
</font>
</BODY>
</HTML>
