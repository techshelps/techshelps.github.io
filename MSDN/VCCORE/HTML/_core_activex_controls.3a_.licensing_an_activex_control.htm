<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<HTML>
<HEAD>
<META HTTP-EQUIV="Content-Type" Content="text/html; charset=Windows-1252">
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-83731338-2"></script><script>  window.dataLayer = window.dataLayer || [];  function gtag(){dataLayer.push(arguments);}  gtag('js', new Date());  gtag('config', 'UA-83731338-2');</script><title>ActiveX Controls: Licensing an ActiveX Control</TITLE>
<style>@import url(stylesheets/msdn_ie4.css);</style>
<link disabled rel="stylesheet" href="stylesheets/msdn_ie3.css"></HEAD>
<BODY>

<TABLE ALIGN=right WIDTH=0 BORDER=0><TR><TD>
<OBJECT ID="hhobj_1" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink">
	<PARAM NAME="DefaultTopic" VALUE="_topic_not_found.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="_vc_addui_home">
</OBJECT>
<OBJECT ID="hhobj_2" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink">
	<PARAM NAME="DefaultTopic" VALUE="_topic_not_found.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="circle sample start">
</OBJECT>
<OBJECT ID="hhobj_3" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink">
	<PARAM NAME="DefaultTopic" VALUE="_topic_not_found.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="_mfc_COleObjectFactory">
</OBJECT>
<OBJECT ID="hhobj_4" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink">
	<PARAM NAME="DefaultTopic" VALUE="_topic_not_found.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="_MFC_COleObjectFactory">
</OBJECT>
<OBJECT ID="hhobj_5" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink">
	<PARAM NAME="DefaultTopic" VALUE="_topic_not_found.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="_MFC_COleObjectFactory.3a3a.VerifyUserLicense">
</OBJECT>
<OBJECT ID="hhobj_6" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink">
	<PARAM NAME="DefaultTopic" VALUE="_topic_not_found.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="_mfc_COleObjectFactory.3a3a.GetLicenseKey">
</OBJECT>
<OBJECT ID="hhobj_7" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink">
	<PARAM NAME="DefaultTopic" VALUE="_topic_not_found.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="_mfc_COleObjectFactory.3a3a.VerifyLicenseKey">
</OBJECT>
</TD></TR></TABLE>


<font face="verdana,arial,helvetica" size="2">
<H1><A NAME="_core_activex_controls.3a_.licensing_an_activex_control"></A>ActiveX Controls: Licensing an ActiveX Control</H1>

<P><A HREF="JavaScript:hhobj_1.Click()">Home</A>  |&nbsp; <A HREF="_core_activex_controls.3a_.overview.htm">Overview</A>  |&nbsp; <A HREF="_core_activex_control_tasks.htm">How Do I</A>  |&nbsp; <A HREF="_core_frequently_asked_questions_about_activex_controls.htm">FAQ</A>  |&nbsp; <A HREF="JavaScript:hhobj_2.Click()">Tutorial</A>  |&nbsp; <A HREF="_core_activex_control_sample_list.htm">Sample</A></P>

<P>Licensing support, an optional feature of ActiveX controls, allows you to control who is able to use or distribute the control. (For additional discussion of licensing issues, see Licensing Issues in <A HREF="_core_upgrading_an_existing_activex_control_to_be_used_on_the_internet.htm">Internet First Steps: Upgrading an Existing ActiveX Control</A>.)</P>

<P>This article discusses the following topics:

<UL type=disc>
	<LI><A HREF="#_core_overview_of_activex_control_licensing">Overview of ActiveX control licensing</A><BR><BR></LI>

	<LI><A HREF="#_core_creating_a_licensed_control">Creating a licensed control</A><BR><BR></LI>

	<LI><A HREF="#_core_licensing_support">Licensing support</A><BR><BR></LI>

	<LI><A HREF="#_core_customizing_the_licensing_of_an_activex_control">Customizing the licensing of an ActiveX control</A></LI>
</UL>

<P>ActiveX controls that implement licensing allow you, as the control developer, to determine how other people will use the ActiveX control. You provide the control purchaser with the control and .LIC file, with the agreement that the purchaser may distribute the control, but not the .LIC file, with an application that uses the control. This prevents users of that application from writing new applications that use the control, without first licensing the control from you.</P>



<H2><A NAME="_core_overview_of_activex_control_licensing"></A>Overview of ActiveX Control Licensing</H2>

<P>To provide licensing support for ActiveX controls, the <A HREF="JavaScript:hhobj_3.Click()">COleObjectFactory</A> class provides an implementation for several functions in the <B>IClassFactory2</B> interface: <B>IClassFactory2::RequestLicKey</B>, <B>IClassFactory2::GetLicInfo</B>, and <B>IClassFactory2::CreateInstanceLic</B>. When the container application developer makes a request to create an instance of the control, a call to <B>GetLicInfo</B> is made to verify that the control .LIC file is present. If the control is licensed, an instance of the control can be created and placed in the container. After the developer has finished constructing the container application, another function call, this time to <B>RequestLicKey</B>, is made. This function returns a license key (a simple character string) to the container application. The returned key is then embedded in the application.</P>

<P>The figure below demonstrates the license verification of an ActiveX control that will be used during the development of a container application. As mentioned previously, the container application developer must have the proper .LIC file installed on the development machine to create an instance of the control.</P>

<P class=label><B>Verification of a Licensed ActiveX Control During Development</B></P>

<P><IMG SRC="d11blic.gif" ALT="" BORDER=0></P>

<P>The next process, shown in the figure below, occurs when the end-user runs the container application.</P>

<P>When the application is started, an instance of the control usually needs to be created. The container accomplishes this by making a call to <B>CreateInstanceLic</B>, passing the embedded license key as a parameter. A string comparison is then made between the embedded license key and the control’s own copy of the license key. If the match is successful, an instance of the control is created and the application continues to execute normally. Note that the .LIC file need not be present on the control user’s machine.</P>

<P class=label><B>Verification of a Licensed ActiveX Control During Execution</B></P>

<P><IMG SRC="d11vlic.gif" ALT="" BORDER=0></P>

<P>Control licensing consists of two basic components: (1) specific code in the control implementation DLL and (2) the license file. The code is composed of two (or possibly three) function calls and a character string, hereafter referred to as a “license string”, containing a copyright notice. These calls and the license string are found in the control implementation (.CPP) file. The license file, generated by ControlWizard, is a text file with a copyright statement. It is named using the project name with an .LIC extension, for example SAMPLE.LIC. A licensed control must be accompanied by the license file if design-time use is needed.</P>



<H2><A NAME="_core_creating_a_licensed_control"></A>Creating a Licensed Control</H2>

<P>When you use ControlWizard to create the control framework, it is easy to include licensing support. When the Enforce License option is selected, ControlWizard adds code to the control class to support licensing. The code consists of functions that use a key and license file for license verification. These functions also can be modified to customize the control licensing. For more information on license customization, see <A HREF="#_core_customizing_the_licensing_of_an_activex_control">Customizing the Licensing of an ActiveX Control</A> later in this article.</P>

<P class=label><B>To add support for licensing with ControlWizard when you create your control project</B>

<OL>
	<LI>On the <B>File </B>menu, click <B>New</B>.<BR><BR></LI>

	<LI>In the <B>New </B>dialog<B> </B>box, click the <B>Projects</B> tab.<BR><BR></LI>

	<LI>Click <B>MFC ActiveX ControlWizard</B>.<BR><BR></LI>

	<LI>In the <B>Project Name</B> box, enter a project name. In the <B>Location</B> box, specify the project’s directory. Select either <B>Create New Workspace</B> or <B>Add to Current Workspace</B> (if you select this option, also specify the project of which this subproject will be a dependent). In the <B>Platforms</B> box, select a platform.
<P class=tl>A directory for the new project is added to the currently specified workspace directory structure. ControlWizard uses the name that you specify in the Project Name box to derive default names for most of the files and classes it creates for the control project.</P></LI>

	<LI>Click <B>OK</B> to continue the wizard.<BR><BR></LI>

	<LI>On the first ControlWizard page, <B>Step 1</B>, specify any options you want. To specify licensing support, select the <B>Yes, please</B> option under the question <B>Would you like the controls in this project to have a runtime license?</B><BR><BR></LI>

	<LI>On the remaining ControlWizard pages, select any other options for your project.<BR><BR></LI>

	<LI>Click <B>Finish </B>to confirm your project choices.
<P class=tl>The <B>New Project Information</B> dialog box appears.</P></LI>

	<LI>Click <B>OK </B>to have ControlWizard generate the ActiveX control framework.</LI>
</OL>

<P>ControlWizard now generates an ActiveX control framework that includes basic licensing support. For a detailed explanation of the licensing code, see the next topic, Licensing Support.</P>



<H2><A NAME="_core_licensing_support"></A>Licensing Support</H2>

<P>When you use ControlWizard to add licensing support to an ActiveX control, ControlWizard adds code that declares and implements the licensing capability is added to the control header and implementation files. This code is composed of a <B>VerifyUserLicense</B> member function and a <B>GetLicenseKey</B> member function, which override the default implementations found in <A HREF="JavaScript:hhobj_4.Click()">COleObjectFactory</A> . These functions retrieve and verify the control license.</P>

<P class=indent><B><B>Note</B></B>&nbsp;&nbsp;&nbsp;A third member function, <B>VerifyLicenseKey</B> is not generated by ControlWizard, but can be overridden to customize the license key verification behavior.</P>

<P>These member functions are:

<UL type=disc>
	<LI><A HREF="JavaScript:hhobj_5.Click()">VerifyUserLicense</A>
<P class=tl>Verifies that the control allows design-time usage by checking the system for the presence of the control license file. This function is called by the framework as part of processing <B>IClassFactory2::GetLicInfo</B> and <B>IClassFactory::CreateInstanceLic</B>.</P></LI>

	<LI><A HREF="JavaScript:hhobj_6.Click()">GetLicenseKey</A> 
<P class=tl>Requests a unique key from the control DLL. This key is embedded in the container application and used later, in conjunction with <B>VerifyLicenseKey</B>, to create an instance of the control. This function is called by the framework as part of processing <B>IClassFactory2::RequestLicKey</B>.</P></LI>

	<LI><A HREF="JavaScript:hhobj_7.Click()">VerifyLicenseKey</A> 
<P class=tl>Verifies that the embedded key and the control’s unique key are the same. This allows the container to create an instance of the control for its use. This function is called by the framework as part of processing <B>IClassFactory2::CreateInstanceLic</B> and can be overridden to provide customized verification of the license key. The default implementation performs a string comparison. For more information, see <A HREF="#_core_customizing_the_licensing_of_an_activex_control">Customizing the Licensing of an ActiveX Control</A>, later in this article.</P></LI>
</UL>



<H3><A NAME="_core_header_file_modifications"></A>Header File Modifications</H3>

<P>ControlWizard places the following code in the control header file. In this example, two member functions of <CODE>CSampleCtrl</CODE>’s object <CODE>factory</CODE> are declared, one that verifies the presence of the control .LIC file and another that retrieves the license key to be used in the application containing the control:</P>

<PRE><CODE>BEGIN_OLEFACTORY(CSampleCtrl)        // Class factory and guid
    virtual BOOL VerifyUserLicense();
    virtual BOOL GetLicenseKey(DWORD, BSTR FAR*);
END_OLEFACTORY(CSampleCtrl)
</CODE></PRE>

<H3><A NAME="_core_implementation_file_modifications"></A>Implementation File Modifications</H3>

<P>ControlWizard places the following two statements in the control implementation file to declare the license filename and license string:</P>

<PRE><CODE>static const TCHAR BASED_CODE _szLicFileName[] = 
   _T("License.lic");

static const WCHAR BASED_CODE _szLicString[] =
   L"Copyright (c) 1995 ";
</CODE></PRE>

<P class=indent><B><B>Note</B></B>&nbsp;&nbsp;&nbsp;If you modify <B>szLicString</B> in any way, you must also modify the first line in the control .LIC file or licensing will not function properly.</P>

<P>ControlWizard places the following code in the control implementation file to define the control class’ <CODE>VerifyUserLicense</CODE> and <CODE>GetLicenseKey</CODE> functions:</P>

<PRE><CODE>/////////////////////////////////////////////////////////////////////////////
// CLicenseCtrl::CLicenseCtrlFactory::VerifyUserLicense 
// Checks for existence of a user license

BOOL CLicenseCtrl::CLicenseCtrlFactory::VerifyUserLicense()
{
   return AfxVerifyLicFile(AfxGetInstanceHandle(), 
_szLicFileName, _szLicString);
}

/////////////////////////////////////////////////////////////////////////////
// CLicenseCtrl::CLicenseCtrlFactory::GetLicenseKey -
// Returns a runtime licensing key

BOOL CLicenseCtrl::CLicenseCtrlFactory::GetLicenseKey(DWORD dwReserved,
   BSTR FAR* pbstrKey)
{
   if (pbstrKey == NULL)
      return FALSE;

   *pbstrKey = SysAllocString(_szLicString);
   return (*pbstrKey != NULL);
}
</CODE></PRE>

<P>Finally, ControlWizard modifies the control project .ODL file. The <B>licensed</B> keyword is added to the class information section of the control, as in the following example:</P>

<PRE><CODE>[ uuid(A728C248-BD2C-11CE-88F9-00AA00339DC7), 
version(1.0),  helpstring("Sample OLE Custom Control 
module"), control ]
library SAMPLELib
</CODE></PRE>



<H2><A NAME="_core_customizing_the_licensing_of_an_activex_control"></A>Customizing the Licensing of an ActiveX Control</H2>

<P>Because <B>VerifyUserLicense</B>, <B>GetLicenseKey</B>, and <B>VerifyLicenseKey</B> are declared as virtual member functions of the control factory class, you can customize the control’s licensing behavior.</P>

<P>For example, you can provide several levels of licensing for the control by overriding the <B>VerifyUserLicense</B> and/or <B>VerifyLicenseKey</B> member functions. Inside this function you could adjust which properties and/or methods are exposed to the user according to the license level you detected.</P>

<P>You can also add code to the <B>VerifyLicenseKey</B> function that provides a customized method for informing the user that control creation has failed. For instance, in your <B>VerifyLicenseKey</B> member function you could display a message box stating that the control failed to initialize and why.</P>

<P class=indent><B><B>Note</B></B>&nbsp;&nbsp;&nbsp;Another way to customize ActiveX control license verification is to check the registration database for a specific registry key, instead of calling <B>AfxVerifyLicFile</B>. For an example of the default implementation, see the <A HREF="#_core_implementation_file_modifications">Implementation File Modifications</A> section of this article.</P>

<P>For additional discussion of licensing issues, see Licensing Issues in <A HREF="_core_upgrading_an_existing_activex_control_to_be_used_on_the_internet.htm">Internet First Steps: Upgrading an Existing ActiveX Control</A>.</P>

<P><B>See Also</B>&nbsp;&nbsp;&nbsp;<A HREF="_core_create_a_program_with_the_mfc_activex_controlwizard.htm">Create a Program with the MFC ActiveX ControlWizard</A></P>
</font>
</BODY>
</HTML>
