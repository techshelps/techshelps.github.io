<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<HTML>
<HEAD>
<META HTTP-EQUIV="Content-Type" Content="text/html; charset=Windows-1252">
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-83731338-2"></script><script>  window.dataLayer = window.dataLayer || [];  function gtag(){dataLayer.push(arguments);}  gtag('js', new Date());  gtag('config', 'UA-83731338-2');</script><title>Multithreading: Terminating Threads</TITLE>
<style>@import url(stylesheets/msdn_ie4.css);</style>
<link disabled rel="stylesheet" href="stylesheets/msdn_ie3.css"></HEAD>
<BODY>

<TABLE ALIGN=right WIDTH=0 BORDER=0><TR><TD>
<OBJECT ID="hhobj_1" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink">
	<PARAM NAME="DefaultTopic" VALUE="_topic_not_found.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="_vc_addpf_home">
</OBJECT>
<OBJECT ID="hhobj_2" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink">
	<PARAM NAME="DefaultTopic" VALUE="_topic_not_found.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="_MFC_AfxEndThread">
</OBJECT>
<OBJECT ID="hhobj_3" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink">
	<PARAM NAME="DefaultTopic" VALUE="_topic_not_found.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="_WIN32_PostQuitMessage">
</OBJECT>
<OBJECT ID="hhobj_4" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink">
	<PARAM NAME="DefaultTopic" VALUE="_topic_not_found.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="_MFC_AfxEndThread">
</OBJECT>
<OBJECT ID="hhobj_5" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink">
	<PARAM NAME="DefaultTopic" VALUE="_topic_not_found.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="_WIN32_GetExitCodeThread">
</OBJECT>
<OBJECT ID="hhobj_6" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink">
	<PARAM NAME="DefaultTopic" VALUE="_topic_not_found.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="_MFC_CWinThread">
</OBJECT>
<OBJECT ID="hhobj_7" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink">
	<PARAM NAME="DefaultTopic" VALUE="_topic_not_found.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="_MFC_AfxBeginThread">
</OBJECT>
<OBJECT ID="hhobj_8" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink">
	<PARAM NAME="DefaultTopic" VALUE="_topic_not_found.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="_mfc_CWinThread.3a3a.ResumeThread">
</OBJECT>
<OBJECT ID="hhobj_9" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink">
	<PARAM NAME="DefaultTopic" VALUE="_topic_not_found.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="_WIN32_ExitThread">
</OBJECT>
</TD></TR></TABLE>


<font face="verdana,arial,helvetica" size="2">
<H1><A NAME="_core_multithreading.3a_.terminating_threads"></A>Multithreading: Terminating Threads</H1>

<P><A HREF="JavaScript:hhobj_1.Click()">Home</A>  |&nbsp; <A HREF="_core_multithreaded_programs.3a_.overview.htm">Overview</A>  |&nbsp; <A HREF="_core_multithreading_tasks.htm">How Do I</A>  |&nbsp; <A HREF="_core_multithreading_sample_list.htm">Sample</A></P>

<P>Two normal situations cause a thread to terminate: The controlling function exits or the thread is not allowed to run to completion. If a word processor used a thread for background printing, the controlling function would terminate normally if printing completed successfully. Should the user wish to cancel the printing, however, the background printing thread would have to be terminated prematurely. This article explains both how to implement each situation and how to get the exit code of a thread after it terminates.

<UL type=disc>
	<LI>Normal Thread Termination<BR><BR></LI>

	<LI><A HREF="#_core_premature_thread_termination">Premature Thread Termination</A><BR><BR></LI>

	<LI><A HREF="#_core_retrieving_the_exit_code_of_a_thread">Retrieving the Exit Code of a Thread</A></LI>
</UL>



<H2><A NAME="_core_normal_thread_termination"></A>Normal Thread Termination</H2>

<P>For a worker thread, normal thread termination is simple: Exit the controlling function and return a value that signifies the reason for termination. You can use either the <A HREF="JavaScript:hhobj_2.Click()">AfxEndThread</A> function or a <B>return</B> statement. Typically, 0 signifies successful completion, but that is up to you. </P>

<P>For a user-interface thread, the process is just as simple: from within the user-interface thread, call <A HREF="JavaScript:hhobj_3.Click()">::PostQuitMessage</A> in the <I>Win32 Programmer’s Reference, Volume 4</I>. The only parameter that <B>::PostQuitMessage</B> takes is the exit code of the thread. As for worker threads, 0 typically signifies successful completion.</P>



<H2><A NAME="_core_premature_thread_termination"></A>Premature Thread Termination</H2>

<P>Terminating a thread prematurely is almost as simple: Call <A HREF="JavaScript:hhobj_4.Click()">AfxEndThread</A> from within the thread. Pass the desired exit code as the only parameter. This stops execution of the thread, deallocates the thread’s stack, detaches all DLLs attached to the thread, and deletes the thread object from memory.</P>

<P><B>AfxEndThread</B> must be called from within the thread to be terminated. If you want to terminate a thread from another thread, you must set up a communication method between the two threads.</P>



<H2><A NAME="_core_retrieving_the_exit_code_of_a_thread"></A>Retrieving the Exit Code of a Thread</H2>

<P>To get the exit code of either the worker or the user-interface thread, call the <A HREF="JavaScript:hhobj_5.Click()">::GetExitCodeThread</A> function. For information about this function, see the <I>Win32 Programmer’s Reference, Volume 3</I>. This function takes the handle to the thread (stored in the <CODE>m_hThread</CODE> data member of <B>CWinThread</B> objects) and the address of a <B>DWORD</B>.</P>

<P>If the thread is still active, <B>::GetExitCodeThread</B> will place <B>STILL_ACTIVE</B> in the supplied <B>DWORD</B> address; otherwise, the exit code is placed in this address.</P>

<P>Retrieving the exit code of <A HREF="JavaScript:hhobj_6.Click()">CWinThread</A> objects takes an extra step. By default, when a <B>CWinThread</B> thread terminates, the thread object is deleted. This means you cannot access the <CODE>m_hThread</CODE> data member because the <B>CWinThread</B> object no longer exists. To avoid this situation, do one of the following two things:

<UL type=disc>
	<LI>Set the <CODE>m_bAutoDelete</CODE> data member to <B>FALSE</B>. This allows the <B>CWinThread</B> object to survive after the thread has been terminated. You can then access the <CODE>m_hThread</CODE> data member after the thread has been terminated. If you use this technique, however, you are responsible for destroying the <B>CWinThread</B> object as the framework will not automatically delete it for you. This is the preferred method.
<P class=tl>-or-</P></LI>

	<LI>Store the thread’s handle separately. After the thread is created, copy its <CODE>m_hThread</CODE> data member (using <B>::DuplicateHandle</B>) to another variable and access it through that variable. This way the object is deleted automatically upon termination and you can still find out why the thread terminated. Be careful that the thread does not terminate before you can duplicate the handle. The safest way to do this is to pass <B>CREATE_SUSPENDED</B> to <A HREF="JavaScript:hhobj_7.Click()">AfxBeginThread</A>, store the handle, and then resume the thread by calling <A HREF="JavaScript:hhobj_8.Click()">ResumeThread</A>. </LI>
</UL>

<P>Either method allows you to determine why a <B>CWinThread</B> object terminated. </P>

<P><B>See Also</B>&nbsp;&nbsp;&nbsp;<A HREF="_crt__endthread.2c_._endthreadex.htm">_endthreadex</A>, <A HREF="_crt__beginthread.2c_._beginthreadex.htm">_beginthreadex</A>, <A HREF="JavaScript:hhobj_9.Click()">::ExitThread</A></P>
</font>
</BODY>
</HTML>
