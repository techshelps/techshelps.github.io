<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<HTML>
<HEAD>
<META HTTP-EQUIV="Content-Type" Content="text/html; charset=Windows-1252">
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-83731338-2"></script><script>  window.dataLayer = window.dataLayer || [];  function gtag(){dataLayer.push(arguments);}  gtag('js', new Date());  gtag('config', 'UA-83731338-2');</script><title>Optimizing Control Drawing</TITLE>
<style>@import url(stylesheets/msdn_ie4.css);</style>
<link disabled rel="stylesheet" href="stylesheets/msdn_ie3.css"></HEAD>
<BODY>

<TABLE ALIGN=right WIDTH=0 BORDER=0><TR><TD>
<OBJECT ID="hhobj_1" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink">
	<PARAM NAME="DefaultTopic" VALUE="_topic_not_found.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="_vc_addui_home">
</OBJECT>
<OBJECT ID="hhobj_2" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink">
	<PARAM NAME="DefaultTopic" VALUE="_topic_not_found.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="circle sample start">
</OBJECT>
<OBJECT ID="hhobj_3" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink">
	<PARAM NAME="DefaultTopic" VALUE="_topic_not_found.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="_mfc_COleControl.3a3a.IsOptimizedDraw">
</OBJECT>
<OBJECT ID="hhobj_4" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink">
	<PARAM NAME="DefaultTopic" VALUE="_topic_not_found.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="_mfc_CPen">
</OBJECT>
<OBJECT ID="hhobj_5" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink">
	<PARAM NAME="DefaultTopic" VALUE="_topic_not_found.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="_mfc_CBrush">
</OBJECT>
<OBJECT ID="hhobj_6" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink">
	<PARAM NAME="DefaultTopic" VALUE="_topic_not_found.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="_mfc_COleControl.3a3a.OnForeColorChanged">
</OBJECT>
<OBJECT ID="hhobj_7" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink">
	<PARAM NAME="DefaultTopic" VALUE="_topic_not_found.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="_mfc_COleControl.3a3a.OnBackColorChanged">
</OBJECT>
<OBJECT ID="hhobj_8" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink">
	<PARAM NAME="DefaultTopic" VALUE="_topic_not_found.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="_mfc_COleControl">
</OBJECT>
</TD></TR></TABLE>


<font face="verdana,arial,helvetica" size="2">
<H1><A NAME="_core_optimizing_control_drawing"></A>Optimizing Control Drawing</H1>

<P><A HREF="JavaScript:hhobj_1.Click()">Home</A>  |&nbsp; <A HREF="_core_activex_controls.3a_.overview.htm">Overview</A>  |&nbsp; <A HREF="_core_activex_control_tasks.htm">How Do I</A>  |&nbsp; <A HREF="_core_frequently_asked_questions_about_activex_controls.htm">FAQ</A>  |&nbsp; <A HREF="JavaScript:hhobj_2.Click()">Tutorial</A>  |&nbsp; <A HREF="_core_activex_control_sample_list.htm">Sample</A></P>

<P>When a control is instructed to draw itself into a container-supplied device context, it typically selects GDI objects (such as pens, brushes, and fonts) into the device context, performs its drawing operations, and restores the previous GDI objects. If the container has multiple controls that are to be drawn into the same device context, and each control selects the GDI objects it requires, time can be saved if the controls do not individually restore previously selected objects. After all of the controls have been drawn, the container can automatically restore the original objects.</P>

<P>To detect whether a container supports this technique, a control can call the <A HREF="JavaScript:hhobj_3.Click()">COleControl::IsOptimizedDraw</A> member function. If this function returns <B>TRUE</B>, the control can skip the normal step of restoring the previously selected objects.</P>

<P>Consider a control that has the following (unoptimized) <CODE>OnDraw</CODE> function:</P>

<PRE><CODE>void CMyCtrl::OnDraw(CDC* pdc, CRect&amp; rcBounds, CRect&amp; rcInvalid)
{
    CPen pen(PS_SOLID, 0, TranslateColor(GetForeColor()));
    CBrush brush(TranslateColor(GetBackColor()));
    CPen* pPenSave = pdc-&gt;SelectObject(&amp;pen);
    CBrush* pBrushSave = pdc-&gt;SelectObject(&amp;brush);
    Rectangle(rcBounds);
    pdc-&gt;SelectObject(pPenSave);
    pdc-&gt;SelectObject(pBrushSave);
}

</CODE></PRE>

<P>The pen and brush in this example are local variables, meaning their destructors will be called when they go out of scope (when the <CODE>OnDraw</CODE> function ends). The destructors will attempt to delete the corresponding GDI objects. But they should not be deleted if you plan to leave them selected into the device context upon returning from <CODE>OnDraw</CODE>.</P>

<P>To prevent the <A HREF="JavaScript:hhobj_4.Click()">CPen</A> and <A HREF="JavaScript:hhobj_5.Click()">CBrush</A> objects from being destroyed when <CODE>OnDraw</CODE> finishes, store them in member variables instead of local variables. In the control's class declaration, add declarations for two new member variables:</P>

<PRE><CODE>class CMyCtrl : public COleControl
{
    .
    .
    .
    CPen m_pen;
    CBrush m_brush;
}

</CODE></PRE>

<P>Then, the <CODE>OnDraw</CODE> function can be rewritten as follows:</P>

<PRE><CODE>void CMyCtrl::OnDraw(CDC* pdc, CRect&amp; rcBounds, CRect&amp; rcInvalid)
{
    if (m_pen.m_hObject == NULL)
        m_pen.CreatePen(PS_SOLID, 0, TranslateColor(GetForeColor()));
    if (m_Brush.m_hObject == NULL)
        m.Brush.CreateSolidBrush(TranslateColor(GetBackColor()));
    CPen* pPenSave = pdc-&gt;SelectObject(&amp;m_pen);
    CBrush* pBrushSave = pdc-&gt;SelectObject(&amp;m_brush);
    Rectangle(rcBounds);
    pdc-&gt;SelectObject(pPenSave);
    pdc-&gt;SelectObject(pBrushSave);
}

</CODE></PRE>

<P>This approach avoids creation of the pen and brush every time <CODE>OnDraw</CODE> is called. The speed improvement comes at the cost of maintaining additional instance data.</P>

<P>If the ForeColor or BackColor property changes, the pen or brush needs to be created again. To do this, override the <A HREF="JavaScript:hhobj_6.Click()">OnForeColorChanged</A> and <A HREF="JavaScript:hhobj_7.Click()">OnBackColorChanged</A> member functions:</P>

<PRE><CODE>void CMyCtrl::OnForeColorChanged()
{
    m_pen.DeleteObject();
}

void CMyCtrl::OnBackColorChanged()
{
    m_brush.DeleteObject();
}

</CODE></PRE>

<P>Finally, to eliminate unnecessary <B>SelectObject</B> calls, modify <CODE>OnDraw</CODE> as follows:</P>

<PRE><CODE>void CMyCtrl::OnDraw(CDC* pdc, CRect&amp; rcBounds, CRect&amp; rcInvalid)
{
    if (m_pen.m_hObject == NULL)
        m_pen.CreatePen(PS_SOLID, 0, TranslateColor(GetForeColor()));
    if (m_Brush.m_hObject == NULL)
        m.Brush.CreateSolidBrush(TranslateColor(GetBackColor()));
    CPen* pPenSave = pdc-&gt;SelectObject(&amp;m_pen);
    CBrush* pBrushSave = pdc-&gt;SelectObject(&amp;m_brush);
    Rectangle(rcBounds);
    if (! IsOptimizedDraw())
    {
        pdc-&gt;SelectObject(pPenSave);
        pdc-&gt;SelectObject(pBrushSave);
    }
}

</CODE></PRE>

<P><B>See Also</B>&nbsp;&nbsp;&nbsp;<A HREF="JavaScript:hhobj_8.Click()">COleControl</A>, <A HREF="_core_activex_controls.htm#_core_serializing_activex_elements">Serialization</A>, <A HREF="_core_activex_controls.htm#_core_basic_components_of_an_activex_control">Basic Components of an ActiveX Control</A>, <A HREF="_core_create_a_program_with_the_mfc_activex_controlwizard.htm">Create a Program with the MFC ActiveX ControlWizard</A>, <A HREF="_core_activex_controls.3a_.painting_an_activex_control.htm">ActiveX Controls: Painting an ActiveX Control</A></P>
</font>
</BODY>
</HTML>
