<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<HTML>
<HEAD>
<META HTTP-EQUIV="Content-Type" Content="text/html; charset=Windows-1252">
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-83731338-2"></script><script>  window.dataLayer = window.dataLayer || [];  function gtag(){dataLayer.push(arguments);}  gtag('js', new Date());  gtag('config', 'UA-83731338-2');</script><title>ActiveX Controls: Subclassing a Windows Control</TITLE>
<style>@import url(stylesheets/msdn_ie4.css);</style>
<link disabled rel="stylesheet" href="stylesheets/msdn_ie3.css"></HEAD>
<BODY>

<TABLE ALIGN=right WIDTH=0 BORDER=0><TR><TD>
<OBJECT ID="hhobj_1" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink">
	<PARAM NAME="DefaultTopic" VALUE="_topic_not_found.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="_vc_addui_home">
</OBJECT>
<OBJECT ID="hhobj_2" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink">
	<PARAM NAME="DefaultTopic" VALUE="_topic_not_found.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="circle sample start">
</OBJECT>
<OBJECT ID="hhobj_3" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink">
	<PARAM NAME="DefaultTopic" VALUE="_topic_not_found.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="_sample_mfc_CONTROLS">
</OBJECT>
<OBJECT ID="hhobj_4" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink">
	<PARAM NAME="DefaultTopic" VALUE="_topic_not_found.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="_WIN32_WM_CTLCOLORBTN">
</OBJECT>
<OBJECT ID="hhobj_5" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink">
	<PARAM NAME="DefaultTopic" VALUE="_topic_not_found.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="_WIN32_WM_CTLCOLORDLG">
</OBJECT>
<OBJECT ID="hhobj_6" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink">
	<PARAM NAME="DefaultTopic" VALUE="_topic_not_found.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="_WIN32_WM_CTLCOLOREDIT">
</OBJECT>
<OBJECT ID="hhobj_7" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink">
	<PARAM NAME="DefaultTopic" VALUE="_topic_not_found.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="_WIN32_WM_CTLCOLORLISTBOX">
</OBJECT>
<OBJECT ID="hhobj_8" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink">
	<PARAM NAME="DefaultTopic" VALUE="_topic_not_found.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="_WIN32_WM_CTLCOLORMSGBOX">
</OBJECT>
<OBJECT ID="hhobj_9" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink">
	<PARAM NAME="DefaultTopic" VALUE="_topic_not_found.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="_WIN32_WM_CTLCOLORSCROLLBAR">
</OBJECT>
<OBJECT ID="hhobj_10" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink">
	<PARAM NAME="DefaultTopic" VALUE="_topic_not_found.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="_WIN32_WM_CTLCOLORSTATIC">
</OBJECT>
<OBJECT ID="hhobj_11" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink">
	<PARAM NAME="DefaultTopic" VALUE="_topic_not_found.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="_sample_mfc_CONTROLS">
</OBJECT>
</TD></TR></TABLE>


<font face="verdana,arial,helvetica" size="2">
<H1><A NAME="_core_activex_controls.3a_.subclassing_a_windows_control"></A>ActiveX Controls: Subclassing a Windows Control</H1>

<P><A HREF="JavaScript:hhobj_1.Click()">Home</A>  |&nbsp; <A HREF="_core_activex_controls.3a_.overview.htm">Overview</A>  |&nbsp; <A HREF="_core_activex_control_tasks.htm">How Do I</A>  |&nbsp; <A HREF="_core_frequently_asked_questions_about_activex_controls.htm">FAQ</A>  |&nbsp; <A HREF="JavaScript:hhobj_2.Click()">Tutorial</A>  |&nbsp; <A HREF="_core_activex_control_sample_list.htm">Sample</A></P>

<P>This article describes the process for subclassing a common Windows control to create an ActiveX control. Subclassing an existing Windows control is a quick way to develop an ActiveX control. The new control will have the abilities of the subclassed Windows control, such as painting and responding to mouse clicks. The MFC ActiveX controls sample BUTTON, listed under <A HREF="JavaScript:hhobj_3.Click()">CONTROLS</A>, is an example of subclassing a Windows control.</P>

<P>To subclass a Windows control, complete the following tasks:

<UL type=disc>
	<LI><A HREF="#_core_overriding_issubclassedcontrol_and_precreatewindow">Override the IsSubclassedControl and PreCreateWindow member functions of COleControl</A><BR><BR></LI>

	<LI><A HREF="#_core_modifying_the_ondraw_member_function">Modify the OnDraw member function</A><BR><BR></LI>

	<LI><A HREF="#_core_handling_reflected_window_messages">Handle any ActiveX control messages (OCM) reflected to the control</A></LI>
</UL>

<P class=indent><B><B>Note</B></B>&nbsp;&nbsp;&nbsp;Much of this work is done for you by ControlWizard if you select the Subclass Windows Control option in the Control Options dialog box.</P>



<H2><A NAME="_core_overriding_issubclassedcontrol_and_precreatewindow"></A>Overriding IsSubclassedControl and PreCreateWindow</H2>

<P>To override <B>PreCreateWindow</B> and <B>IsSubclassedControl</B>, add the following lines of code to the <B>protected</B> section of the control class declaration:</P>

<PRE><CODE>BOOL PreCreateWindow( CREATESTRUCT&amp; cs );
BOOL IsSubclassedControl( );
</CODE></PRE>

<P>In the control implementation file (.CPP), add the following lines of code to implement the two overridden functions:</P>

<PRE><CODE>BOOL CSampleCtrl::PreCreateWindow( CREATESTRUCT&amp; cs )
{
    cs.lpszClass = _T("BUTTON");
    return COleControl::PreCreateWindow(cs);
}
BOOL CSampleCtrl::IsSubclassedControl( )
{
    return TRUE;
}
</CODE></PRE>

<P>Notice that, in this example, the Windows button control is specified in <B>PreCreateWindow</B>. However, any of the standard Windows controls can be subclassed. For more information on standard Windows controls, see&nbsp; <A HREF="_core_controls.3a_.overview.htm">Controls: Overview</A>.</P>

<P>When subclassing a Windows control, you may want to specify particular window style (<B>WS_</B>) or extended window style (<B>WS_EX_</B>) flags to be used in creating the control's window. You can set values for these parameters in the <B>PreCreateWindow</B> member function by modifying the <B>cs.style</B> and the <B>cs.dwExStyle</B> structure fields. Modifications to these fields should be made using an <B>OR</B> operation, to preserve the default flags that are set by class <B>COleControl</B>. For example, if the control is subclassing the BUTTON control and you want the control to appear as a check box, insert the following line of code into the implementation of <CODE>CSampleCtrl::PreCreateWindow</CODE>, before the return statement:</P>

<PRE><CODE>cs.style |= BS_CHECKBOX;
</CODE></PRE>

<P>This operation adds the <B>BS_CHECKBOX</B> style flag, while leaving the default style flag (<B>WS_CHILD</B>) of class <B>COleControl</B> intact.</P>



<H2><A NAME="_core_modifying_the_ondraw_member_function"></A>Modifying the OnDraw Member Function</H2>

<P>If you want your subclassed control to keep the same appearance as the corresponding Windows control, the <CODE>OnDraw</CODE> member function for the control should contain only a call to the <B>DoSuperclassPaint</B> member function, as in the following example:</P>

<PRE><CODE>    void CSampleCtrl::OnDraw( CDC* pdc, const CRect&amp; rcBounds,
        const CRect&amp; rcInvalid )
    {
     DoSuperclassPaint( pdc, rcBounds );
    }
</CODE></PRE>

<P>The <B>DoSuperclassPaint</B> member function, implemented by <B>COleControl</B>, uses the window procedure of the Windows control to draw the control in the specified device context, within the bounding rectangle. This makes the control visible even when it is not active.</P>

<P class=indent><B><B>Note</B></B>&nbsp;&nbsp;&nbsp;The <B>DoSuperclassPaint</B> member function will work only with those control types that allow a device context to be passed as the <B>wParam</B> of a <B>WM_PAINT</B> message. This includes some of the standard Windows controls, such as <B>SCROLLBAR</B> and <B>BUTTON</B>, and all of the Windows 95 common controls. For controls that do not support this behavior, you will have to provide your own code to properly display an inactive control.</P>



<H2><A NAME="_core_handling_reflected_window_messages"></A>Handling Reflected Window Messages</H2>

<P>Windows controls typically send certain window messages to their parent window. Some of these messages, such as <B>WM_COMMAND</B>, provide notification of an action by the user. Others, such as <B>WM_CTLCOLOR</B>, are used to obtain information from the parent window. An ActiveX control usually communicates with the parent window by other means. Notifications are communicated by firing events (sending event notifications), and information about the control container is obtained by accessing the container’s ambient properties. Because these communication techniques exist, ActiveX control containers are not expected to process any window messages sent by the control.</P>

<P>To prevent the container from receiving the window messages sent by a subclassed Windows control, <B>COleControl</B> creates an extra window to serve as the control's parent. This extra window, called a “reflector”, is created only for an ActiveX control that subclasses a Windows control and has the same size and position as the control window. The reflector window intercepts certain window messages and sends them back to the control. The control, in its window procedure, can then process these reflected messages by taking actions appropriate for an ActiveX control (for example, firing an event).</P>

<P>The following table shows the messages that are intercepted and the corresponding messages that the reflector window sends.</P>

<P class=label><B>Reflected Windows Messages</B></P>

<TABLE border=1 cellpadding=5 cols=2 frame=below rules=rows>

<TR VALIGN="top">
<TD class=label width=42%><B>Message sent by control</B></TD>
<TD class=label width=58%><B>Message reflected to control</B></TD>
</TR>

<TR VALIGN="top">
<TD width=42%><B>WM_COMMAND</B></TD>
<TD width=58%><B>OCM_COMMAND</B></TD>
</TR>

<TR VALIGN="top">
<TD width=42%><B>WM_CTLCOLOR</B></TD>
<TD width=58%><B>OCM_CTLCOLOR</B></TD>
</TR>

<TR VALIGN="top">
<TD width=42%><B>WM_DRAWITEM</B></TD>
<TD width=58%><B>OCM_DRAWITEM</B></TD>
</TR>

<TR VALIGN="top">
<TD width=42%><B>WM_MEASUREITEM</B></TD>
<TD width=58%><B>OCM_MEASUREITEM</B></TD>
</TR>

<TR VALIGN="top">
<TD width=42%><B>WM_DELETEITEM</B></TD>
<TD width=58%><B>OCM_DELETEITEM</B></TD>
</TR>

<TR VALIGN="top">
<TD width=42%><B>WM_VKEYTOITEM</B></TD>
<TD width=58%><B>OCM_VKEYTOITEM</B></TD>
</TR>

<TR VALIGN="top">
<TD width=42%><B>WM_CHARTOITEM</B></TD>
<TD width=58%><B>OCM_CHARTOITEM</B></TD>
</TR>

<TR VALIGN="top">
<TD width=42%><B>WM_COMPAREITEM</B></TD>
<TD width=58%><B>OCM_COMPAREITEM</B></TD>
</TR>

<TR VALIGN="top">
<TD width=42%><B>WM_HSCROLL</B></TD>
<TD width=58%><B>OCM_HSCROLL</B></TD>
</TR>

<TR VALIGN="top">
<TD width=42%><B>WM_VSCROLL</B></TD>
<TD width=58%><B>OCM_VSCROLL</B></TD>
</TR>

<TR VALIGN="top">
<TD width=42%><B>WM_NOTIFY</B></TD>
<TD width=58%><B>OCM_NOTIFY</B></TD>
</TR>

<TR VALIGN="top">
<TD width=42%><B>WM_PARENTNOTIFY</B></TD>
<TD width=58%><B>OCM_PARENTNOTIFY</B></TD>
</TR>
</TABLE><BR>

<P class=indent><B><B>Note</B></B>  If the control runs on a Win32 system, there are several types of <B>WM_CTLCOLOR</B> messages it may receive instead of <B>WM_CTLCOLOR</B>. For more information, see <A HREF="JavaScript:hhobj_4.Click()">WM_CTLCOLORBTN</A>, <A HREF="JavaScript:hhobj_5.Click()">WM_CTLCOLORDLG</A>, <A HREF="JavaScript:hhobj_6.Click()">WM_CTLCOLOREDIT</A>, <A HREF="JavaScript:hhobj_7.Click()">WM_CTLCOLORLISTBOX</A>, <A HREF="JavaScript:hhobj_8.Click()">WM_CTLCOLORMSGBOX</A>, <A HREF="JavaScript:hhobj_9.Click()">WM_CTLCOLORSCROLLBAR</A>, <A HREF="JavaScript:hhobj_10.Click()">WM_CTLCOLORSTATIC</A>.</P>

<P>An ActiveX control container may be designed to perform message reflection itself, eliminating the need for <B>COleControl</B> to create the reflector window and reducing the run-time overhead for a subclassed Windows control. <B>COleControl</B> detects whether the container supports this capability by checking for a MessageReflect ambient property with a value of <B>TRUE</B>.</P>

<P>To handle a reflected window message, add an entry to the control message map and implement a handler function. Because reflected messages are not part of the standard set of messages defined by Windows, ClassWizard does not support adding such message handlers. However, it is not difficult to add a handler manually.</P>

<P>To add a message handler for a reflected window message manually do the following:

<UL type=disc>
	<LI>In the control class .H file, declare a handler function. The function should have a return type of <B>LRESULT</B> and two parameters, with types <B>WPARAM</B> and <B>LPARAM</B>, respectively. For example:
<PRE><CODE>class CSampleCtrl : public COleControl
{
 protected:
LRESULT OnOcmCommand( WPARAM wParam, LPARAM lParam );
...
}
</CODE></PRE>
</LI>

	<LI>In the control class .CPP file, add an <B>ON_MESSAGE</B> entry to the message map. The parameters of this entry should be the message identifier and the name of the handler function. For example:
<PRE><CODE>BEGIN_MESSAGE_MAP(CSampleCtrl, COleControl)
//{{AFX_MSG_MAP(CSampleCtrl)
...
ON_MESSAGE(OCM_COMMAND, OnOcmCommand)
...
//}}AFX_MSG_MAP
END_MESSAGE_MAP()
</CODE></PRE>
</LI>

	<LI>Also in the .CPP file, implement the <B>OnOcmCommand</B> member function to process the reflected message. The <B>wParam</B> and <B>lParam</B> parameters are the same as those of the original window message.</LI>
</UL>

<P>For an example of how reflected messages are processed, refer to the MFC ActiveX controls sample BUTTON, listed under <A HREF="JavaScript:hhobj_11.Click()">CONTROLS</A>. It demonstrates an <B>OnOcmCommand</B> handler that detects the <B>BN_CLICKED</B> notification code and responds by firing (sending) a Click event.</P>
</font>
</BODY>
</HTML>
