<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<HTML>
<HEAD>
<META HTTP-EQUIV="Content-Type" Content="text/html; charset=Windows-1252">
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-83731338-2"></script><script>  window.dataLayer = window.dataLayer || [];  function gtag(){dataLayer.push(arguments);}  gtag('js', new Date());  gtag('config', 'UA-83731338-2');</script><title>Defining __asm Blocks as C Macros</TITLE>
<style>@import url(stylesheets/msdn_ie4.css);</style>
<link disabled rel="stylesheet" href="stylesheets/msdn_ie3.css"></HEAD>
<BODY>

<TABLE ALIGN=right WIDTH=0 BORDER=0><TR><TD>
<OBJECT ID="hhobj_1" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink">
	<PARAM NAME="DefaultTopic" VALUE="_topic_not_found.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="_vc_addpf_home">
</OBJECT>
</TD></TR></TABLE>


<font face="verdana,arial,helvetica" size="2">
<H1><A NAME="_core_defining___asm_blocks_as_c_macros"></A>Defining __asm Blocks as C Macros</H1>

<P><A HREF="JavaScript:hhobj_1.Click()">Home</A>  |&nbsp; <A HREF="_core_assembler_.28.inline.293a_.overview.htm">Overview</A>  |&nbsp; <A HREF="_core_assembler_.28.inline.29_.tasks.htm">How Do I</A></P>

<P>C macros offer a convenient way to insert assembly code into your source code, but they demand extra care because a macro expands into a single logical line. To create trouble-free macros, follow these rules:

<UL type=disc>
	<LI>Enclose the <B>__asm</B> block in braces.<BR><BR></LI>

	<LI>Put the <B>__asm</B> keyword in front of each assembly instruction.<BR><BR></LI>

	<LI>Use old-style C comments ( <CODE>/* comment */</CODE>) instead of assembly-style comments ( <CODE>; comment</CODE>) or single-line C comments ( <CODE>// comment</CODE>).</LI>
</UL>

<P>To illustrate, the following example defines a simple macro:</P>

<PRE><CODE>#define PORTIO __asm      \
/* Port output */         \
{                         \
   __asm mov al, 2        \
   __asm mov dx, 0xD007   \
   __asm out al, dx       \
}
</CODE></PRE>

<P>At first glance, the last three <B>__asm</B> keywords seem superfluous. They are needed, however, because the macro expands into a single line:</P>

<PRE><CODE>__asm /* Port output */ { __asm mov al, 2  __asm mov dx, 0xD007 __asm out al, dx }
</CODE></PRE>

<P>The third and fourth <B>__asm</B> keywords are needed as statement separators. The only statement separators recognized in <B>__asm</B> blocks are the newline character and <B>__asm</B> keyword. Because a block defined as a macro is one logical line, you must separate each instruction with <B>__asm</B>.</P>

<P>The braces are essential as well. If you omit them, the compiler can be confused by C or C++ statements on the same line to the right of the macro invocation. Without the closing brace, the compiler cannot tell where assembly code stops, and it sees C or C++ statements after the <B>__asm</B> block as assembly instructions.</P>

<P>Assembly-style comments that start with a semicolon (<B>;</B>) continue to the end of the line. This causes problems in macros because the compiler ignores everything after the comment, all the way to the end of the logical line. The same is true of single-line C or C++ comments ( <CODE>// comment</CODE>). To prevent errors, use old-style C comments ( <CODE>/* comment */</CODE>) in <B>__asm</B> blocks defined as macros.</P>

<P>An <B>__asm</B> block written as a C macro can take arguments. Unlike an ordinary C macro, however, an <B>__asm</B> macro cannot return a value. So you cannot use such macros in C or C++ expressions.</P>

<P>Be careful not to invoke macros of this type indiscriminately. For instance, invoking an assembly-language macro in a function declared with the <B>__fastcall</B> convention may cause unexpected results. (See <A HREF="_core_using_and_preserving_registers_in_inline_assembly.htm">Using and Preserving Registers in Inline Assembly</A>.)</P>
</font>
</BODY>
</HTML>
