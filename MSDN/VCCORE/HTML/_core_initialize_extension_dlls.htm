<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<HTML>
<HEAD>
<META HTTP-EQUIV="Content-Type" Content="text/html; charset=Windows-1252">
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-83731338-2"></script><script>  window.dataLayer = window.dataLayer || [];  function gtag(){dataLayer.push(arguments);}  gtag('js', new Date());  gtag('config', 'UA-83731338-2');</script><title>Initialize Extension DLLs</TITLE>
<style>@import url(stylesheets/msdn_ie4.css);</style>
<link disabled rel="stylesheet" href="stylesheets/msdn_ie3.css"></HEAD>
<BODY>

<TABLE ALIGN=right WIDTH=0 BORDER=0><TR><TD>
<OBJECT ID="hhobj_1" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink">
	<PARAM NAME="DefaultTopic" VALUE="_topic_not_found.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="_vc_addpf_home">
</OBJECT>
<OBJECT ID="hhobj_2" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink">
	<PARAM NAME="DefaultTopic" VALUE="_topic_not_found.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="_win32_TlsAlloc">
</OBJECT>
<OBJECT ID="hhobj_3" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink">
	<PARAM NAME="DefaultTopic" VALUE="_topic_not_found.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="_win32_Using_Thread_Local_Storage_in_a_Dynamic_Link_Library">
</OBJECT>
<OBJECT ID="hhobj_4" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink">
	<PARAM NAME="DefaultTopic" VALUE="_topic_not_found.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="_sample_mfc_DLLHUSK">
</OBJECT>
<OBJECT ID="hhobj_5" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink">
	<PARAM NAME="DefaultTopic" VALUE="_topic_not_found.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="_win32_dllmain">
</OBJECT>
<OBJECT ID="hhobj_6" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink">
	<PARAM NAME="DefaultTopic" VALUE="_topic_not_found.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="_win32_Dynamic_Link_Library_Entry_Point_Function">
</OBJECT>
</TD></TR></TABLE>


<font face="verdana,arial,helvetica" size="2">
<H1><A NAME="_core_initialize_extension_dlls"></A>Initialize Extension DLLs</H1>

<P><A HREF="JavaScript:hhobj_1.Click()">Home</A>  |&nbsp; <A HREF="_core_dlls.3a_.overview.htm">Overview</A>  |&nbsp; <A HREF="_core_dll_tasks.htm">How Do I</A>  |&nbsp; <A HREF="_core_dlls.3a_.frequently_asked_questions.htm">FAQ</A>  |&nbsp; <A HREF="_core_dll_topics.htm">Details</A>  |&nbsp; <A HREF="_core_dll_sample_programs.htm">Sample</A></P>

<P>Because extension DLLs do not have a <B>CWinApp</B>-derived object (as do regular DLLs), you should add your initialization and termination code to the <B>DllMain</B> function that AppWizard generates. </P>

<P>AppWizard provides the following code for extension DLLs. In the code below, <CODE>PROJNAME</CODE> is a placeholder for the name of your project.</P>

<PRE><CODE>#include "stdafx.h"
#include &lt;afxdllx.h&gt;

#ifdef _DEBUG
#define new DEBUG_NEW
#undef THIS_FILE
static char THIS_FILE[] = __FILE__;
#endif
static AFX_EXTENSION_MODULE PROJNAMEDLL = { NULL, NULL };

extern "C" int APIENTRY
DllMain(HINSTANCE hInstance, DWORD dwReason, LPVOID lpReserved)
{
   if (dwReason == DLL_PROCESS_ATTACH)
   {
      TRACE0("PROJNAME.DLL Initializing!\n");
      
      // Extension DLL one-time initialization
      AfxInitExtensionModule(PROJNAMEDLL, 
                                 hInstance);

      // Insert this DLL into the resource chain
      new CDynLinkLibrary(Dll3DLL);
   }
   else if (dwReason == DLL_PROCESS_DETACH)
   {
      TRACE0("PROJNAME.DLL Terminating!\n");
   }
   return 1;   // ok
}
</CODE></PRE>

<P>Creating a new <B>CDynLinkLibrary</B> object during initialization allows the extension DLL to export <B>CRuntimeClass</B> objects or resources to the client application.</P>

<P>If you are going to use your extension DLL from one or more regular DLLs, you must export an initialization function that creates a <B>CDynLinkLibrary</B> object. That function must be called from each of the regular DLLs that use the extension DLL. An appropriate place to call this initialization function is in the <B>InitInstance</B> member function of the regular DLL’s <B>CWinApp</B>-derived object before using any of the extension DLL's exported classes or functions. </P>

<P>In the <B>DllMain</B> that AppWizard generates, the call to <B>AfxInitExtensionModule</B> captures the module’s run-time classes (<B>CRuntimeClass</B> structures) as well as its object factories (<B>COleObjectFactory</B> objects) for use when the <B>CDynLinkLibrary</B> object is created. You should check the return value of <B>AfxInitExtensionModule</B>; if a zero value is returned from <B>AfxInitExtensionModule</B>, return zero from your <B>DllMain</B> function. </P>

<P>If your extension DLL will be explicitly linked to an executable (meaning the executable calls <B>AfxLoadLibrary</B> to link to the DLL), you should add a call to <B>AfxTermExtensionModule</B> on <B>DLL_PROCESS_DETACH</B>. This function allows MFC to clean up the extension DLL when each process detaches from the extension DLL (which happens when the process exits, or when the DLL is unloaded as a result of a <B>AfxFreeLibrary</B> call). If your extension DLL will be linked implicitly to the application, the call to <B>AfxTermExtensionModule</B> is not necessary.</P>

<P>Applications that explicitly link to extension DLLs must call <B>AfxTermExtensionModule </B>when freeing the DLL. They should also use <B>AfxLoadLibrary</B> and <B>AfxFreeLibrary</B> (instead of the Win32 functions <B>LoadLibrary</B> and <B>FreeLibrary</B>) if the application uses multiple threads. Using <B>AfxLoadLibrary</B> and <B>AfxFreeLibrary</B> ensures that the startup and shutdown code that executes when the extension DLL is loaded and unloaded does not corrupt the global MFC state.</P>

<P>Because the MFCx0.DLL is fully initialized by the time <B>DllMain</B> is called, you can allocate memory and call MFC functions within <B>DllMain</B> (unlike the 16-bit version of MFC).</P>

<P>Extension DLLs can take care of multithreading by handling the <B>DLL_THREAD_ATTACH</B> and <B>DLL_THREAD_DETACH</B> cases in the <B>DllMain</B> function. These cases are passed to <B>DllMain</B> when threads attach and detach from the DLL. Calling <A HREF="JavaScript:hhobj_2.Click()">TlsAlloc</A> when a DLL is attaching allows the DLL to maintain thread local storage (TLS) indexes for every thread attached to the DLL.</P>

<P>Note that the header file AFXDLLX.H contains special definitions for structures used in extension DLLs, such as the definition for <B>AFX_EXTENSION_MODULE</B> and <B>CDynLinkLibrary</B>. You should include this header file in your extension DLL.</P>

<P class=indent><B><B>Note</B></B>&nbsp;&nbsp;&nbsp;It is important that you neither define nor undefine any of the _AFX_NO_XXX macros in stdafx.h. See the Knowledge Base article "PRB: Problems Occur When Defining _AFX_NO_XXX." You can find Knowledge Base articles on the MSDN Library CD, or at http://www.microsoft.com/kb/.</P>

<P>A sample initialization function that handles multithreading is included in <A HREF="JavaScript:hhobj_3.Click()">Using Thread Local Storage in a Dynamic-Link Library</A> in the Win32 SDK documentation. Note that the sample contains an entry-point function called <B>LibMain</B>, but you should name this function <B>DllMain</B> so that it works with the MFC and C run-time libraries.</P>

<P>The MFC sample <A HREF="JavaScript:hhobj_4.Click()">DLLHUSK</A> demonstrates the use of initialization functions.</P>

<H3>What do you want to do?</H3>

<UL type=disc>
	<LI><A HREF="_core_initialize_regular_dlls.htm">Initialize regular DLLs</A><BR><BR></LI>

	<LI><A HREF="_core_initialize_non.2d.mfc_dlls.htm">Initialize non-MFC DLLs</A></LI>
</UL>

<H3>What do you need to know more about?</H3>

<UL type=disc>
	<LI><A HREF="_core_run.2d.time_library_behavior.htm">The C run-time library behavior and _DllMainCRTStartup</A><BR><BR></LI>

	<LI><A HREF="_core_using_extension_dll.2c.database.2f.ole.2f.sockets_in_regular_dll.htm">Using extension DLL, Database/OLE/Sockets in regular DLL</A><BR><BR></LI>

	<LI><A HREF="JavaScript:hhobj_5.Click()">The function specification for DllMain (Win32 SDK documentation)</A><BR><BR></LI>

	<LI><A HREF="JavaScript:hhobj_6.Click()">Dynamic-link library entry-point function (Win32 SDK documentation)</A></LI>
</UL>
</font>
</BODY>
</HTML>
