<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<HTML>
<HEAD>
<META HTTP-EQUIV="Content-Type" Content="text/html; charset=Windows-1252">
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-83731338-2"></script><script>  window.dataLayer = window.dataLayer || [];  function gtag(){dataLayer.push(arguments);}  gtag('js', new Date());  gtag('config', 'UA-83731338-2');</script><title>Windows Sockets: Using Sockets with Archives</TITLE>
<style>@import url(stylesheets/msdn_ie4.css);</style>
<link disabled rel="stylesheet" href="stylesheets/msdn_ie3.css"></HEAD>
<BODY>

<TABLE ALIGN=right WIDTH=0 BORDER=0><TR><TD>
<OBJECT ID="hhobj_1" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink">
	<PARAM NAME="DefaultTopic" VALUE="_topic_not_found.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="_vc_addpf_home">
</OBJECT>
<OBJECT ID="hhobj_2" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink">
	<PARAM NAME="DefaultTopic" VALUE="_topic_not_found.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="_MFC_CSocket">
</OBJECT>
<OBJECT ID="hhobj_3" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink">
	<PARAM NAME="DefaultTopic" VALUE="_topic_not_found.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="_MFC_CAsyncSocket">
</OBJECT>
<OBJECT ID="hhobj_4" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink">
	<PARAM NAME="DefaultTopic" VALUE="_topic_not_found.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="_MFC_CArchive">
</OBJECT>
<OBJECT ID="hhobj_5" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink">
	<PARAM NAME="DefaultTopic" VALUE="_topic_not_found.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="_MFC_CSocket">
</OBJECT>
<OBJECT ID="hhobj_6" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink">
	<PARAM NAME="DefaultTopic" VALUE="_topic_not_found.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="_mfc_CAsyncSocket.3a3a.Create">
</OBJECT>
<OBJECT ID="hhobj_7" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink">
	<PARAM NAME="DefaultTopic" VALUE="_topic_not_found.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="_mfc_CAsyncSocket.3a3a.Connect">
</OBJECT>
<OBJECT ID="hhobj_8" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink">
	<PARAM NAME="DefaultTopic" VALUE="_topic_not_found.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="_mfc_CAsyncSocket.3a3a.Listen">
</OBJECT>
<OBJECT ID="hhobj_9" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink">
	<PARAM NAME="DefaultTopic" VALUE="_topic_not_found.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="_mfc_CAsyncSocket.3a3a.Accept">
</OBJECT>
<OBJECT ID="hhobj_10" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink">
	<PARAM NAME="DefaultTopic" VALUE="_topic_not_found.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="_MFC_CSocketFile">
</OBJECT>
<OBJECT ID="hhobj_11" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink">
	<PARAM NAME="DefaultTopic" VALUE="_topic_not_found.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="_MFC_CArchive">
</OBJECT>
<OBJECT ID="hhobj_12" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink">
	<PARAM NAME="DefaultTopic" VALUE="_topic_not_found.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="_sample_mfc_CHATSRVR">
</OBJECT>
<OBJECT ID="hhobj_13" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink">
	<PARAM NAME="DefaultTopic" VALUE="_topic_not_found.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="MFC Samples">
</OBJECT>
<OBJECT ID="hhobj_14" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink">
	<PARAM NAME="DefaultTopic" VALUE="_topic_not_found.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="_mfc_CSocket.3a3a.Create">
</OBJECT>
</TD></TR></TABLE>


<font face="verdana,arial,helvetica" size="2">
<H1><A NAME="_core_windows_sockets.3a_.using_sockets_with_archives"></A>Windows Sockets: Using Sockets with Archives</H1>

<P><A HREF="JavaScript:hhobj_1.Click()">Home</A>  |&nbsp; <A HREF="_core_windows_sockets_for_network_programming.3a_.overview.htm">Overview</A>  |&nbsp; <A HREF="_core_windows_sockets_tasks.htm">How Do I</A>  |&nbsp; <A HREF="_core_windows_sockets_sample_list.htm">Sample</A></P>

<P>This article describes <A HREF="#_core_the_csocket_programming_model">the CSocket programming model</A>. Class <A HREF="JavaScript:hhobj_2.Click()">CSocket</A> supplies socket support at a higher level of abstraction than does class <A HREF="JavaScript:hhobj_3.Click()">CAsyncSocket</A>. <B>CSocket</B> uses a version of the MFC serialization protocol to pass data to and from a socket object via an MFC <A HREF="JavaScript:hhobj_4.Click()">CArchive</A> object. <B>CSocket</B> provides blocking (while managing background processing of Windows messages) and gives you access to <B>CArchive</B>, which manages many aspects of the communication that you would have to do yourself using either the raw API or class <B>CAsyncSocket</B>.</P>

<P class=indent><B><B>Tip</B></B>&nbsp;&nbsp;&nbsp;You can use class <B>CSocket</B> by itself, as a more convenient version of <B>CAsyncSocket</B>, but the simplest programming model is to use <B>CSocket</B> with a <B>CArchive</B> object.</P>

<P>For additional information about how the implementation of sockets with archives works, see the article <A HREF="_core_windows_sockets.3a_.how_sockets_with_archives_work.htm">Windows Sockets: How Sockets with Archives Work</A>. For example code, see the articles <A HREF="_core_windows_sockets.3a_.sequence_of_operations.htm">Windows Sockets: Sequence of Operations</A> and <A HREF="_core_windows_sockets.3a_.example_of_sockets_using_archives.htm">Windows Sockets: Example of Sockets Using Archives</A>. For information about some of the functionality you can gain by deriving your own classes from the sockets classes, see the article <A HREF="_core_windows_sockets.3a_.deriving_from_socket_classes.htm">Windows Sockets: Deriving from Socket Classes</A>. </P>

<P class=indent><B><B>Caution</B></B>&nbsp;&nbsp;&nbsp;If you are writing an MFC client program to communicate with established (non-MFC) servers, don’t send C++ objects via the archive. Unless the server is an MFC application that understands the kinds of objects you want to send, it won’t be able to receive and deserialize your objects. For related material on the subject of communicating with non-MFC applications, also see the article <A HREF="_core_windows_sockets.3a_.byte_ordering.htm">Windows Sockets: Byte Ordering</A>. </P>



<H2><A NAME="_core_the_csocket_programming_model"></A>The CSocket Programming Model</H2>

<P>Using a <B>CSocket</B> object involves creating and associating together several MFC class objects. In the general procedure below, each step is taken by both the server socket and the client socket, except for step 3, in which each socket type requires a different action.</P>

<P class=indent><B><B>Tip</B></B>&nbsp;&nbsp;&nbsp;At run time, the server application usually starts first in order to be ready and “listening” when the client application seeks a connection. If the server is not ready when the client tries to connect, you typically require the user application to try connecting again later.</P>

<P class=label><B>To set up communication between a server socket and a client socket</B>

<OL>
	<LI>Construct a <A HREF="JavaScript:hhobj_5.Click()">CSocket</A> object.<BR><BR></LI>

	<LI>Use the object to create the underlying <B>SOCKET</B> handle.
<P class=tl>For a <B>CSocket</B> client object, you should normally use the default parameters to <A HREF="JavaScript:hhobj_6.Click()">Create</A>, unless you need a datagram socket. For a <B>CSocket</B> server object, you must specify a port in the <B>Create</B> call.</P>
<P class=atl><B><B>Note</B></B>&nbsp;&nbsp;&nbsp;<B>CArchive</B> doesn’t work with datagram sockets. If you want to use <B>CSocket</B> for a datagram socket, you must use the class as you would <B>CAsyncSocket</B> — without an archive. Because datagrams are unreliable (not guaranteed to arrive and may be repeated or out of sequence), they aren’t compatible with serialization via an archive. You expect a serialization operation to complete reliably and in sequence. If you try to use <B>CSocket</B> with a <B>CArchive</B> object for a datagram, an MFC assertion fails.</p></LI>

	<LI>If the socket is a client, call <A HREF="JavaScript:hhobj_7.Click()">CAsyncSocket::Connect</A> to connect the socket object to a server socket.
<P class=tl>-or-</P>
<P class=tl>If the socket is a server, call <A HREF="JavaScript:hhobj_8.Click()">CAsyncSocket::Listen</A> to begin listening for connect attempts from a client. Upon receiving a connection request, accept it by calling <A HREF="JavaScript:hhobj_9.Click()">CAsyncSocket::Accept</A>.</P>
<P class=atl><B><B>Note</B></B>&nbsp;&nbsp;&nbsp;The <B>Accept</B> member function takes a reference to a new, empty <B>CSocket</B> object as its parameter. You must construct this object before you call <B>Accept</B>. Keep in mind that if this socket object goes out of scope, the connection closes. Do not call <B>Create</B> for this new socket object.</p></LI>

	<LI>Create a <A HREF="JavaScript:hhobj_10.Click()">CSocketFile</A> object, associating the <B>CSocket</B> object with it.<BR><BR></LI>

	<LI>Create a <A HREF="JavaScript:hhobj_11.Click()">CArchive</A> object for either loading (receiving) or storing (sending) data. The archive is associated with the <B>CSocketFile</B> object.
<P class=tl>Keep in mind that <B>CArchive</B> doesn’t work with datagram sockets.</P></LI>

	<LI>Use the <B>CArchive</B> object to pass data between the client and server sockets.
<P class=tl>Keep in mind that a given <B>CArchive</B> object moves data in one direction only: either for loading (receiving) or storing (sending). In some cases, you’ll use two <B>CArchive</B> objects, one for sending data, the other for receiving acknowledgments.</P>
<P class=tl>After accepting a connection and setting up the archive, you can perform such tasks as validating passwords.</P></LI>

	<LI>Destroy the archive, socket file, and socket objects.</LI>
</OL>

<P class=indent><B><B>Note</B></B>&nbsp;&nbsp;&nbsp;Class <B>CArchive</B> supplies the <B>IsBufferEmpty</B> member function specifically for use with class <B>CSocket</B>. If the buffer contains multiple data messages, for example, you need to loop until all of them are read and the buffer is cleared. Otherwise, your next notification that there is data to be received may be indefinitely delayed. Use <B>IsBufferEmpty</B> to assure that you retrieve all data. For examples of using <B>IsBufferEmpty</B>, see the <A HREF="JavaScript:hhobj_12.Click()">CHATSRVR</A> sample application. For source code and information about MFC samples, see <A HREF="JavaScript:hhobj_13.Click()">MFC Samples</A>.</P>

<P>The article <A HREF="_core_windows_sockets.3a_.sequence_of_operations.htm">Windows Sockets: Sequence of Operations</A> illustrates both sides of this process with example code.</P>

<H3>What do you want to know more about?</H3>

<UL type=disc>
	<LI><A HREF="_core_windows_sockets.3a_.stream_sockets.htm">Windows Sockets: Stream Sockets</A><BR><BR></LI>

	<LI><A HREF="_core_windows_sockets.3a_.datagram_sockets.htm">Windows Sockets: Datagram Sockets</A></LI>
</UL>

<P><B>See Also</B>&nbsp;&nbsp;&nbsp;<A HREF="JavaScript:hhobj_14.Click()">CSocket::Create</A></P>
</font>
</BODY>
</HTML>
