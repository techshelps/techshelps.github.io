<HTML><HEAD><script async src="https://www.googletagmanager.com/gtag/js?id=UA-83731338-2"></script><script>  window.dataLayer = window.dataLayer || [];  function gtag(){dataLayer.push(arguments);}  gtag('js', new Date());  gtag('config', 'UA-83731338-2');</script><title>Appendix 2:CIFS Specification</TITLE><META HTTP-EQUIV="CONTENT-TYPE" CONTENT="text/html; charset= iso-8859-1"><style>@import url(msdn_ie4.css);</style>
<link disabled rel="stylesheet" href="msdn_ie3.css"><style>@import url(msdn_ie4.css);</style>
<link disabled rel="stylesheet" href="msdn_ie3.css"></HEAD>	<BODY bgcolor="#FFFFFF" link=#003399 vlink=#996699>


	<FONT FACE="Verdana, Arial, Helvetica" SIZE="2">

	<!--TOOLBAR_START-->
	<!--TOOLBAR_EXEMPT-->
	<!--TOOLBAR_END-->

<H2>Appendix 2: CIFS Specification</H2><p>CIFS (Common Internet File System) defines a standard remote file system access protocol for use over the Internet, enabling groups of users to work together and share documents across the Internet or within their corporate intranets. CIFS is an open, cross-platform technology based on the native file-sharing protocols built into the Microsoft Windows and other popular PC operating systems, and supported on dozens of other platforms, including UNIX. Dfs is covered as part of the CIFS specification, a full copy of which can be obtained from the following URL: http://www.microsoft.com/intdev/cifs/cifs.htm#spec.</P>
<P>Dfs details from CIFS</P>
<P>Distributed File System (Dfs) Support</P>
<p>Protocol dialects of NT LM 0.12 and later support distributed file system operations. The Distributed File System gives a way for this protocol to use a single consistent file naming scheme which may span a collection of different servers and shares. The distributed file system model employed is a referral-based model. This protocol specifies the manner in which clients receive referrals.</P>
<p>The client can set a flag in the request SMB header indicating that the client wants the server to resolve this SMB's paths within the Dfs known to the server. The server attempts to resolve the requested name to a file contained within the local directory tree indicated by the TID of the request and proceeds normally. If the request path name resolves to a file on a different system, the server returns the following error:</P>
<P CLASS="spacing"><BR></P>
<pre><FONT FACE="Courier New" SIZE="3">STATUS_DFS_PATH_NOT_COVERED</font></pre>
<p>The server does not support the part of the Dfs namespace needed to resolved the pathname in the request. The client should request a referral from this server for further information.</P>
<p>A client asks for a referral with the TRANS2_DFS_GET_REFERRAL request containing the Dfs pathname of interest. The response from the server indicates how the client should proceed. The method by which the topological knowledge of the Dfs is stored and maintained by the servers is not specified by this protocol.</P>
<P>Dfs Path Names</P>
<p>A Dfs pathname adheres to the standard described in the FileNames section. A Dfs-enabled client accessing a Dfs share should set the <I>Flags2</I> bit 12 in all name-based SMB Headers indicating to the server that the enclosed pathname should be resolved in the Distributed File System namespace. The path name should always have the full file name, including the server name and share name. If the server can resolve the Dfs name to a piece of local storage, the local storage will be accessed. If the server determines that the Dfs name actually maps to a different server share, the access to the name will fail with the distinguished error:</P>
<P CLASS="spacing"><BR></P>
<pre><FONT FACE="Courier New" SIZE="3">STATUS_PATH_NOT_COVERED (SMB Status code 0xC0000257)</font></pre>
<p>On receiving this error, the Dfs enabled client should ask the server for a <I>referral</I> (see TRANS2_GET_DFS_REFERRAL). The referral request should contain the full file name. </P>
<p>The response to the request will contain a list of server and share names to try, and the part of the request file name that junctions to the list of server shares. If the ServerType field of the referral is set to 1 (SMB server), then the client should resubmit the request with the <I>original</I> file name to one of the server shares in the list, once again setting the Flags2 bit 12 bit in the SMB. If the ServerType field is not 1, then the client should strip off the part of the file name that junctions to the server share before resubmitting the request to one of servers in the list.</P>
<p>A response to a referral request may elicit a response that does not have the StorageServers bit set. In that case, the client should resubmit the <I>referral request</I> to one of the servers in the list, until it finally obtains a referral response that has the StorageServers bit set, at which point the client can resubmit the request SMB to one of the listed server shares.</P>
<p>If, after getting a referral with the StorageServers bit set and resubmitting the request to one of the server shares in the list, the server fails the request with STATUS_PATH_NOT_COVERED, then there is an inconsistency between the view of the Dfs namespace held by the server granting the referral and the server listed in that referral. In this case, the client may inform the server granting the referral of this inconsistency via the <I>TRANS2_REPORT_DFS_INCONSISTENCY</I> SMB.</P>
<P>TRANS2_GET_DFS_REFERRAL:<BR>Retrieve Distributed Filesystem Referral</P>
<p>The client sends this request to ask the server to convert <I>RequestFilename</I> into an alternate name for this file. This request can be sent to the server if the server response to the NEGOTIATE SMB included the CAP_DFS capability. The TID of the request must be IPC$. <I>Bit15</I> of <I>Flags2</I> in the SMB header must be set, indicating this is a UNICODE request.</P>
<p></P>

<TABLE COLS="2" BORDER="1" CELLPADDING="7"><COLGROUP><COL WIDTH="134pt" VALIGN="TOP"><COL WIDTH="202pt" VALIGN="TOP"></COLGROUP><TBODY><TR><TD VALIGN="TOP">
<FONT FACE="Verdana, Arial" SIZE=2><P>
Client Request</P></TD>

<TD VALIGN="TOP"><FONT FACE="Verdana, Arial, Helvetica" SIZE="2"><P>Description</P></TD>

</TR><TR><TD VALIGN="TOP">
<FONT FACE="Verdana, Arial" SIZE=2><P>
WordCount</P></TD>

<TD VALIGN="TOP"><FONT FACE="Verdana, Arial, Helvetica" SIZE="2"><P>15</P></TD>

</TR><TR><TD VALIGN="TOP">
<FONT FACE="Verdana, Arial" SIZE=2><P>
TotalDataCount</P></TD>

<TD VALIGN="TOP"><FONT FACE="Verdana, Arial, Helvetica" SIZE="2"><P>0</P></TD>

</TR><TR><TD VALIGN="TOP">
<FONT FACE="Verdana, Arial" SIZE=2><P>
SetupCount</P></TD>

<TD VALIGN="TOP"><FONT FACE="Verdana, Arial, Helvetica" SIZE="2"><P>1</P></TD>

</TR><TR><TD VALIGN="TOP">
<FONT FACE="Verdana, Arial" SIZE=2><P>
Setup[0]</P></TD>

<TD VALIGN="TOP"><FONT FACE="Verdana, Arial, Helvetica" SIZE="2"><P>TRANS2_GET_DFS_REFERRAL</P></TD>

</TR><TR><TD VALIGN="TOP">
<FONT FACE="Verdana, Arial" SIZE=2><P>
Parameter Block Encoding</P></TD>

<TD VALIGN="TOP"><FONT FACE="Verdana, Arial, Helvetica" SIZE="2"><P>Description</P></TD>

</TR><TR><TD VALIGN="TOP">
<FONT FACE="Verdana, Arial" SIZE=2><P>
USHORT MaxReferralLevel</P></TD>

<TD VALIGN="TOP"><FONT FACE="Verdana, Arial, Helvetica" SIZE="2"><P>Latest referral version number understood</P></TD>

</TR><TR><TD VALIGN="TOP">
<FONT FACE="Verdana, Arial" SIZE=2><P>
WCHAR RequestFileName;</P></TD>

<TD VALIGN="TOP"><FONT FACE="Verdana, Arial, Helvetica" SIZE="2"><P>DFS name of file for which referral is sought</P></TD>

</TR></TBODY></TABLE>
<P CLASS="spacing"><BR></P><p></P>

<TABLE COLS="2" BORDER="1" CELLPADDING="7"><COLGROUP><COL WIDTH="133pt" VALIGN="TOP"><COL WIDTH="203pt" VALIGN="TOP"></COLGROUP><TBODY><TR><TD VALIGN="TOP">
<FONT FACE="Verdana, Arial" SIZE=2><P>
Response Data Block</P></TD>

<TD VALIGN="TOP"><FONT FACE="Verdana, Arial, Helvetica" SIZE="2"><P>Description</P></TD>

</TR><TR><TD VALIGN="TOP">
<FONT FACE="Verdana, Arial" SIZE=2><P>
USHORT PathConsumed;</P></TD>

<TD VALIGN="TOP"><FONT FACE="Verdana, Arial, Helvetica" SIZE="2"><P>Number of RequestFilename bytes client</P></TD>

</TR><TR><TD VALIGN="TOP">
<FONT FACE="Verdana, Arial" SIZE=2><P>
USHORT NumberOfReferrals;</P></TD>

<TD VALIGN="TOP"><FONT FACE="Verdana, Arial, Helvetica" SIZE="2"><P>Number of referrals contained in this response</P></TD>

</TR><TR><TD VALIGN="TOP">
<FONT FACE="Verdana, Arial" SIZE=2><P>
USHORT Flags;</P></TD>

<TD VALIGN="TOP"><FONT FACE="Verdana, Arial, Helvetica" SIZE="2"><P>bit0 - The servers in Referrals are capable of fielding TRANS2_GET_DFS_REFERRAL.</P>
<P>bit1 - The servers in Referrals should hold the storage for the requested file.</P></TD>

</TR><TR><TD VALIGN="TOP">
<FONT FACE="Verdana, Arial" SIZE=2><P>
REFERRAL_LIST Referrals[]</P></TD>

<TD VALIGN="TOP"><FONT FACE="Verdana, Arial, Helvetica" SIZE="2"><P>Set of referrals for this file</P></TD>

</TR><TR><TD VALIGN="TOP">
<FONT FACE="Verdana, Arial" SIZE=2><P>
UNICODESTRINGE Strings </P></TD>

<TD VALIGN="TOP"><FONT FACE="Verdana, Arial, Helvetica" SIZE="2"><P>Used to hold the strings pointed to by Version 2 Referrals in Referrals. </P></TD>

</TR></TBODY></TABLE>
<P CLASS="spacing"><BR></P><p></P>
<p>The server response is a list of <I>Referrals</I> which inform the client where it should resubmit the request to obtain access to the file.  <I>PathConsumed</I> in the response indicates to the client how many characters of <I>RequestFilename</I> have been consumed by the server. When the client chooses one of the referrals to use for file access, the client may need to strip the leading <I>PathConsumed</I> characters from the front of <I>RequestFileName</I> before submitting the name to the target server. Whether or not the pathname should be trimmed is indicated by the individual referral as detailed below. </P>
<p><I>Flags</I> indicates how this referral should be treated. If <I>bit0</I> is clear, any entity in the <I>Referrals</I> list holds the storage for <I>RequestFileName</I>. If <I>bit0</I> is set, any entity in the <I>Referrals</I> list has further referral information for <I>RequestFilename</I> – a TRANS2_GET_DFS_REFERRAL request should be sent to an entity in the <I>Referrals</I> list for further resolution.</P>
<p>The format of an individual referral contains version and length information allowing the client to skip referrals it does not understand. MaxReferralLevel indicates to the server the latest version of referral which the client can digest. Since each referral has a uniform element, <I>MaxReferralLevel</I> is advisory only. Each element in <I>Referrals</I> has this envelope:</P>

<TABLE COLS="3" BORDER="1" CELLPADDING="7"><COLGROUP><COL WIDTH="133pt" VALIGN="TOP"><COL WIDTH="11pt" VALIGN="TOP"><COL WIDTH="147pt" VALIGN="TOP"></COLGROUP><TBODY><TR><TD VALIGN="TOP">
<FONT FACE="Verdana, Arial" SIZE=2><P>
REFERRAL_LIST element</P></TD>

<TD COLSPAN="2" VALIGN="TOP"><P></P></TD>

</TR><TR><TD COLSPAN="2" VALIGN="TOP"><P>USHORT VersionNumber</P></TD>

<TD COLSPAN="2" VALIGN="TOP"><P>Version of this referral element</P></TD>

</TR><TR><TD COLSPAN="2" VALIGN="TOP"><P>USHORT ReferralSize</P></TD>

<TD COLSPAN="2" VALIGN="TOP"><P>Size of this referral element</P></TD>

</TR></TBODY></TABLE>
<P CLASS="spacing"><BR></P><p></P>
<p>The following referral element versions are defined:</P>
<p></P>

<TABLE COLS="3" BORDER="1" CELLPADDING="7"><COLGROUP><COL WIDTH="117pt" VALIGN="TOP"><COL WIDTH="49pt" VALIGN="TOP"><COL WIDTH="153pt" VALIGN="TOP"></COLGROUP><TBODY><TR><TD COLSPAN="2" VALIGN="TOP"><P>Version 1 Referral Element Format</P></TD>

<TD COLSPAN="2" VALIGN="TOP"><P></P></TD>

</TR><TR><TD VALIGN="TOP">
<FONT FACE="Verdana, Arial" SIZE=2><P>
USHORT ServerType</P></TD>

<TD COLSPAN="2" VALIGN="TOP"><P>Type of Node handling referral:</P>
<P>Don't know</P>
<P>SMB Server</P>
<P>Netware Server</P>
<P>Domain</P></TD>

</TR><TR><TD VALIGN="TOP">
<FONT FACE="Verdana, Arial" SIZE=2><P>
USHORT ReferralFlags</P></TD>

<TD COLSPAN="2" VALIGN="TOP"><P>Flags which describe this referral:</P>
<P>01 - Strip off PathConsumed characters before submitting RequestFileName to Node</P></TD>

</TR><TR><TD VALIGN="TOP">
<FONT FACE="Verdana, Arial" SIZE=2><P>
UNICODESTRING Node</P></TD>

<TD COLSPAN="2" VALIGN="TOP"><P>Name of entity to visit next </P></TD>

</TR></TBODY></TABLE>
<P CLASS="spacing"><BR></P><p></P>

<TABLE COLS="4" BORDER="1" CELLPADDING="7"><COLGROUP><COL WIDTH="136pt" VALIGN="TOP"><COL WIDTH="55pt" VALIGN="TOP"><COL WIDTH="144pt" VALIGN="TOP"><COL WIDTH="0pt" VALIGN="TOP"></COLGROUP><TBODY><TR><TD COLSPAN="2" VALIGN="TOP"><P>Version 2 Referral Element Format</P></TD>

<TD COLSPAN="2" VALIGN="TOP"><P></P></TD>

</TR><TR><TD VALIGN="TOP">
<FONT FACE="Verdana, Arial" SIZE=2><P>
USHORT ServerType</P></TD>

<TD COLSPAN="3" VALIGN="TOP"><P>Type of Node handling referral:</P>
<P>Don't know</P>
<P>SMB Server</P>
<P>Netware Server</P>
<P>Domain</P></TD>

</TR><TR><TD VALIGN="TOP">
<FONT FACE="Verdana, Arial" SIZE=2><P>
USHORT ReferralFlags</P></TD>

<TD COLSPAN="3" VALIGN="TOP"><P>Flags which describe this referral:</P>
<P>01 - Strip off PathConsumed characters before submitting RequestFileName to Node</P></TD>

</TR><TR><TD VALIGN="TOP">
<FONT FACE="Verdana, Arial" SIZE=2><P>
ULONG Proximity</P></TD>

<TD COLSPAN="3" VALIGN="TOP"><P>A hint describing the proximity of this server to the client. 0 indicates the closest, higher numbers indicate increasingly "distant" servers. The number is only relevant within the context of the servers listed in this particular SMB.</P></TD>

</TR><TR><TD VALIGN="TOP">
<FONT FACE="Verdana, Arial" SIZE=2><P>
ULONG TimeToLive</P></TD>

<TD COLSPAN="3" VALIGN="TOP"><P>Number of seconds for which the client can cache this referral.</P></TD>

</TR><TR><TD VALIGN="TOP">
<FONT FACE="Verdana, Arial" SIZE=2><P>
USHORT DfsPathOffset</P></TD>

<TD COLSPAN="3" VALIGN="TOP"><P>Offset, in bytes from the beginning of this referral, of the Dfs Path that matched PathConsumed bytes of the RequestFileName.</P></TD>

</TR><TR><TD VALIGN="TOP">
<FONT FACE="Verdana, Arial" SIZE=2><P>
USHORT DfsAlternatePathOffset</P></TD>

<TD COLSPAN="3" VALIGN="TOP"><P>Offset, in bytes from the beginning of this referral, of an alternate name (8.3 format) of the Dfs Path that matched PathConsumed bytes of the RequestFileName.</P></TD>

</TR><TR><TD VALIGN="TOP">
<FONT FACE="Verdana, Arial" SIZE=2><P>
USHORT NetworkAddressOffset</P></TD>

<TD COLSPAN="3" VALIGN="TOP"><P>Offset, in bytes from the beginning of this referral, of the entity to visit next.</P></TD>

</TR></TBODY></TABLE>
<P CLASS="spacing"><BR></P><p></P>
<p>The SMB protocol imposes no referral selection policy.</P>
<P>TRANS2_REPORT_DFS_INCONSISTENCY:<BR>Inform a Server About Dfs Error</P>
<p>As part of the Distributed Name Resolution algorithm, a Dfs client may discover a knowledge inconsistency between the referral server (i.e., the server that handed out a referral), and the storage server (i.e., the server to which the client was redirected to by the referral server). When such an inconsistency is discovered, the Dfs client optionally sends this SMB to the referral server, allowing the referral server to take corrective action.</P>
<p></P>

<TABLE COLS="2" BORDER="1" CELLPADDING="7"><COLGROUP><COL WIDTH="134pt" VALIGN="TOP"><COL WIDTH="202pt" VALIGN="TOP"></COLGROUP><TBODY><TR><TD VALIGN="TOP">
<FONT FACE="Verdana, Arial" SIZE=2><P>
Client Request</P></TD>

<TD VALIGN="TOP"><FONT FACE="Verdana, Arial, Helvetica" SIZE="2"><P>Description</P></TD>

</TR><TR><TD VALIGN="TOP">
<FONT FACE="Verdana, Arial" SIZE=2><P>
WordCount</P></TD>

<TD VALIGN="TOP"><FONT FACE="Verdana, Arial, Helvetica" SIZE="2"><P>15</P></TD>

</TR><TR><TD VALIGN="TOP">
<FONT FACE="Verdana, Arial" SIZE=2><P>
MaxParameterCount</P></TD>

<TD VALIGN="TOP"><FONT FACE="Verdana, Arial, Helvetica" SIZE="2"><P>0</P></TD>

</TR><TR><TD VALIGN="TOP">
<FONT FACE="Verdana, Arial" SIZE=2><P>
SetupCount</P></TD>

<TD VALIGN="TOP"><FONT FACE="Verdana, Arial, Helvetica" SIZE="2"><P>1</P></TD>

</TR><TR><TD VALIGN="TOP">
<FONT FACE="Verdana, Arial" SIZE=2><P>
Setup[0]</P></TD>

<TD VALIGN="TOP"><FONT FACE="Verdana, Arial, Helvetica" SIZE="2"><P>TRANS2_REPORT_DFS_INCONSISTENCY</P></TD>

</TR><TR><TD VALIGN="TOP">
<FONT FACE="Verdana, Arial" SIZE=2><P>
Parameter Block Encoding</P></TD>

<TD VALIGN="TOP"><FONT FACE="Verdana, Arial, Helvetica" SIZE="2"><P>Description</P></TD>

</TR><TR><TD VALIGN="TOP">
<FONT FACE="Verdana, Arial" SIZE=2><P>
UNICODESTRING RequestFileName;</P></TD>

<TD VALIGN="TOP"><FONT FACE="Verdana, Arial, Helvetica" SIZE="2"><P>DFS Name of file for which referral was sought</P></TD>

</TR></TBODY></TABLE>
<P CLASS="spacing"><BR></P><p></P>
<p>The data part of this request contains the referral element (Version 1 format only) believed to be in error. These are encoded as described in the TRANS2_GET_DFS_REFERRAL response. If the server returns success, the client can resubmit the TRANS2_GET_DFS_REFERRAL request to this server to get a new referral. It is not mandatory for the Dfs knowledge to be automatically repaired; the client must be prepared to receive further errant referrals and must not wind up looping between this request and the TRANS2_GET_DFS_REFERRAL request.</P>
<p><I>Bit15</I> of <I>Flags2</I> in the SMB header must be set, indicating this is a UNICODE request.</P></BODY></HTML>
