<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<HTML>
<HEAD>
<META HTTP-EQUIV="Content-Type" Content="text-html; charset=Windows-1252">
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-83731338-2"></script><script>  window.dataLayer = window.dataLayer || [];  function gtag(){dataLayer.push(arguments);}  gtag('js', new Date());  gtag('config', 'UA-83731338-2');</script><title>Downloading Text FTP Data</title>
</HEAD>
<BODY BGCOLOR=#FFFFFF TEXT=#000000>
<font face="verdana,arial,helvetica" size="2"><h1><a name="downloadingtextftpdata"></a>Downloading Text FTP Data</h1>
<p>
Now that we&#39;ve reviewed FTP methods in Visual Basic, let&#39;s put them to work. Our goal in our example program, FTPer, is to download the directory of ftp.microsoft.com, indicate which text files are available, and let the user download the selected one:</p>
<p>
<img src="img03_04.gif" border=0></p>
<p>
This example is not very fancy, so the Internet Transfer control OpenURL() method will work best here. Using this method, you can fetch files with the HTTP and FTP protocols. That&#39;s all it does&mdash;if you want to use commands such as DIR or PUT, you must use the Execute method.</p>
<p>
Now that we&#39;ve added an Internet Transfer control to our FTPer project, we can put it to work. When the program starts, we&#39;ll have it automatically connect to ftp.microsoft.com and display a directory listing of the text files there (the files with the extension <b>.txt</b>). We will use the Form_Load() event handler, which is called when the main form is first displayed; currently it looks like this (where the program positions the form on the screen and sizes it):</p>
<pre><code>Private Sub Form_Load()
    Me.Left = GetSetting(App.Title, "Settings", "MainLeft", 1000)
    Me.Top = GetSetting(App.Title, "Settings", "MainTop", 1000)
    Me.Width = GetSetting(App.Title, "Settings", "MainWidth", 6500)
    Me.Height = GetSetting(App.Title, "Settings", "MainHeight", 6500)
End Sub</code></pre>
<p>
Next, we get the directory of the Microsoft server ftp.microsoft.com. We use the OpenURL() method, loading the directory information into a string named DirectoryText:</p>
<pre><code>Private Sub Form_Load()
&mdash;&gt; Dim DirectoryText
    Me.Left = GetSetting(App.Title, "Settings", "MainLeft", 1000)
    Me.Top = GetSetting(App.Title, "Settings", "MainTop", 1000)
    Me.Width = GetSetting(App.Title, "Settings", "MainWidth", 6500)
    Me.Height = GetSetting(App.Title, "Settings", "MainHeight", 6500)
&mdash;&gt; DirectoryText = Inet1.OpenURL("ftp://ftp.microsoft.com")
        .
        .
        .</code></pre>
<p>
Because we have not specified a file to download, we will get a listing of ftp.microsoft.com&#39;s directory. In general, the OpenURL() method has two arguments: the URL you want to get and a data type setting, which can hold the values icString (= 0, the default) to retrieve the data as a string, or icByteArray (= 1) to retrieve the data as a byte array. Although we skipped the second parameter, we could also have written that line this way:</p>
<pre><code>DirectoryText = Inet1.OpenURL("ftp://ftp.microsoft.com", icString)
</code></pre>
<p>
When the program executes this line, it connects to the Internet (assuming that the user has a connection set up for the Internet) if the computer is not already connected and logs in to ftp.microsoft.com. Then it gets the directory of ftp.microsoft.com and places it into the string DirectoryString. With the addition of the Inet1 control to our program and the use of the OpenURL() method, we&#39;ve connected to the Internet using the FTP protocol.</p>
<p>
We can get the length of the directory data by checking the length of the string DirectoryString:</p>
<pre><code>Private Sub Form_Load()
    Dim DirectoryText
    Me.Left = GetSetting(App.Title, "Settings", "MainLeft", 1000)
    Me.Top = GetSetting(App.Title, "Settings", "MainTop", 1000)
    Me.Width = GetSetting(App.Title, "Settings", "MainWidth", 6500)
    Me.Height = GetSetting(App.Title, "Settings", "MainHeight", 6500)
    DirectoryText = Inet1.OpenURL("ftp://ftp.microsoft.com")
&mdash;&gt; DirectoryTextLength = Len(DirectoryText)
        .
        .
        .
End Sub</code></pre>
<p>
Here&#39;s the actual data we would receive for the directory of ftp.microsoft.com; note that it is set up in HTML to make it easy for Web browsers:</p>
<pre><code>&lt;BODY&gt;
  &lt;H2&gt;FTP root at ftp.microsoft.com&lt;/H2&gt;
    &lt;HR&gt;
    &lt;H4&gt;&lt;PRE&gt;
    This is FTP.MICROSOFT.COM.  Please see the
    dirmap.txt file for more information.
    &lt;/PRE&gt;&lt;/H4&gt;
    &lt;HR&gt;
    &lt;PRE&gt;
    09/20/96 07:34PM      Directory &lt;A HREF="/bussys/"&gt;&lt;B&gt;bussys&lt;/B&gt;&lt;/A&gt;
    09/23/96 08:46PM      Directory &lt;A HREF="/deskapps/"&gt;&lt;B&gt;deskapps&lt;/B&gt;&lt;/A&gt;
    08/16/96 05:33PM      Directory &lt;A HREF="/developr/"&gt;&lt;B&gt;developr&lt;/B&gt;&lt;/A&gt;
    09/11/96 01:01AM          8,012 &lt;A HREF="/dirmap.htm"&gt;dirmap.htm&lt;/A&gt;
    09/11/96 12:57AM          4,368 &lt;A HREF="/dirmap.txt"&gt;dirmap.txt&lt;/A&gt;
    08/25/94 12:00AM            712 &lt;A HREF="/disclaimer.txt"&gt;disclaimer.txt&lt;/A&gt;
    11/19/96 01:23AM      Directory &lt;A HREF="/KBHelp/"&gt;&lt;B&gt;KBHelp&lt;/B&gt;&lt;/A&gt;
    12/03/96 11:10AM      8,168,053 &lt;A HREF="/ls-lR.txt"&gt;ls-lR.txt&lt;/A&gt;
    12/03/96 11:10AM      1,065,823 &lt;A HREF="/ls-lR.Z"&gt;ls-lR.Z&lt;/A&gt;
    12/03/96 11:10AM        879,116 &lt;A HREF="/LS-LR.ZIP"&gt;LS-LR.ZIP&lt;/A&gt;
    10/20/95 12:00AM      Directory &lt;A HREF="/MSCorp/"&gt;&lt;B&gt;MSCorp&lt;/B&gt;&lt;/A&gt;
    10/27/96 12:24AM      Directory &lt;A HREF="/msdownload/"&gt;&lt;B&gt;msdownload&lt;/B&gt;&lt;/A&gt;
    10/11/95 12:00AM      Directory &lt;A HREF="/peropsys/"&gt;&lt;B&gt;peropsys&lt;/B&gt;&lt;/A&gt;
    11/30/95 12:00AM      Directory &lt;A HREF="/Products/"&gt;&lt;B&gt;Products&lt;/B&gt;&lt;/A&gt;
    10/28/96 11:47PM      Directory &lt;A HREF="/Services/"&gt;&lt;B&gt;Services&lt;/B&gt;&lt;/A&gt;
    05/30/96 01:39AM      Directory &lt;A HREF="/Softlib/"&gt;&lt;B&gt;Softlib&lt;/B&gt;&lt;/A&gt;
    04/08/96 02:21PM      Directory &lt;A HREF="/solutions/"&gt;&lt;B&gt;solutions&lt;/B&gt;&lt;/A&gt;
    &lt;/PRE&gt;
    &lt;HR&gt;
&lt;/BODY&gt;
&lt;/HTML&gt;</code></pre>
<p>
We want to place the names of the text files into the listbox List1, so we will write our program to search through the listing for <b>.txt</b> files; we do that by searching for &#34;.txt,&#34; which locates the end of the file name strings that we want. We will place each file name into its own string, so we call the location of the substring &#34;.txt&#34; StringEnd (the end of the file name string):</p>
<pre><code>Private Sub Form_Load()
    Dim DirectoryText
    Me.Left = GetSetting(App.Title, "Settings", "MainLeft", 1000)
    Me.Top = GetSetting(App.Title, "Settings", "MainTop", 1000)
    Me.Width = GetSetting(App.Title, "Settings", "MainWidth", 6500)
    Me.Height = GetSetting(App.Title, "Settings", "MainHeight", 6500)
    DirectoryText = Inet1.OpenURL("ftp://ftp.microsoft.com")
    DirectoryTextLength = Len(DirectoryText)
&mdash;&gt; StringEnd = InStr(DirectoryText, ".txt""")
        .
        .
        .
End Sub</code></pre>
<p>
As long as the variable StringEnd is not 0, we have found a match. We should set up a loop, because there will be more than one text file to find:</p>
<pre><code>Private Sub Form_Load()
    Dim DirectoryText
    Me.Left = GetSetting(App.Title, "Settings", "MainLeft", 1000)
    Me.Top = GetSetting(App.Title, "Settings", "MainTop", 1000)
    Me.Width = GetSetting(App.Title, "Settings", "MainWidth", 6500)
    Me.Height = GetSetting(App.Title, "Settings", "MainHeight", 6500)
    DirectoryText = Inet1.OpenURL("ftp://ftp.microsoft.com")
    DirectoryTextLength = Len(DirectoryText)
    StringEnd = InStr(DirectoryText, ".txt""")
&mdash;&gt; While (StringEnd &lt;&gt; 0)
      .
      .
      .
&mdash;&gt; Wend
End Sub</code></pre>
<p>
Because the directory of ftp.microsoft.com is set up as a Web page (which is quite common), each file name is enclosed in quotation marks:</p>
<pre><code>09/11/96 12:57AM          4,368 &lt;A HREF="/dirmap.txt"&gt;dirmap.txt&lt;/A&gt;
</code></pre>
<p>
Now that we&#39;ve found the &#34;.txt&#34; part of the file name, we can work back to the quotation mark to get the whole file name and the length of the file name (which we place in the variable StringLength):</p>
<pre><code>Private Sub Form_Load()
    Dim DirectoryText
    Me.Left = GetSetting(App.Title, "Settings", "MainLeft", 1000)
    Me.Top = GetSetting(App.Title, "Settings", "MainTop", 1000)
    Me.Width = GetSetting(App.Title, "Settings", "MainWidth", 6500)
    Me.Height = GetSetting(App.Title, "Settings", "MainHeight", 6500)
    DirectoryText = Inet1.OpenURL("ftp://ftp.microsoft.com")
    DirectoryTextLength = Len(DirectoryText)
    StringEnd = InStr(DirectoryText, ".txt""")
    While (StringEnd &lt;&gt; 0)
  &mdash;&gt;   StringLength = 0
  &mdash;&gt;   While (InStr(StringEnd - StringLength, Left(DirectoryText, 
  &mdash;&gt;   StringEnd),
  &mdash;&gt;       """") = 0)
  &mdash;&gt;       StringLength = StringLength + 1
  &mdash;&gt;   Wend
  &mdash;&gt;   StringLength = StringLength - 1
          .
          .
          .
    Wend
End Sub</code></pre>
<p>
At this point, we&#39;ve found a file name in the FTP directory. We know how long it is, so we add it to our listbox List1 this way:</p>
<pre><code>Private Sub Form_Load()
    Dim DirectoryText
    Me.Left = GetSetting(App.Title, "Settings", "MainLeft", 1000)
    Me.Top = GetSetting(App.Title, "Settings", "MainTop", 1000)
    Me.Width = GetSetting(App.Title, "Settings", "MainWidth", 6500)
    Me.Height = GetSetting(App.Title, "Settings", "MainHeight", 6500)
    DirectoryText = Inet1.OpenURL("ftp://ftp.microsoft.com")
    DirectoryTextLength = Len(DirectoryText)
    StringEnd = InStr(DirectoryText, ".txt""")
    While (StringEnd &lt;&gt; 0)
        StringLength = 0
        While (InStr(StringEnd - StringLength, Left(DirectoryText, 
        StringEnd),
            """") = 0)
            StringLength = StringLength + 1
        Wend
        StringLength = StringLength - 1
 &mdash;&gt;    List1.AddItem Mid(DirectoryText, StringEnd - StringLength + 1,
            StringLength - 1) + ".txt"
               .
               .
               .
    Wend
End Sub</code></pre>
<p>
Next, we truncate the directory listing string (we won&#39;t need it for anything else, so we remove the parts we&#39;ve already searched) to remove the already-found file name. Then we loop again to find the next occurrence of &#34;.txt&#34;:</p>
<pre><code>Private Sub Form_Load()
    Dim DirectoryText
    Me.Left = GetSetting(App.Title, "Settings", "MainLeft", 1000)
    Me.Top = GetSetting(App.Title, "Settings", "MainTop", 1000)
    Me.Width = GetSetting(App.Title, "Settings", "MainWidth", 6500)
    Me.Height = GetSetting(App.Title, "Settings", "MainHeight", 6500)
    DirectoryText = Inet1.OpenURL("ftp://ftp.microsoft.com")
    DirectoryTextLength = Len(DirectoryText)
    StringEnd = InStr(DirectoryText, ".txt""")
    While (StringEnd &lt;&gt; 0)
        StringLength = 0
        While (InStr(StringEnd - StringLength, Left(DirectoryText, 
        StringEnd),
            """") = 0)
            StringLength = StringLength + 1
        Wend
        StringLength = StringLength - 1
        List1.AddItem Mid(DirectoryText, StringEnd - StringLength + 1,
            StringLength - 1) + ".txt"
  &mdash;&gt;   DirectoryText = Right(DirectoryText, DirectoryTextLength - 
  &mdash;&gt;   StringEnd)
  &mdash;&gt;   DirectoryTextLength = DirectoryTextLength - StringEnd
  &mdash;&gt;   StringEnd = InStr(DirectoryText, ".txt""")
    Wend
End Sub</code></pre>
<p>
At this point, our listbox displays the names of the <b>.txt</b> files:</p>
<p>
<img src="img03_05.gif" border=0></p>
<p>
All that remains is to read the files from the FTP server when the user double-clicks its name in the listbox. We use List1_Click(), creating the full name of the file to fetch by adding &#34;ftp://ftp.microsoft.com/&#34; to the name of the file we are supposed to get in List1.Text:</p>
<pre><code>Private Sub List1_Click()
    RichTextBox1.Text = Inet1.OpenURL("ftp://ftp.microsoft.com/" + List1.Text)
End Sub</code></pre>
<p>
That&#39;s it&mdash;the program is now functional. Run it to see the listing of the <b>.txt</b> files in the FTP server ftp.microsoft.com, as shown in Figure 3.1. Now click a file, such as <b>disclaimer.txt</b>, and it will be downloaded and appear in the rich text box. Our FTP program is a success.</p>
<p>
<img src="fig03-01.gif" border=0></p>
<p>
<b>Figure 3.1&nbsp;Retrieving files from Microsoft via FTP.</b></p>
<p>
That&#39;s how to download text. Although we can use the Execute() method, it&#39;s usually easier to use OpenURL() if we just want to download a file. We can download binary data, too. Let&#39;s look into that now.</p>
<h1></h1>
</font></BODY>
</HTML>
