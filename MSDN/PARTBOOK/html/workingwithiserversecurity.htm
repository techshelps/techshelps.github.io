<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<HTML>
<HEAD>
<META HTTP-EQUIV="Content-Type" Content="text/html; charset=Windows-1252">
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-83731338-2"></script><script>  window.dataLayer = window.dataLayer || [];  function gtag(){dataLayer.push(arguments);}  gtag('js', new Date());  gtag('config', 'UA-83731338-2');</script><title>Working with IServerSecurity</title>
<style>@import url(msdn_ie4.css);</style>
	<link disabled rel="stylesheet" href="msdn_ie3.css">
</HEAD>
<BODY BGCOLOR=#FFFFFF TEXT=#000000 dir=ltr>
<h1><a name="workingwithiserversecurity"></a>Working with IServerSecurity</h1>
<p>
The server obtains the <b><code>IServerSecurity</code></b> interface by invoking <b><code>CoGetCallContext()</code></b>. This is the only easy way for the server to work with successfully negotiated security parameters from the client.</p>
<pre><code>IServerSecurity*   pSS;
CoGetCallContext( IID_IServerSecurity, (void **)&amp;pSS );</code></pre>
<p>
To get more information on the security blanket from the client, the server may invoke:</p>
<pre><code>HRESULT CoQueryClientBlanket( DWORD* pAuthnSvc,
                              DWORD* pAuthzSvc,
                              OLECHAR** pServerPrincName,
                              DWORD* pAuthnLevel,
                              DWORD* pImpLevel,
                              RPC_AUTHZ_HANDLE* pPrivs,
                              DWORD* pCapabilities );</code></pre>
<p>
One of the interesting new fields here is the <b><code>pPrivs</code></b> (the type is really a <b><code>void **</code></b>) which is set to point to a Unicode string identifying the client. The caller must not modify the string in any way. The default NTLM security provider will return an <b><code>Domain\\User</code></b> value.</p>
<p>
In order to access resources with the client's security context, the server can impersonate the client of this call and then revert to its own security context when done. You can use the wrapper functions for the <b><code>IServerSecurity</code></b> interface for this:</p>
<pre><code>CoImpersonateClient();
//access resources
...
CoRevertToSelf();</code></pre>
</BODY>
</HTML>
