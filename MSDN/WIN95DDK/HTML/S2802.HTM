<HTML><HEAD><script async src="https://www.googletagmanager.com/gtag/js?id=UA-83731338-2"></script><script>  window.dataLayer = window.dataLayer || [];  function gtag(){dataLayer.push(arguments);}  gtag('js', new Date());  gtag('config', 'UA-83731338-2');</script><title>Color Support</TITLE><META HTTP-EQUIV="CONTENT-TYPE" CONTENT="text/html; charset= iso-8859-1"><style>@import url(/msdn_ie4.css);</style>
<link disabled rel="stylesheet" href="/msdn_ie3.css"></HEAD><BODY BGCOLOR="#FFFFFF">
<FONT FACE="verdana,arial,helvetica" SIZE="2">
<H3>Color Support </H3><P>The DIB engine supports drawing on 256-color palettized devices. The color data for these devices is specified in a <B>BITMAPINFO</B> structure. The header section of this structure defines the dimensions and color format of the device's DIB. The array of <B>RGBQUAD</B> structures which follows the header corresponds to the device's palette. The members of the <B>BITMAPINFO </B>structure are initialized by a minidriver or display driver when the <B>Enable</B> function is called. </P>
<P>Drivers do not need to initialize their color table. At boot time, GDI calls <B>SetPalette</B> to initialize the device's color table. The display driver should first forward the call to the DIB engine which will store the colors into the color table. After the DIB engine call returns, the driver should set the contents of the color table into the hardware DAC. </P>
<P>To ensure that colors used in background drawing operations match the current system palette, GDI maintains a palette-translation table. When GDI calls a minidriver's <B>SetPaletteTranslate</B> function for a palettized device, you should call the DIB engine's <B>DIB_SetPaletteTranslateExt</B> function to create an inverse translation table that GDI can use for mapping logical color indices to physical color indices. When GDI calls a minidriver's <B>GetPaletteTranslate</B> function for a palettized device, you should call the <B>DIB_GetPaletteTranslateExt</B> function to retrieve a copy of the current translation table. When GDI calls the <B>UpdateColors</B> function, you should call the DIB_UpdateColorsExt function to update the colors in a given window using the colors in the translation table. </P>
<P>When a non-identity palette translation is set, the DIB engine function <B>DIB_SetPaletteTranslateExt</B> sets the PALETTE_XLAT bit in the <B>deFlags</B> field of the <B>DIBENGINE</B> structure. This function clears the PALETTE_XLAT bit when an identity translate is set. Minidrivers and the DIB engine may use this bit to decide whether palette translation is needed or not. When applicable, this bit is set or cleared for palette translation for bitmaps, brushes, pens, foreground color, background color and text color. </P>
<P>If all palette calls from GDI are routed to the DIB engine, all that is needed to check for palette translation in a function call such as <B>BitBlt</B> is to test the PALETTE_XLAT bit in the <B>deFlags</B> of the <B>PDEVICE</B> parameter. For functions that take one <B>PDEVICE</B> and the PALETTE_XLAT bit is set, the call should be routed to the DIB Engine. For functions that take two <B>PDEVICE</B> structures, the minidriver should check the PALETTE_XLAT bit in both <B>PDEVICE</B> structures. If the bit is set in one, but not both, the call must be routed to the DIB engine. If the bit is set in both <B>PDEVICE</B> structures and the ROP code is SRCCOPY, the operation is a screen-to-screen draw and the minidriver should handle it; no palette translation needs to be done. Otherwise, the call should be routed to the DIB engine because it may need to translate the colors in a brush. </P>
<P>See also <B>DIB_SetPaletteExt</B>, <B>DIB_GetPaletteExt</B>, <B>DIB_SetPaletteTranslateExt</B>, <B>DIB_GetPaletteTranslateExt</B>, <B>DIB_UpdateColorsExt</B> </P></FONT></BODY></HTML>
