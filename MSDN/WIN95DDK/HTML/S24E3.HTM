<HTML><HEAD><script async src="https://www.googletagmanager.com/gtag/js?id=UA-83731338-2"></script><script>  window.dataLayer = window.dataLayer || [];  function gtag(){dataLayer.push(arguments);}  gtag('js', new Date());  gtag('config', 'UA-83731338-2');</script><title>Processing Before Sys_Critical_Init Message</TITLE><META HTTP-EQUIV="CONTENT-TYPE" CONTENT="text/html; charset= iso-8859-1"><style>@import url(/msdn_ie4.css);</style>
<link disabled rel="stylesheet" href="/msdn_ie3.css"></HEAD><BODY BGCOLOR="#FFFFFF">
<FONT FACE="verdana,arial,helvetica" SIZE="2">
<H3>Processing Before Sys_Critical_Init Message </H3><P>The devnode tree is constructed after entering protected mode, and after VXDLDR.VXD's early Device_Init. (VXDLDR is very early in the load order.) The root enumerator (which is part of Configuration Manager) creates device nodes for every device it can enumerate. Any static VxD that was loaded for a given device node is then sent a system control call with the following parameters: </P>
<P><BR></P>
<PRE>EAX = PNP_NEW_DEVNODE
 EBX = DEVNODE
 EDX = LOAD_DLVXD_DEVLOADER
</PRE>
<P>At this point, most VxDs return CR_DEVLOADER_NOT_READY. When a static VxD reaches the device initialization stage, it should call the <B>CONFIGMG_Register_DevLoader</B> function. The system will make another PNP_NEW_DEVNODE system control call, at which point the VxD can load the device driver or enumerator. (Often, the device driver and enumerator are in the same binary file, as in the case of ISAPNP.386.) A typical driver must call <B>CONFIGMG_Register_Device_Driver</B>, and an enumerator must additionally call <B>CONFIGMG_Register_Enumerator</B>. Some VxDs will also register arbitrators at this point, using the <B>CONFIGMG_Register_Arbitrator</B> function. Arbitrators should be loaded at SYS_CRITICAL_INIT if they are global. </P>
<P>Configuration Manager will then call any enumerator that has been registered to further enumerate devices. All devices that were enumerated in real mode will have been allocated a complete device node by the end of this process, and any VxD that was loaded for a particular device will have been notified through the new Plug and Play system control call. </P>
<P>Once all device nodes have been created, Configuration Manager will assign resources to each device and call the driver entry point to inform it of its new configuration. </P>
<H4><A NAME="sec0"></A>Example </H4><P>Plug and Play processing early in the system's entry to protected mode might follow a series of steps like this: </P>
<UL><LI>     Configuration Manager initializes, creates root device node. </LI><LI>     Enumerates children, creates device node for PnP BIOS. </LI><LI>     Notifies BIOSENUM VxD that its device node exists. </LI><LI>     DirectedSysCtrl("BIOSENUM", PNP_NEW_DEVNODE, STATIC_DRIVER, DevNodeHandle) </LI><LI>     BIOSENUM registers as enumerator. </LI><LI>     Configuration Manager calls BIOSENUM to enumerate. It creates device nodes and the process continues. </LI></UL><P></P></FONT></BODY></HTML>
