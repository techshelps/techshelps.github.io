<HTML><HEAD><script async src="https://www.googletagmanager.com/gtag/js?id=UA-83731338-2"></script><script>  window.dataLayer = window.dataLayer || [];  function gtag(){dataLayer.push(arguments);}  gtag('js', new Date());  gtag('config', 'UA-83731338-2');</script><title>Defining Services</TITLE><META HTTP-EQUIV="CONTENT-TYPE" CONTENT="text/html; charset= iso-8859-1"><style>@import url(/msdn_ie4.css);</style>
<link disabled rel="stylesheet" href="/msdn_ie3.css"></HEAD><BODY BGCOLOR="#FFFFFF">
<FONT FACE="verdana,arial,helvetica" SIZE="2">
<H3>Defining Services </H3><P>A virtual device defines its services by using the <B>BeginProc</B> and <B>EndProc</B> macros and the <B>Service</B> or <B>Async_Service</B> options. The macros mark the start and end of the procedure code for the service. The options identify the procedure as a service. The following example shows the definition for the service <B>VSAMPLED_Get_Version</B>: </P>
<P><BR></P>
<PRE>BeginProc VSAMPLED_Get_Version, Service
    mov   ax, 030Ah
    clc
    ret
EndProc VSAMPLED_Get_Version
</PRE>
<P>The <B>Async_Service</B> option is for services that can be called asynchronously, that is, during processing of an interrupt. Asynchronous services must be re-entrant and must <I>not</I> call VMM or virtual device services that are not also asynchronous. </P>
<P>The VMM and standard virtual devices use two calling conventions for their services: register-based and 32-bit C-language based. These calling conventions specify the spelling for the service name, the method for passing parameters and returning values, and the registers to preserve. </P>
<P>For register-based services, the service name should not begin with an underscore (_). All the parameters are passed in registers, and results are returned in registers. Typically, the service preserves all registers it does not explicitly use to return values in. </P>
<P>For C-language-based services, the service name must begin with an underscore (_). All parameters are passed as 32-bit values on the stack. Results (if any) are returned in the EAX register (for 32-bit values), or the EAX and EDX registers (for 64-bit values). The service preserves the EBX, ES, FS, and GS registers as well as the ESI and EDI registers. Only the flags and the EAX, ECX, and EDX registers are modified. </P></FONT></BODY></HTML>
