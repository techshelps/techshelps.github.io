<HTML><HEAD><script async src="https://www.googletagmanager.com/gtag/js?id=UA-83731338-2"></script><script>  window.dataLayer = window.dataLayer || [];  function gtag(){dataLayer.push(arguments);}  gtag('js', new Date());  gtag('config', 'UA-83731338-2');</script><title>VDMAD_Lock_DMA_Region</TITLE><META HTTP-EQUIV="CONTENT-TYPE" CONTENT="text/html; charset= iso-8859-1"><style>@import url(/msdn_ie4.css);</style>
<link disabled rel="stylesheet" href="/msdn_ie3.css"></HEAD><BODY BGCOLOR="#FFFFFF">
<FONT FACE="verdana,arial,helvetica" SIZE="2">
<H3>VDMAD_Lock_DMA_Region </H3><P><BR></P>
<PRE>include vdmad.inc

mov esi, OFFSET32 DMA_Region
mov ecx, RegionSize
mov dl, Alignment
VxDcall VDMAD_Lock_DMA_Region
jc ErrorHandler
</PRE>
<P>Attempts to lock a region of memory for a DMA transfer. Uses EAX, ECX, EDX, and flags </P>
<UL><LI>     Clears the carry flag and copies the DMA address into EDX if the function succeeds. Otherwise, sets the carry flag and copies the number of bytes that can be locked into ECX (starting from ESI); the AL registers contains one of the following error values: </LI></UL>
<TABLE COLS="2" BORDER="0" CELLPADDING="7"><COLGROUP><COL WIDTH="144pt" VALIGN="TOP"><COL WIDTH="190pt" VALIGN="TOP"></COLGROUP><TBODY><TR><TD VALIGN="TOP"><P>1 </P></TD><TD VALIGN="TOP"><P>DMA_Not_Contiguous: Region not contiguous. </P></TD></TR><TR><TD VALIGN="TOP"><P>2 </P></TD><TD VALIGN="TOP"><P>DMA_Not_Aligned: Region crossed physical alignment boundary. </P></TD></TR><TR><TD VALIGN="TOP"><P>3 </P></TD><TD VALIGN="TOP"><P>DMA_Lock_Failed: Unable to lock pages. </P></TD></TR></TBODY></TABLE>
<P><BR></P><P></P>
<P></P>
<P><I>DMA_Region</I> </P>
<P>Address of the DMA region. </P>
<P><I>RegionSize</I> </P>
<P>Number of bytes in the DMA region. </P>
<P><I>Alignment</I> </P>
<P>Region alignment. This parameter can be one of the following values: </P>

<TABLE COLS="2" BORDER="0" CELLPADDING="7"><COLGROUP><COL WIDTH="144pt" VALIGN="TOP"><COL WIDTH="190pt" VALIGN="TOP"></COLGROUP><TBODY><TR><TD VALIGN="TOP"><P>1 </P></TD><TD VALIGN="TOP"><P>Region must be aligned on 64K page boundary. </P></TD></TR><TR><TD VALIGN="TOP"><P>2 </P></TD><TD VALIGN="TOP"><P>Region must be aligned on 128K page boundary. </P></TD></TR></TBODY></TABLE>
<P><BR></P><P></P>
<P>The service first verifies that the region is mapped to contiguous pages of physical memory, then it determines whether the region results in a DMA bank (page) wrap. </P>
<P>Typically, each channel has a base address register and a page address register. The base address register is incremented after each byte or word is transferred. If the increment of this 16-bit register results in the roll over from 0FFFFh to 0, then the transfer wraps to the start of the DMA bank because the page register is not updated. Normally MS-DOS watches for this condition and adjusts Interrupt 13h parameters to split transfers to avoid this wrap, but MS-DOS does not account for the difference between linear and physical addresses with Windows, so VDMAD checks again to prevent wrap from occurring. </P>
<P>If these checks pass, the service calls the memory manager to lock the physical pages. </P>
<P>This service does not check to see if the region is within some physical maximum constraint. If the region can be locked, then it locks the memory, and it is up to the caller to check to see if the physical region is acceptable. If the region is not acceptable, then the caller should unlock the region and perform a buffered DMA transfer. </P>
<P>This service must be called before a DMA transfer is started, that is, before the physical state is set for a channel and before it is unmasked. </P>
<P></P>
<P></P></FONT></BODY></HTML>
