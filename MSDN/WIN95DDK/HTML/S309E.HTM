<HTML><HEAD><script async src="https://www.googletagmanager.com/gtag/js?id=UA-83731338-2"></script><script>  window.dataLayer = window.dataLayer || [];  function gtag(){dataLayer.push(arguments);}  gtag('js', new Date());  gtag('config', 'UA-83731338-2');</script><title>FS_CloseFile</TITLE><META HTTP-EQUIV="CONTENT-TYPE" CONTENT="text/html; charset= iso-8859-1"><style>@import url(/msdn_ie4.css);</style>
<link disabled rel="stylesheet" href="/msdn_ie3.css"></HEAD><BODY BGCOLOR="#FFFFFF">
<FONT FACE="verdana,arial,helvetica" SIZE="2">
<H3>FS_CloseFile </H3><P><BR></P>
<PRE>FS_CloseFile(
 PIOREQ pir
 )
</PRE>
<P>A currently open file is closed through <B>FS_CloseFile</B>. This routine handles the Win32 function: CloseHandle(); and INT 21h functions: 10h, and 3Eh. </P>
<P>This routine must clean up record locks belonging to the process for the file being closed. </P>
<P><I>ir_rh</I> </P>
<P>Supplies handle to disk volume or network resource which contains the file. </P>
<P><I>ir_fh</I> </P>
<P>Supplies FSD file handle. </P>
<P><I>ir_sfn</I> </P>
<P>Supplies system file number. </P>
<P><I>ir_options</I> </P>
<P>Supplies processing options. </P>

<TABLE COLS="2" BORDER="0" CELLPADDING="7"><COLGROUP><COL WIDTH="144pt" VALIGN="TOP"><COL WIDTH="190pt" VALIGN="TOP"></COLGROUP><TBODY><TR><TD VALIGN="TOP"><P><B>Proccessing Option Values:</B> </P>
<P>The following options may be specified: </P></TD><TD VALIGN="TOP"><P></P></TD></TR><TR><TD VALIGN="TOP"><P><B>Value </B></P></TD><TD VALIGN="TOP"><P><B>Meaning </B></P></TD></TR><TR><TD VALIGN="TOP"><P><B>FILE_NO_LAST_ACCESS_DATE</B> </P></TD><TD VALIGN="TOP"><P>Do not update last access date on the close operation even if it is currently enabled for the volume. This flag is a special flag that is passed in when a volume is locked down not allowing writes, so that there are no write operations done to the disk in all cases. </P></TD></TR><TR><TD VALIGN="TOP"><P><B>FILE_CLOSE_FOR_LEVEL3_LOCK</B> </P></TD><TD VALIGN="TOP"><P>This is a special flag informing the FSD that this close operation is being done on a level 3 lock request by user. The FSD needs to do some special processing for files that have file record locks on them when a level 3 lock is taken. For more details, refer to the volume locking specification. </P></TD></TR><TR><TD VALIGN="TOP"><P><B>FILE_CLOSE_NO_IO</B> </P></TD><TD VALIGN="TOP"><P>This flag informs the FSD that no i/o operation should be done during this close operation. This is usually because the resource the file was opened on is no longer available. FSDs should just clean up their internal data structures and return when this flag is set. </P></TD></TR></TBODY></TABLE>
<P><BR></P><P></P>
<P><I>ir_flags</I> </P>
<P>Supplies close flags. </P>

<TABLE COLS="2" BORDER="0" CELLPADDING="7"><COLGROUP><COL WIDTH="144pt" VALIGN="TOP"><COL WIDTH="190pt" VALIGN="TOP"></COLGROUP><TBODY><TR><TD VALIGN="TOP"><P><B>Close Flag Values:</B> </P>
<P>One of the following flags will be specified. </P></TD><TD VALIGN="TOP"><P></P></TD></TR><TR><TD VALIGN="TOP"><P><B>Value </B></P></TD><TD VALIGN="TOP"><P><B>Meaning </B></P></TD></TR><TR><TD VALIGN="TOP"><P><B>CLOSE_HANDLE</B> </P></TD><TD VALIGN="TOP"><P>Ordinary close, flush buffers. </P></TD></TR><TR><TD VALIGN="TOP"><P><B>CLOSE_FOR_PROCESS</B> </P></TD><TD VALIGN="TOP"><P>Last close for process, flush buffers and free locks the process owns. </P></TD></TR><TR><TD VALIGN="TOP"><P><B>CLOSE_FINAL</B> </P></TD><TD VALIGN="TOP"><P>Final close of file, last process that had the file open. The FSD should free any FSD allocated memory associated with this file, flush buffers and free locks. </P></TD></TR></TBODY></TABLE>
<P><BR></P><P></P>
<P><I>ir_user</I> </P>
<P>Supplies user id for this request. </P>
<P><I>ir_pid</I> </P>
<P>Supplies process id for this request. </P>

<TABLE COLS="2" BORDER="0" CELLPADDING="7"><COLGROUP><COL WIDTH="144pt" VALIGN="TOP"><COL WIDTH="190pt" VALIGN="TOP"></COLGROUP><TBODY><TR><TD VALIGN="TOP"><P>     <I>ir_error</I> </P></TD><TD VALIGN="TOP"><P>Returns status of the operation ( 0 if no error, errorcode otherwise ). </P></TD></TR><TR><TD VALIGN="TOP"><P><I>ir_pos</I> </P></TD><TD VALIGN="TOP"><P>Returns a pointer to the list of file record locks for this open file. This pointer should be returned only if the FILE_CLOSE_FOR_LEVEL3_LOCK flag is passed in. This list is then passed in to the FSD on a subsequent open call to FS_OpenFile. A NULL value should be returned if there are no active file record locks on this file. Volume locking is described in detail in the volume locking specification. </P></TD></TR></TBODY></TABLE>
<P><BR></P><P></P>
<P></P>
<P>When the level 3 lock is taken, the IFS manager issues a CLOSE_FINAL on all open handles for the corresponding volume. It also passes in the FILE_CLOSE_FOR_LEVEL3_LOCK flag in ir_options to indicate this to the FSD. In this case, the FSD should not free the record locks on the file as it would normally. Instead, it should just return a pointer to the list of active record locks for the file. This pointer is then passed in on the FS_OpenFile call when the IFS manager reopens the file for access. </P>
<P></P>
<P></P></FONT></BODY></HTML>
