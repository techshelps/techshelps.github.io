<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<HTML dir=ltr>
<HEAD>
<META HTTP-EQUIV="Content-Type" Content="text/html; charset=Windows-1252">
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-83731338-2"></script><script>  window.dataLayer = window.dataLayer || [];  function gtag(){dataLayer.push(arguments);}  gtag('js', new Date());  gtag('config', 'UA-83731338-2');</script><title>TN042: ODBC Driver Developer Recommendations</title>
<style>@import url(msdn_ie4.css);</style>
<link disabled rel="stylesheet" href="msdn_ie3.css"></HEAD>
<BODY>
<font face="verdana,arial,helvetica" size="2">
<h1><a name="_mfcnotes_tn042"></a><sup></sup>TN042: ODBC Driver Developer Recommendations</h1>
<p>
This note describes guidelines for ODBC driver writers. It outlines general requirements and assumptions of ODBC functionality which the MFC Database classes make, and various expected semantic details. Required driver functionality to support the three <b>CRecordset</b> Open modes (<b>forwardOnly</b>, <b>snapshot</b> and <b>dynaset</b>) are described.</p>
<p class=label>
<b>ODBC's Cursor Library</b></p>
<p>
The MFC Database classes present functionality to the user which in many cases surpasses the functionality provided by most level 1 ODBC drivers. Fortunately, ODBC's Cursor Library will layer itself between the database classes and the driver, and will automatically provide much of this additional functionality.</p>
<p>
For instance, most 1.0 drivers do not support backward scrolling. The Cursor Library can detect this, and will cache rows from the driver and present them as requested on FETCH_PREV calls in <b>SQLExtendedFetch</b>.</p>
<p>
Another important example of cursor library dependence is positioned updates. Most 1.0 drivers also do not have positioned updates, but the cursor library will generate update statements which identify a target row on the data source based upon its current cached data values, or a cached timestamp value.</p>
<p>
The class library never makes use of multiple rowsets. Therefore, the few <b>SQLSetPos</b> statements are always applied to row 1 of the rowset.</p>
<p class=label>
<b>CDatabases</b></p>
<p>
Each <b>CDatabase</b> allocates a single <b>HDBC</b>. (If <b>CDatabase</b>'s <b>ExecuteSQL</b> function is used, an <b>HSTMT</b> is temporarily allocated.) So if multiple <b>CDatabase</b>'s are required, multiple <b>HDBC</b>s per <b>HENV</b> must be supported.</p>
<p>
The database classes require the cursor library. This is reflected in a <b>SQLSetConnections</b> call <b>SQL_ODBC_CURSORS</b>, <b>SQL_CUR_USE_ODBC</b>.</p>
<p>
<b>SQLDriverConnect</b>, <b>SQL_DRIVER_COMPLETE</b> is used by <b>CDatabase::Open</b> to establish the connection to the data source.</p>
<p>
The driver must support <b>SQLGetInfo</b> <b>SQL_ODBC_API_CONFORMANCE</b> &gt;= <b>SQL_OAC_LEVEL1</b>, <b>SQLGetInfo</b> <b>SQL_ODBC_SQL_CONFORMANCE</b> &gt;= <b>SQL_OSC_MINIMUM</b>.</p>
<p>
In order for transactions to be supported for the <b>CDatabase</b> and its dependent recordsets, <b>SQLGetInfo</b> <b>SQL_CURSOR_COMMIT_BEHAVIOR</b> and <b>SQL_CURSOR_ROLLBACK_BEHAVIOR</b> must have <b>SQL_CR_PRESERVE</b>. Otherwise, attempts to perform transaction control will be ignored.</p>
<p>
<b>SQLGetInfo</b> <b>SQL_DATA_SOURCE_READ_ONLY</b> must be supported. If it returns "Y", no update operations will be performed on the data source.</p>
<p>
If the <b>CDatabase</b> is opened ReadOnly an attempt to set the data source readonly will be made with <b>SQLSetConnectOption</b> <b>SQL_ACCESS_MODE</b>, <b>SQL_MODE_READ_ONLY</b>.</p>
<p>
If identifiers require quoting, this information should be returned from the driver with an <b>SQLGetInfo</b> <b>SQL_IDENTIFIER_QUOTE_CHAR</b> call.</p>
<p>
For debugging purposes, <b>SQLGetInfo SQL_DBMS_VER</b> and <b>SQL_DBMS_NAME</b> are retrieved from the driver.</p>
<p>
<b>SQLSetStmtOption</b> <b>SQL_QUERY_TIMEOUT</b> and <b>SQL_ASYNC_ENABLE</b> may be called on a <b>CDatabase</b>'s <b>HDBC</b>.</p>
<p>
<b>SQLError</b> may be called with any or all arguments NULL.</p>
<p>
Of course, <b>SQLAllocEnv</b>, <b>SQLAllocConnect</b>, <b>SQLDisconnect</b> and <b>SQLFreeConnect</b> must be supported.</p>
<p class=label>
<b>ExecuteSQL</b></p>
<p>
In additional to allocating and freeing a temporary <b>HSTMT</b>, <b>ExecuteSQL</b> calls <b>SQLExecDirect</b>, <b>SQLFetch</b>, <b>SQLNumResultCol</b> and <b>SQLMoreResults</b>. <b>SQLCancel</b> may be called on the <b>HSTMT</b>.</p>
<p class=label>
<b>GetDatabaseName</b></p>
<p>
<b>SQLGetInfo</b> <b>SQL_DATABASE_NAME</b> will be called.</p>
<p class=label>
<b>BeginTrans, CommitTrans, Rollback</b></p>
<p>
<b>SQLSetConnectOption</b> <b>SQL_AUTOCOMMIT</b> and <b>SQLTransact</b> <b>SQL_COMMIT</b>, <b>SQL_ROLLBACK</b> and <b>SQL_AUTOCOMMIT</b> will be called if transaction requests are made.</p>
<p class=label>
<b>CRecordsets</b></p>
<p>
<b>SQLAllocStmt</b>, <b>SQLPrepare</b>, <b>SQLExecute</b> (For <b>Open</b> and <b>Requery</b>), <b>SQLExecDirect</b> (for update operations), <b>SQLFreeStmt</b> must be supported. <b>SQLNumResultCols</b> and <b>SQLDescribeCol</b> will be called on the results set at various times.</p>
<p>
<b>SQLSetParam</b> is used extensively for binding parameter data and <b>DATA_AT_EXEC</b> functionality.</p>
<p>
<b>SQLBindCol</b> is used extensively to register output Column data storage locations with ODBC.</p>
<p>
Two <b>SQLGetData</b> calls are used to retrieve <b>SQL_LONG_VARCHAR</b> and <b>SQL_LONG_VARBINARY</b> data. The first call attempts to find the total length of the column value by calling <b>SQLGetData</b> with cbMaxValue of 0, but with a valid pcbValue. If pcbValue holds <b>SQL_NO_TOTAL</b>, an exception is thrown. Otherwise an <b>HGLOBAL</b> is allocated, and another <b>SQLGetData</b> call made to retrieve the entire result.</p>
<p class=label>
<b>Updating</b></p>
<p>
If pessimistic locking is requested, <b>SQLGetInfo</b> <b>SQL_LOCK_TYPES</b> will be queried. If <b>SQL_LCK_EXCLUSIVE</b> is not supported, an exception will be thrown.</p>
<p>
Attempts to update a <b>CRecordset</b> (<b>snapshot</b> or <b>dynaset</b>) will cause a second <b>HSTMT</b> to be allocated. For drivers that don't support second <b>HSTMT</b>, the cursor library will simulate this functionality. Unfortunately, this may sometimes mean forcing the current query on the first <b>HSTMT</b> to completion before processing the second <b>HSTMT</b>'s request.</p>
<p>
<b>SQLFreeStmt</b> <b>SQL_CLOSE</b> and <b>SQL_RESET_PARAMS</b> and <b>SQLGetCursorName</b> will be called during update operations.</p>
<p>
If there are <b>CLongBinarys</b> in the <b>outputColumns</b>, ODBC's <b>DATA_AT_EXEC</b> functionality must be supported. This includes returning <b>SQL_NEED_DATA</b> from <b>SQLExecDirect</b>, <b>SQLParamData</b> and <b>SQLPutData</b>.</p>
<p>
<b>SQLRowCount</b> is called after executing to verify that only 1 record was updated by the <b>SQLExecDirect</b>.</p>
<p class=label>
<b>ForwardOnly Cursors</b></p>
<p>
Only <b>SQLFetch</b> is required for the <b>Move</b> operations. Note that <b>forwardOnly</b> cursors do not support updates.</p>
<p class=label>
<b>Snapshot Cursors</b></p>
<p>
Snapshot functionality requires <b>SQLExtendedFetch</b> support. As noted above, the ODBC cursor library will detect when a driver does not support <b>SQLExtendedFetch</b>, and provide the necessary support itself.</p>
<p>
<b>SQLGetInfo</b>, <b>SQL_SCROLL_OPTIONS</b> must support <b>SQL_SO_STATIC</b>.</p>
<p class=label>
<b>Dynaset Cursors</b></p>
<p>
Below is the minimum support required to open a dynaset:</p>
<p>
<b>SQLGetInfo</b>, <b>SQL_ODBC_VER</b> must return &gt; "01".</p>
<p>
<b>SQLGetInfo</b>, <b>SQL_SCROLL_OPTIONS</b> must support <b>SQL_SO_KEYSET_DRIVEN</b>.</p>
<p>
<b>SQLGetInfo</b>, <b>SQL_ROW_UPDATES</b> must return "Y".</p>
<p>
<b>SQLGetInfo</b>, <b>SQL_POSITIONED_UPDATES</b> must support <b>SQL_PS_POSITIONED_DELETE</b> and <b>SQL_PS_POSITIONED_UPDATE</b>.</p>
<p>
In addition, if pessimistic locking is requested, a call to <b>SQLSetPos</b> with irow 1, fRefresh FALSE and fLock <b>SQL_LCK_EXCLUSIVE</b> will be made.</p>
<p>
<a href="_mfcnotes_technical_notes_by_number.htm">Technical Notes by Number</a>  |&nbsp; <a href="_mfcnotes_technical_notes_by_category.htm">Technical Notes by Category</a></p>
</font></BODY>
</HTML>
