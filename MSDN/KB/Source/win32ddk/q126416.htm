

<HTML>
<HEAD>
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-83731338-2"></script><script>  window.dataLayer = window.dataLayer || [];  function gtag(){dataLayer.push(arguments);}  gtag('js', new Date());  gtag('config', 'UA-83731338-2');</script><title>INFO: Cautions on Using METHOD_NEITHER IOCTL </TITLE>

<!--STYLE_BEGIN-->
<style>@import url(../../msdn_ie4.css);</style>
	<link disabled rel="stylesheet" href="../../msdn_ie3.css">
<!--STYLE_END-->

<META HTTP-EQUIV="CONTENT-Type" CONTENT="text/html; charset=us-ascii">
<META NAME="ms.locale" CONTENT="EN-US">
<META NAME="Category" CONTENT="Support; KB Article">
<META NAME="KBID" CONTENT="Q126416">
<META NAME="KBModify" CONTENT="1998/02/17">
<META NAME="KBCreate" CONTENT="1995/02/22">
<META NAME="Keywords" CONTENT="">
<META NAME="KBArea" CONTENT="Support; KB; win32ddk">
<META NAME="Description" CONTENT="  This articles discusses three caveats to keep in mind if you create custom IOCTL code for use with a driver so that the driver accesses memory allocated by an application.  MORE INFORMATION  First, in order for this operation to succeed, the driver...">
<META NAME="Product" CONTENT="Win32 DDK">
<META NAME="Platform" CONTENT="Windows">
<META NAME="Technology" CONTENT=" ">
<META NAME="Premium" CONTENT="support">

<META NAME="nyms" CONTENT="QAU9,QBW7,QA5E,QAI5,QBW6,QAGI,QBWG,QAJH,QAY5,QAYV,QACJ,QAA1,QA1S,QBWP,QA3A V02180118">
</HEAD>

<BODY BGCOLOR="#FFFFFF" LEFTMARGIN="0" RIGHTMARGIN="0" TOPMARGIN="0">


<!--DOCBODY_START-->
<BR>
<CENTER>
<TABLE BORDER="0" CELLPADDING="0" CELLSPACING="0" VALIGN="top" WIDTH="90%">
	<TR>
		<TD VALIGN="top">
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<H1>INFO: Cautions on Using METHOD_NEITHER IOCTL</H1>
			</FONT>
			<FONT FACE="verdana,arial,helvetica" SIZE="1">
			Last reviewed:  February 17, 1998</FONT><BR>
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<B>Article ID: Q126416</B>
			</FONT>
		</TD>
	</TR>
	<TR>
	<TD>
	<FONT FACE="Verdana, Arial, Helvetica" SIZE=2>



 
 
The information in this article applies to:

<UL><LI>Microsoft Win32 Device Development Kit (DDK) for Windows NT,
   versions 3.5, 3.51
</UL> 
<P>
<P><h2>SUMMARY</h2>
 
<P>
This articles discusses three caveats to keep in mind if you create custom
IOCTL code for use with a driver so that the driver accesses memory
allocated by an application.
<P>
<P><h2>MORE INFORMATION</h2>
 
<P>
First, in order for this operation to succeed, the driver may only get
access to the memory if it is a highest level driver whose
DispatchDeviceControl routine is run in the context of the thread
manufactured to request this operation. A driver's StartIo, DPC, ISR, or
APC routine cannot be guaranteed of this as these routines are run in an
arbitrary thread context.
<P>
Second, any access to this buffer must be wrapped in an appropriate
exception handler. The buffer must be probed by calling
MmProbeAndLockPages. Be careful when performing operations on this buffer.
Access could also be obtained by wrapping access to the buffer in an
appropriate exception handler, locking the pages, and then mapping the
locked pages. With this alternative method, caution must still be used when
performing operations on the buffer. Problems can occur when the
application that owns this buffer changes the access mode for the memory or
attempts to deallocate the memory while the driver attempts to read or
write to it.
<P>
Third, caution must be exercised as there is no way to synchronize access
to this memory between the driver and the application. Applications should
NEVER attempt to share memory by using a DeviceIoControl call. As well, an
application should NEVER attempt to read or write to the buffer
simultaneous with a driver.
<P>
In conclusion, while it is possible to share memory between an application
and a driver, the aforementioned precautions must be observed. Setting up
sharing of memory should be done using a DeviceIoControl (for example, by
mapping a region of memory into the applications address space), and
alternatives should be exercised if feasible.
<P>

	</FONT>
	</TD>
	</TR>
</TABLE>
<P>


<!--DOCBODY_END-->

<!--FOOTER_START-->
<table cellpadding=5 border=0 width="90%">
<tr>
<td>
	<HR WIDTH="90%">

<BLOCKQUOTE>
<FONT FACE="Verdana, Arial, Helvetica" SIZE="1">
<SPAN STYLE="font-family:verdana,arial,helvetica; font-size:8pt">
Additional query words: MEMORY MAPPING DEVICEIOCONTROL<BR>
Version           : WINNT:3.5,3.51;<BR>
Platform          : winnt<BR>
Issue type        : kbinfo<BR>

</SPAN>
</FONT>
<BR>
<BR>
THE INFORMATION PROVIDED IN THE MICROSOFT KNOWLEDGE BASE IS
PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND.  MICROSOFT DISCLAIMS
ALL WARRANTIES, EITHER EXPRESS OR IMPLIED, INCLUDING THE WARRANTIES
OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  IN NO
EVENT SHALL MICROSOFT CORPORATION OR ITS SUPPLIERS BE LIABLE FOR
ANY DAMAGES WHATSOEVER INCLUDING DIRECT, INDIRECT, INCIDENTAL,
CONSEQUENTIAL, LOSS OF BUSINESS PROFITS OR SPECIAL DAMAGES, EVEN IF
MICROSOFT CORPORATION OR ITS SUPPLIERS HAVE BEEN ADVISED OF THE
POSSIBILITY OF SUCH DAMAGES.  SOME STATES DO NOT ALLOW THE EXCLUSION
OR LIMITATION OF LIABILITY FOR CONSEQUENTIAL OR INCIDENTAL DAMAGES
SO THE FOREGOING LIMITATION MAY NOT APPLY.
</BLOCKQUOTE>
<P>
<center>
	<FONT FACE="Verdana,Arial,Helvetica" SIZE="1">
	Last reviewed:  February 17, 1998</FONT>
	<BR>
	<A HREF="../cpyright.htm" STYLE="font: bold 7pt Verdana,Arial,Helvetica">&copy; 1998 Microsoft Corporation. All rights reserved. Terms of Use.</A><BR>
	
</center>
</td>
</tr>
</table>

<!--FOOTER_END-->
</FONT>
</BODY>
</HTML>
