

<HTML>
<HEAD>
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-83731338-2"></script><script>  window.dataLayer = window.dataLayer || [];  function gtag(){dataLayer.push(arguments);}  gtag('js', new Date());  gtag('config', 'UA-83731338-2');</script><title>FIX: Memory Leak Occurs After Form is Unloaded </TITLE>

<!--STYLE_BEGIN-->
<style>@import url(../../msdn_ie4.css);</style>
	<link disabled rel="stylesheet" href="../../msdn_ie3.css">
<!--STYLE_END-->

<META HTTP-EQUIV="CONTENT-Type" CONTENT="text/html; charset=us-ascii">
<META NAME="ms.locale" CONTENT="EN-US">
<META NAME="Category" CONTENT="Support; KB Article">
<META NAME="KBID" CONTENT="Q174289">
<META NAME="KBModify" CONTENT="1997/09/26">
<META NAME="KBCreate" CONTENT="1997/09/24">
<META NAME="Keywords" CONTENT="vb432 VB4WIN vb5all VBKBObj VBKBVB">
<META NAME="KBArea" CONTENT="Support; KB; vbwin">
<META NAME="Description" CONTENT="  A memory leak occurs in a Visual Basic project that has forms that are loaded and unloaded several times.  CAUSE =====  The small icon of a form remains in memory after the form is unloaded, which results in a memory leak.  RESOLUTION  To work arou...">
<META NAME="Product" CONTENT="Visual Basic for Windows">
<META NAME="Platform" CONTENT="Windows">
<META NAME="Technology" CONTENT=" ">
<META NAME="Premium" CONTENT="support">

<META NAME="nyms" CONTENT="QBS0,QAH4,QAY5,QAR4,QAO4,QBW6,QAMA,QDL9,QBWQ,QBWO,QBWN,QA9N,QA5B,QAM1,QAEF V02180118">
</HEAD>

<BODY BGCOLOR="#FFFFFF" LEFTMARGIN="0" RIGHTMARGIN="0" TOPMARGIN="0">


<!--DOCBODY_START-->
<BR>
<CENTER>
<TABLE BORDER="0" CELLPADDING="0" CELLSPACING="0" VALIGN="top" WIDTH="90%">
	<TR>
		<TD VALIGN="top">
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<H1>FIX: Memory Leak Occurs After Form is Unloaded</H1>
			</FONT>
			<FONT FACE="verdana,arial,helvetica" SIZE="1">
			Last reviewed:  September 26, 1997</FONT><BR>
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<B>Article ID: Q174289</B>
			</FONT>
		</TD>
	</TR>
	<TR>
	<TD>
	<FONT FACE="Verdana, Arial, Helvetica" SIZE=2>



 
 
The information in this article applies to:

<UL><LI>Microsoft Visual Basic Control Creation, Learning,
   Professional, and Enterprise Editions for Windows, version 5.0
<LI>Microsoft Visual Basic Standard, Professional, and Enterprise
   Editions, 32-bit only, for Windows, version 4.0
</UL> 
<P>
<P><h2>SYMPTOMS</h2>
 
<P>
A memory leak occurs in a Visual Basic project that has forms that
are loaded and unloaded several times.
<P>
<P><h2>CAUSE</h2>
 
<P>
The small icon of a form remains in memory after the form is
unloaded, which results in a memory leak.
<P>
<P><h2>RESOLUTION</h2>
 
<P>
To work around this bug in Visual Basic 4.0, use the DestroyIcon
function during the Form_Unload event to remove the small icon
from memory. Copy the following code sample to the code window of
each form in your project:
<P>
<PRE>   Private Declare Function SendMessage Lib "user32" _
      Alias "SendMessageA" _
      (ByVal hwnd As Long, _
       ByVal wMsg As Long, _
       ByVal wParam As Long, _
       lParam As Long) As Long

   Private Declare Function DestroyIcon Lib "user32" _
      (ByVal hIcon As Long) As Long

   Private Const WM_SETICON = &amp;H80
   Private Const MiniIcon = 0
   Private Const NullIcon = 0

   Private Sub Form_Unload(Cancel As Integer)
      Dim hIcon As Long
      hIcon = SendMessage(hwnd, WM_SETICON, MiniIcon, ByVal _
      NullIcon)
      If hIcon &lt;&gt; 0 Then
         DestroyIcon hIcon
      End If
   End Sub

</PRE><h2>STATUS</h2>
 
<P>
Microsoft has confirmed this to be a bug in the Microsoft products
listed at the beginning of this article. This bug has been fixed
in Visual Basic Version 5.0.
<P>
<P><h2>MORE INFORMATION</h2>
 
<P>
Programs that load and unload forms frequently can cause a
significant leak in memory because the operating system will lose
1148 bytes every time a form is unloaded. The workaround is to
destroy the icon when the form is unloaded.
<P>
Use the SendMessage function with the WM_SETICON message to get
the handle of either the large or small icon and to then replace
it with the icon specified by the NullIcon parameter; in this case
replacing it with Null. With the MiniIcon parameter set to zero,
the message applies to the small icon.
<P>
The return value is the handle to the old icon which is removed
from memory by the DestroyIcon function.
<P>
<P><h3>Steps to Reproduce the Behavior</h3>
 

<OL><P><LI>Start a new project. Form1 is created by default.

<P><LI>Add another Form to the project.

<P><LI>Add the following code to the Click event of Form1:
<P>
<P><PRE>      Dim i as Integer
      For i = 1 To 1000
<PRE></PRE>         Form2.Show
         Form2.Hide
      Next i

</PRE><P><LI>Press the F5 key to run the project. You will notice a
   performance drop where Form2 loads more slowly as the
   iterations progress. Press the CTRL+BREAK keys to end the
   application.
</OL> 
<PRE>Keywords          : vb432 VB4WIN vb5all VBKBObj VBKBVB
Version           : WINDOWS:4.0 5.0
Platform          : WINDOWS
Issue type        : kbbug
Solution Type     : kbfix</PRE>

	</FONT>
	</TD>
	</TR>
</TABLE>
<P>


<!--DOCBODY_END-->

<!--FOOTER_START-->
<table cellpadding=5 border=0 width="90%">
<tr>
<td>
	<HR WIDTH="90%">

<BLOCKQUOTE>
<FONT FACE="Verdana, Arial, Helvetica" SIZE="1">
<SPAN STYLE="font-family:verdana,arial,helvetica; font-size:8pt">
================================================================================<BR>

</SPAN>
</FONT>
<BR>
<BR>
THE INFORMATION PROVIDED IN THE MICROSOFT KNOWLEDGE BASE IS
PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND.  MICROSOFT DISCLAIMS
ALL WARRANTIES, EITHER EXPRESS OR IMPLIED, INCLUDING THE WARRANTIES
OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  IN NO
EVENT SHALL MICROSOFT CORPORATION OR ITS SUPPLIERS BE LIABLE FOR
ANY DAMAGES WHATSOEVER INCLUDING DIRECT, INDIRECT, INCIDENTAL,
CONSEQUENTIAL, LOSS OF BUSINESS PROFITS OR SPECIAL DAMAGES, EVEN IF
MICROSOFT CORPORATION OR ITS SUPPLIERS HAVE BEEN ADVISED OF THE
POSSIBILITY OF SUCH DAMAGES.  SOME STATES DO NOT ALLOW THE EXCLUSION
OR LIMITATION OF LIABILITY FOR CONSEQUENTIAL OR INCIDENTAL DAMAGES
SO THE FOREGOING LIMITATION MAY NOT APPLY.
</BLOCKQUOTE>
<P>
<center>
	<FONT FACE="Verdana,Arial,Helvetica" SIZE="1">
	Last reviewed:  September 26, 1997</FONT>
	<BR>
	<A HREF="../cpyright.htm" STYLE="font: bold 7pt Verdana,Arial,Helvetica">&copy; 1998 Microsoft Corporation. All rights reserved. Terms of Use.</A><BR>
	
</center>
</td>
</tr>
</table>

<!--FOOTER_END-->
</FONT>
</BODY>
</HTML>
