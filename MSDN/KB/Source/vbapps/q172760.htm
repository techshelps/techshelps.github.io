

<HTML>
<HEAD>
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-83731338-2"></script><script>  window.dataLayer = window.dataLayer || [];  function gtag(){dataLayer.push(arguments);}  gtag('js', new Date());  gtag('config', 'UA-83731338-2');</script><title>XL: Function Using ActiveCell Property Returns Incorrect Result </TITLE>

<!--STYLE_BEGIN-->
<style>@import url(../../msdn_ie4.css);</style>
	<link disabled rel="stylesheet" href="../../msdn_ie3.css">
<!--STYLE_END-->

<META HTTP-EQUIV="CONTENT-Type" CONTENT="text/html; charset=us-ascii">
<META NAME="ms.locale" CONTENT="EN-US">
<META NAME="Category" CONTENT="Support; KB Article">
<META NAME="KBID" CONTENT="Q172760">
<META NAME="KBModify" CONTENT="1998/02/03">
<META NAME="KBCreate" CONTENT="1997/08/14">
<META NAME="Keywords" CONTENT="kbcode kbprg xlvbahowto xlvbainfo xlformula">
<META NAME="KBArea" CONTENT="Support; KB; vbapps">
<META NAME="Description" CONTENT="  When you enter a formula that calls a custom function, the formula may  return an incorrect result when you recalculate the worksheet. The formula returns the correct result only when you select the cell that contains the formula and then recalcula...">
<META NAME="Product" CONTENT="vbapps">
<META NAME="Platform" CONTENT="Windows">
<META NAME="Technology" CONTENT=" ">
<META NAME="Premium" CONTENT="support">

<META NAME="nyms" CONTENT="QBVP,QAUD,QAY5,QAB9,QAVX,QAVW,QBV8,QBS0,QDNZ,QAKD,QAGI,QAPN,QALW,QBJZ,QAJH P1 P2 P3 P4 P5 P6 T2 P7 V02180118">
</HEAD>

<BODY BGCOLOR="#FFFFFF" LEFTMARGIN="0" RIGHTMARGIN="0" TOPMARGIN="0">


<!--DOCBODY_START-->
<BR>
<CENTER>
<TABLE BORDER="0" CELLPADDING="0" CELLSPACING="0" VALIGN="top" WIDTH="90%">
	<TR>
		<TD VALIGN="top">
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<H1>XL: Function Using ActiveCell Property Returns Incorrect Result</H1>
			</FONT>
			<FONT FACE="verdana,arial,helvetica" SIZE="1">
			Last reviewed:  February 3, 1998</FONT><BR>
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<B>Article ID: Q172760</B>
			</FONT>
		</TD>
	</TR>
	<TR>
	<TD>
	<FONT FACE="Verdana, Arial, Helvetica" SIZE=2>



 
 
The information in this article applies to:

<UL><LI>Microsoft Excel 98 Macintosh Edition
<LI>Microsoft Excel 97 for Windows
<LI>Microsoft Excel for Windows 95, versions 7.0, 7.0a
<LI>Microsoft Excel for Windows, versions 5.0, 5.0c
<LI>Microsoft Excel for the Macintosh, versions 5.0, 5.0a
</UL> 
<P>
<P><h2>SYMPTOMS</h2>
 
<P>
When you enter a formula that calls a custom function, the formula may 
return an incorrect result when you recalculate the worksheet. The formula
returns the correct result only when you select the cell that contains the
formula and then recalculate the worksheet. When you do this, other 
formulas that call the same custom function return the same result.
<P>
<P><h2>CAUSE</h2>
 
<P>
This problem occurs when the following conditions are true:

<UL><LI>The custom function uses the ActiveCell property.
<P>
<P><PRE>    -and-
</PRE>
<LI>The custom function uses the Volatile method to force the function to
   recalculate values each time the worksheet is recalculated.
<P>
</UL>To see an example of this problem, see the "More Information" section later 
in this article.
<P>
<P><h2>WORKAROUND</h2>
 
<P>
Microsoft provides programming examples for illustration only, without
warranty either expressed or implied, including, but not limited to, the
implied warranties of merchantability and/or fitness for a particular
purpose. This article assumes that you are familiar with the programming
language being demonstrated and the tools used to create and debug
procedures. Microsoft support engineers can help explain the functionality
of a particular procedure, but they will not modify these examples to
provide added functionality or construct procedures to meet your specific
needs. If you have limited programming experience, you may want to contact
the Microsoft fee-based consulting line at (800) 936-5200. For more
information about the support options available from Microsoft, please see
the following page on the World Wide Web:
<P>
<PRE>   <B><A HREF="http://www.microsoft.com/supportnet/refguide/">http://www.microsoft.com/supportnet/refguide/</A></B> 

</PRE>To work around this problem, substitute "Application.Caller" for
"ActiveCell" wherever it is used in the custom function. For example, if
the custom function is the following:
<P>
<PRE>   Function Test()

      Application.Volatile

      ' Returns the cell one column to the left of the active cell. Note
      ' that the active cell is not necessarily the cell that is calling
      ' the function.
      Test = ActiveCell.Offset(0, -1).Value

   End Function

</PRE>change it to the following:
<P>
<PRE>   Function Test()

      Application.Volatile

      ' Returns the cell one column to the left of the cell that is
      ' actually calling the function.
      Test = Application.Caller.Offset(0, -1).Value

   End Function

</PRE>When you do this, the function correctly uses the cell that is calling the 
function instead of using the currently active cell.
<P>
<P><h2>STATUS</h2>
 
<P>
This behavior is by design of the versions of Microsoft Excel listed at the
beginning of this article.
<P>
<P><h2>MORE INFORMATION</h2>
 
<P>
When you use the ActiveCell property in a custom function in Microsoft
Excel, the property returns the cell that is currently active. This is true
even if the custom function is called by a formula in a worksheet cell.
<P>
The Caller property of the Application object returns the object that calls
the function, regardless of the cell or worksheet that is active.
<P>
To demonstrate the problem described in this article, follow these steps:

<OL><P><LI>In Microsoft Excel, create a new workbook.

<P><LI>In Sheet1 of the new workbook, enter the following values:
<P>
<P><PRE>      A1: 1
      A2: 2
      A3: 3
      A4: 4
      A5: 5
</PRE>
<P><LI>Insert a new Visual Basic module. (In Microsoft Excel 97 or Microsoft
   Excel 98, first activate the Visual Basic Editor by pressing ALT+F11.)
   Type the following code into the new module:
<P>
<P><PRE>      Function Test()
<PRE></PRE>         Application.Volatile
         Test = ActiveCell.Offset(0, -1).Value
      End Function

</PRE><P><LI>Switch to Sheet1. Enter the following formula into cell B1:
<P>
<P><PRE>      =Test()
</PRE><P>
   Note that the formula returns the value 1. This is the correct value
   because the cell that is one column to the left of the active cell (B1)
   contains the value 1.

<P><LI>Select cell B1. On the Edit menu, click Copy. Select cells B2:B5. On
   the Edit menu, click Paste, and then press ESC.
<P>
   Note that all five formulas in B1:B5 return the value 2. This is true
   because the cell that is one column to the left of the active cell (B2)
   contains the value 2.

<P><LI>Select cell D10. Press F9.
<P>
   All five formulas in B1:B5 return the value 0, because the cell that is
   one column to the left of the active cell (D10) contains no value, which
   is equivalent to having a value of 0.

<P><LI>If you want the function to always return the value of the cell that is
   one column to the left of the cell that is calling the function, change
   the function to the following:
<P>
<P><PRE>      Function Test()
<PRE></PRE>          Application.Volatile
          Test = Application.Caller.Offset(0, -1).Value
      End Function

   When you change the function, and then recalculate the worksheet, the
   formulas in B1:B5 return the values 1 through 5 no matter what cell or
   worksheet is active.

</PRE></OL><h2>REFERENCES</h2>
 
<P>
For additional information about getting help with Visual Basic for 
Applications, please see the following article in the Microsoft Knowledge 
Base:
<P>
<PRE>   ARTICLE-ID: <B><A HREF="../vbapps/Q163435.htm">Q163435</A></B>
   TITLE     : VBA: Programming Resources for Visual Basic  
               for Applications
</PRE>

	</FONT>
	</TD>
	</TR>
</TABLE>
<P>


<!--DOCBODY_END-->

<!--FOOTER_START-->
<table cellpadding=5 border=0 width="90%">
<tr>
<td>
	<HR WIDTH="90%">

<BLOCKQUOTE>
<FONT FACE="Verdana, Arial, Helvetica" SIZE="1">
<SPAN STYLE="font-family:verdana,arial,helvetica; font-size:8pt">
Additional query words: XL5 XL7 XL97 XL98<BR>
Keywords          : kbcode kbprg xlvbahowto xlvbainfo xlformula<BR>
Version           : MACINTOSH:5.0,5.0a,98; WINDOWS:5.0,5.0c,7.0,7.0a,97<BR>
Platform          : MACINTOSH WINDOWS<BR>
Issue type        : kbprb<BR>
Solution Type     : kbworkaround<BR>

</SPAN>
</FONT>
<BR>
<BR>
THE INFORMATION PROVIDED IN THE MICROSOFT KNOWLEDGE BASE IS
PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND.  MICROSOFT DISCLAIMS
ALL WARRANTIES, EITHER EXPRESS OR IMPLIED, INCLUDING THE WARRANTIES
OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  IN NO
EVENT SHALL MICROSOFT CORPORATION OR ITS SUPPLIERS BE LIABLE FOR
ANY DAMAGES WHATSOEVER INCLUDING DIRECT, INDIRECT, INCIDENTAL,
CONSEQUENTIAL, LOSS OF BUSINESS PROFITS OR SPECIAL DAMAGES, EVEN IF
MICROSOFT CORPORATION OR ITS SUPPLIERS HAVE BEEN ADVISED OF THE
POSSIBILITY OF SUCH DAMAGES.  SOME STATES DO NOT ALLOW THE EXCLUSION
OR LIMITATION OF LIABILITY FOR CONSEQUENTIAL OR INCIDENTAL DAMAGES
SO THE FOREGOING LIMITATION MAY NOT APPLY.
</BLOCKQUOTE>
<P>
<center>
	<FONT FACE="Verdana,Arial,Helvetica" SIZE="1">
	Last reviewed:  February 3, 1998</FONT>
	<BR>
	<A HREF="../cpyright.htm" STYLE="font: bold 7pt Verdana,Arial,Helvetica">&copy; 1998 Microsoft Corporation. All rights reserved. Terms of Use.</A><BR>
	
</center>
</td>
</tr>
</table>

<!--FOOTER_END-->
</FONT>
</BODY>
</HTML>
