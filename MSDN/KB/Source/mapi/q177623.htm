

<HTML>
<HEAD>
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-83731338-2"></script><script>  window.dataLayer = window.dataLayer || [];  function gtag(){dataLayer.push(arguments);}  gtag('js', new Date());  gtag('config', 'UA-83731338-2');</script><title>PRB: Rule that Applies to All Messages Cannot Be Created </TITLE>

<!--STYLE_BEGIN-->
<style>@import url(../../msdn_ie4.css);</style>
	<link disabled rel="stylesheet" href="../../msdn_ie3.css">
<!--STYLE_END-->

<META HTTP-EQUIV="CONTENT-Type" CONTENT="text/html; charset=us-ascii">
<META NAME="ms.locale" CONTENT="EN-US">
<META NAME="Category" CONTENT="Support; KB Article">
<META NAME="KBID" CONTENT="Q177623">
<META NAME="KBModify" CONTENT="1998/01/07">
<META NAME="KBCreate" CONTENT="1997/12/04">
<META NAME="Keywords" CONTENT="kbcode EDKAPI">
<META NAME="KBArea" CONTENT="Support; KB; mapi">
<META NAME="Description" CONTENT="  A rule that applies to all the messages that come into an Inbox cannot be created using any of the helper functions such as HRInsert(), because this type of rule requires that the restriction structure be empty.  This is a problem because the HrStr...">
<META NAME="Product" CONTENT="mapi">
<META NAME="Platform" CONTENT="Windows">
<META NAME="Technology" CONTENT=" ">
<META NAME="Premium" CONTENT="support">

<META NAME="nyms" CONTENT="QAIB,QAPF,QAI4,QAEV,QAH4,QAUD,QAH6,QAD7,QAY5,QAYC,QAK9,QAH7,QAGI,QABN,QADB V02180118">
</HEAD>

<BODY BGCOLOR="#FFFFFF" LEFTMARGIN="0" RIGHTMARGIN="0" TOPMARGIN="0">


<!--DOCBODY_START-->
<BR>
<CENTER>
<TABLE BORDER="0" CELLPADDING="0" CELLSPACING="0" VALIGN="top" WIDTH="90%">
	<TR>
		<TD VALIGN="top">
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<H1>PRB: Rule that Applies to All Messages Cannot Be Created</H1>
			</FONT>
			<FONT FACE="verdana,arial,helvetica" SIZE="1">
			Last reviewed:  January 7, 1998</FONT><BR>
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<B>Article ID: Q177623</B>
			</FONT>
		</TD>
	</TR>
	<TR>
	<TD>
	<FONT FACE="Verdana, Arial, Helvetica" SIZE=2>



 
 
The information in this article applies to:

<UL><LI>Exchange Development Kit (EDK), version 5.0
</UL> 
<P>
<P><h2>SYMPTOMS</h2>
 
<P>
A rule that applies to all the messages that come into an Inbox cannot be
created using any of the helper functions such as HRInsert(), because this
type of rule requires that the restriction structure be empty.
<P>
This is a problem because the HrStringToRestriction() function [used to
create a restriction to pass to HRInsert() and other similar functions]
fails with MAPI_E_INVALID_PARAMETER when called with a NULL for the
restriction string.
<P>
<P><h2>CAUSE</h2>
 
<P>
The call returns MAPI_E_INVALID_PARAMETER because HrStringToRestriction()
expects a string, not a NULL.
<P>
<P><h2>RESOLUTION</h2>
 
<P>
The following code allows you to programmatically create a rule that
applies to all messages. The code provided is not complete. It assumes that
you already have a handle to a MAPI session, a pointer to the message
store, a pointer to the folder the rule is to be applied to, and that you
will release the appropriate structures before exiting the program.
<P>
<PRE>   hr = AllMessageRule(m_lpExchTbl,
               lpFolder,0,lStateFlags,
               lpRes,lpActs,"MSFT:TDX Rules",0,"");

   if (FAILED(hr))
   {
      MessageBox(NULL,"Insert Failed",NULL,MB_OK);
      goto cleanup;
   }

   HRESULT AllMessageRule(IN LPEXCHANGEMODIFYTABLE m_lpExchTbl,
      IN LPMAPIFOLDER   lpFolder,
      IN ULONG          ulSequence,
      IN ULONG          ulState,
      IN LPSRestriction lpRestriction,
      IN LPACTIONS      lpActions,
      IN LPSTR          lpszProvider,
      IN ULONG          ulLevel,
      IN LPSTR          lpszName)
   {
    HRESULT              hr         = S_OK;
    SizedROWLIST(1, RowList) = {0};
    LPROWENTRY      lpRowEntry      = NULL;
    LPROWLIST       lpRowList       = (LPROWLIST)&amp;RowList;
    SPropValue      rgPropVals[9]   = {0};

    rgPropVals[0].ulPropTag     =   PR_RULE_SEQUENCE;
    rgPropVals[0].Value.ul      =   ulSequence;

    rgPropVals[1].ulPropTag     =   PR_RULE_STATE;
    rgPropVals[1].Value.ul      =   ulState;

    rgPropVals[2].ulPropTag     =   PR_RULE_CONDITION;
    rgPropVals[2].Value.ul      =   (ULONG)lpRestriction;

    rgPropVals[3].ulPropTag     =   PR_RULE_ACTIONS;
    rgPropVals[3].Value.ul      =   (ULONG)lpActions;

    rgPropVals[4].ulPropTag     =   PR_RULE_PROVIDER;
    rgPropVals[4].Value.lpszA   =   lpszProvider;

    rgPropVals[5].ulPropTag     =   PR_RULE_LEVEL;
    rgPropVals[5].Value.ul      =   NULL;

    rgPropVals[6].ulPropTag     =   PR_RULE_NAME;
    rgPropVals[6].Value.lpszA   =   lpszName;

    rgPropVals[7].ulPropTag     =   PR_RULE_USER_FLAGS;
    rgPropVals[7].Value.ul      =   NULL;

    rgPropVals[8].ulPropTag     =   PR_RULE_PROVIDER_DATA;
    rgPropVals[8].Value.ul      =   NULL;

    lpRowList-&gt;cEntries = 1;

    lpRowEntry = lpRowList-&gt;aEntries;

    lpRowEntry-&gt;ulRowFlags   = ROW_ADD;
    lpRowEntry-&gt;cValues      = 9;
    lpRowEntry-&gt;rgPropVals   = (LPSPropValue)rgPropVals;

    // Modify the RULE table

    hr = m_lpExchTbl-&gt;ModifyTable(0, lpRowList);

    if (FAILED(hr))
    {
        goto cleanup;
    }

   cleanup:

     ULRELEASE(m_lpExchTbl);

     RETURN(hr);
   }
</PRE> 
<PRE>Keywords          : kbcode EDKAPI
Version           : WINDOWS:5.0
Platform          : WINDOWS
Issue type        : kbprb</PRE>

	</FONT>
	</TD>
	</TR>
</TABLE>
<P>


<!--DOCBODY_END-->

<!--FOOTER_START-->
<table cellpadding=5 border=0 width="90%">
<tr>
<td>
	<HR WIDTH="90%">

<BLOCKQUOTE>
<FONT FACE="Verdana, Arial, Helvetica" SIZE="1">
<SPAN STYLE="font-family:verdana,arial,helvetica; font-size:8pt">
================================================================================<BR>

</SPAN>
</FONT>
<BR>
<BR>
THE INFORMATION PROVIDED IN THE MICROSOFT KNOWLEDGE BASE IS
PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND.  MICROSOFT DISCLAIMS
ALL WARRANTIES, EITHER EXPRESS OR IMPLIED, INCLUDING THE WARRANTIES
OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  IN NO
EVENT SHALL MICROSOFT CORPORATION OR ITS SUPPLIERS BE LIABLE FOR
ANY DAMAGES WHATSOEVER INCLUDING DIRECT, INDIRECT, INCIDENTAL,
CONSEQUENTIAL, LOSS OF BUSINESS PROFITS OR SPECIAL DAMAGES, EVEN IF
MICROSOFT CORPORATION OR ITS SUPPLIERS HAVE BEEN ADVISED OF THE
POSSIBILITY OF SUCH DAMAGES.  SOME STATES DO NOT ALLOW THE EXCLUSION
OR LIMITATION OF LIABILITY FOR CONSEQUENTIAL OR INCIDENTAL DAMAGES
SO THE FOREGOING LIMITATION MAY NOT APPLY.
</BLOCKQUOTE>
<P>
<center>
	<FONT FACE="Verdana,Arial,Helvetica" SIZE="1">
	Last reviewed:  January 7, 1998</FONT>
	<BR>
	<A HREF="../cpyright.htm" STYLE="font: bold 7pt Verdana,Arial,Helvetica">&copy; 1998 Microsoft Corporation. All rights reserved. Terms of Use.</A><BR>
	
</center>
</td>
</tr>
</table>

<!--FOOTER_END-->
</FONT>
</BODY>
</HTML>
