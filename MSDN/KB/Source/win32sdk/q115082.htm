

<HTML>
<HEAD>
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-83731338-2"></script><script>  window.dataLayer = window.dataLayer || [];  function gtag(){dataLayer.push(arguments);}  gtag('js', new Date());  gtag('config', 'UA-83731338-2');</script><title>PRB: Page Fault in WIN32S16.DLL Under Win32s </TITLE>

<!--STYLE_BEGIN-->
<style>@import url(../../msdn_ie4.css);</style>
	<link disabled rel="stylesheet" href="../../msdn_ie3.css">
<!--STYLE_END-->

<META HTTP-EQUIV="CONTENT-Type" CONTENT="text/html; charset=us-ascii">
<META NAME="ms.locale" CONTENT="EN-US">
<META NAME="Category" CONTENT="Support; KB Article">
<META NAME="KBID" CONTENT="Q115082">
<META NAME="KBModify" CONTENT="1997/03/20">
<META NAME="KBCreate" CONTENT="1994/05/18">
<META NAME="Keywords" CONTENT="kbprg W32s">
<META NAME="KBArea" CONTENT="Support; KB; win32sdk">
<META NAME="Description" CONTENT="  Start two instances of the Win32 application under Win32s. Close one instance, then close the other instance. A page fault is generated in WIN32S16.DLL. Under Win32s, version 1.1, a dialog box appears. Under Win32s, version 1.15, the error only app...">
<META NAME="Product" CONTENT="Win32 SDK">
<META NAME="Platform" CONTENT="Windows">
<META NAME="Technology" CONTENT=" ">
<META NAME="Premium" CONTENT="support">

<META NAME="nyms" CONTENT="QBWP,QAGI,QBFY,QABI,QAJH,QDNN,QA56,QA55,QADX,QAKJ,QAHC,QAGB,QAC1,QBVV,QBHQ V02180118">
</HEAD>

<BODY BGCOLOR="#FFFFFF" LEFTMARGIN="0" RIGHTMARGIN="0" TOPMARGIN="0">


<!--DOCBODY_START-->
<BR>
<CENTER>
<TABLE BORDER="0" CELLPADDING="0" CELLSPACING="0" VALIGN="top" WIDTH="90%">
	<TR>
		<TD VALIGN="top">
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<H1>PRB: Page Fault in WIN32S16.DLL Under Win32s</H1>
			</FONT>
			<FONT FACE="verdana,arial,helvetica" SIZE="1">
			Last reviewed:  March 20, 1997</FONT><BR>
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<B>Article ID: Q115082</B>
			</FONT>
		</TD>
	</TR>
	<TR>
	<TD>
	<FONT FACE="Verdana, Arial, Helvetica" SIZE=2>



<P><h3> </h3>
 
The information in this article applies to:

<UL><LI>Microsoft Win32s, versions 1.3, 1.3a, 1.3c
</UL> 
<P>
<P><h2>SYMPTOMS</h2>
 
<P>
Start two instances of the Win32 application under Win32s. Close one
instance, then close the other instance. A page fault is generated in
WIN32S16.DLL. Under Win32s, version 1.1, a dialog box appears. Under
Win32s, version 1.15, the error only appears in the output from the debug
version of Win32s.
<P>
<P><h2>CAUSE</h2>
 
<P>
This problem can occur when your application uses the static C run-time
(CRT) libraries or an incompatible version of the MSVCRT*.DLL that comes
with the Visual C++ products. Note that even if the application does not
make any CRT calls, one of its DLLs may call the CRT initialization and
cleanup code in any of the libraries above. The CRT code makes the
following sequence of API calls:
<P>
<PRE>   DeleteCriticalSection
   DeleteCriticalSection
   DeleteCriticalSection
   TlsFree
   VirtualFree
   VirtualFree
   VirtualFree

</PRE>When the second application instance terminates, it faults before it makes
the call to TlsFree(). The CRT has two blocks, one that contains strings
from the environment and one that contains pointers to the first blocks.
These are allocated by the first process that attach to the DLL. Other
processes that attach do not allocate these blocks. When processes are
terminated, these two blocks are freed. However, this succeeds only when
the process that owns the memory frees them. Any other process that tries
to access these blocks will fail.
<P>
<P><h2>RESOLUTION</h2>
 
<P>
Because there is no instance data by default under Win32s (unlike under
Windows NT), applications and DLLs should not use the static CRT DLLs,
instead they should use a compatible version of the MSVCRT*.DLL that ships
with the Visual C++ product. Always use the /MD (Multithreaded using CRT in
a DLL) option when compiling the DLL and add the MSVCRT.LIB import library
to the library list. Then make sure to copy the Win32s version of
MSVCRT*.DLL from the corresponding Visual C++ product to your project or
the Win32s machine.
<P>
Microsoft Visual C++ version 2.0 and later contain two versions of
MSVCRT*.DLL - one version is intended for use on Windows NT, the other is
intended for use on Win32s. Always make sure to use and ship the Win32s
version of MSVCRT*.DLL in your application. The Windows NT/Windows 95
version of MSVCRT20.DLL or MSVCRT4x.DLL can be found in the MSVC20\REDIST
or MSVC4x\REDIST directory of the CD. The Win32s version can be found in
the WIN32S\REDIST directory.
<P>
Note for Visual C++ version 1.0 users - there is only one version of the
MSVCRT10.DLL which is not compatible with Win32s. Therefore, for Visual C++
1.0 users, use CRTDLL.LIB (which comes with the Win32 SDK) because Win32s
has its own CRTDLL.DLL file that was specifically designed for this use.
<P>
<P><h2>MORE INFORMATION</h2>
 
<P>
The real problem is that memory is allocated for several applications. The
allocation is done by the first application. When this application
terminates, it takes with it all of its memory. This means that each time
the remaining applications try to access this memory, an error occurs.
Symptoms include data corruption, hanging, or the WIN32S16.DLL page fault
mentioned above.
<P>

	</FONT>
	</TD>
	</TR>
</TABLE>
<P>


<!--DOCBODY_END-->

<!--FOOTER_START-->
<table cellpadding=5 border=0 width="90%">
<tr>
<td>
	<HR WIDTH="90%">

<BLOCKQUOTE>
<FONT FACE="Verdana, Arial, Helvetica" SIZE="1">
<SPAN STYLE="font-family:verdana,arial,helvetica; font-size:8pt">
Additional query words: 1.0 2.0 4.0 4.1 4.2<BR>
Keywords            : kbprg W32s<BR>
Version             : 1.3 1.3a 1.3c<BR>
Issue type          : kbprb<BR>

</SPAN>
</FONT>
<BR>
<BR>
THE INFORMATION PROVIDED IN THE MICROSOFT KNOWLEDGE BASE IS
PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND.  MICROSOFT DISCLAIMS
ALL WARRANTIES, EITHER EXPRESS OR IMPLIED, INCLUDING THE WARRANTIES
OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  IN NO
EVENT SHALL MICROSOFT CORPORATION OR ITS SUPPLIERS BE LIABLE FOR
ANY DAMAGES WHATSOEVER INCLUDING DIRECT, INDIRECT, INCIDENTAL,
CONSEQUENTIAL, LOSS OF BUSINESS PROFITS OR SPECIAL DAMAGES, EVEN IF
MICROSOFT CORPORATION OR ITS SUPPLIERS HAVE BEEN ADVISED OF THE
POSSIBILITY OF SUCH DAMAGES.  SOME STATES DO NOT ALLOW THE EXCLUSION
OR LIMITATION OF LIABILITY FOR CONSEQUENTIAL OR INCIDENTAL DAMAGES
SO THE FOREGOING LIMITATION MAY NOT APPLY.
</BLOCKQUOTE>
<P>
<center>
	<FONT FACE="Verdana,Arial,Helvetica" SIZE="1">
	Last reviewed:  March 20, 1997</FONT>
	<BR>
	<A HREF="../cpyright.htm" STYLE="font: bold 7pt Verdana,Arial,Helvetica">&copy; 1998 Microsoft Corporation. All rights reserved. Terms of Use.</A><BR>
	
</center>
</td>
</tr>
</table>

<!--FOOTER_END-->
</FONT>
</BODY>
</HTML>
