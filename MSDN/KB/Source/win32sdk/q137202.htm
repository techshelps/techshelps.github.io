

<HTML>
<HEAD>
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-83731338-2"></script><script>  window.dataLayer = window.dataLayer || [];  function gtag(){dataLayer.push(arguments);}  gtag('js', new Date());  gtag('config', 'UA-83731338-2');</script><title>Windows 95 RegOpenKeyEx Incompatible with Windows NT </TITLE>

<!--STYLE_BEGIN-->
<style>@import url(../../msdn_ie4.css);</style>
	<link disabled rel="stylesheet" href="../../msdn_ie3.css">
<!--STYLE_END-->

<META HTTP-EQUIV="CONTENT-Type" CONTENT="text/html; charset=us-ascii">
<META NAME="ms.locale" CONTENT="EN-US">
<META NAME="Category" CONTENT="Support; KB Article">
<META NAME="KBID" CONTENT="Q137202">
<META NAME="KBModify" CONTENT="1997/01/15">
<META NAME="KBCreate" CONTENT="1995/09/21">
<META NAME="Keywords" CONTENT="kbprg kbprb">
<META NAME="KBArea" CONTENT="Support; KB; win32sdk">
<META NAME="Description" CONTENT="  A Win32-based application runs under Windows 95 but does not run correctly under Windows NT. Or a Windows-based application runs under Windows 95 but leaks registry handles under Windows NT.  CAUSE =====  Windows NT RegOpenKeyEx always returns a un...">
<META NAME="Product" CONTENT="Win32 SDK">
<META NAME="Platform" CONTENT="Windows">
<META NAME="Technology" CONTENT=" ">
<META NAME="Premium" CONTENT="support">

<META NAME="nyms" CONTENT="QBWP,QDL9,QBWN,QBWO,QBWQ,QAH4,QAKJ,QAJQ,QAUD,QAGB,QDNF,QBWS,QAGQ,QAGI,QANY V02180118">
</HEAD>

<BODY BGCOLOR="#FFFFFF" LEFTMARGIN="0" RIGHTMARGIN="0" TOPMARGIN="0">


<!--DOCBODY_START-->
<BR>
<CENTER>
<TABLE BORDER="0" CELLPADDING="0" CELLSPACING="0" VALIGN="top" WIDTH="90%">
	<TR>
		<TD VALIGN="top">
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<H1>Windows 95 RegOpenKeyEx Incompatible with Windows NT</H1>
			</FONT>
			<FONT FACE="verdana,arial,helvetica" SIZE="1">
			Last reviewed:  January 15, 1997</FONT><BR>
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<B>Article ID: Q137202</B>
			</FONT>
		</TD>
	</TR>
	<TR>
	<TD>
	<FONT FACE="Verdana, Arial, Helvetica" SIZE=2>



 
The information in this article applies to:

<UL><LI>Microsoft Win32 Application Programming Interface (API) included with:
<P><PRE>    - Microsoft Windows 95 version 4.0
</UL></PRE> 
<P>
<P><h2>SYMPTOMS</h2>
 
<P>
A Win32-based application runs under Windows 95 but does not run correctly
under Windows NT. Or a Windows-based application runs under Windows 95 but
leaks registry handles under Windows NT.
<P>
<P><h2>CAUSE</h2>
 
<P>
Windows NT RegOpenKeyEx always returns a unique handle. Windows 95
RegOpenKeyEx returns the same handle each time the same key is opened.
Windows 95 keeps a reference count, incrementing it each time the key
is opened with RegOpenKeyEx and decrementing it each time the key is
closed with RegCloseKey. The key remains open as long as the reference
count is greater than zero.
<P>
Consider the following code:
<P>
<PRE>   RegOpenKeyEx(OldKey, NULL, 0, MAXIMUM_ALLOWED, &amp;NewKey)
   RegCloseKey(NewKey)
   RegQueryValue(NewKey,...)
   RegCloseKey(NewKey)

</PRE>This code is incorrect, but it works under Windows 95 because OldKey and
NewKey refer to the same key. However, the code fails under Windows NT,
because NewKey is not valid after it is closed.
<P>
In a related issue, RegOpenKey with a NULL subkey string on Windows NT
will return the same handle that was passed in. Under Windows 95, the
reference count is incremented.
<P>
<PRE>   RegOpenKey(OldKey, NULL, 0, MAXIMUM_ALLOWED, &amp;NewKey)
   RegCloseKey(OldKey)
   RegQueryValue(NewKey,...)
   RegCloseKey(NewKey)

</PRE>This code works under Windows 95 because NewKey is still valid after
closing OldKey, but the code fails under Windows NT. Code that is correct
for Windows NT (don't close the handle until both OldKey and NewKey are no
longer needed) leaks registry handles under Windows 95.
<P>
<P><h2>RESOLUTION</h2>
 
<P>
You should use RegOpenKeyEx and make sure that there is a corresponding
close call for each open call. This will ensure that you do not use any
handle that has been closed.
<P>
<P><h2>STATUS</h2>
 
<P>
This behavior is by design.
<P>

	</FONT>
	</TD>
	</TR>
</TABLE>
<P>


<!--DOCBODY_END-->

<!--FOOTER_START-->
<table cellpadding=5 border=0 width="90%">
<tr>
<td>
	<HR WIDTH="90%">

<BLOCKQUOTE>
<FONT FACE="Verdana, Arial, Helvetica" SIZE="1">
<SPAN STYLE="font-family:verdana,arial,helvetica; font-size:8pt">
KBCategory: kbprg kbprb<BR>
KBSubcategory: BseRegistry<BR>
Additional reference words: 4.00 Windows 95<BR>

</SPAN>
</FONT>
<BR>
<BR>
THE INFORMATION PROVIDED IN THE MICROSOFT KNOWLEDGE BASE IS
PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND.  MICROSOFT DISCLAIMS
ALL WARRANTIES, EITHER EXPRESS OR IMPLIED, INCLUDING THE WARRANTIES
OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  IN NO
EVENT SHALL MICROSOFT CORPORATION OR ITS SUPPLIERS BE LIABLE FOR
ANY DAMAGES WHATSOEVER INCLUDING DIRECT, INDIRECT, INCIDENTAL,
CONSEQUENTIAL, LOSS OF BUSINESS PROFITS OR SPECIAL DAMAGES, EVEN IF
MICROSOFT CORPORATION OR ITS SUPPLIERS HAVE BEEN ADVISED OF THE
POSSIBILITY OF SUCH DAMAGES.  SOME STATES DO NOT ALLOW THE EXCLUSION
OR LIMITATION OF LIABILITY FOR CONSEQUENTIAL OR INCIDENTAL DAMAGES
SO THE FOREGOING LIMITATION MAY NOT APPLY.
</BLOCKQUOTE>
<P>
<center>
	<FONT FACE="Verdana,Arial,Helvetica" SIZE="1">
	Last reviewed:  January 15, 1997</FONT>
	<BR>
	<A HREF="../cpyright.htm" STYLE="font: bold 7pt Verdana,Arial,Helvetica">&copy; 1998 Microsoft Corporation. All rights reserved. Terms of Use.</A><BR>
	
</center>
</td>
</tr>
</table>

<!--FOOTER_END-->
</FONT>
</BODY>
</HTML>
