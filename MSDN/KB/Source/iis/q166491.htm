

<HTML>
<HEAD>
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-83731338-2"></script><script>  window.dataLayer = window.dataLayer || [];  function gtag(){dataLayer.push(arguments);}  gtag('js', new Date());  gtag('config', 'UA-83731338-2');</script><title>Secure Batch Files Return Access Denied Error Message </TITLE>

<!--STYLE_BEGIN-->
<style>@import url(../../msdn_ie4.css);</style>
	<link disabled rel="stylesheet" href="../../msdn_ie3.css">
<!--STYLE_END-->

<META HTTP-EQUIV="CONTENT-Type" CONTENT="text/html; charset=us-ascii">
<META NAME="ms.locale" CONTENT="EN-US">
<META NAME="Category" CONTENT="Support; KB Article">
<META NAME="KBID" CONTENT="Q166491">
<META NAME="KBModify" CONTENT="1997/12/23">
<META NAME="KBCreate" CONTENT="1997/04/08">
<META NAME="Keywords" CONTENT="kbnetwork">
<META NAME="KBArea" CONTENT="Support; KB; iis">
<META NAME="Description" CONTENT="  Batch files that are implemented as Common Gateway Interface (CGI) applications on an Internet Information Server (IIS) computer will always return an Access Denied error message if they are secured using NTFS file security and the Anonymous user d...">
<META NAME="Product" CONTENT="Internet Information Server">
<META NAME="Platform" CONTENT="Windows">
<META NAME="Technology" CONTENT=" ">
<META NAME="Premium" CONTENT="support">

<META NAME="nyms" CONTENT="QAB4,QAUD,QBXP,QA1S,QAAD,QAK7,QAGI,QDN9,QAVY,QABI,QDNQ,QAAP,QABH,QBWA,QABT V02180118">
</HEAD>

<BODY BGCOLOR="#FFFFFF" LEFTMARGIN="0" RIGHTMARGIN="0" TOPMARGIN="0">


<!--DOCBODY_START-->
<BR>
<CENTER>
<TABLE BORDER="0" CELLPADDING="0" CELLSPACING="0" VALIGN="top" WIDTH="90%">
	<TR>
		<TD VALIGN="top">
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<H1>Secure Batch Files Return Access Denied Error Message</H1>
			</FONT>
			<FONT FACE="verdana,arial,helvetica" SIZE="1">
			Last reviewed:  December 23, 1997</FONT><BR>
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<B>Article ID: Q166491</B>
			</FONT>
		</TD>
	</TR>
	<TR>
	<TD>
	<FONT FACE="Verdana, Arial, Helvetica" SIZE=2>



 
 
The information in this article applies to:

<UL><LI>Microsoft Internet Information Server, version 2.0 and 3.0
</UL> 
<P>
<P><h2>SYMPTOMS</h2>
 
<P>
Batch files that are implemented as Common Gateway Interface (CGI)
applications on an Internet Information Server (IIS) computer will always
return an Access Denied error message if they are secured using NTFS file
security and the Anonymous user does not have access rights to the batch
files. The Access Denied error message is returned regardless of the
authentication scheme (Basic or Challenge Response) configured on the IIS
server. The following is the error page returned to the client:
<P>
<PRE>   CGI Error
   The specified CGI application misbehaved by not returning a complete
   set of HTTP headers. The headers it did return are:
   Access is denied.

</PRE><h2>CAUSE</h2>
 
<P>
The error occurs because CGI applications are not access checked before
being executed. IIS relies on the request handler in w3svc to access check
a request and return an error indicating authentication is required to
access the requested object.
<P>
In this case, the requested object is a batch file, which is handled
differently than other requests. A batch file requires IIS to run the
command interpreter (Cmd.exe) to process, and requires an extra thread to
monitor and return any output generated by the batch file (CGI Gateway
Thread). Because Cmd.exe is not secure, it will execute without a failure
and IIS will start the CGI Gateway Thread. The error results when Cmd.exe
attempts to process the secure batch file. Cmd.exe fails to process the
batch file silently; however, the CGI Gateway Thread is still waiting for
output from the batch file. Eventually the CGI Gateway Thread fails and
returns a Gateway Error to the requesting client with the Access Denied
error message.
<P>
<P><h2>WORKAROUND</h2>
 
<P>
To work around this problem, you need to first upgrade to IIS 3.0 (if you
have not already done so), install IIS 3.0 Active Server Pages (ASP), and
use the new server-side include "execute" functionality to force a security
check before executing the batch file. To force a security check before
executing the batch file:

<OL><P><LI>Install Windows NT 4.0 Service Pack 2, then shut down and restart.

<P><LI>Install Active Server Pages (ASP) from the Service Pack 2 CD by
   running iis30\asp\aspsetup.bat.

<P><LI>Create an .stm file (for example, Test.stm) for every secure batch file
   used. The .stm file should contain the following text to execute a batch
   file.
<P>
<P><PRE>      Example .stm file:
      &lt;!--#exec cgi="/scripts/test.cmd"--&gt;
</PRE>
<P><LI>Place the .stm file in the /scripts directory on your server (or
   another directory with execute permissions).

<P><LI>Set the NTFS security on the .stm file to match the security on the
   batch file.

<P><LI>Call the .stm file from html pages instead of calling the batch files
   directly.
<P>
<P><PRE>      Example html document:
      &lt;html&gt;
      &lt;form action="/scripts/test.stm" type=get&gt;
      &lt;input type=submit&gt;
      &lt;/form&gt;
      &lt;/html&gt;
</PRE><P>
</OL><h2>STATUS</h2>
 
<P>
Microsoft has confirmed this to be a problem in Internet Information
Server versions 2.0 and 3.0. We are researching this problem and will
post new information here in the Microsoft Knowledge Base as it becomes
available.
 
<PRE>Keywords          : kbnetwork
Version           : winnt:2.0,3.0
Platform          : winnt
Hardware          : x86
Issue type        : kbbug</PRE>

	</FONT>
	</TD>
	</TR>
</TABLE>
<P>


<!--DOCBODY_END-->

<!--FOOTER_START-->
<table cellpadding=5 border=0 width="90%">
<tr>
<td>
	<HR WIDTH="90%">

<BLOCKQUOTE>
<FONT FACE="Verdana, Arial, Helvetica" SIZE="1">
<SPAN STYLE="font-family:verdana,arial,helvetica; font-size:8pt">
================================================================================<BR>

</SPAN>
</FONT>
<BR>
<BR>
THE INFORMATION PROVIDED IN THE MICROSOFT KNOWLEDGE BASE IS
PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND.  MICROSOFT DISCLAIMS
ALL WARRANTIES, EITHER EXPRESS OR IMPLIED, INCLUDING THE WARRANTIES
OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  IN NO
EVENT SHALL MICROSOFT CORPORATION OR ITS SUPPLIERS BE LIABLE FOR
ANY DAMAGES WHATSOEVER INCLUDING DIRECT, INDIRECT, INCIDENTAL,
CONSEQUENTIAL, LOSS OF BUSINESS PROFITS OR SPECIAL DAMAGES, EVEN IF
MICROSOFT CORPORATION OR ITS SUPPLIERS HAVE BEEN ADVISED OF THE
POSSIBILITY OF SUCH DAMAGES.  SOME STATES DO NOT ALLOW THE EXCLUSION
OR LIMITATION OF LIABILITY FOR CONSEQUENTIAL OR INCIDENTAL DAMAGES
SO THE FOREGOING LIMITATION MAY NOT APPLY.
</BLOCKQUOTE>
<P>
<center>
	<FONT FACE="Verdana,Arial,Helvetica" SIZE="1">
	Last reviewed:  December 23, 1997</FONT>
	<BR>
	<A HREF="../cpyright.htm" STYLE="font: bold 7pt Verdana,Arial,Helvetica">&copy; 1998 Microsoft Corporation. All rights reserved. Terms of Use.</A><BR>
	
</center>
</td>
</tr>
</table>

<!--FOOTER_END-->
</FONT>
</BODY>
</HTML>
