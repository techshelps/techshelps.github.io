

<HTML>
<HEAD>
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-83731338-2"></script><script>  window.dataLayer = window.dataLayer || [];  function gtag(){dataLayer.push(arguments);}  gtag('js', new Date());  gtag('config', 'UA-83731338-2');</script><title>Hooking Interrupt 21h Before Windows </TITLE>

<!--STYLE_BEGIN-->
<style>@import url(../../msdn_ie4.css);</style>
	<link disabled rel="stylesheet" href="../../msdn_ie3.css">
<!--STYLE_END-->

<META HTTP-EQUIV="CONTENT-Type" CONTENT="text/html; charset=us-ascii">
<META NAME="ms.locale" CONTENT="EN-US">
<META NAME="Category" CONTENT="Support; KB Article">
<META NAME="KBID" CONTENT="Q81813 ">
<META NAME="KBModify" CONTENT="1997/07/23">
<META NAME="KBCreate" CONTENT="1992/03/17">
<META NAME="Keywords" CONTENT="kb16bitonly">
<META NAME="KBArea" CONTENT="Support; KB; win16sdk">
<META NAME="Description" CONTENT="  In the standard and enhanced modes of Microsoft Windows version 3.1, an application for Windows can receive notification of all calls to MS-DOS made by Windows after these calls have been translated by the Windows kernel. To do so, the application ...">
<META NAME="Product" CONTENT="Win16 SDK">
<META NAME="Platform" CONTENT="Windows">
<META NAME="Technology" CONTENT=" ">
<META NAME="Premium" CONTENT="support">

<META NAME="nyms" CONTENT="QADN,QAHC,QDL9,QBWO,QBWN,QAGI,QAHB,QBWQ,QA5W,QAUD,QAY5,QAIF,QABB,QAB5,QAJH V02180118">
</HEAD>

<BODY BGCOLOR="#FFFFFF" LEFTMARGIN="0" RIGHTMARGIN="0" TOPMARGIN="0">


<!--DOCBODY_START-->
<BR>
<CENTER>
<TABLE BORDER="0" CELLPADDING="0" CELLSPACING="0" VALIGN="top" WIDTH="90%">
	<TR>
		<TD VALIGN="top">
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<H1>Hooking Interrupt 21h Before Windows</H1>
			</FONT>
			<FONT FACE="verdana,arial,helvetica" SIZE="1">
			Last reviewed:  July 23, 1997</FONT><BR>
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<B>Article ID: Q81813 </B>
			</FONT>
		</TD>
	</TR>
	<TR>
	<TD>
	<FONT FACE="Verdana, Arial, Helvetica" SIZE=2>



 
3.10
WINDOWS
kbprg
<P>
 
The information in this article applies to:

<UL><LI>Microsoft Windows Software Development Kit (SDK) for Windows version 3.1
</UL> 
<P>
<P><h2>SUMMARY</h2>
 
<P>
In the standard and enhanced modes of Microsoft Windows version 3.1, an
application for Windows can receive notification of all calls to MS-DOS
made by Windows after these calls have been translated by the Windows
kernel. To do so, the application calls the MS-DOS Protected Mode Interface
(DPMI) to hook the real mode Interrupt 21h vector.
<P>
<P><h2>MORE INFORMATION</h2>
 
<P>
This technique is not effective in standard mode under Windows version 3.1
because the Windows 3.1 Standard Mode MS-DOS Extender (DOSX) does not use
the real mode interrupt vector table (IVT) to translate software interrupts
from protected mode to real mode. DOSX uses a copy of the real mode IVT,
made at DOSX initialization, for this purpose.
<P>
In addition, receiving notification using DPMI is of questionable validity
because future versions of Windows may implement some or all software
interrupts in protected mode. (The Windows 3.1 kernel already implements
Interrupt 13h in protected mode, when 32-bit disk access is enabled.)
<P>
Applications that must receive notification of Interrupt 21h after the
Windows kernel can use the GetSetKernelDOSProc() function provided by
the standard and enhanced modes of Windows 3.1. This function sets the
protected mode address that the kernel calls to implement Interrupt
21h. The prototype of GetSetKernelDOSProc() is as follows:
<P>
<PRE>   DWORD _far _pascal GetSetKernelDOSProc(DWORD newproc);

</PRE>The newproc parameter is the protected mode address of the new Interrupt
21h interrupt routine, which kernel calls to implement Interrupt 21h.
GetSetKernelDOSProc() returns the address of the old routine, which kernel
called previously. If the application processes only particular Interrupt
21h functions, it must send unprocessed functions to the next handler in
the chain. Use the address returned by GetSetKernelDOSProc() to call the
next handler in the chain.
<P>
An application calls GetSetKernelDOSProc() once to install itself as the
Interrupt 21h handler, saving the return value. When the function exits, it
calls the function again to restore the previous value. An application that
can uninstall itself should verify that GetSetKernelDOSProc() returns the
value of its handler when called to restore the previous handler. If
GetSetKernelDOSProc() returns a different value, another program has
installed itself into the Interrupt 21h chain. If so, the application
should call GetSetKernelDOSProc() a third time to place itself back into
the Interrupt 21h chain.
<P>
An application that hooks real mode Interrupt 21h in Windows 3.0
should use GetSetKernelDOSProc() in Windows 3.1 and later versions.
Although GetSetKernelDOSProc() is not in LIBW.LIB, it is exported as
ordinal 311, which is the preferred method to link to the function.
The other method is to use GetProcAddress() with the function name.
<P>

	</FONT>
	</TD>
	</TR>
</TABLE>
<P>


<!--DOCBODY_END-->

<!--FOOTER_START-->
<table cellpadding=5 border=0 width="90%">
<tr>
<td>
	<HR WIDTH="90%">

<BLOCKQUOTE>
<FONT FACE="Verdana, Arial, Helvetica" SIZE="1">
<SPAN STYLE="font-family:verdana,arial,helvetica; font-size:8pt">
Additional reference words: 3.10<BR>
KBCategory: kbprg<BR>
KBSubcategory: KrDosint<BR>
Keywords            : kb16bitonly<BR>

</SPAN>
</FONT>
<BR>
<BR>
THE INFORMATION PROVIDED IN THE MICROSOFT KNOWLEDGE BASE IS
PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND.  MICROSOFT DISCLAIMS
ALL WARRANTIES, EITHER EXPRESS OR IMPLIED, INCLUDING THE WARRANTIES
OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  IN NO
EVENT SHALL MICROSOFT CORPORATION OR ITS SUPPLIERS BE LIABLE FOR
ANY DAMAGES WHATSOEVER INCLUDING DIRECT, INDIRECT, INCIDENTAL,
CONSEQUENTIAL, LOSS OF BUSINESS PROFITS OR SPECIAL DAMAGES, EVEN IF
MICROSOFT CORPORATION OR ITS SUPPLIERS HAVE BEEN ADVISED OF THE
POSSIBILITY OF SUCH DAMAGES.  SOME STATES DO NOT ALLOW THE EXCLUSION
OR LIMITATION OF LIABILITY FOR CONSEQUENTIAL OR INCIDENTAL DAMAGES
SO THE FOREGOING LIMITATION MAY NOT APPLY.
</BLOCKQUOTE>
<P>
<center>
	<FONT FACE="Verdana,Arial,Helvetica" SIZE="1">
	Last reviewed:  July 23, 1997</FONT>
	<BR>
	<A HREF="../cpyright.htm" STYLE="font: bold 7pt Verdana,Arial,Helvetica">&copy; 1998 Microsoft Corporation. All rights reserved. Terms of Use.</A><BR>
	
</center>
</td>
</tr>
</table>

<!--FOOTER_END-->
</FONT>
</BODY>
</HTML>
