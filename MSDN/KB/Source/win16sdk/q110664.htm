

<HTML>
<HEAD>
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-83731338-2"></script><script>  window.dataLayer = window.dataLayer || [];  function gtag(){dataLayer.push(arguments);}  gtag('js', new Date());  gtag('config', 'UA-83731338-2');</script><title>BUG: DDEML Fails to Free Item Name HSZ on a LATEACK </TITLE>

<!--STYLE_BEGIN-->
<style>@import url(../../msdn_ie4.css);</style>
	<link disabled rel="stylesheet" href="../../msdn_ie3.css">
<!--STYLE_END-->

<META HTTP-EQUIV="CONTENT-Type" CONTENT="text/html; charset=us-ascii">
<META NAME="ms.locale" CONTENT="EN-US">
<META NAME="Category" CONTENT="Support; KB Article">
<META NAME="KBID" CONTENT="Q110664">
<META NAME="KBModify" CONTENT="1995/05/25">
<META NAME="KBCreate" CONTENT="1994/01/26">
<META NAME="Keywords" CONTENT="kbprg kbbuglist kbcode">
<META NAME="KBArea" CONTENT="Support; KB; win16sdk">
<META NAME="Description" CONTENT="  On an advise loop started with the XTYPF_ACKREQ flag, the item name string is mistakenly removed from the global atom table after a certain period of time causing a subsequent call to DdePostAdvise() on that item name string to fail.  CAUSE =====  ...">
<META NAME="Product" CONTENT="Win16 SDK">
<META NAME="Platform" CONTENT="Windows">
<META NAME="Technology" CONTENT=" ">
<META NAME="Premium" CONTENT="support">

<META NAME="nyms" CONTENT="QBWN,QDL9,QBWO,QAUD,QAUJ,QAGI,QATX,QAKP,QDMA,QAY2,QBWQ,QARM,QASR,QAEF,QAC1 V02180118">
</HEAD>

<BODY BGCOLOR="#FFFFFF" LEFTMARGIN="0" RIGHTMARGIN="0" TOPMARGIN="0">


<!--DOCBODY_START-->
<BR>
<CENTER>
<TABLE BORDER="0" CELLPADDING="0" CELLSPACING="0" VALIGN="top" WIDTH="90%">
	<TR>
		<TD VALIGN="top">
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<H1>BUG: DDEML Fails to Free Item Name HSZ on a LATEACK</H1>
			</FONT>
			<FONT FACE="verdana,arial,helvetica" SIZE="1">
			Last reviewed:  May 25, 1995</FONT><BR>
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<B>Article ID: Q110664</B>
			</FONT>
		</TD>
	</TR>
	<TR>
	<TD>
	<FONT FACE="Verdana, Arial, Helvetica" SIZE=2>



 
The information in this article applies to:

<UL><LI>Microsoft Windows Software Development Kit (SDK) for Windows
   version 3.1
</UL> 
<P>
<P><h2>SYMPTOMS</h2>
 
<P>
On an advise loop started with the XTYPF_ACKREQ flag, the item name string
is mistakenly removed from the global atom table after a certain period
of time causing a subsequent call to DdePostAdvise() on that item name
string to fail.
<P>
<P><h2>CAUSE</h2>
 
<P>
For an advise loop started with the XTYPF_ACKREQ flag, DDEML sends the
server application an XTYP_ADVREQ with the LOWORD(dwData1) set to
CADV_LATEACK when the server application calls DdePostAdvise() before the
ACK for the previous update has been received.
<P>
When the server's callback returns from processing this specific
transaction, DDEML fails to free the item name string handle. This causes
the item name's atom reference count (a WORD value) to increment
indefinitely. When the maximum number of transactions (65535 for a WORD
value) of this type occur, the reference count will be incremented
(wrapped) to zero and the item name's atom ultimately is deleted from the
global atom table. Subsequent calls to DdePostAdvise() on this item name
string fail because the item name is no longer valid.
<P>
<P><h2>RESOLUTION</h2>
 
<P>
To work around this problem, modify your 16-bit server code as described
below, freeing the string handle appropriately before returning from the
XTYP_ADVREQ transaction:
<P>
<PRE>   case XTYP_ADVREQ:
   ....  // Application specific processing here.

   if (WIN16APP &amp;&amp;  (GetDDEMLVer() &lt;= 0x00030011))
   {
      if (CADV_LATEACK == LOWORD(dwData1)
          DdeFreeStringHandle(idInst, hsz2);
   }

   ...  // Return appropriate data handle or NULL here.

</PRE>The function GetDDEMLVer() could be written to return the dwFileVersionMS
member of the VS_FIXEDFILEINFO structure. Refer to the VERSTAMP sample that
shipped with the Microsoft Windows 3.1 SDK and/or Microsoft Visual C++ for
further details about extracting version information.
<P>
WIN16APP can be #defined to TRUE if this is a 16-bit version of your
application; FALSE otherwise.
<P>
<P><h2>STATUS</h2>
 
<P>
Microsoft has confirmed this to be a bug in Microsoft Windows version
3.1.
<P>
NOTE: This is not a problem in the 32-bit version of DDEML, that is, the
version that comes with Microsoft Windows NT and Windows 95.
<P>

	</FONT>
	</TD>
	</TR>
</TABLE>
<P>


<!--DOCBODY_END-->

<!--FOOTER_START-->
<table cellpadding=5 border=0 width="90%">
<tr>
<td>
	<HR WIDTH="90%">

<BLOCKQUOTE>
<FONT FACE="Verdana, Arial, Helvetica" SIZE="1">
<SPAN STYLE="font-family:verdana,arial,helvetica; font-size:8pt">
Additional reference words: 3.10 buglist3.10<BR>
KBCategory: kbprg kbbuglist kbcode<BR>
KBSubcategory: UsrDde<BR>

</SPAN>
</FONT>
<BR>
<BR>
THE INFORMATION PROVIDED IN THE MICROSOFT KNOWLEDGE BASE IS
PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND.  MICROSOFT DISCLAIMS
ALL WARRANTIES, EITHER EXPRESS OR IMPLIED, INCLUDING THE WARRANTIES
OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  IN NO
EVENT SHALL MICROSOFT CORPORATION OR ITS SUPPLIERS BE LIABLE FOR
ANY DAMAGES WHATSOEVER INCLUDING DIRECT, INDIRECT, INCIDENTAL,
CONSEQUENTIAL, LOSS OF BUSINESS PROFITS OR SPECIAL DAMAGES, EVEN IF
MICROSOFT CORPORATION OR ITS SUPPLIERS HAVE BEEN ADVISED OF THE
POSSIBILITY OF SUCH DAMAGES.  SOME STATES DO NOT ALLOW THE EXCLUSION
OR LIMITATION OF LIABILITY FOR CONSEQUENTIAL OR INCIDENTAL DAMAGES
SO THE FOREGOING LIMITATION MAY NOT APPLY.
</BLOCKQUOTE>
<P>
<center>
	<FONT FACE="Verdana,Arial,Helvetica" SIZE="1">
	Last reviewed:  May 25, 1995</FONT>
	<BR>
	<A HREF="../cpyright.htm" STYLE="font: bold 7pt Verdana,Arial,Helvetica">&copy; 1998 Microsoft Corporation. All rights reserved. Terms of Use.</A><BR>
	
</center>
</td>
</tr>
</table>

<!--FOOTER_END-->
</FONT>
</BODY>
</HTML>
