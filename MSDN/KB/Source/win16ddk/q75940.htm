

<HTML>
<HEAD>
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-83731338-2"></script><script>  window.dataLayer = window.dataLayer || [];  function gtag(){dataLayer.push(arguments);}  gtag('js', new Date());  gtag('config', 'UA-83731338-2');</script><title>BUG: VKD_API_Force_Key Can Cause Windows Crash </TITLE>

<!--STYLE_BEGIN-->
<style>@import url(../../msdn_ie4.css);</style>
	<link disabled rel="stylesheet" href="../../msdn_ie3.css">
<!--STYLE_END-->

<META HTTP-EQUIV="CONTENT-Type" CONTENT="text/html; charset=us-ascii">
<META NAME="ms.locale" CONTENT="EN-US">
<META NAME="Category" CONTENT="Support; KB Article">
<META NAME="KBID" CONTENT="Q75940 ">
<META NAME="KBModify" CONTENT="1995/04/12">
<META NAME="KBCreate" CONTENT="1991/09/10">
<META NAME="Keywords" CONTENT="kbprg kbbuglist">
<META NAME="KBArea" CONTENT="Support; KB; win16ddk">
<META NAME="Description" CONTENT="  When a Windows-based application calls the virtual keyboard device (VKD) service VKD_API_Force_Key to simulate keystrokes into a virtual  8086-mode MS-DOS session without requesting a simulated change in shift state, Windows crashes.  RESOLUTION  T...">
<META NAME="Product" CONTENT="Win16 DDK">
<META NAME="Platform" CONTENT="Windows">
<META NAME="Technology" CONTENT=" ">
<META NAME="Premium" CONTENT="support">

<META NAME="nyms" CONTENT="QBWN,QDL9,QBWO,QBWQ,QAMN,QACI,QAGI,QAMB,QAC2,QAKJ,QBXT,QA5V,QAIB,QAH4,QDJO V02180118">
</HEAD>

<BODY BGCOLOR="#FFFFFF" LEFTMARGIN="0" RIGHTMARGIN="0" TOPMARGIN="0">


<!--DOCBODY_START-->
<BR>
<CENTER>
<TABLE BORDER="0" CELLPADDING="0" CELLSPACING="0" VALIGN="top" WIDTH="90%">
	<TR>
		<TD VALIGN="top">
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<H1>BUG: VKD_API_Force_Key Can Cause Windows Crash</H1>
			</FONT>
			<FONT FACE="verdana,arial,helvetica" SIZE="1">
			Last reviewed:  April 12, 1995</FONT><BR>
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<B>Article ID: Q75940 </B>
			</FONT>
		</TD>
	</TR>
	<TR>
	<TD>
	<FONT FACE="Verdana, Arial, Helvetica" SIZE=2>



 
The information in this article applies to:

<UL><LI>Microsoft Windows Device Development Kit (DDK) for Windows version
   3.0
</UL> 
<P>
<P><h2>SYMPTOMS</h2>
 
<P>
When a Windows-based application calls the virtual keyboard device (VKD)
service VKD_API_Force_Key to simulate keystrokes into a virtual  8086-mode
MS-DOS session without requesting a simulated change in shift state,
Windows crashes.
<P>
<P><h2>RESOLUTION</h2>
 
<P>
This problem may be avoided by either of two methods:

<UL><LI>Request a change in shift state each time this service is used
<P>
   -or-

<LI>Modify the VKD to eliminate the problem.
<P>
</UL><h2>STATUS</h2>
 
<P>
Microsoft has confirmed this to be a problem in Windows version 3.0. We
are researching this problem and will post new information here as it
becomes available.
<P>
<P><h2>MORE INFORMATION</h2>
 
<P>
The remainder of this article describes the required changes to the VKD
source code to enable this service to work correctly without requesting a
change in the shift state.
<P>
If VKD_API_Force_Key is called with DX set to -1 (which indicates that this
API should not make a simulated change in shift state), the logic flow is
such that the scan code (AL register) and the repeat count (ECX register)
will not get initialized. This causes a keyboard hardware buffer overflow
and a system crash.
<P>
To correct this situation, make the following three changes to the VKD
source module VKD.ASM, which is included with the Windows Device
Development Kit (DDK) in the \VXD\VKD directory:

<OL><P><LI>Move the label at line 2293 (afk_no_ss:) up to line 2289, to
   include the lines that set the register values for the AL and ECX
   registers.

<P><LI>Insert a new label name (such as afk_put_keys:) at line 2293.

<P><LI>Change line 2302 to loop to the new label. This might read:
<P>
<PRE>      loop    afk_put_keys

</PRE></OL>After making these changes to VKD.ASM, perform these four steps:

<OL><P><LI>Build the VKD virtual driver (this will create a VKD.386 file).

<P><LI>Copy VKD.386 to the Windows system directory (by default this is
   the \WINDOWS\SYSTEM directory).

<P><LI>Modify the SYSTEM.INI file to change the "keyboard=*vkd" under the
   [386enh] section to read:
<P>
<P><PRE>      keyboard=VKD.386
</PRE>
<P><LI>Exit Windows and restart. The corrected VKD will be loaded.
<P></OL>

	</FONT>
	</TD>
	</TR>
</TABLE>
<P>


<!--DOCBODY_END-->

<!--FOOTER_START-->
<table cellpadding=5 border=0 width="90%">
<tr>
<td>
	<HR WIDTH="90%">

<BLOCKQUOTE>
<FONT FACE="Verdana, Arial, Helvetica" SIZE="1">
<SPAN STYLE="font-family:verdana,arial,helvetica; font-size:8pt">
Additional reference words: 3.00<BR>
KBCategory: kbprg kbbuglist<BR>
KBSubcategory: D3KbVkdforce<BR>

</SPAN>
</FONT>
<BR>
<BR>
THE INFORMATION PROVIDED IN THE MICROSOFT KNOWLEDGE BASE IS
PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND.  MICROSOFT DISCLAIMS
ALL WARRANTIES, EITHER EXPRESS OR IMPLIED, INCLUDING THE WARRANTIES
OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  IN NO
EVENT SHALL MICROSOFT CORPORATION OR ITS SUPPLIERS BE LIABLE FOR
ANY DAMAGES WHATSOEVER INCLUDING DIRECT, INDIRECT, INCIDENTAL,
CONSEQUENTIAL, LOSS OF BUSINESS PROFITS OR SPECIAL DAMAGES, EVEN IF
MICROSOFT CORPORATION OR ITS SUPPLIERS HAVE BEEN ADVISED OF THE
POSSIBILITY OF SUCH DAMAGES.  SOME STATES DO NOT ALLOW THE EXCLUSION
OR LIMITATION OF LIABILITY FOR CONSEQUENTIAL OR INCIDENTAL DAMAGES
SO THE FOREGOING LIMITATION MAY NOT APPLY.
</BLOCKQUOTE>
<P>
<center>
	<FONT FACE="Verdana,Arial,Helvetica" SIZE="1">
	Last reviewed:  April 12, 1995</FONT>
	<BR>
	<A HREF="../cpyright.htm" STYLE="font: bold 7pt Verdana,Arial,Helvetica">&copy; 1998 Microsoft Corporation. All rights reserved. Terms of Use.</A><BR>
	
</center>
</td>
</tr>
</table>

<!--FOOTER_END-->
</FONT>
</BODY>
</HTML>
