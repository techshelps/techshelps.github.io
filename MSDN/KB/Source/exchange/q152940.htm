

<HTML>
<HEAD>
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-83731338-2"></script><script>  window.dataLayer = window.dataLayer || [];  function gtag(){dataLayer.push(arguments);}  gtag('js', new Date());  gtag('config', 'UA-83731338-2');</script><title>XFOR: IMC Stops Sending Mail, Fails to Release TCP Connection </TITLE>

<!--STYLE_BEGIN-->
<style>@import url(../../msdn_ie4.css);</style>
	<link disabled rel="stylesheet" href="../../msdn_ie3.css">
<!--STYLE_END-->

<META HTTP-EQUIV="CONTENT-Type" CONTENT="text/html; charset=us-ascii">
<META NAME="ms.locale" CONTENT="EN-US">
<META NAME="Category" CONTENT="Support; KB Article">
<META NAME="KBID" CONTENT="Q152940">
<META NAME="KBModify" CONTENT="1997/04/03">
<META NAME="KBCreate" CONTENT="1996/08/20">
<META NAME="Keywords" CONTENT="kb3rdparty kbinterop XFOR">
<META NAME="KBArea" CONTENT="Support; KB; exchange">
<META NAME="Description" CONTENT="  Microsoft Exchange Internet Mail Connector (IMC) may stop sending mail to a foreign SMTP host and fail to terminate the TCP connection until the MSExchangeIMC service is stopped and restarted.  CAUSE =====  An RFC821 SMTP protocol violation of inte...">
<META NAME="Product" CONTENT="Exchange">
<META NAME="Platform" CONTENT="Windows">
<META NAME="Technology" CONTENT=" ">
<META NAME="Premium" CONTENT="support">

<META NAME="nyms" CONTENT="QAIB,QAYC,QAH6,QAIA,QAYV,QBG2,QAML,QAGB,QAI5,QAEV,QAYY,QAH4,QAY2,QBXT,QA5V V02180118">
</HEAD>

<BODY BGCOLOR="#FFFFFF" LEFTMARGIN="0" RIGHTMARGIN="0" TOPMARGIN="0">


<!--DOCBODY_START-->
<BR>
<CENTER>
<TABLE BORDER="0" CELLPADDING="0" CELLSPACING="0" VALIGN="top" WIDTH="90%">
	<TR>
		<TD VALIGN="top">
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<H1>XFOR: IMC Stops Sending Mail, Fails to Release TCP Connection</H1>
			</FONT>
			<FONT FACE="verdana,arial,helvetica" SIZE="1">
			Last reviewed:  April 3, 1997</FONT><BR>
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<B>Article ID: Q152940</B>
			</FONT>
		</TD>
	</TR>
	<TR>
	<TD>
	<FONT FACE="Verdana, Arial, Helvetica" SIZE=2>



 
 
The information in this article applies to:

<UL><LI>Microsoft Exchange Server, version 4.0
</UL> 
<P>
<P><h2>SYMPTOMS</h2>
 
<P>
Microsoft Exchange Internet Mail Connector (IMC) may stop sending mail to a
foreign SMTP host and fail to terminate the TCP connection until the
MSExchangeIMC service is stopped and restarted.
<P>
<P><h2>CAUSE</h2>
 
<P>
An RFC821 SMTP protocol violation of interrupting the IMC's transmission of
SMTP message DATA may cause an IMC thread to become blocked. Depending on
how the target host requests the connection be closed (FIN or RST), the
connection may remain open.
<P>
<P><h2>WORKAROUND</h2>
 
<P>
This SMTP protocol violation can be avoided by configuring the IMC to
restrict maximum message size on a "per domain" basis. This option is
configured in Exchange Administrator, "&lt;Internet Mail Connector&gt;.Internet
Mail.Email Domain.Add.Maximum Size (KB):"
<P>
It is prudent to configure this setting when communicating with foreign
SMTP hosts that have a maximum inbound message size limit, for the
followingreasons:

<UL><LI>It avoids the issue described in this article.

<LI>A non-delivery report (NDR) is returned to the originator of the message
   informing them of the limitation *before* the IMC attempts to send the
   large message. This results in more efficient IMC performance.
<P>
</UL><h2>MORE INFORMATION</h2>
 
<P>
Proper behavior for conversations between SMTP mail hosts is documented in
RFC821. In cases where these symptoms (listed under SYMPTOMS above) have
been observed, the target SMTP host interrupts the IMC's DATA transmission
with a 552 error (sender's message has exceeded fixed maximum message
size).
<P>
While this is a valid error message, the fact that it is returned to the
IMC in the middle of the transmission of the DATA portion of a message is a
protocol violation. In the case of an error during the DATA transmission,
it is the target's responsibility to continue accepting the message
(discarding received data if necessary), and *after completion,* return the
reply code for the DATA command to the sending side.
<P>
The following sections from RFC821 detail the specifics for this issue:
<P>
<PRE>   4.2, paragraph 1, "... Every command must generate exactly one reply."

  4.3, "Command-reply" sequence for DATA diagrammed

   4.4, State diagram for DATA - Notes: "Note that the data here is a
   series of lines sent from the sender to the receiver with no response
   expected until the last line sent."

</PRE>Example (successful) SMTP Conversation:
<P>
I = IMC (initiator), T= Target (receiver)
<P>
<PRE>    T: &lt;waiting for connection on TCP port 25&gt;
    I: &lt;open connection to target&gt;
    T: 220 tin.pan.alley.com SMTP service ready
    I: HELO cartoonville.com
    T: 250 tin.pan.alley.com says hello to cartoonville.com
    I: MAIL FROM: &lt;clem@cartoonville.com&gt;
    T: 250 sender OK
    I: RCPT TO: &lt;ditty@tin.pan.alley.com&gt;
    T: 250 Recipient OK
</PRE>x   I: DATA
<PRE>    T: 354 Enter mail, end with "." on a line by itself
</PRE>*   I: **** IMC begins sending a message header and body, and according to
<PRE>    I: RFC821, 4.4, "Note that the data here is a series of lines sent from
    I: the sender to the receiver with no response expected until the last
    I: line sent." The last line sent is signified by "." on a line by
    I: itself - which is coming up next (note: this DATA content portion is
    I: not usually logged)****
</PRE>*   I: .
y   T: 250 message sent
<PRE>    I: QUIT
    T: 221 tin.pan.alley.com closing connection
    I: &lt;Closes connection&gt;
    T: &lt;closes connection&gt;

</PRE>Notice that once the DATA command (x) has been positively acknowledged, the
IMC expects to send the message data uninterrupted (lines between
asterisks, inclusive) until it signifies the last line (the last asterisk).
Then the following line (y) is the appropriate point at which success or
error codes should be returned from the target.
<P>
Example network trace summary (failure):
<P>
<PRE>3076    IMC &gt;&gt;&gt; Target     SMTP
</PRE>Data - continued from frame 3074, 536 bytes
<PRE> (IMC is sending DATA)
3077    Target &gt;&gt;&gt; IMC     TCP
.A...., len:    0, seq:1417586500-1417586500, ack: 136770891, win:  967
 (Target ACKs the DATA)
3078    IMC &gt;&gt;&gt; Target     SMTP
</PRE>Data - continued from frame 3076, 536 bytes
(sending more)
<PRE>3079    Target &gt;&gt;&gt; IMC     TCP
.A...., len:    0, seq:1417586500-1417586500, ack: 136771427, win:  967
</PRE>(ACK'd)
<PRE>3080    IMC &gt;&gt;&gt; Target     SMTP
</PRE>Data - continued from frame 3078, 536 bytes
(sending more - IMC is not finished sending DATA yet)
<PRE>3081    Target &gt;&gt;&gt; IMC     SMTP
</PRE>Rsp: Requested mail action aborted: exceeded storage allocation, 54 bytes
(frame 3081 is the first protocol violation - this frame contains the 552
error code)
<PRE>3082    Target &gt;&gt;&gt; IMC     SMTP
</PRE>Rsp: Service not available, closing transmission channel, 46 bytes
(this frame is another protocol violation - this frame contains a 421 error
code "service unavailable")
<PRE>3083    Target &gt;&gt;&gt; IMC     TCP
.A...F, len:    0, seq:1417586599-1417586599, ack: 136771427, win:  967
</PRE>(this is a TCP FIN frame. See below)
<PRE>3084    IMC &gt;&gt;&gt; Target     TCP
.A...., len:    0, seq: 136771963-136771963, ack:1417586599, win: 8254
</PRE>(this is a TCP ACK frame, which ACKs through frame 3082)
<PRE>3085    IMC &gt;&gt;&gt; Target     TCP
.A...., len:    0, seq: 136771963-136771963, ack:1417586600, win: 8254
</PRE>(this is another TCP ACK frame, ACKing frame 3083, the Target's FIN)
<P>
In frame 3080, the IMC is still sending more message DATA. In frame 3081 &amp;
3082 the target interrupts this send, returning SMTP error codes. The
target should wait until the IMC completed sending DATA before returning
these codes.
<P>
It has also been noted that receiving a FIN from the target may not
terminate the TCP connection. The procedure for closing a TCP connection is
documented in section 3.5 of RFC793. It states:
<P>
<PRE>   The user who CLOSEs may continue to RECEIVE until he is told that the
   other side has CLOSED also.

</PRE>In the trace above, the target sends a FIN in frame 3083, which informs the
IMC that it should not expect more data from the target. This action is not
a TCP protocol violation. The IMC ACKs the FIN with frame 3085, and,
because it is in the middle of sending message DATA, resumes sending, which
is now blocked from the previous SMTP protocol violations (frames 3081 and
3082).
<P>
According to RFC793, the method to unconditionally abort a TCP connection
is by sending an RST [reset] frame. Note, however, that this defeats any
ability to provide a "reason" for the connection termination to the
applications using the connection.
<P>

	</FONT>
	</TD>
	</TR>
</TABLE>
<P>


<!--DOCBODY_END-->

<!--FOOTER_START-->
<table cellpadding=5 border=0 width="90%">
<tr>
<td>
	<HR WIDTH="90%">

<BLOCKQUOTE>
<FONT FACE="Verdana, Arial, Helvetica" SIZE="1">
<SPAN STYLE="font-family:verdana,arial,helvetica; font-size:8pt">
Additional query words: MSExchangeIMC<BR>
Keywords            : kb3rdparty kbinterop XFOR<BR>
Version             : 4.0 5.0<BR>
Platform            : WINDOWS<BR>

</SPAN>
</FONT>
<BR>
<BR>
THE INFORMATION PROVIDED IN THE MICROSOFT KNOWLEDGE BASE IS
PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND.  MICROSOFT DISCLAIMS
ALL WARRANTIES, EITHER EXPRESS OR IMPLIED, INCLUDING THE WARRANTIES
OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  IN NO
EVENT SHALL MICROSOFT CORPORATION OR ITS SUPPLIERS BE LIABLE FOR
ANY DAMAGES WHATSOEVER INCLUDING DIRECT, INDIRECT, INCIDENTAL,
CONSEQUENTIAL, LOSS OF BUSINESS PROFITS OR SPECIAL DAMAGES, EVEN IF
MICROSOFT CORPORATION OR ITS SUPPLIERS HAVE BEEN ADVISED OF THE
POSSIBILITY OF SUCH DAMAGES.  SOME STATES DO NOT ALLOW THE EXCLUSION
OR LIMITATION OF LIABILITY FOR CONSEQUENTIAL OR INCIDENTAL DAMAGES
SO THE FOREGOING LIMITATION MAY NOT APPLY.
</BLOCKQUOTE>
<P>
<center>
	<FONT FACE="Verdana,Arial,Helvetica" SIZE="1">
	Last reviewed:  April 3, 1997</FONT>
	<BR>
	<A HREF="../cpyright.htm" STYLE="font: bold 7pt Verdana,Arial,Helvetica">&copy; 1998 Microsoft Corporation. All rights reserved. Terms of Use.</A><BR>
	
</center>
</td>
</tr>
</table>

<!--FOOTER_END-->
</FONT>
</BODY>
</HTML>
