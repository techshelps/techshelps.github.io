

<HTML>
<HEAD>
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-83731338-2"></script><script>  window.dataLayer = window.dataLayer || [];  function gtag(){dataLayer.push(arguments);}  gtag('js', new Date());  gtag('config', 'UA-83731338-2');</script><title>FIX: Unexpected Vines IPC Msg Can Cause CPU Spin or Exception </TITLE>

<!--STYLE_BEGIN-->
<style>@import url(../../msdn_ie4.css);</style>
	<link disabled rel="stylesheet" href="../../msdn_ie3.css">
<!--STYLE_END-->

<META HTTP-EQUIV="CONTENT-Type" CONTENT="text/html; charset=us-ascii">
<META NAME="ms.locale" CONTENT="EN-US">
<META NAME="Category" CONTENT="Support; KB Article">
<META NAME="KBID" CONTENT="Q141853">
<META NAME="KBModify" CONTENT="1997/05/02">
<META NAME="KBCreate" CONTENT="1995/12/28">
<META NAME="Keywords" CONTENT="kb3rdparty kbbug4.21a kbinterop kbnetwork SSrvLan SSrvNet_Lib">
<META NAME="KBArea" CONTENT="Support; KB; sqlserver">
<META NAME="Description" CONTENT="BUG# NT: 12636 (4.21a)   The SQL Server Banyan network library can cause a CPU spin on SQL Server version 4.21a or an unhandled exception in SQL Server version 6.0 if it receives an unexpected Vines IPC message from any Banyan client.  When the CPU s...">
<META NAME="Product" CONTENT="SQL Server">
<META NAME="Platform" CONTENT="Windows">
<META NAME="Technology" CONTENT=" ">
<META NAME="Premium" CONTENT="support">

<META NAME="nyms" CONTENT="QABM,QAEV,QBFD,QAVZ,QAR4,QBHQ,QAYC,QBIO,QAH6,QDIO,QATR,QAM1,QBVX,QBVV,QBG2 V02180118">
</HEAD>

<BODY BGCOLOR="#FFFFFF" LEFTMARGIN="0" RIGHTMARGIN="0" TOPMARGIN="0">


<!--DOCBODY_START-->
<BR>
<CENTER>
<TABLE BORDER="0" CELLPADDING="0" CELLSPACING="0" VALIGN="top" WIDTH="90%">
	<TR>
		<TD VALIGN="top">
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<H1>FIX: Unexpected Vines IPC Msg Can Cause CPU Spin or Exception</H1>
			</FONT>
			<FONT FACE="verdana,arial,helvetica" SIZE="1">
			Last reviewed:  May 2, 1997</FONT><BR>
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<B>Article ID: Q141853</B>
			</FONT>
		</TD>
	</TR>
	<TR>
	<TD>
	<FONT FACE="Verdana, Arial, Helvetica" SIZE=2>



<P><h3> </h3>
 
The information in this article applies to:

<UL><LI>Microsoft SQL Server, versions 4.21a and 6.0
</UL> 
BUG# NT: 12636 (4.21a)
<P>
<P><h2>SYMPTOMS</h2>
 
<P>
The SQL Server Banyan network library can cause a CPU spin on SQL Server
version 4.21a or an unhandled exception in SQL Server version 6.0 if
it receives an unexpected Vines IPC message from any Banyan client.
<P>
When the CPU spin occurs, all connections through the Banyan net library
are disabled. However, you can still connect to SQL Server using other
network libraries. On a single processor computer, the server will appear
to be very sluggish, and on a symmetric multiprocessor (SMP) computer, only
one CPU is tied up and the server will continue to be fairly responsive.
<P>
SQL Server must be shut down and restarted to restore Banyan net library
connectivity.
<P>
<P><h2>CAUSE</h2>
 
<P>
When SQL Server's Banyan SPP socket receives an IPC message, it tries to
"flush" it. However, in 4.21a, when we try to discard the message, one of
the parameters we use with VnsSocketReceive to flush this message is
SO_CREC and this, as documented by Banyan, is supported only by the SPP
service. Because we are dealing with an IPC message, not SPP data, we are
unable to flush this message and thus caught in a loop trying repeatedly to
flush the same IPC message.
<P>
For SQL Server 6.0, we are not caught in a loop because the first time we
try to flush this IPC message, SQL Server generates an unhandled exception.
In version 4.21a, when we flush the message, we initialize the Vines
connection identifier (cid) to zero; in version 6.0, we initialize the cid
to a variable in a data structure whose address is stored in a pointer.
Unfortunately, the pointer to the data structure in most cases is a null
pointer.
<P>
<P>
<P><h2>WORKAROUND</h2>
 
<P>
Use other SQL Server net libraries, such as TCP/IP sockets or Named Pipes.
There is no other known workaround for this problem.
<P>
<P><h2>STATUS</h2>
 
<P>
Microsoft has confirmed this to be a problem in Microsoft SQL Server
versions 4.21a and 6.0. This problem was corrected in a hot fix release.
Contact your primary support provider to obtain the hot fix or for more
information.
<P>
<P><h2>MORE INFORMATION</h2>
 
<P>
SQL Server uses the connection-oriented SPP service provided by the Vines
Transport Layer to communicate with any Banyan network clients. Once this
SPP socket is opened by SQL Server, it can theoretically be used for Vines'
IPC communication also.
<P>
IPC Service, provided also by Vines Transport Layer, can be used to send
both unreliable datagrams and reliable messages. Applications using SQL
Server Banyan client side net library use an IPC datagram to communicate
with the Banyan server to enumerate SQL Servers available on the network.
<P>
However, IPC messages are not sent by SQL Server Banyan client-side net
library directly to SQL Server. Because the server-side net library never
expects to receive an IPC message, it is unable to get rid of this message
when it receives one, and thus leads to the CPU spin as described above.
<P>

	</FONT>
	</TD>
	</TR>
</TABLE>
<P>


<!--DOCBODY_END-->

<!--FOOTER_START-->
<table cellpadding=5 border=0 width="90%">
<tr>
<td>
	<HR WIDTH="90%">

<BLOCKQUOTE>
<FONT FACE="Verdana, Arial, Helvetica" SIZE="1">
<SPAN STYLE="font-family:verdana,arial,helvetica; font-size:8pt">
Additional query words: sql6 Banyan Vines CPU SPIN hotfix<BR>
Keywords            : kb3rdparty kbbug4.21a kbinterop kbnetwork SSrvLan SSrvNet_Lib<BR>
Version             : 4.21a 6.0<BR>
Platform            : WINDOWS<BR>
Resolution Type     : kbfix<BR>

</SPAN>
</FONT>
<BR>
<BR>
THE INFORMATION PROVIDED IN THE MICROSOFT KNOWLEDGE BASE IS
PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND.  MICROSOFT DISCLAIMS
ALL WARRANTIES, EITHER EXPRESS OR IMPLIED, INCLUDING THE WARRANTIES
OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  IN NO
EVENT SHALL MICROSOFT CORPORATION OR ITS SUPPLIERS BE LIABLE FOR
ANY DAMAGES WHATSOEVER INCLUDING DIRECT, INDIRECT, INCIDENTAL,
CONSEQUENTIAL, LOSS OF BUSINESS PROFITS OR SPECIAL DAMAGES, EVEN IF
MICROSOFT CORPORATION OR ITS SUPPLIERS HAVE BEEN ADVISED OF THE
POSSIBILITY OF SUCH DAMAGES.  SOME STATES DO NOT ALLOW THE EXCLUSION
OR LIMITATION OF LIABILITY FOR CONSEQUENTIAL OR INCIDENTAL DAMAGES
SO THE FOREGOING LIMITATION MAY NOT APPLY.
</BLOCKQUOTE>
<P>
<center>
	<FONT FACE="Verdana,Arial,Helvetica" SIZE="1">
	Last reviewed:  May 2, 1997</FONT>
	<BR>
	<A HREF="../cpyright.htm" STYLE="font: bold 7pt Verdana,Arial,Helvetica">&copy; 1998 Microsoft Corporation. All rights reserved. Terms of Use.</A><BR>
	
</center>
</td>
</tr>
</table>

<!--FOOTER_END-->
</FONT>
</BODY>
</HTML>
