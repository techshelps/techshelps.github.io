

<HTML>
<HEAD>
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-83731338-2"></script><script>  window.dataLayer = window.dataLayer || [];  function gtag(){dataLayer.push(arguments);}  gtag('js', new Date());  gtag('config', 'UA-83731338-2');</script><title>BUG: Unhandled Exception in SQL Server Using Keyset Cursors </TITLE>

<!--STYLE_BEGIN-->
<style>@import url(../../msdn_ie4.css);</style>
	<link disabled rel="stylesheet" href="../../msdn_ie3.css">
<!--STYLE_END-->

<META HTTP-EQUIV="CONTENT-Type" CONTENT="text/html; charset=us-ascii">
<META NAME="ms.locale" CONTENT="EN-US">
<META NAME="Category" CONTENT="Support; KB Article">
<META NAME="KBID" CONTENT="Q166233">
<META NAME="KBModify" CONTENT="1997/04/16">
<META NAME="KBCreate" CONTENT="1997/04/01">
<META NAME="Keywords" CONTENT="kbbug6.50 SSrvGPF SSrvRep buglist2.01">
<META NAME="KBArea" CONTENT="Support; KB; sqlserver">
<META NAME="Description" CONTENT="BUG #: 16560 (Windows NT: 6.50)   SQL Server seems to stop responding and becomes unresponsive when running cursor queries that require keyset cursors. The errorlog indicates an access violation (AV) and the following error:     closetable: table alr...">
<META NAME="Product" CONTENT="SQL Server">
<META NAME="Platform" CONTENT="Windows">
<META NAME="Technology" CONTENT=" ">
<META NAME="Premium" CONTENT="support">

<META NAME="nyms" CONTENT="QABM,QAO2,QBXS,QAB4,QAI5,QABA,QAKP,QAAP,QAKC,QACK,QDKW,QBWS,QBWP,QBC6,QAXB V02180118">
</HEAD>

<BODY BGCOLOR="#FFFFFF" LEFTMARGIN="0" RIGHTMARGIN="0" TOPMARGIN="0">


<!--DOCBODY_START-->
<BR>
<CENTER>
<TABLE BORDER="0" CELLPADDING="0" CELLSPACING="0" VALIGN="top" WIDTH="90%">
	<TR>
		<TD VALIGN="top">
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<H1>BUG: Unhandled Exception in SQL Server Using Keyset Cursors</H1>
			</FONT>
			<FONT FACE="verdana,arial,helvetica" SIZE="1">
			Last reviewed:  April 16, 1997</FONT><BR>
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<B>Article ID: Q166233</B>
			</FONT>
		</TD>
	</TR>
	<TR>
	<TD>
	<FONT FACE="Verdana, Arial, Helvetica" SIZE=2>



 
 
The information in this article applies to

<UL><LI>Microsoft SQL Server, version 6.5
</UL> 
BUG #: 16560 (Windows NT: 6.50)
<P>
<P><h2>SYMPTOMS</h2>
 
<P>
SQL Server seems to stop responding and becomes unresponsive when running
cursor queries that require keyset cursors. The errorlog indicates an
access violation (AV) and the following error:
<P>
<PRE>   closetable: table already closed for sdes '%*.d'

</PRE>There is no message in the errorlog about SQL Server being shut down. The
client receives the following error:
<P>
<PRE>   Error 10037
   Unexpected EOF from SQL Server.  Connection broken.

</PRE><h2>CAUSE</h2>
 
<P>
SQL Server version 6.5 introduced the asynchronous generation of keysets
for keyset cursors, using "subprocess." The optimizer decides the number of
records in the result set based on the statistics information, and if this
number is within the cursor threshold, the keyset values are generated
synchronously. When this number exceeds the "cursor threshold" setting, it
uses asynchronous generation of keysets by forking a "subprocess" to
populate the keyset cursor. When the subprocess completes, it closes itself
and while doing so, it generates an access violation that is not completely
handled.
<P>
<P><h2>WORKAROUND</h2>
 
<P>
To work around this problem, either set the "cursor threshold"
configuration parameter to a higher value, or set it to the default setting
of -1 (all cursors will be generated synchronously). Running update
statistics to have latest distribution information may help the optimizer
determine the result set more accurately.
<P>
<P><h2>STATUS</h2>
 
<P>
Microsoft has confirmed this to be a problem in Microsoft SQL Server
version 6.5. We are researching this problem and will post new
information here in the Microsoft Knowledge Base as it becomes available.
<P>
If any replication-related process runs into the above scenario,
Sqlexec.exe also generates an unhandled exception error before
Sqlservr.exe. Otherwise, if the SQLExecutive service is set to restart the
MSSQLServer service, the service will be restarted and the client gets the
following error message:
<P>
<PRE>   Unexpected EOF from SQL Server. Connection Broken.

</PRE>If the server is restarted automatically by SQLExecutive service,
errorlog.1 will contain the above information.
<P>

	</FONT>
	</TD>
	</TR>
</TABLE>
<P>


<!--DOCBODY_END-->

<!--FOOTER_START-->
<table cellpadding=5 border=0 width="90%">
<tr>
<td>
	<HR WIDTH="90%">

<BLOCKQUOTE>
<FONT FACE="Verdana, Arial, Helvetica" SIZE="1">
<SPAN STYLE="font-family:verdana,arial,helvetica; font-size:8pt">
Additional query words: GPF terminate die hang freeze lock<BR>
Keywords            : kbbug6.50 SSrvGPF SSrvRep buglist2.01<BR>
Version             : 6.5<BR>
Platform            : WINDOWS<BR>
Issue type          : kbbug<BR>
Resolution Type     : kbpending<BR>

</SPAN>
</FONT>
<BR>
<BR>
THE INFORMATION PROVIDED IN THE MICROSOFT KNOWLEDGE BASE IS
PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND.  MICROSOFT DISCLAIMS
ALL WARRANTIES, EITHER EXPRESS OR IMPLIED, INCLUDING THE WARRANTIES
OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  IN NO
EVENT SHALL MICROSOFT CORPORATION OR ITS SUPPLIERS BE LIABLE FOR
ANY DAMAGES WHATSOEVER INCLUDING DIRECT, INDIRECT, INCIDENTAL,
CONSEQUENTIAL, LOSS OF BUSINESS PROFITS OR SPECIAL DAMAGES, EVEN IF
MICROSOFT CORPORATION OR ITS SUPPLIERS HAVE BEEN ADVISED OF THE
POSSIBILITY OF SUCH DAMAGES.  SOME STATES DO NOT ALLOW THE EXCLUSION
OR LIMITATION OF LIABILITY FOR CONSEQUENTIAL OR INCIDENTAL DAMAGES
SO THE FOREGOING LIMITATION MAY NOT APPLY.
</BLOCKQUOTE>
<P>
<center>
	<FONT FACE="Verdana,Arial,Helvetica" SIZE="1">
	Last reviewed:  April 16, 1997</FONT>
	<BR>
	<A HREF="../cpyright.htm" STYLE="font: bold 7pt Verdana,Arial,Helvetica">&copy; 1998 Microsoft Corporation. All rights reserved. Terms of Use.</A><BR>
	
</center>
</td>
</tr>
</table>

<!--FOOTER_END-->
</FONT>
</BODY>
</HTML>
