

<HTML>
<HEAD>
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-83731338-2"></script><script>  window.dataLayer = window.dataLayer || [];  function gtag(){dataLayer.push(arguments);}  gtag('js', new Date());  gtag('config', 'UA-83731338-2');</script><title>High Rate of Collisions on 100-MB Networks </TITLE>

<!--STYLE_BEGIN-->
<style>@import url(../../msdn_ie4.css);</style>
	<link disabled rel="stylesheet" href="../../msdn_ie3.css">
<!--STYLE_END-->

<META HTTP-EQUIV="CONTENT-Type" CONTENT="text/html; charset=us-ascii">
<META NAME="ms.locale" CONTENT="EN-US">
<META NAME="Category" CONTENT="Support; KB Article">
<META NAME="KBID" CONTENT="Q169789">
<META NAME="KBModify" CONTENT="1997/10/13">
<META NAME="KBCreate" CONTENT="1997/06/09">
<META NAME="Keywords" CONTENT="nthw NTSrvWkst nttcp kbnetwork">
<META NAME="KBArea" CONTENT="Support; KB; winnt, crossnet, iis">
<META NAME="Description" CONTENT=" IMPORTANT: This article contains information about editing the registry. Before you edit the registry, make sure you understand how to restore it if a problem occurs. For information about how to do this, view the  Restoring the Registry  Help topic...">
<META NAME="Product" CONTENT="Windows NT">
<META NAME="Platform" CONTENT="Windows">
<META NAME="Technology" CONTENT=" ">
<META NAME="Premium" CONTENT="support">

<META NAME="nyms" CONTENT="QARL,QBWP,QAH6,QAB7,QDNT,QAYY,QAKD,QAVZ,QBIC,QAIA,QALG,QAIB,QBFN,QAMR,QAL0 V02180118">
</HEAD>

<BODY BGCOLOR="#FFFFFF" LEFTMARGIN="0" RIGHTMARGIN="0" TOPMARGIN="0">


<!--DOCBODY_START-->
<BR>
<CENTER>
<TABLE BORDER="0" CELLPADDING="0" CELLSPACING="0" VALIGN="top" WIDTH="90%">
	<TR>
		<TD VALIGN="top">
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<H1>High Rate of Collisions on 100-MB Networks</H1>
			</FONT>
			<FONT FACE="verdana,arial,helvetica" SIZE="1">
			Last reviewed:  October 13, 1997</FONT><BR>
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<B>Article ID: Q169789</B>
			</FONT>
		</TD>
	</TR>
	<TR>
	<TD>
	<FONT FACE="Verdana, Arial, Helvetica" SIZE=2>



 
 
The information in this article applies to:

<UL><LI>Microsoft Windows NT Workstation versions 3.51 and 4.0
<LI>Microsoft Windows NT Server versions 3.51 and 4.0
</UL> 
<P>
IMPORTANT: This article contains information about editing the registry.
Before you edit the registry, make sure you understand how to restore it if
a problem occurs. For information about how to do this, view the "Restoring
the Registry" Help topic in Regedit.exe or the "Restoring a
Registry  Key" Help topic in Regedt32.exe.
<P>
<P><h2>SYMPTOMS</h2>
 
<P>
You may notice slow network performance while copying files when you are
using the TCP/IP protocol with a 100-MB network adapter. You may experience
this degraded performance while using Windows Explorer in Windows NT 4.0 or
the Copy command from a command prompt in Windows NT 3.51. Performance is
normal when using File Manager in Windows NT 3.51.
<P>
NOTE: Although the slow performance has been observed on several 100-MB
network cards, this problem is not specific to Windows NT.
<P>
<P><h2>CAUSE</h2>
 
<P>
The slow network performance is due to a high rate of early collisions on
the network. The interframe gap, the amount of time a workstation waits
before attempting to transmit on the wire, is lower than the IEEE 802.3
specification of 9.6 microseconds.
<P>
<P><h2>RESOLUTION</h2>
 
<P>
WARNING: Using Registry Editor incorrectly can cause serious problems that
may require you to reinstall your operating system. Microsoft cannot
guarantee that problems resulting from the incorrect use of Registry Editor
can be solved. Use Registry Editor at your own risk.
<P>
For information about how to edit the registry, view the "Changing Keys And
Values" Help topic in Registry Editor (Regedit.exe) or the "Add and Delete
Information in the Registry" and "Edit Registry Data" Help topics in
Regedt32.exe. Note that you should back up the registry before you edit it.

<UL><LI>To resolve this issue, contact your network adapter manufacturer for
   information about increasing the interframe gap. Intel EtherExpress 100B
   adapters have a registry parameter that controls the interframe gap. To
   modify this parameter, use the following steps:
<P>
   1. Start Registry Editor (Regedt32.exe).
   
   2. Go to the following subkey:
   
<PRE>         HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\
         Services\e100b"x"\Parameters
   
      where "x" is the number of your interface card.
   
   3. Click Edit, click Add Value, and enter the following information:

      Value Name: Adaptive_ifs
      Value Type: REG_DWORD
      Data: 1  (enable adaptive algorithm)

   The adaptive algorithm to detect collisions and tune the interframe gap
   is enabled by default. Setting it to 0 disables the adaptive algorithm.
   A value between 2 and 200 sets a predefined interframe gap. Measure
   collisions with this parameter set to intervals of 20 decimals (starting
   at 20), and choose a value that has a low collision rate and does not
   affect performance.

</PRE><LI>To work around this issue, you can tune the TcpWindowSize registry
   parameter so that the sender will wait to receive an ACK from the
   receiver before sending more data, thereby avoiding the potential for
   collision.
<P>
   The TcpWindowSize parameter normally does not exist in the registry, so
   it needs to be created using the following steps:
<P>
   WARNING: Using Registry Editor incorrectly can cause serious problems
   that may require you to reinstall your operating system. Microsoft
   cannot guarantee that problems resulting from the incorrect use of
   Registry Editor can be solved. Use Registry Editor at your own risk.
<P>
   For information about how to edit the registry, view the "Changing Keys
   And Values" Help topic in Registry Editor (Regedit.exe) or the "Add and
   Delete Information in the Registry" and "Edit Registry Data" Help topics
   in Regedt32.exe. Note that you should back up the registry before you
   edit it.
<P>
   1. Start Registry Editor (Regedt32.exe).
<P>
   2. Go to the following subkey:
   
<PRE>         HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\
         Services\Tcpip\Parameters

   3. Click Add, click Value, and enter the following information:
   
      Value Name: TcpWindowSize
      Value Type: REG_DWORD
      Data: 2920 (decimal) - Number of bytes
      Set it to Decimal 2920 for Ethernet (and two times the maximum TCP
      data size on other networks. This setting should not have to be
      modified for other networks, however, because Token Ring, FDDI, and
      so on, do not have collisions as Ethernet does).

   NOTE: Modifying this parameter could significantly affect performance.
   In general, on a WAN network or a regular 10-MB network, depending on
   the topology, there will be some latency between the sender and the
   receiver. Therefore, the potential for collisions due to TCP/IP ACKing
   behavior does not exist. Tuning TcpWindowSize in this case will only
   reduce throughput.

</PRE></UL>For additional information about TCP/IP, please see the following white
paper available on the Microsoft anonymous FTP server:
<P>
<PRE>   File Name: Tcpipimp2.doc
   Location : <B><A HREF="ftp://ftp.microsoft.com/bussys/winnt/winnt-docs/papers/">ftp://ftp.microsoft.com/bussys/winnt/winnt-docs/papers/</A></B>
   Title    : "TCP/IP Implementation Details"

</PRE><h2>MORE INFORMATION</h2>
 
<P>
A "collision" occurs when two stations transmit simultaneously on the wire.
An "early collision" is any collision that occurs before 512 bits of the
frame have been put onto the wire. Early collisions may occur regularly in
a normally operating Ethernet network. There is no hardware malfunction or
misbehaving station.
<P>
The IEEE 802.3 specification states that, before a station can attempt to
transmit on the wire, it must wait 9.6 microseconds (interframe gap).
Several adapter manufacturers have designed their cards with a smaller
interframe gap to achieve higher data transfer rates, which could lead to a
high rate of collisions.
<P>
This problem can be influenced by the behavior of the upper layer protocol.
The TCP/IP specification indicates that an ACK should be sent for every
other frame received. That is, when a TCP host receives two data frames, it
should then transmit an ACK to the sender. The potential for collisions to
occur is high when a client that has received two packets tries to send an
ACK while the sender may be trying to send more data to the client.
<P>
<P><h3>Analysis of Windows NT 3.51 File Manager File Copy</h3>
 
<P>
Under Windows NT 3.51, when you are copying files using File Manager, the
redirector performs only 4KB reads. The pattern of data transfer is shown
below, as captured using Network Monitor:
<P>
<PRE>18 CLIENT SERVER  SMB   C read &amp; X, FID = 0x804, Read 0x10c5
19 SERVER CLIENT  SMB   R read &amp; X, Read 0x10c5
20 SERVER CLIENT  NBT   SS: Session Message Cont., 1460 Bytes
21 SERVER CLIENT  NBT   SS: Session Message Cont., 1437 Bytes
22 CLIENT SERVER  TCP   .A...., len:    0, seq:585361-5851029

</PRE>At the TCP level:
<P>
<PRE>Frame 18: TCP: len:   64, seq: 585297-585360, ack:734154,
</PRE>&gt;Client sends 64 bytes of data (SMB Command to read 4KB);
<P>
Frame 19: TCP: len: 1460, seq: 734154-735613, ack:585361,
&gt;Server then sends back 1460 bytes of data (smb response + data), with a
piggybacked ACK indicating that it received all the data in frame 18.
<P>
<PRE>Frame 20: TCP: len: 1460, seq:    735614-737073, ack: 585361,
Frame 21: TCP: len: 1437, seq:    737074-738510, ack: 585361,
</PRE>&gt;Server then sends two more data frames and completes the 4KB transfer.
<P>
<PRE>Frame 22: TCP: len:    0, seq:    585361-585361, ack: 738511,
</PRE>&gt;Client sends an ACK for all the data that it received on these two frames.
<P>
Because the server has completed the 4-KB data transfer, it has no more
data to send. Therefore, potential for collision to occur does not exist.
<P>
<P><h3>Analysis of Windows NT 4.0 Windows Explorer File Copy</h3>
 
<P>
When the same file copy is initiated using a command prompt, or using
Windows Explorer in Windows NT 4.0, the pattern of data transfer is
different. In this case, the redirector issues a 60KB "bulk read" or "raw
read" (Windows NT 3.51). The data transfer pattern is shown below:
<P>
10 CLIENT SERVER  SMB C read &amp; X, FID = 0x1004, Read 0xf000
11 SERVER CLIENT  SMB R read &amp; X, Read 0xf000
12 SERVER CLIENT  NBT SS: Session Message Cont., 1460 Bytes
13 SERVER CLIENT  NBT SS: Session Message Cont., 1460 Bytes
14 SERVER CLIENT  NBT SS: Session Message Cont., 1460 Bytes
15 SERVER CLIENT  NBT SS: Session Message Cont., 1460 Bytes
16 CLIENT SERVER  TCP .A...., len: 0, seq:404791-404791, ack
17 CLIENT SERVER  TCP .A...., len: 0, seq:404791-404791, ack
18 SERVER CLIENT  NBT SS: Session Message Cont., 1460 Bytes
19 SERVER CLIENT  NBT SS: Session Message Cont., 1460 Bytes
20 SERVER CLIENT  NBT SS: Session Message Cont., 1460 Bytes
<P>
At the TCP level:
<P>
<PRE>10 CLIENT SERVER  TCP len:   64, seq: 404727-404790, ack:   6992081
</PRE>&gt;Client sends 64 bytes of data (SMB command to read 4KB);
<P>
<PRE>11 SERVER CLIENT  TCP len: 1460, seq: 6992081-6993540, ack:    404791
</PRE>&gt;Server sends the piggy back ACK, and the SMB response with some data;
<P>
<PRE>12 SERVER CLIENT  TCP len: 1460, seq: 6993541-6995000, ack:    404791
13 SERVER CLIENT  TCP len: 1460, seq: 6995001-6996460, ack:    404791
</PRE>&gt;Server sends rest of the data to the client.
<P>
&gt;**Collision likely at this point, because the client will try to send an
ACK.
<P>
<PRE>14 SERVER CLIENT  TCP len: 1460, seq: 6996461-6997920, ack:    404791
15 SERVER CLIENT  TCP len: 1460, seq: 6997921-6999380, ack:    404791
</PRE>&gt;But server is able to get the wire and send more data.
<P>
<PRE>16 CLIENT SERVER  TCP len:    0, seq: 404791-404791, ack:   6996461
</PRE>&gt;Client is able to get the wire and send the ACK for data on frames 12 and
13.
<P>
<PRE>17 CLIENT SERVER  TCP len:    0, seq: 404791-404791, ack:   6999381
</PRE>&gt;Client is able to get the wire and send the ACK for data on frames 14 and
15.
<P>
18 SERVER CLIENT  TCP len: 1460, seq: 6999381-7000840, ack: 404791
19 SERVER CLIENT  TCP len: 1460, seq: 7000841-7002300, ack: 404791
&gt;Server continues to send data.
<P>
&gt;**Collision likely at this point, because the client will try to send an
ACK.
<P>
20 SERVER CLIENT  TCP len: 1460, seq: 7002301-7003760, ack: 404791
&gt;But server is able to get the wire and send more data.
<P>
As mentioned earlier, when you use the TCP/IP protocol, TCP ACKing
influences the collision. However, the problem is not due to TCP/IP or the
enhancement for Windows Explorer to do 60KB bulk reads. The problem can be
illustrated using FTP also. TCP/IP, the redirector, and Windows Explorer
have absolutely no control over interframe gap. Interframe gap is at the
physical layer, which is controlled by the chipset on the adapter. If you
experience a high rate of collisions, please contact your network card
vendor.
<P>
Additional reference word: prodnt
 
<PRE>Keywords          : nthw NTSrvWkst nttcp kbnetwork
Version           : WinNT:3.51,4.0
Platform          : winnt</PRE>

	</FONT>
	</TD>
	</TR>
</TABLE>
<P>


<!--DOCBODY_END-->

<!--FOOTER_START-->
<table cellpadding=5 border=0 width="90%">
<tr>
<td>
	<HR WIDTH="90%">

<BLOCKQUOTE>
<FONT FACE="Verdana, Arial, Helvetica" SIZE="1">
<SPAN STYLE="font-family:verdana,arial,helvetica; font-size:8pt">
================================================================================<BR>

</SPAN>
</FONT>
<BR>
<BR>
THE INFORMATION PROVIDED IN THE MICROSOFT KNOWLEDGE BASE IS
PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND.  MICROSOFT DISCLAIMS
ALL WARRANTIES, EITHER EXPRESS OR IMPLIED, INCLUDING THE WARRANTIES
OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  IN NO
EVENT SHALL MICROSOFT CORPORATION OR ITS SUPPLIERS BE LIABLE FOR
ANY DAMAGES WHATSOEVER INCLUDING DIRECT, INDIRECT, INCIDENTAL,
CONSEQUENTIAL, LOSS OF BUSINESS PROFITS OR SPECIAL DAMAGES, EVEN IF
MICROSOFT CORPORATION OR ITS SUPPLIERS HAVE BEEN ADVISED OF THE
POSSIBILITY OF SUCH DAMAGES.  SOME STATES DO NOT ALLOW THE EXCLUSION
OR LIMITATION OF LIABILITY FOR CONSEQUENTIAL OR INCIDENTAL DAMAGES
SO THE FOREGOING LIMITATION MAY NOT APPLY.
</BLOCKQUOTE>
<P>
<center>
	<FONT FACE="Verdana,Arial,Helvetica" SIZE="1">
	Last reviewed:  October 13, 1997</FONT>
	<BR>
	<A HREF="../cpyright.htm" STYLE="font: bold 7pt Verdana,Arial,Helvetica">&copy; 1998 Microsoft Corporation. All rights reserved. Terms of Use.</A><BR>
	
</center>
</td>
</tr>
</table>

<!--FOOTER_END-->
</FONT>
</BODY>
</HTML>
