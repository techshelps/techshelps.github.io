

<HTML>
<HEAD>
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-83731338-2"></script><script>  window.dataLayer = window.dataLayer || [];  function gtag(){dataLayer.push(arguments);}  gtag('js', new Date());  gtag('config', 'UA-83731338-2');</script><title>Secure Channel Manipulation with TCP/IP </TITLE>

<!--STYLE_BEGIN-->
<style>@import url(../../msdn_ie4.css);</style>
	<link disabled rel="stylesheet" href="../../msdn_ie3.css">
<!--STYLE_END-->

<META HTTP-EQUIV="CONTENT-Type" CONTENT="text/html; charset=us-ascii">
<META NAME="ms.locale" CONTENT="EN-US">
<META NAME="Category" CONTENT="Support; KB Article">
<META NAME="KBID" CONTENT="Q181171">
<META NAME="KBModify" CONTENT="1998/03/10">
<META NAME="KBCreate" CONTENT="1998/02/16">
<META NAME="Keywords" CONTENT="ntdomain NTSrvWkst">
<META NAME="KBArea" CONTENT="Support; KB; winnt, crossnet, iis">
<META NAME="Description" CONTENT=" IMPORTANT: This article contains information about editing the registry. Before you edit the registry, make sure you understand how to restore it if a problem occurs. For information on how to do this, view the  Restoring the Registry  online Help t...">
<META NAME="Product" CONTENT="Windows NT">
<META NAME="Platform" CONTENT="Windows">
<META NAME="Technology" CONTENT=" ">
<META NAME="Security" CONTENT="PUBLIC ">
<META NAME="Premium" CONTENT="support">

<META NAME="nyms" CONTENT="QBWP,QAAD,QAK7,QABT,QABG,QA9A,QAVY,QAA1,QBII,QBW3,QDI2,QBXJ,QBKX,QAPN,QAMB V02180118">
</HEAD>

<BODY BGCOLOR="#FFFFFF" LEFTMARGIN="0" RIGHTMARGIN="0" TOPMARGIN="0">


<!--DOCBODY_START-->
<BR>
<CENTER>
<TABLE BORDER="0" CELLPADDING="0" CELLSPACING="0" VALIGN="top" WIDTH="90%">
	<TR>
		<TD VALIGN="top">
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<H1>Secure Channel Manipulation with TCP/IP</H1>
			</FONT>
			<FONT FACE="verdana,arial,helvetica" SIZE="1">
			Last reviewed:  March 10, 1998</FONT><BR>
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<B>Article ID: Q181171</B>
			</FONT>
		</TD>
	</TR>
	<TR>
	<TD>
	<FONT FACE="Verdana, Arial, Helvetica" SIZE=2>



 
 
The information in this article applies to:

<UL><LI>Microsoft Windows NT Workstation versions 3.51 and 4.0
<LI>Microsoft Windows NT Server versions 3.51 and 4.0
</UL> 
<P>
IMPORTANT: This article contains information about editing the registry.
Before you edit the registry, make sure you understand how to restore it if
a problem occurs. For information on how to do this, view the "Restoring
the Registry" online Help topic in Regedit.exe or the "Restoring a Registry
Key" online Help topic in Regedt32.exe.
<P>
<P><h2>SUMMARY</h2>
 
<P>
There are several processes on a Windows NT network that require
workstations and servers to establish a secure channel with a domain
controller. One of these processes is user validation. A common
misconception is that this secure channel will be formed with the nearest
domain controller. In reality, a computer running Windows NT Workstation or
Server will establish a secure channel with the first domain controller to
respond to a logon request. Because many factors contribute to the speed of
the response -- including network speed, work load, name resolution
methods, and WINS registration order -- it is quite possible for a secure
channel to be established with a domain controller several network hops
away. This is rarely desirable, and, therefore, it becomes necessary to
attempt to control the formation of secure channels.
<P>
This article will document five methods to control which domain controller
a secure channel is setup to.
<P>
<P><h2>RESOLUTION</h2>
 
<P>
<P><h3>Method 1: M-Node Name Resolution</h3>
 
<P>
Windows NT will always broadcast first to set up a secure channel; however,
we will not always wait the full time out period for a response. By
explicitly setting the Node type to Broadcast first (m-node), we will wait
longer and give the local domain controller more time to response to our
Secure Channel request. This method will only work if there is a domain
controller on our local subnet. If there is not, we will still query WINS
(if specified) for a list of domain controllers.
<P>
H-node is the default node type of a Windows NT client if a WINS address is
specified. Without a WINS address specified, modified b-node is the
default. H-node uses the WINS server first and then will broadcast for name
resolution. M-node will broadcast first on the local subnet.
<P>
WARNING: Using Registry Editor incorrectly can cause serious problems that
may require you to reinstall Windows. Microsoft cannot guarantee that
problems resulting from the incorrect use of Registry Editor can be
solved. Use Registry Editor at your own risk.
<P>
For information about how to edit the registry, view the "Changing Keys And
Values" online Help topic in Registry Editor (Regedit.exe) or the "Add and
Delete Information in the Registry" and "Edit Registry Data" online Help
topics in Regedt32.exe. Note that you should back up the registry before
you edit it.

<OL><P><LI>Run Regedt32 and navigate to the following key:
<P>
<P><PRE>      HKEY_LOCAL_MACHINE\Registry\Machine\System\CurrentControlSet\Services
      \NetBT\Parameters\NodeType
</PRE><P>
   NOTE: The above registry key is one path; it has been wrapped for
   readability.

<P><LI>Change it to 0x00000004 for mixed node or m-node.
<P>
   The possible values are:
<P>
<P><PRE>      0x00000008 for hybrid node or h-node
      0x00000004 for mixed node or m-node
      0x00000002 for point-to-point WINS or p-node
      0x00000001 for broadcast node or b-node
</PRE><P>
</OL>-or-
<P>
If the clients in question are using DHCP, use DHCP to change the
node type of DHCP clients. However, this will change the node type on all
computers serviced by that scope.
<P>
After you change the node type, restart the computer for the changes to
take effect.
<P>
<P><h3>Method 2: LMHOSTS File</h3>
 
<P>
When a computer running Windows NT sets up a secure channel, it will use
the NetBIOS 1C entry for the domain that it needs to contact. For a
computer running Windows NT Server or Workstation, this will be its own
domain. For a domain controller, it will need to contact all trusted
domains. To add a 1C for a preferred domain controller, verify that the
TCP/IP Enable LMHOSTS Lookup property is selected. Edit or create the
LMHOSTS file in the %SystemRoot%\system32\drivers\etc directory. Add an
entry for the domain with which you want to control the secure channel. The
entry should look like:
<P>
<PRE>   IP_ADDRESS_OF_DC  "DOMAIN         \0x1C" #PRE

</PRE></OL>The domain name must be padded with enough characters to make it 15
characters, there should be exactly 20 characters inside the quotes. To
avoid problems that may arise from non-ASCII characters and hidden
extensions, the use of Notepad.exe is discouraged. Edit.com is a true ASCII
editor, and its use is strongly recommended. The LMHOSTS file needs to have
several blank lines at the bottom.
<P>
When you are done, use NBTSTAT -R (must be capitalized) and then NBTSTAT -c
to verify that the entry is now in the NetBIOS cache.
<P>
When used by itself, we will have to restart the computer to establish a
new secure channel; however, an LMHOSTS file can be with the following
methods to point the secure channel to a desired server.
<P>
<P><h3>Method 3: NLTEST</h3>
 
<P>
NLTEST (included with the Windows NT Server 4.0 Resource Kit) will allow us
to determine who our secure channel is set up with and also to force it to
reestablish the secure channel. To determine who your secure channel is set
up with, type the following at a command prompt:
<P>
<PRE>   NLTEST /SC_QUERY:&lt;DOMAIN_NAME_TO_CHECK&gt;

</PRE>To reestablish a secure channel, use the parameter:
<P>
<PRE>   NLTEST /SC_RESET:&lt;DOMAIN_NAME_TO_RESET&gt;

</PRE>The first thing NLTEST does to reestablish a secure channel is query the
network for the 1C list for the domain. By using NLTEST and an LMHOSTS file
to preload a 1C entry for our preferred domain controller, we can control
who we will resolve the 1C entry to. NLTEST can also be used if the network
has been altered and the distant or slow domain controller would not be
chosen again.
<P>
You do not need to restart your computer when you use NLTEST.
<P>
<P><h3>Method 4: SETPRFDC</h3>
 
<P>
SETPRFDC is currently only available from Microsoft Technical Support, but
should be included in a future service pack. SETPRFDC uses additions to the
Netlogon.dll file to tell it who it should attempt to set up its secure
channel with.
<P>
Usage:
<P>
<PRE>   SETPRFDC &lt;TrustedDomain&gt; &lt;ListOfDcsInTrustedDomain&gt;

</PRE>SETPRFDC allows you to supply a list of domain controllers in the order you
would like them tried.
<P>
You do not need to restart your computer when you use SETPRFDC.
<P>
<P><h3>Method 5: NETDOM</h3>
 
<P>
NETDOM (included with the Windows NT Server 4.0 Resource Kit) allows us to
control many domain or account functions from the command line. Only the
ones concerning secure channels will be discussed here.
<P>
Type the following to reset a workstation or member server:
<P>
<PRE>   NETDOM /Domain:mydomain MEMBER mycomputer /JOINDOMAIN

</PRE>Type the following to reset a backup domain controller:
<P>
<PRE>   NETDOM BDC mybdc /RESET

</PRE>Type the following to reset a trust relationship:
<P>
<PRE>   NETDOM /Domain:MyResourceDomain /User:MyResourceDomain\AUser
   /Password:apassword MASTER MyMasterDomain MyPassword /TRUST

</PRE>NETDOM will also query for the 1C list when reestablishing the new secure
channel. If we preload our preferred domain controller in an LMHOSTS file,
we can control the location of the secure channel.
<P>
For more information on NETDOM, please see the Netdom.hlp file in the
Resource Kit.
<P>
<P><h2>MORE INFORMATION</h2>
 
<P>
For additional information, please see the following articles in the
Microsoft Knowledge Base:
<P>
TCP/IP Node Types:
<P>
<PRE>   ARTICLE-ID: <B><A HREF="../WINNT/Q167640.htm">Q167640</A></B>
   TITLE     : Automatically Changing the Node Type of a WinNT Wkst

</PRE>LMHOSTS Files:
<P>
<PRE>   ARTICLE-ID: <B><A HREF="../WINNT/Q101927.htm">Q101927</A></B>
   TITLE     : The LHMOSTS File for TCP/IP in Windows NT

   ARTICLE-ID: <B><A HREF="../WINNT/Q105997.htm">Q105997</A></B>
   TITLE     : Differences Between the HOSTS and LMHOSTS Files in Windows
               NT

   ARTICLE-ID: <B><A HREF="../WINNT/Q129218.htm">Q129218</A></B>
   TITLE     : How to Statically Initialize WINS with 0x1B for the PDC

</PRE>NLTEST:
<P>
<PRE>   ARTICLE-ID: <B><A HREF="../WINNT/Q156684.htm">Q156684</A></B>
   TITLE     : How to Use NLTEST to Force a New Secure Channel

   ARTICLE-ID: <B><A HREF="../WINNT/Q165202.htm">Q165202</A></B>
   TITLE     : WinNT Client Logon in Resource and Master Domain Environment

</PRE>NETDOM:
<P>
<PRE>   ARTICLE-ID: <B><A HREF="../WINNT/Q175024.htm">Q175024</A></B>
   TITLE     : Resetting Domain Member Secure Channel

   ARTICLE-ID: <B><A HREF="../WINNT/Q150518.htm">Q150518</A></B>
   TITLE     : NetLogon Service Fails when Secure Channel Not Functioning

   ARTICLE-ID: <B><A HREF="../WINNT/Q175025.htm">Q175025</A></B>
   TITLE     : How to Build and Reset a Trust Relationship from a Command
               Line
</PRE> 
<PRE>Keywords          : ntdomain NTSrvWkst
Version           : WinNT:3.51,4.0
Platform          : winnt
Issue type        : kbinfo</PRE>

	</FONT>
	</TD>
	</TR>
</TABLE>
<P>


<!--DOCBODY_END-->

<!--FOOTER_START-->
<table cellpadding=5 border=0 width="90%">
<tr>
<td>
	<HR WIDTH="90%">

<BLOCKQUOTE>
<FONT FACE="Verdana, Arial, Helvetica" SIZE="1">
<SPAN STYLE="font-family:verdana,arial,helvetica; font-size:8pt">
================================================================================<BR>

</SPAN>
</FONT>
<BR>
<BR>
THE INFORMATION PROVIDED IN THE MICROSOFT KNOWLEDGE BASE IS
PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND.  MICROSOFT DISCLAIMS
ALL WARRANTIES, EITHER EXPRESS OR IMPLIED, INCLUDING THE WARRANTIES
OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  IN NO
EVENT SHALL MICROSOFT CORPORATION OR ITS SUPPLIERS BE LIABLE FOR
ANY DAMAGES WHATSOEVER INCLUDING DIRECT, INDIRECT, INCIDENTAL,
CONSEQUENTIAL, LOSS OF BUSINESS PROFITS OR SPECIAL DAMAGES, EVEN IF
MICROSOFT CORPORATION OR ITS SUPPLIERS HAVE BEEN ADVISED OF THE
POSSIBILITY OF SUCH DAMAGES.  SOME STATES DO NOT ALLOW THE EXCLUSION
OR LIMITATION OF LIABILITY FOR CONSEQUENTIAL OR INCIDENTAL DAMAGES
SO THE FOREGOING LIMITATION MAY NOT APPLY.
</BLOCKQUOTE>
<P>
<center>
	<FONT FACE="Verdana,Arial,Helvetica" SIZE="1">
	Last reviewed:  March 10, 1998</FONT>
	<BR>
	<A HREF="../cpyright.htm" STYLE="font: bold 7pt Verdana,Arial,Helvetica">&copy; 1998 Microsoft Corporation. All rights reserved. Terms of Use.</A><BR>
	
</center>
</td>
</tr>
</table>

<!--FOOTER_END-->
</FONT>
</BODY>
</HTML>
