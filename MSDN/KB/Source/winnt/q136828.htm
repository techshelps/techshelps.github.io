

<HTML>
<HEAD>
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-83731338-2"></script><script>  window.dataLayer = window.dataLayer || [];  function gtag(){dataLayer.push(arguments);}  gtag('js', new Date());  gtag('config', 'UA-83731338-2');</script><title>ICMP Does Not Provide MTU Hint in ICMP Dest Unreachable, DF Set </TITLE>

<!--STYLE_BEGIN-->
<style>@import url(../../msdn_ie4.css);</style>
	<link disabled rel="stylesheet" href="../../msdn_ie3.css">
<!--STYLE_END-->

<META HTTP-EQUIV="CONTENT-Type" CONTENT="text/html; charset=us-ascii">
<META NAME="ms.locale" CONTENT="EN-US">
<META NAME="Category" CONTENT="Support; KB Article">
<META NAME="KBID" CONTENT="Q136828">
<META NAME="KBModify" CONTENT="1997/03/21">
<META NAME="KBCreate" CONTENT="1995/09/14">
<META NAME="Keywords" CONTENT="kbbug3.50 kbbug3.51 kbfix3.51.sp2 kbnetwork ntnetserv NTSrvWkst">
<META NAME="KBArea" CONTENT="Support; KB; winnt, crossnet, iis">
<META NAME="Description" CONTENT="  When you use computers running Windows NT as routers between media of different types, file transfers may start out slowly.  CAUSE =====  Windows NT 3.5 and 3.51 TCP/IP uses PMTU (Path Maximum Transfer Unit) discovery to determine the optimum TCP s...">
<META NAME="Product" CONTENT="Windows NT">
<META NAME="Platform" CONTENT="Windows">
<META NAME="Technology" CONTENT=" ">
<META NAME="Premium" CONTENT="support">

<META NAME="nyms" CONTENT="QBWP,QARL,QAH6,QASP,QDNL,QBW9,QDJP,QAKG,QBXS,QAI4,QAIB,QAIA,QAB7,QAH4,QDO3 V02180118">
</HEAD>

<BODY BGCOLOR="#FFFFFF" LEFTMARGIN="0" RIGHTMARGIN="0" TOPMARGIN="0">


<!--DOCBODY_START-->
<BR>
<CENTER>
<TABLE BORDER="0" CELLPADDING="0" CELLSPACING="0" VALIGN="top" WIDTH="90%">
	<TR>
		<TD VALIGN="top">
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<H1>ICMP Does Not Provide MTU Hint in ICMP Dest Unreachable, DF Set</H1>
			</FONT>
			<FONT FACE="verdana,arial,helvetica" SIZE="1">
			Last reviewed:  March 21, 1997</FONT><BR>
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<B>Article ID: Q136828</B>
			</FONT>
		</TD>
	</TR>
	<TR>
	<TD>
	<FONT FACE="Verdana, Arial, Helvetica" SIZE=2>



<P><h3> </h3>
 
The information in this article applies to:

<UL><LI>Microsoft Windows NT Workstation version 3.5 and 3.51
<LI>Microsoft Windows NT Server version 3.5 and 3.51
</UL> 
<P>
<P><h2>SYMPTOMS</h2>
 
<P>
When you use computers running Windows NT as routers between media of
different types, file transfers may start out slowly.
<P>
<P><h2>CAUSE</h2>
 
<P>
Windows NT 3.5 and 3.51 TCP/IP uses PMTU (Path Maximum Transfer Unit)
discovery to determine the optimum TCP segment size that can be used
for data transfers on a path between two computers. PMTU discovery is
described in RFC1191. Following is an excerpt from that RFC:
<P>
<PRE>   Router specification

   When a router is unable to forward a datagram because it exceeds the
   MTU of the next-hop network and its Don't Fragment bit is set, the
   router is required to return an ICMP Destination Unreachable message
   to the source of the datagram, with the Code indicating
   "fragmentation needed and DF set". To support the Path MTU Discovery
   technique specified in this memo, the router MUST include the MTU of
   that next-hop network in the low-order 16 bits of the ICMP header
   field that is labeled "unused" in the ICMP specification [7]. The
   high-order 16 bits remain unused, and MUST be set to zero. Thus, the
   message has the following format:

       0                   1                   2                   3
       0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |   Type = 3    |   Code = 4    |           Checksum            |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |           unused = 0          |         Next-Hop MTU          |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |      Internet Header + 64 bits of Original Datagram Data      |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+

</PRE>When a computer running Windows NT 3.5 or 3.51 is used as a router, it does
return the ICMP Destination Unreachable message; however it does not
include the MTU of the next-hop network. This forces the sending computer
to retransmit the data, guessing at the next-hop MTU. Because it can take
several guesses to determine the correct value, a small delay can occur.
<P>
The following trace, captured by Microsoft Network Monitor, illustrates
this behavior:
<P>
<PRE>#  Source Dest   Prot Description
</PRE> 
<P>
1  server client TCP  ....S., len: 4, seq:1286279, ack:0, win: 8192,
2  client server TCP  .A..S., len: 4, seq:659688, ack:1286280, win: 8760
3  server client TCP  .A...., len: 0, seq:1286280, ack:659689, win: 8760
4  client server FTP  Data Transfer To Server, Port = 1028, size 1460
5  router client ICMP Destination Unreachable, Destination: 199.199.40.14
6  client server TCP  .A...., len: 0, seq:643477, ack:1270209, win: 8558
7  client server FTP  Data Transfer To Server, Port = 1028, size 966
8  router client ICMP Destination Unreachable, Destination: 199.199.40.14
9  client server FTP  Data Transfer To Server, Port = 1028, size 468
10 server client TCP  .A...., len: 0, seq:1286280, ack:660157, win: 8292
11 client server FTP  Data Transfer To Server, Port = 1028, size 468
12 client server FTP  Data Transfer To Server, Port = 1028, size 468
13 server client TCP  .A...., len: 0, seq:1286280, ack:661093, win: 8760
14 client server FTP  Data Transfer To Server, Port = 1028, size 468
15 client server FTP  Data Transfer To Server, Port = 1028, size 468
 

<UL><LI>The first three frames show the 3-way handshake to set up the
   connection.

<LI>The fourth frame shows an attempt to send a 1460 byte TCP segment over
   the path (through a Windows NT 3.51 router).

<LI>The fifth frame shows the Windows NT 3.51 router returning an ICMP
   error, destination unreachable (fragmentation needed, but DF bit set)

<LI>The seventh frame shows the client trying a 966 byte segment. This is
   the next "likely" MSS (Maximum Segment Size) down from 1460.

<LI>The eighth frame is another ICMP destination unreachable message.

<LI>The ninth frame shows the client trying a 468 byte segment. This
   succeeds, and the transfer continues using that value.
<P>
</UL><h2>RESOLUTION</h2>
 
<P>
To correct this problem, upgrade to Windows NT 3.51 (if you have not
already done so) and install the latest U.S. Service Pack for Windows NT
version 3.51 or Windows NT 4.0
<P>
The ICMP code for Windows NT 3.51 and Windows NT 4.0 has been modified to
include the Next-Hop MTU correctly.
<P>
<P><h2>STATUS</h2>
 
<P>
Microsoft has confirmed this to be a problem in Windows NT version 3.5 and
<PRE>3.51.    This problem has been corrected in Windows NT 4.0 and the latest
  U.S.
</PRE>Service Pack for Windows NT version 3.51. For information on obtaining the
Service Pack, query on the following word in the Microsoft Knowledge Base
without the spaces):
<P>
<PRE>   S E R V P A C K
</PRE>

	</FONT>
	</TD>
	</TR>
</TABLE>
<P>


<!--DOCBODY_END-->

<!--FOOTER_START-->
<table cellpadding=5 border=0 width="90%">
<tr>
<td>
	<HR WIDTH="90%">

<BLOCKQUOTE>
<FONT FACE="Verdana, Arial, Helvetica" SIZE="1">
<SPAN STYLE="font-family:verdana,arial,helvetica; font-size:8pt">
Additional query words: prodnt<BR>
Keywords            : kbbug3.50 kbbug3.51 kbfix3.51.sp2 kbnetwork ntnetserv NTSrvWkst<BR>
Version             : 3.5 3.51<BR>
Platform            : WinNT<BR>

</SPAN>
</FONT>
<BR>
<BR>
THE INFORMATION PROVIDED IN THE MICROSOFT KNOWLEDGE BASE IS
PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND.  MICROSOFT DISCLAIMS
ALL WARRANTIES, EITHER EXPRESS OR IMPLIED, INCLUDING THE WARRANTIES
OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  IN NO
EVENT SHALL MICROSOFT CORPORATION OR ITS SUPPLIERS BE LIABLE FOR
ANY DAMAGES WHATSOEVER INCLUDING DIRECT, INDIRECT, INCIDENTAL,
CONSEQUENTIAL, LOSS OF BUSINESS PROFITS OR SPECIAL DAMAGES, EVEN IF
MICROSOFT CORPORATION OR ITS SUPPLIERS HAVE BEEN ADVISED OF THE
POSSIBILITY OF SUCH DAMAGES.  SOME STATES DO NOT ALLOW THE EXCLUSION
OR LIMITATION OF LIABILITY FOR CONSEQUENTIAL OR INCIDENTAL DAMAGES
SO THE FOREGOING LIMITATION MAY NOT APPLY.
</BLOCKQUOTE>
<P>
<center>
	<FONT FACE="Verdana,Arial,Helvetica" SIZE="1">
	Last reviewed:  March 21, 1997</FONT>
	<BR>
	<A HREF="../cpyright.htm" STYLE="font: bold 7pt Verdana,Arial,Helvetica">&copy; 1998 Microsoft Corporation. All rights reserved. Terms of Use.</A><BR>
	
</center>
</td>
</tr>
</table>

<!--FOOTER_END-->
</FONT>
</BODY>
</HTML>
