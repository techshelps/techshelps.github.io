

<HTML>
<HEAD>
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-83731338-2"></script><script>  window.dataLayer = window.dataLayer || [];  function gtag(){dataLayer.push(arguments);}  gtag('js', new Date());  gtag('config', 'UA-83731338-2');</script><title>BUG: Error in Requery When Set Null Date Parameter to Not Null </TITLE>

<!--STYLE_BEGIN-->
<style>@import url(../../msdn_ie4.css);</style>
	<link disabled rel="stylesheet" href="../../msdn_ie3.css">
<!--STYLE_END-->

<META HTTP-EQUIV="CONTENT-Type" CONTENT="text/html; charset=us-ascii">
<META NAME="ms.locale" CONTENT="EN-US">
<META NAME="Category" CONTENT="Support; KB Article">
<META NAME="KBID" CONTENT="Q166756">
<META NAME="KBModify" CONTENT="1997/07/31">
<META NAME="KBCreate" CONTENT="1997/04/10">
<META NAME="Keywords" CONTENT="MfcDatabase vcbuglist500 kbprg kbbuglist">
<META NAME="KBArea" CONTENT="Support; KB; visualc">
<META NAME="Description" CONTENT="  When you set a previously Null date parameter to no longer be Null, using either CRecordset::SetParamNull() or CRecordset::SetFieldNull(), it may cause a subsequent call to CRecordset::Requery() to generate the following exception:     Invalid stri...">
<META NAME="Product" CONTENT="Visual C++">
<META NAME="Platform" CONTENT="Windows">
<META NAME="Technology" CONTENT=" ">
<META NAME="Premium" CONTENT="support">

<META NAME="nyms" CONTENT="QAGI,QAHE,QAI4,QAY5,QAIF,QAH4,QAEF,QAKP,QACE,QBXS,QASR,QAPN,QALZ,QAGX,QAB9 V02180118">
</HEAD>

<BODY BGCOLOR="#FFFFFF" LEFTMARGIN="0" RIGHTMARGIN="0" TOPMARGIN="0">


<!--DOCBODY_START-->
<BR>
<CENTER>
<TABLE BORDER="0" CELLPADDING="0" CELLSPACING="0" VALIGN="top" WIDTH="90%">
	<TR>
		<TD VALIGN="top">
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<H1>BUG: Error in Requery When Set Null Date Parameter to Not Null</H1>
			</FONT>
			<FONT FACE="verdana,arial,helvetica" SIZE="1">
			Last reviewed:  July 31, 1997</FONT><BR>
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<B>Article ID: Q166756</B>
			</FONT>
		</TD>
	</TR>
	<TR>
	<TD>
	<FONT FACE="Verdana, Arial, Helvetica" SIZE=2>



 
 
The information in this article applies to:

<UL><LI>The Microsoft Foundation Classes (MFC) included with:
   - Microsoft Visual C++, 32-bit Editions, version 5.0
</UL> 
<P>
<P><h2>SYMPTOMS</h2>
 
<P>
When you set a previously Null date parameter to no longer be Null, using
either CRecordset::SetParamNull() or CRecordset::SetFieldNull(), it may
cause a subsequent call to CRecordset::Requery() to generate the following
exception:
<P>
<PRE>   Invalid string or buffer length

</PRE><h2>CAUSE</h2>
 
<P>
During a call to CRecordset::Open, no memory is allocated for a Null date
field. However, CRecordset::Requery expects the memory to exist.
<P>
<P><h2>RESOLUTION</h2>
 
<P>
Create a replacement for the RFX_Date function which always allocates
memory for the date field. See the MORE INFORMATION section.
<P>
<P><h2>STATUS</h2>
 
<P>
Microsoft has confirmed this to be a bug in the Microsoft products listed
at the beginning of this article. We are researching this bug and will post
new information here in the Microsoft Knowledge Base as it becomes
available.
<P>
<P><h2>MORE INFORMATION</h2>
 
<P>
This problem only occurs with the version of RFX_Date that takes a CTime
argument.
<P>
<P><h3>Steps to Reproduce Behavior</h3>
 
<P>
The following code displays the problem for a predefined query named
Query1, which takes one date parameter:
<P>
<PRE>    CMySet rs;
    try
    {
        rs.SetParamNull( 0, TRUE );
        rs.Open( CRecordset::snapshot, "{Call Query1(?)}" );
        rs.m_paramDate = CTime( 1996, 10, 13, 0, 0, 0 );
        rs.SetParamNull( 0, FALSE );
        rs.Requery();
    }
    catch( CDBException* e )
    {
        AfxMessageBox( e-&gt;m_strError );
        e-&gt;Delete();
    }
    rs.Close();


</PRE><h3>Steps to Replace the RFX_Date Function</h3>
 
<P>
The following steps detail one method of making the needed changes in
RFX_Date:

<OL><P><LI>Copy the implementation of RFX_Date() (DEVSTUDIO\VC\MFC\SRC\DBRFX.CPP)
   into a new .cpp file, and rename the function to something such as
   RFX_Date2(). Create a header file for the .cpp file and include that
   in your recordset .cpp file. Be sure to type:
<P>
<P><PRE>      #include "stdafx.h"
</PRE><P>
   at the top of your new .cpp file, and include the .cpp file in your
   project.

<P><LI>Change all RFX_Date() calls for date parameters in your recordset's
   DoFieldExchange() to calls to RFX_Date2().

<P><LI>In your new RFX_Date2() implementation, comment out the following
   lines, which appear under the CFieldExchange::BindParam case:
<P>
<P><PRE>       if (pFX-&gt;m_prs-&gt;IsParamStatusNull(nField - 1))
       {
<PRE></PRE>           pts = NULL;
           *plLength = SQL_NULL_DATA;
       }
       else

</PRE><P><LI>To reduce the amount of code, you may want to remove all of the cases
   from the select statement except the case for CFieldExchange::BindParam,
   and add the following lines to the top of your replacement function:
<P>
<P><PRE>       if( CFieldExchange::BindParam != pFX-&gt;m_nOperation ) {
<PRE></PRE>           RFX_Date(pFX, szName, value);
           return;
       }
</PRE></OL> 
<PRE>Keywords          : MfcDatabase vcbuglist500 kbprg kbbuglist
Technology        : kbMfc
Version           : 5.0
Platform          : NT WINDOWS</PRE>

	</FONT>
	</TD>
	</TR>
</TABLE>
<P>


<!--DOCBODY_END-->

<!--FOOTER_START-->
<table cellpadding=5 border=0 width="90%">
<tr>
<td>
	<HR WIDTH="90%">

<BLOCKQUOTE>
<FONT FACE="Verdana, Arial, Helvetica" SIZE="1">
<SPAN STYLE="font-family:verdana,arial,helvetica; font-size:8pt">
================================================================================<BR>

</SPAN>
</FONT>
<BR>
<BR>
THE INFORMATION PROVIDED IN THE MICROSOFT KNOWLEDGE BASE IS
PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND.  MICROSOFT DISCLAIMS
ALL WARRANTIES, EITHER EXPRESS OR IMPLIED, INCLUDING THE WARRANTIES
OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  IN NO
EVENT SHALL MICROSOFT CORPORATION OR ITS SUPPLIERS BE LIABLE FOR
ANY DAMAGES WHATSOEVER INCLUDING DIRECT, INDIRECT, INCIDENTAL,
CONSEQUENTIAL, LOSS OF BUSINESS PROFITS OR SPECIAL DAMAGES, EVEN IF
MICROSOFT CORPORATION OR ITS SUPPLIERS HAVE BEEN ADVISED OF THE
POSSIBILITY OF SUCH DAMAGES.  SOME STATES DO NOT ALLOW THE EXCLUSION
OR LIMITATION OF LIABILITY FOR CONSEQUENTIAL OR INCIDENTAL DAMAGES
SO THE FOREGOING LIMITATION MAY NOT APPLY.
</BLOCKQUOTE>
<P>
<center>
	<FONT FACE="Verdana,Arial,Helvetica" SIZE="1">
	Last reviewed:  July 31, 1997</FONT>
	<BR>
	<A HREF="../cpyright.htm" STYLE="font: bold 7pt Verdana,Arial,Helvetica">&copy; 1998 Microsoft Corporation. All rights reserved. Terms of Use.</A><BR>
	
</center>
</td>
</tr>
</table>

<!--FOOTER_END-->
</FONT>
</BODY>
</HTML>
