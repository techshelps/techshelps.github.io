

<HTML>
<HEAD>
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-83731338-2"></script><script>  window.dataLayer = window.dataLayer || [];  function gtag(){dataLayer.push(arguments);}  gtag('js', new Date());  gtag('config', 'UA-83731338-2');</script><title>PRB: Assert Error in BARTOOL.CPP line 398 </TITLE>

<!--STYLE_BEGIN-->
<style>@import url(../../msdn_ie4.css);</style>
	<link disabled rel="stylesheet" href="../../msdn_ie3.css">
<!--STYLE_END-->

<META HTTP-EQUIV="CONTENT-Type" CONTENT="text/html; charset=us-ascii">
<META NAME="ms.locale" CONTENT="EN-US">
<META NAME="Category" CONTENT="Support; KB Article">
<META NAME="KBID" CONTENT="Q131815">
<META NAME="KBModify" CONTENT="1997/07/31">
<META NAME="KBCreate" CONTENT="1995/06/20">
<META NAME="Keywords" CONTENT="MfcUI kbprb kbprg kbtshoot">
<META NAME="KBArea" CONTENT="Support; KB; visualc">
<META NAME="Description" CONTENT="  An Assert error occurs in BARTOOL.CPP, line 398 if a command handler for a toolbar button destroys the window that owns the toolbar.  CAUSE =====  The MFC implementation of CToolbar::OnLButtonUp() performs additional processing after invoking the c...">
<META NAME="Product" CONTENT="Visual C++">
<META NAME="Platform" CONTENT="Windows">
<META NAME="Technology" CONTENT=" ">
<META NAME="Premium" CONTENT="support">

<META NAME="nyms" CONTENT="QA5D,QAH4,QBV8,QAB9,QAEV,QAB5,QAF0,QANS,QAIB,QBXT,QBVV,QA5V,QAY5,QAX6,QALZ V02180118">
</HEAD>

<BODY BGCOLOR="#FFFFFF" LEFTMARGIN="0" RIGHTMARGIN="0" TOPMARGIN="0">


<!--DOCBODY_START-->
<BR>
<CENTER>
<TABLE BORDER="0" CELLPADDING="0" CELLSPACING="0" VALIGN="top" WIDTH="90%">
	<TR>
		<TD VALIGN="top">
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<H1>PRB: Assert Error in BARTOOL.CPP line 398</H1>
			</FONT>
			<FONT FACE="verdana,arial,helvetica" SIZE="1">
			Last reviewed:  July 31, 1997</FONT><BR>
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<B>Article ID: Q131815</B>
			</FONT>
		</TD>
	</TR>
	<TR>
	<TD>
	<FONT FACE="Verdana, Arial, Helvetica" SIZE=2>



 
2.00 2.10
WINDOWS NT
kbprg kbtshoot kbprb
<P>
 
The information in this article applies to:

<UL><LI>The Microsoft Foundation Classes included with:
   Microsoft Visual C++, 32-bit Edition, versions 2.0, 2.1
</UL> 
<P>
<P><h2>SYMPTOMS</h2>
 
<P>
An Assert error occurs in BARTOOL.CPP, line 398 if a command handler for a
toolbar button destroys the window that owns the toolbar.
<P>
<P><h2>CAUSE</h2>
 
<P>
The MFC implementation of CToolbar::OnLButtonUp() performs additional
processing after invoking the command handler implemented for that
particular toolbar button.
<P>
Specifically, the CToolbar::OnLButtonUp() function executes this code:
<P>
<PRE>   GetOwner()-&gt;SendMessage(WM_COMMAND, nIDCmd)

</PRE>This in turn immediatly executes the command handler. The OnLButtonUp()
function does more processing after sending the WM_COMMAND message.
<P>
If the execution of the command handler causes the toolbar to be destroyed,
then OnLButtonUp() attempts a call to SetButtonStyle(iButtonCapture,
nNewStyle) on a toolbar that no longer exists. This action leads to the
assertion failure.
<P>
<P><h2>RESOLUTION</h2>
 
<P>
Implement the command handler to post the message that eventually destroys
the toolbar. This way the toolbar is not destroyed until the execution of
OnLButtonUp is complete.
<P>
<P><h3>Example Scenario and Resolution</h3>
 
<P>
A popular scenario that leads to this assertion is implementing a toolbar
button that is intended to close a CFrameWnd window. For example, you
implement a command handler in the class derived from CFrameWnd to execute
the code SendMessage(WM_CLOSE). Executing this code immediately causes a
WM_CLOSE message to be sent to the frame window, which in turn destroys
that window and all the windows it owns, including the toolbar, thereby
causing the assertion.
<P>
A better implementation is to execute PostMessage(WM_CLOSE) in the toolbar
button's command handler. Then the WM_CLOSE message is posted at the end of
the message queue, and the OnLButtonUp() completes before the WM_CLOSE
message is handled.
<P>
<P><h2>MORE INFORMATION</h2>
 
<P>
This problem is specific to MFC versions 3.x, shipped with Visual C++,
32-bit Edition, versions 2.x. The CToolBar object of MFC versions previous
to 2.5 was not as sophisticated and did not provide the OnLButtonUp()
member function. The implementation of CToolbar::OnLButtonUp() in MFC
version 2.5 (16-bit) is slightly different from that of MFC version 3.0
(32-bit); in MFC version 2.5, GetOwner()-&gt;SendMessage(WM_COMMAND, nIDCmd)
is the last line of code in CToolbar::OnLButtonUp(). In MFC version 4.0
(shipped with Visual C++ version 4.0), the CToolBar object has been
redefined significantly and no longer supports the OnLButtonUp() function.
In addition, this redefinition produced a more robust CToolBar that does
not assert in the example scenario discussed above.
<P>
<P><h2>REFERENCES</h2>
 
<P>
For more information about this issue, see \MSVC20\MFC\SRC\BARTOOL.CPP.
<P>

	</FONT>
	</TD>
	</TR>
</TABLE>
<P>


<!--DOCBODY_END-->

<!--FOOTER_START-->
<table cellpadding=5 border=0 width="90%">
<tr>
<td>
	<HR WIDTH="90%">

<BLOCKQUOTE>
<FONT FACE="Verdana, Arial, Helvetica" SIZE="1">
<SPAN STYLE="font-family:verdana,arial,helvetica; font-size:8pt">
Additional reference words: 2.00 2.10 3.00 3.10 3.0 3.1<BR>
KBCategory: kbprg kbtshoot kbprb<BR>
KBSubcategory: MfcUI<BR>
Keywords          : MfcUI kbprb kbprg kbtshoot<BR>
Technology        : kbMfc<BR>
Version           : 2.00 2.10<BR>
Platform          : NT WINDOWS<BR>

</SPAN>
</FONT>
<BR>
<BR>
THE INFORMATION PROVIDED IN THE MICROSOFT KNOWLEDGE BASE IS
PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND.  MICROSOFT DISCLAIMS
ALL WARRANTIES, EITHER EXPRESS OR IMPLIED, INCLUDING THE WARRANTIES
OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  IN NO
EVENT SHALL MICROSOFT CORPORATION OR ITS SUPPLIERS BE LIABLE FOR
ANY DAMAGES WHATSOEVER INCLUDING DIRECT, INDIRECT, INCIDENTAL,
CONSEQUENTIAL, LOSS OF BUSINESS PROFITS OR SPECIAL DAMAGES, EVEN IF
MICROSOFT CORPORATION OR ITS SUPPLIERS HAVE BEEN ADVISED OF THE
POSSIBILITY OF SUCH DAMAGES.  SOME STATES DO NOT ALLOW THE EXCLUSION
OR LIMITATION OF LIABILITY FOR CONSEQUENTIAL OR INCIDENTAL DAMAGES
SO THE FOREGOING LIMITATION MAY NOT APPLY.
</BLOCKQUOTE>
<P>
<center>
	<FONT FACE="Verdana,Arial,Helvetica" SIZE="1">
	Last reviewed:  July 31, 1997</FONT>
	<BR>
	<A HREF="../cpyright.htm" STYLE="font: bold 7pt Verdana,Arial,Helvetica">&copy; 1998 Microsoft Corporation. All rights reserved. Terms of Use.</A><BR>
	
</center>
</td>
</tr>
</table>

<!--FOOTER_END-->
</FONT>
</BODY>
</HTML>
