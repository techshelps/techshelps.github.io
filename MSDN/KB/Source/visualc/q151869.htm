

<HTML>
<HEAD>
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-83731338-2"></script><script>  window.dataLayer = window.dataLayer || [];  function gtag(){dataLayer.push(arguments);}  gtag('js', new Date());  gtag('config', 'UA-83731338-2');</script><title>PRB: Incorrect Usage of CSingleLock May Lock Up Mutex Object </TITLE>

<!--STYLE_BEGIN-->
<style>@import url(../../msdn_ie4.css);</style>
	<link disabled rel="stylesheet" href="../../msdn_ie3.css">
<!--STYLE_END-->

<META HTTP-EQUIV="CONTENT-Type" CONTENT="text/html; charset=us-ascii">
<META NAME="ms.locale" CONTENT="EN-US">
<META NAME="Category" CONTENT="Support; KB Article">
<META NAME="KBID" CONTENT="Q151869">
<META NAME="KBModify" CONTENT="1997/07/31">
<META NAME="KBCreate" CONTENT="1996/05/30">
<META NAME="Keywords" CONTENT="MFCThreadIss kbprb kbprg">
<META NAME="KBArea" CONTENT="Support; KB; visualc">
<META NAME="Description" CONTENT="  The CSingleLock class can be used with a CMutex object. An attempt to free the Mutex object by making a call to the documented function CSingleLock::Unlock(LONG, LPLONG) locks up the Mutex. The Mutex is not released even when the CSingleLock object...">
<META NAME="Product" CONTENT="Visual C++">
<META NAME="Platform" CONTENT="Windows">
<META NAME="Technology" CONTENT=" ">
<META NAME="Premium" CONTENT="support">

<META NAME="nyms" CONTENT="QAGI,QAPN,QAJ6,QABT,QAW6,QAIF,QAYL,QAK7,QA4F,QAH4,QALQ,QBXS,QBWP,QBVV,QAY5 V02180118">
</HEAD>

<BODY BGCOLOR="#FFFFFF" LEFTMARGIN="0" RIGHTMARGIN="0" TOPMARGIN="0">


<!--DOCBODY_START-->
<BR>
<CENTER>
<TABLE BORDER="0" CELLPADDING="0" CELLSPACING="0" VALIGN="top" WIDTH="90%">
	<TR>
		<TD VALIGN="top">
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<H1>PRB: Incorrect Usage of CSingleLock May Lock Up Mutex Object</H1>
			</FONT>
			<FONT FACE="verdana,arial,helvetica" SIZE="1">
			Last reviewed:  July 31, 1997</FONT><BR>
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<B>Article ID: Q151869</B>
			</FONT>
		</TD>
	</TR>
	<TR>
	<TD>
	<FONT FACE="Verdana, Arial, Helvetica" SIZE=2>



 
4.10
WINDOWS NT
kbprg kbprb
<P>
 
The information in this article applies to:

<UL><LI>The Microsoft Foundation Classes (MFC) included with:
   Microsoft Visual C++, 32-bit Edition, version 4.1
</UL> 
<P>
<P><h2>SYMPTOMS</h2>
 
<P>
The CSingleLock class can be used with a CMutex object. An attempt to free
the Mutex object by making a call to the documented function
CSingleLock::Unlock(LONG, LPLONG) locks up the Mutex. The Mutex is not
released even when the CSingleLock object is destroyed.
<P>
Instead, the call to CSingleLock::Unlock(void) successfully frees the
Mutex.
<P>
<P><h2>CAUSE</h2>
 
<P>
There is a Boolean variable kept in the class CSingleLock - m_bAcquired.
This variable keeps track of the state of the synchronization object. In
the case of Mutexes, a value of TRUE (.T.) means that the Mutex object is
owned by a thread. The variable is set to FALSE (.F.) when the Mutex is
freed.
<P>
There are two versions of CSingleLock::Unlock and two versions for
CSyncObject::Unlock. One version takes no arguments, while the other one
takes two: LONG and LPLONG. CSingleLock::Unlock makes a call to
CSyncObject::Unlock only if the m_bAcquired member of CSingleLock is set to
TRUE.
<P>
Of the two versions of CSingleLock::Unlock, the latter version, with two
arguments, should be used only with CSingleLock associated with CSemaphore
objects. When used on a CSingleLock object associated with a CMutex, it
just returns TRUE. This value is interpreted by CSingleLock::Unlock as
though the object got freed and it sets its m_bAcquired member to FALSE.
This causes the Mutex to lock up, because any future calls to
CSingleLock::Unlock see m_bAcquired to be FALSE and the call to
CSyncObject::Unlock is not made. When CSingleLock's destructor gets called,
it calls Unlock. However, the same sequence of events prevents the Mutex
from being freed.
<P>
<P><h2>RESOLUTION</h2>
 
<P>
The first version of CSingleLock::Unlock, the one that takes no arguments,
should be used. This calls CSyncObject::Unlock(void). This is a virtual
function that calls CMutex::Unlock, that, in turn, calls ::ReleaseMutex to
free the Mutex object.
<P>
<P><h2>STATUS</h2>
 
<P>
This behavior is by design.
<P>
<P><h2>MORE INFORMATION</h2>
 
<P>
<P><h3>Sample Code</h3>
 
<P>
The following code demonstrates the problem:
<P>
<PRE>   //.......
        CSingleLock* sLock = new CSingleLock (&amp;GlobalMutex);
        sLock-&gt;Lock();
        //...
        sLock-&gt;Unlock(1);
        //...
        delete sLock;
   //.......

</PRE>This code should be changed to:
<P>
<PRE>   //......
        CSingleLock* sLock = new CSingleLock (&amp;GlobalMutex);
        sLock-&gt;Lock();
        //....
        sLock-&gt;Unlock();
        //...
        delete sLock;
   //.......
</PRE>

	</FONT>
	</TD>
	</TR>
</TABLE>
<P>


<!--DOCBODY_END-->

<!--FOOTER_START-->
<table cellpadding=5 border=0 width="90%">
<tr>
<td>
	<HR WIDTH="90%">

<BLOCKQUOTE>
<FONT FACE="Verdana, Arial, Helvetica" SIZE="1">
<SPAN STYLE="font-family:verdana,arial,helvetica; font-size:8pt">
Additional reference words: 4.10<BR>
KBCategory: kbprg kbprb<BR>
KBSubcategory: MfcThreadIss<BR>
Keywords          : MFCThreadIss kbprb kbprg<BR>
Technology        : kbMfc<BR>
Version           : 4.10<BR>
Platform          : NT WINDOWS<BR>

</SPAN>
</FONT>
<BR>
<BR>
THE INFORMATION PROVIDED IN THE MICROSOFT KNOWLEDGE BASE IS
PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND.  MICROSOFT DISCLAIMS
ALL WARRANTIES, EITHER EXPRESS OR IMPLIED, INCLUDING THE WARRANTIES
OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  IN NO
EVENT SHALL MICROSOFT CORPORATION OR ITS SUPPLIERS BE LIABLE FOR
ANY DAMAGES WHATSOEVER INCLUDING DIRECT, INDIRECT, INCIDENTAL,
CONSEQUENTIAL, LOSS OF BUSINESS PROFITS OR SPECIAL DAMAGES, EVEN IF
MICROSOFT CORPORATION OR ITS SUPPLIERS HAVE BEEN ADVISED OF THE
POSSIBILITY OF SUCH DAMAGES.  SOME STATES DO NOT ALLOW THE EXCLUSION
OR LIMITATION OF LIABILITY FOR CONSEQUENTIAL OR INCIDENTAL DAMAGES
SO THE FOREGOING LIMITATION MAY NOT APPLY.
</BLOCKQUOTE>
<P>
<center>
	<FONT FACE="Verdana,Arial,Helvetica" SIZE="1">
	Last reviewed:  July 31, 1997</FONT>
	<BR>
	<A HREF="../cpyright.htm" STYLE="font: bold 7pt Verdana,Arial,Helvetica">&copy; 1998 Microsoft Corporation. All rights reserved. Terms of Use.</A><BR>
	
</center>
</td>
</tr>
</table>

<!--FOOTER_END-->
</FONT>
</BODY>
</HTML>
