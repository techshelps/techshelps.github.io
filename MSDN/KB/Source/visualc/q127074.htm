

<HTML>
<HEAD>
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-83731338-2"></script><script>  window.dataLayer = window.dataLayer || [];  function gtag(){dataLayer.push(arguments);}  gtag('js', new Date());  gtag('config', 'UA-83731338-2');</script><title>How to Use AFX_MANAGE_STATE in an OLE Control </TITLE>

<!--STYLE_BEGIN-->
<style>@import url(../../msdn_ie4.css);</style>
	<link disabled rel="stylesheet" href="../../msdn_ie3.css">
<!--STYLE_END-->

<META HTTP-EQUIV="CONTENT-Type" CONTENT="text/html; charset=us-ascii">
<META NAME="ms.locale" CONTENT="EN-US">
<META NAME="Category" CONTENT="Support; KB Article">
<META NAME="KBID" CONTENT="Q127074">
<META NAME="KBModify" CONTENT="1995/10/12">
<META NAME="KBCreate" CONTENT="1995/03/12">
<META NAME="Keywords" CONTENT="kbole kbcode">
<META NAME="KBArea" CONTENT="Support; KB; visualc">
<META NAME="Description" CONTENT="  The AFX_MANAGE_STATE macro is used to establish the correct module context for OLE controls and should be used for all external entry points to the control.  The existing implementation of COleControl and COlePropertyPage use AFX_MANAGE_STATE in se...">
<META NAME="Product" CONTENT="Visual C++">
<META NAME="Platform" CONTENT="Windows">
<META NAME="Technology" CONTENT=" ">
<META NAME="Premium" CONTENT="support">

<META NAME="nyms" CONTENT="QAB5,QA7O,QAMN,QAOE,QA9Q,QAUD,QAH4,QAY5,QALS,QAHV,QBQU,QBV8,QAGI,QAB9,QALW V02180118">
</HEAD>

<BODY BGCOLOR="#FFFFFF" LEFTMARGIN="0" RIGHTMARGIN="0" TOPMARGIN="0">


<!--DOCBODY_START-->
<BR>
<CENTER>
<TABLE BORDER="0" CELLPADDING="0" CELLSPACING="0" VALIGN="top" WIDTH="90%">
	<TR>
		<TD VALIGN="top">
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<H1>How to Use AFX_MANAGE_STATE in an OLE Control</H1>
			</FONT>
			<FONT FACE="verdana,arial,helvetica" SIZE="1">
			Last reviewed:  October 12, 1995</FONT><BR>
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<B>Article ID: Q127074</B>
			</FONT>
		</TD>
	</TR>
	<TR>
	<TD>
	<FONT FACE="Verdana, Arial, Helvetica" SIZE=2>



 
The information in this article applies to:

<UL><LI>The OLE Control Developer's Kit (CDK), versions 1.0 and 1.1
</UL> 
<P>
<P><h2>SUMMARY</h2>
 
<P>
The AFX_MANAGE_STATE macro is used to establish the correct module context
for OLE controls and should be used for all external entry points to the
control.
<P>
The existing implementation of COleControl and COlePropertyPage use
AFX_MANAGE_STATE in several locations, but there are still some situations
where the control writer will need to directly invoke AFX_MANAGE_STATE.
This article shows you how.
<P>
<P><h2>MORE INFORMATION</h2>
 
<P>
OLE controls written with the OLE CDK use a shared MFC DLL to eliminate the
need to have a separate copy of MFC in each control. In a way, an OLE
control is similar to a standard MFC extension DLL. Previous versions of
MFC use the _AFXDLL model to implement extension DLLs, one limitation of
this model is that the host executable had to be written to also use the
shared MFC DLL, that is it must be used by an MFC application. A different
mechanism is needed for OLE controls because they can be used by non-MFC
applications.
<P>
MFC maintains a small amount of global state information that includes
(among other things) the instance handle used when loading resources. Many
MFC functions rely on this state information, so it is important that it
always reflect the state of the module currently executing.
<P>
The AFX_MANAGE_STATE macro creates a small local object on the stack that
swaps in the control's state information in its constructor, and then
restores the previous state in its destructor. A typical use of the macro
looks like this:
<P>
<PRE>   AFX_MANAGE_STATE(_afxModuleAddrThis);

</PRE>Every exported function should invoke AFX_MANAGE_STATE as shown in the this
sample code:
<P>
STDAPI DllRegisterServer(void)
{
<PRE>        AFX_MANAGE_STATE(_afxModuleAddrThis);

        if (!AfxOleRegisterTypeLib(AfxGetInstanceHandle(), _tlid))
                return ResultFromScode(SELFREG_E_TYPELIB);

        if (!COleObjectFactoryEx::UpdateRegistryAll(TRUE))
                return ResultFromScode(SELFREG_E_CLASS);

        return NOERROR;
}

</PRE>All OLE controls implement a self-registration feature by exporting two
functions, DllRegisterServer and DllUnregisterServer. These functions are
called directly from outside of the control, so AFX_MANAGE_STATE must be
invoked at the beginning of each function.
<P>
AFX_MANAGE_STATE should also be used when handling messages sent to a child
window created by an OLE control. Such messages are sent directly to the
child window, bypassing the call to AFX_MANAGE_STATE in
COleControl::WindowProc().
<P>

	</FONT>
	</TD>
	</TR>
</TABLE>
<P>


<!--DOCBODY_END-->

<!--FOOTER_START-->
<table cellpadding=5 border=0 width="90%">
<tr>
<td>
	<HR WIDTH="90%">

<BLOCKQUOTE>
<FONT FACE="Verdana, Arial, Helvetica" SIZE="1">
<SPAN STYLE="font-family:verdana,arial,helvetica; font-size:8pt">
Additional reference words: 1.51 1.00 1.52 1.10 2.00 2.10<BR>
KBCategory: kbole kbcode<BR>
KBSubcategory: CDKIss<BR>

</SPAN>
</FONT>
<BR>
<BR>
THE INFORMATION PROVIDED IN THE MICROSOFT KNOWLEDGE BASE IS
PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND.  MICROSOFT DISCLAIMS
ALL WARRANTIES, EITHER EXPRESS OR IMPLIED, INCLUDING THE WARRANTIES
OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  IN NO
EVENT SHALL MICROSOFT CORPORATION OR ITS SUPPLIERS BE LIABLE FOR
ANY DAMAGES WHATSOEVER INCLUDING DIRECT, INDIRECT, INCIDENTAL,
CONSEQUENTIAL, LOSS OF BUSINESS PROFITS OR SPECIAL DAMAGES, EVEN IF
MICROSOFT CORPORATION OR ITS SUPPLIERS HAVE BEEN ADVISED OF THE
POSSIBILITY OF SUCH DAMAGES.  SOME STATES DO NOT ALLOW THE EXCLUSION
OR LIMITATION OF LIABILITY FOR CONSEQUENTIAL OR INCIDENTAL DAMAGES
SO THE FOREGOING LIMITATION MAY NOT APPLY.
</BLOCKQUOTE>
<P>
<center>
	<FONT FACE="Verdana,Arial,Helvetica" SIZE="1">
	Last reviewed:  October 12, 1995</FONT>
	<BR>
	<A HREF="../cpyright.htm" STYLE="font: bold 7pt Verdana,Arial,Helvetica">&copy; 1998 Microsoft Corporation. All rights reserved. Terms of Use.</A><BR>
	
</center>
</td>
</tr>
</table>

<!--FOOTER_END-->
</FONT>
</BODY>
</HTML>
