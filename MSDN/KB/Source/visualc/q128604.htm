

<HTML>
<HEAD>
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-83731338-2"></script><script>  window.dataLayer = window.dataLayer || [];  function gtag(){dataLayer.push(arguments);}  gtag('js', new Date());  gtag('config', 'UA-83731338-2');</script><title>FIX: Three Pens Leaked by MFC in Visual C++ 1.52 </TITLE>

<!--STYLE_BEGIN-->
<style>@import url(../../msdn_ie4.css);</style>
	<link disabled rel="stylesheet" href="../../msdn_ie3.css">
<!--STYLE_END-->

<META HTTP-EQUIV="CONTENT-Type" CONTENT="text/html; charset=us-ascii">
<META NAME="ms.locale" CONTENT="EN-US">
<META NAME="Category" CONTENT="Support; KB Article">
<META NAME="KBID" CONTENT="Q128604">
<META NAME="KBModify" CONTENT="1997/09/18">
<META NAME="KBCreate" CONTENT="1995/04/04">
<META NAME="Keywords" CONTENT="kb16bitonly MfcUI kbbuglist kbfixlist kbprg">
<META NAME="KBArea" CONTENT="Support; KB; visualc">
<META NAME="Description" CONTENT="  Running a 16-bit MFC application generated with Visual C++ version 1.52 under Windows results in a drop in the available GDI resources even after the application has exited. If you run under the debug kernel in Windows, you will see messages simila...">
<META NAME="Product" CONTENT="Visual C++">
<META NAME="Platform" CONTENT="Windows">
<META NAME="Technology" CONTENT=" ">
<META NAME="Premium" CONTENT="support">

<META NAME="nyms" CONTENT="QAGB,QAW6,QAPN,QBVV,QBHF,QBFY,QBCT,QA56,QA55,QAGC,QAEF,QDL9,QBWQ,QBWO,QBWN V02180118">
</HEAD>

<BODY BGCOLOR="#FFFFFF" LEFTMARGIN="0" RIGHTMARGIN="0" TOPMARGIN="0">


<!--DOCBODY_START-->
<BR>
<CENTER>
<TABLE BORDER="0" CELLPADDING="0" CELLSPACING="0" VALIGN="top" WIDTH="90%">
	<TR>
		<TD VALIGN="top">
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<H1>FIX: Three Pens Leaked by MFC in Visual C++ 1.52</H1>
			</FONT>
			<FONT FACE="verdana,arial,helvetica" SIZE="1">
			Last reviewed:  September 18, 1997</FONT><BR>
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<B>Article ID: Q128604</B>
			</FONT>
		</TD>
	</TR>
	<TR>
	<TD>
	<FONT FACE="Verdana, Arial, Helvetica" SIZE=2>



 
1.52
WINDOWS
kbprg kbfixlist kbbuglist
<P>
 
The information in this article applies to:

<UL><LI>The Microsoft Foundation Classes (MFC) included with:
   Microsoft Visual C++ for Windows, version 1.52
</UL> 
<P>
<P><h2>SYMPTOMS</h2>
 
<P>
Running a 16-bit MFC application generated with Visual C++ version 1.52
under Windows results in a drop in the available GDI resources even after
the application has exited. If you run under the debug kernel in Windows,
you will see messages similar to these:
<P>
<PRE>   wn PENLEAK GDI: Pen not deleted: 126A
   wn PENLEAK GDI: Pen not deleted: 1286
   wn PENLEAK GDI: Pen not deleted: 0E0E

</PRE>Please note that this bug only exists in MFC version 2.52 that ships with
Visual C++ version 1.52. The bug does not exist in previous 16-bit versions
of MFC nor is it present in any 32-bit version of MFC.
<P>
<P><h2>CAUSE</h2>
 
<P>
Three GDI Pen objects are being created by MFC that are never destroyed.
The creation of these objects can be found in the MFC source code in the
file AUXDATA.CPP. They are:
<P>
<PRE>   hpenBtnShadow = ::CreatePen(PS_SOLID, 0, clrBtnShadow);
   hpenBtnHilite = ::CreatePen(PS_SOLID, 0, clrBtnHilite);
   hpenBtnText = ::CreatePen(PS_SOLID, 0, clrBtnText);

</PRE><h2>RESOLUTION</h2>
 
<P>
If you are using the DLL version of MFC (building with _AFXDLL defined and
linking with MFC250(d).LIB), then there is no way to work around the leak
because this data is not exported from the DLL. However, if your project is
statically linking to MFC, you will have an opportunity to delete these
objects before your application (or _USRDLL) exits. This can be done in
your application object's ExitInstance function.
<P>
First, you will need to get the handle to the pen objects that have not
been deleted. These objects are members of the afxData structure defined in
AUXDATA.H. If you include AUXDATA.H, you can get these handles and delete
the pen objects in your ExitInstance function. This problem is specific to
MFC version 2.52 and the workaround depends on using version-specific
information, so you should compile the workaround conditionally depending
on the version. For example:
<P>
<PRE>   ...
   #if _MFC_VER==0x0252
     #include &lt;..\src\auxdata.h&gt;
   #endif
   ...

   #if _MFC_VER==0x0252
     extern void PASCAL _AfxExitDelete(HGDIOBJ hObject);
   #endif

   int CMyApp::ExitInstance()
   {

     #if _MFC_VER==0x0252

     _AfxExitDelete(afxData.hpenBtnShadow);
     _AfxExitDelete(afxData.hpenBtnHilite);
     _AfxExitDelete(afxData.hpenBtnText);

     #endif

     return CWinApp::ExitInstance();
   }

</PRE><h2>STATUS</h2>
 
<P>
Microsoft has confirmed this to be a bug in the Microsoft products listed
at the beginning of this article. This bug was corrected in MFC version
2.52b included with Visual C++ version 1.52b for Windows.
<P>
<P>

	</FONT>
	</TD>
	</TR>
</TABLE>
<P>


<!--DOCBODY_END-->

<!--FOOTER_START-->
<table cellpadding=5 border=0 width="90%">
<tr>
<td>
	<HR WIDTH="90%">

<BLOCKQUOTE>
<FONT FACE="Verdana, Arial, Helvetica" SIZE="1">
<SPAN STYLE="font-family:verdana,arial,helvetica; font-size:8pt">
Additional reference words: 1.52 2.52 bounds checker heapwalk<BR>
KBCategory: kbprg kbfixlist kbbuglist<BR>
KBSubcategory: MfcUI<BR>
Keywords          : kb16bitonly MfcUI kbbuglist kbfixlist kbprg<BR>
Technology        : kbMfc<BR>
Version           : 1.52<BR>
Platform          : WINDOWS<BR>
Solution Type     : kbfix<BR>

</SPAN>
</FONT>
<BR>
<BR>
THE INFORMATION PROVIDED IN THE MICROSOFT KNOWLEDGE BASE IS
PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND.  MICROSOFT DISCLAIMS
ALL WARRANTIES, EITHER EXPRESS OR IMPLIED, INCLUDING THE WARRANTIES
OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  IN NO
EVENT SHALL MICROSOFT CORPORATION OR ITS SUPPLIERS BE LIABLE FOR
ANY DAMAGES WHATSOEVER INCLUDING DIRECT, INDIRECT, INCIDENTAL,
CONSEQUENTIAL, LOSS OF BUSINESS PROFITS OR SPECIAL DAMAGES, EVEN IF
MICROSOFT CORPORATION OR ITS SUPPLIERS HAVE BEEN ADVISED OF THE
POSSIBILITY OF SUCH DAMAGES.  SOME STATES DO NOT ALLOW THE EXCLUSION
OR LIMITATION OF LIABILITY FOR CONSEQUENTIAL OR INCIDENTAL DAMAGES
SO THE FOREGOING LIMITATION MAY NOT APPLY.
</BLOCKQUOTE>
<P>
<center>
	<FONT FACE="Verdana,Arial,Helvetica" SIZE="1">
	Last reviewed:  September 18, 1997</FONT>
	<BR>
	<A HREF="../cpyright.htm" STYLE="font: bold 7pt Verdana,Arial,Helvetica">&copy; 1998 Microsoft Corporation. All rights reserved. Terms of Use.</A><BR>
	
</center>
</td>
</tr>
</table>

<!--FOOTER_END-->
</FONT>
</BODY>
</HTML>
