

<HTML>
<HEAD>
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-83731338-2"></script><script>  window.dataLayer = window.dataLayer || [];  function gtag(){dataLayer.push(arguments);}  gtag('js', new Date());  gtag('config', 'UA-83731338-2');</script><title>FIX: Setting Tooltip Text in OnToolHitTest Causes Assertion </TITLE>

<!--STYLE_BEGIN-->
<style>@import url(../../msdn_ie4.css);</style>
	<link disabled rel="stylesheet" href="../../msdn_ie3.css">
<!--STYLE_END-->

<META HTTP-EQUIV="CONTENT-Type" CONTENT="text/html; charset=us-ascii">
<META NAME="ms.locale" CONTENT="EN-US">
<META NAME="Category" CONTENT="Support; KB Article">
<META NAME="KBID" CONTENT="Q156067">
<META NAME="KBModify" CONTENT="1997/09/19">
<META NAME="KBCreate" CONTENT="1996/09/16">
<META NAME="Keywords" CONTENT="MfcUI vcbuglist400 vcfixlist500">
<META NAME="KBArea" CONTENT="Support; KB; visualc">
<META NAME="Description" CONTENT="  Attempting to set the text for a tooltip in the OnToolHitTest function of a CWnd by assigning a resource ID to the TOOLINFO struct's lpszText member causes the following assertion to occur:     Debug assertion failed    File: dbgheap.c    Line: 101...">
<META NAME="Product" CONTENT="Visual C++">
<META NAME="Platform" CONTENT="Windows">
<META NAME="Technology" CONTENT=" ">
<META NAME="Premium" CONTENT="support">

<META NAME="nyms" CONTENT="QATX,QBXS,QAIM,QAWT,QAR4,QAMB,QBBI,QBAO,QAY5,QAM1,QABA,QBFY,QA4H,QBV8,QAB9 V02180118">
</HEAD>

<BODY BGCOLOR="#FFFFFF" LEFTMARGIN="0" RIGHTMARGIN="0" TOPMARGIN="0">


<!--DOCBODY_START-->
<BR>
<CENTER>
<TABLE BORDER="0" CELLPADDING="0" CELLSPACING="0" VALIGN="top" WIDTH="90%">
	<TR>
		<TD VALIGN="top">
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<H1>FIX: Setting Tooltip Text in OnToolHitTest Causes Assertion</H1>
			</FONT>
			<FONT FACE="verdana,arial,helvetica" SIZE="1">
			Last reviewed:  September 19, 1997</FONT><BR>
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<B>Article ID: Q156067</B>
			</FONT>
		</TD>
	</TR>
	<TR>
	<TD>
	<FONT FACE="Verdana, Arial, Helvetica" SIZE=2>



 
 
The information in this article applies to:

<UL><LI>The Microsoft Foundation Classes (MFC) included with:
   - Microsoft Visual C++, 32-bit Edition, versions 4.0, 4.1, 4.2
</UL> 
<P>
<P><h2>SYMPTOMS</h2>
 
<P>
Attempting to set the text for a tooltip in the OnToolHitTest function of a
CWnd by assigning a resource ID to the TOOLINFO struct's lpszText member
causes the following assertion to occur:
<P>
<PRE>   Debug assertion failed
   File: dbgheap.c
   Line: 1011

</PRE>For example, setting the TOOLINFO struct as follows:
<P>
<PRE>   pTI-&gt;lpszText= MAKEINTRESOURCE(SomeId);
   pTI-&gt;hinst=AfxGetInstanceHandle();

</PRE>where pTI is a pointer to the TOOLINFO struct, will cause the problem.
Setting the TOOLINFO struct members in this manner allows the programmer to
specify a resource that the tooltip uses to get the text for the tooltip.
<P>
<P><h2>CAUSE</h2>
 
<P>
The CWnd::FilterToolTipMessage() function contains the following code:
<P>
<PRE>   if (tiHit.lpszText != LPSTR_TEXTCALLBACK)
       free(tiHit.lpszText);

</PRE>Because lpszText is not set to LPSTR_TEXTCALLBACK, the free function is
called. However, a resource ID, rather than a string, was specified in the
OnToolHitTest() function, and therefore the assertion occurs.
<P>
<P><h2>RESOLUTION</h2>
 
<P>
Instead of specifying a resource ID to load, load the resource and assign
the text to the TOOLINFO struct's lpszText member as follows:
<P>
<PRE>   pTI-&gt;lpszText = (char *)malloc(200, sizeof(char));
   if (::LoadString(AfxGetInstanceHandle(),pTI-&gt;uId, pTI-&gt;lpszText,200)==0)
   {
      ASSERT(FALSE);   //String resource doesn't exist
   }

</PRE>MFC frees the allocated buffer after it has added the tool (that is, after
it has sent the TTM_ADDTOOL message).
<P>
<P><h2>STATUS</h2>
 
<P>
Microsoft has confirmed this to be a bug in the Microsoft products listed
at the beginning of this article. This problem has been fixed in Visual C++
version 5.0.
<P>

	</FONT>
	</TD>
	</TR>
</TABLE>
<P>


<!--DOCBODY_END-->

<!--FOOTER_START-->
<table cellpadding=5 border=0 width="90%">
<tr>
<td>
	<HR WIDTH="90%">

<BLOCKQUOTE>
<FONT FACE="Verdana, Arial, Helvetica" SIZE="1">
<SPAN STYLE="font-family:verdana,arial,helvetica; font-size:8pt">
Additional query words: tool tip<BR>
Keywords          : MfcUI vcbuglist400 vcfixlist500<BR>
Technology        : kbMfc<BR>
Version           : WINDOWS NT:4.0,4.1,4.2<BR>
Platform          : NT WINDOWS<BR>
Issue type        : kbbug<BR>
Solution Type     : kbfix<BR>

</SPAN>
</FONT>
<BR>
<BR>
THE INFORMATION PROVIDED IN THE MICROSOFT KNOWLEDGE BASE IS
PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND.  MICROSOFT DISCLAIMS
ALL WARRANTIES, EITHER EXPRESS OR IMPLIED, INCLUDING THE WARRANTIES
OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  IN NO
EVENT SHALL MICROSOFT CORPORATION OR ITS SUPPLIERS BE LIABLE FOR
ANY DAMAGES WHATSOEVER INCLUDING DIRECT, INDIRECT, INCIDENTAL,
CONSEQUENTIAL, LOSS OF BUSINESS PROFITS OR SPECIAL DAMAGES, EVEN IF
MICROSOFT CORPORATION OR ITS SUPPLIERS HAVE BEEN ADVISED OF THE
POSSIBILITY OF SUCH DAMAGES.  SOME STATES DO NOT ALLOW THE EXCLUSION
OR LIMITATION OF LIABILITY FOR CONSEQUENTIAL OR INCIDENTAL DAMAGES
SO THE FOREGOING LIMITATION MAY NOT APPLY.
</BLOCKQUOTE>
<P>
<center>
	<FONT FACE="Verdana,Arial,Helvetica" SIZE="1">
	Last reviewed:  September 19, 1997</FONT>
	<BR>
	<A HREF="../cpyright.htm" STYLE="font: bold 7pt Verdana,Arial,Helvetica">&copy; 1998 Microsoft Corporation. All rights reserved. Terms of Use.</A><BR>
	
</center>
</td>
</tr>
</table>

<!--FOOTER_END-->
</FONT>
</BODY>
</HTML>
