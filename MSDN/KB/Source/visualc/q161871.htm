

<HTML>
<HEAD>
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-83731338-2"></script><script>  window.dataLayer = window.dataLayer || [];  function gtag(){dataLayer.push(arguments);}  gtag('js', new Date());  gtag('config', 'UA-83731338-2');</script><title>PRB: MFC Sockets Application Crashes after Exit on NT 3.51 </TITLE>

<!--STYLE_BEGIN-->
<style>@import url(../../msdn_ie4.css);</style>
	<link disabled rel="stylesheet" href="../../msdn_ie3.css">
<!--STYLE_END-->

<META HTTP-EQUIV="CONTENT-Type" CONTENT="text/html; charset=us-ascii">
<META NAME="ms.locale" CONTENT="EN-US">
<META NAME="Category" CONTENT="Support; KB Article">
<META NAME="KBID" CONTENT="Q161871">
<META NAME="KBModify" CONTENT="1997/08/07">
<META NAME="KBCreate" CONTENT="1997/01/07">
<META NAME="Keywords" CONTENT="MfcSockets kbprb kbprg">
<META NAME="KBArea" CONTENT="Support; KB; visualc">
<META NAME="Description" CONTENT="  When you unload an application or DLL that uses the MFC socket classes, an Unhandled Access violation occurs. This only happens on Windows NT 3.50 or 3.51 and will often be erratic in its occurrence; it does not reproduce consistently.  CAUSE =====...">
<META NAME="Product" CONTENT="Visual C++">
<META NAME="Platform" CONTENT="Windows">
<META NAME="Technology" CONTENT=" ">
<META NAME="Premium" CONTENT="support">

<META NAME="nyms" CONTENT="QBWP,QAGI,QDNN,QAIF,QBVV,QAUD,QAO4,QALQ,QDNL,QAH4,QABO,QDL9,QBWQ,QBWO,QBWN V02180118">
</HEAD>

<BODY BGCOLOR="#FFFFFF" LEFTMARGIN="0" RIGHTMARGIN="0" TOPMARGIN="0">


<!--DOCBODY_START-->
<BR>
<CENTER>
<TABLE BORDER="0" CELLPADDING="0" CELLSPACING="0" VALIGN="top" WIDTH="90%">
	<TR>
		<TD VALIGN="top">
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<H1>PRB: MFC Sockets Application Crashes after Exit on NT 3.51</H1>
			</FONT>
			<FONT FACE="verdana,arial,helvetica" SIZE="1">
			Last reviewed:  August 7, 1997</FONT><BR>
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<B>Article ID: Q161871</B>
			</FONT>
		</TD>
	</TR>
	<TR>
	<TD>
	<FONT FACE="Verdana, Arial, Helvetica" SIZE=2>



 
4.10 4.20
WINDOWS NT
kbprg kbprb
<P>
 
The information in this article applies to:

<UL><LI>Microsoft Visual C++, 32-bit Edition, versions 4.1, 4.2
</UL> 
<P>
<P><h2>SYMPTOMS</h2>
 
<P>
When you unload an application or DLL that uses the MFC socket classes, an
Unhandled Access violation occurs. This only happens on Windows NT 3.50 or
3.51 and will often be erratic in its occurrence; it does not reproduce
consistently.
<P>
<P><h2>CAUSE</h2>
 
<P>
A bug in the WSOCK32.DLL that is included with Windows NT 3.5x can cause
this behavior. The bug occurs when the DLL is being unloaded via
FreeLibrary.
<P>
As of MFC version 4.1, the sockets classes explicitly load the WINSOCK DLL
rather than implicitly loading the DLL. Consequently, the socket classes
may encounter this bug when FreeLibrary is called to unload the DLL.
<P>
<P><h2>RESOLUTION</h2>
 
<P>
The only resolution is to prevent WSOCK32.DLL from being completely
unloaded when MFC makes the call to FreeLibrary. This can only be done by
increasing the DLL's module usage count.
<P>
The effect of this will be an increased memory footprint for the process
that is using the socket classes. If it is a DLL that is using the MFC
socket classes, then the WSOCK32.DLL will remain loaded in the process
memory space even after the MFC DLL is unloaded.
<P>
However, as long as the DLL is not being used or accessed, this memory will
be swapped out to disk and should not have a major impact on performance.
<P>
To implement the following workaround, modify your code to make an
additional call to LoadLibrary after the call to AfxSocketInit(). Because
the problem only occurs on Windows NT 3.5x, you don't need to include the
additional call to LoadLibrary for Windows 95 or Windows NT 4.0. This can
be determined using the GetVersion() API call.
<P>
For example:
<P>
<PRE>   BOOL CMyApp::InitInstance()
   {
     ...
     if(!AfxSocketInit())
     {
           AfxMessageBox(IDP_SOCKETS_INIT_FAILED);
           return FALSE;
     }

     DWORD dwVersion = ::GetVersion();
     BOOL bWin4 = (BYTE)dwVersion &gt;= 4;

     if(!bWin4 &amp;&amp; !LoadLibrary("WSOCK32.DLL"))
     {
           AfxMessageBox(IDP_SOCKETS_INIT_FAILED);
           return FALSE;
     }
     ...
</PRE>

	</FONT>
	</TD>
	</TR>
</TABLE>
<P>


<!--DOCBODY_END-->

<!--FOOTER_START-->
<table cellpadding=5 border=0 width="90%">
<tr>
<td>
	<HR WIDTH="90%">

<BLOCKQUOTE>
<FONT FACE="Verdana, Arial, Helvetica" SIZE="1">
<SPAN STYLE="font-family:verdana,arial,helvetica; font-size:8pt">
KBCategory: kbprg kbprb<BR>
KBSubcategory: MfcSockets<BR>
Additional reference words: 4.10 4.20 kbdsd<BR>
Keywords          : MfcSockets kbprb kbprg<BR>
Version           : 4.10 4.20<BR>
Platform          : NT WINDOWS<BR>

</SPAN>
</FONT>
<BR>
<BR>
THE INFORMATION PROVIDED IN THE MICROSOFT KNOWLEDGE BASE IS
PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND.  MICROSOFT DISCLAIMS
ALL WARRANTIES, EITHER EXPRESS OR IMPLIED, INCLUDING THE WARRANTIES
OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  IN NO
EVENT SHALL MICROSOFT CORPORATION OR ITS SUPPLIERS BE LIABLE FOR
ANY DAMAGES WHATSOEVER INCLUDING DIRECT, INDIRECT, INCIDENTAL,
CONSEQUENTIAL, LOSS OF BUSINESS PROFITS OR SPECIAL DAMAGES, EVEN IF
MICROSOFT CORPORATION OR ITS SUPPLIERS HAVE BEEN ADVISED OF THE
POSSIBILITY OF SUCH DAMAGES.  SOME STATES DO NOT ALLOW THE EXCLUSION
OR LIMITATION OF LIABILITY FOR CONSEQUENTIAL OR INCIDENTAL DAMAGES
SO THE FOREGOING LIMITATION MAY NOT APPLY.
</BLOCKQUOTE>
<P>
<center>
	<FONT FACE="Verdana,Arial,Helvetica" SIZE="1">
	Last reviewed:  August 7, 1997</FONT>
	<BR>
	<A HREF="../cpyright.htm" STYLE="font: bold 7pt Verdana,Arial,Helvetica">&copy; 1998 Microsoft Corporation. All rights reserved. Terms of Use.</A><BR>
	
</center>
</td>
</tr>
</table>

<!--FOOTER_END-->
</FONT>
</BODY>
</HTML>
