<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<HTML dir=ltr>
<HEAD>
<META HTTP-EQUIV="Content-Type" Content="text/html; charset=Windows-1252">
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-83731338-2"></script><script>  window.dataLayer = window.dataLayer || [];  function gtag(){dataLayer.push(arguments);}  gtag('js', new Date());  gtag('config', 'UA-83731338-2');</script><title>WSPCleanup</title>
<link disabled rel=stylesheet href=../../../backsdk3.css>
<style type="text/css">
@import url(../../../backsdk4.css);
</style>
</HEAD>
<BODY BGCOLOR = #FFFFFF TEXT = #000000>

<h1><a name="_win32_wspcleanup_2"></a>WSPCleanup</h1>
<p>
The <b>WSPCleanup</b> function terminates use of the Windows Sockets service provider.</p>
<pre><code><b>int WSPCleanup (
  LPINT</b><i> lpErrno  </i>
<b>);</b>
 </code></pre>
<h4>Parameters</h4>
<dl>
<dt>
<i>lpErrno</i></dt>
<dd>
[out] A pointer to the error code.
</dd>
</dl>
<h4>Remarks</h4>
<p>
The Windows Sockets 2 SPI client is required to perform a successful <a href="wsspiref_3xbm.htm"><b>WSPStartup</b></a> call before it can use Windows Sockets service providers. When it has completed the use of Windows Sockets service providers, the SPI client will call <b>WSPCleanup</b> to deregister itself from a Windows Sockets service provider and allow the service provider to free any resources allocated on behalf of the Windows Sockets 2 client. It is permissible for SPI clients to make more than one <b>WSPStartup</b> call. For each <b>WSPStartup</b> call a corresponding <b>WSPCleanup</b> call will also be issued. Only the final <b>WSPCleanup</b> for the service provider does the actual cleanup; the preceding calls simply decrement an internal reference count in the Windows Sockets service provider.</p>
<p>
When the internal reference count reaches zero and actual cleanup operations commence, any pending blocking or asynchronous calls issued by any thread in this process are canceled without posting any notification messages or signaling any event objects. Any pending overlapped send and receive operations (<a href="wsspiref_2dpu.htm"><b>WSPSend</b></a>/<a href="wsspiref_68he.htm"><b>WSPSendTo</b></a>/<a href="wsspiref_854i.htm"><b>WSPRecv</b></a>/<a href="wsspiref_6lbm.htm"><b>WSPRecvFrom</b></a> with an overlapped socket) issued by any thread in this process are also canceled without setting the event object or invoking the completion routine, if specified. In this case, the pending overlapped operations fail with the error status WSA_OPERATION_ABORTED. Any sockets open when <b>WSPCleanup</b> is called are reset and automatically deallocated as if <a href="wsspiref_533m.htm"><b>WSPClosesocket</b></a> was called; sockets which have been closed with <b>WSPCloseSocket</b> but which still have pending data to be sent are not affected—the pending data is still sent.</p>
<p>
This function should not return until the service provider DLL is prepared to be unloaded from memory. In particular, any data remaining to be transmitted must either already have been sent or be queued for transmission by portions of the transport stack that will <i>not</i> be unloaded from memory along with the service provider's DLL.</p>
<h4>Return Values</h4>
<p>
The return value is zero if the operation has been successfully initiated. Otherwise, the value SOCKET_ERROR is returned, and a specific error number is available in <i>lpErrno</i>.</p>
<h4>Comments</h4>
<p>
A Windows Sockets service provider must be prepared to deal with a process which terminates without invoking <b>WSPCleanup</b> (for example, as a result of an error). A Windows Sockets service provider must ensure that <b>WSPCleanup</b> leaves things in a state in which the WS2_32.DLL can immediately invoke <a href="wsspiref_3xbm.htm"><b>WSPStartup</b></a> to re-establish Windows Sockets usage.</p>
<h4>Error Codes</h4>
<table cellspacing=4 cols=2>
<tr valign=top>
<td width=37%>WSANOTINITIALISED</td>
<td width=63%>A successful <a href="wsspiref_3xbm.htm"><b>WSPStartup</b></a> must occur before using this function.</td>
</tr>
<tr valign=top>
<td width=37%>WSAENETDOWN</td>
<td width=63%>The network subsystem has failed.</td>
</tr>
<tr valign=top>
<td width=37%>WSAEINVAL</td>
<td width=63%>The provider ID given to the name space provider is not managed by the name space provider.</td>
</tr>
</table><br>
<h4>QuickInfo</h4>
<p>
&nbsp;&nbsp;<b>Windows NT:</b>  Yes<br>
&nbsp;&nbsp;<b>Windows:</b> Yes<br>
&nbsp;&nbsp;<b>Windows CE:</b>  Unsupported.<br>
&nbsp;&nbsp;<b>Header:</b> Declared in ws2spi.h.</p>
<h4>See Also</h4>
<p>
<a href="wsspiref_3xbm.htm"><b>WSPStartup</b></a>, <a href="wsspiref_533m.htm"><b>WSPClosesocket</b></a>, <a href="wsspiref_4dma.htm"><b>WSPShutdown</b></a> </p>
<p>&nbsp;</p></body>
</HTML>
