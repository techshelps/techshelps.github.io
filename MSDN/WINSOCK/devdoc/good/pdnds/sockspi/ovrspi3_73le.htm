<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<HTML dir=ltr>
<HEAD>
<META HTTP-EQUIV="Content-Type" Content="text/html; charset=Windows-1252">
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-83731338-2"></script><script>  window.dataLayer = window.dataLayer || [];  function gtag(){dataLayer.push(arguments);}  gtag('js', new Date());  gtag('config', 'UA-83731338-2');</script><title>Initialization</title>
<link disabled rel=stylesheet href=../../../backsdk3.css>
<style type="text/css">
@import url(../../../backsdk4.css);
</style>
</HEAD>
<BODY BGCOLOR = #FFFFFF TEXT = #000000>

<h3><a name="_win32_initialization_2"></a>Initialization</h3>
<p>
The WS2_32.DLL loads the service provider's interface DLL into the system by using the standard Windows dynamic library loading mechanisms, and initializes it by calling <a href="wsspiref_3xbm.htm"><b>WSPStartup</b></a>. This is usually triggered by an application calling either <a href="../sock2/wsapiref_2qr6.htm"><b>socket</b></a> or <a href="../sock2/wsapiref_533m.htm"><b>WSASocket</b></a> in order to create a new socket that is to be associated with a service provider whose interface DLL is not currently loaded into memory. The path to each service provider's interface DLL is stored by the WS2_32.DLLat the time the service provider is being installed. See section <i>Configuration and Installation</i> for more information. </p>
<p>
Over time, different versions may exist for the WinSock 2 DLLs, applications, and service providers. New versions may define new features, new fields to data structures and bit fields, etc. Version numbers therefore indicate how to interpret various data structures. </p>
<p>
To allow optimal mixing and matching of different versions of applications, versions of the WS2_32.DLL itself, and versions of service providers by different vendors, the SPI provides a version negotiation mechanism for use between the WS2_32.DLL and the service providers. This version negotiation is handled by <a href="wsspiref_3xbm.htm"><b>WSPStartup</b></a>. Basically, the WS2_32.DLLpasses to the service provider the highest version numbers it is compatible with. The service provider compares this with its own supported range of version numbers. If these ranges overlap, the service provider returns a value within the overlapping portion of the range as the result of the negotiation. Usually, this should be the highest possible value. If the ranges do not overlap, the two parties are incompatible and the function returns an error. </p>
<p>
<a href="wsspiref_3xbm.htm"><b>WSPStartup</b></a> must be called at least once by each client process, and may be called multiple times by WS2_32.DLLor other entities. A matching <a href="wsspiref_3436.htm"><b>WSPCleanup</b></a> must be called for each successful <b>WSPStartup</b> call. The service provider should maintain a reference count on a per-process basis. On each <b>WSPStartup</b> call, the caller may specify any version number supported by the SP DLL. </p>
<p>
A service provider must store the pointer to the client's upcall dispatch table that is received as a <b>WSPStartup</b> parameter on a per-process basis. If a given process calls <b>WSPStartup</b> multiple times, the service provider must use only the most recently supplied dispatch table pointer. </p>
<p>
As part of the service provider initialization process The WS2_32.DLLretrieves the service provider's dispatch table via the <i>lpProcTable</i> parameter in order to obtain entry points to the rest of the SPI functions specified in this document. Using a dispatch table (as opposed to the usual DLL mechanisms for accessing entry points) serves two purposes. First of all, it is more convenient for the WS2_32.DLLsince a single call can be made to discover the entire set of entry points. Secondly, this enables layered service providers formed into protocol chains to operate more efficiently. </p>

<h4><a name="_win32_initializing_protocol_chains_2"></a>Initializing Protocol Chains</h4>
<p>
At the time the WSAPROTOCOL_INFOW struct for a protocol chain is installed, the path to the first layered provider in the chain is also specified. When a protocol chain is initialized, the WS2_32.DLLuses this path to load the provider DLL and then invokes <a href="wsspiref_3xbm.htm"><b>WSPStartup</b></a>. Since <b>WSPStartup</b> includes a pointer to the chain's WSAPROTOCOL_INFOW struct as one of its parameters, layered providers can determine what type of chain they are being initialized into, and who the next lower layer in the chain is. A layered provider would then in turn load the next protocol provider in the chain and initialize it with a call to <b>WSPStartup</b>, and so forth. Whenever the next lower layer is another layered provider, the chain's WSAPROTOCOL_INFOW struct must be referenced in the <b>WSPStartup</b> call. When the next lower layer is a base protocol (signifying the end of the chain), the chain's WSAPROTOCOL_INFOW struct is no longer propagated downward. Instead, the current layer must reference a WSAPROTOCOL_INFOW struct that corresponds to the protocol that the base provider should use. Thus, the base provider has no notion of being involved in a protocol chain. </p>
<p>
The dispatch table provided by any given layered provider will, in many instances, duplicate the entry points of an underlying provider. The layered provider would only insert its own entry points for functions that it needed to be directly involved in. Note, however, that it is imperative that a layered provider <b>not</b> modify the contents of the upcall table that it received when calling <a href="wsspiref_3xbm.htm"><b>WSPStartup</b></a> on the next lower layer in a protocol chain. These upcalls <b>must</b> be made directly to the WinSock 2 DLL. </p>
<p>&nbsp;</p></body>
</HTML>
