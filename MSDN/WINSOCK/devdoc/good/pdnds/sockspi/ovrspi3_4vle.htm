<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<HTML dir=ltr>
<HEAD>
<META HTTP-EQUIV="Content-Type" Content="text/html; charset=Windows-1252">
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-83731338-2"></script><script>  window.dataLayer = window.dataLayer || [];  function gtag(){dataLayer.push(arguments);}  gtag('js', new Date());  gtag('config', 'UA-83731338-2');</script><title>SPI: Shared Sockets</title>
<link disabled rel=stylesheet href=../../../backsdk3.css>
<style type="text/css">
@import url(../../../backsdk4.css);
</style>
</HEAD>
<BODY BGCOLOR = #FFFFFF TEXT = #000000>

<h2><a name="_win32_spi_shared_sockets_2"></a>SPI: Shared Sockets</h2>
<p>
Socket sharing between processes in Windows Sockets is implemented as follows. A source process calls <a href="wsspiref_7242.htm"><b>WSPDuplicateSocket</b></a> to obtain a special WSAPROTOCOL_INFOW structure. It uses some interprocess communications (IPC) mechanism to pass the contents of this structure to a target process. The target process then uses the WSAPROTOCOL_INFOW structure in a call to <a href="wsspiref_46ia.htm"><b>WSPSocket</b></a>. The socket descriptor returned by this function will be an additional socket descriptor to an underlying socket which thus becomes shared. </p>
<p>
It is the service provider's responsibility to perform whatever operations are needed in the source process context and to create a WSAPROTOCOL_INFOW structure that will be recognized when it subsequently appears as a parameter to <b>WSPSocket</b> in the target processes' context. The <i>dwProviderReserved</i> field of the WSAPROTOCOL_INFOW struct is available for the service provider's use, and may be used to store any useful context information, including a duplicated handle. </p>
<p>
This mechanism is designed to be appropriate for both single-threaded version of Windows (such as Windows 3.1) and preemptive multithreaded versions of Windows (such as Windows 95 and NT). Note however, that sockets may be shared amongst threads in a given process without using the <b>WSPDuplicateSocket</b> function, since a socket descriptor is valid in all of a process' threads. </p>
<p>
As is described in section <a href="ovrspi3_46eq.htm">Descriptor Allocation</a>, when new socket descriptors are allocated IFS providers must call <a href="wsspiref_30mq.htm"><b>WPUModifyIFSHandle</b></a> and non-IFS providers must call <a href="wsspiref_8m0i.htm"><b>WPUCreateSocketHandle</b></a>. </p>
<p>
One possible scenario for establishing and using a shared socket in a handoff mode is illustrated below:</p>
<table cellspacing=4 cols=3>
<tr valign=top>
<th align=left width=43%>Source Process</th>
<th align=left width=15%>IPC</th>
<th align=left width=42%>Destination Process</th>
</tr>
<tr valign=top>
<td width=43%>1) <a href="wsspiref_46ia.htm"><b>WSPSocket</b></a>, <a href="wsspiref_0meq.htm"><b>WSPConnect</b></a></td>
<td width=15%></td>
<td width=42%></td>
</tr>
<tr valign=top>
<td width=43%>2) Request target process ID</td>
<td width=15%><font face="Symbol">Þ</font></td>
<td width=42%></td>
</tr>
<tr valign=top>
<td width=43%></td>
<td width=15%></td>
<td width=42%>3) Receive process ID request and respond</td>
</tr>
<tr valign=top>
<td width=43%>4) Receive process ID</td>
<td width=15%><font face="Symbol">Ü</font></td>
<td width=42%></td>
</tr>
<tr valign=top>
<td width=43%>5) Call <a href="wsspiref_7242.htm"><b>WSPDuplicateSocket</b></a> to get a special WSAPROTOCOL_INFOW structure</td>
<td width=15%></td>
<td width=42%></td>
</tr>
<tr valign=top>
<td width=43%>6) Send WSAPROTOCOL_INFOW structure to target</td>
<td width=15%></td>
<td width=42%></td>
</tr>
<tr valign=top>
<td width=43%></td>
<td width=15%><font face="Symbol">Þ</font></td>
<td width=42%>7) Receive WSAPROTOCOL_INFOW structure</td>
</tr>
<tr valign=top>
<td width=43%></td>
<td width=15%></td>
<td width=42%>8) Call <a href="wsspiref_46ia.htm"><b>WSPSocket</b></a> to create shared socket descriptor.</td>
</tr>
<tr valign=top>
<td width=43%>10) <a href="wsspiref_533m.htm"><b>WSPClosesocket</b></a></td>
<td width=15%></td>
<td width=42%>9)Use shared socket for data exchange</td>
</tr>
</table><br>
<p>&nbsp;</p></body>
</HTML>
