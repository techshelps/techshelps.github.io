<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<HTML dir=ltr>
<HEAD>
<META HTTP-EQUIV="Content-Type" Content="text/html; charset=Windows-1252">
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-83731338-2"></script><script>  window.dataLayer = window.dataLayer || [];  function gtag(){dataLayer.push(arguments);}  gtag('js', new Date());  gtag('config', 'UA-83731338-2');</script><title>TREE_CONNECT_ANDX:  Tree Connect</title>
<link disabled rel=stylesheet href=../../../backsdk3.css>
<style type="text/css">
@import url(../../../backsdk4.css);
</style>
</HEAD>
<BODY BGCOLOR = #FFFFFF TEXT = #000000>

<h3><a name="_cifs_66"></a>TREE_CONNECT_ANDX:  Tree Connect</h3>
<table border=1 cellspacing=4 cols=2 frame=box rules=cols>
<tr valign=top>
<td width=49%>Client Request<br>
=================================</td>
<td width=51%>Description<br>
=================================</td>
</tr>
<tr valign=top>
<td width=49%>UCHAR WordCount;</td>
<td width=51%>Count of parameter words = 4</td>
</tr>
<tr valign=top>
<td width=49%>UCHAR AndXCommand;</td>
<td width=51%>Secondary (X) command; 0xFF = none</td>
</tr>
<tr valign=top>
<td width=49%>UCHAR AndXReserved;</td>
<td width=51%>Reserved (must be 0)</td>
</tr>
<tr valign=top>
<td width=49%>USHORT AndXOffset;</td>
<td width=51%>Offset to next command WordCount</td>
</tr>
<tr valign=top>
<td width=49%>USHORT Flags;</td>
<td width=51%>Additional information</td>
</tr>
<tr valign=top>
<td width=49%></td>
<td width=51%>bit 0 set = disconnect Tid</td>
</tr>
<tr valign=top>
<td width=49%>USHORT PasswordLength;</td>
<td width=51%>Length of Password[]</td>
</tr>
<tr valign=top>
<td width=49%>USHORT ByteCount;</td>
<td width=51%>Count of data bytes;    min = 3</td>
</tr>
<tr valign=top>
<td width=49%>UCHAR Password[];</td>
<td width=51%>Password</td>
</tr>
<tr valign=top>
<td width=49%>STRING Path[];</td>
<td width=51%>Server name and share name</td>
</tr>
<tr valign=top>
<td width=49%>STRING Service[];</td>
<td width=51%>Service name</td>
</tr>
</table><br>
<p>
The serving machine verifies the combination and returns an error code or an identifier.  The full name is included in this request message and the identifier identifying the connection is returned in the <i>tid</i> field of the SMB header.  The <i>tid</i> field in the client request is ignored.  The meaning of this identifier (<i>tid</i>) is server specific; the client must not associate any specific meaning to it.</p>
<p>
If the negotiated dialect is LANMAN1.0 or later, then it is a protocol violation for the client to send this message prior to a successful SMB_COM_SESSION_SETUP_ANDX, and the server ignores <i>Password</i>.</p>
<p>
If the negotiated dialect is prior to LANMAN1.0 and the client has not sent a successful SMB_COM_SESSION_SETUP_ANDX request when the tree connect arrives, a user level security mode server must nevertheless validate the client's credentials as discussed earlier in this document.</p>
<p>
<i>Path</i> follows UNC style syntax, that is to say it is encoded as \\server\share and it indicates the name of the resource to which the client wishes to connect.</p>
<p>
Because <i>Password</i> may be an authentication response, it is a variable length field with the length specified by <i>PasswordLength</i>.   If authentication is not being used, <i>Password</i> should be a null terminated ASCII string with <i>PasswordLength</i> set to the string size including the terminating null.</p>
<p>
The server can enforce whatever policy it desires to govern share access. Typically, if the server is paused, administrative privilege is required to connect to any share; if the server is not paused, administrative privilege is required only for administrative shares (C$, etc.). Other such policies may include valid times of day, software usage license limits, number of simultaneous server users or share users, etc.</p>
<p>
The Service component indicates the type of resource the client intends to access.  Valid values are:</p>
<table border=1 cellspacing=4 cols=3 frame=box rules=cols>
<tr valign=top>
<td width=14%>Service<br>
========</td>
<td width=37%>Description<br>
========================</td>
<td width=49%>Earliest Dialect Allowed<br>
================================</td>
</tr>
<tr valign=top>
<td width=14%>A:</td>
<td width=37%>disk share</td>
<td width=49%><code>PC NETWORK PROGRAM 1.0</code></td>
</tr>
<tr valign=top>
<td width=14%>LPT1:</td>
<td width=37%>printer</td>
<td width=49%><code>PC NETWORK PROGRAM 1.0</code></td>
</tr>
<tr valign=top>
<td width=14%>IPC</td>
<td width=37%>named pipe</td>
<td width=49%><code>MICROSOFT NETWORKS 3.0</code></td>
</tr>
<tr valign=top>
<td width=14%>COMM</td>
<td width=37%>communications device</td>
<td width=49%><code>MICROSOFT NETWORKS 3.0</code></td>
</tr>
<tr valign=top>
<td width=14%>?????</td>
<td width=37%>any type of device</td>
<td width=49%><code>MICROSOFT NETWORKS 3.0</code></td>
</tr>
</table><br>
<p>
If <i>bit0</i> of <i>flags</i> is set, the tree connection to <i>tid</i> in the SMB header should be disconnected.  If this tree disconnect fails, the error should be ignored.</p>
<p>
If the negotiated dialect is earlier than DOS <code>LANMAN2.1</code>, the response to this SMB is:</p>
<table border=1 cellspacing=4 cols=2 frame=box rules=cols>
<tr valign=top>
<td width=47%>Server Response<br>
================================</td>
<td width=53%>Description<br>
===================================</td>
</tr>
<tr valign=top>
<td width=47%>UCHAR WordCount;</td>
<td width=53%>Count of parameter words = 2</td>
</tr>
<tr valign=top>
<td width=47%>UCHAR AndXCommand;</td>
<td width=53%>Secondary (X) command;  0xFF = none</td>
</tr>
<tr valign=top>
<td width=47%>UCHAR AndXReserved;</td>
<td width=53%>Reserved (must be 0)</td>
</tr>
<tr valign=top>
<td width=47%>USHORT AndXOffset;</td>
<td width=53%>Offset to next command WordCount</td>
</tr>
<tr valign=top>
<td width=47%>USHORT ByteCount;</td>
<td width=53%>Count of data bytes;    min = 3</td>
</tr>
</table><br>
<p>
If the negotiated is DOS <code>LANMAN2.1</code> or later, the response to this SMB is:</p>
<table border=1 cellspacing=4 cols=2 frame=box rules=cols>
<tr valign=top>
<td width=47%>Server Response<br>
================================</td>
<td width=53%>Description<br>
===================================</td>
</tr>
<tr valign=top>
<td width=47%>UCHAR WordCount;</td>
<td width=53%>Count of parameter words = 3</td>
</tr>
<tr valign=top>
<td width=47%>UCHAR AndXCommand;</td>
<td width=53%>Secondary (X) command;  0xFF = none</td>
</tr>
<tr valign=top>
<td width=47%>UCHAR AndXReserved;</td>
<td width=53%>Reserved (must be 0)</td>
</tr>
<tr valign=top>
<td width=47%>USHORT AndXOffset;</td>
<td width=53%>Offset to next command WordCount</td>
</tr>
<tr valign=top>
<td width=47%>USHORT OptionalSupport;</td>
<td width=53%>Optional support bits</td>
</tr>
<tr valign=top>
<td width=47%>USHORT ByteCount;</td>
<td width=53%>Count of data bytes;    min = 3</td>
</tr>
<tr valign=top>
<td width=47%>UCHAR Service[];</td>
<td width=53%>Service type connected to.  Always ANSII.</td>
</tr>
<tr valign=top>
<td width=47%>STRING NativeFileSystem[];</td>
<td width=53%>Native file system for this tree</td>
</tr>
</table><br>
<p>
<i>NativeFileSystem</i> is the name of the filesystem; values to be expected include FAT, NTFS, etc. </p>
<p>
<i>OptionalSupport</i> bits has the encoding:</p>
<table border=1 cellspacing=4 cols=3 frame=box rules=all>
<tr valign=top>
<td width=44%>Name<br>
=============================</td>
<td width=16%>Encoding<br>
=========</td>
<td width=40%>Description<br>
==========================</td>
</tr>
<tr valign=top>
<td width=44%>smb_support_search_bits</td>
<td width=16%>0x0001</td>
<td width=40%></td>
</tr>
<tr valign=top>
<td width=44%>smb_share_is_in_dfs</td>
<td width=16%>0x0002</td>
<td width=40%></td>
</tr>
</table><br>
<p>
Some servers negotiate "DOS LANMAN2.1" dialect or later and still send the "downlevel" (i.e. wordcount==2) response.  Valid AndX following commands are</p>
<table cellspacing=4 cols=3>
<tr valign=top>
<td width=37%><code>SMB_COM_OPEN</code></td>
<td width=33%><code>SMB_COM_OPEN_ANDX</code></td>
<td width=30%><code>SMB_COM_CREATE</code></td>
</tr>
<tr valign=top>
<td width=37%><code>SMB_COM_CREATE_NEW</code></td>
<td width=33%><code>SMB_COM_CREATE_DIRECTORY</code></td>
<td width=30%><code>SMB_COM_DELETE</code></td>
</tr>
<tr valign=top>
<td width=37%><code>SMB_COM_DELETE_DIRECTORY</code></td>
<td width=33%><code>SMB_COM_FIND</code></td>
<td width=30%><code>SMB_COM_FIND_UNIQUE</code></td>
</tr>
<tr valign=top>
<td width=37%><code>SMB_COM_COPY</code></td>
<td width=33%><code>SMB_COM_RENAME</code></td>
<td width=30%><code>SMB_COM_NT_RENAME</code></td>
</tr>
<tr valign=top>
<td width=37%><code>SMB_COM_CHECK_DIRECTORY</code></td>
<td width=33%><code>SMB_COM_QUERY_INFORMATION</code></td>
<td width=30%><code>SMB_COM_SET_INFORMATION</code></td>
</tr>
<tr valign=top>
<td width=37%><code>SMB_COM_GET_PRINT_QUEUE</code></td>
<td width=33%><code>SMB_COM_OPEN_PRINT_FILE</code></td>
<td width=30%><code>SMB_COM_NO_ANDX_COMMAND</code></td>
</tr>
<tr valign=top>
<td width=37%><code>SMB_COM_TRANSACTION</code></td>
<td width=33%></td>
<td width=30%></td>
</tr>
</table><br>
<h4>Errors</h4>
<p>
ERRDOS/ERRnomem</p>
<p>
ERRDOS/ERRbadpath</p>
<p>
ERRDOS/ERRinvdevice</p>
<p>
ERRSRV/ERRaccess</p>
<p>
ERRSRV/ERRbadpw</p>
<p>
ERRSRV/ERRinvnetname</p>
<p>&nbsp;</p></body>
</HTML>
