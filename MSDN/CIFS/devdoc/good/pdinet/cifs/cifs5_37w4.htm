<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<HTML dir=ltr>
<HEAD>
<META HTTP-EQUIV="Content-Type" Content="text/html; charset=Windows-1252">
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-83731338-2"></script><script>  window.dataLayer = window.dataLayer || [];  function gtag(){dataLayer.push(arguments);}  gtag('js', new Date());  gtag('config', 'UA-83731338-2');</script><title>Data Buffer (BUFFER) and String Formats</title>
<link disabled rel=stylesheet href=../../../backsdk3.css>
<style type="text/css">
@import url(../../../backsdk4.css);
</style>
</HEAD>
<BODY BGCOLOR = #FFFFFF TEXT = #000000>

<h3><a name="_cifs_44"></a>Data Buffer (<i>buffer</i>) and String Formats</h3>
<p>
The data portion of SMBs typically contains the data to be read or written, file paths, or directory paths.  The format of the data portion depends on the message.  All fields in the data portion have the same format.  In every case it consists of an identifier byte followed by the data.</p>
<table border=1 cellspacing=4 cols=3 frame=box rules=all>
<tr valign=top>
<td width=34%>Identifier<br>
===============</td>
<td width=53%>Description<br>
=========================</td>
<td width=13%>Value<br>
=====</td>
</tr>
<tr valign=top>
<td width=34%>Data Block<p>
Dialect</p>
<p>
Pathname</p>
<p>
ASCII</p>
<p>
Variable block</p>
</td>
<td width=53%>See Below<p>
Null terminated String</p>
<p>
Null terminated String</p>
<p>
Null terminated String</p>
<p>
See Below</p>
</td>
<td width=13%>1<p>
2</p>
<p>
3</p>
<p>
4</p>
<p>
5</p>
</td>
</tr>
</table><br>
<p>
When the identifier indicates a data block or variable block then the format is a word indicating the length followed by the data.</p>
<p>
In all dialects prior to <code>NT LM 0.12</code>, all strings are encoded in ASCII.  If the agreed dialect is <code>NT LM 0.12 </code>or later, Unicode strings may be exchanged.<code> </code>Unicode strings include file names, resource names, and user names.  This applies to null-terminated strings, length specified strings and the type-prefixed strings.  In all cases where a string is passed in Unicode format, the Unicode string must be word-aligned with respect to the beginning of the SMB.  Should the string not naturally fall on a two-byte boundary, a null byte of padding will be inserted, and the Unicode string will begin at the next address.  In the description of the SMBs, items that may be encoded in Unicode or ASCII are labeled as STRING.  If the encoding is ASCII, even if the negotiated string is Unicode, the quantity is labeled as UCHAR.</p>
<p>
For type-prefixed Unicode strings, the padding byte is found after the type byte.  The type byte is 4 (indicating SMB_FORMAT_ASCII) independent of whether the string is ASCII or Unicode. For strings whose start addresses are found using offsets within the fixed part of the SMB (as opposed to simply being found at the byte following the preceding field,) it is guaranteed that the offset will be properly aligned.</p>
<p>
Strings that are never passed in Unicode are:
<ul>
<li>
The protocol strings in the Negotiate SMB request.</li>
<li>
The service name string in the Tree Connect And X SMB.</li>
</ul>
<p>
When Unicode is negotiated, bit 15 should be set in the <i>flags2</i> field of every SMB header.</p>
<p>
Despite the flexible encoding scheme, no field of a data portion may be omitted or included out of order.  In addition, neither an <i>wordcount</i> nor <i>bytecount</i> of value 0 at the end of a message may be omitted.</p>
<p>&nbsp;</p></body>
</HTML>
