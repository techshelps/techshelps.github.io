<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<HTML dir=ltr>
<HEAD>
<META HTTP-EQUIV="Content-Type" Content="text/html; charset=Windows-1252">
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-83731338-2"></script><script>  window.dataLayer = window.dataLayer || [];  function gtag(){dataLayer.push(arguments);}  gtag('js', new Date());  gtag('config', 'UA-83731338-2');</script><title>TRANS2_GET_DFS_REFERRAL: Retrieve Distributed Filesystem Referral</title>
<link disabled rel=stylesheet href=../../../backsdk3.css>
<style type="text/css">
@import url(../../../backsdk4.css);
</style>
</HEAD>
<BODY BGCOLOR = #FFFFFF TEXT = #000000>

<h3><a name="_cifs_98"></a>TRANS2_GET_DFS_REFERRAL: Retrieve Distributed Filesystem Referral</h3>
<p>
The client sends this request to ask the server to convert <i>RequestFilename</i> into an alternate name for this file.  This request can be sent to the server if the server response to the <code>NEGOTIATE SMB</code> included the <code>CAP_DFS</code> capability.  The TID of the request must be IPC$.  <i>Bit15</i> of <i>Flags2</i> in the SMB header must be set, indicating this is a UNICODE request.</p>
<table border=1 cellspacing=4 cols=2 frame=box rules=cols>
<tr valign=top>
<td width=39%>Client Request<br>
==========================</td>
<td width=61%>Description<br>
=========================================</td>
</tr>
<tr valign=top>
<td width=39%>WordCount</td>
<td width=61%>15</td>
</tr>
<tr valign=top>
<td width=39%>TotalDataCount</td>
<td width=61%>0</td>
</tr>
<tr valign=top>
<td width=39%></td>
<td width=61%></td>
</tr>
<tr valign=top>
<td width=39%>SetupCount</td>
<td width=61%>1</td>
</tr>
<tr valign=top>
<td width=39%>Setup[0]</td>
<td width=61%><code>TRANS2_GET_DFS_REFERRAL</code></td>
</tr>
<tr valign=top>
<td width=39%></td>
<td width=61%></td>
</tr>
<tr valign=top>
<td width=39%></td>
<td width=61%></td>
</tr>
<tr valign=top>
<td width=39%>Parameter Block Encoding<br>
==========================</td>
<td width=61%>Description<br>
=========================================</td>
</tr>
<tr valign=top>
<td width=39%>USHORT MaxReferralLevel</td>
<td width=61%>Latest referral version number understood</td>
</tr>
<tr valign=top>
<td width=39%>WCHAR RequestFileName;</td>
<td width=61%>DFS name of file for which referral is sought</td>
</tr>
</table><br>
<table border=1 cellspacing=4 cols=2 frame=box rules=cols>
<tr valign=top>
<td width=39%>Response Data Block<br>
==========================</td>
<td width=61%>Description<br>
=========================================</td>
</tr>
<tr valign=top>
<td width=39%>USHORT PathConsumed;</td>
<td width=61%>Number of <i>RequestFilename</i> bytes client</td>
</tr>
<tr valign=top>
<td width=39%>USHORT NumberOfReferrals;</td>
<td width=61%>Number of referrals contained in this response</td>
</tr>
<tr valign=top>
<td width=39%>USHORT Flags;</td>
<td width=61%>bit0 - The servers in <i>Referrals </i>are capable of fielding TRANS2_GET_DFS_REFERRAL.<p>
bit1 - The servers in <i>Referrals</i> should hold the storage for the requested file.</p>
</td>
</tr>
<tr valign=top>
<td width=39%>REFERRAL_LIST Referrals[]</td>
<td width=61%>Set of referrals for this file</td>
</tr>
<tr valign=top>
<td width=39%>UNICODESTRINGE Strings </td>
<td width=61%>Used to hold the strings pointed to by Version 2 Referrals in <i>referrals. </i></td>
</tr>
</table><br>
<p>
The server response is a list of <i>Referrals</i> which inform the client where it should resubmit the request to obtain access to the file.   <i>PathConsumed</i> in the response indicates to the client how many characters of  <i>RequestFilename</i> have been consumed by the server.  When the client chooses one of the referrals to use for file access, the client may need to strip the leading <i>PathConsumed</i> characters from the front of <i>RequestFileName</i> before submitting the name to the target server.  Whether or not the pathname should be trimmed is indicated by the individual referral as detailed below. </p>
<p>
<i>flags</i> indicates how this referral should be treated.  If <i>bit0</i> is clear, any entity in the <i>Referrals</i> list holds the storage for <i>RequestFileName</i>.  If <i>bit0</i> is set, any entity in the <i>Referrals</i> list has further referral information for <i>RequestFilename</i> – a <code>TRANS2_GET_DFS_REFERRAL</code> request should be sent to an entity in the <i>Referrals</i> list for further resolution.</p>
<p>
The format of an individual referral contains version and  length information allowing the client to skip referrals it does not understand.  MaxReferralLevel indicates to the server the latest version of referral which the client can digest.  Since each referral has a uniform element, <i>MaxReferralLevel</i> is advisory only. Each element in <i>Referrals</i> has this envelope:</p>
<table border=1 cellspacing=4 cols=2 frame=box rules=all>
<tr valign=top>
<td colspan=2 width=100%>REFERRAL_LIST element<br>
======================================================================</td>
</tr>
<tr valign=top>
<td width=39%>USHORT VersionNumber</td>
<td width=61%>Version of this referral element</td>
</tr>
<tr valign=top>
<td width=39%>USHORT ReferralSize</td>
<td width=61%>Size of this referral element</td>
</tr>
</table><br>
<p>
The following referral element versions are defined:</p>
<table border=1 cellspacing=4 cols=2 frame=box rules=all>
<tr valign=top>
<td colspan=2 width=100%>Version 1 Referral Element Format<br>
======================================================================</td>
</tr>
<tr valign=top>
<td width=39%>USHORT ServerType</td>
<td width=61%>Type of <i>Node</i> handling referral:<br>
0 - Don't know<br>
1 - SMB Server<br>
2 - Netware Server<br>
3 - Domain</td>
</tr>
<tr valign=top>
<td width=39%>USHORT ReferralFlags</td>
<td width=61%>Flags which describe this referral:<br>
01 - Strip off <i>PathConsumed</i> characters before submitting <i>RequestFileName</i> to <i>Node</i></td>
</tr>
<tr valign=top>
<td width=39%>UNICODESTRING Node</td>
<td width=61%>Name of entity to visit next </td>
</tr>
</table><br>
<table border=1 cellspacing=4 cols=2 frame=box rules=all>
<tr valign=top>
<td colspan=2 width=100%>Version 2 Referral Element Format<br>
======================================================================</td>
</tr>
<tr valign=top>
<td width=49%>USHORT ServerType</td>
<td width=51%>Type of <i>Node</i> handling referral:<br>
0 - Don't know<br>
1 - SMB Server<br>
2 - Netware Server<br>
3 - Domain</td>
</tr>
<tr valign=top>
<td width=49%>USHORT ReferralFlags</td>
<td width=51%>Flags which describe this referral:<p>
01 - Strip off <i>PathConsumed</i> characters before submitting <i>RequestFileName</i> to <i>Node</i></p>
</td>
</tr>
<tr valign=top>
<td width=49%>ULONG Proximity</td>
<td width=51%>A hint describing the proximity of this server to the client. 0 indicates the closest, higher numbers indicate increasingly "distant" servers. The number is only relevant within the context of the servers listed in <i>this</i> particular SMB.</td>
</tr>
<tr valign=top>
<td width=49%>ULONG TimeToLive</td>
<td width=51%>Number of seconds for which the client can cache this referral.</td>
</tr>
<tr valign=top>
<td width=49%>USHORT DfsPathOffset</td>
<td width=51%>Offset, in bytes from the beginning of this referral, of  the DFS Path that matched <i>PathConsumed</i> bytes of the <i>RequestFileName.</i></td>
</tr>
<tr valign=top>
<td width=49%>USHORT DfsAlternatePathOffset</td>
<td width=51%>Offset, in bytes from the beginning of this referral, of an alternate name (8.3 format) of the DFS Path that matched <i>PathConsumed</i> bytes of the <i>RequestFileName.</i></td>
</tr>
<tr valign=top>
<td width=49%>USHORT NetworkAddressOffset</td>
<td width=51%>Offset, in bytes from the beginning of this referral, of the entity to visit next.</td>
</tr>
</table><br>
<p>
The CIFS protocol imposes no referral selection policy.</p>
<p>&nbsp;</p></body>
</HTML>
