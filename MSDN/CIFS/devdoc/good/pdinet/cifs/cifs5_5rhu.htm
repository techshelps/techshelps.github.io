<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<HTML dir=ltr>
<HEAD>
<META HTTP-EQUIV="Content-Type" Content="text/html; charset=Windows-1252">
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-83731338-2"></script><script>  window.dataLayer = window.dataLayer || [];  function gtag(){dataLayer.push(arguments);}  gtag('js', new Date());  gtag('config', 'UA-83731338-2');</script><title>LOCK_AND_READ: Lock and Read Bytes</title>
<link disabled rel=stylesheet href=../../../backsdk3.css>
<style type="text/css">
@import url(../../../backsdk4.css);
</style>
</HEAD>
<BODY BGCOLOR = #FFFFFF TEXT = #000000>

<h2><a name="_cifs_112"></a><i></i>LOCK_AND_READ: Lock and Read Bytes</h2>
<p>
This  request is used to lock and "read ahead" the specified bytes of the file indicated by <i>fid</i> in the SMB header</p>
<table border=1 cellspacing=4 cols=2 frame=box rules=cols>
<tr valign=top>
<td width=45%>Client Request<br>
==============================</td>
<td width=55%>Description<br>
=====================================</td>
</tr>
<tr valign=top>
<td width=45%>UCHAR WordCount;</td>
<td width=55%>Count of parameter words = 5</td>
</tr>
<tr valign=top>
<td width=45%>USHORT Fid;</td>
<td width=55%>File handle</td>
</tr>
<tr valign=top>
<td width=45%>USHORT Count;</td>
<td width=55%>Count of bytes being requested</td>
</tr>
<tr valign=top>
<td width=45%>ULONG Offset;</td>
<td width=55%>Offset in file of first byte to read</td>
</tr>
<tr valign=top>
<td width=45%>USHORT Remaining;</td>
<td width=55%>Estimate of bytes to read if nonzero</td>
</tr>
<tr valign=top>
<td width=45%>USHORT ByteCount;</td>
<td width=55%>Count of data bytes = 0</td>
</tr>
</table><br>
<p>
<i>fid</i> must refer to a disk file.  <i>count</i> specifies the requested number of bytes.  <i>offset</i> specifies the offset in the file of the first byte to be locked then read.  Note that this offset is limited to 32 bits, so this client request is inappropriate for files having 64 bit offsets.</p>
<p>
<i>remaining</i> is advisory.  If the value is not zero, then it is taken as an estimate of the total number of bytes that will be read, including those read by this request.  This additional information may be used by the server to optimize buffer allocation or read-ahead.  <i>remaining</i> is not included in the byte range to be locked.</p>
<table border=1 cellspacing=4 cols=2 frame=box rules=cols>
<tr valign=top>
<td width=50%>Server Response<br>
==================================</td>
<td width=50%>Description<br>
=================================</td>
</tr>
<tr valign=top>
<td width=50%>UCHAR WordCount;</td>
<td width=50%>Count of parameter words = 5</td>
</tr>
<tr valign=top>
<td width=50%>USHORT Count;</td>
<td width=50%>Count of bytes actually returned</td>
</tr>
<tr valign=top>
<td width=50%>USHORT Reserved [4];</td>
<td width=50%>Reserved (must be 0)</td>
</tr>
<tr valign=top>
<td width=50%>USHORT ByteCount;</td>
<td width=50%>Count of data bytes</td>
</tr>
<tr valign=top>
<td width=50%>UCHAR BufferFormat;</td>
<td width=50%>0x01 -- Data block</td>
</tr>
<tr valign=top>
<td width=50%>USHORT DataLength;</td>
<td width=50%>Length of data</td>
</tr>
</table><br>
<p>
<i>bytecount</i> is the number of bytes actually being returned. <i>bytecount</i> may be less than the count requested only if a read specifies bytes beyond the current file size.  In this case only the bytes that exist are returned.  A read completely beyond the end of file results in a response of length zero.  This is the only circumstance when a zero length response is generated.  A count returned which is less than the count requested is the end of file indicator.</p>
<p>
As in the core SMB_LOCK_BYTE_RANGE request,  if the lock can not be immediately granted an error should be returned to the client.  If an error occurs on the lock, the bytes should not be read.  If a Read requests more data than can be placed in a message of the maximum-xmit-size for the <i>tid</i> specified, the server will abort the connection to the client.</p>
<p>&nbsp;</p></body>
</HTML>
