<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<HTML dir=ltr>
<HEAD>
<META HTTP-EQUIV="Content-Type" Content="text/html; charset=Windows-1252">
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-83731338-2"></script><script>  window.dataLayer = window.dataLayer || [];  function gtag(){dataLayer.push(arguments);}  gtag('js', new Date());  gtag('config', 'UA-83731338-2');</script><title>SEARCH: Search Directory using Wildcards</title>
<link disabled rel=stylesheet href=../../../backsdk3.css>
<style type="text/css">
@import url(../../../backsdk4.css);
</style>
</HEAD>
<BODY BGCOLOR = #FFFFFF TEXT = #000000>

<h2><a name="_cifs_122"></a><i></i>SEARCH: Search Directory using Wildcards</h2>
<p>
This command is used to search directories.</p>
<table border=1 cellspacing=4 cols=2 frame=box rules=cols>
<tr valign=top>
<td width=50%>Client Request<br>
==================================</td>
<td width=50%>Description<br>
=================================</td>
</tr>
<tr valign=top>
<td width=50%>UCHAR WordCount;</td>
<td width=50%>Count of parameter words = 2</td>
</tr>
<tr valign=top>
<td width=50%>USHORT MaxCount;</td>
<td width=50%>Number of dir. entries to return</td>
</tr>
<tr valign=top>
<td width=50%>USHORT SearchAttributes;</td>
<td width=50%></td>
</tr>
<tr valign=top>
<td width=50%>USHORT ByteCount;</td>
<td width=50%>Count of data bytes;  min = 5</td>
</tr>
<tr valign=top>
<td width=50%>UCHAR BufferFormat1;</td>
<td width=50%>0x04 -- ASCII</td>
</tr>
<tr valign=top>
<td width=50%>UCHAR FileName[];</td>
<td width=50%>File name, may be null</td>
</tr>
<tr valign=top>
<td width=50%>UCHAR BufferFormat2;</td>
<td width=50%>0x05 -- Variable block</td>
</tr>
<tr valign=top>
<td width=50%>USHORT ResumeKeyLength;</td>
<td width=50%>Length of resume key, may be 0</td>
</tr>
<tr valign=top>
<td width=50%>UCHAR ResumeKey[];</td>
<td width=50%>Resume key</td>
</tr>
</table><br>
<p>
<i>filename</i> specifies the file to be sought.  <i>searchattributes</i> indicates the attributes that the file must have, and is described in the "File Attribute Encoding" section of this document.  If  <i>searchattributes</i> is zero then only normal files are returned.  If the system file, hidden or directory attributes are specified then the search is inclusive–both the specified type(s) of files and normal files are returned.  If the volume label attribute is specified then the search is exclusive, and only the volume label entry is returned.</p>
<p>
<i>maxcount</i> specifies the number of directory entries to be returned.</p>
<table border=1 cellspacing=4 cols=2 frame=box rules=cols>
<tr valign=top>
<td width=50%>Server Response<br>
==================================</td>
<td width=50%>Description<br>
=================================</td>
</tr>
<tr valign=top>
<td width=50%>UCHAR WordCount;</td>
<td width=50%>Count of parameter words = 1</td>
</tr>
<tr valign=top>
<td width=50%>USHORT Count;</td>
<td width=50%>Number of entries returned</td>
</tr>
<tr valign=top>
<td width=50%>USHORT ByteCount;</td>
<td width=50%>Count of data bytes;  min = 3</td>
</tr>
<tr valign=top>
<td width=50%>UCHAR BufferFormat;</td>
<td width=50%>0x05 -- Variable block</td>
</tr>
<tr valign=top>
<td width=50%>USHORT DataLength;</td>
<td width=50%>Length of data</td>
</tr>
<tr valign=top>
<td width=50%>UCHAR DirectoryInformationData[];</td>
<td width=50%>Data</td>
</tr>
</table><br>
<p>
The response will contain one or more directory entries as determined by the <i>count</i> field.  No more than <i>maxcount</i> entries will be returned.  Only entries that match the sought <i>filename</i> and <i>searchattributes</i> combination will be returned.</p>
<p>
<i>resumekey</i> must be null (length = 0) on the initial search request.  Subsequent search requests intended to continue a search must contain the <i>resumekey</i> field extracted from the last directory entry of the previous response.  <i>resumekey</i> is self-contained, for on calls containing a non-zero <i>resumekey</i> neither the <i>searchattributes</i> or <i>filename</i> fields will be valid in the request.  <i>resumekey</i> has the following format:</p>
<table border=1 cellspacing=4 cols=2 frame=box rules=cols>
<tr valign=top>
<td width=50%>Resume Key Field<br>
==================================</td>
<td width=50%>Description<br>
=================================</td>
</tr>
<tr valign=top>
<td width=50%>UCHAR Reserved;</td>
<td width=50%>bit 7 - consumer use</td>
</tr>
<tr valign=top>
<td width=50%></td>
<td width=50%>bits 5,6 - system use (must preserve)</td>
</tr>
<tr valign=top>
<td width=50%></td>
<td width=50%>bits 0-4 - server use (must preserve)</td>
</tr>
<tr valign=top>
<td width=50%>UCHAR FileName[11];</td>
<td width=50%>Name of the returned file</td>
</tr>
<tr valign=top>
<td width=50%>UCHAR ReservedForServer[5];</td>
<td width=50%>Client must not modify</td>
</tr>
<tr valign=top>
<td width=50%>UCHAR ReservedForConsumer[4];</td>
<td width=50%>Server must not modify</td>
</tr>
</table><br>
<p>
<i>filename</i> is 8.3 format, with the three character extension left justified into <i>filename</i>[9-11].  If the client is prior to the LANMAN1.0 dialect, the returned <i>filename</i> should be uppercased.</p>
<p>
SMB_COM_SEARCH terminates when either the requested maximum number of entries that match the named file are found, or the end of directory is reached without the maximum number of matches being found.  A response containing no entries indicates that no matching entries were found between the starting point of the search and the end of directory.</p>
<p>
There may be multiple matching entries in response to a single request as SMB_COM_SEARCH supports wildcards in the last component of <i>filename</i> of the initial request.</p>
<p>
Returned directory entries in the <i>directoryinformationdata</i> field of the response each have the following format:</p>
<table border=1 cellspacing=4 cols=2 frame=box rules=cols>
<tr valign=top>
<td width=50%>Directory Information Field<br>
==================================</td>
<td width=50%>Description<br>
=================================</td>
</tr>
<tr valign=top>
<td width=50%>SMB_RESUME_KEY ResumeKey;</td>
<td width=50%>Described above</td>
</tr>
<tr valign=top>
<td width=50%>UCHAR FileAttributes;</td>
<td width=50%>Attributes of the found file</td>
</tr>
<tr valign=top>
<td width=50%>SMB_TIME LastWriteTime;</td>
<td width=50%>Time file was last written</td>
</tr>
<tr valign=top>
<td width=50%>SMB_DATE LastWriteDate;</td>
<td width=50%>Date file was last written</td>
</tr>
<tr valign=top>
<td width=50%>ULONG FileSize;</td>
<td width=50%>Size of the file</td>
</tr>
<tr valign=top>
<td width=50%>UCHAR FileName[13];</td>
<td width=50%>ASCII, space-filled null terminated</td>
</tr>
</table><br>
<p>
<i>filename</i> must conform to 8.3 rules, and is padded after the extension with 0x20 characters if necessary.  If the client has negotiated a dialect prior to the LANMAN1.0 dialect, or if <i>bit0</i> of the <i>flags2</i> SMB header field of the request is clear, the returned <i>filename</i> should be uppercased.</p>
<p>
As can be seen from the above structure, SMB_COM_SEARCH can not return long filenames, and can not return UNICODE filenames.  Files which have a size greater than 2^32 bytes should have the least significant 32 bits of their size returned in <i>filesize</i>.</p>
<p>&nbsp;</p></body>
</HTML>
