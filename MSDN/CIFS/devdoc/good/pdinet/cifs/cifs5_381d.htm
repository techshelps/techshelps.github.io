<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<HTML dir=ltr>
<HEAD>
<META HTTP-EQUIV="Content-Type" Content="text/html; charset=Windows-1252">
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-83731338-2"></script><script>  window.dataLayer = window.dataLayer || [];  function gtag(){dataLayer.push(arguments);}  gtag('js', new Date());  gtag('config', 'UA-83731338-2');</script><title>File Requests</title>
<link disabled rel=stylesheet href=../../../backsdk3.css>
<style type="text/css">
@import url(../../../backsdk4.css);
</style>
</HEAD>
<BODY BGCOLOR = #FFFFFF TEXT = #000000>

<h2><a name="_cifs_71"></a><i></i>File Requests</h2>
<p>
</p>

<h3><a name="_cifs_72"></a>NT_CREATE_ANDX: Create or Open File</h3>
<p>
This command is used to create or open a file or a directory. </p>
<table border=1 cellspacing=4 cols=2 frame=box rules=cols>
<tr valign=top>
<td width=49%>Client Request<br>
=================================</td>
<td width=51%>Description<br>
==================================</td>
</tr>
<tr valign=top>
<td width=49%>UCHAR WordCount;</td>
<td width=51%>Count of parameter words = 24</td>
</tr>
<tr valign=top>
<td width=49%>UCHAR AndXCommand;</td>
<td width=51%>Secondary command;  0xFF = None</td>
</tr>
<tr valign=top>
<td width=49%>UCHAR AndXReserved;</td>
<td width=51%>Reserved (must be 0)</td>
</tr>
<tr valign=top>
<td width=49%>USHORT AndXOffset;</td>
<td width=51%>Offset to next command WordCount</td>
</tr>
<tr valign=top>
<td width=49%>UCHAR Reserved;</td>
<td width=51%>Reserved (must be 0)</td>
</tr>
<tr valign=top>
<td width=49%>USHORT NameLength;</td>
<td width=51%>Length of Name[] in bytes</td>
</tr>
<tr valign=top>
<td width=49%>ULONG Flags;</td>
<td width=51%>Create bit set:<p>
0x02 - Request an oplock</p>
<p>
0x04 - Request a batch oplock</p>
<p>
0x08 - Target of open must be directory</p>
</td>
</tr>
<tr valign=top>
<td width=49%>ULONG RootDirectoryFid;</td>
<td width=51%>If non-zero, open is relative to this directory</td>
</tr>
<tr valign=top>
<td width=49%>ACCESS_MASK DesiredAccess;</td>
<td width=51%>access desired</td>
</tr>
<tr valign=top>
<td width=49%>LARGE_INTEGER AllocationSize;</td>
<td width=51%>Initial allocation size</td>
</tr>
<tr valign=top>
<td width=49%>ULONG ExtFileAttributes;</td>
<td width=51%>File attributes</td>
</tr>
<tr valign=top>
<td width=49%>ULONG ShareAccess;</td>
<td width=51%>Type of share access</td>
</tr>
<tr valign=top>
<td width=49%>ULONG CreateDisposition;</td>
<td width=51%>Action to take if file exists or not</td>
</tr>
<tr valign=top>
<td width=49%>ULONG CreateOptions;</td>
<td width=51%>Options to use if creating a file</td>
</tr>
<tr valign=top>
<td width=49%>ULONG ImpersonationLevel;</td>
<td width=51%>Security QOS information</td>
</tr>
<tr valign=top>
<td width=49%>UCHAR SecurityFlags;</td>
<td width=51%>Security tracking mode flags:<br>
0x1 - SECURITY_CONTEXT_TRACKING<br>
0x2 - SECURITY_EFFECTIVE_ONLY</td>
</tr>
<tr valign=top>
<td width=49%>USHORT ByteCount;</td>
<td width=51%>Length of byte parameters</td>
</tr>
<tr valign=top>
<td width=49%>STRING Name[];</td>
<td width=51%>File to open or create</td>
</tr>
</table><br>
<p>
The <i>DesiredAccess</i> parameter is specified in section 3.7 on Access Mask Encoding.</p>
<p>
If no value is specified, it still allows an application to query attributes without actually accessing the file.</p>
<p>
The <i>ExtFIleAttributes</i> parameter specifies the file attributes and flags for the file. The parameter's value is the sum of allowed attributes and flags defined in section 3.11 on Extended File Attribute Encoding</p>
<p>
The <i>ShareAccess</i> field Specifies how this file can be shared. This parameter must be some combination of the following values: </p>
<table cellspacing=4 cols=3>
<tr valign=top>
<td width=24%><b>Value</b></td>
<td width=16%></td>
<td width=60%><b>Meaning</b></td>
</tr>
<tr valign=top>
<td width=24%>0</td>
<td width=16%></td>
<td width=60%>Prevents the file from being shared.</td>
</tr>
<tr valign=top>
<td width=24%>FILE_SHARE_READ</td>
<td width=16%><code>0x00000001</code></td>
<td width=60%>Other open operations can be performed on the file for read access. </td>
</tr>
<tr valign=top>
<td width=24%>FILE_SHARE_WRITE</td>
<td width=16%><code>0x00000002</code></td>
<td width=60%>Other open operations can be performed on the file for write access.</td>
</tr>
<tr valign=top>
<td width=24%>FILE_SHARE_DELETE</td>
<td width=16%><code>0x00000004</code></td>
<td width=60%>Other open operations can be performed on the file for delete access.</td>
</tr>
</table><br>
<p>
The <i>CreateDisposition</i> parameter can contain one of the following values: </p>
<table cellspacing=4 cols=2>
<tr valign=top>
<td width=35%>CREATE_NEW</td>
<td width=65%>Creates a new file. The function fails if the specified file already exists.</td>
</tr>
<tr valign=top>
<td width=35%>CREATE_ALWAYS</td>
<td width=65%>Creates a new file. The function overwrites the file if it exists.</td>
</tr>
<tr valign=top>
<td width=35%>OPEN_EXISTING</td>
<td width=65%>Opens the file. The function fails if the file does not exist.</td>
</tr>
<tr valign=top>
<td width=35%>OPEN_ALWAYS</td>
<td width=65%>Opens the file, if it exists. If the file does not exist, act like CREATE_NEW.</td>
</tr>
<tr valign=top>
<td width=35%>TRUNCATE_EXISTING</td>
<td width=65%>Opens the file. Once opened, the file is truncated so that its size is zero bytes. The calling process must open the file with at least GENERIC_WRITE access. The function fails if the file does not exist.</td>
</tr>
</table><br>
<p>
The <i>ImpersonationLevel</i> parameter can contain one or more of the following values: </p>
<table cellspacing=4 cols=2>
<tr valign=top>
<td width=35%>SECURITY_ANONYMOUS</td>
<td width=65%>Specifies to impersonate the client at the Anonymous impersonation level.</td>
</tr>
<tr valign=top>
<td width=35%>SECURITY_IDENTIFICATION</td>
<td width=65%>Specifies to impersonate the client at the Identification impersonation level.</td>
</tr>
<tr valign=top>
<td width=35%>SECURITY_IMPERSONATION</td>
<td width=65%>Specifies to impersonate the client at the Impersonation impersonation level.</td>
</tr>
<tr valign=top>
<td width=35%>SECURITY_DELEGATION</td>
<td width=65%>Specifies to impersonate the client at the Delegation impersonation level.</td>
</tr>
</table><br>
<p>
The <i>SecurityFlags</i> parameter can have either of the following two flags set:</p>
<table border=1 cellspacing=4 cols=4 frame=box rules=cols>
<tr valign=top>
<td width=35%>SECURITY_CONTEXT_TRACKING</td>
<td colspan=3 width=65%>Specifies that the security tracking mode is dynamic. If this flag is not specified, Security Tracking Mode is static.</td>
</tr>
<tr valign=top>
<td width=35%>SECURITY_EFFECTIVE_ONLY</td>
<td colspan=3 width=65%>Specifies that only the enabled aspects of the client's security context are available to the server. If you do not specify this flag, all aspects of the client's security context are available. This flag allows the client to limit the groups and privileges that a server can use while impersonating the client.</td>
</tr>
<tr valign=top>
<td colspan=2 width=49%>Server Response<br>
=================================</td>
<td width=48%>Description<br>
==================================</td>
</tr>
<tr valign=top>
<td colspan=2 width=49%>UCHAR WordCount;</td>
<td width=48%>Count of parameter words = 26</td>
</tr>
<tr valign=top>
<td colspan=2 width=49%>UCHAR AndXCommand;  Secondary command;</td>
<td width=48%>0xFF = None</td>
</tr>
<tr valign=top>
<td colspan=2 width=49%>UCHAR AndXReserved;</td>
<td width=48%>MBZ</td>
</tr>
<tr valign=top>
<td colspan=2 width=49%>USHORT AndXOffset;</td>
<td width=48%>Offset to next command WordCount</td>
</tr>
<tr valign=top>
<td colspan=2 width=49%>UCHAR OplockLevel;</td>
<td width=48%>The oplock level granted<br>
0 - No oplock granted<br>
1 - Exclusive oplock granted<br>
2 - Batch oplock granted<br>
3 - Level II oplock granted</td>
</tr>
<tr valign=top>
<td colspan=2 width=49%>USHORT Fid;</td>
<td width=48%>The file ID</td>
</tr>
<tr valign=top>
<td colspan=2 width=49%>ULONG CreateAction;</td>
<td width=48%>The action taken</td>
</tr>
<tr valign=top>
<td colspan=2 width=49%>TIME CreationTime;</td>
<td width=48%>The time the file was created</td>
</tr>
<tr valign=top>
<td colspan=2 width=49%>TIME LastAccessTime;</td>
<td width=48%>The time the file was accessed</td>
</tr>
<tr valign=top>
<td colspan=2 width=49%>TIME LastWriteTime;</td>
<td width=48%>The time the file was last written</td>
</tr>
<tr valign=top>
<td colspan=2 width=49%>TIME ChangeTime;</td>
<td width=48%>The time the file was last changed</td>
</tr>
<tr valign=top>
<td colspan=2 width=49%>ULONG ExtFileAttributes;</td>
<td width=48%>The file attributes</td>
</tr>
<tr valign=top>
<td colspan=2 width=49%>LARGE_INTEGER AllocationSize;</td>
<td width=48%>The number of byes allocated</td>
</tr>
<tr valign=top>
<td colspan=2 width=49%>LARGE_INTEGER EndOfFile;</td>
<td width=48%>The end of file offset</td>
</tr>
<tr valign=top>
<td colspan=2 width=49%>USHORT FileType;</td>
<td width=48%></td>
</tr>
<tr valign=top>
<td colspan=2 width=49%>USHORT DeviceState;</td>
<td width=48%>state of IPC device (e.g. pipe)</td>
</tr>
<tr valign=top>
<td colspan=2 width=49%>BOOLEAN Directory;</td>
<td width=48%>TRUE if this is a directory</td>
</tr>
<tr valign=top>
<td colspan=2 width=49%>USHORT ByteCount;</td>
<td width=48%>= 0</td>
</tr>
</table><br>
<p>
The following SMBs may follow SMB_COM_NT_CREATE_ANDX:</p>
<table cellspacing=4 cols=2>
<tr valign=top>
<td width=44%>SMB_COM_READ</td>
<td width=56%>SMB_COM_READ_ANDX</td>
</tr>
<tr valign=top>
<td width=44%>SMB_COM_IOCTL</td>
<td width=56%></td>
</tr>
</table>
<p>&nbsp;</p></body>
</HTML>
