<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<HTML dir=ltr>
<HEAD>
<META HTTP-EQUIV="Content-Type" Content="text/html; charset=Windows-1252">
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-83731338-2"></script><script>  window.dataLayer = window.dataLayer || [];  function gtag(){dataLayer.push(arguments);}  gtag('js', new Date());  gtag('config', 'UA-83731338-2');</script><title>SITEHIER.FRM</title>
<link disabled rel=stylesheet href=../../../../../../../backsdk3.css>
<style type="text/css">
@import url(../../../../../../../backsdk4.css);
</style>
</HEAD>
<BODY BGCOLOR = #FFFFFF TEXT = #000000>
<h2><a name="_code_context5932"></a>SITEHIER.FRM</h2>
<pre><code>VERSION 4.00 <br>Begin VB.Form frmSiteHierarchyReport  <br>   Appearance      =   0  'Flat <br>   BackColor       =   &amp;H80000005&amp; <br>   Caption         =   "Site Hierarchy Report" <br>   ClientHeight    =   4350 <br>   ClientLeft      =   1860 <br>   ClientTop       =   2580 <br>   ClientWidth     =   4530 <br>   BeginProperty Font  <br>      name            =   "MS Sans Serif" <br>      charset         =   1 <br>      weight          =   700 <br>      size            =   8.25 <br>      underline       =   0   'False <br>      italic          =   0   'False <br>      strikethrough   =   0   'False <br>   EndProperty <br>   ForeColor       =   &amp;H80000008&amp; <br>   Height          =   4755 <br>   Icon            =   "SITEHIER.frx":0000 <br>   Left            =   1800 <br>   LinkTopic       =   "Form1" <br>   MDIChild        =   -1  'True <br>   ScaleHeight     =   4350 <br>   ScaleWidth      =   4530 <br>   Top             =   2235 <br>   Width           =   4650 <br>   Begin VB.CommandButton cmdSave  <br>      Appearance      =   0  'Flat <br>      BackColor       =   &amp;H80000005&amp; <br>      Caption         =   "Save" <br>      Height          =   315 <br>      Left            =   420 <br>      TabIndex        =   4 <br>      TabStop         =   0   'False <br>      Top             =   2100 <br>      Visible         =   0   'False <br>      Width           =   3735 <br>   End <br>   Begin VB.CommandButton cmdSaveAs  <br>      Appearance      =   0  'Flat <br>      BackColor       =   &amp;H80000005&amp; <br>      Caption         =   "Save As" <br>      Height          =   315 <br>      Left            =   420 <br>      TabIndex        =   3 <br>      TabStop         =   0   'False <br>      Top             =   2400 <br>      Visible         =   0   'False <br>      Width           =   3735 <br>   End <br>   Begin VB.CheckBox chkDirty  <br>      Appearance      =   0  'Flat <br>      BackColor       =   &amp;H80000005&amp; <br>      Caption         =   "Dirty Bit" <br>      ForeColor       =   &amp;H80000008&amp; <br>      Height          =   195 <br>      Left            =   420 <br>      TabIndex        =   2 <br>      TabStop         =   0   'False <br>      Top             =   1860 <br>      Visible         =   0   'False <br>      Width           =   1155 <br>   End <br>   Begin VB.CommandButton cmdPrintPreview  <br>      Appearance      =   0  'Flat <br>      BackColor       =   &amp;H80000005&amp; <br>      Caption         =   "Print Preview" <br>      Height          =   315 <br>      Left            =   420 <br>      TabIndex        =   1 <br>      TabStop         =   0   'False <br>      Top             =   3000 <br>      Visible         =   0   'False <br>      Width           =   3735 <br>   End <br>   Begin VB.CommandButton cmdPrint  <br>      Appearance      =   0  'Flat <br>      BackColor       =   &amp;H80000005&amp; <br>      Caption         =   "Print" <br>      Height          =   315 <br>      Left            =   420 <br>      TabIndex        =   0 <br>      TabStop         =   0   'False <br>      Top             =   2700 <br>      Visible         =   0   'False <br>      Width           =   3735 <br>   End <br>   Begin VB.CommandButton cmdAbort  <br>      Appearance      =   0  'Flat <br>      BackColor       =   &amp;H80000005&amp; <br>      Caption         =   "Abort" <br>      Height          =   315 <br>      Left            =   420 <br>      TabIndex        =   7 <br>      TabStop         =   0   'False <br>      Top             =   3900 <br>      Visible         =   0   'False <br>      Width           =   3735 <br>   End <br>   Begin VB.CommandButton cmdInitialize  <br>      Appearance      =   0  'Flat <br>      BackColor       =   &amp;H80000005&amp; <br>      Caption         =   "Initialize" <br>      Height          =   315 <br>      Left            =   420 <br>      TabIndex        =   8 <br>      TabStop         =   0   'False <br>      Top             =   3600 <br>      Visible         =   0   'False <br>      Width           =   3735 <br>   End <br>   Begin VB.CommandButton cmdExport  <br>      Appearance      =   0  'Flat <br>      BackColor       =   &amp;H80000005&amp; <br>      Caption         =   "Export" <br>      Height          =   315 <br>      Left            =   420 <br>      TabIndex        =   9 <br>      TabStop         =   0   'False <br>      Top             =   3300 <br>      Visible         =   0   'False <br>      Width           =   3735 <br>   End <br>   Begin MSComDlg.CommonDialog CommonDialog  <br>      Left            =   2400 <br>      Top             =   360 <br>      _ExtentX        =   847 <br>      _ExtentY        =   847 <br>      _StockProps     =   0 <br>   End <br>   Begin Crystal.CrystalReport CrystalReport  <br>      Left            =   2880 <br>      Top             =   360 <br>      _ExtentX        =   741 <br>      _ExtentY        =   741 <br>      _StockProps     =   0 <br>      ReportFileName  =   "" <br>      Destination     =   0 <br>      WindowLeft      =   100 <br>      WindowTop       =   100 <br>      WindowWidth     =   480 <br>      WindowHeight    =   300 <br>      WindowTitle     =   "" <br>      WindowBorderStyle=   2 <br>      WindowControlBox=   -1  'True <br>      WindowMaxButton =   -1  'True <br>      WindowMinButton =   -1  'True <br>      CopiesToPrinter =   1 <br>      PrintFileName   =   "" <br>      PrintFileType   =   2 <br>      SelectionFormula=   "" <br>      GroupSelectionFormula=   "" <br>      Connect         =   "" <br>      UserName        =   "" <br>      ReportSource    =   0 <br>      BoundReportHeading=   "" <br>      BoundReportFooter=   -1  'True <br>   End <br>   Begin MSOutl.Outline olnData  <br>      Height          =   750 <br>      Left            =   420 <br>      TabIndex        =   6 <br>      Top             =   240 <br>      Width           =   1500 <br>      _Version        =   65536 <br>      _ExtentX        =   2646 <br>      _ExtentY        =   1323 <br>      _StockProps     =   77 <br>      BorderStyle     =   0 <br>      Style           =   5 <br>   End <br>   Begin VB.Label lblFileSpec  <br>      Appearance      =   0  'Flat <br>      BackColor       =   &amp;H80000005&amp; <br>      Caption         =   "File Specification" <br>      ForeColor       =   &amp;H80000008&amp; <br>      Height          =   195 <br>      Left            =   1740 <br>      TabIndex        =   5 <br>      Top             =   1860 <br>      Visible         =   0   'False <br>      Width           =   2175 <br>   End <br>End <br>Attribute VB_Name = "frmSiteHierarchyReport" <br>Attribute VB_Creatable = False <br>Attribute VB_Exposed = False <br>Option Explicit <br> <br>'//**************************************************************************** <br>'// <br>'//  Copyright (c) 1995, Microsoft Corporation <br>'// <br>'//  File:  SITEHIER.FRM <br>'// <br>'//  History: <br>'// <br>'//      Gary Fuehrer, SEA   5/9/95      Created. <br>'// <br>'//**************************************************************************** <br> <br>Dim hConnect&amp; <br>Dim ReportTempSpec$ <br>Dim NewNumber% <br>Dim db As Database <br>Dim dbt As Database <br> <br>'Some relavent names for the outline control pictures <br>Const MSOUTLINE_PICTURE_ROOT = SITEHIERTYPE_ROOT <br>Const MSOUTLINE_PICTURE_SITE = SITEHIERTYPE_SITE <br>Const MSOUTLINE_PICTURE_DOMAIN = SITEHIERTYPE_DOMAIN <br> <br>'State flags <br>Dim bGetData%  'If True, getting site data from SMS. <br>Dim bReadData% 'If True, reading site data from file. <br> <br>Private Sub chkDirty_Click() <br>    UpdateCaption <br>End Sub <br> <br>Private Sub cmdAbort_Click() <br>    'Handle user abort of current lengthy operation <br>    If bGetData% Then <br>        If MsgBox("Do you want to stop gathering site data?" + Chr$(10) + Chr$(10) + "Click Yes to abort, No to continue.", MB_YESNO + MB_ICONQUESTION, Caption) = IDYES Then <br>            bGetData% = False <br>        End If <br>    ElseIf bReadData% Then <br>        If MsgBox("Do you want to stop reading site data?" + Chr$(10) + Chr$(10) + "Click Yes to abort, No to continue.", MB_YESNO + MB_ICONQUESTION, Caption) = IDYES Then <br>            bReadData% = False <br>        End If <br>    End If <br>End Sub <br> <br>Private Sub cmdExport_Click() <br>    Dim FileSpec$, nPos%, Resp%, FileKilled% <br> <br>    'Build suggested file spec <br>    If lblFileSpec &gt; "" Then <br>        nPos% = InStr(lblFileSpec, ".") - 1 <br>        If nPos% &lt; 0 Then nPos% = Len(lblFileSpec) <br>        FileSpec$ = left$(lblFileSpec, nPos) + ".TXT" <br>    Else: FileSpec$ = "*.TXT" <br>    End If <br> <br>    'Get from the user the print file name <br>    FileSpec$ = GetSaveAsFileSpec$(FileSpec$, "ASCII Text (*.TXT) |*.TXT |All Files (*.*) |*.*") <br>    If FileSpec$ &lt;= "" Then Exit Sub <br> <br>    'See if we need to delete existing file <br>    '(Crystal Reports can't overwrite an existing file) <br>    If Dir$(FileSpec$) &gt; "" Then <br>        FileKilled% = 0 <br>        Do <br>            On Error Resume Next <br>            Kill FileSpec <br>            If Err &gt; 0 Then <br>                Resp% = MsgBox("An error occured writing to file " + FileSpec$ + ":" + Chr$(10) + Error$ + Chr$(10) + Chr$(10) + "Do you want to try again?", MB_RETRYCANCEL Or MB_ICONQUESTION, Caption) <br>                If Resp% = IDCANCEL Then Exit Sub <br>            Else: FileKilled% = True <br>            End If <br>        Loop Until FileKilled% <br>    End If <br> <br>    'Set the print file name and type <br>    CrystalReport.PrintFileName = CommonDialog.filename <br>    CrystalReport.PrintFileType = 2 'ASCII text <br> <br>    'Export report code <br>    PrintDoc CRW_PRINT_TO_FILE <br>End Sub <br> <br>Private Sub cmdInitialize_Click() <br>    If lblFileSpec &gt; "" Then <br>        'Flag that we are in data reading mode <br>        bReadData% = True <br>        ReadSiteData "", -1 <br>        bReadData% = False <br>    Else <br>        'Flag that we are in gathering data mode <br>        bGetData% = True <br>        GetSiteData <br>        bGetData% = False <br>    End If <br>End Sub <br> <br>Private Sub cmdPrint_Click() <br>    'See if we need the print dialog <br>    If gbNeedPrintDialog% = True Then <br>        'Put up the print dialog <br>        CommonDialog.Flags = PD_NOSELECTION Or PD_NOPAGENUMS Or PD_HIDEPRINTTOFILE <br>        CommonDialog.Copies = 1 <br>        CommonDialog.CancelError = True <br>        On Error Resume Next <br>        CommonDialog.Action = DLG_PRINT <br>        If Err = CDERR_CANCEL Then Exit Sub <br>        If Err &gt; 0 Then <br>            MsgBox "An unexpected error occured:" + Chr$(10) + Chr$(10) + Error$, MB_OK Or MB_ICONEXCLAMATION, Caption <br>            Exit Sub <br>        End If <br>        On Error GoTo 0 <br> <br>        'Handle user settings <br>        CrystalReport.CopiesToPrinter = CommonDialog.Copies <br>    Else <br>        'Supply default settings <br>        CrystalReport.CopiesToPrinter = 1 <br>    End If <br> <br>    'Print document <br>    PrintDoc CRW_PRINT_TO_PRINTER <br>End Sub <br> <br>Private Sub cmdPrintPreview_Click() <br>    'Print Preview document <br>    PrintDoc CRW_PRINT_TO_WINDOW <br>End Sub <br> <br>Private Sub cmdSave_Click() <br>    'See if we need to do a Save or a Save As <br>    If lblFileSpec &gt; "" Then <br>        SaveDoc lblFileSpec <br>    Else: cmdSaveAs_Click <br>    End If <br>End Sub <br> <br>Private Sub cmdSaveAs_Click() <br>    Dim NewFileSpec$ <br> <br>    NewFileSpec$ = GetSaveAsFileSpec$(lblFileSpec, "Access 1.0 (*.MDB) |*.MDB |All Files (*.*) |*.*") <br>    If NewFileSpec$ &lt;= "" Then Exit Sub <br> <br>    SaveDoc NewFileSpec$ <br>End Sub <br> <br>Private Sub Form_Load() <br>    'Position outline control (will be resized in Form Resize) <br>    olnData.left = 0 <br>    olnData.top = 0 <br> <br>    chkDirty = False <br> <br>    NewNumber% = InitReportNewNumber% <br>    hConnect&amp; = InitReporthConnect&amp; <br>    lblFileSpec = InitReportFileSpec$ <br>    ReportTempSpec$ = InitReportTempSpec$ <br> <br>    Set dbt = OpenDatabase(ReportTempSpec$, True) <br>    If lblFileSpec &gt; "" Then Set db = OpenDatabase(lblFileSpec, True, True) <br>End Sub <br> <br>Private Sub Form_QueryUnload(Cancel As Integer, UnloadMode As Integer) <br>    Dim Resp%, FileSpec$ <br> <br>    'Make sure we're not in the middle of something <br>    If bGetData% Or bReadData% Then <br>        cmdAbort_Click <br>        Cancel = True <br>        Exit Sub <br>    End If <br> <br>    'Give the user a chance to save document <br>    If chkDirty Then <br>        Resp% = MsgBox("This report has been modified. Save data before closing?", MB_YESNOCANCEL Or MB_ICONQUESTION, Caption) <br>        If Resp% = IDYES Then <br>            cmdSave_Click <br>            If chkDirty Then Cancel = True <br>        ElseIf Resp% = IDCANCEL Then: Cancel = True <br>        End If <br>    End If <br>End Sub <br> <br>Private Sub Form_Resize() <br>    Static OldWidth, OldHeight <br>    Dim r As Rect, HBorderPixels%, VBorderPixels% <br> <br>    'See if we're minimized <br>    If WindowState = MINIMIZED Then Exit Sub <br> <br>    'Get client size of form (already in pixels, I find) <br>    GetClientRect hwnd, r <br>    HBorderPixels% = Width / X_PIX_SIZE - r.right <br>    VBorderPixels% = Height / Y_PIX_SIZE - r.bottom <br> <br>    If OldWidth &lt;&gt; Width And Width - X_PIX_SIZE * HBorderPixels% &gt; olnData.left Then <br>        olnData.Width = Width - X_PIX_SIZE * HBorderPixels% - olnData.left <br> <br>        OldWidth = Width <br>    End If <br> <br>    If OldHeight &lt;&gt; Height And Height - Y_PIX_SIZE * VBorderPixels% &gt; olnData.top Then <br>        olnData.Height = Height - Y_PIX_SIZE * VBorderPixels% - olnData.top <br> <br>        OldHeight = Height <br>    End If <br>End Sub <br> <br>Private Sub Form_Unload(Cancel As Integer) <br>    dbt.Close <br>    If Not db Is Nothing Then db.Close <br> <br>    'Kill temp file <br>    On Error Resume Next <br>    Kill ReportTempSpec$ <br>    On Error GoTo 0 <br> <br>    FreeReportWindow Me <br>End Sub <br> <br>Private Function GetSaveAsFileSpec$(ByVal InitFileSpec$, Filter$) <br>    'Default return value empty (User canceled) <br>    GetSaveAsFileSpec$ = "" <br> <br>    CommonDialog.CancelError = True <br>    CommonDialog.filename = InitFileSpec$ <br>    CommonDialog.Filter = Filter$ <br>    CommonDialog.FilterIndex = 1 <br>    CommonDialog.Flags = OFN_OVERWRITEPROMPT Or OFN_PATHMUSTEXIST Or OFN_HIDEREADONLY <br>    On Error Resume Next <br>    CommonDialog.Action = DLG_FILE_SAVE <br>    If Err = CDERR_CANCEL Then Exit Function <br>    If Err &gt; 0 Then <br>        MsgBox "An unexpected error occured:" + Chr$(10) + Error$, MB_OK Or MB_ICONEXCLAMATION, Caption <br>        Exit Function <br>    End If <br>    On Error GoTo 0 <br> <br>    GetSaveAsFileSpec$ = CommonDialog.filename <br>End Function <br> <br>Private Sub GetSiteData() <br>    Dim hContainer&amp;, hSubFolder&amp;, ItemNum&amp;, RootSite As SiteRec <br>    Dim sScalar As SCALAR <br>    Dim lRet&amp;, Resp% <br> <br>    'Reset item number <br>    ItemNum&amp; = 0 <br> <br>    lRet&amp; = SmsOpenContainer&amp;(C_SITE, hConnect&amp;, hContainer&amp;) <br>    If lRet&amp; &lt;&gt; SMS_OK Then <br>        MsgBox "SMS Error:" + Chr$(10) + Chr$(10) + SMSError$(lRet&amp;), MB_ICONEXCLAMATION + MB_OK, Caption <br>        Exit Sub <br>    End If <br> <br>    lRet&amp; = SmsPopulate&amp;(hContainer&amp;, POP_SYNC, ByVal 0&amp;) <br>    If lRet&amp; &lt;&gt; SMS_OK And lRet&amp; &lt;&gt; SMS_EMPTY Then <br>        MsgBox "SMS Error:" + Chr$(10) + Chr$(10) + SMSError$(lRet&amp;), MB_ICONEXCLAMATION + MB_OK, Caption <br>        GoTo GetSiteDataCleanup <br>    End If <br> <br>    'List the root sites in this container <br>    Resp% = IDOK <br>    lRet&amp; = SmsGetNextFolder&amp;(hContainer&amp;, F_ANY, hSubFolder&amp;) <br>    Do While lRet&amp; = SMS_OK <br>        'Get this site's depth <br>        lRet&amp; = SmsGetScalarByName&amp;(hSubFolder&amp;, "Depth", sScalar) <br>        If lRet&amp; &lt;&gt; SMS_OK Then <br>            Resp% = MsgBox("SMS Error:" + Chr$(10) + Chr$(10) + SMSError$(lRet&amp;), MB_ICONEXCLAMATION + MB_ABORTRETRYIGNORE, Caption) <br>        Else <br>            'Only recurse from top level Site (Depth = 0) <br>            If sScalar.dwValue&amp; &lt;&gt; 0 Then <br>                Resp% = IDOK <br>            Else <br>                'Get subfolders recursively <br>                Resp% = GetSiteDataRecursive%(dbt, hSubFolder&amp;, CInt(olnData.ListCount), RootSite, ItemNum&amp;) <br> <br>                'See if the user canceled <br>                If Not bGetData% Then Resp% = IDABORT <br>            End If <br>        End If <br> <br>        'Check the user response <br>        Select Case Resp% <br>            Case IDOK, IDIGNORE <br>                lRet&amp; = SmsCloseFolder&amp;(hSubFolder&amp;) <br>                lRet&amp; = SmsGetNextFolder&amp;(hContainer&amp;, F_ANY, hSubFolder&amp;) <br>                Resp% = IDOK <br>            Case IDABORT <br>                lRet&amp; = SmsCloseFolder&amp;(hSubFolder&amp;) <br>                lRet&amp; = SMS_NO_MORE_DATA <br>            Case IDRETRY <br>                lRet&amp; = SMS_OK <br>        End Select <br>    Loop <br>    If lRet&amp; &lt;&gt; SMS_NO_MORE_DATA Then <br>        MsgBox "SMS Error:" + Chr$(10) + Chr$(10) + SMSError$(lRet&amp;), MB_ICONEXCLAMATION + MB_OK, Caption <br>    End If <br> <br>GetSiteDataCleanup: <br>    lRet&amp; = SmsCloseContainer&amp;(hContainer&amp;) <br>    chkDirty = CHECKED <br>End Sub <br> <br>Private Function GetSiteDataRecursive%(db As Database, ByVal hFolder&amp;, ParentListIndex%, ParentSite As SiteRec, ItemNum&amp;) <br>    Dim hSubFolder&amp;, FolderType&amp; <br>    Dim sScalar As SCALAR <br>    Dim Site As SiteRec <br>    Dim ListIndex%, bGetDataOld% <br>    Dim lRet&amp;, Resp% <br> <br>    'Default return value IDOK (Entry added) <br>    GetSiteDataRecursive% = IDOK <br> <br>    'Location of next item to add to outline control <br>    ListIndex% = olnData.ListCount <br> <br>    'Get this folder's type (site or domain) <br>    lRet&amp; = SmsGetFolderType&amp;(hFolder&amp;, FolderType&amp;, Site.TypeName$) <br>    If lRet&amp; &lt;&gt; SMS_OK Then <br>        GetSiteDataRecursive% = MsgBox("SMS Error:" + Chr$(10) + Chr$(10) + SMSError$(lRet&amp;), MB_ICONEXCLAMATION + MB_ABORTRETRYIGNORE, Caption) <br>        Exit Function <br>    End If <br> <br>    Select Case Site.TypeName$ <br>        Case "Domain" <br>            lRet&amp; = SmsGetScalarByName&amp;(hFolder&amp;, "Site code", sScalar) <br>            If lRet&amp; &lt;&gt; SMS_OK Then <br>                GetSiteDataRecursive% = MsgBox("SMS Error:" + Chr$(10) + Chr$(10) + SMSError$(lRet&amp;), MB_ICONEXCLAMATION + MB_ABORTRETRYIGNORE, Caption) <br>                Exit Function <br>            End If <br>            Site.Parent$ = sScalar.pszValue <br>             <br>            lRet&amp; = SmsGetFolderID&amp;(hFolder&amp;, Site.Name$) <br>            If lRet&amp; &lt;&gt; SMS_OK Then <br>                GetSiteDataRecursive% = MsgBox("SMS Error:" + Chr$(10) + Chr$(10) + SMSError$(lRet&amp;), MB_ICONEXCLAMATION + MB_ABORTRETRYIGNORE, Caption) <br>                Exit Function <br>            End If <br>            Site.Name$ = Site.Name$ <br> <br>            Site.Code$ = "" <br>            Site.Type% = SITEHIERTYPE_DOMAIN <br>            Site.Depth% = ParentSite.Depth% + 1 <br> <br>            ParentSite.ItemNum&amp; = ParentSite.ItemNum&amp; + 1 <br>            Site.ItemNum&amp; = ParentSite.ItemNum&amp; <br> <br>        Case "Site" <br>            lRet&amp; = SmsGetFolderID&amp;(hFolder&amp;, Site.Code$) <br>            If lRet&amp; &lt;&gt; SMS_OK Then <br>                GetSiteDataRecursive% = MsgBox("SMS Error:" + Chr$(10) + Chr$(10) + SMSError$(lRet&amp;), MB_ICONEXCLAMATION + MB_ABORTRETRYIGNORE, Caption) <br>                Exit Function <br>            End If <br> <br>            lRet&amp; = SmsGetScalarByName&amp;(hFolder&amp;, "Parent site", sScalar) <br>            If lRet&amp; &lt;&gt; SMS_OK Then <br>                GetSiteDataRecursive% = MsgBox("SMS Error:" + Chr$(10) + Chr$(10) + SMSError$(lRet&amp;), MB_ICONEXCLAMATION + MB_ABORTRETRYIGNORE, Caption) <br>                Exit Function <br>            End If <br>            Site.Parent$ = sScalar.pszValue <br> <br>            lRet&amp; = SmsGetScalarByName&amp;(hFolder&amp;, "Depth", sScalar) <br>            If lRet&amp; &lt;&gt; SMS_OK Then <br>                GetSiteDataRecursive% = MsgBox("SMS Error:" + Chr$(10) + Chr$(10) + SMSError$(lRet&amp;), MB_ICONEXCLAMATION + MB_ABORTRETRYIGNORE, Caption) <br>                Exit Function <br>            End If <br>            Site.Depth = sScalar.dwValue&amp; <br> <br>            lRet&amp; = SmsGetScalarByName&amp;(hFolder&amp;, "Site name", sScalar) <br>            If lRet&amp; &lt;&gt; SMS_OK Then <br>                GetSiteDataRecursive% = MsgBox("SMS Error:" + Chr$(10) + Chr$(10) + SMSError$(lRet&amp;), MB_ICONEXCLAMATION + MB_ABORTRETRYIGNORE, Caption) <br>                Exit Function <br>            End If <br>            Site.Name$ = sScalar.pszValue <br> <br>            lRet&amp; = SmsGetScalarByName&amp;(hFolder&amp;, "Site type", sScalar) <br>            If lRet&amp; &lt;&gt; SMS_OK Then <br>                GetSiteDataRecursive% = MsgBox("SMS Error:" + Chr$(10) + Chr$(10) + SMSError$(lRet&amp;), MB_ICONEXCLAMATION + MB_ABORTRETRYIGNORE, Caption) <br>                Exit Function <br>            End If <br>            Site.TypeName$ = sScalar.pszValue + " " + Site.TypeName$ <br> <br>            If Site.Parent$ &gt; "" Then <br>                Site.Type% = SITEHIERTYPE_SITE <br>            Else: Site.Type% = SITEHIERTYPE_ROOT <br>            End If <br> <br>            Site.ItemNum&amp; = ItemNum&amp; <br>            ItemNum&amp; = ItemNum&amp; + &amp;H10000 <br> <br>        Case Else <br>            Exit Function <br>    End Select <br> <br>    DoEvents <br> <br>    'Check to see if the user wants to cancel <br>    If bGetData% Then <br>        'Add item to database <br>        If InsertSite&amp;(db, Site) = 1 Then <br>            'Add item to outline control <br>            olnData.AddItem Site.Name$, ListIndex% <br>            olnData.Indent(ListIndex%) = Site.Depth% <br>            olnData.PictureType(ListIndex%) = Site.Type% <br>            olnData.ItemData(ListIndex%) = Site.ItemNum&amp; <br>            If olnData.IsItemVisible(ParentListIndex%) And Not olnData.Expand(ParentListIndex%) Then <br>                olnData.Expand(ParentListIndex%) = True <br>            End If <br>            If olnData.ListIndex = ListIndex% - 1 Then <br>                olnData.ListIndex = ListIndex% <br>            End If <br>            olnData.Refresh <br>            Resp% = IDOK <br>        Else: Resp% = MsgBox("Database Error:" + Chr$(10) + Chr$(10) + Error$, MB_ICONEXCLAMATION + MB_ABORTRETRYIGNORE, Caption) <br>        End If <br>    Else: Resp% = IDABORT <br>    End If <br> <br>    'Make sure everything is OK and get first subfolder <br>    If Site.Type% &lt;&gt; SITEHIERTYPE_DOMAIN And Resp% = IDOK Then <br>        lRet&amp; = SmsGetNextFolder&amp;(hFolder&amp;, F_ANY, hSubFolder&amp;) <br>    Else: lRet&amp; = SMS_NO_MORE_DATA <br>    End If <br> <br>    'List the sub-folders in this folder <br>    Do While lRet&amp; = SMS_OK <br>        'Get subfolders recursively <br>        Resp% = GetSiteDataRecursive%(db, hSubFolder&amp;, ListIndex%, Site, ItemNum&amp;) <br> <br>        'See if user canceled <br>        If Not bGetData% Then Resp% = IDABORT <br> <br>        'Check the user response <br>        Select Case Resp% <br>            Case IDOK, IDIGNORE <br>                lRet&amp; = SmsCloseFolder&amp;(hSubFolder&amp;) <br>                lRet&amp; = SmsGetNextFolder&amp;(hFolder&amp;, F_ANY, hSubFolder&amp;) <br>                Resp% = IDOK <br>            Case IDABORT <br>                lRet&amp; = SmsCloseFolder&amp;(hFolder&amp;) <br>                lRet&amp; = SMS_NO_MORE_DATA <br>            Case IDRETRY <br>                lRet&amp; = SMS_OK <br>        End Select <br>    Loop <br>    If lRet&amp; &lt;&gt; SMS_NO_MORE_DATA Then <br>        MsgBox "SMS Error:" + Chr$(10) + Chr$(10) + SMSError$(lRet&amp;), MB_ICONEXCLAMATION + MB_OK, Caption <br>    End If <br> <br>    'If we're done with the item, collapse it <br>    If Resp% = IDOK Then <br>        If (olnData.ListIndex &lt;= ListIndex% Or olnData.ListIndex = olnData.ListCount - 1) And olnData.HasSubItems(ListIndex%) Then <br>            'Preserve flag and allow Collapse to remove nodes <br>            bGetDataOld% = bGetData% <br>            bGetData% = False <br> <br>            'Collapse the site now that its done <br>            olnData_Collapse ListIndex% <br> <br>            'Restore flag <br>            bGetData% = bGetDataOld% <br>        End If <br>    End If <br> <br>    'Set the return value (either IDABORT or IDOK) <br>    GetSiteDataRecursive% = Resp% <br>End Function <br> <br>Private Sub lblFileSpec_Change() <br>    UpdateCaption <br>End Sub <br> <br>Private Sub olnData_Collapse(ListIndex As Integer) <br>    If Not bGetData% And Not bReadData% Then <br>        Do While olnData.HasSubItems(ListIndex%) <br>            olnData_Collapse ListIndex% + 1 <br>            olnData.RemoveItem ListIndex% + 1 <br>        Loop <br>    End If <br>End Sub <br> <br>Private Sub olnData_DblClick() <br>    If olnData.HasSubItems(olnData.ListIndex) Then <br>        olnData_Collapse CInt(olnData.ListIndex) <br>    Else: olnData_Expand CInt(olnData.ListIndex) <br>    End If <br>End Sub <br> <br>Private Sub olnData_Expand(ListIndex As Integer) <br>    Dim Site As SiteRec <br>    Static bExpanded% <br> <br>    'Prevent infinite recursion <br>    If bExpanded% Then Exit Sub <br> <br>    If Not bReadData% Then <br>        If Not olnData.HasSubItems(ListIndex) Then <br>            'Find the info on the node to expand <br>            Site.ItemNum&amp; = olnData.ItemData(ListIndex) <br>            If FindSite(dbt, Site) &lt;&gt; 1 Then <br>                MsgBox "Unexpected error trying to expand site:" + Chr$(10) + Chr$(10) + Error$, MB_OK + MB_ICONEXCLAMATION, Caption <br>                Exit Sub <br>            Else: If Site.Type = SITEHIERTYPE_DOMAIN Then Exit Sub <br>            End If <br>     <br>            'Read the sites children from the data file <br>            bReadData% = True <br>            ReadSiteData Site.Code$, ListIndex <br>            bReadData% = False <br>        End If <br> <br>        'Expand the node to show children <br>        If olnData.HasSubItems(ListIndex) Then <br>            bExpanded% = True <br>            olnData.Expand(ListIndex%) = True <br>            bExpanded% = False <br>        End If <br>    End If <br>End Sub <br> <br>Private Sub olnData_PictureClick(ListIndex As Integer) <br>    olnData.ListIndex = ListIndex <br>End Sub <br> <br>Private Sub olnData_PictureDblClick(ListIndex As Integer) <br>    olnData.ListIndex = ListIndex <br>    olnData_DblClick <br>End Sub <br> <br>Private Sub PrintDoc(Destination%) <br>    CrystalReport.WindowTitle = Caption <br>    CrystalReport.Destination = Destination% <br>    CrystalReport.WindowParentHandle = 0 <br>    CrystalReport.DataFiles(0) = ReportTempSpec$ <br>    CrystalReport.ReportFileName = App.Path + "\SITEHIER.RPT" <br> <br>    'Print the report <br>    CrystalReport.Action = 1 <br>End Sub <br> <br>Private Sub ReadSiteData(Parent$, ParentListIndex%) <br>    Dim ListIndex%, TooMany%, DBError% <br>    Dim Site As SiteRec <br> <br>    'Select all children of Parent$ sites <br>    Site.Parent$ = Parent$ <br>    Site.Code$ = "" <br>    If QuerySite%(dbt, Site) = False Then <br>        MsgBox "Error accessing database" <br>        Exit Sub <br>    End If <br> <br>    TooMany% = False <br>    ListIndex% = ParentListIndex% + 1 <br>    Do While FetchSite%(Site, Not bReadData% Or TooMany%, DBError%) <br>        If DBError% Then <br>            MsgBox "Error accessing database" <br>            Exit Sub <br>        ElseIf olnData.ListCount &gt;= MAX_OUTLINE_ENTRIES Then <br>            TooMany% = True <br>        Else <br>            olnData.AddItem Site.Name$, ListIndex% <br>            olnData.Indent(ListIndex%) = Site.Depth% <br>            olnData.PictureType(ListIndex%) = Site.Type% <br>            olnData.ItemData(ListIndex%) = Site.ItemNum&amp; <br>            ListIndex% = ListIndex% + 1 <br> <br>            'DoEvents 'Turned off because its too slow! <br>                      'Turn back on to check for user cancel <br>        End If <br>    Loop <br> <br>    If TooMany% Then <br>        MsgBox "No more sites and domains can be displayed in this window until some are collapsed." <br>    End If <br>End Sub <br> <br>Private Sub SaveDoc(ByVal FileSpec$) <br>    Dim ReportSaved%, Resp% <br>     <br>    'Temporarily close the database and temp database <br>    dbt.Close <br>    If Not db Is Nothing Then db.Close <br> <br>    ReportSaved% = False <br>    Do <br>        On Error Resume Next <br>        FileCopy ReportTempSpec$, FileSpec$ <br>        If Err &gt; 0 Then <br>            Resp% = MsgBox("An error occured trying to save " + FileSpec$ + ":" + Chr$(10) + Error$ + Chr$(10) + Chr$(10) + "Do you want to try again?", MB_OKCANCEL Or MB_ICONQUESTION, Caption) <br>            If Resp% = IDCANCEL Then Exit Sub <br>        Else: ReportSaved% = True <br>        End If <br>    Loop Until ReportSaved% <br> <br>    'Re-open the database and temp database <br>    Set dbt = OpenDatabase(ReportTempSpec$, True) <br>    Set db = OpenDatabase(FileSpec$, True, True) <br> <br>    If ReportSaved% Then <br>        lblFileSpec = FileSpec$ <br>        chkDirty = False <br>    End If <br>End Sub <br> <br>Private Sub UpdateCaption() <br>    Dim NewCaption$ <br> <br>    If lblFileSpec &gt; "" Then <br>        NewCaption$ = lblFileSpec <br>    Else: NewCaption$ = "New Site Hierarchy Report " + CStr(NewNumber) <br>    End If <br> <br>    If chkDirty Then NewCaption$ = NewCaption$ + "*" <br> <br>    Caption = NewCaption$ <br>End Sub <br> <br></code></pre>
<p>&nbsp;</p></body>
</HTML>
