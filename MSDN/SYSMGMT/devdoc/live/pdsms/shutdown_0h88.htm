<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<HTML dir=ltr>
<HEAD>
<META HTTP-EQUIV="Content-Type" Content="text/html; charset=Windows-1252">
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-83731338-2"></script><script>  window.dataLayer = window.dataLayer || [];  function gtag(){dataLayer.push(arguments);}  gtag('js', new Date());  gtag('config', 'UA-83731338-2');</script><title>Displaying the Shutdown Dialog Box</title>
<link disabled rel=stylesheet href=../../backsdk3.css>
<style type="text/css">
@import url(../../backsdk4.css);
</style>
</HEAD>
<BODY BGCOLOR = #FFFFFF TEXT = #000000>

<h2><a name="_win32_displaying_the_shutdown_dialog_box"></a>Displaying the Shutdown Dialog Box</h2>
<p>
<b>Windows NT: </b>The following example uses the <a href="shutdown_04ry.htm"><b>InitiateSystemShutdown</b></a> function to begin the system shutdown process on the computer on which is user is logged on. The application must first enable the SE_SHUTDOWN_NAME privilege. </p>
<pre><code>HANDLE hToken;              // handle to process token 
TOKEN_PRIVILEGES tkp;       // pointer to token structure 
 
BOOL fResult;               // system shutdown flag 
 
// Get the current process token handle so we can get shutdown 
// privilege. 
 
if (!OpenProcessToken(GetCurrentProcess(), 
        TOKEN_ADJUST_PRIVILEGES | TOKEN_QUERY, &amp;hToken)) 
    ErrorHandler("OpenProcessToken failed."); 
 
// Get the LUID for shutdown privilege. 
 
LookupPrivilegeValue(NULL, SE_SHUTDOWN_NAME, 
        &amp;tkp.Privileges[0].Luid); 
 
tkp.PrivilegeCount = 1;  // one privilege to set    
tkp.Privileges[0].Attributes = SE_PRIVILEGE_ENABLED; 
 
// Get shutdown privilege for this process. 
 
AdjustTokenPrivileges(hToken, FALSE, &amp;tkp, 0, 
    (PTOKEN_PRIVILEGES) NULL, 0); 
 
// Cannot test the return value of AdjustTokenPrivileges. 
 
if (GetLastError() != ERROR_SUCCESS) 
    ErrorHandler("AdjustTokenPrivileges enable failed."); 
 
// Display the shutdown dialog box and start the time-out countdown. 
 
fResult = InitiateSystemShutdown( 
    NULL,                                  // shut down local computer 
    "Click on the main window and press \
     the Escape key to cancel shutdown.",  // message to user 
    20,                                    // time-out period 
    FALSE,                                 // ask user to close apps 
    TRUE);                                 // reboot after shutdown 
 
if (!fResult) 
{ 
    ErrorHandler("InitiateSystemShutdown failed."); 
} 
 
// Disable shutdown privilege. 
 
tkp.Privileges[0].Attributes = 0; 
AdjustTokenPrivileges(hToken, FALSE, &amp;tkp, 0, 
        (PTOKEN_PRIVILEGES) NULL, 0); 
 
if (GetLastError() != ERROR_SUCCESS) 
{
    ErrorHandler("AdjustTokenPrivileges disable failed."); 
} 
 </code></pre>
<p>
If the <a href="shutdown_5vou.htm"><b>AbortSystemShutdown</b></a> function is executed in the time-out period specified by <a href="shutdown_04ry.htm"><b>InitiateSystemShutdown</b></a>, the system does not shut down. In this example, the user can prevent the system from shutting down by clicking on the application's main window and pressing the esc key. The example processes the keystroke by calling <b>AbortSystemShutdown</b>. </p>
<pre><code>HANDLE hToken;              // handle to process token 
TOKEN_PRIVILEGES tkp;       // pointer to token structure 
 
BOOL fResult;               // system shutdown flag 
 
case WM_KEYDOWN: 
 
    // Process only the Escape key. 
 
    if (wParam != VK_ESCAPE) 
    { 
        break; 
    } 
 
    // Get the current process token handle  so we can get shutdown 
    // privilege. 
 
    if (!OpenProcessToken(GetCurrentProcess(), 
            TOKEN_ADJUST_PRIVILEGES | TOKEN_QUERY, &amp;hToken)) 
    {
        ErrorHandler("OpenProcessToken failed."); 
    }
 
    // Get the LUID for shutdown privilege. 
 
    LookupPrivilegeValue(NULL, SE_SHUTDOWN_NAME, 
            &amp;tkp.Privileges[0].Luid); 
 
    tkp.PrivilegeCount = 1;  // one privilege to set    
    tkp.Privileges[0].Attributes = SE_PRIVILEGE_ENABLED; 
 
    // Get shutdown privilege for this process. 
 
    AdjustTokenPrivileges(hToken, FALSE, &amp;tkp, 0, 
        (PTOKEN_PRIVILEGES)NULL, 0); 
 
    // Cannot test the return value of AdjustTokenPrivileges. 
 
    if (GetLastError() != ERROR_SUCCESS) 
    {
        ErrorHandler("AdjustTokenPrivileges enable failed."); 
    }
 
    // Prevent the system from shutting down. 
 
    fResult = AbortSystemShutdown(NULL); 
 
    if (!fResult) 
    { 
        ErrorHandler("AbortSystemShutdown failed."); 
    } 
 
    // Disable shutdown privilege. 
 
    tkp.Privileges[0].Attributes = 0; 
    AdjustTokenPrivileges(hToken, FALSE, &amp;tkp, 0, 
        (PTOKEN_PRIVILEGES) NULL, 0); 
 
    if (GetLastError() != ERROR_SUCCESS) 
    {
        ErrorHandler("AdjustTokenPrivileges disable failed."); 
    }
 
    break; 
 </code></pre>
<p>&nbsp;</p></body>
</HTML>
