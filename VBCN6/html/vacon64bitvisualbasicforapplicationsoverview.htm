<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<HTML>
<HEAD>
<META HTTP-EQUIV="Content-Type" Content="text/html; charset=Windows-1252">
<TITLE>64-Bit Visual Basic for Applications Overview</TITLE>
<style>@import url(office.css);</style>
	<link disabled rel="stylesheet" href="msoffice.css"></HEAD>


<BODY BGCOLOR="#FFFFFF" TEXT="#000000">


<TABLE ALIGN=right WIDTH=0 BORDER=0><TR><TD>
<OBJECT ID="hhobj_3" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="DeclareStatement">
</OBJECT>
<OBJECT ID="hhobj_4" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="LongPtrDataType">
</OBJECT>
<OBJECT ID="hhobj_5" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="LongLongDataType">
</OBJECT>
<OBJECT ID="hhobj_6" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="PtrSafeKeyword">
</OBJECT>
<OBJECT ID="hhobj_7" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="CompilerConstants">
</OBJECT>
<OBJECT ID="hhobj_8" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="VarTypeConstants">
</OBJECT>
<OBJECT ID="hhobj_9" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="DeftypeStatement">
</OBJECT>
<OBJECT ID="hhobj_10" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="TypeConversionFunctions">
</OBJECT>
</TD></TR></TABLE>



<H1><A NAME="vacon64bitvisualbasicforapplicationsoverview"></A>64-Bit Visual Basic for Applications Overview</H1>

<P class=ALNSR>

<P class=T> VBA includes language features that enable VBA code to run correctly in both 32-bit and 64-bit environments.</P>

<P class=T>Running VBA code that was written by using VBA version 6 and earlier on a 64-bit platform can result in errors if the code is not modified to run in 64-bit versions of an application. Errors will result because VBA version 6 and earlier implicitly targets 32-bit platforms and typically contains <A HREF="JavaScript:hhobj_3.Click()">Declare Statements</A>  that call into the Windows API using 32-bit data types for pointers and handles. Because VBA version 6 and earlier does not have a specific data type for pointers or handles, it uses the <B>Long</B> data type, which is a 32-bit 4-byte data type, to reference pointers and handles. Pointers and handles in 64-bit environments are 8-byte 64-bit quantities. These 64-bit quantities cannot be held in 32-bit data types.</P>

<P class=NT><B>Note</B>&nbsp;&nbsp;&nbsp;You only need to modify VBA code if it runs in the 64-bit version of an application.
</P>

<P class=T>The problem with running legacy VBA code in 64-bit applications is that trying to load 64-bits into a 32-bit data type truncates the 64-bit quantity. This can result in memory overruns, unexpected results in your code, and possible application failure.</P>

<P class=T>To address this problem and enable VBA code to work correctly in both 32-bit and 64-bit environments, several language features have been added to VBA. The table at the bottom of this document summarizes the new VBA language features. Three important additions are the <A HREF="JavaScript:hhobj_4.Click()">LongPtr</A>  type alias, the  <A HREF="JavaScript:hhobj_5.Click()">LongLong</A> data type, and the  <A HREF="JavaScript:hhobj_6.Click()">PtrSafe</A> keyword.</P>

<UL>
	<LI class=LB1> <A HREF="JavaScript:hhobj_4.Click()">LongPtr</A> - VBA now includes a variable type alias:  <A HREF="JavaScript:hhobj_4.Click()">LongPtr</A>. The actual data type that  <A HREF="JavaScript:hhobj_4.Click()">LongPtr</A> resolves to depends on the version of an application that it is running in:  <A HREF="JavaScript:hhobj_4.Click()">LongPtr</A> resolves to Long in 32-bit versions of an application, and  <A HREF="JavaScript:hhobj_4.Click()">LongPtr</A> resolves to  <A HREF="JavaScript:hhobj_5.Click()">LongLong</A> in 64-bit versions of an application. Use  <A HREF="JavaScript:hhobj_4.Click()">LongPtr</A> for pointers and handles.<BR><BR></LI>

	<LI class=LB1> <A HREF="JavaScript:hhobj_5.Click()">LongLong</A> - The  <A HREF="JavaScript:hhobj_5.Click()">LongLong</A> data type is a signed 64-bit integer that is only available on 64-bit versions of the hosting application. Use  <A HREF="JavaScript:hhobj_5.Click()">LongLong</A> for 64-bit integrals. Conversion functions must be used to explicitly assign  <A HREF="JavaScript:hhobj_5.Click()">LongLong</A> (including  <A HREF="JavaScript:hhobj_4.Click()">LongPtr</A> on 64-bit platforms) to smaller integral types. Implicit conversions of  <A HREF="JavaScript:hhobj_5.Click()">LongLong</A> to smaller integrals are not allowed. </LI>

	<LI class=LB1> <A HREF="JavaScript:hhobj_6.Click()">PtrSafe</A> - The  <A HREF="JavaScript:hhobj_6.Click()">PtrSafe</A> keyword asserts that a <A HREF="JavaScript:hhobj_3.Click()">Declare Statement</A> is safe to run in 64-bit versions of an application.</LI>
</UL>

<P class=T>All <A HREF="JavaScript:hhobj_3.Click()">Declare Statement</A> must now include the  <A HREF="JavaScript:hhobj_6.Click()">PtrSafe</A> keyword when running in 64-bit versions of an application. It is important to understand that simply adding the  <A HREF="JavaScript:hhobj_6.Click()">PtrSafe</A> keyword to a <A HREF="JavaScript:hhobj_3.Click()">Declare Statement</A> only signifies the <A HREF="JavaScript:hhobj_3.Click()">Declare Statement</A> explicitly targets 64-bits, all data types within the statement that need to store 64-bits (including return values and parameters) must still be modified to hold 64-bit quantities.</P>

<P class=NT><B>Note</B>&nbsp;&nbsp;&nbsp;<A HREF="JavaScript:hhobj_3.Click()">Declare Statements</A> with the  <A HREF="JavaScript:hhobj_6.Click()">PtrSafe</A> keyword is the recommended syntax. <A HREF="JavaScript:hhobj_3.Click()">Declare Statements</A> that include  <A HREF="JavaScript:hhobj_6.Click()">PtrSafe</A> work correctly in the VBA7 development environment on both 32-bit and 64-bit platforms. To ensure backwards compatibility in VBA7 and earlier use the following construct:
 </P>

<PRE class=CT><CODE>#If Vba7 Then 
Declare PtrSafe Sub... 
#Else 
Declare Sub... 
#EndIf
</CODE></PRE>

<P class=T>Consider the following <A HREF="JavaScript:hhobj_3.Click()">Declare Statement</A> examples. Running the unmodified <A HREF="JavaScript:hhobj_3.Click()">Declare Statement</A> in 64-bit versions of an application will result in an error indicating the <A HREF="JavaScript:hhobj_3.Click()">Declare Statement</A> does not include the  <A HREF="JavaScript:hhobj_6.Click()">PtrSafe</A> qualifier. The modified VBA example contains the  <A HREF="JavaScript:hhobj_6.Click()">PtrSafe</A> qualifier, but notice that the return value (a pointer to the active window) returns a Long data type. On 64-bit versions of an application, this is incorrect because the pointer needs to be 64-bits. The  <A HREF="JavaScript:hhobj_6.Click()">PtrSafe</A> qualifier tells the compiler the <A HREF="JavaScript:hhobj_3.Click()">Declare Statement</A> is targeting 64-bits, so the statement executes without error. But because the return value has not been updated to a 64-bit data type, the return value is truncated resulting in an incorrect value returned.</P>

<P class=T>Unmodified legacy VBA <A HREF="JavaScript:hhobj_3.Click()">Declare Statement</A> example: </P>

<PRE class=CT><CODE>Declare Function GetActiveWindow Lib "user32" () As Long</CODE></PRE>

<P class=T>VBA <A HREF="JavaScript:hhobj_3.Click()">Declare Statement</A> example modified to include the  <A HREF="JavaScript:hhobj_6.Click()">PtrSafe</A> qualifier but still using 32-bit values </P>

<PRE class=CT><CODE>Declare PtrSafe Function GetActiveWindow Lib "user32" () As Long
</CODE></PRE>

<P class=T>To reiterate, you must modify the <A HREF="JavaScript:hhobj_3.Click()">Declare Statement</A> to include the  <A HREF="JavaScript:hhobj_6.Click()">PtrSafe</A> qualifier and you must update any variables within the statement that need to hold 64-bit quantities so that the variables use 64-bit data types.</P>

<P class=T>VBA <A HREF="JavaScript:hhobj_3.Click()">Declare Statement</A> example modified to include the  <A HREF="JavaScript:hhobj_6.Click()">PtrSafe</A> keyword and updated to use the proper 64-bit (<A HREF="JavaScript:hhobj_4.Click()">LongPtr</A>) data type: </P>

<PRE class=CT><CODE>Declare PtrSafe Function GetActiveWindow Lib "user32" () As LongPtr</CODE></PRE>

<P class=T>In summary, for code to work in 64-bit versions of the hosting application, you need to locate and modify all existing <A HREF="JavaScript:hhobj_3.Click()">Declare Statements</A> to use the  <A HREF="JavaScript:hhobj_6.Click()">PtrSafe</A> qualifier. And you need to locate and modify all data types within these <A HREF="JavaScript:hhobj_3.Click()">Declare Statements</A> that reference handles or pointers to use the new 64-bit compatible  <A HREF="JavaScript:hhobj_4.Click()">LongPtr</A> type alias, and types that need to hold 64-bit integrals with the new  <A HREF="JavaScript:hhobj_5.Click()">LongLong</A> data type. Additionally, you must update any user defined types (UDTs) that contain pointers or handles, and 64-bit integrals to use 64-bit data types and verify all variable assignments are correct to prevent type mismatch errors. </P>

<H4>Writing code that works on both 32-bit and 64-bit applications</H4>

<P class=T>To write code that can port between both 32-bit and 64-bit versions of an application you only need to use the new <A HREF="JavaScript:hhobj_4.Click()">LongPtr</A> type alias instead of Long or  <A HREF="JavaScript:hhobj_5.Click()">LongLong</A> for all pointers and handle values. The  <A HREF="JavaScript:hhobj_4.Click()">LongPtr</A> type alias will resolve to the correct Long or  <A HREF="JavaScript:hhobj_5.Click()">LongLong</A> data type depending on which version of the application is running. Note that if you require different logic to execute, for example you need to manipulate 64-bit values in large project, you can use the Win64 conditional compilation constant as shown in the following section.</P>

<H4>Writing code that works on both versions of an application (32-bit or 64-bit) and previous versions of an application</H4>

<P class=T>To write code that can work in both new and older versions of an application, you can use a combination of the new <B>VBA7</B> and <B>Win64</B> conditional  <A HREF="JavaScript:hhobj_7.Click()">Compiler Constants</A>. The <B>Vba7</B> conditional  <A HREF="JavaScript:hhobj_7.Click()">Compiler Constant</A> is used to determine if code is running in version 7 of the VB editor. The Win64 conditional compilation constant is used to determine which version (32-bit or 64-bit) of the hosting application is running.</P>

<PRE class=CT><CODE>#if Vba7 then 
'  Code is running in the new VBA7 editor 
     #if Win64 then 
     '  Code is running in 64-bit version of the application
     #else 
     '  Code is running in 32-bit version of the application
     #end if 
#else 
' Code is running in VBA version 6 or earlier 
#end if 
 
 
 
#If Vba7 Then 
Declare PtrSafe Sub... 
#Else 
Declare Sub... 
#EndIf 
</CODE></PRE>

<H4>Summary of VBA7 Language Updates</H4>

<P class=T>The following table summarizes the new VBA language additions and provides an explanation of each:</P>

<TABLE cellpadding=4 cellspacing=4 cols=3>

<TR VALIGN="top">
<TH width=20%>Name</TH>
<TH width=20%>Type</TH>
<TH width=60%>Description</TH>
</TR>

<TR VALIGN="top">
<TD class=T width=20%> <A HREF="JavaScript:hhobj_6.Click()">PtrSafe</A></TD>
<TD class=T width=20%>Keyword</TD>
<TD class=T width=60%>Asserts that a <A HREF="JavaScript:hhobj_3.Click()">Declare Statement</A> is targeted for 64-bit systems. Required on 64-bits.
</TD>

</TR>
<TR VALIGN="top">
<TD class=T width=20%> <A HREF="JavaScript:hhobj_4.Click()">LongPtr</A></TD>
<TD class=T width=60%>Data type</TD>
<TD class=T width=60%>Type alias that maps to Long on 32-bit systems, or  <A HREF="JavaScript:hhobj_5.Click()">LongLong</A> on 64-bit systems.
</TD>
</TR>

<TR VALIGN="top">
<TD class=T width=20%> <A HREF="JavaScript:hhobj_5.Click()">LongLong</A></TD>
<TD class=T width=20%>Data type</TD>
<TD class=T width=60%>8 byte data type that is only available on 64bit systems. Numeric type. Integer numbers in the range of -9,223,372,036,854,775,808 to 9,223,372,036,854,775,807.  <A HREF="JavaScript:hhobj_5.Click()">LongLong</A> is a valid declared type only on 64-bit platforms. Additionally,  <A HREF="JavaScript:hhobj_5.Click()">LongLong</A> may not be implicitly converted to a smaller type (for example, you can’t assign a  <A HREF="JavaScript:hhobj_5.Click()">LongLong</A> to a Long.). This is done to prevent inadvertent pointer truncation. Explicit coercions are allowed, so in the example above, you could apply CLng to a  <A HREF="JavaScript:hhobj_5.Click()">LongLong</A> and assign the result to a Long. (Valid on 64-bit platforms only.)
</TD>
</TR>

<TR VALIGN="top">
<TD class=T width=20%>^</TD>
<TD class=T width=20%> <A HREF="JavaScript:hhobj_5.Click()">LongLong</A> type-declaration character</TD>
<TD class=T width=60%>Explicitly declares a literal value as a  <A HREF="JavaScript:hhobj_5.Click()">LongLong</A>. Required to declare a  <A HREF="JavaScript:hhobj_5.Click()">LongLong</A> literal that is larger than the maximum Long value (otherwise it will get implicitly converted to double).
</TD>
</TR>

<TR VALIGN="top">
<TD class=T width=20%> <A HREF="JavaScript:hhobj_10.Click()">CLngPtr</A></TD>
<TD class=T width=20%>type conversion function</TD>
<TD class=T width=60%>Converts a simple expression to a  <A HREF="JavaScript:hhobj_4.Click()">LongPtr</A>.</TD>
</TR>

<TR VALIGN="top">
<TD class=T width=20%> <A HREF="JavaScript:hhobj_10.Click()">CLngLng</A></TD>
<TD class=T width=20%>type conversion function
</TD>
<TD class=T width=60%>Converts a simple expression to a  <A HREF="JavaScript:hhobj_5.Click()">LongLong</A> data type. (Valid on 64-bit platforms only.)</TD>
</TR>

<TR VALIGN="top">
<TD class=T width=20%> <A HREF="JavaScript:hhobj_8.Click()">vbLongLong</A> <A HREF="JavaScript:hhobj_5.Click()">LongLong</A></TD>
<TD class=T width=20%>VarType constant

</TD>
<TD class=T width=60%>VarType constant.
</TD>
</TR>

<TR VALIGN="top">
<TD class=T width=20%> <A HREF="JavaScript:hhobj_9.Click()">DefLngPtr</A></TD>
<TD class=T width=20%>DefType statement
</TD>
<TD class=T width=60%>Sets the default data type for a range of variables as  <A HREF="JavaScript:hhobj_4.Click()">LongPtr</A>.</TD>
</TR>

<TR VALIGN="top">
<TD class=T width=20%> <A HREF="JavaScript:hhobj_9.Click()">DefLngLng</A></TD>
<TD class=T width=20%>DefType statement
</TD>
<TD class=T width=60%>Sets the default data type for a range of variables as  <A HREF="JavaScript:hhobj_5.Click()">LongLong</A>.</TD>
</TR>

</TABLE><BR>



</BODY>
</HTML>
