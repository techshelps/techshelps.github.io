<html><head>
<META http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
<!--SafClassName="docSection1Title"--><!--SafTocEntry="8.3 Create a Point-and-Click SQL Server Query Tool for Users Using a Windows Form"-->
<link rel="STYLESHEET" type="text/css" href="FILES/style.css">
<link rel="STYLESHEET" type="text/css" href="FILES/docsafari.css">
<style type="text/css">	.tt1    {font-size: 10pt;}</style>
</head>
<body><H3 class="docSection1Title">8.3 Create a Point-and-Click SQL Server Query Tool for Users Using a Windows Form</H3>
<P>Clients usually want a means of querying the tables, but they do not necessarily know how to create SQL statements. This example describes how to create a point-and-click query interface using a Windows Form and display fields from individual tables as they are chosen.</P>
<P>In just about every application you create, your clients need a means to view the data and want to be able to create their own lists. However, most don't want to have to learn how to create SQL statements. In this How-To, you will see a method for not only creating a point-and-click query tool that will allow the users to examine all tables in the database, but also for using the Windows Form in an application without modification.</P>
<H4 class="docSection2Title"> Technique</H4>
<P>To accomplish the task just presented, you will be using the <TT>OleDbCommand</TT> and <TT>DataReader</TT> object. Along with these objects, you will be using some stored procedures that SQL Server supplies. These stored procedures list the various objects within a SQL Server database-in this case, Northwind's tables and columns.</P>
<P>You will take the elements returned in the <TT>DataReader</TT> object and load the Add method of the <TT>ListBox</TT> object.</P>
<H4 class="docSection2Title"> Steps</H4>
<P>Open and run the VB.NET -Chapter 8 solution. From the main Windows Form, click on the command button with the caption How-To 8.3. The first list box you see to the left is populated with the tables from Northwind. Click on the Customer table, and you will see the columns in the next list box labeled Columns. Click on the CompanyName and ContactName, and you will see the SQL String text box filled in. After clicking on the View button, the form will look like the one displayed in Figure 8.5.</P>






<span style="font-weight:bold"><OL class="docList" START="1">
<LI><span style="font-weight:normal" value="1"><P>Create a Windows Form. Then place the controls shown in Figure 8.5 with the properties set forth in Table 8.4.</P>
<P><TABLE BORDER="1" align="center" CELLPADDING="6" CELLSPACING="0">
<CAPTION><h5 class="docTableTitle">Table 8.4. Labels, ListBoxes, DataGrid, TextBox, and Command Button Controls Property Settings</h5></CAPTION><COLGROUP span="3">
<TR>
<TH class="docTableHeader" align="left" valign="top">
<P>Object</P>
</TH>
<TH class="docTableHeader" align="left" valign="top">
<P>Property</P>
</TH>
<TH class="docTableHeader" align="left" valign="top">
<P>Setting</P>
</TH>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>Label</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Name</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Label1</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">&nbsp;</TD>
<TD class="docTableCell" valign="top">
<P><TT>Text</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Tables</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>Label</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Name</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Label2</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">&nbsp;</TD>
<TD class="docTableCell" valign="top">
<P><TT>Text</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Columns</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>Label</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Name</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Label3</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">&nbsp;</TD>
<TD class="docTableCell" valign="top">
<P><TT>Text</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>SQL String</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>Label</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Name</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Label4</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">&nbsp;</TD>
<TD class="docTableCell" valign="top">
<P><TT>Text</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Data Display</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>ListBox</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Name</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>lstTables</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>ListBox</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Name</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>lstColumns</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">&nbsp;</TD>
<TD class="docTableCell" valign="top">
<P><TT>SelectionMode</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>MultiSimple</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>TextBox</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Name</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>txtSQLString</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">&nbsp;</TD>
<TD class="docTableCell" valign="top">
<P><TT>MultiLine</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>True</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>Button</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Name</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>btnView</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>DataGrid</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Name</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>dgDisplay</TT></P>
</TD>
</TR>
</COLGROUP>
</TABLE></P>
<div class="docNote"><p class="docNoteTitle">Tip</p>
<p><table border="0" align="center" cellpadding="6" cellspacing="0"><tr>
<td width="60" valign="top"><IMG BORDER="0" ALIGN="LEFT" WIDTH="100" HEIGHT="100" src="FILES/tip_icon.gif" ALT="graphics/tip_icon.gif"></td>
<td valign="top"><P>Notice that the lstTables list box only allows the user to pick one table at a time, whereas lstColumns allows you to choose multiple columns.</P>
<P>A great enhancement to this tool would be to allow the user to select multiple tables and have the application figure out the relation between tables.</P>
</td>
</tr></table></p>
</div></span></LI><LI><span style="font-weight:normal" value="2"><P>In the class module for the form, add the following Private declaration just below the line of code that reads <TT>Windows Form Designer generated code</TT>:</P>
<pre>
Dim mcnn As New OleDb.OleDbConnection(BuildCnnStr("(local)", "Northwind"))
</pre>
<P>This line of code declares and assigns an OleDBConnection object that will be used throughout the form.</P></span></LI><LI><span style="font-weight:normal" value="3"><P>On the form, add the code in Listing 8.12 to the <TT>Load</TT> event. The first thing this code routine does is create a new <TT>OleDbCommand</TT> called <TT>ocmdTables</TT> and assign the built-in SQL Server stored procedure called sp_Tables. After establishing the CommandType as being <TT>CommandType.StoredProcedure</TT> and then opening the connection, the data reader called <TT>odrTables</TT> is created by calling the <TT>ExecuteReader</TT> method off <TT>ocmdTables</TT>.</P>
<H5 class="docExampleTitle">Listing 8.12 <TT>frmHowTo8_3.vb</TT>: Executing a SQL Server-Supplied Stored Procedure That Lists the Tables in the Database</H5>
<PRE>
Private Sub frmHowTo3_8_Load(ByVal sender As System.Object, _
                                ByVal e As System.EventArgs) Handles MyBase.Load

        '-- Create the connection and specify the stored procedure to use.
        Dim ocmdTables As New OleDb.OleDbCommand("sp_Tables", mcnn)
        Dim odrTables As OleDb.OleDbDataReader

        Try
            '-- Specify the type of command being performed
            ocmdTables.CommandType = CommandType.StoredProcedure

            mcnn.Open()

            '-- Create the DataReader object
            odrTables = ocmdTables.ExecuteReader()

            '-- Loop through and add table-type object names
            '  to the lstTables list box.
            Do While odrTables.Read
                If odrTables.GetString(3) = "TABLE" Then
                    Me.lstTables.Items.Add(odrTables.GetString(2))
                End If
            Loop

            mcnn.Close()

        Catch excpData As Exception
            MessageBox.Show("Error Occurred: " &amp; excpData.Message)

        End Try

    End Sub
</PRE>
<P>Next, the code loops though each of the items returned by the command. Those of type <TT>TABLE</TT> are added to the lstTables items. Then the connection is closed.</P>
<P>As mentioned, you will see a comparison to the literal "TABLE." The reason for this is that the fourth column returned is the same table type as the current table. The other two types are <TT>SYSTEMTABLE</TT> and <TT>VIEW</TT>. To see the data returned by the <TT>sp_tables</TT> stored procedure, open the Query Analyzer, located on the Start menu, in Programs, Microsoft SQL Server. After opening up the Query Analyzer, highlight the Northwind database, and then type <TT>execute sp_tables</TT> into the Query Edit window and press F5 to execute the query. The results will be shown in the bottom of the window. Page down through the data until you see some of the type "TABLE" (see Figure 8.6).</P>
<CENTER><H5 class="docFigureTitle">Figure 8.6. Testing the built-in stored procedure called sp_tables.</H5><p><IMG BORDER="0" WIDTH="500" HEIGHT="375" src="FILES/08fig06.gif" ALT="graphics/08fig06.gif"></p>
</CENTER></span></LI><LI><span style="font-weight:normal" value="4"><P>On lstTables, add the code in Listing 8.13 to the <TT>SelectedIndexChanged</TT> event. This routine performs a similar feat to the previous routine in that it calls a built-in stored procedure-in this case, <TT>sp_Columns</TT>. However, the next task in this step is to pass a parameter, <TT>TableName</TT>, which is the table chosen in lstTables. After the connection is opened, the data reader called <TT>odrColumns</TT> is loaded with the <TT>ExecuteReader</TT> command. After the <TT>lstColumns.Items.Clear()</TT> method is called to clear the list, the new columns are added to lstColumns Items collection. Last, the connection is closed.</P>
<H5 class="docExampleTitle">Listing 8.13 <TT>frmHowTo8_3.vb</TT>: Executing a SQL Server Built-In Stored Procedure That Lists the Columns of a Supplied Table in the Database</H5>
<PRE>
Private Sub lstTables_SelectedIndexChanged(ByVal sender As System.Object,
            ByVal e As System.EventArgs) Handles lstTables.SelectedIndexChanged

        '-- Create the connection and specify the stored procedure to use.
        Dim ocmdColumns As New OleDb.OleDbCommand("sp_Columns", mcnn)
        Dim odrColumns As OleDb.OleDbDataReader

        Try
            '-- Specify the type of command being performed
            ocmdColumns.CommandType = CommandType.StoredProcedure
            ocmdColumns.Parameters.Add("@TableName", Me.lstTables.Text)

            mcnn.Open()

            '-- Create the DataReader object
            odrColumns = ocmdColumns.ExecuteReader()

            '-- Clear the current items in the list
            Me.lstColumns.Items.Clear()

            '-- Loop through and add table type object names
            '    to the lstTables list box.
            Do While odrColumns.Read
                Me.lstColumns.Items.Add(odrColumns.GetString(3))
            Loop

            mcnn.Close()

        Catch excpData As Exception
            MessageBox.Show("Error Occurred: " &amp; excpData.Message)

        End Try
End Sub
</PRE></span></LI><LI><span style="font-weight:normal" value="5"><P>On lstColumns, add the code in Listing 8.14 to the <TT>SelectedIndexChanged</TT> event. This routine iterates through the <TT>SelectedItems</TT> collection of the <TT>lstColumns ListBox</TT> control, adding the chosen column names to a string variable called <TT>strTemp</TT>. The length of the string is checked; if the length is greater than 0, the Text property of <TT>txtSQLString</TT> is set to the following expression: <TT>"Select " &amp; strTemp &amp; " From " &amp; Me.lstTables.Text</TT>.</P>
<H5 class="docExampleTitle">Listing 8.14 <TT>frmHowTo8_3.vb</TT>: Creating the SQL String</H5>
<PRE>
Private Sub lstColumns_SelectedIndexChanged(ByVal sender As System.Object,
            ByVal e As System.EventArgs) Handles lstColumns.SelectedIndexChanged

        Dim strTemp As String
        Dim intNumColumns As Integer
        Dim oCurr As Object

        '-- Cycle through each of the selected columns of the table chosen
        '   and combine them into a string.

        For Each oCurr In Me.lstColumns.SelectedItems()

            If Len(strTemp) &gt; 0 Then
                strTemp &amp;= ", "
            End If

            strTemp &amp;= oCurr

        Next

        '-- Take the string created and add it to the table
        '    name for a SQL String
        '   if columns are chosen.

        If Len(strTemp) = 0 Then
            Me.txtSQLString.Text = ""
        Else
            Me.txtSQLString.Text = "Select " &amp; strTemp &amp; " From " &amp; _
           Me.lstTables.Text

        End If

End Sub
</PRE></span></LI><LI><span style="font-weight:normal" value="6"><P>On btnView, add the code in Listing 8.15 to the <TT>Click</TT> event. This routine creates the new data adapter called odaDisplay passes the <TT>Text</TT> property of <TT>txtSQLString</TT>, and then fills the dtDisplay data table. dtDisplay is then set to the <TT>DataSource</TT> property of the data grid called dgDisplay.</P>
<H5 class="docExampleTitle">Listing 8.15 <TT>frmHowTo8_3.vb</TT>: Loading the <TT>DataGrid</TT> Control with the Specified Data</H5>
<PRE>
Private Sub btnView_Click(ByVal sender As System.Object, _
                        ByVal e As System.EventArgs) Handles btnView.Click


        Dim odaDisplay As OleDb.OleDbDataAdapter
        Dim dtDisplay As New DataTable()

        Try

            '-- Take the txtSQLString text and create a data table; then set the
            '   data source of the data grid.

            odaDisplay = New OleDb.OleDbDataAdapter(Me.txtSQLString.Text, mcnn)

            odaDisplay.Fill(dtDisplay)

            Me.dgDisplay.DataSource = dtDisplay

        Catch excData As Exception

            MessageBox.Show(excData.Message)

        End Try

End Sub
</PRE></span></LI></OL></span>
<CENTER><H5 class="docFigureTitle">Figure 8.5. You can set the sorting of the data grid displayed here by clicking on the desired column.</H5><p><IMG BORDER="0" WIDTH="500" HEIGHT="318" src="FILES/08fig05.gif" ALT="graphics/08fig05.gif"></p>
</CENTER>
<H4 class="docSection2Title"> How It Works</H4>
<P>When the form is opened, the <TT>lstTables ListBox</TT> control is loaded with the tables from the Northwind database. When the user selects a table from the list, that table name is passed to the stored procedure that lists the columns in a table located in the database specified in the connection-in this case, Northwind. These columns are loaded into lstColumns.</P>
<P>The user can then click on multiple columns in lstColumns. The columns are then added to the SQL Select string that is created and stored in <TT>txtSQLString</TT>. When the btnView button is clicked, the string is passed to a <TT>DataAdapter</TT> control, filling a data table. The data is then displayed when the data source of the <TT>DataGrid</TT> control is set to the data table.</P>
<H4 class="docSection2Title"> Comments</H4>
<P>You can enhance this tool in a number of ways:</P>
<UL>
<LI><P>Allow users to click on multiple tables and automatically create the join.</P></LI>
<LI><P>Add a list of columns for the user to choose to use for criteria, and allow the user to input the criteria.</P></LI>
<LI><P>Use this tool as a base for editing or reporting the records that are returned.</P></LI>
<LI><P>Let the users specify the sorting order using a combo box.</P></LI>
</UL>
<div class="docNote"><p class="docNoteTitle">Tip</p>
<p><table border="0" align="center" cellpadding="6" cellspacing="0"><tr>
<td width="60" valign="top"><IMG BORDER="0" ALIGN="LEFT" WIDTH="100" HEIGHT="100" src="FILES/tip_icon.gif" ALT="graphics/tip_icon.gif"></td>
<td valign="top"><P>This last enhancement isn't necessary using the <TT>DataGrid</TT> control because you can click on the column heading and have it sort the columns for you.</P>
</td>
</tr></table></p>
</div><br>
<P>The goal of this technique, as with others in this book, is to push you into thinking about the possibilities of what you can accomplish with Visual Studio .NET and your databases.</P>
<ul></ul>
</body></html>
