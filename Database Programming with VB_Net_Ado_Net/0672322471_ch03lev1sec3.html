<html><head>
<META http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
<!--SafClassName="docSection1Title"--><!--SafTocEntry="3.1 Retrieve Data by Using the DataReader Object"-->
<link rel="STYLESHEET" type="text/css" href="FILES/style.css">
<link rel="STYLESHEET" type="text/css" href="FILES/docsafari.css">
<style type="text/css">	.tt1    {font-size: 10pt;}</style>
</head>
<body><H3 class="docSection1Title">3.1 Retrieve Data by Using the DataReader Object</H3>
<P>In Chapter 1, you learned how to use bound controls to <TT>OleDb</TT> controls that could be included on the forms. Some developers prefer to use unbound controls to perform the same task. The DataReader object allows you to add items to a list box in a more efficient manner because it is only a read-and-forward-only type object. This How-To tells you how to generate a limited ListBox control by using a <TT>DataReader</TT> object.</P>
<P>You want to create a limited list of customers. You don't want to use bound controls because you are a cool VB developer who knows better than that. You heard that the <TT>DataReader</TT> object is a fast way to get data. How do you retrieve data using the <TT>DataReader</TT> object to perform this task?</P>
<H4 class="docSection2Title"> Technique</H4>
<P>For this How-To, you will be using the <TT>ListBox</TT> control and loading items into it by using the <TT>DataReader</TT> object. To get to the <TT>DataReader</TT> object, you need to look at the <TT>Command</TT> object.</P>
<P>The <TT>Command</TT> object in .NET works similarly to the ADO Command in that you will assign the stored procedure name or SQL statement to the <TT>CommandText</TT> property as well as the connection to use. One difference is that you will use the <TT>Open</TT> method of the <TT>Command</TT> object, and then the <TT>ExecuteReader</TT> method, to create the <TT>DataReader</TT> object.</P>
<P>You will then use the Read method off of the <TT>DataReader</TT> object to perform two tasks. The first task is that when used in a loop, you can test for <span class="docEmphasis"><TT>datareader</TT></span><TT>.Read()</TT> to check whether to terminate the loop and also to iterate through the rows that the <TT>DataReader</TT> object returns.</P>
<P>After you have the <TT>DataReader</TT> populated and you are iterating through the rows, you will load the data into the <TT>ListBox</TT> control. You will be using the <TT>Clear</TT> and <TT>Add</TT> methods, which were used in VB 6. In addition, you will use the <TT>BeginEdit</TT> and <TT>EndEdit</TT> methods, which speed up loading ListBox controls when you are loading a large amount of data.</P>
<P>To view this example in design view, open the form called frmHowTo3_1.vb in the chapter's solution.</P>
<H4 class="docSection2Title"> Steps</H4>
<P>Open and run the VB.NET-Chapter 3 solution. From the main form, click on the command button with the caption How-To 3.1. When the form loads, click on the Load List command button. You will see the list below fill with all the company names that start with <span class="docEmphasis">A</span>.</P>
<P>You will be creating a form similar to one that was created in Chapter 1. Instead of using bound controls, however, you will use code along with ADO.NET to populate the ListBox control.</P>



<span style="font-weight:bold"><OL class="docList" START="1">
<LI><span style="font-weight:normal" value="1"><P>Create a Windows Form. Then place a Label, TextBox, ListBox, and Command button on the form with the properties that are listed in Table 3.3 set.</P>
<P><TABLE BORDER="1" align="center" CELLPADDING="6" CELLSPACING="0">
<CAPTION><h5 class="docTableTitle">Table 3.3. Label, TextBox, ListBox, and Command Button Control Property Settings</h5></CAPTION><COLGROUP span="3">
<TR>
<TH class="docTableHeader" align="left" valign="top">
<P>Object</P>
</TH>
<TH class="docTableHeader" align="left" valign="top">
<P>Property</P>
</TH>
<TH class="docTableHeader" align="left" valign="top">
<P>Setting</P>
</TH>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>Label</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Name</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Label1</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">&nbsp;</TD>
<TD class="docTableCell" valign="top">
<P><TT>Caption</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Customer</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>TextBox</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Name</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>txtCustLimit</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">&nbsp;</TD>
<TD class="docTableCell" valign="top">
<P><TT>Text</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>A</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>ListBox</TT> </P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Name</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>lstCustomers</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>Command Button</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Name</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>btnLoadList</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">&nbsp;</TD>
<TD class="docTableCell" valign="top">
<P><TT>Caption</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Load List</TT></P>
</TD>
</TR>
</COLGROUP>
</TABLE></P>
<P>Notice that the list box does not have the DataBindings properties set. That is because you will be using the ListBox control unbound. Look at Figure 3.3 to see what the form should look like.</P>
<CENTER><H5 class="docFigureTitle">Figure 3.3. Arrange the controls on the form that you created to look like this form.</H5><p><IMG BORDER="0" WIDTH="500" HEIGHT="375" src="FILES/03fig03.jpg" ALT="graphics/03fig03.jpg"></p>
</CENTER></span></LI><LI><span style="font-weight:normal" value="2"><P>Before creating the code that will be attached to the Click event of the btnLoadList command button, you need to devise a support routine to create the connection string. Called <TT>BuildCnnStr</TT>, the function can been seen in Listing 3.1. This function takes a server and database names that are passed to it and creates a connection string.</P>
<H5 class="docExampleTitle">Listing 3.1 <TT>modGeneralRoutines.vb</TT>: Creating a Connection String</H5>
<PRE>
Function BuildCnnStr(ByVal strServer As String, _
            ByVal strDatabase As String) As String

        Dim strTemp As String
        strTemp = "Provider=SQLOleDB; Data Source=" &amp; strServer &amp; ";"
        strTemp &amp;= "Initial Catalog=" &amp; strDatabase &amp; ";"
        strTemp &amp;= "Integrated Security=SSPI"

        Return strTemp
    End Function
</PRE>
<P>Although you could create a routine that would pass back a <TT>Connection</TT> object, a more versatile method is to pass back a string. The reason for this is that for some objects, you are asked for a Connection object, whereas in other objects, you just need a string. You will see <TT>BuildCnnStr</TT> called in the next step.</P></span></LI><LI><span style="font-weight:normal" value="3"><P>On the btnLoadList Command button, add the following code from Listing 3.2 to the <TT>Click</TT> event. In this routine, a SQL string is created and stored in the <TT>strSQL</TT> string, taking <TT>Text</TT> property of the txtCustLimit text box and adding it to a literal. Then, within a Try-Catch-End-Try block, a new instance of an <TT>OleDbCommand</TT> object called ocmdCust is created. The routine then follows the steps that are discussed in the Technique section.</P>
<H5 class="docExampleTitle">Listing 3.2 <TT>frmHowTo3_1.vb</TT>: Loading a List Box By Using the DataReader Object</H5>
<PRE>
Private Sub btnLoadList_Click(ByVal sender As System.Object, _
                    ByVal e As System.EventArgs) Handles btnLoadList.Click

        Dim ocmdCust As OleDb.OleDbCommand
        Dim odrCust As OleDb.OleDbDataReader
        Dim strSQL As String

        '-- Create the SQL String
        strSQL = "Select CompanyName From Customers Where CustomerID Like '" &amp;
                    Me.txtCustLimit.Text &amp; "%'"

        '-- Set up the exception catch
        Try

            '-- Create an instance of the command
            ocmdCust = New OleDb.OleDbCommand()

            With ocmdCust
                '-- Set up the connection of the command and the command text
                .Connection = _
                    New OleDb.OleDbConnection(BuildCnnStr("(local)", "Northwind"))
                .Connection.Open()
                .CommandText = strSQL

                '-- Set up the data reader instance
                odrCust = .ExecuteReader(CommandBehavior.SequentialAccess)

            End With

            '-- Add the items to the list box.
            With lstCustomers
                .Items.Clear()
                .BeginUpdate()
                Do While odrCust.Read
                    .Items.Add(odrCust.Item("CompanyName"))
                Loop
                .EndUpdate()
            End With

        Catch oexpData As OleDb.OleDbException
            MsgBox(oexpData.Message)
        End Try

    End Sub
</PRE></span></LI></OL></span>
<div class="docNote"><p class="docNoteTitle">Note</p>
<p><table border="0" align="center" cellpadding="6" cellspacing="0"><tr>
<td width="60" valign="top"><IMG BORDER="0" ALIGN="LEFT" WIDTH="100" HEIGHT="100" src="FILES/note_icon.gif" ALT="graphics/note_icon.gif"></td>
<td valign="top"><P>Something of interest to those VB developers is the fact that the lines of code that read as follows:</P>
<pre>
.Connection = _
         New OleDb.OleDbConnection(BuildCnnStr("(local)", "Northwind"))
</pre><P>actually declare, initialize, and use an <TT>OleDBConnection</TT> object in the single statement. This is new to .NET and is extremely useful.</P>
</td>
</tr></table></p>
</div><br>
<H4 class="docSection2Title"> How It Works</H4>
<P>When the user clicks the btnLoadList button, the <TT>Command</TT> object is assigned the necessary properties, the connection is opened, and the <TT>ExecuteReader</TT> method is called.</P>
<P>After the list has been cleared, the <TT>DataReader</TT> is iterated through, and the <TT>ListBox</TT> control is loaded.</P>
<H4 class="docSection2Title"> Comments</H4>
<P>The <TT>DataReader</TT> object is one of the most efficient ways to get data from the server and load lists into your application. Other options besides <TT>CommandBehavior.SequentialAccess</TT> are available that make the <TT>DataReader</TT> convenient to use. Most notable is <TT>CommandBehavior.SchemaOnly</TT>, which returns information only about the columns, and no data.</P>
<P>You can use the <TT>Command</TT> object in a number of ways besides what was mentioned in this How-To. You will see additional examples of using the <TT>Command</TT> object with stored procedures to perform batch actions later in the chapter.</P>
<P>You have seen how to use the <TT>ListBox</TT> control in a total unbound technique. In the next How-To, you will see a blend of using the <TT>ListBox</TT> control in a semibound technique, where you will bind the data at runtime.</P>
<ul></ul>
</body></html>
