<html><head>
<META http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
<!--SafClassName="docSection1Title"--><!--SafTocEntry="7.2 Back Up and Verify a SQL Server Database"-->
<link rel="STYLESHEET" type="text/css" href="FILES/style.css">
<link rel="STYLESHEET" type="text/css" href="FILES/docsafari.css">
<style type="text/css">	.tt1    {font-size: 10pt;}</style>
</head>
<body><H3 class="docSection1Title">7.2 Back Up and Verify a SQL Server Database</H3>
<P>Backing up a database is probably one of the most important features to incorporate into your application. If you leave it up to the user to use the Enterprise Manager to back up the database, then it won't happen. You can arrange to have the backup scheduled, but sometimes you need to back it up at a moment's notice. This How-To shows you how to create a custom dialog box that will allow the user not only to back up your SQL Server database, but also to verify the backup.</P>
<P>Your users need to have a method for backing up and verifying their databases without using Enterprise Manager. How do you create a dialog box that would let them back up and verify their databases?</P>
<H4 class="docSection2Title"> Technique</H4>
<P>To accomplish this task, you will once again use the SQL-DMO objects. A couple of the new objects you will use are the <TT>Backup</TT> and <TT>BackupDevices</TT> objects. You can see some of the additional objects, along with the properties and methods that will be used, in Table 7.3.</P>
<P><TABLE BORDER="1" align="center" CELLPADDING="6" CELLSPACING="0">
<CAPTION><h5 class="docTableTitle">Table 7.3. Additional SQL-DMO Objects Used for Backing Up and Verifying a Database</h5></CAPTION><COLGROUP span="3">
<TR>
<TH class="docTableHeader" align="left" valign="top">
<P>Object</P>
</TH>
<TH class="docTableHeader" align="left" valign="top">
<P>Property/Method</P>
</TH>
<TH class="docTableHeader" align="left" valign="top">
<P>Description</P>
</TH>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>Backup</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Action</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P>This property allows you to specify what type of backup that you want to take place. The choices are <TT>SQLDMOBackup_Database</TT>, <TT>SQLDMOBackup_Differential</TT>, <TT>SQLDMOBackup_Files</TT>, and <TT>SQLDMOBackup_Log</TT>.</P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">&nbsp;</TD>
<TD class="docTableCell" valign="top">
<P><TT>BackupSetDescription</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P>This property allows you to specify a description for the backup set.</P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">&nbsp;</TD>
<TD class="docTableCell" valign="top">
<P><TT>BackupSetName</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P>This property is the Backup set name.</P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">&nbsp;</TD>
<TD class="docTableCell" valign="top">
<P><TT>Database</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P>This property allows you to specify the database to back up.</P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">&nbsp;</TD>
<TD class="docTableCell" valign="top">
<P><TT>Devices</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P>This property specifies the devices you will be backing up to.</P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">&nbsp;</TD>
<TD class="docTableCell" valign="top">
<P><TT>Initialize</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P>This method initializes the Backup process.</P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">&nbsp;</TD>
<TD class="docTableCell" valign="top">
<P><TT>TruncateLog</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P>This property allows you to specify how to handle the truncate log when backing up.</P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">&nbsp;</TD>
<TD class="docTableCell" valign="top">
<P><TT>SQLBackup</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P>This method performs the actual backup.</P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>BackupDevices</TT></P>
</TD>
<TD class="docTableCell" valign="top">&nbsp;</TD>
<TD class="docTableCell" valign="top">
<P>This is a collection of backup devices for a SQL Server.</P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>BackupDevice</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Name</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P>Thisis the name of a specific backup device.</P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">&nbsp;</TD>
<TD class="docTableCell" valign="top">
<P><TT>ReadBackupHeader</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P>This method reads in the header information for a backup, returning a <TT>QueryResults</TT> object.</P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>QueryResults</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>ColumnName</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P>This is the individual property information about a backup.</P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">&nbsp;</TD>
<TD class="docTableCell" valign="top">
<P><TT>GetColumnString</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P>This is the actual value for individual header information.</P>
</TD>
</TR>
</COLGROUP>
</TABLE></P>
<P>Using the objects listed in Table 7.3, you will create a form with options for the user to back up his database and verify the information after it has been saved.</P>
<div class="docNote"><p class="docNoteTitle">Note</p>
<p><table border="0" align="center" cellpadding="6" cellspacing="0"><tr>
<td width="60" valign="top"><IMG BORDER="0" ALIGN="LEFT" WIDTH="100" HEIGHT="100" src="FILES/note_icon.gif" ALT="graphics/note_icon.gif"></td>
<td valign="top"><P>Not all the possible options will be included in the form created for this How-To. For example, you could allow the user to back up the database to a separate file and give him additional options for the type of backup to perform.</P>
<P>Odds are good that you will not want to give the users all the options they <span class="docEmphasis">could</span> have; that is one of the reasons you want to create the dialog box here instead of letting users use the Enterprise Manager.</P>
</td>
</tr></table></p>
</div><br>
<H4 class="docSection2Title"> Steps</H4>
<P>Open and run the VB.NET -Chapter 7 solution. From the main Windows form, click on the command button with the caption How-To 7.2.</P>
<P>As with How-To 7.1, a user clicks on the SQL Server that he wants to display the databases of. He can then choose the database and backup device. From there, the user can click the Backup button to perform the backup. You can then click on the verify button to have information about the backup displayed in the text box at the bottom of the form. The form will look similar to the one displayed in Figure 7.7.</P>







<span style="font-weight:bold"><OL class="docList" START="1">
<LI><span style="font-weight:normal" value="1"><P>Create a Windows Form. Then place the controls shown in Figure 7.7, with the following properties set as in Table 7.4.</P><P><TABLE BORDER="1" align="center" CELLPADDING="6" CELLSPACING="0">
<CAPTION><h5 class="docTableTitle">Table 7.4. Controls and Their Property Settings</h5></CAPTION><COLGROUP span="3">
<TR>
<TH class="docTableHeader" align="left" valign="top">
<P>Object</P>
</TH>
<TH class="docTableHeader" align="left" valign="top">
<P>Property</P>
</TH>
<TH class="docTableHeader" align="left" valign="top">
<P>Setting</P>
</TH>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>Label</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Name</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Label1</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">&nbsp;</TD>
<TD class="docTableCell" valign="top">
<P><TT>Text</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>SQL Servers</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>ListBox</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Name</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>lstSQLServers</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>Label</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Name</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Label2</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">&nbsp;</TD>
<TD class="docTableCell" valign="top">
<P><TT>Text</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Databases</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>ListBox</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Name</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>lstDatabases</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>Label</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Name</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Label3</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">&nbsp;</TD>
<TD class="docTableCell" valign="top">
<P><TT>Text</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Backup</TT> Devices</P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>ListBox</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Name</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>lstBackupDevices</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>Command Button</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Name</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>btnBackup</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">&nbsp;</TD>
<TD class="docTableCell" valign="top">
<P><TT>Text</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>&amp;Backup</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>Label</TT> </P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Name</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Label4</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">&nbsp;</TD>
<TD class="docTableCell" valign="top">
<P><TT>Text</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Backup Set Name</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>TextBox</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Name</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>txtBackupSetName</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">&nbsp;</TD>
<TD class="docTableCell" valign="top">
<P><TT>Text</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>MyTestBackup</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>Label</TT> </P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Name</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Label5</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">&nbsp;</TD>
<TD class="docTableCell" valign="top">
<P><TT>Text</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Options</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>Panel</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Name</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Panel1</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>Groupbox</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Name</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>grpAction</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">&nbsp;</TD>
<TD class="docTableCell" valign="top">
<P><TT>Text</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Action</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>Radio Button</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Name</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>rbFull</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">&nbsp;</TD>
<TD class="docTableCell" valign="top">
<P><TT>Checked</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>True</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">&nbsp;</TD>
<TD class="docTableCell" valign="top">
<P><TT>Text</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Full</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>Radio Button</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Name</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>rbIncremental</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">&nbsp;</TD>
<TD class="docTableCell" valign="top">
<P><TT>Checked</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>False</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">&nbsp;</TD>
<TD class="docTableCell" valign="top">
<P><TT>Text</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Incremental</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>Groupbox</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Name</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>grpTruncateLog</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">&nbsp;</TD>
<TD class="docTableCell" valign="top">
<P><TT>Text</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Truncate Log</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>Radio Button</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Name</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>rbNoLog</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">&nbsp;</TD>
<TD class="docTableCell" valign="top">
<P><TT>Checked</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P>True</P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">&nbsp;</TD>
<TD class="docTableCell" valign="top">
<P><TT>Text</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>No Log</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>Radio Button</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Name</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>rbNoTruncate</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">&nbsp;</TD>
<TD class="docTableCell" valign="top">
<P><TT>Checked</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>False</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">&nbsp;</TD>
<TD class="docTableCell" valign="top">
<P><TT>Text</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>No Truncate</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>Radio Button</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Name</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>rbTruncate</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">&nbsp;</TD>
<TD class="docTableCell" valign="top">
<P><TT>Checked</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>False</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">&nbsp;</TD>
<TD class="docTableCell" valign="top">
<P><TT>Text</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Truncate</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>Label</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Name</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Label5</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">&nbsp;</TD>
<TD class="docTableCell" valign="top">
<P><TT>Text</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Backup Set Description</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>TextBox</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Name</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>txtBackupSetDescription</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">&nbsp;</TD>
<TD class="docTableCell" valign="top">
<P><TT>Text</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>MyTestBackup</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>Checkbox</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Name</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>chkInitialize</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">&nbsp;</TD>
<TD class="docTableCell" valign="top">
<P><TT>Text</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Initialize?</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>TextBox</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Name</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>txtVerify</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">&nbsp;</TD>
<TD class="docTableCell" valign="top">
<P><TT>Multiline</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>True</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">&nbsp;</TD>
<TD class="docTableCell" valign="top">
<P><TT>Scrollbars</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Both</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>Command Button</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Name</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>btnVerify</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">&nbsp;</TD>
<TD class="docTableCell" valign="top">
<P><TT>Text</TT> </P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>&amp;Verify</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>Command Button</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Name</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>btnClose</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">&nbsp;</TD>
<TD class="docTableCell" valign="top">
<P><TT>Text</TT> </P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>&amp;Close</TT></P>
</TD>
</TR>
</COLGROUP>
</TABLE></P></span></LI><LI><span style="font-weight:normal" value="2"><P>On the form, add the code in Listing 7.8 to the <TT>Load</TT> event. This will look familiar to How-To 7.1. For an examination of the LoadSQLServers routine, check out step 4 in that How-To.</P>
<H5 class="docExampleTitle">Listing 7.8 <TT>frmHowTo7_2.vb</TT>: Calling the Routine That Loads Available SQL Servers into a List Box</H5>
<PRE>
Private Sub frmHowTo7_2_Load(ByVal sender As System.Object,
                        ByVal e As System.EventArgs) Handles MyBase.Load

        '-- Load up the SQL Servers
        LoadSQLServers(Me.lstSQLServers)

End Sub
</PRE></span></LI><LI><span style="font-weight:normal" value="3"><P>On the lstSQLServers list box, add the code in Listing 7.9 to the <TT>SelectedIndexChanged</TT> event. This routine calls both the <TT>GetSQLDatabases</TT>, described in step 6 of How-To 7.1, and <TT>GetBackupDevices</TT>, described in the next step.</P>
<H5 class="docExampleTitle">Listing 7.9 <TT>frmHowTo7_2.vb</TT>: Populating the lstDatabases and lstBackupDevices List Boxes</H5>
<PRE>
Private Sub lstSQLServers_SelectedIndexChanged(ByVal sender As System.Object,
                    ByVal e As System.EventArgs) _
                   Handles lstSQLServers.SelectedIndexChanged

        GetSQLDatabases(Me.lstSQLServers.SelectedItem, Me.lstDatabases)
        GetBackupDevices(Me.lstSQLServers.SelectedItem, Me.lstBackupDevices)

End Sub
</PRE></span></LI><LI><span style="font-weight:normal" value="4"><P>Create the <TT>GetBackupDevices</TT> routine by entering the code in Listing 7.10 into the new module you created in How-To 7.1. The first task attempted by this routine is to connect to the server that is selected. Next, the names of the backup devices that are within the SQL Server are loaded into the list box called <TT>lstBackupDevices</TT>.</P>
<H5 class="docExampleTitle">Listing 7.10 <TT>modSQLDMORoutines.vb</TT>: Retrieving Backup Device Names for a Given SQL Server</H5>
<PRE>
Public Sub GetBackupDevices(ByVal strSQLServer As String, _
                                        ByRef lstBackupDevices As ListBox)

        Dim oDevice As SQLDMO.BackupDevice

        '-- Log on to the SQL Server.
        Dim osvr As SQLDMO.SQLServer = New SQLDMO.SQLServer()

        osvr.LoginSecure = True
        osvr.Connect(strSQLServer)

        lstBackupDevices.Items.Clear()

        '-- Iterate through the backup devices.
        For Each oDevice In osvr.BackupDevices
            lstBackupDevices.Items.Add(oDevice.Name)
        Next

End Sub
</PRE></span></LI><LI><span style="font-weight:normal" value="5"><P>On the btnBackup button, add the code in Listing 7.11 to the Click event. After connecting to the chosen SQL Server, a <TT>Backup</TT> object is instantiated. Next, certain properties of the <TT>Backup</TT> object, called <TT>oBackup</TT>, are set to values that are specified on the form. The <TT>SQLBackup</TT> method is called off the <TT>Backup</TT> object, and the connection is closed. Last, the variables are cleared (set to <TT>Nothing</TT>) and a message box is displayed.</P>
<H5 class="docExampleTitle">Listing 7.11 <TT>frmHowTo7_2.vb</TT>: Performing the Backup</H5>
<PRE>
    Private Sub btnBackup_Click(ByVal sender As System.Object, _
                    ByVal e As System.EventArgs) Handles btnBackup.Click

        '-- Create a connection to the server
        Dim osvr As New SQLDMO.SQLServer()
        osvr.LoginSecure = True
        osvr.Connect(Me.lstSQLServers.SelectedItem)

        '-- Create a Backup object, and set the necessary properties
        '   based on options chosen on the form.
        Dim oBackup As New SQLDMO.Backup()

        With oBackup

            If Me.rbFull.Checked Then
                .Action = SQLDMO.SQLDMO_BACKUP_TYPE.SQLDMOBackup_Database

            Else
                .Action = SQLDMO.SQLDMO_BACKUP_TYPE.SQLDMOBackup_Differential
            End If

            .BackupSetDescription = Me.txtBUSetDescription.Text
            .BackupSetName = Me.txtBUSetName.Text
            .Database = Me.lstDatabases.SelectedItem
            .Devices = "[" &amp; Me.lstBackupDevices.SelectedItem &amp; "]"
            If Me.rbNoLog.Checked Then
                .TruncateLog = _
                   SQLDMO.SQLDMO_BACKUP_LOG_TYPE.SQLDMOBackup_Log_NoLog
            ElseIf Me.rbNoTruncate.Checked Then
                .TruncateLog = _
                   SQLDMO.SQLDMO_BACKUP_LOG_TYPE.SQLDMOBackup_Log_NoTruncate
            Else
                .TruncateLog = _
                   SQLDMO.SQLDMO_BACKUP_LOG_TYPE.SQLDMOBackup_Log_Truncate
            End If
            .Initialize = Me.chkInitialize.Checked

            '-- Execute the backup
            .SQLBackup(osvr)

        End With

        '-- Disconnect from the server and clean up.
        osvr.DisConnect()

        osvr = Nothing
        oBackup = Nothing

        MessageBox.Show("Database Backed Up", "Task Completed", _
                          MessageBoxButtons.OK)

End Sub
</PRE></span></LI><LI><span style="font-weight:normal" value="6"><P>Add the code in Listing 7.12 to the <TT>Click</TT> event of <TT>btnVerify</TT>. After connecting to the SQL Server, the code iterates through each of the backup devices for the server and locates the one that the form specifies.</P>
<P>After the specific backup device is located, the <TT>ReadBackupHeader</TT> method is called, with an <TT>SQLDMO.QueryResults</TT> object returned. Each row of the QueryResults is read, and then the information is displayed in a text box called <TT>txtVerifyDisplay</TT>. From there, the SQLServer object is disconnected.</P>
<H5 class="docExampleTitle">Listing 7.12 <TT>frmHowTo7_2.vb</TT>: Performing the Backup</H5>
<PRE>
Private Sub btnVerify_Click(ByVal sender As System.Object, _
                        ByVal e As System.EventArgs) Handles btnVerify.Click

        Dim oDevice As SQLDMO.BackupDevice
        Dim oResults As SQLDMO.QueryResults

        Dim intRowCount As Integer
        Dim intColCount As Integer

        '-- Create a connection to the server
        Dim osvr As New SQLDMO.SQLServer()
        osvr.LoginSecure = True
        osvr.Connect(Me.lstSQLServers.SelectedItem)

        '-- Iterate through the devices
        For Each oDevice In osvr.BackupDevices

            If oDevice.Name = Me.lstBackupDevices.SelectedItem Then

                '-- If found, display the results
                oResults = oDevice.ReadBackupHeader

                For intRowCount = 1 To oResults.Rows

                    For intColCount = 1 To oResults.Columns

                        Me.txtVerifyDisplay.Text &amp;= _
                          oResults.ColumnName(intColCount) &amp; " - "

                        Me.txtVerifyDisplay.Text &amp;= _
                          oResults.GetColumnString(intRowCount, _
intColCount) &amp; vbCrLf &amp; vbCrLf
                    Next
                Next
            End If
        Next

        '-- Disconnect and clean up
        osvr.DisConnect()
        osvr = Nothing
        oDevice = Nothing
        oResults = Nothing

End Sub
</PRE></span></LI><LI><span style="font-weight:normal" value="7"><P>Add the code in Listing 7.13 to the <TT>Click</TT> event of btnClose.</P>
<H5 class="docExampleTitle">Listing 7.13 <TT>frmHowTo7_2.vb</TT>: Performing the Backup</H5>
<PRE>
Private Sub btnClose_Click(ByVal sender As System.Object, _
                    ByVal e As System.EventArgs) Handles btnClose.Click

        Me.Close()

End Sub
</PRE></span></LI></OL></span>
<CENTER><H5 class="docFigureTitle">Figure 7.7. Creating a form for backing up and verifying a SQL Database gives you control over what options the user has when performing the task.</H5><p><IMG BORDER="0" WIDTH="464" HEIGHT="472" src="FILES/07fig07.gif" ALT="graphics/07fig07.gif"></p>
</CENTER>
<H4 class="docSection2Title"> How It Works</H4>
<P>After the form loads, the user can select the SQL Server, database, and backup device. When the user clicks the button labeled Perform Backup, a SQLDMO <TT>Backup</TT> object is created. The Backup object gives you the same capabilities as if you were using the Enterprise Manager-except that you control them. Only put options on the form that you want to have the user set, and then set the other options yourself, as you deem necessary. After setting the options, the <TT>SQLBackup</TT> method performs the backup.</P>
<P>By using the <TT>QueryResults</TT> object off the <TT>BackupDevice</TT>, you have a means of looking at some of the properties of the backup and verifying them to make sure the database did indeed get backed up.</P>
<H4 class="docSection2Title"> Comments</H4>
<P>You could enhance this utility in a number of ways, a couple of which include the following:</P>
<UL>
<LI><P>Add a text box for letting the user specify a filename for the backup, rather than using a backup device.</P></LI>
<LI><P>Allow the user to add backup devices. Currently, only existing backup devices can be used.</P></LI>
</UL>
<P>Just be careful on what options you give the user so he doesn't shoot himself in the foot.</P>
<img src="FILES/pixel.gif" width="1" height="1" border="0"><ul></ul>
</body></html>
