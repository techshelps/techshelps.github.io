<html><head>
<META http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
<!--SafClassName="docSection1Title"--><!--SafTocEntry="7.5 Create a Detach/Attach SQL Server Database Dialog Box"-->
<link rel="STYLESHEET" type="text/css" href="FILES/style.css">
<link rel="STYLESHEET" type="text/css" href="FILES/docsafari.css">
<style type="text/css">	.tt1    {font-size: 10pt;}</style>
</head>
<body><H3 class="docSection1Title">7.5 Create a Detach/Attach SQL Server Database Dialog Box</H3>
<P>Situations sometimes arise that require a database to be attached, detached, or both. Perhaps your client needs to move the database from one SQL Server to another. This How-To shows you the methods you can use to perform these tasks.</P>
<P>Before diving into solving some of the tasks that can be accomplished in the How-Tos just listed, it's important to discuss the SQL-DMO object model, as well as create a reference to it.</P>
<P>Many times, you've used the Enterprise Manager to move databases for users by attaching and detaching them. It would be nice to be able to perform this task without users calling you. At he very least, you'd like to be able to walk users through the details over the phone, without having to use the Enterprise Manager. How do you create a dialog box to perform this task?</P>
<H4 class="docSection2Title"> Technique</H4>
<P>This is probably the easiest of the How-Tos to create for this chapter, other than How-To 7.1. For this task, you will be using two methods of the <TT>SQLServer</TT> object: <TT>DetachDB</TT> and <TT>AttachDBWithSingleFile</TT>.</P>
<P>Along with the two methods just mentioned, you will also be using a Tab control to choose which task to perform, as well as an OpenFile Dialog control to allow the user to choose the file to attach.</P>
<H4 class="docSection2Title"> Steps</H4>
<P>Open and run the VB.NET -Chapter 7 solution. From the main Windows form, click on the command button with the caption How-To 7.5. You can select a database, such as the one displayed in Figure 7.11, and click the Detach button. You will see the database disappear from the list of databases to choose from.</P>
<CENTER><H5 class="docFigureTitle">Figure 7.11. Ready to detach the chosen database.</H5><p><IMG BORDER="0" WIDTH="500" HEIGHT="226" src="FILES/07fig11.gif" ALT="graphics/07fig11.gif"></p>
</CENTER>
<P>After you have chosen the database, you can reattach the database by clicking on the tab labeled Attach Database. You can then type in the name you want to attach the database as, and click on the Locate File button to locate the database file to attach (see Figure 7.12.)</P>
<CENTER><H5 class="docFigureTitle">Figure 7.12. Choosing the database file to attach.</H5><p><IMG BORDER="0" WIDTH="500" HEIGHT="308" src="FILES/07fig12.gif" ALT="graphics/07fig12.gif"></p>
</CENTER>
<P>Select the file and click Open. To attach the file, click the Attach Database button. The database file will then be attached, and you can see it in the list of databases. To check this, you can look at the list back on the Detach Database tab; that list was refreshed when you clicked the Attach Database button.</P>











<span style="font-weight:bold"><OL class="docList" START="1">
<LI><span style="font-weight:normal" value="1"><P>Create a Windows Form.</P></span></LI><LI><span style="font-weight:normal" value="2"><P>Add a Tab control from the Windows Form Controls list. Click the builder button in the Tab Pages property, and add two pages. Set the Text property for Page1 to Detach Database, and the Text property for Page2 to Attach Database.</P></span></LI><LI><span style="font-weight:normal" value="3"><P>Add an <TT>OpenFileDialog</TT> control from the Windows Form Controls list. Go ahead and leave the default name given to the control, but make a note of it.</P></span></LI><LI><span style="font-weight:normal" value="4"><P>Place the other controls shown in Figure 7.10 and 7.11, with the following properties set as in Table 7.9.</P>
<P><TABLE BORDER="1" align="center" CELLPADDING="6" CELLSPACING="0">
<CAPTION><h5 class="docTableTitle">Table 7.9. Label, ListBox, and Command Button Controls Property Settings</h5></CAPTION><COLGROUP span="4">
<TR>
<TH class="docTableHeader" align="left" valign="top">
<P>Object</P>
</TH>
<TH class="docTableHeader" align="left" valign="top">
<P>Location</P>
</TH>
<TH class="docTableHeader" align="left" valign="top">
<P>Property</P>
</TH>
<TH class="docTableHeader" align="left" valign="top">
<P>Setting</P>
</TH>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>Label</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Main Form</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Name</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Label1</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">&nbsp;</TD>
<TD class="docTableCell" valign="top">&nbsp;</TD>
<TD class="docTableCell" valign="top">
<P><TT>Text</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>SQL Servers</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>ListBox</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Main Form</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Name</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>lstSQLServers</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>Label</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Main Form</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Name</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Label2</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">&nbsp;</TD>
<TD class="docTableCell" valign="top">&nbsp;</TD>
<TD class="docTableCell" valign="top">
<P><TT>Text</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Databases</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>ListBox</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Tab Page1</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Name</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>lstDatabases</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>Button</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Tab Page1</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Name</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>btnDetach</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">&nbsp;</TD>
<TD class="docTableCell" valign="top">&nbsp;</TD>
<TD class="docTableCell" valign="top">
<P><TT>Text</TT> </P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>&amp;Detach Database</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>Label</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Tab Page2</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Name</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Label3</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">&nbsp;</TD>
<TD class="docTableCell" valign="top">&nbsp;</TD>
<TD class="docTableCell" valign="top">
<P><TT>Text</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>File to Attach</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>TextBox</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Tab Page2</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Name</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>txtFileToAttach</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>Label</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Tab Page2</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Name</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Label4</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">&nbsp;</TD>
<TD class="docTableCell" valign="top">&nbsp;</TD>
<TD class="docTableCell" valign="top">
<P><TT>Text</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Name of Attached Database</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>TextBox</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Tab Page2</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Name</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>txtNameOfAttach</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>Button</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Tab Page2</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Name</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>btnLocate</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">&nbsp;</TD>
<TD class="docTableCell" valign="top">&nbsp;</TD>
<TD class="docTableCell" valign="top">
<P><TT>Text</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>&amp;Locate File</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>Button</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Tab Page2</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Name</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>btnAttach</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">&nbsp;</TD>
<TD class="docTableCell" valign="top">&nbsp;</TD>
<TD class="docTableCell" valign="top">
<P><TT>Text</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>&amp;Attach Database</TT></P>
</TD>
</TR>
</COLGROUP>
</TABLE></P></span></LI><LI><span style="font-weight:normal" value="5"><P>On the form, add the code in Listing 7.24 to the <TT>Load</TT> event. This will look familiar from How-To 7.1. For an examination of the LoadSQLServers routine, check out step 4 in that How-To.</P>
<H5 class="docExampleTitle">Listing 7.24 <TT>frmHowTo7_5.vb</TT>: Calling the Routine That Loads Available SQL Servers into a List Box</H5>
<PRE>
Private Sub frmHowTo7_5_Load(ByVal sender As System.Object, _
                        ByVal e As System.EventArgs) Handles MyBase.Load

        LoadSQLServers(Me.lstSQLServers)

End Sub
</PRE></span></LI><LI><span style="font-weight:normal" value="6"><P>On the lstSQLServers list box, add the code in Listing 7.25 to the SelectedIndexChanged event. This routine toggles the btnDetach button, depending on whether a SQL Server and database has been selected. It then calls <TT>GetSQLDatabases</TT>, described in step 6 of How-To 7.1.</P>
<H5 class="docExampleTitle">Listing 7.25 <TT>frmHowTo7_5.vb</TT>: Populating the lstDatabases List Boxes</H5>
<PRE>
    Private Sub lstSQLServers_SelectedIndexChanged(ByVal sender As System.Object,
                ByVal e As System.EventArgs) _
Handles lstSQLServers.SelectedIndexChanged

        If lstSQLServers.SelectedItems.Count &gt; 0 And _
                lstDatabases.SelectedItems.Count &gt; 0 Then
            Me.btnDetach.Enabled = True
        Else
            Me.btnDetach.Enabled = False
        End If

        GetSQLDatabases(Me.lstSQLServers.SelectedItem, Me.lstDatabases)

End Sub
</PRE></span></LI><LI><span style="font-weight:normal" value="7"><P>On the lstDatabases list box, add the code in Listing 7.26 to the <TT>SelectedIndexChanged</TT> event. This routine toggles the btnDetach button, depending on whether a SQL Server and database have been selected.</P>
<H5 class="docExampleTitle">Listing 7.26 <TT>frmHowTo7_5.vb</TT>: Toggling the btnDetach Button Based on Whether a SQL Server and Database Have Been Chosen</H5>
<PRE>
Private Sub lstDatabases_SelectedIndexChanged(ByVal sender As System.Object,
                    ByVal e As System.EventArgs) _
                   Handles lstDatabases.SelectedIndexChanged

        If lstSQLServers.SelectedItems.Count &gt; 0 And _
                    lstDatabases.SelectedItems.Count &gt; 0 Then
            Me.btnDetach.Enabled = True
        Else
            Me.btnDetach.Enabled = False
        End If

End Sub
</PRE></span></LI><LI><span style="font-weight:normal" value="8"><P>On the btnDetach button, add the code in Listing 7.27 to the Click event. After connecting to the server, the <TT>DetachDB</TT> method is called. Then the <TT>GetSQLDatabases</TT> routine is called to refresh the database list.</P>
<H5 class="docExampleTitle">Listing 7.27 <TT>frmHowTo7_5.vb</TT>: Detaching a SQL Server Database</H5>
<PRE>
Private Sub btnDetach_Click(ByVal sender As System.Object, _
                          ByVal e As System.EventArgs) Handles btnDetach.Click

        Dim oSQLSvr As New SQLDMO.SQLServer()
        Dim strDetachMsg As String

        Try

            '-- Connect to the server
            oSQLSvr.LoginSecure = True

            oSQLSvr.Connect(Me.lstSQLServers.SelectedItem)

            '-- Perform the detach
            strDetachMsg = oSQLSvr.DetachDB(Me.lstDatabases.SelectedItem)

            '-- Refresh the databases
            GetSQLDatabases(Me.lstSQLServers.SelectedItem, Me.lstDatabases)

        Catch excp As Exception
            MessageBox.Show(excp.Message)
            Exit Sub
        End Try

        MessageBox.Show("Database Detached")

End Sub
</PRE></span></LI><LI><span style="font-weight:normal" value="9"><P>Add the code in Listing 7.28 to the <TT>Click</TT> event of btnLocateFile. This routine uses the <TT>OpenFileDialog</TT> control to retrieve the name of the file you want to attach.</P>
<H5 class="docExampleTitle">Listing 7.28 <TT>frmHowTo7_5.vb</TT>: Locating the Database File to Attach</H5>
<PRE>
Private Sub btnLocateFile_Click(ByVal sender As System.Object, _
                 ByVal e As System.EventArgs) Handles btnLocateFile.Click

        With OpenFileDialog1
            .InitialDirectory = _

"E:\Program Files\Microsoft SQL Server\MSSQL\Data\"
            .Filter = "SQL Server Database files (*.mdf)|*.mdf"
            .ShowDialog()
            Me.txtFileToAttach.Text = .FileName
        End With
End Sub
</PRE></span></LI><LI><span style="font-weight:normal" value="10"><P>Add the code in Listing 7.29 to the <TT>TextChanged</TT> event of <TT>txtFileToAttach</TT> and <TT>txtNameToAttach</TT> as appropriate.</P>
<H5 class="docExampleTitle">Listing 7.29 <TT>frmHowTo7_5.vb</TT>: Closing the Form</H5>
<PRE>
Private Sub txtFileToAttach_TextChanged(ByVal sender As System.Object,
                ByVal e As System.EventArgs) Handles txtFileToAttach.TextChanged

        If Len(Me.txtFileToAttach.Text) &gt; 0 And _
          Len(Me.txtNameOfAttach.Text) &gt; 0 Then
            Me.btnAttach.Enabled = True
        Else
            Me.btnAttach.Enabled = False

        End If
End Sub

Private Sub txtNameOfAttach_TextChanged(ByVal sender As System.Object,
         ByVal e As System.EventArgs) Handles txtNameOfAttach.TextChanged

        If Len(Me.txtFileToAttach.Text) &gt; 0 And _
                  Len(Me.txtNameOfAttach.Text) &gt; 0 Then
            Me.btnAttach.Enabled = True
        Else
            Me.btnAttach.Enabled = False

        End If
End Sub
</PRE></span></LI><LI><span style="font-weight:normal" value="11"><P>Add the code in Listing 7.30 to the <TT>Click</TT> event of btnAttach. After connecting to the server, this code calls the <TT>AttachDBWithSingleFile</TT> method. Then it refreshes the database list using the routine <TT>GetSQLDatabases</TT>.</P>
<H5 class="docExampleTitle">Listing 7.30 <TT>frmHowTo7_5.vb</TT>: Attaching a SQL Server Database</H5>
<PRE>
Private Sub btnAttach_Click(ByVal sender As System.Object, _
                        ByVal e As System.EventArgs) Handles btnAttach.Click

        Dim oSQLSvr As New SQLDMO.SQLServer()
        Dim strAttachMsg As String

        Try

            oSQLSvr.LoginSecure = True

            oSQLSvr.Connect(Me.lstSQLServers.SelectedItem)

            '-- Attach the database
            strAttachMsg = oSQLSvr.AttachDBWithSingleFile( _
                           Me.txtNameOfAttach.Text, Me.txtFileToAttach.Text)

            '-- Refresh the databases
            GetSQLDatabases(Me.lstSQLServers.SelectedItem, Me.lstDatabases)

        Catch excp As Exception
            MessageBox.Show(excp.Message)
            Exit Sub
        End Try

        MessageBox.Show("Database Attached")

End Sub
</PRE></span></LI></OL></span>
<H4 class="docSection2Title"> How It Works</H4>
<P>This How-To uses the <TT>DetachDB</TT> and <TT>AttachDBWithSingleFile</TT> methods to attach and detach a database.</P>
<H4 class="docSection2Title"> Comments</H4>
<P>You can enhance this routine by allowing for databases that have multiple files to be attached and detached.</P>
<P>There is so much you can do with the APIs that SQL Server provides. Open the Enterprise Manager and look at some of the various utilities, including Data Transformation Services. Then open the Object Browser to the SQL-DMO and SQL-DTS libraries, and notice the correlation between tasks that are displayed using the Enterprise Manager and the APIs.</P>
<ul></ul>
</body></html>
