<html><head>
<META http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
<!--SafClassName="docSection1Title"--><!--SafTocEntry="6.8 Create and Call SQL Server 2000 User-Defined Functions"-->
<link rel="STYLESHEET" type="text/css" href="FILES/style.css">
<link rel="STYLESHEET" type="text/css" href="FILES/docsafari.css">
<style type="text/css">	.tt1    {font-size: 10pt;}</style>
</head>
<body><H3 class="docSection1Title">6.8 Create and Call SQL Server 2000 User-Defined Functions</H3>
<P>In SQL Server 2000, I have heard that you can create user-defined functions (UDFs). Where would you use UDFs, and how do you create and call them from within T-SQL?</P>
<H4 class="docSection2Title"> Technique</H4>
<P>UDFs have been used for years in application development languages. You can now create them in SQL Server 2000 as well.</P>
<H5 class="docSection3Title"> Creating SQL Server 2000 UDFs</H5>
<P>You can create UDFs in SQL Server 2000 by using the <TT>CREATE FUNCTION</TT> command. Normally, you would do this using the Enterprise Manager or some tool, but here you will learn how to do it using VB.NET. Following is the function that will be created:</P>
<pre>
CREATE FUNCTION udf_ShowProdAndCat (@UnitPriceParm money)
RETURNS @ProdAndCatTab TABLE
(
     ProductID     int,
     ProductName   nvarchar(80),
     CategoryName  nvarchar(80),
     UnitPrice     int
)
AS
BEGIN
     INSERT @ProdAndCatTab
         SELECT P.ProductID, P.ProductName,
             C.CategoryName, P.UnitPrice
         FROM Products AS P INNER JOIN Categories AS C
         ON P.CategoryID = C.CategoryID
         WHERE P.UnitPrice &gt; @UnitPriceParm
     RETURN
END
</pre>
<P>This function definitely looks a lot different from functions you have created in other languages, but it doesn't look as funky when you remember you are using T-SQL commands.</P>
<H5 class="docSection4Title"> Passing Parameters to SQL Server UDFs</H5>
<P>The parameter that is passed starts with the @ symbol, much like local variables that were discussed in How-To 6.1.</P>
<P>You will also want to declare the data type.</P>
<H5 class="docSection4Title"> Returning Scalar or Table Types from SQL Server UDFs</H5>
<P>When returning values from a UDF, you will either pass back a scalar type, which is actually a single value of one of the standard data types, or pass back a new Table data type.</P>
<P>The example for this How-To creates and returns a Table data type, specified with the following lines of code:</P>
<pre>
RETURNS @ProdAndCatTab TABLE
(
     ProductID     int,
     ProductName   nvarchar(80),
     CategoryName  nvarchar(80),
     UnitPrice     int
)
</pre>
<P>By including the opening and closing parentheses, you can specify and return an entire table's worth of data, but be careful not to because performance would not be good. This is the same as it would be using SQL Server data.</P>
<P>You can then use this table that is returned in another T-SQL statement.</P>
<P>After establishing the return value, in this case the table ProdAndCatTab, you need to create the body of code for the UDF.</P>
<div class="docNote"><p class="docNoteTitle">Note</p>
<p><table border="0" align="center" cellpadding="6" cellspacing="0"><tr>
<td width="60" valign="top"><IMG BORDER="0" ALIGN="LEFT" WIDTH="100" HEIGHT="100" src="FILES/note_icon.gif" ALT="graphics/note_icon.gif"></td>
<td valign="top"><P>Although this return value has been called ProdAndCatTab, there is not going to be a table that you can access outside the function by that name. It will just be strictly for use in the calling statement.</P>
</td>
</tr></table></p>
</div><br>
<H5 class="docSection4Title"> Formatting the Body of Code for SQL Server UDFs</H5>
<P>You can see from the block of code that follows that you need to have a <TT>BEGIN</TT> and <TT>END</TT> statement:</P>
<pre>
AS
BEGIN
     INSERT @ProdAndCatTab
         SELECT P.ProductID, P.ProductName,
             C.CategoryName, P.UnitPrice
         FROM Products AS P INNER JOIN Categories AS C
         ON P.CategoryID = C.CategoryID
         WHERE P.UnitPrice &gt; @UnitPriceParm
     RETURN
END
</pre>
<P>Notice also that you will have INSERT @ProdAndCatTab and RETURN statements in there to create the Table return value. The rest of the code is much the same as other T-SQL statements.</P>
<H5 class="docSection3Title"> Calling SQL Server 2000 UDFs</H5>
<P>You can call UDFs from other T-SQL Statements, as displayed here for this How-To:</P>
<pre>
Select * From udf_ShowProdAndCat(" &amp; Me.txtUnitPrice.Text &amp; ")"
</pre>
<P>There, the UDF is called in a SELECT statement, and the parameter is passed.</P>
<H4 class="docSection2Title"> Steps</H4>
<P>Open and run the VB.NET -Chapter 6 solution. From the main form, click on the button with the caption How-To 6.8 (see Figure 6.9).</P>
<CENTER><H5 class="docFigureTitle">Figure 6.9. A common problem with inner joins is retrieving multiple records when you want to see only one per occurrence.</H5><p><IMG BORDER="0" WIDTH="500" HEIGHT="539" src="FILES/06fig09.jpg" ALT="graphics/06fig09.jpg"></p>
</CENTER>
<P>You will see the UDF described in the "Technique" section in a label. Click the button labeled Create UDF. If the UDF already exists, then a message box will tell you so. Otherwise, the UDF is created. Next, click the button labeled Use UDF. The data grid is then filled and the data is displayed. You can change the value in the Products Greater Than text box. Then click Use UDF again to see the new data displayed.</P>





<span style="font-weight:bold"><OL class="docList" START="1">
<LI><span style="font-weight:normal" value="1"><P>Create a Windows Form. Then place the controls listed in Table 6.8 with the following properties set, as displayed in Figure 6.9.</P><P><TABLE BORDER="1" align="center" CELLPADDING="6" CELLSPACING="0">
<CAPTION><h5 class="docTableTitle">Table 6.8. Control Property Settings for This How-To</h5></CAPTION><COLGROUP span="3">
<TR>
<TH class="docTableHeader" align="left" valign="top">
<P>Object</P>
</TH>
<TH class="docTableHeader" align="left" valign="top">
<P>Property</P>
</TH>
<TH class="docTableHeader" align="left" valign="top">
<P>Setting</P>
</TH>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>Label</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Text</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Report Products Greater Than:</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>TextBox</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Name</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>txtUnitPrice</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>Label</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Text</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>SQL Statement Creating Temporary Table</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>Label</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Name</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>lblCreateUDF</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>Button</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Name</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>btnCreateUDF</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">&nbsp;</TD>
<TD class="docTableCell" valign="top">
<P><TT>Text</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Create UDF</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>Label</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Text</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>SQL Statement Using UDF</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>Label</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Name</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>lblUseUDF</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>Button</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Name</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>btnUseUDF</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">&nbsp;</TD>
<TD class="docTableCell" valign="top">
<P><TT>Text</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Use UDF</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>Label</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Text</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Results</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>DataGrid</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Name</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>dgResults</TT></P>
</TD>
</TR>
</COLGROUP>
</TABLE></P></span></LI><LI><span style="font-weight:normal" value="2"><P>Add the code in Listing 6.18 to the Load event of the form. (Double-click on the form to bring up the code.)</P>
<H5 class="docExampleTitle">Listing 6.18 <TT>frmHowTo6_8.vb</TT>: Create the UDF Code, and Assign It to a Label for Display and Use Later</H5>
<PRE>
Private Sub frmHowTo6_8_Load(ByVal sender As System.Object,
                    ByVal e As System.EventArgs) Handles MyBase.Load

        '-- Create the UDF string
        Dim strSQL As String
        strSQL = "CREATE FUNCTION udf_ShowProdAndCat ( @UnitPriceParm money)"
        strSQL &amp;= "RETURNS @ProdAndCatTab TABLE" &amp; vbCrLf
        strSQL &amp;= "(" &amp; vbCrLf
        strSQL &amp;= "     ProductID     int," &amp; vbCrLf
        strSQL &amp;= "     ProductName   nvarchar(80)," &amp; vbCrLf
        strSQL &amp;= "     CategoryName  nvarchar(80)," &amp; vbCrLf
        strSQL &amp;= "     UnitPrice     int" &amp; vbCrLf
        strSQL &amp;= ")" &amp; vbCrLf
        strSQL &amp;= "AS" &amp; vbCrLf
        strSQL &amp;= "BEGIN" &amp; vbCrLf
        strSQL &amp;= "     INSERT @ProdAndCatTab" &amp; vbCrLf
        strSQL &amp;= "         SELECT P.ProductID, P.ProductName," &amp; vbCrLf
        strSQL &amp;= "             C.CategoryName, P.UnitPrice" &amp; vbCrLf
        strSQL &amp;= "         FROM Products AS P INNER JOIN Categories AS C" &amp; _
vbCrLf
        strSQL &amp;= "         ON P.CategoryID = C.CategoryID" &amp; vbCrLf
        strSQL &amp;= "         WHERE P.UnitPrice &gt; @UnitPriceParm" &amp; vbCrLf
        strSQL &amp;= "     RETURN" &amp; vbCrLf
        strSQL &amp;= "END"


        Me.lblCreateUDF.Text = strSQL

        '-- Create the SQL string that calls the UDF
        Me.lblUseUDF.Text = "Select * From udf_ShowProdAndCat(" &amp; _
Me.txtUnitPrice.Text &amp; ")"

End Sub
</PRE></span></LI><LI><span style="font-weight:normal" value="3"><P>Add the code in Listing 6.19 to the <TT>Click</TT> event of btnCreateUDF. This code uses <TT>Connection</TT> and <TT>Command</TT> objects to create the UDF based on the code that is provided.</P>
<H5 class="docExampleTitle">Listing 6.19 <TT>frmHowTo6_8.vb</TT>: Creating the New UDF in SQL Server</H5>
<PRE>
Private Sub btnCreateUDF_Click(ByVal sender As System.Object,
                    ByVal e As System.EventArgs) Handles btnCreateUDF.Click

        Try

            Dim ocnn As New OleDb.OleDbConnection(BuildCnnStr("(local)", _
                  "Northwind"))
            Dim ocmd As New OleDb.OleDbCommand(Me.lblCreateUDF.Text)

            ocmd.Connection = ocnn

            ocnn.Open()
            ocmd.ExecuteNonQuery()
            ocnn.Close()

        Catch excp As Exception
            MessageBox.Show(excp.Message)
            Exit Sub
        End Try

        MessageBox.Show("UDF Created")

End Sub
</PRE></span></LI><LI><span style="font-weight:normal" value="4"><P>Add the code in Listing 6.20 to the TextChanged event of the button txtUnitPrice.</P>
<H5 class="docExampleTitle">Listing 6.20 <TT>frmHowTo6_8.vb</TT>: Updating the <TT>SELECT</TT> Statement That Is Calling the UDF</H5>
<PRE>
Private Sub txtUnitPrice_TextChanged(ByVal sender As System.Object,
                    ByVal e As System.EventArgs) Handles txtUnitPrice.TextChanged

        Me.lblUseUDF.Text = "Select * From udf_ShowProdAndCat(" &amp; _
                  Me.txtUnitPrice.Text &amp; ")"

End Sub
</PRE></span></LI><LI><span style="font-weight:normal" value="5"><P>Add the code in Listing 6.21 to the <TT>Click</TT> event of the button btnUseUDF. This code fills a dataset based on the <TT>SELECT</TT> statement that calls the UDF. The code then assigns the dataset to the <TT>DataSource</TT> property of dgResults.</P>
<H5 class="docExampleTitle">Listing 6.21 Displaying Data Using the <TT>SELECT</TT> Statement in the Text Property of <TT>lblUseUDF</TT></H5>
<PRE>
Private Sub btnUseUDF_Click(ByVal sender As System.Object,
                    ByVal e As System.EventArgs) Handles btnUseUDF.Click

        Dim dtResults As New DataTable()
        Try
            '-- Use the SQL String to build the data adapter
    '     and fill the data table.
            Dim odaResults As New OleDb.OleDbDataAdapter(Me.lblUseUDF.Text,
                                      BuildCnnStr("(local)", "Northwind"))

            odaResults.Fill(dtResults)

        Catch excp As Exception
            MessageBox.Show(excp.Message)
            Exit Sub
        End Try

        '-- Assign the data table to the data grid's DataSource property.
        Me.dgResults.DataSource = dtResults

End Sub
</PRE></span></LI></OL></span>
<H4 class="docSection2Title"> Comments</H4>
<P>When you have to use the same T-SQL statements repeatedly, it is handy to be able to store that code somewhere, just like you can do with UDFs you create in Visual Basic.</P>
<P>When using UDFs, you can use the value inline and save a number of steps when creating your T-SQL routines.</P>
<ul></ul>
</body></html>
