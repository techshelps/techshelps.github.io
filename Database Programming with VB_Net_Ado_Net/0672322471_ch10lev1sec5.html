<html><head>
<META http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
<!--SafClassName="docSection1Title"--><!--SafTocEntry="10.5 Determine Which Records Will Be Printed at Runtime"-->
<link rel="STYLESHEET" type="text/css" href="FILES/style.css">
<link rel="STYLESHEET" type="text/css" href="FILES/docsafari.css">
<style type="text/css">	.tt1    {font-size: 10pt;}</style>
</head>
<body><H3 class="docSection1Title">10.5 Determine Which Records Will Be Printed at Runtime</H3>
<P>I can use the Select Wizard to help limit the records that I want to be displayed on the report, but that doesn't do my users much good when they want control over that when the application is running. How do I determine which records are displayed at runtime?</P>
<H4 class="docSection2Title"> Technique</H4>
<P>To handle this, use the <TT>SelectionFormula</TT> of the <TT>CrystalReportsViewer</TT>. When you use the <TT>SelectionFormula</TT> to limit your records, you are taking advantage of Crystal Report's Database optimization. This means that the query you generated by setting the SelectionFormula and the original record source for the report will be "pushed down" to the server.</P>
<H5 class="docSection3Title"> <TT>SelectionFormula</TT> Syntax</H5>
<P>You can see the syntax for the <TT>SelectionFormula</TT> here:</P>
<pre>
CrystalReportViewer1.SelectionFormula = "{<span class="docEmphasis">Table.Field</span>} = <span class="docEmphasis">value</span>"
</pre>
<P><span class="docEmphasis">Value</span> can be various data types, delimited by the usual delimiters, such as single quotes for strings.</P>
<P>For the new criteria to take effect, after setting the <TT>SelectionFormula</TT>, you need to call the <TT>RefreshReport</TT> method of the CrystalReportViewer.</P>
<H5 class="docSection3Title"> Setting Report Options</H5>
<P>To get optimal use out of the <TT>SelectionFormula</TT>, you need to keep some things in mind. You need to set an option of the report that will ensure it uses the record source indexes if possible.</P>
<P>To do this, you right-click on the report and choose Report Options from the Report menu. On the Options page, make sure to check Use Indexes or Server for Speed (see Figure 10.20).</P>
<CENTER><H5 class="docFigureTitle">Figure 10.20. Customize your report by using the Report Options dialog box.</H5><p><IMG BORDER="0" WIDTH="468" HEIGHT="386" src="FILES/10fig20.jpg" ALT="graphics/10fig20.jpg"></p>
</CENTER>
<P>Another tip is to make sure you use indexed fields whenever possible.</P>
<div class="docNote"><p class="docNoteTitle">Tip</p>
<p><table border="0" align="center" cellpadding="6" cellspacing="0"><tr>
<td width="60" valign="top"><IMG BORDER="0" ALIGN="LEFT" WIDTH="100" HEIGHT="100" src="FILES/tip_icon.gif" ALT="graphics/tip_icon.gif"></td>
<td valign="top"><P>Take some time now to check out some of the other report options.</P>
</td>
</tr></table><p></p>
</div><br>
<H4 class="docSection2Title"> Steps</H4>
<P>Open and run the Visual Basic .NET-Chapter 10 solution. Click on the button labeled How-To 10.5. You can select Regions from the ComboBox control on the top of the form; the report then reflects the selection (see Figure 10.21).</P>





<span style="font-weight:bold"><OL class="docList" START="1">
<LI><span style="font-weight:normal" value="1"><P>Create a Windows Form.</P></span></LI><LI><span style="font-weight:normal" value="2"><P>Drag on a ReportDocument object, and set it to point to the report you created in How-To 10.1. Then name your report document <TT>rdHowTo10_5</TT>.</P></span></LI><LI><span style="font-weight:normal" value="3"><P>Place the controls shown in Figure 10.21 onto the form with the properties set in Table 10.4.</P>
<P><TABLE BORDER="1" align="center" CELLPADDING="6" CELLSPACING="0">
<CAPTION><h5 class="docTableTitle">Table 10.4. Label, Combo, and CrystalReportViewer Controls and Their Property Settings</h5></CAPTION><COLGROUP span="3">
<TR>
<TH class="docTableHeader" align="left" valign="top">
<P>Object</P>
</TH>
<TH class="docTableHeader" align="left" valign="top">
<P>Property</P>
</TH>
<TH class="docTableHeader" align="left" valign="top">
<P>Setting</P>
</TH>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>Label</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Text</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Pick a Region</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>ComboBox</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Name</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>cboRegions</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>CrystalReportViewer</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Name</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>cvwRegionReport</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">&nbsp;</TD>
<TD class="docTableCell" valign="top">
<P><TT>Anchor</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Top, Bottom, Right, Left</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">&nbsp;</TD>
<TD class="docTableCell" valign="top">
<P><TT>ReportSource</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>rdHowTo10_5</TT></P>
</TD>
</TR>

</TABLE><p></P></span></LI><LI><span style="font-weight:normal" value="4"><P>Add the code in Listing 10.3 into the Load event of the form. This code performs a <TT>DISTINCT</TT> SQL statement to get all of the regions used in the Customers table. The data adapter then fills dtRegions. Before binding dtRegions to the combo box cboRegions, a new data row is added to allow the user to specify All Regions.</P>
<H5 class="docExampleTitle">Listing 10.3 <TT>frmHowTo10_5.vb</TT>: Populating the Selection Combo Box</H5>
<PRE>
Private Sub frmHowTo10_5_Load(ByVal sender As System.Object, _
            ByVal e As System.EventArgs) Handles MyBase.Load

    Dim odaRegions As New _
            OleDb.OleDbDataAdapter("SELECT DISTINCT Region FROM Customers",
                    BuildCnnStr("(local)", "Northwind"))
    Dim dtRegions As New DataTable()

    odaRegions.Fill(dtRegions)

    '-- Add the All Regions feature
    Dim drAll As DataRow = dtRegions.NewRow
    drAll(0) = "&lt;&lt; ALL Regions &gt;&gt;"
    dtRegions.Rows.Add(drAll)


    With Me.cboRegions
        .DataSource = dtRegions
        .ValueMember = "Region"
    End With


End Sub
</PRE>
<div class="docNote"><p class="docNoteTitle">Note</p>
<p><table border="0" align="center" cellpadding="6" cellspacing="0"><tr>
<td width="60" valign="top"><IMG BORDER="0" ALIGN="LEFT" WIDTH="100" HEIGHT="100" src="FILES/note_icon.gif" ALT="graphics/note_icon.gif"></td>
<td valign="top"><P>As with a number of other examples, the <TT>BuildCnnStr()</TT> function has been created in the <TT>modGeneralRoutines</TT> module to create a connection string.</P>
</td>
</tr></table><p></p>
</div></span></LI><LI><span style="font-weight:normal" value="5"><P>Add the report in Listing 10.4 to the <TT>SelectedIndexChanged</TT> event of <TT>cboRegions</TT>. One of the values that is in the Region field of the Customer table is <TT>NULL</TT>. This code tests for that first by testing this:</P>
<pre>
Me.cboRegions.SelectedItem(0) Is System.DBNull.Value
</pre>
<P>If the selected item is <TT>NULL</TT>, which uses <TT>System.DBNull.Value</TT> for the comparison, then the value of <TT>IsNull</TT>(<TT>{Customers.Region}</TT>) is stored in the <TT>SelectionFormula</TT>. If All Reasons was chosen, then the <TT>SelectFormula</TT> is set to the empty string so that all items are chosen. Otherwise, the Customers.Region field is compared to the literal region, supplied by cboRegions. The last task performed is refreshing the report.</P>
<H5 class="docExampleTitle">Listing 10.4 <TT>frmHowTo10_5.vb</TT>: Setting the SelectionFormula Property</H5>
<PRE>
Private Sub cboRegions_SelectedIndexChanged(ByVal sender As System.Object, _
                ByVal e As System.EventArgs) _
                  Handles cboRegions.SelectedIndexChanged

    With Me.cvwRegionReport

        If Me.cboRegions.SelectedItem(0) Is System.DBNull.Value Then

            .SelectionFormula = "IsNull({Customers.Region})"

        ElseIf Me.cboRegions.SelectedItem(0) = "&lt;&lt; ALL Regions &gt;&gt;" Then

            .SelectionFormula = ""

        Else

            .SelectionFormula = "{Customers.Region} = '" &amp; _
                               Me.cboRegions.SelectedItem(0) &amp; "'"
        End If

        .RefreshReport()

    End With

End Sub
</PRE></span></LI></OL></span>
<CENTER><H5 class="docFigureTitle">Figure 10.21. You can let your user control how much data he sees in the report.</H5><p><IMG BORDER="0" WIDTH="500" HEIGHT="367" src="FILES/10fig21.jpg" ALT="graphics/10fig21.jpg"></p>
</CENTER>
<H4 class="docSection2Title"> Comments</H4>
<P>You can limit the selection displayed on the report in other ways, too. This How-To presented just one way to get you started. Letting your user choose the records gives him the perceived control he wants.</P>
<img src="FILES/pixel.gif" width="1" height="1" border="0"><ul></ul>
</body></html>
