<html><head>
<META http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
<!--SafClassName="docSection1Title"--><!--SafTocEntry="6.2 Use Variables and Functions in T-SQL"-->
<link rel="STYLESHEET" type="text/css" href="FILES/style.css">
<link rel="STYLESHEET" type="text/css" href="FILES/docsafari.css">
<style type="text/css">	.tt1    {font-size: 10pt;}</style>
</head>
<body><H3 class="docSection1Title">6.2 Use Variables and Functions in T-SQL</H3>
<P>I understand that I can use parameters in my stored procedures, but how do I use variables and functions within T-SQL?</P>
<H4 class="docSection2Title"> Technique</H4>
<P>It is time to expand the coding you do using T-SQL. In this book so far, you have pretty well been limited to single-line <TT>SELECT</TT> statements. Now you will learn how to use variables and built-in functions. To achieve this, look at the routine that will be created here:</P>
<pre>
DECLARE @Cust_Id nchar(5), @Order_Date datetime

SET @Cust_Id = 'ANTON'
SET @Order_Date = '11/27/1996'

SELECT OrderID, OrderDate, ShippedDate,
DateDiff(day, @Order_Date, ShippedDate) as Days_To_Ship
FROM Orders
WHERE CustomerID = @Cust_Id and OrderDate = @Order_Date
</pre>
<H5 class="docSection3Title"> Declaring Local Variables in T-SQL</H5>
<P>You can use variables in T-SQL much like you would in your other coding languages. First, you must declare them. To declare variables in T-SQL, you will use the <TT>DECLARE</TT> statement, the ampersand with the variable name, and the data type. You can see an example of the variable declaration here, where <TT>nchar</TT>, with the length and datetime variables, is declared.</P>
<pre>
DECLARE @Cust_Id nchar(5), @Order_Date datetime
</pre>
<div class="docNote"><p class="docNoteTitle">Note</p>
<p><table border="0" align="center" cellpadding="6" cellspacing="0"><tr>
<td width="60" valign="top"><IMG BORDER="0" ALIGN="LEFT" WIDTH="100" HEIGHT="100" src="FILES/note_icon.gif" ALT="graphics/note_icon.gif"></td>
<td valign="top"><P>Besides the standard SQL Server data types, such as <TT>nchar</TT>, <TT>int</TT>, and <TT>datetime</TT>, you can also declare and create a Table datatype. You will see an example of this in How-To 6.8, found later in this chapter.</P>
</td>
</tr></table></p>
</div><br>
<P>After you have declared the variables, you need to initialize them before you can use them.</P>
<H5 class="docSection3Title"> Initialing Local Variables in T-SQL</H5>
<P>To initialize the variables, you will use the SET command, shown in these two lines of code:</P>
<pre>
SET @Cust_Id = 'ANTON'
SET @Order_Date = '11/27/1996'
</pre>
<P>By setting the initial values, you are then ready to use the variables within the rest of your procedure, any way that you need them, again, by using the @varname syntax.</P>
<H5 class="docSection3Title"> Utilizing Built-In Functions</H5>
<P>Within T-SQL, you can also use functions to perform some of the tasks needed, just as you do within Visual Basic. Not all of the functions are the same, nor are there necessarily as many. For instance, instead of a <TT>Date()</TT> function, which is used in Visual Basic, in T-SQL, you use the <TT>GetDate()</TT> function. Functions also will not necessarily return the same values or accept the same parameters.</P>
<P>This How-To calls the <TT>DateDiff()</TT> function. As with Visual Basic's <TT>DateDiff()</TT> function, this function takes two dates, and based on the interval requested, it returns the difference between the two. To check out other functions that are available, you can look up the word <span class="docEmphasis">function</span> in the Books On-Line for SQL-SQL Server.</P>
<H4 class="docSection2Title"> Steps</H4>
<P>Open and run the Visual Basic .NET-Chapter 6 solution. From the main page, click on the button with the caption How-To 6.2. When the form loads, you will see a SQL statement display in a label, and a DataGrid displayed below (see Figure 6.3).</P>


<span style="font-weight:bold"><OL class="docList" START="1">
<LI><span style="font-weight:normal" value="1"><P>Create a Windows Form. Then place the controls listed in Table 6.2 and seen in Figure 6.3 with the following properties set.</P>
<P><TABLE BORDER="1" align="center" CELLPADDING="6" CELLSPACING="0">
<CAPTION><h5 class="docTableTitle">Table 6.2. Control Property Settings for This How-To</h5></CAPTION><COLGROUP span="3">
<TR>
<TH class="docTableHeader" align="left" valign="top">
<P><TT>Object</TT></P>
</TH>
<TH class="docTableHeader" align="left" valign="top">
<P><TT>Property</TT></P>
</TH>
<TH class="docTableHeader" align="left" valign="top">
<P><TT>Setting</TT></P>
</TH>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>Label</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Text</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>SQL Statement</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>Label</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Name</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>lblSQLString</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>Label</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Text</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Results</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>DataGrid</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Name</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>dgResult</TT>s</P>
</TD>
</TR>
</COLGROUP>
</TABLE></P></span></LI><LI><span style="font-weight:normal" value="2"><P>Add the code in Listing 6.2 to the Load event of the form. (Double-click on the form to bring up the code.) Creating the T-SQL routine described in the "Technique" section, this code then assigns the routine to the Text property of the Label called <TT>lblSQLString</TT>. It then creates a data adapter using the string and fills the <TT>dtResults DataTable</TT>. Last, the code assigns the data adapter as the data source for the dgResults data grid.</P>
<H5 class="docExampleTitle">Listing 6.5 <TT>frmHowTo6_2.vb</TT>: Storing the SQL Statement and Then Executing</H5>
<PRE>
Private Sub frmHowTo6_2_Load(ByVal sender As System.Object,
                    ByVal e As System.EventArgs) Handles MyBase.Load


        '-- Build the SQL String
        Dim strSQL As String

        strSQL = "DECLARE @Cust_Id nchar(5), @Order_Date datetime " &amp; _
                          vbCrLf &amp; vbCrLf

        strSQL &amp;= "SET @Cust_Id = 'ANTON'" &amp; vbCrLf
        strSQL &amp;= "SET @Order_Date = '11/27/1996'" &amp; vbCrLf &amp; vbCrLf

        strSQL &amp;= "SELECT OrderID, OrderDate, ShippedDate, "
        strSQL &amp;= "DateDiff(day, @Order_Date, ShippedDate) as Days_To_Ship "
        strSQL &amp;= "FROM Orders" &amp; vbCrLf
        strSQL &amp;= "WHERE CustomerID = @Cust_Id and OrderDate = @Order_Date"

        '-- Store the SQL String
        Me.lblSQLString.Text = strSQL

        '-- Use the SQL String to build the data adapter and fill the data table.
        Dim odaResults As New OleDb.OleDbDataAdapter(Me.lblSQLString.Text,
                                  BuildCnnStr("(local)", "Northwind"))
        Dim dtResults As New DataTable()

        Try
            odaResults.Fill(dtResults)
        Catch excp As Exception
            MessageBox.Show(excp.Message)
            Exit Sub
        End Try

        '-- Assign the data table to the data grid's DataSource property
        Me.dgResults.DataSource = dtResults

End Sub
</PRE></span></LI></OL></span>
<CENTER><H5 class="docFigureTitle">Figure 6.3. The Days_To_Ship is derived from using the DateDiff function with the OrderDate and ShippedDate.</H5><p><IMG BORDER="0" WIDTH="500" HEIGHT="295" src="FILES/06fig03.jpg" ALT="graphics/06fig03.jpg"></p>
</CENTER>
<H4 class="docSection2Title"> Comments</H4>
<P>For the most part, you will use parameters when you are creating your T-SQL routines. However, when you're creating multiple steps in your routines that are getting more complex, you'll use variables more often.</P>
<img src="FILES/pixel.gif" width="1" height="1" border="0"><ul></ul>
</body></html>
