<html><head>
<META http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
<!--SafClassName="docSection1Title"--><!--SafTocEntry="7.4 Transfer Tables Between SQL Server Databases"-->
<link rel="STYLESHEET" type="text/css" href="FILES/style.css">
<link rel="STYLESHEET" type="text/css" href="FILES/docsafari.css">
<style type="text/css">	.tt1    {font-size: 10pt;}</style>
</head>
<body><H3 class="docSection1Title">7.4 Transfer Tables Between SQL Server Databases</H3>
<P>Users sometimes need to transfer (copy) tables between SQL Server databases. This How-To shows how to allow the user to choose multiple tables and copy them from one database to another as well as tables from two different databases on two different SQL servers.</P>
<P>One of the tasks your clients have you perform for them using the Enterprise Manager is to transfer objects, such as tables, between SQL Server databases. How do you create a dialog box that would allow the user to transfer databases between two SQL Server databases?</P>
<H4 class="docSection2Title"> Technique</H4>
<P>Unlike the earlier How-Tos in this chapter, you will be using the SQL-DTS object model in addition to SQL-DMO. You can see the objects, properties, and methods that will be used from SQL-DTS in Table 7.7.</P>
<P><TABLE BORDER="1" align="center" CELLPADDING="6" CELLSPACING="0">
<CAPTION><h5 class="docTableTitle">Table 7.7. SQL-DTS Objects That Are Used to Perform the Transfer of Tables from One SQL Server Database to Another</h5></CAPTION><COLGROUP span="2">
<TR>
<TH class="docTableHeader" align="left" valign="top">
<P>Object</P>
</TH>
<TH class="docTableHeader" align="left" valign="top">
<P>Property/Method</P>
</TH>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>Package</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Steps.New</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">&nbsp;</TD>
<TD class="docTableCell" valign="top">
<P><TT>Tasks.New</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">&nbsp;</TD>
<TD class="docTableCell" valign="top">
<P><TT>Steps.Add</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">&nbsp;</TD>
<TD class="docTableCell" valign="top">
<P><TT>Tasks.Add</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">&nbsp;</TD>
<TD class="docTableCell" valign="top">
<P><TT>Execute</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>Step</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>TaskName</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">&nbsp;</TD>
<TD class="docTableCell" valign="top">
<P><TT>Name</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>Task</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>CustomTask</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>CustomTask</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Name</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">&nbsp;</TD>
<TD class="docTableCell" valign="top">
<P><TT>SourceServer</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">&nbsp;</TD>
<TD class="docTableCell" valign="top">
<P><TT>SourceUseTrustedConnection</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">&nbsp;</TD>
<TD class="docTableCell" valign="top">
<P><TT>SourceDatabase</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>DestinationServer</TT></P>
<P><TT>DestinationUseTrustedConnection</TT></P>
</TD>
<TD class="docTableCell" valign="bottom">
<P><TT>DestinationDatabase</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">&nbsp;</TD>
<TD class="docTableCell" valign="top">
<P><TT>CopyAllObjects</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">&nbsp;</TD>
<TD class="docTableCell" valign="top">
<P><TT>IncludeDependencies</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">&nbsp;</TD>
<TD class="docTableCell" valign="top">
<P><TT>IncludeLogins</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">&nbsp;</TD>
<TD class="docTableCell" valign="top">
<P><TT>IncludeUsers</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">&nbsp;</TD>
<TD class="docTableCell" valign="top">
<P><TT>DropDestinationObjectsFirst</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">&nbsp;</TD>
<TD class="docTableCell" valign="top">
<P><TT>CopySchema</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">&nbsp;</TD>
<TD class="docTableCell" valign="top">
<P><TT>CopyData</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">&nbsp;</TD>
<TD class="docTableCell" valign="top">
<P><TT>AddObjectForTransfer</TT></P>
</TD>
</TR>
</COLGROUP>
</TABLE></P>
<P>Using the items just listed, you will create a form with options to transfer tables between two SQL databases.</P>
<H4 class="docSection2Title"> Steps</H4>
<P>Open and run the VB.NET -Chapter 7 solution. From the main Windows form, click on the command button with the caption How-To 7.4. You will then see a form allowing you to pick SQL Servers on the network to transfer from and to. After you have chosen these, you can then select which databases you want to transfer from and to. After choosing from the database to transfer from, you are then presented with a list of tables to transfer from. You can then highlight multiple tables, as shown in Figure 7.9.</P>
<CENTER><H5 class="docFigureTitle">Figure 7.9. Transferring tables between SQL Server databases.</H5><p><IMG BORDER="0" WIDTH="480" HEIGHT="328" src="FILES/07fig09.gif" ALT="graphics/07fig09.gif"></p>
</CENTER>
<div class="docNote"><p class="docNoteTitle">Tip</p>
<p><table border="0" align="center" cellpadding="6" cellspacing="0"><tr>
<td width="60" valign="top"><IMG BORDER="0" ALIGN="LEFT" WIDTH="100" HEIGHT="100" src="FILES/tip_icon.gif" ALT="graphics/tip_icon.gif"></td>
<td valign="top"><P>One of the options included as a property of the <TT>CustomTask</TT> object is <TT>IncludeDependencies</TT>. This option specifies whether to have DTS transfer related tables as well as the selected table(s). This could be put as an option on the form as well. For this example, I have it set to <TT>True</TT>.</P>
</td>
</tr></table></p>
</div><br>







<span style="font-weight:bold"><OL class="docList" START="1">
<LI><span style="font-weight:normal" value="1"><P>Create a Windows Form. Then place the controls shown in Figure 7.9, with the following properties set as in Table 7.8.</P>
<P><TABLE BORDER="1" align="center" CELLPADDING="6" CELLSPACING="0">
<CAPTION><h5 class="docTableTitle">Table 7.8. Label, ListBox, and Command Button Controls Property Settings</h5></CAPTION><COLGROUP span="3">
<TR>
<TH class="docTableHeader" align="left" valign="top">
<P>Object</P>
</TH>
<TH class="docTableHeader" align="left" valign="top">
<P>Property</P>
</TH>
<TH class="docTableHeader" align="left" valign="top">
<P>Setting</P>
</TH>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>Label</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Name</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Label1</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">&nbsp;</TD>
<TD class="docTableCell" valign="top">
<P><TT>Text</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>From SQL Servers</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>ListBox</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Name</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>lstFromSQLServer</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>Label</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Name</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Label2</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">&nbsp;</TD>
<TD class="docTableCell" valign="top">
<P><TT>Text</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>To SQL Servers</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>ListBox</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Name</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>lstToSQLServer</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>Label</TT> </P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Name</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Label3</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">&nbsp;</TD>
<TD class="docTableCell" valign="top">
<P><TT>Text</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Transfer from Database</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>ListBox</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Name</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>lstFromDB</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>Label</TT> </P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Name</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Label4</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">&nbsp;</TD>
<TD class="docTableCell" valign="top">
<P><TT>Text</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Transfer to Database</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>ListBox</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Name</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>lstToDB</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>Label</TT> </P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Name</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Label5</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">&nbsp;</TD>
<TD class="docTableCell" valign="top">
<P><TT>Text</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Table(s) to Transfer</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>ListBox</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Name</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>lstTables</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">&nbsp;</TD>
<TD class="docTableCell" valign="top">
<P><TT>SelectionMode</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>MultiSimple</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>Command Button</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Name</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>btnTransfer</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">&nbsp;</TD>
<TD class="docTableCell" valign="top">
<P><TT>Text</TT> </P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>&amp;Perform Transfer</TT></P>
</TD>
</TR>
</COLGROUP>
</TABLE></P></span></LI><LI><span style="font-weight:normal" value="2"><P>On the form, add the code in Listing 7.18 to the Load event. This will look familiar from How-To 7.1. For an examination of the <TT>LoadSQLServers</TT> routine, check out step 4 in that How-To. Different from the other How-Tos in this chapter thus far, however, is the fact that the <TT>LoadSQLServers</TT> routine is called twice: once for the <TT>lstFromSQLServer</TT>, and a second time for the <TT>lstToSQLServer</TT>.</P>
<H5 class="docExampleTitle">Listing 7.18 <TT>frmHowTo7_4.vb</TT>: Calling the Routine That Loads Available SQL Servers into a List Box</H5>
<PRE>
Private Sub frmHowTo7_4_Load(ByVal sender As System.Object,
ByVal e As System.EventArgs) Handles MyBase.Load

        LoadSQLServers(Me.lstFromSQLServer)
        LoadSQLServers(Me.lstToSQLServer)

End Sub
</PRE></span></LI><LI><span style="font-weight:normal" value="3"><P>On the <TT>lstFromSQLServer</TT> and <TT>lstToSQLServer</TT> list boxes, add the code in Listing 7.19 to the <TT>SelectedIndexChanged</TT> event of each, as appropriate. These routines call <TT>GetSQLDatabases</TT>, described in step 6 of How-To 7.1.</P>
<H5 class="docExampleTitle">Listing 7.19 <TT>frmHowTo7_4.vb</TT>: Populating the lstDatabases and lstBackupDevices List Boxes</H5>
<PRE>
Private Sub lstFromSQLServer_SelectedIndexChanged(ByVal sender As System.Object,
ByVal e As System.EventArgs) Handles lstFromSQLServer.SelectedIndexChanged

        GetSQLDatabases(Me.lstFromSQLServer.SelectedItem, Me.lstFromDB)

    End Sub

Private Sub lstToSQLServer_SelectedIndexChanged(ByVal sender As System.Object, _
            ByVal e As System.EventArgs) _
           Handles lstToSQLServer.SelectedIndexChanged

        GetSQLDatabases(Me.lstToSQLServer.SelectedItem, Me.lstToDB)

End Sub
</PRE></span></LI><LI><span style="font-weight:normal" value="4"><P>On the lstFromTables list box, add the code in Listing 7.20 to the <TT>SelectedIndexChanged</TT> event. This routine starts off by logging onto the server that is selected in the lstFromSQLServer list box, and then creates a reference to the database that is selected in the lstFromDB list box. After clearing the lstTables list box, the routine iterates through each of the tables in the database and adds the names of those that are user tables to the lstTables items.</P>
<H5 class="docExampleTitle">Listing 7.20 <TT>frmHowTo7_4.vb</TT>: Populating the lstDatabases and lstBackupDevices List Boxes</H5>
<PRE>
Private Sub lstFromDB_SelectedIndexChanged(ByVal sender As System.Object,
ByVal e As System.EventArgs) Handles lstFromDB.SelectedIndexChanged

        '-- Create the connection and specify the stored procedure to use.
        Dim odb As SQLDMO.Database
        Dim otbl As SQLDMO.Table
        Dim oapp As New SQLDMO.Application()
        Dim osvr As New SQLDMO.SQLServer()

        Try

            osvr.LoginSecure = True
            osvr.Connect(Me.lstFromSQLServer.SelectedItem)
            odb = osvr.Databases.Item(Me.lstFromDB.SelectedItem)

            Me.lstTables.Items.Clear()

            For Each otbl In odb.Tables
                If otbl.TypeOf = _
                  SQLDMO.SQLDMO_OBJECT_TYPE.SQLDMOObj_UserTable Then
                    Me.lstTables.Items.Add(otbl.Name)
                End If
            Next

        Catch excpData As Exception
            MessageBox.Show("Error Occurred: " &amp; excpData.Message)

        End Try


    End Sub
</PRE>
<div class="docNote"><p class="docNoteTitle">Tip</p>
<p><table border="0" align="center" cellpadding="6" cellspacing="0"><tr>
<td width="60" valign="top"><IMG BORDER="0" ALIGN="LEFT" WIDTH="100" HEIGHT="100" src="FILES/tip_icon.gif" ALT="graphics/tip_icon.gif"></td>
<td valign="top"><P>You could really make this a flexible and powerful utility by including different objects to transfer other than just user tables. Some examples could be stored procedures or views.</P>
</td>
</tr></table></p>
</div></span></LI><LI><span style="font-weight:normal" value="5"><P>On the lstTables list box, add the code in Listing 7.21 to the SelectedIndexChanged event. This routine enables the btnTransfer button.</P>
<H5 class="docExampleTitle">Listing 7.21 <TT>frmHowTo7_4.vb</TT>: Performing the Transfer of Tables</H5>
<PRE>
Private Sub lstTables_SelectedIndexChanged(ByVal sender As System.Object,
ByVal e As System.EventArgs) Handles lstTables.SelectedIndexChanged
        Me.btnTransfer.Enabled = True
End Sub
</PRE></span></LI><LI><span style="font-weight:normal" value="6"><P>Add the code in Listing 7.22 to the <TT>Click</TT> event of btnTransfer. This routine begins by declaring all the objects to be used, and then creates new Step and Task objects, with the type of task being specified. In this case, the task is of type <TT>DTSTransferObjectsTask</TT>. Next, the various necessary properties are set on the Task object. For each of the tables to be transferred, the <TT>AddObjectForTransfer</TT> method is executed, with the name of the table being passed to the method. After the name of the task is added to the step, both objects are added to their collections in the <TT>Package</TT> object. The <TT>Execute</TT> method of the <TT>Package</TT> object is then called.</P>
<H5 class="docExampleTitle">Listing 7.22 <TT>frmHowTo7_4.vb</TT>: Performing the Transfer of Tables</H5>
<PRE>
Private Sub btnTransfer_Click(ByVal sender As System.Object, _
                    ByVal e As System.EventArgs) Handles btnTransfer.Click

        Dim oPackage As New DTS.Package()
        Dim oStep As DTS.Step
        Dim oTask As DTS.Task
        Dim oXferObj As DTS.TransferObjectsTask
        Dim intCurrTable As Integer

        Try
            '-- Create step and task

            oStep = oPackage.Steps.New
            oTask = oPackage.Tasks.New("DTSTransferObjectsTask")
            oXferObj = oTask.CustomTask

            '-- Configure transfer objects task

            With oXferObj

                .Name = "XferObjTask"
                .SourceServer = Me.lstFromSQLServer.SelectedItem
                .SourceUseTrustedConnection = True
                .SourceDatabase = Me.lstFromDB.SelectedItem
                .DestinationServer = Me.lstToSQLServer.SelectedItem
                .DestinationUseTrustedConnection = True
                .DestinationDatabase = Me.lstToDB.SelectedItem
                .CopyAllObjects = False
                .IncludeDependencies = True
                .IncludeLogins = False
                .IncludeUsers = False
                .DropDestinationObjectsFirst = False
                .CopySchema = True
                .CopyData = DTS.DTSTransfer_CopyDataOption.DTSTransfer_AppendData

                For intCurrTable = 0 To Me.lstTables.SelectedItems.Count - 1

                    .AddObjectForTransfer( _
                            Me.lstTables.SelectedItems.Item(intCurrTable), "dbo",
                            DTS.DTSSQLObjectType.DTSSQLObj_UserTable)

                Next

            End With

            '-- Link step to task
            oStep.TaskName = oXferObj.Name
            oStep.Name = "XferObjStep"
            oPackage.Steps.Add(oStep)
            oPackage.Tasks.Add(oTask)

            oPackage.Execute()

        Catch excp As Exception

            MessageBox.Show(excp.Message, "Error Occurred")
            Exit Sub

        End Try

        MessageBox.Show("Tables Transferred")

End Sub
</PRE></span></LI><LI><span style="font-weight:normal" value="7"><P>Add the code in Listing 7.23 to the <TT>Click</TT> event of btnClose.</P>
<H5 class="docExampleTitle">Listing 7.23 <TT>frmHowTo7_4.vb</TT>: Closing the Form</H5>
<PRE>
Private Sub btnClose_Click(ByVal sender As System.Object, _
                    ByVal e As System.EventArgs) Handles btnClose.Click

        Me.Close()

End Sub
</PRE></span></LI></OL></span>
<H4 class="docSection2Title"> How It Works</H4>
<P>Using the Data Transformation Services API requires a bit more work than just using SQL-DMO. To use SQL-DTS, you need to also have a concept of using workflow. Workflow allows you to specify steps in a package and assign tasks to those steps. Task objects that are not assigned to steps can be included in the package, but they will not be executed. You can see an example of multiple tasks being performed by the arrows in the package in Enterprise Manager (see Figure 7.10).</P>
<CENTER><H5 class="docFigureTitle">Figure 7.10. This DTS package has multiple tasks that are being performed and shows workflow.</H5><p><IMG BORDER="0" WIDTH="500" HEIGHT="279" src="FILES/07fig10.gif" ALT="graphics/07fig10.gif"></p>
</CENTER>
<P>This example is simple in that it has only one step and task. For more information on using workflow and DTS packages, check out SQL Server's Books On-Line, and look up "workflow."</P>
<P>As you create each of the tasks, you will have to set the various properties that are necessary to perform the tasks. The source and destination servers and databases are examples of this.</P>
<H4 class="docSection2Title"> Comments</H4>
<P>As mentioned, using DTS takes a bit more work to understand than DMO, but after you understand what needs to be done, there is little you can't perform using it.</P>
<ul></ul>
</body></html>
