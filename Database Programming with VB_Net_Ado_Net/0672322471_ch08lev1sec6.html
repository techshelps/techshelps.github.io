<html><head>
<META http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
<!--SafClassName="docSection1Title"--><!--SafTocEntry="8.6 Use a Single Web Form to Update Multiple Lookup Tables"-->
<link rel="STYLESHEET" type="text/css" href="FILES/style.css">
<link rel="STYLESHEET" type="text/css" href="FILES/docsafari.css">
<style type="text/css">	.tt1    {font-size: 10pt;}</style>
</head>
<body><H3 class="docSection1Title">8.6 Use a Single Web Form to Update Multiple Lookup Tables</H3>
<P>As with the second tutorial(8.2), this example will show you how to update multiple lookup tables-this time using a Web Form.</P>
<P>Creating a Web Form for viewing multiple lookup tables would take about the same if not less code than performing the same task using the Windows Form. Updating, adding, and deleting data takes a bit more work, though. This How-To will show you how to accomplish this task by using the <TT>DataGrid</TT> control and show you how to take advantage of <TT>Session</TT> variables and paging within the data grid when you're manipulating data.</P>
<H4 class="docSection2Title"> Technique</H4>
<P>The <TT>DataGrid</TT> control is a powerful control, as you saw in Chapter 5, "Working with Data on Web Forms," but when programming in Web Forms, it takes some getting used to. Because the Web Forms are stateless, you need to keep reminding the data grid what it is bound to.</P>
<P>Also, even though you declare a variable at the module level behind the form, you will notice that whenever the form goes back to the server for information, you lose the values of your variables. The workaround for this is the use of the Session object.</P>
<div class="docNote"><p class="docNoteTitle">Note</p>
<p><table border="0" align="center" cellpadding="6" cellspacing="0"><tr>
<td width="60" valign="top"><IMG BORDER="0" ALIGN="LEFT" WIDTH="100" HEIGHT="100" src="FILES/note_icon.gif" ALT="graphics/note_icon.gif"></td>
<td valign="top"><P>A full discussion of <TT>State</TT> management in .NET and the various options is presented in Chapter 5. This also includes how to use the options for the data grid manipulation portion of this How-To.</P>
</td>
</tr></table></p>
</div><br>
<P>The other major issue with this How-To is managing the paging of the <TT>DataGrid</TT> control, covered in Chapter 4. You will quickly learn the steps of creating the Web Form that allows users to update Lookup tables.</P>
<H4 class="docSection2Title"> Steps</H4>
<P>Open and run the VB.NET -Chapter 8 solution. From the main Web Form, click on the hyperlink with the caption How-To 8.6: Use a Single Web Form for Updating Multiple Lookup Tables. Click on the first choice, Categories, in the list box labeled Lookup Table to Edit. The data grid will then appear. The grid will be filled in with the data of the table you chose. Your page will then look like the page displayed in Figure 8.9.</P>
<CENTER><H5 class="docFigureTitle">Figure 8.9. On this page, you can add, edit, and delete information for all your simple lookup tables.</H5><p><IMG BORDER="0" WIDTH="500" HEIGHT="375" src="FILES/08fig09.gif" ALT="graphics/08fig09.gif"></p>
</CENTER>
<P>You can now add data into the data grid by clicking on the Add New button, located under the Error box. When you click on the Add New button, an entry is added to the data grid, and you are placed in Edit mode, shown in Figure 8.10.</P>
<CENTER><H5 class="docFigureTitle">Figure 8.10. Adding new data to your lookup tables using the DataGrid control.</H5><p><IMG BORDER="0" WIDTH="500" HEIGHT="375" src="FILES/08fig10.gif" ALT="graphics/08fig10.gif"></p>
</CENTER>
<P>After entering the data into the fields, you will click Update. The values are then saved back to the server. If you don't want to save the new entry, click the Cancel button, and the data grid makes the entry disappear.</P>
<div class="docNote"><p class="docNoteTitle">Tip</p>

<p><table border="0" align="center" cellpadding="6" cellspacing="0"><tr>
<td width="60" valign="top"><IMG BORDER="0" ALIGN="LEFT" WIDTH="100" HEIGHT="100" src="FILES/tip_icon.gif" ALT="graphics/tip_icon.gif"></td>
<td valign="top">
<P></P>
</td>
</tr></table></p>
<P>You will notice that the look of the columns is a little congested and changes when you go to edit the data. You can avoid this by creating and using templates with the data grid. Of course, if you are using templates with the data grid, you have to change the template based on the lookup table you were using.</P>
</div><br>
<div class="docNote"><p class="docNoteTitle">Tip</p>
<p><table border="0" align="center" cellpadding="6" cellspacing="0"><tr>
<td width="60" valign="top"><IMG BORDER="0" ALIGN="LEFT" WIDTH="100" HEIGHT="100" src="FILES/tip_icon.gif" ALT="graphics/tip_icon.gif"></td>
<td valign="top"><P>You will also notice that the CategoryID field has been disabled and can't be edited. This is through the use of a method, <TT>FillSchema</TT>, which fills data table with schema information from the record source. In this case, <TT>FillSchema</TT> passed on the information that the CategoryID was an AutoIncrement field, and the data grid was smart enough to handle it.</P>
</td>
</tr></table></p>
</div><br>
<P>When you click on the Edit button, the page will look similar to Figure 8.10, except that data already will be present in the fields. When you click Delete, the entry is deleted.</P>
<P>Any errors that might occur, such as from data integrity errors, will appear in the text box labeled Errors. If you try to delete a current category and Products uses that category, for example, then SQL Server causes an error to occur, and the page reports the error because of code created.</P>












<span style="font-weight:bold"><OL class="docList" START="1">
<LI><span style="font-weight:normal" value="1"><P>Create a Web Form. Then place the controls shown in Figure 8.9 with the properties shown in Table 8.8.</P>
<P><TABLE BORDER="1" align="center" CELLPADDING="6" CELLSPACING="0">
<CAPTION><h5 class="docTableTitle">Table 8.8. Label, TextBox, ListBox, and Command Button Control Property Settings</h5></CAPTION><COLGROUP span="3">
<TR>
<TH class="docTableHeader" align="left" valign="top">
<P>Object</P>
</TH>
<TH class="docTableHeader" align="left" valign="top">
<P>Property</P>
</TH>
<TH class="docTableHeader" align="left" valign="top">
<P>Setting</P>
</TH>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>DOCUMENT</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>bgColor</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>buttonface</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>Label</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Name</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Label1</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">&nbsp;</TD>
<TD class="docTableCell" valign="top">
<P><TT>Text</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Lookup Table to Edit:</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>ListBox</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Name</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>lstLookupTables</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">&nbsp;</TD>
<TD class="docTableCell" valign="top">
<P><TT>AutoPostback</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>True</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>Label</TT> </P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Name</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Label2</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">&nbsp;</TD>
<TD class="docTableCell" valign="top">
<P><TT>Text</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Lookup Table Data:</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>DataGrid</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Name</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>dgLookupData</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">&nbsp;</TD>
<TD class="docTableCell" valign="top">
<P><TT>AllowPaging</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>True</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">&nbsp;</TD>
<TD class="docTableCell" valign="top">
<P><TT>PageSize</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>5</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>Label</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Name</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Label3</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">&nbsp;</TD>
<TD class="docTableCell" valign="top">
<P><TT>Text</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Errors:</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>TextBox</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Name</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>txtError</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">&nbsp;</TD>
<TD class="docTableCell" valign="top">
<P><TT>ForeColor</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Red</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">&nbsp;</TD>
<TD class="docTableCell" valign="top">
<P><TT>ReadOnly</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>True</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">&nbsp;</TD>
<TD class="docTableCell" valign="top">
<P><TT>TextMode</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>MultiLine</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>Button</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Name</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>btnAdd</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">&nbsp;</TD>
<TD class="docTableCell" valign="top">
<P><TT>Text</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Add New</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>HyperLink</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Name</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>hplReturnToMain</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">&nbsp;</TD>
<TD class="docTableCell" valign="top">
<P><TT>NavigateURL</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>wfrmMain.aspx</TT></P>
</TD>
</TR>
</COLGROUP>
</TABLE></P></span></LI><LI><span style="font-weight:normal" value="2"><P>On the newly created lstLookupTables <TT>ListBox</TT> control, click the Build button next to the <TT>Items</TT> property, which is a collection of names of the lookup tables to edit. After you have clicked the Build button, the ListItem Collection Editor opens. Enter the values Categories, Regions, and Territories, as shown in Figure 8.11. Click OK to accept the entries.</P>
<CENTER><H5 class="docFigureTitle">Figure 8.11. These values allow you to update multiple lookup tables from a single Web Form.</H5><p><IMG BORDER="0" WIDTH="487" HEIGHT="437" src="FILES/08fig11.gif" ALT="graphics/08fig11.gif"></p>
</CENTER>
<div class="docNote"><p class="docNoteTitle">Tip</p>
<p><table border="0" align="center" cellpadding="6" cellspacing="0"><tr>
<td width="60" valign="top"><IMG BORDER="0" ALIGN="LEFT" WIDTH="100" HEIGHT="100" src="FILES/tip_icon.gif" ALT="graphics/tip_icon.gif"></td>
<td valign="top"><P>To make this truly data driven, you could have these entries in a table in your database. Then you could point the <TT>DataSource</TT> property of the list box to the table. You could also have the table contain the names of the templates you wanted to use.</P>
<P>A different approach was taken here so that you would not have to modify your copy of the Northwind database.</P>
</td>
</tr></table></p>
</div></span></LI><LI><span style="font-weight:normal" value="3"><P>On the <TT>dgLookupData DataGrid</TT> control, click the Build button next to the Columns property. You will then be brought into the Columns tab of the dgLookupData Properties dialog box. Click on the plus sign by the Button column in the Available Columns list. You will then see the list of available button types you can use. Select the Edit, Update, Cancel, and Delete buttons. Set each of these buttons to have the PushButton button type. After you have made these selections, the dialog box will look like Figure 8.12. Click OK to accept the entries.</P>
<CENTER><H5 class="docFigureTitle">Figure 8.12. Add some buttons to your DataGrid control.</H5><p><IMG BORDER="0" WIDTH="500" HEIGHT="430" src="FILES/08fig12.gif" ALT="graphics/08fig12.gif"></p>
</CENTER></span></LI><LI><span style="font-weight:normal" value="4"><P>Now that you have added some buttons to the <TT>DataGrid</TT> control, you still have to tell the control how to react to the buttons. You will do that using events in code, but we need to add some tags to the HTML. The tags you will add are as follows:</P>
<pre>
OnUpdateCommand="dgLookupData_Update"
OnCancelCommand="dgLookupData_Cancel"
OnEditCommand="dgLookupData_Edit"
OnDeleteCommand="dgLookupData_Delete"
</pre>
<P>Click on the HTML tab of the Web Form in Visual Studio. Then you can see the HTML and insert the tags. By looking at the HTML shown in Figure 8.13, you can see where to put the tags. Of course, your HTML won't be as nicely laid out as this figure because Visual Studio scrunches it up.</P>
<CENTER><H5 class="docFigureTitle">Figure 8.13. Add the tags in this step to tie in the events to the buttons in the DataGrid control.</H5><p><IMG BORDER="0" WIDTH="500" HEIGHT="375" src="FILES/08fig13.gif" ALT="graphics/08fig13.gif"></p>
</CENTER></span></LI><LI><span style="font-weight:normal" value="5"><P>Now it's time for the code. The first items to add are the code for the module level <TT>DataTable</TT> object variable declaration and the code that you want to add for the Load event of the page. Both are shown in Listing 8.32. The load event tests for the <TT>Session</TT> variable <TT>MyLookupData</TT>; if the variable exists, the event creates a reference to the data table using the <TT>mdtLookupData DataTable</TT> object.</P>
<H5 class="docExampleTitle">Listing 8.32 <TT>frmHowTo8_6.aspx</TT>: Tracking the DataTable Object Between Trips to the Server</H5>
<PRE>
Private mdtLookupData As New DataTable()

Private Sub Page_Load(ByVal sender As System.Object, _
                ByVal e As System.EventArgs) Handles MyBase.Load

        'Put user code to initialize the page here
        If Not (Session("MyLookupData") Is Nothing) Then

            mdtLookupData = CType(Session("MyLookupData"), DataTable)

        End If

End Sub
</PRE></span></LI><LI><span style="font-weight:normal" value="6"><P>Add the code in Listing 8.33 to the <TT>SelectedIndexChanged</TT> event of <TT>lstLookupTables</TT>. This code starts off by clearing the <TT>txtError</TT> TextBox control that is used to store the Exception object's Message property that is caught later in the routine. Next, the odaLookupData <TT>DataAdapter</TT> object is built by creating a SQL Select statement from the currently selected table in lstLookupTables.</P>
<P>Now it's time to fill in the dtNew DataTable object, which is done using FillSchema and Fill. You have seen the Fill method before. FillSchema tells .NET to do just that-return the Schema to the data table, thus having your DataTable object use properties such as <TT>AutoIncrement</TT>, <TT>DataTypes</TT>, and even <TT>Constraints</TT>.</P>
<P>Next, the code reassigns the mdtLookupTable reference to point to dtNew. This works well for using the DataTable and <TT>DataGrid</TT> objects with different tables, which not only clears the data, but also resets what columns are being used in the data table object.</P>
<P>You can see that <TT>mdtLookupData</TT> is being stored to a <TT>Session</TT> object entry called <TT>MyDataTable</TT>, and a Boolean variable called <TT>IsAdding</TT> is set to <TT>False</TT>. This last variable will be set to <TT>True</TT> when the btnAdd is clicked and used for special handling when updating and canceling the editing of the data grid.</P>
<div class="docNote"><p class="docNoteTitle">Tip</p>
<p><table border="0" align="center" cellpadding="6" cellspacing="0"><tr>
<td width="60" valign="top"><IMG BORDER="0" ALIGN="LEFT" WIDTH="100" HEIGHT="100" src="FILES/tip_icon.gif" ALT="graphics/tip_icon.gif"></td>
<td valign="top"><P>You really need to watch where you are storing values to the <TT>Session</TT> object and other state management objects. Make sure you do store these objects before calling methods or accessing properties of server controls such as the <TT>DataGrid</TT> control.</P>
</td>
</tr></table></p>
</div>
<P>Next, the <TT>EditItemIndex</TT> property is set to -1 to unselect any item that is being edited. Then the <TT>CurrentPageIndex</TT> property is reset to 0 to reflect the first page in the data grid.</P>
<P>The data grid is then filled and the subroutine <TT>BindTheGrid()</TT> is called. You can find this subroutine at the bottom of the listing. This routine sets the <TT>DataSource</TT> property of the <TT>DataGrid</TT> control to <TT>mdtLookupData</TT> and calls the <TT>DataBind</TT> method of the <TT>DataGrid</TT> control.</P>
<H5 class="docExampleTitle">Listing 8.33 <TT>frmHowTo8_6.aspx</TT>: Tracking the DataTable Object Between Trips to the Server</H5>
<PRE>
Private Sub lstLookupTables_SelectedIndexChanged(ByVal sender As System.Object,
            ByVal e As System.EventArgs) _
           Handles lstLookupTables.SelectedIndexChanged

    Dim odaLookupData As OleDb.OleDbDataAdapter
    Dim dtNew As New DataTable()

    Me.txtError.Text = ""

    Try

        '-- Take the txtSQLString text and create a data table; then set the
        '   data source of the data grid.

        odaLookupData = New OleDb.OleDbDataAdapter("Select * From " &amp; _
                                    Me.lstLookupTables.SelectedItem.ToString,
                                    BuildCnnStr("(local)", "Northwind"))

        '-- Test for identity and display any other notes.
        odaLookupData.FillSchema(dtNew, SchemaType.Source)

        '-- Get the data and put it in the data table.
        odaLookupData.Fill(dtNew)


        '-- Save the data table to a session variable so that
        '   you don't lose it on a trip back to the server.
        '   Set the flag for adding new records to False.

        Session("IsAdding") = False
        Session("MyLookupData") = dtNew
        mdtLookupData = dtNew

        Me.dgLookupData.EditItemIndex = -1
        Me.dgLookupData.CurrentPageIndex = 0

        '-- Bind the data grid to the data table
        BindTheGrid()

    Catch excp As Exception

        '-- If an error occurs, stash the error message to a text box.
        Me.txtError.Text = excp.Message

    End Try

End Sub

Sub BindTheGrid()

    '-- Bind the data grid
    Me.dgLookupData.DataSource = mdtLookupData
    Me.dgLookupData.DataBind()

End Sub
</PRE></span></LI><LI><span style="font-weight:normal" value="7"><P>Add the code in Listing 8.34 to the <TT>Edit</TT> command of <TT>dgLookupData</TT>. This is one of the events specified in step 4. This code sets the <TT>EditItemIndex</TT> of the <TT>DataGrid</TT> object to the selected item and then binds the data.</P>
<H5 class="docExampleTitle">Listing 8.34 <TT>frmHowTo8_6.aspx</TT>: Telling the DataGrid Object to Use the Selected Item and Go into Edit Mode (Display Wise)</H5>
<PRE>
Sub dgLookupData_Edit(ByVal sender As Object, _
                ByVal e As DataGridCommandEventArgs)

        '-- The data grid does most of the work; just set the EditItemIndex
        '   to the ItemIndex and bind the grid again.

        Me.txtError.Text = ""

        dgLookupData.EditItemIndex = e.Item.ItemIndex

        BindTheGrid()

End Sub
</PRE></span></LI><LI><span style="font-weight:normal" value="8"><P>Add the code in Listing 8.35 to the <TT>Click</TT> event of btnAdd. Notice that the first task invokes the <TT>BeginLoadData</TT> method for <TT>mdtLookupData</TT>. This turns off the schema checking that will occur when adding the new row to the <TT>DataTable</TT> object. You need to turn this off because you don't want to have it check for required fields until you actually edit the record. The editing of the record is started by the line of code setting the EditItemIndex property of the <TT>DataGrid</TT> object.</P>
<P>The <TT>GetPageNum()</TT> routine helps to synchronize the DataGrid page with the position the pointer is in the <TT>DataTable</TT> object. If you add a record, you have to know whether to have it be on the current page or on a new page in the data grid. You can see <TT>GetPageNum</TT> after <TT>btnAdd_Click</TT> in Listing 8.35.</P>
<P><TT>GetPageRows()</TT>, found at the bottom of Listing 8.35, returns the number of actual rows based on the page in the data grid.</P>
<div class="docNote"><p class="docNoteTitle">Note</p>
<p><table border="0" align="center" cellpadding="6" cellspacing="0"><tr>
<td width="60" valign="top"><IMG BORDER="0" ALIGN="LEFT" WIDTH="100" HEIGHT="100" src="FILES/note_icon.gif" ALT="graphics/note_icon.gif"></td>
<td valign="top"><P><TT>GetPageRows()</TT> returns the current page number (<TT>dgLookupData.CurrentPageIndex</TT>) times the page size (<TT>dgLookupData.PageSize</TT>). In this case, <TT>GetPageRows()</TT> returns 5, as set in step 1. If <TT>EditItemIndex</TT> were used alone, it would return only the position of the item that was being edited for the current page.</P>
</td>
</tr></table></p>
</div>
<P>Last, the <TT>EditItemIndex</TT> of <TT>dgLookupData</TT> is set. The data grid is bound to the data table using the <TT>BindTheGrid</TT> routine.</P>
<H5 class="docExampleTitle">Listing 8.35 <TT>frmHowTo8_6.aspx</TT>: Adding a Record to the Data Table and Having the Data Grid Reflect It</H5>
<PRE>
Private Sub btnAdd_Click(ByVal sender As System.Object, _
                        ByVal e As System.EventArgs) Handles btnAdd.Click

        Dim intColCnt As Integer
        Dim drCurr As data row

        Me.txtError.Text = ""
        mdtLookupData.BeginLoadData()

        '-- Add the row to the data table via the data row
        drCurr = mdtLookupData.NewRow
        mdtLookupData.Rows.Add(drCurr)

        '-- Set the Adding flag.
        Session("MyLookupData") = mdtLookupData
        Session("IsAdding") = True

        '-- Set the current page based on the new number of rows
        dgLookupData.CurrentPageIndex = GetPageNum(mdtLookupData)

        '-- Set the item index based on the rows on this page only.
        dgLookupData.EditItemIndex = mdtLookupData.Rows.Count - _
                  GetPageRows() - 1

        BindTheGrid()

    End Sub

Function GetPageRows() As Integer

        '-- This helps synchronize the data table rows
        '  with the DataGrid page and row.

        GetPageRows = dgLookupData.PageSize * dgLookupData.CurrentPageIndex

    End Function

    Function GetPageNum(ByVal dt As data table) As Decimal

        Dim decTemp As Decimal

        '-- Calculate the number of pages
        decTemp = ((dt.Rows.Count - 1) / dgLookupData.PageSize)

        GetPageNum = decTemp.Truncate(decTemp)

    End Function
</PRE></span></LI><LI><span style="font-weight:normal" value="9"><P>Add the code shown in Listing 8.36 to the Cancel command of <TT>dgLookupData</TT>. This is one of the events specified in step 4. If the code is in the middle of adding an entry, it uses the <TT>EditItemIndex</TT> of the <TT>DataGrid</TT> object to the selected item and adds this to the value returned by <TT>GetPageRows()</TT>, shown just after the <TT>dgLookupData_Cancel</TT> subroutine.</P>
<P>The value that <TT>EditItemIndex</TT> and <TT>GetPagerows()</TT> returns is used to position the pointer in mdtLookupData so that the <TT>Delete</TT> method can be called.</P>
<P>After accepting the changes, the session variables are resaved. Then the page index for the <TT>DataGrid</TT> object is cleaned up by comparing the current page number relative to the pointer of the data table position to the <TT>CurrentPageIndex</TT> property. Regardless of whether the item is being added or edited, the <TT>EditItemIndex</TT> is cleared by setting it to -1. The data grid is bound again by calling <TT>BindTheData()</TT>.</P>
<H5 class="docExampleTitle">Listing 8.36 <TT>frmHowTo8_6.aspx</TT>: Canceling Editing/Adding a Record in the DataGrid Object</H5>
<PRE>
Sub dgLookupData_Cancel(ByVal sender As Object,
                        ByVal e As DataGridCommandEventArgs)

    Dim blnAdding As Boolean

    '-- If you're canceling while adding a record, you need to back the
    '   row out of the data table and data grid.
    '  You don't have to send it to the
    '   server because it really was never added to it.

    Me.txtError.Text = ""

    If CType(Session("IsAdding"), Boolean) Then

       mdtLookupData.Rows(dgLookupData.EditItemIndex + _
      GetPageRows()).Delete()
       mdtLookupData.AcceptChanges()

       Session("IsAdding") = False
       Session("MyLookupData") = mdtLookupData

       '-- Reset the paging if it has been affected
       If GetPageNum(mdtLookupData) &lt; dgLookupData.CurrentPageIndex Then
           dgLookupData.CurrentPageIndex -= 1
       End If

   End If

   dgLookupData.EditItemIndex = -1

   BindTheGrid()

End Sub
</PRE></span></LI><LI><span style="font-weight:normal" value="10"><P>Add the code in Listing 8.37 for the <TT>Delete</TT> command of dgLookupData. This is one of the events specified in step 4. This code is a lot like the code in the previous step when the record was added. The big difference in this step's code listing is that the deletion is posted back to the server, and in the previous step, it wasn't. It wasn't posted back to the server in the previous step because the server never knew anything about the record. The record had only been added to the data table and was not sent back to the server. You can see that in the next step.</P>
<P>Another item to note is the <TT>RejectChanges</TT> method called in the <TT>Catch</TT> of the exception handling code. If an error occurs, the change is undone, the message is noted, and life goes on. The rest of this code pretty closely follows what was done in the previous step.</P>
<H5 class="docExampleTitle">Listing 8.37 <TT>frmHowTo8_6.aspx</TT>: Deleting a Record from the Data Grid and Posting It Back to the Server</H5>
<PRE>
   Sub dgLookupData_Delete(ByVal sender As Object, _
                          ByVal e As DataGridCommandEventArgs)

        Dim intColCnt As Integer
        Dim cnn As New OleDb.OleDbConnection(BuildCnnStr("(local)", _
                   "Northwind"))

        '-- Create the command builder to update (post) the data
        '  in the data grid
        '   back to the server.

        Dim odaTableData As OleDb.OleDbDataAdapter

        Me.txtError.Text = ""

        Try

            '-- Take the txtSQLString text and create a data table. Then set the
            '   data source of the data grid.

            odaTableData = New OleDb.OleDbDataAdapter("Select * From " &amp; _
                            Me.lstLookupTables.SelectedItem.ToString, cnn)

            Dim ocbTableData As OleDb.OleDbCommandBuilder = _
                                    New OleDb.OleDbCommandBuilder(odaTableData)

            '-- Delete the row from the data table.
            mdtLookupData.Rows(e.Item.ItemIndex + GetPageRows()).Delete()

            '-- Commands are necessary to actually post back to the server.
            cnn.Open()

            odaTableData.Update(mdtLookupData)
            mdtLookupData.AcceptChanges()

            cnn.Close()

            Session("MyLookupData") = mdtLookupData
            Session("IsAdding") = False

            '-- This is just in case they were editing and press Delete, Clear.
            dgLookupData.EditItemIndex = -1

            '-- Adjust the page according to the number of rows.
            If GetPageNum(mdtLookupData) &lt; dgLookupData.CurrentPageIndex Then
                dgLookupData.CurrentPageIndex -= 1
            End If

        Catch excp As Exception

            Me.txtError.Text = excp.Message
            mdtLookupData.RejectChanges()

        End Try

        BindTheGrid()

End Sub
</PRE></span></LI><LI><span style="font-weight:normal" value="11"><P>Add the code in Listing 8.38 for the <TT>Update</TT> command of <TT>dgLookupData</TT>. This is one of the events specified in step 4. This routine starts off by declaring <TT>DataAdapter</TT> and <TT>CommandBuilder</TT> objects to update your data back to the server. Before the actual update, however, the current row that is being edited in the data grid is assigned to a <TT>DataRow</TT> object. Then each of the items in the row is saved from the data grid cells to the column in the data row.</P>
<P>Thanks to using the <TT>FillSchema</TT> method when filling the data table, the <TT>AutoIncrement</TT> property will reflect whether a column was an Identity column. If the <TT>FillSchema</TT> method were not used, you would have to handle the exception that would occur when you tried to write the value to the column.</P>
<P>When writing the cells into the columns in the data row, the <TT>Trim</TT> function is used; because of using the <TT>FillSchema</TT> method, the values are padded out as SQL Server columns generally are.</P>
<P>The rest of the code pretty well runs like it does in step 9. The changes are accepted, written back to the server, and so forth.</P>
<H5 class="docExampleTitle">Listing 8.38 <TT>frmHowTo8_6.aspx</TT>: Deleting a Record from the Data Grid and Posting It Back to the Server</H5>
<PRE>
   Sub dgLookupData_Update(ByVal sender As Object, _
                   ByVal e As DataGridCommandEventArgs)

        Dim intColCnt As Integer
        Dim intColCurr As Integer
        Dim drCurr As DataRow
        Dim cnn As New OleDb.OleDbConnection(BuildCnnStr("(local)", _
                           "Northwind"))
        Dim blnAdding As Boolean
        Dim strCurrValue As String

        '-- Create the command builder to update (post) the data
        '  in the data grid
        '   back to the server.

        Dim odaTableData As OleDb.OleDbDataAdapter

        Me.txtError.Text = ""

        Try

            '-- Take the txtSQLString text and create a data table. Then set the
            '   data source of the data grid.
            odaTableData = New OleDb.OleDbDataAdapter("Select * From " &amp; _
                            Me.lstLookupTables.SelectedItem.ToString, cnn)

            Dim ocbTableData As OleDb.OleDbCommandBuilder = _
                                    New OleDb.OleDbCommandBuilder(odaTableData)

            drCurr = mdtLookupData.Rows(dgLookupData.EditItemIndex + _
                          GetPageRows())

            '-- Update the fields in the rows.
            intColCnt = e.Item.Cells.Count

            For intColCurr = 2 To intColCnt - 1

                If mdtLookupData.Columns(intColCurr - 2).AutoIncrement = _
                          False Then

                    drCurr.Item(intColCurr - 2) = _
                            Trim(CType(e.Item.Cells(intColCurr).Controls(0), _
                          TextBox).Text)

                End If

            Next

            '-- Commands are necessary to actually post back to the server.
            cnn.Open()

            odaTableData.Update(mdtLookupData)
            mdtLookupData.AcceptChanges()

            cnn.Close()

            Session("MyLookupData") = mdtLookupData
            Session("IsAdding") = False

            dgLookupData.EditItemIndex = -1
            BindTheGrid()

        Catch excp As Exception

            Me.txtError.Text = excp.Message

        End Try

End Sub
</PRE></span></LI><LI><span style="font-weight:normal" value="12"><P>Add the code in Listing 8.39 for the <TT>PageIndexChanged</TT> command of <TT>dgLookupData</TT>. This code simply sets the <TT>CurrentPageIndex</TT> property of the data grid to the page that is chosen. The code then calls <TT>BindTheGrid()</TT>.</P></span></LI></OL></span>
<H5 class="docExampleTitle">Listing 8.39 <TT>frmHowTo8_6.aspx</TT>: Updating the Data Grid Page Index</H5>
<PRE>
Private Sub dgLookupData_PageIndexChanged(ByVal source As Object,
  ByVal e As System.Web.UI.WebControls.DataGridPageChangedEventArgs)
  Handles dgLookupData.PageIndexChanged

    '-- Set the current page in the data grid.
    Me.dgLookupData.CurrentPageIndex = e.NewPageIndex

    BindTheGrid()

End Sub
</PRE>
<H4 class="docSection2Title"> How It Works</H4>
<P>When the form opens, the user clicks on an entry in the Lookup Table to Edit list box. When this occurs and when a user selects a new item in the list, a Select statement is generated and loaded into a data adapter, which fills a data table. This, in turn, is used for the data source of the data grid, and the <TT>DataBind</TT> method is called. The data is then displayed.</P>
<P>If the user clicks on the Edit button, the controls in the data grid are put into Edit mode. If the user clicks the Add button, a data row is added to the data table, and the data grid reflects this, including handling the paging of row locations.</P>
<P>When the user clicks the button with the caption Update, a <TT>CommandBuilder</TT> object is generated off the <TT>DataAdapter</TT> object. The <TT>Update</TT> command for the data adapter is then invoked, with the <TT>Update</TT> method called. The data table is then referenced from the data source of the data grid control, and the <TT>AcceptChanges</TT> method is called. If the user clicks Cancel, then the changes are ignored if a record is being edited, but the data row is deleted if the record was in the middle of being added.</P>
<P>When the user clicks Delete, the <TT>DataAdapter</TT> and <TT>CommandBuilder</TT> objects are created to remove the data row from the data table and reflect the changes back to the server. The data grid is also re-bound to the data table, and the paging is adjusted.</P>
<H4 class="docSection2Title"> Comments</H4>
<P>Whew, this was a long one. The good news is that the code is already created for you with the book. Remember, though, as with other techniques and examples, this is a starting point for you to run with and expand on. This example doesn't provide all the error trapping that is necessary, but it definitely gives a good start.</P>
<P>Before spending too much time enhancing this example, make sure you get the performance out of it, just as you should when trying different data-driven techniques.</P>
<ul></ul>
</body></html>
