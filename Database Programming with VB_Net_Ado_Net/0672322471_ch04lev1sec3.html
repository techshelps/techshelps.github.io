<html><head>
<META http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
<!--SafClassName="docSection1Title"--><!--SafTocEntry="4.3 Execute Parameterized Stored Procedures in ADO.NET"-->
<link rel="STYLESHEET" type="text/css" href="FILES/style.css">
<link rel="STYLESHEET" type="text/css" href="FILES/docsafari.css">
<style type="text/css">	.tt1    {font-size: 10pt;}</style>
</head>
<body><H3 class="docSection1Title">4.3 Execute Parameterized Stored Procedures in ADO.NET</H3>
<P>To take advantage of stored procedures to their full power, you need to be able to pass parameters so that specific criteria can be used. This How-To describes how to create parameters off the <TT>OleDbCommand</TT> objects to pass parameters to SQL Server.</P>
<P>You need to execute a parameterized stored procedure in your application. How do you do this using Visual Basic .NET and ADO.NET?</P>
<H4 class="docSection2Title"> Technique</H4>
<P>In ADO, you have a <TT>Command</TT> object to execute stored procedures, among other tasks. In ADO.NET, you also have a <TT>Command</TT> object that performs basically the same task. In fact, many of the properties and methods that you use are the same. You can see a list of those in Table 4.4.</P>
<P><TABLE BORDER="1" align="center" CELLPADDING="6" CELLSPACING="0">
<CAPTION><h5 class="docTableTitle">Table 4.4. Objects That Are Used for This Technique, with Properties and Methods</h5></CAPTION><COLGROUP span="3">
<TR>
<TH class="docTableHeader" align="left" valign="top">
<P>Object</P>
</TH>
<TH class="docTableHeader" align="left" valign="top">
<P>Property</P>
</TH>
<TH class="docTableHeader" align="left" valign="top">
<P>Description/Method</P>
</TH>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>Connection</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>ConnectionString</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P>Contains the connection string that is used.</P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>Connection</TT> </P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Open</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P>Opens the connection that the <TT>Command</TT> object uses.</P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>Command</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>cmdText</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P>Specifies the SQL statement to use. Can be SQL statement or names of objects such as tables or stored procedures.</P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>Command</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Connection</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P>Uses the <TT>Connection</TT> object.</P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>Command</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>CommandType</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P>Specifies the type of command you want to execute. Can be one of the following command types: <TT>StoredProcedure</TT>, <TT>DirectTable</TT>, or <TT>Text</TT>.</P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>Command</TT> </P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Parameters</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P>Parameters to pass to the stored procedure.</P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>Command</TT> </P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>ExecuteReader</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P>Creates a <TT>DataReader</TT> object with the data that the command object specifies.</P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>DataReader</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Read</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P>Reads the next record in the <TT>DataReader</TT>, and also tests the end of the data returned.</P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>DataReader</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>GetString</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P>Returns the current record, getting the column specified, and returns it as string.</P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>DataReader</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>GetInt32</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P>Returns the current record, getting the column specified, and returns it as 32-bit integer.</P>
</TD>
</TR>
</COLGROUP>
</TABLE></P>
<P>You will use these objects and their properties and methods for the following steps.</P>
<H4 class="docSection2Title"> Steps</H4>
<P>Open and run the VB.NET-Chapter 4 solution. From the main form, click on the command button with the caption How-To 4.3. When the form loads, click on the View button to display the orders for the customer ID that is specified. By default, this is ALKI. A <TT>TextBox</TT> control is then displayed on the bottom of the form. You can see the form in Figure 4.2.</P>



<span style="font-weight:bold"><OL class="docList" START="1">
<LI><span style="font-weight:normal" value="1"><P>Create a new Windows Form.</P></span></LI><LI><span style="font-weight:normal" value="2"><P>Add the following controls, setting the properties as listed in Table 4.5.</P>
<P><TABLE BORDER="1" align="center" CELLPADDING="6" CELLSPACING="0">
<CAPTION><h5 class="docTableTitle">Table 4.5. Controls Property Settings</h5></CAPTION><COLGROUP span="3">
<TR>
<TH class="docTableHeader" align="left" valign="top">
<P>Object</P>
</TH>
<TH class="docTableHeader" align="left" valign="top">
<P>Property</P>
</TH>
<TH class="docTableHeader" align="left" valign="top">
<P>Setting</P>
</TH>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>Label</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Name</TT></P>
<P><TT>Caption</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Label1</TT></P>
<P><TT>Products and Quantities Ordered By:</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>TextBox</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Name</TT></P>
<P><TT>Text</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>txtCustID</TT></P>
<P><TT>ALFKI</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>Button</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Name</TT></P>
<P><TT>Text</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>btnView</TT></P>
<P><TT>&amp;View</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>TextBox</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Name</TT></P>
<P><TT>MultiLine</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>txtResults</TT></P>
<P><TT>True</TT></P>
</TD>
</TR>
</COLGROUP>
</TABLE></P></span></LI><LI><span style="font-weight:normal" value="2"><P>Enter the following code to the <TT>Click</TT> event <TT>btnView</TT>. This code takes the connection and creates the command object. The name of the stored procedure is passed, and the command type is specified, which is <TT>CommandType</TT>.<TT>StoredProcedure</TT>. Next, parameters and the <TT>DataReader</TT> are created. The last task is to iterate through the data and add it to the display text box.</P>
<pre>
Private Sub btnView_Click(ByVal sender As System.Object, _
                ByVal e As System.EventArgs) Handles btnView.Click

        Dim ocnn As New OleDb.OleDbConnection(BuildCnnStr("(local)",
                              "Northwind"))
        Dim ocmdCustHist As New OleDb.OleDbCommand("CustOrderHist", ocnn)
        Dim odrCustHist As OleDb.OleDbDataReader

        Try
            '-- Specify the name of the stored procedure
            ocmdCustHist.CommandType = CommandType.StoredProcedure

            '-- Specify the parameters.
            ocmdCustHist.Parameters.Add("@CustomerID", Me.txtCustID.Text)

            '-- Open the connection object.
            ocnn.Open()

            '-- Establish the DataRead object.
            odrCustHist = _
                   ocmdCustHist.ExecuteReader(CommandBehavior.SequentialAccess)

            '-- Iterate through the data loaded, building the results string.
            Do While odrCustHist.Read
                Me.txtResults.Text &amp;= odrCustHist.GetString(0) &amp; _
                             ", " &amp; odrCustHist.GetInt32(1) &amp; vbCrLf
            Loop

        Catch excpData As Exception
            MessageBox.Show("Error Occurred: " &amp; excpData.Message)

        End Try
    End Sub
</pre></span></LI></OL></span>
<CENTER><H5 class="docFigureTitle">Figure 4.2. This form uses the <TT>Command</TT> object with a stored procedure to populate the <TT>TextBox</TT> control.</H5><p><IMG BORDER="0" WIDTH="478" HEIGHT="298" src="FILES/04fig02.jpg" ALT="graphics/04fig02.jpg"></p>
</CENTER>
<H4 class="docSection2Title"> How It Works</H4>
<P>When the user clicks on the View button with Customer ID filled in, the text box below is filled in, displaying order information for that customer.</P>
<H4 class="docSection2Title"> Comments</H4>
<P>Using the technique presented here, you can pretty well perform the majority of the tasks you need to by using Command objects and stored procedures.</P>
<img src="FILES/pixel.gif" width="1" height="1" border="0"><ul></ul>
</body></html>
