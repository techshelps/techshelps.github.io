<html><head>
<META http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
<!--SafClassName="docSection1Title"--><!--SafTocEntry="12.4 Retrieve XML from SQL Server 2000"-->
<link rel="STYLESHEET" type="text/css" href="FILES/style.css">
<link rel="STYLESHEET" type="text/css" href="FILES/docsafari.css">
<style type="text/css">	.tt1    {font-size: 10pt;}</style>
</head>
<body><H3 class="docSection1Title">12.4 Retrieve XML from SQL Server 2000</H3>
<P>Sometimes I have to pull data from my SQL Server database into an XML document format. How do I do that with SQL Server 2000?</P>
<H4 class="docSection2Title"> Technique</H4>
<P>To accomplish this task, you will create a <TT>Command</TT> object with the Transact-SQL SELECT statement that you want to execute. However, at the end of your SQL statement, you will add the clause FOR XML <span class="docEmphasis">mode</span>. The mode can be any of these that are listed:</P>
<UL>
<LI><p>
<span class="docEmphRoman">RAW.</span> 
With this mode, each of the rows that is returned in the query result is made into a generic XML element with &lt;row /&gt; as the identifier tag.</p>
</LI>
<LI><p>
<span class="docEmphRoman">AUTO.</span> 
Each of the rows and the columns are identified with tags for each of the elements and attributes, using the column names as identifier tags.</p>
</LI>
<LI><p>
<span class="docEmphRoman">EXPLICIT.</span> 
Here, you have to nest and create your query in a particular way. For more information on this mode, check out the SQL Server Books Online.</p>
</LI>
</UL>
<P>For this example, the code will use the RAW mode and look like this:</P>
<pre>
SELECT * FROM Customers FOR XML RAW
</pre>
<P>To execute the SQL statement in this case, you use the method ExecuteXMLReader. When you use this method, an XMLReader is returned. You should then iterate through the elements as seen in How-To 12.2.</P>
<H4 class="docSection2Title"> Steps</H4>
<P>Open and run the Visual Basic .NET-Chapter 12 solution. From the main Web page, click on the hyperlink with the caption How-To 12.4: Retrieving XML from SQL Server 2000. When the page loads, you will see an example of a T-SQL statement that retrieves data from SQL Server 2000 in an XML format. Click on the button labeled Retrieve XML, and the data will be listed in the TextArea at the bottom of the form (see Figure 12.4).</P>


<span style="font-weight:bold"><OL class="docList" START="1">
<LI><span style="font-weight:normal" value="1"><P>Create a Web Form. Then place the Label, TextBox, and Button objects as seen in Figure 12.4 on the form with the properties in Table 12.8 set.</P>
<P><TABLE BORDER="1" align="center" CELLPADDING="6" CELLSPACING="0">
<CAPTION><h5 class="docTableTitle">Table 12.8. Label, TextBox, and Button Control Property Settings</h5></CAPTION><COLGROUP span="3">
<TR>
<TH class="docTableHeader" align="left" valign="top">
<P><TT>Object</TT></P>
</TH>
<TH class="docTableHeader" align="left" valign="top">
<P><TT>Property</TT></P>
</TH>
<TH class="docTableHeader" align="left" valign="top">
<P><TT>Setting</TT></P>
</TH>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>Label</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Text</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>SQL To Execute</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>TextBox</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><PRE><TT>ID</TT></PRE></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>txtSQLToExecute</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">&nbsp;</TD>
<TD class="docTableCell" valign="top">
<P><TT>Text</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>SELECT * FROM Customers FOR XML AUTO, ELEMENTS</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>Button</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><PRE><TT>ID</TT></PRE></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>btnRetrieveXML</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">&nbsp;</TD>
<TD class="docTableCell" valign="top">
<P><TT>Text</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Retrieve XML</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>TextArea</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><PRE><TT>ID</TT></PRE></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>taOutput</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>HyperLink</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><PRE><TT>ID</TT></PRE></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>hplReturnToMain</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">&nbsp;</TD>
<TD class="docTableCell" valign="top">
<P><TT>NavigateURL</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>wfrmMain.aspx</TT></P>
</TD>
</TR>
</COLGROUP>
</TABLE></P></span></LI><LI><span style="font-weight:normal" value="2"><P>Add the code in Listing 12.10 to the Click event of btnRetrieveXML. Taking the SQL statement displayed in the "Technique" section, the <TT>Command</TT> object <TT>cmdCust</TT> is created, and <TT>ExecuteXMLReader</TT> is invoked. The XMLReader then iterates through each of the elements in the document, and they concatenate to a string. Last, the string is assigned to the <TT>InnerText</TT> property of taOutput, and the connection to the <TT>XMLReader</TT> object is closed.</P>
<H5 class="docExampleTitle">Listing 12.10 <TT>wfrmHowTo12_4.aspx.vb</TT>: Reading an XML Document Using XMLTextReader</H5>
<PRE>
    Private Sub btnRetrieveXML_Click(ByVal sender As System.Object, _
        ByVal e As System.EventArgs) Handles btnRetrieveXML.Click

        Dim cnn As New SqlClient.SqlConnection(BuildCnnStr("(local)", "Northwind"))

        Dim cmdCust As SqlClient.SqlCommand = New SqlClient.SqlCommand( _
                                Me.txtSQLToExecute.Text, cnn)
        Dim xrCust As System.Xml.XmlReader
        Dim intAtts As Int32
        Dim intCurrAtt As Int32
        Dim strOut As String

        Try
            cnn.Open()
            xrCust = cmdCust.ExecuteXmlReader()

            While xrCust.Read()

                intAtts = xrCust.AttributeCount
                If xrCust.NodeType &lt;&gt; System.Xml.XmlNodeType.XmlDeclaration Then
                    If intAtts &gt; 0 Then
                        For intCurrAtt = 0 To intAtts - 1
                            strOut &amp;= xrCust(intCurrAtt) &amp; vbCrLf
                        Next
                    Else
                        strOut &amp;= xrCust.Value &amp; vbCrLf
                    End If
                End If
            End While

        Catch excp As Exception

            strOut &amp;= "Following Error Occurred: " &amp; excp.Message

        Finally

            strOut &amp;= vbCrLf &amp; "Done Processing "
            taOutput.InnerText = strOut

            If Not xrCust Is Nothing Then
                xrCust.Close()
            End If
            cnn.Close()

        End Try

End Sub
</PRE>
<div class="docNote"><p class="docNoteTitle">Note</p>
<p><table border="0" align="center" cellpadding="6" cellspacing="0"><tr>
<td width="60" valign="top"><IMG BORDER="0" ALIGN="LEFT" WIDTH="100" HEIGHT="100" src="FILES/note_icon.gif" ALT="graphics/note_icon.gif"></td>
<td valign="top"><P>You have been using the <TT>BuildCnnStr()</TT> function throughout this book. You should add this function to a module or copy it from other chapters. Here is the code for the function:</P>
<P><br>Function&nbsp;BuildCnnStr(ByVal&nbsp;strServer&nbsp;As&nbsp;String,<br>ByVal&nbsp;strDatabase&nbsp;As&nbsp;String)&nbsp;As&nbsp;String<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Dim&nbsp;strTemp&nbsp;As&nbsp;String<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;strTemp&nbsp;=&nbsp;"Data&nbsp;Source="&nbsp;&amp;&nbsp;strServer&nbsp;&amp;&nbsp;";"<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;strTemp&nbsp;&amp;=&nbsp;"Initial&nbsp;Catalog="&nbsp;&amp;&nbsp;strDatabase&nbsp;&amp;&nbsp;";"<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;strTemp&nbsp;&amp;=&nbsp;"Integrated&nbsp;Security=SSPI"<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Return&nbsp;strTemp<br>End&nbsp;Function<br></P></td>
</tr></table></p>
</div></span></LI></OL></span>
<CENTER><H5 class="docFigureTitle">Figure 12.4. The information displayed here was read from SQL Server in an XML format.</H5><p><IMG BORDER="0" WIDTH="500" HEIGHT="375" src="FILES/12fig04.jpg" ALT="graphics/12fig04.jpg"></p>
</CENTER>
<H4 class="docSection2Title"> Comments</H4>
<P>Normally, you would be taking the XML document that the command object returned and passing that on to another system that requires the data to be in XML format. The data was displayed from the XMLReader for demonstration purposes.</P>
<img src="FILES/pixel.gif" width="1" height="1" border="0"><ul></ul>
</body></html>
