<html><head>
<META http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
<!--SafClassName="docSection1Title"--><!--SafTocEntry="6.7 Create a New Table with Data from Existing Tables"-->
<link rel="STYLESHEET" type="text/css" href="FILES/style.css">
<link rel="STYLESHEET" type="text/css" href="FILES/docsafari.css">
<style type="text/css">	.tt1    {font-size: 10pt;}</style>
</head>
<body><H3 class="docSection1Title">6.7 Create a New Table with Data from Existing Tables</H3>
<P>I often need to create new tables from existing data. If the table already exists, I need to delete the old table first. How do I do this using T-SQL?</P>
<H4 class="docSection2Title"> Technique</H4>
<P>To perform these tasks, you will create two T-SQL statements and use them in one <TT>Command</TT> object. Here are the two statements that will be used:</P>
<pre>
IF EXISTS (SELECT * FROM sysobjects
        WHERE id = object_id(N'[Northwind].[dbo].[MyProdAndCat]'))
        DROP TABLE [Northwind].[dbo].[MyProdAndCat]

SELECT Categories.CategoryName, Products.ProductName INTO MyProdAndCat
       FROM Categories INNER JOIN ProductsON Categories.CategoryID =
       Products.CategoryID"
</pre>
<P>The first statement checks for the existence of the particular table you will be creating, in this case MyProdAndCat. This statement demonstrates a couple of techniques that you can use in T-SQL:</P>
<UL>
<LI><P>Using the <TT>EXIST</TT> statement with a <TT>SELECT</TT> statement, querying the system table called sysobjects</P></LI>
<LI><P>Using an IF statement to conditionally execute another command, in this case the <TT>DROP TABLE</TT> statement</P></LI>
</UL>
<div class="docNote"><p class="docNoteTitle">Tip</p>
<p><table border="0" align="center" cellpadding="6" cellspacing="0"><tr>
<td width="60" valign="top"><IMG BORDER="0" ALIGN="LEFT" WIDTH="100" HEIGHT="100" src="FILES/tip_icon.gif" ALT="graphics/tip_icon.gif"></td>
<td valign="top"><P>Now that you have learned this technique, you will want to use it repeatedly. Make sure you mark this page!</P>
</td>
</tr></table><p></p>
</div><br>
<P>The last statement uses an inner join to join two tables displaying the CategoryName and ProductName. The clause that creates the new table is this:</P>
<pre>
INTO MyProdAndCat
</pre>
<P>This tells SQL Server to create a new table called <TT>MyProdAndCat</TT> from the <TT>SELECT</TT> statement that is specified.</P>
<H4 class="docSection2Title"> Steps</H4>
<P>Open and run the Visual Basic .NET-Chapter 6 solution. From the main form, click on the button with the caption How-To 6.7. You will see the SQL string specified in the "Technique" section displayed in a label. If you click the Execute button, the new table is generated a <TT>SELECT</TT> statement is executed, and the results are displayed in the DataGrid object (see Figure 6.8).</P>



<span style="font-weight:bold"><OL class="docList" START="1">
<LI><span style="font-weight:normal" value="1"><P>Create a Windows Form. Then place the controls listed in Table 6.7 with the following properties set, as displayed in Figure 6.8.</P>
<P><TABLE BORDER="1" align="center" CELLPADDING="6" CELLSPACING="0">
<CAPTION><h5 class="docTableTitle">Table 6.7. Control Property Settings for This How-To</h5></CAPTION><COLGROUP span="3">
<TR>
<TH class="docTableHeader" align="left" valign="top">
<P>Object</P>
</TH>
<TH class="docTableHeader" align="left" valign="top">
<P>Property</P>
</TH>
<TH class="docTableHeader" align="left" valign="top">
<P>Setting</P>
</TH>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>Label</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Text</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>SQL Statement</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>Label</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Name</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>lblSQLString</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>Label</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Text</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Results</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P>Button</P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Name</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>btnExecute</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">&nbsp;</TD>
<TD class="docTableCell" valign="top">
<P><TT>Text</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Execute</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>DataGrid</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Name</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>dgResults</TT></P>
</TD>
</TR>

</TABLE><p></P></span></LI><LI><span style="font-weight:normal" value="2"><P>Add the code in Listing 6.16 to the Load event of the form. (Double-click on the form to bring up the code.)</P>
<H5 class="docExampleTitle">Listing 6.16 <TT>frmHowTo6_7.vb</TT>: Storing the SQL Statement in the <TT>lblSQLString</TT> Label to Display and Use Later</H5>
<PRE>
Private Sub frmHowTo6_7_Load(ByVal sender As System.Object, _
                ByVal e As System.EventArgs) Handles MyBase.Load

    '-- Build the SQL String that returns cities that
'    have more than one customer in them.
    Dim strSQL As String
    strSQL = "IF EXISTS (SELECT * from sysobjects " &amp; vbCrLf
    strSQL &amp;= "  WHERE id = object_id(N'[Northwind].[dbo].[MyProdAndCat]'))" &amp; _
vbCrLf
    strSQL &amp;= "  DROP Table [Northwind].[dbo].[MyProdAndCat]" &amp; _
vbCrLf &amp; vbCrLf
    strSQL &amp;= "SELECT Categories.CategoryName, Products.ProductName" &amp; vbCrLf
    strSQL &amp;= "INTO MyProdAndCat" &amp; vbCrLf
    strSQL &amp;= "FROM Categories INNER JOIN Products" &amp; vbCrLf
    strSQL &amp;= "ON Categories.CategoryID = Products.CategoryID"
    Me.lblSQLString.Text = strSQL

End Sub
</PRE></span></LI><LI><span style="font-weight:normal" value="2"><P>Add the following code in Listing 6.17 to the <TT>Click</TT> event of btnExecute. This code creates <TT>Connection</TT> and <TT>Command</TT> objects by using the T-SQL routine discussed in the "Technique" section. Then the code executes the query. Next, a <TT>select</TT> query is run against the new table, and the <TT>DataSource</TT> property is set to the data table that was filled.</P>
<H5 class="docExampleTitle">Listing 6.17 <TT>frmHowTo6_7.vb</TT>: Loading the Form</H5>
<PRE>
Private Sub btnExecute_Click(ByVal sender As System.Object,
                ByVal e As System.EventArgs) Handles btnExecute.Click
        Dim dtResults As New DataTable()
        Try
            Dim ocnn As New OleDb.OleDbConnection(BuildCnnStr("(local)", _
                  "Northwind"))
            Dim ocmd As New OleDb.OleDbCommand(Me.lblSQLString.Text)
            ocmd.Connection = ocnn
            ocnn.Open()
            ocmd.ExecuteNonQuery()
            ocnn.Close()

            '-- Use the SQL String to build the data adapter
    '    and fill the data table.
            Dim odaResults As _
           New OleDb.OleDbDataAdapter("Select * From MyProdAndCat",
               BuildCnnStr("(local)", "Northwind"))

            odaResults.Fill(dtResults)

        Catch excp As Exception
            MessageBox.Show(excp.Message)
            Exit Sub
        End Try

        '-- Assign the data table to the data grid's DataSource property
        Me.dgResults.DataSource = dtResults

End Sub
</PRE></span></LI></OL></span>
<CENTER><H5 class="docFigureTitle">Figure 6.8. These results are based on a new table created by the SQL string that is displayed.</H5><p><IMG BORDER="0" WIDTH="500" HEIGHT="359" src="FILES/06fig08.jpg" ALT="graphics/06fig08.jpg"></p>
</CENTER>
<H4 class="docSection2Title"> Comments</H4>
<P>You will probably want to go ahead and drop the new table after you are finished using it if you don't need to keep it around for any other purposes.</P>
<ul></ul>
</body></html>
