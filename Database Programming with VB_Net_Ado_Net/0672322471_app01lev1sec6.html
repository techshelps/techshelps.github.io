<html><head>
<META http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
<!--SafClassName="docSection1Title"--><!--SafTocEntry="Executing a SQL Server Stored Procedure By Using ActiveX Data Objects"-->
<link rel="STYLESHEET" type="text/css" href="FILES/style.css">
<link rel="STYLESHEET" type="text/css" href="FILES/docsafari.css">
<style type="text/css">	.tt1    {font-size: 10pt;}</style>
</head>
<body><H3 class="docSection1Title"> Executing a SQL Server Stored Procedure By Using ActiveX Data Objects</H3>
<P>If you are doing an ADO development with client server for backends, then you probably call stored procedures. In doing so, you will use the ADO <TT>Command</TT> object, as well as the <TT>Parameter</TT> object if you are passing parameters.</P>
<P>You will create a <TT>Command</TT> object and supply the command text, which in this case will be the name of the stored procedure, called <TT>CustOrdersHist</TT>. You can see the T-SQL for <TT>CustOrderHist</TT> in Listing A.7. This stored procedure returns product names and the total quantity purchased of those products for a given customer.</P>
<H5 class="docExampleTitle">Listing A.7 Northwind SQL Server Database: T-SQL for the Stored Procedure Called <TT>CustOrdersHist</TT></H5>
<PRE>
ALTER PROCEDURE CustOrderHist @CustomerID nchar(5)
AS
SELECT ProductName, Total=SUM(Quantity)
FROM Products P, [Order Details] OD, Orders O, Customers C
WHERE C.CustomerID = @CustomerID
AND C.CustomerID = O.CustomerID AND O.OrderID = OD.OrderID AND _
        OD.ProductID = P.ProductID
GROUP BY ProductName
</PRE>
<P>You will then specify the type of Command object you are creating-in this case by using the type of <TT>ADODB.CommandTypeEnum.adCmdStoredProc</TT>.</P>
<P>The next step is to create a parameter that the Command object will use. This parameter will match the one specified in <TT>CustOrdersHist</TT>, called <TT>CustomerID</TT>. You can see the actual code for this routine, called <TT>UseAStoredProcedureWithAParameter</TT>, in Listing A.8.</P>
<H5 class="docExampleTitle">Listing A.8 <TT>basCommandExamples.vb</TT>: Calling a Stored Procedure By Using Parameters</H5>
<PRE>
Sub UseAStoredProcedureWithAParameter(ByVal txtResults As TextBox)

        Dim cnn As New ADODB.Connection()
        Dim rstCurr As New ADODB.Recordset()
        Dim cmd As New ADODB.Command()
        Dim prm As ADODB.Parameter

        Try
            cmd.CommandText = "CustOrderHist"
            cmd.CommandType = ADODB.CommandTypeEnum.adCmdStoredProc
            prm = cmd.CreateParameter("CustomerID", ADODB.DataTypeEnum.adChar,
                                 ADODB.ParameterDirectionEnum.adParamInput, 5)

            cmd.Parameters.Append(prm)
            prm.Value = "CHOPS"

            OpenNorthwindADOConnection(cnn)

            cmd.ActiveConnection = cnn

            rstCurr.Open(cmd)

            txtResults.Text = rstCurr.GetString

        Catch excp As Exception
            MessageBox.Show(excp.Message)
        End Try

    End Sub
</PRE>
<P>The last thing that this routine does is open a recordset based on the <TT>Command</TT> object. This is to the use just those records that are needed. In this case, the <TT>GetString</TT> method is used to assign it to the results text box. If you are using a bulk query, shown in the next section, you would use the <TT>Execute</TT> method. To see the routine in A.8 executed, click on the button with the caption Stored Procedure with Parameter, located on the <TT>frmMain</TT> form for this Appendix project.</P>
<ul></ul>
</body></html>
