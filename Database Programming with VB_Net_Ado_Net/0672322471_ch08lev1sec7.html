<html><head>
<META http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
<!--SafClassName="docSection1Title"--><!--SafTocEntry="8.7 Create a Point-and-Click Query Tool for Users Using a Web Form"-->
<link rel="STYLESHEET" type="text/css" href="FILES/style.css">
<link rel="STYLESHEET" type="text/css" href="FILES/docsafari.css">
<style type="text/css">	.tt1    {font-size: 10pt;}</style>
</head>
<body><H3 class="docSection1Title">8.7 Create a Point-and-Click Query Tool for Users Using a Web Form</H3>
<P>As useful-if not more so-than the example shown in the 8.3 How-to, this exercise will show you how to add a data-driven query tool to your ASP.NET application.</P>
<P>When creating database applications, even on the Web, one of your clients inevitably wants to be able to examine the data in his database, and not necessarily in edit pages. The client wants to be able to list his data out and examine the data at his leisure.</P>
<P>Giving the user the flexibility to do this via the Web is not as big of a hassle as it sounds. This How-To will show you how to create a page to view the tables in your database, using a nice point-and-click interface.</P>
<H4 class="docSection2Title"> Technique</H4>
<P>To accomplish the task just presented, you will be using the <TT>OleDbCommand</TT> and <TT>DataReader</TT> objects. Along with these objects, you will be using some stored procedures that SQL Server supplies. Those stored procedures list the various objects within a SQL Server database-in this case, Northwind's tables and columns.</P>
<P>You will take the elements returned in the <TT>DataReader</TT> object and load the <TT>Add</TT> method of the <TT>ListBox</TT> object.</P>
<P>You will also use the <TT>Session</TT> object as you did in the previous How-To to save a <TT>DataTable</TT> object for use over trips to the server.</P>
<P>Finally, the <TT>ViewState</TT> object will be used to store a string variable when going to the server and back. The <TT>ViewState</TT> object is a good .NET state object to use for small pieces of data, such as strings.</P>
<H4 class="docSection2Title"> Steps</H4>
<P>Open and run the VB.NET -Chapter 8 solution. From the main Web Form, click on the hyperlink with the caption How-To 8.7: Create a Point-and-Click SQL Server Query Tool for Users Using a Web Form. When the new page opens, the first list box you see to the left is populated with the tables from Northwind. Click on the Customer table, and you will see the columns listed in the list box labeled Columns. Click on the CompanyName and ContactName, and you will see the SQL String text box filled in. After clicking on the View button, the Web page will look like the one displayed in Figure 8.14.</P>







<span style="font-weight:bold"><OL class="docList" START="1">
<LI><span style="font-weight:normal" value="1"><P>Create a Web Form. Then place the controls shown in Figure 8.14 with the properties set forth in Table 8.9.</P><P><TABLE BORDER="1" align="center" CELLPADDING="6" CELLSPACING="0">
<CAPTION><h5 class="docTableTitle">Table 8.9. Property Settings for Controls on the Point-and-Click Web Form</h5></CAPTION><COLGROUP span="3">
<TR>
<TH class="docTableHeader" align="left" valign="top">
<P>Object</P>
</TH>
<TH class="docTableHeader" align="left" valign="top">
<P>Property</P>
</TH>
<TH class="docTableHeader" align="left" valign="top">
<P>Setting</P>
</TH>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>DOCUMENT</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>bgColor</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>buttonface</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>Label</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Name</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Label1</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">&nbsp;</TD>
<TD class="docTableCell" valign="top">
<P><TT>Text</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Tables</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>Label</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Name</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Label2</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">&nbsp;</TD>
<TD class="docTableCell" valign="top">
<P><TT>Text</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Columns</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>Label</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Name</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Label3</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">&nbsp;</TD>
<TD class="docTableCell" valign="top">
<P><TT>Text</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>SQL String</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>Label</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Name</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Label4</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">&nbsp;</TD>
<TD class="docTableCell" valign="top">
<P><TT>Text</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Data Display</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>ListBox</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Name</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>lstTables</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">&nbsp;</TD>
<TD class="docTableCell" valign="top">
<P><TT>AutoPostback</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>True</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>ListBox</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Name</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>lstColumns</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">&nbsp;</TD>
<TD class="docTableCell" valign="top">
<P><TT>SelectionMode</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Multiple</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">&nbsp;</TD>
<TD class="docTableCell" valign="top">
<P><TT>AutoPostback</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>True</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>DropDown</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Name</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>ddSortBy</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">&nbsp;</TD>
<TD class="docTableCell" valign="top">
<P><TT>AutoPostback</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>True</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>TextBox</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Name</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>txtSQLString</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">&nbsp;</TD>
<TD class="docTableCell" valign="top">
<P><TT>MultiLine</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>True</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>Button</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Name</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>btnView</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>DataGrid</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Name</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>dgDisplay</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">&nbsp;</TD>
<TD class="docTableCell" valign="top">
<P><TT>AllowPaging</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>True</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>Hyperlink</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Name</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>hplBackToMain</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">&nbsp;</TD>
<TD class="docTableCell" valign="top">
<P><TT>Text</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Return To Main</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">&nbsp;</TD>
<TD class="docTableCell" valign="top">
<P><TT>NavigateURL</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>wfrmMain.aspx</TT></P>
</TD>
</TR>
</COLGROUP>
</TABLE></P>
<div class="docNote"><p class="docNoteTitle">Tip</p>
<p><table border="0" align="center" cellpadding="6" cellspacing="0"><tr>
<td width="60" valign="top"><IMG BORDER="0" ALIGN="LEFT" WIDTH="100" HEIGHT="100" src="FILES/tip_icon.gif" ALT="graphics/tip_icon.gif"></td>
<td valign="top"><P>Notice that the lstTables list box allows the user to choose only one table at a time, whereas lstColumns allows the user to choose multiple columns.</P>
<P>A great enhancement to this tool would be to allow the user to choose multiple tables and have the application figure out the relationship between tables and create joins automatically.</P>
</td>
</tr></table></p>
</div></span></LI><LI><span style="font-weight:normal" value="2"><P>In the class module for the form, add the following Private declaration just below the line of code that reads <TT>Web Form Designer Generated Code</TT>:</P>
<pre>
Private mdtDisplay As DataTable
</pre></span></LI><LI><span style="font-weight:normal" value="3"><P>On the Web Form, add the code in Listing 8.40 to the Load event. The first task is to load the tables list box, performed by the subroutine <TT>LoadTables()</TT>, which is also in this listing. The form only calls this routine if it is the first time into the page, by checking for <TT>Not Me.IsPostBack</TT>. The form then tests to see whether the <TT>Session</TT> object has an entry called <TT>MyDisplayDataTable</TT>. If the entry exists, then <TT>mdtDisplay</TT> is referenced to it, meaning that this time through the <TT>Load</TT> event is probably occurring on a trip back from the server. The entry exists, and the code needs to set a reference to it.</P>
<P>In LoadTables, the routine first creates a new <TT>OleDbConnection</TT> object called <TT>ocnn</TT>, an <TT>OleDbCommand</TT> object called <TT>ocmdTables</TT>. It then assigns the built-in SQL Server stored procedure called <TT>sp_Tables</TT> when instantiating ocmdTables. After establishing the <TT>CommandType</TT> as being <TT>CommandType.StoredProcedure</TT> and then opening the connection, the data reader called <TT>odrTables</TT> is created by calling the ExecuteReader method off <TT>ocmdTables</TT>.</P>
<H5 class="docExampleTitle">Listing 8.40 <TT>frmHowTo8_7.vb</TT>: Executing a SQL Server-Supplied Stored Procedure That Lists the Tables in the Database</H5>
<PRE>
Private Sub Page_Load(ByVal sender As System.Object,
ByVal e As System.EventArgs) Handles MyBase.Load

       'Put user code to initialize the page here
        If Not Me.IsPostBack Then

            LoadTables()

        End If
        If Not (Session("MyDisplayDataTable") Is Nothing) Then

            mdtDisplay = CType(Session("MyDisplayDataTable"), DataTable)

        End If

    End Sub

    Sub LoadTables()

        '-- Create the connection and specify the stored procedure to use.
        Dim ocnn As New OleDb.OleDbConnection(BuildCnnStr("(local)", _
                  "Northwind"))
        Dim ocmdTables As New OleDb.OleDbCommand("sp_Tables", ocnn)
        Dim odrTables As OleDb.OleDbDataReader

        '-- Specify the type of command being performed.
        ocmdTables.CommandType = CommandType.StoredProcedure

        ocnn.Open()

        '-- Create the DataReader object.
        odrTables = ocmdTables.ExecuteReader()

        '-- Loop through and add table type object names
        '  to the lstTables list box.
        Do While odrTables.Read
            If odrTables.GetString(3) = "TABLE" Then
                Me.lstTables.Items.Add(odrTables.GetString(2))
            End If
        Loop

End Sub
</PRE>
<P>Next, the code loops through each of the items returned by the command. Those of type <TT>TABLE</TT> are added to the lstTables items. Then the connection is closed.</P>
<P>As mentioned, you will see a comparison to the literal <TT>TABLE</TT>. This is because the fourth column returned matches the current table type. The other two types are <TT>SYSTEMTABLE</TT> and <TT>VIEW</TT>. To see the data returned by the sp_tables stored procedure, open the Query Analyzer, as described in How-To 8.3.</P></span></LI><LI><span style="font-weight:normal" value="4"><P>On lstTables, add the code in Listing 8.41 to the <TT>SelectedIndexChanged</TT> event. This routine performs a similar feat as the previous routine; it will call a built-in stored procedure-in this case, <TT>sp_Columns</TT>. However, the next task in this step is to pass a parameter, <TT>TableName</TT>, which is the table chosen in <TT>lstTables.SelectedItem.Text</TT>. After the connection is opened, the <TT>DataReader</TT> called <TT>odrColumns</TT> is loaded with the <TT>ExecuteReader</TT> command. After the <TT>lstColumns.Items.Clear()</TT> method is called to clear the list, the new columns are added to the lstColumns Items collection. Then the connection is closed.</P>
<H5 class="docExampleTitle">Listing 8.41 <TT>frmHowTo8_7.vb</TT>: Executing a SQL Server Built-In Stored Procedure That Lists the Columns of a Supplied Table in the Database</H5>
<PRE>
Private Sub lstTables_SelectedIndexChanged(ByVal sender As System.Object,
        ByVal e As System.EventArgs) Handles lstTables.SelectedIndexChanged

    '-- Create the connection and specify the stored procedure to use.
    Dim ocnn As New OleDb.OleDbConnection(BuildCnnStr("(local)", _
                   "Northwind"))
    Dim ocmdColumns As New OleDb.OleDbCommand("sp_Columns", ocnn)
    Dim odrColumns As OleDb.OleDbDataReader

    '-- Specify the type of command being performed
    ocmdColumns.CommandType = CommandType.StoredProcedure
    ocmdColumns.Parameters.Add("@TableName", Me.lstTables.SelectedItem.Text)

    ocnn.Open()

    '-- Create the DataReader object
    odrColumns = ocmdColumns.ExecuteReader()

    '-- Clear the current items in the list
    Me.lstColumns.Items.Clear()

    '-- Loop through and add table type object names
'  to the lstTables list box.
    Do While odrColumns.Read
        Me.lstColumns.Items.Add(odrColumns.GetString(3))
    Loop

End Sub
</PRE></span></LI><LI><span style="font-weight:normal" value="5"><P>On lstColumns, add the code in Listing 8.42 to the <TT>SelectedIndexChanged</TT> event. After clearing the items from ddSortBy, this routine iterates through the Items collection of the lstColumns ListBox control, adding the chosen column names (those items with the Selected property set to True) to a string variable called strTemp. The <TT>DropDown</TT> control called <TT>ddSoryBy</TT> adds the column name to its Items collection.</P>
<P>After the string is finished iterating through the lstColumns Items, it is stored to a <TT>ViewState</TT> entry called <TT>SQLFields</TT>. The <TT>LoadSQLString</TT> routine is then called, which is also in this listing.</P>
<P>In the routine <TT>LoadSQLString</TT>, the length of the string is checked. If the length is greater than 0, the Text property of <TT>txtSQLString</TT> is set to the following expression: <TT>"Select " &amp; strTemp &amp; " From " &amp; Me.lstTables.Text &amp; " Order By " &amp; Me.ddSortBy.SelectedItem.ToString</TT>. If the length is 0, then the Text property of txtSQLString is set to the empty string.</P>
<H5 class="docExampleTitle">Listing 8.42 <TT>frmHowTo8_7.vb</TT>: Creating the SQL String</H5>
<PRE>
    Private Sub lstColumns_SelectedIndexChanged(ByVal sender As System.Object,
                ByVal e As System.EventArgs) Handles
lstColumns.SelectedIndexChanged

        Dim intNumColumns As Integer
        Dim oCurr As Object
        Dim blnIsSelected As Boolean
        Dim strTemp As String

        Me.ddSortBy.Items.Clear()

        '-- Cycle through each of the selected columns of the table chosen
        '   and combine them into a string.

        For Each oCurr In Me.lstColumns.Items

            If oCurr.Selected() = True Then

                If Len(strTemp) &gt; 0 Then
                    strTemp &amp;= ", "
                End If

                strTemp &amp;= oCurr.ToString

                Me.ddSortBy.Items.Add(oCurr.ToString)

            End If
        Next

        ViewState("SQLFields") = strTemp

        LoadSQLString()

End Sub

Sub LoadSQLString()

        '-- Take the string created and add it to the
        '   table name for a SQL String, if columns are chosen.

        If Len(ViewState("SQLFields")) = 0 Then
            Me.txtSQLString.Text = ""
        Else
            Me.txtSQLString.Text = "Select " &amp; ViewState("SQLFields") &amp; _
" From " &amp; Me.lstTables.SelectedItem.ToString &amp; _
                      " Order By " &amp; Me.ddSortBy.SelectedItem.ToString
        End If

    End Sub
</PRE></span></LI><LI><span style="font-weight:normal" value="6"><P>On btnView, add the code in Listing 8.43 to the <TT>Click</TT> event. This routine creates the new data adapter called <TT>odaDisplay</TT>, passes the <TT>Text</TT> property of <TT>txtSQLString</TT>, and then fills the <TT>dtDisplay</TT> DataTable. The public variable, called mdtDisplay, references dtDisplay so that it will be seen in other routines. The code then stores a new entry in the Session object called <TT>MyDisplayDataTable</TT>, which is loaded back into mdtDisplay upon reloading of the page. Last, the routine <TT>BindTheGrid</TT> is called to set to the <TT>DataSource</TT> property of the data grid called <TT>dgDisplay</TT>.</P>
<H5 class="docExampleTitle">Listing 8.43 <TT>frmHowTo8_7.vb</TT>: Loading the DataGrid Control with the Specified Data</H5>
<PRE>
Private Sub btnView_Click(ByVal sender As System.Object, _
                        ByVal e As System.EventArgs) Handles btnView.Click
    Dim odaDisplay As OleDb.OleDbDataAdapter
    Dim dtDisplay As New DataTable()

    Try

        '-- Take the txtSQLString text and create a data table. Then set the
        '   data source of the data grid.

        odaDisplay = New OleDb.OleDbDataAdapter(Me.txtSQLString.Text, _
                                            BuildCnnStr("(local)", "Northwind"))

        odaDisplay.Fill(dtDisplay)

        mdtDisplay = dtDisplay

        Session("MyDisplayDataTable") = mdtDisplay

        BindTheGrid()

    Catch excData As Exception

    End Try

End Sub

Sub BindTheGrid()

    Me.dgDisplay.DataSource = mdtDisplay
    '-- Must databind for ASP.NET
    Me.dgDisplay.DataBind()

End Sub
</PRE></span></LI><LI><span style="font-weight:normal" value="7"><P>On the ddSortby control, attach the first routine in Listing 8.44 to the <TT>SelectedIndexChanged</TT> event. Then add the second routine to the <TT>PageIndexChanged</TT> event of <TT>dgDisplay</TT>.</P></span></LI></OL></span>
<CENTER><H5 class="docFigureTitle">Figure 8.14. You can set the sorting of the data grid that is displayed here by choosing from the drop-down list.</H5><p><IMG BORDER="0" WIDTH="500" HEIGHT="375" src="FILES/08fig14.gif" ALT="graphics/08fig14.gif"></p>
</CENTER>
<H5 class="docExampleTitle">Listing 8.44 <TT>frmHowTo8_7.vb</TT>: Loading the DataGrid Control with the Specified Data</H5>
<PRE>
Private Sub ddSortBy_SelectedIndexChanged(ByVal sender As System.Object,
           ByVal e As System.EventArgs) Handles ddSortBy.SelectedIndexChanged

        LoadSQLString()

End Sub

Private Sub dgDisplay_PageIndexChanged(ByVal source As Object, _
       ByVal e As System.Web.UI.WebControls.DataGridPageChangedEventArgs)
                    Handles dgDisplay.PageIndexChanged

        '-- Set the current page in the data grid
        Me.dgDisplay.CurrentPageIndex = e.NewPageIndex

        BindTheGrid()

End Sub
</PRE>
<H4 class="docSection2Title"> How It Works</H4>
<P>When the form is opened, the lstTables ListBox control is loaded with the tables from the Northwind database. When the user selects a table from the list, that table name is passed to the stored procedure. That procedure lists the columns in a database table that is specified in the connection-in this case, Northwind. These columns are loaded into lstColumns.</P>
<P>The user can click on multiple columns in lstColumns. Those columns then are added to the SQL Select string that is created and stored in <TT>txtSQLString</TT>. When the btnView button is clicked, the string is passed to a <TT>DataAdapter</TT> control, filling a data table. From there, the data is displayed when the data source of the <TT>DataGrid</TT> control is set to the data table.</P>
<P>Users can change the sort order by changing the value in the <TT>DropDown</TT> object.</P>
<H4 class="docSection2Title"> Comments</H4>
<P>You can enhance this tool in several ways:</P>
<UL>
<LI><P>Let users click on multiple tables and automatically create the join.</P></LI>
<LI><P>Add a list of columns for the user to choose to use for criteria, and allow the user to input the criteria.</P></LI>
<LI><P>Use this tool as a base for editing or reporting the records that are returned.</P></LI>
</UL>
<P>This technique's goal, as with others in this book, is to push you into thinking about the possibilities of what you can accomplish with Visual Studio .NET and your databases.</P>
<img src="FILES/pixel.gif" width="1" height="1" border="0"><ul></ul>
</body></html>
