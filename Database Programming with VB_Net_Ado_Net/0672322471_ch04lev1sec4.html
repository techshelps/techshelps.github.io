<html><head>
<META http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
<!--SafClassName="docSection1Title"--><!--SafTocEntry="4.4 Create and Execute On-the-Fly Batch Updates by Using ADO.NET"-->
<link rel="STYLESHEET" type="text/css" href="FILES/style.css">
<link rel="STYLESHEET" type="text/css" href="FILES/docsafari.css">
<style type="text/css">	.tt1    {font-size: 10pt;}</style>
</head>
<body><H3 class="docSection1Title">4.4 Create and Execute On-the-Fly Batch Updates by Using ADO.NET</H3>
<P>Sometimes in database applications, you want to create and execute stored procedures that don't currently exist. When you have a situation in which you need to use highly dynamic stored procedures that might use criteria that is entirely created at runtime, you might need to create those stored procedures on-the-fly. This How-To shows you how to create and execute these stored procedures.</P>
<P>It's great that you can execute stored procedures that are already created, but what if you need to generate one at runtime? How do you do this?</P>
<H4 class="docSection2Title"> Technique</H4>
<P>To perform this How-To, you will be utilizing the <TT>OleDBCommand</TT> object, and feeding in the <TT>CommandText</TT> property from a text box. The text box is set to <TT>"Update Employees Set City = 'Redmond' Where City = 'Seattle'"</TT> to give you something to start with.</P>
<H4 class="docSection2Title"> Steps</H4>
<P>Open and run the VB.NET-Chapter 4 solution. From the main form, click on the command button with the caption How-To 4.4. When the form loads, you will see an example update statement in a text box. Click on the Execute button to execute the update statement. A <TT>TextBox</TT> control is then displayed on the bottom of the form showing the number of records that are affected. You can the form in Figure 4.3.</P>
<CENTER><H5 class="docFigureTitle">Figure 4.3. This form uses the <TT>Command</TT> object with a SQL statement passed to execute the specified action.</H5><p><IMG BORDER="0" WIDTH="500" HEIGHT="181" src="FILES/04fig03.jpg" ALT="graphics/04fig03.jpg"></p>
</CENTER>
<div class="docNote"><p class="docNoteTitle">Note</p>
<p><table border="0" align="center" cellpadding="6" cellspacing="0"><tr>
<td width="60" valign="top"><IMG BORDER="0" ALIGN="LEFT" WIDTH="100" HEIGHT="100" src="FILES/note_icon.gif" ALT="graphics/note_icon.gif"></td>
<td valign="top"><P>The number of records affected might be different on your system depending on what you have been doing with the Northwind data.</P>
</td>
</tr></table></p>
</div><br>



<span style="font-weight:bold"><OL class="docList" START="1">
<LI><span style="font-weight:normal" value="1"><P>Create a new Windows Form.</P></span></LI><LI><span style="font-weight:normal" value="2"><P>Add the following controls, setting the properties as listed in Table 4.6.</P>
<P><TABLE BORDER="1" align="center" CELLPADDING="6" CELLSPACING="0">
<CAPTION><h5 class="docTableTitle">Table 4.6. Controls Property Settings</h5></CAPTION><COLGROUP span="3">
<TR>
<TH class="docTableHeader" align="left" valign="top">
<P>Object</P>
</TH>
<TH class="docTableHeader" align="left" valign="top">
<P>Property</P>
</TH>
<TH class="docTableHeader" align="left" valign="top">
<P>Setting</P>
</TH>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>Label</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Name</TT></P>
<P><TT>Caption</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Label1</TT></P>
<P><TT>Update Statement to Execute:</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>Button</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Name</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>btnExecute</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>TextBox</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Name</TT></P>
<P><TT>Text</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>txtSQL</TT></P>
<P><TT>Update Employees Set City = 'Redmond' Where City = 'Seattle'</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">&nbsp;</TD>
<TD class="docTableCell" valign="top">
<P><TT>MultiLine</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>True</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>Label</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Name</TT></P>
<P><TT>Caption</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Label2</TT></P>
<P><TT>Records Affected:</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>TextBox</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Name</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>txtRecsAffected</TT></P>
</TD>
</TR>
</COLGROUP>
</TABLE></P></span></LI><LI><span style="font-weight:normal" value="3"><P>Enter the following code to the <TT>Click</TT> event <TT>btnExecute</TT>. When the command is instantiated in this case, the string in the <TT>txtSQL</TT> text box is passed as the <TT>CommandText</TT>. The <TT>CommandType</TT> is set as <TT>CommandType.Text</TT>. The connection is then open. Finally, the command is executed with the <TT>ExecuteNonQuery</TT> method, with the <TT>ToString</TT> passing back the number of records that were affected to the <TT>Text</TT> property of the <TT>txtRecsAffected</TT> text box.</P>
<pre>
Private Sub btnExecute_Click(ByVal sender As System.Object, _
                    ByVal e As System.EventArgs) Handles btnExecute.Click

        Dim ocnn As New OleDb.OleDbConnection(BuildCnnStr("(local)", "Northwind"))
        Dim ocmdPhoneUp As New OleDb.OleDbCommand(Me.txtSQL.Text, ocnn)

        Try
            '-- Specify the name of the stored procedure
            ocmdPhoneUp.CommandType = CommandType.Text

            '-- Open the connection object.
            ocnn.Open()

            Me.txtRecsAffected.Text = ocmdPhoneUp.ExecuteNonQuery.ToString

        Catch excpData As Exception
            MessageBox.Show("Error Occurred: " &amp; excpData.Message)

        End Try
End Sub
</pre></span></LI></OL></span>
<div class="docNote"><p class="docNoteTitle">Tip</p>
<p><table border="0" align="center" cellpadding="6" cellspacing="0"><tr>
<td width="60" valign="top"><IMG BORDER="0" ALIGN="LEFT" WIDTH="100" HEIGHT="100" src="FILES/tip_icon.gif" ALT="graphics/tip_icon.gif"></td>
<td valign="top"><P>Use a <TT>Try&#8230;Catch&#8230;End Try block</TT> to trap any exceptions that might occur when working with ADO.NET. In this case, the error is trapped and a message box displays the error. Remember that exceptions that are not trapped will cause the application to fail.</P>
</td>
</tr></table></p>
</div><br>
<H4 class="docSection2Title"> How It Works</H4>
<P>When a valid SQL statement is entered into the text box with the label <TT>Update Statement to Execute:</TT> and the Execute button is clicked, the command entered is executed, and the number of records that were affected is returned.</P>
<H4 class="docSection2Title"> Comments</H4>
<P>The <TT>Command</TT> object is a real workhorse when it comes to performing bulk operations, whether working with store procedures already created or when using statements that have been created on-the-fly.</P>
<img src="FILES/pixel.gif" width="1" height="1" border="0"><ul></ul>
</body></html>
