<html><head>
<META http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
<!--SafClassName="docSection1Title"--><!--SafTocEntry="6.5 Take Advantage of Using Subqueries"-->
<link rel="STYLESHEET" type="text/css" href="FILES/style.css">
<link rel="STYLESHEET" type="text/css" href="FILES/docsafari.css">
<style type="text/css">	.tt1    {font-size: 10pt;}</style>
</head>
<body><H3 class="docSection1Title">6.5 Take Advantage of Using Subqueries</H3>
<P>I think there are some duplicate records in one of my tables. Also, I need to know which of the cities (and regions) in a Northwind database has more than one customer in it. How can I use subqueries to perform these tasks?</P>
<H4 class="docSection2Title"> Technique</H4>
<P>To get the answers to the situations just presented, you will use a subquery in your T-SQL statement. A subquery is a complete SELECT statement. Following is the query that will be used for this How-To. It uses a subquery in the WHERE clause of the outer, or main query:</P>
<pre>
SELECT Customers.City, Customers.Region, Customers.CustomerID,
Customers.CompanyName From Customers WHERE (((Customers.City)
IN (SELECT Tmp.City FROM Customers As Tmp GROUP BY Tmp.City,Tmp.Region
HAVING Count(*)&gt;1 And Region = Customers.Region)))
ORDER BY Customers.City, Customers.Region
</pre>
<P>You can see in this query that in the <TT>WHERE</TT> clause, the City column in Customers is used with an <TT>IN</TT> operator. The subquery in this case returns all the cities that are assigned to more than one customer.</P>
<div class="docNote"><p class="docNoteTitle">Note</p>
<p><table border="0" align="center" cellpadding="6" cellspacing="0"><tr>
<td width="60" valign="top"><IMG BORDER="0" ALIGN="LEFT" WIDTH="100" HEIGHT="100" src="FILES/note_icon.gif" ALT="graphics/note_icon.gif"></td>
<td valign="top"><P>In this case, you are using a subquery much as you would a joined table or against another view. The nice thing about using the subquery is that you can see the entire query here, instead of opening another view that is joined.</P>
<P>Performancewise, there is no benefit or degradation in using subqueries.</P>
</td>
</tr></table></p>
</div><br>
<P>In addition to using subqueries in WHERE clauses, you can use them anywhere you would use an expression.</P>
<H4 class="docSection2Title"> Steps</H4>
<P>Open and run the "Visual Basic .NET-Chapter 6" solution. From the main form, click on the button with the caption How-To 6.5. Much like a couple of the other How-Tos in this chapter, you will see the query displayed in the label on the top of the form, with the results displayed in the data grid object below (see Figure 6.6).</P>


<span style="font-weight:bold"><OL class="docList" START="1">
<LI><span style="font-weight:normal" value="1"><P>Create a Windows Form. Then place the controls listed in Table 6.5 with the properties set displayed in Figure 6.6.</P>
<P><TABLE BORDER="1" align="center" CELLPADDING="6" CELLSPACING="0">
<CAPTION><h5 class="docTableTitle">Table 6.5. Control Property Settings for This How-To</h5></CAPTION><COLGROUP span="3">
<TR>
<TH class="docTableHeader" align="left" valign="top">
<P>Object</P>
</TH>
<TH class="docTableHeader" align="left" valign="top">
<P>Property</P>
</TH>
<TH class="docTableHeader" align="left" valign="top">
<P>Setting</P>
</TH>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>Label</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Text</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>SQL Statement</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>Label</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Name</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>lblSQLString</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>Label</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Text</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Results</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>DataGrid</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Name</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>dgResults</TT></P>
</TD>
</TR>
</COLGROUP>
</TABLE></P></span></LI><LI><span style="font-weight:normal" value="2"><P>Add the code in Listing 6.10 to the Load event of the form. (Double-click on the form to bring up the code.)</P>
<H5 class="docExampleTitle">Listing 6.10 <TT>frmHowTo6_5.vb</TT>: Loading and Executing the SQL Statement by Using the Subquery</H5>
<PRE>
Private Sub frmHowTo6_5_Load(ByVal sender As System.Object,
                    ByVal e As System.EventArgs) Handles MyBase.Load

        '-- Build the SQL String that returns cities that
        '    have more than one customer in them.
        Dim strSQL As String
        strSQL = "SELECT Customers.City, Customers.Region, " &amp;
"Customers.CustomerID, Customers.CompanyName "
        strSQL &amp;= "From Customers "
        strSQL &amp;= "WHERE (((Customers.City) In "
        strSQL &amp;= "(SELECT Tmp.City FROM Customers As Tmp "
        strSQL &amp;= "GROUP BY Tmp.City,Tmp.Region HAVING Count(*)&gt;1 "
        strSQL &amp;= "And Region = Customers.Region))) " &amp; _
          "ORDER BY Customers.City, Customers.Region"

        Me.lblSQLString.Text = strSQL

        '-- Use the SQL String to build the data adapter and fill the data table.
        Dim odaResults As New OleDb.OleDbDataAdapter(Me.lblSQLString.Text,
                                  BuildCnnStr("(local)", "Northwind"))
        Dim dtResults As New DataTable()

        Try
            odaResults.Fill(dtResults)
        Catch excp As Exception
            MessageBox.Show(excp.Message)
            Exit Sub
        End Try

        '-- Assign the data table to the data grid's DataSource property
        Me.dgResults.DataSource = dtResults

End Sub
</PRE></span></LI></OL></span>
<CENTER><H5 class="docFigureTitle">Figure 6.6. Using subqueries in one step to retrieve information saves time and effort.</H5><p><IMG BORDER="0" WIDTH="488" HEIGHT="336" src="FILES/06fig06.jpg" ALT="graphics/06fig06.jpg"></p>
</CENTER>
<H4 class="docSection2Title"> Comments</H4>
<P>Subqueries are a powerful tool for getting at your data in different ways. Following are some rules you have to remember when using subqueries:</P>
<UL>
<LI><P>You can only use an <TT>ORDER BY</TT> clause if you are using the <TT>TOP</TT> clause.</P></LI>
<LI><P>If a table is being used in the subquery but not in the main query, then you cannot use columns from that table in the output of the main query.</P></LI>
<LI><P>You need to use parentheses around the subquery <TT>SELECT</TT> statement.</P></LI>
<LI><P>You can't include a <TT>FOR BROWSE</TT> or <TT>COMPUTE</TT> clause in the subquery.</P></LI>
</UL>
<ul></ul>
</body></html>
