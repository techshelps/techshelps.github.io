<html><head>
<META http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
<!--SafClassName="docSection1Title"--><!--SafTocEntry="4.2 Add and Delete Rows in a Dataset with ADO.NET"-->
<link rel="STYLESHEET" type="text/css" href="FILES/style.css">
<link rel="STYLESHEET" type="text/css" href="FILES/docsafari.css">
<style type="text/css">	.tt1    {font-size: 10pt;}</style>
</head>
<body><H3 class="docSection1Title">4.2 Add and Delete Rows in a Dataset with ADO.NET</H3>
<P>Again using the <TT>OleDbDataAdapter</TT> and <TT>OleDbCommandBuilder</TT> objects, this How-To shows you how to use unbound controls with the dataset to add and delete rows from SQL Server.</P>
<P>As with editing and updating data, you need to be able to add and delete rows using the dataset. How do you perform this task?</P>
<H4 class="docSection2Title"> Technique</H4>
<P>The main difference between this technique and the previous one will be which action command you will use with the <TT>DataAdapter</TT> object. You will also be presented with the Add method on the <TT>Rows</TT> collection.</P>
<H4 class="docSection2Title"> Steps</H4>
<P>Open and run the VB.NET-Chapter 4 solution. From the main form, click on the command button with the caption How-To 4.2. When the form loads, click on the Load List button to display the customers that begin with the letter <span class="docEmphasis">A</span>. Click the Add button. You will notice that the fields have now taken on a sunken look and that they are cleared. Fill in the Customer ID and Company Name text boxes with <TT>AAA1</TT> and <TT>Another Example</TT>. Now click Save. If you move off the record and move back on, you will notice that the value has been saved. Now select the new record you added, and click the Delete button. The record disappears, and the list box is updated to reflect the deletion.</P>







<span style="font-weight:bold"><OL class="docList" START="1">
<LI><span style="font-weight:normal" value="1"><P>Make a copy of the form you created in the last How-To.</P></span></LI><LI><span style="font-weight:normal" value="2"><P>Add two buttons for adding and deleting records, setting the properties as listed here in Table 4.3.</P><P><TABLE BORDER="1" align="center" CELLPADDING="6" CELLSPACING="0">
<CAPTION><h5 class="docTableTitle">Table 4.3. Add and Delete Buttons Property Settings</h5></CAPTION><COLGROUP span="3">
<TR>
<TH class="docTableHeader" align="left" valign="top">
<P>Object</P>
</TH>
<TH class="docTableHeader" align="left" valign="top">
<P>Property</P>
</TH>
<TH class="docTableHeader" align="left" valign="top">
<P>Setting</P>
</TH>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>Button</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Name</TT></P>
<P><TT>Caption</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>btnAdd</TT></P>
<P><TT>&amp;Add</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>Button</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Name</TT></P>
<P><TT>Text</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>btnDelete</TT></P>
<P><TT>&amp;Delete</TT></P>
</TD>
</TR>
</COLGROUP>
</TABLE></P></span></LI><LI><span style="font-weight:normal" value="3"><P>Add the following line of code where you placed the other module-level variable declarations. This variable will be set to <TT>True</TT> in the <TT>btnAdd</TT> click event, and it can be used when saving the record.</P>
<pre>
Dim mblnAdd As Boolean
</pre></span></LI><LI><span style="font-weight:normal" value="4"><P>Enter the following code to the <TT>Click</TT> event btnAdd. The first task is to set the mblnAdd variable to <TT>True</TT>. Then the routine clears the current text in the text boxes. It also enables the text boxes by calling <TT>ActiveEditing</TT>.</P>
<pre>
Private Sub btnAdd_Click(ByVal sender As System.Object,
             ByVal e As System.EventArgs) Handles btnAdd.Click

        Dim oCtl As Object
        Dim strName

        mblnAdd = True

        '-- Clear the fields
        For Each oCtl In Me.Controls

            If TypeOf oCtl Is TextBox And oCtl.name &lt;&gt; "txtCustLimit" Then

                strName = Mid(oCtl.Name, 4)

                '-- By trapping the exception this way, errors are ignored.
                Try
                    oCtl.text = ""
                Catch oexp As Exception
                End Try

            End If

        Next

        ActivateEditing(True)

    End Sub
</pre></span></LI><LI><span style="font-weight:normal" value="5"><P>Replace the <TT>SaveRecord</TT> routine with the following code in the form that you created for this How-To. The first change is to add the lines of code that test <TT>mblnAdd</TT>; if they're <TT>True</TT>, call the <TT>NewRow</TT> method off the dataset's Tables collection, specifying the Customers table. The DataRow returned is assigned to <TT>mdrCustIndiv</TT>. You can then enter the other changes wherever the <TT>blnAdd</TT> variable is queried.</P>
<pre>
Private Sub SaveRecord()

        Dim oCtl As Object
        Dim strName As String

        If mblnAdd Then
            mdrCustIndiv = mdsCustIndiv.Tables("Customers").NewRow
        End If

        '-- Start the editing in the datarow.
        mdrCustIndiv.BeginEdit()

        '-- Run through the text boxes on the form, and
        '-- if they match up with a field from the record,
        '-- place the value back in the record.
        For Each oCtl In Me.Controls

            If TypeOf oCtl Is TextBox Then

                strName = Mid(oCtl.Name, 4)

                '-- By trapping the exception this way, errors are ignored.
                Try
                    mdrCustIndiv(strName) = oCtl.text
                Catch oexp As Exception
                End Try

            End If

        Next

        '-- Finish the editing of the datarow
        mdrCustIndiv.EndEdit()

        Try

            If mblnAdd Then
                mdsCustIndiv.Tables("Customers").Rows.Add(mdrCustIndiv)
            End If

            '-- Create an instance of the command builder
            Dim ocbCustIndiv As OleDb.OleDbCommandBuilder
            ocbCustIndiv = New OleDb.OleDbCommandBuilder(modaCustIndiv)

            If mblnAdd Then
                '-- Have the command builder create an Insert SQL command
                modaCustIndiv.InsertCommand = ocbCustIndiv.GetInsertCommand
            Else
                '-- Have the command builder create an update SQL command
                modaCustIndiv.UpdateCommand = ocbCustIndiv.GetUpdateCommand
            End If

            '-- Perform the specified SQL command; then close the connection
            modaCustIndiv.Update(mdsCustIndiv, "Customers")
            mdsCustIndiv.Tables("Customers").AcceptChanges()

            '-- Close the connection
            If mblnAdd Then
                modaCustIndiv.InsertCommand.Connection.Close()
                LoadList()
            Else
                modaCustIndiv.UpdateCommand.Connection.Close()
            End If

        Catch excData As Exception
            MessageBox.Show("Error Occurred: " &amp; excData.Message)
        End Try

    End Sub
</pre></span></LI><LI><span style="font-weight:normal" value="6"><P>Enter the following code to the <TT>Click</TT> event btnCancel.</P>
<pre>
Private Sub btnCancel_Click(ByVal sender As System.Object, _
                   ByVal e As System.EventArgs) Handles btnCancel.Click

        '-- Cancel the current editing.

        If mblnAdd Then
            mblnAdd = False
        End If

        LoadIndividual()
        ActivateEditing(False)

    End Sub
</pre></span></LI><LI><span style="font-weight:normal" value="7"><P>Enter the following code to the <TT>Click</TT> event <TT>btnDelete</TT>. Follow the comments to see what is happening.</P>
<pre>
Private Sub btnDelete_Click(ByVal sender As System.Object,
             ByVal e As System.EventArgs) Handles btnDelete.Click

        Dim ocbCustIndiv As OleDb.OleDbCommandBuilder

        Try

            '-- Delete the record from the datarow object
            mdrCustIndiv.Delete()

            '-- Instantiate the command builder
            ocbCustIndiv = New OleDb.OleDbCommandBuilder(modaCustIndiv)

            '-- Have the command builder create a Delete SQL command
            modaCustIndiv.DeleteCommand = ocbCustIndiv.GetDeleteCommand

            '-- Perform the specified SQL command; then close the connection
            modaCustIndiv.Update(mdsCustIndiv, "Customers")
            mdsCustIndiv.Tables("Customers").AcceptChanges()

            '-- Close the connection
            modaCustIndiv.DeleteCommand.Connection.Close()

        Catch excData As Exception
            MessageBox.Show("Error Occurred: " &amp; excData.Message)
        End Try

        LoadList()
        ActivateEditing(False)

    End Sub
</pre></span></LI></OL></span>
<H4 class="docSection2Title"> How It Works</H4>
<P>When a user clicks the Add button, the text boxes are all blanked out, and the mblnAdd flag is set as <TT>True</TT>. Then, after the user adds his information and clicks the Save button, the new record is added back to the server. If the Cancel button is clicked, the individual customer to whom the list is currently pointed is loaded into the text boxes. When the Delete key is pressed, the current record is deleted from the server. Then the customer list is refreshed, and the first customer in the list is displayed in the text boxes.</P>
<H4 class="docSection2Title"> Comments</H4>
<P>As you can see, adding and deleting a record does not take much more than editing and updating a record using ADO.NET. Using the commands in this How-To and the prior one, you can set it up to handle updating and canceling of multiple records as well.</P>
<ul></ul>
</body></html>
