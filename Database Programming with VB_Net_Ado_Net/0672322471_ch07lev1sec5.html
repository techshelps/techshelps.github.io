<html><head>
<META http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
<!--SafClassName="docSection1Title"--><!--SafTocEntry="7.3 Restore a SQL Server Database"-->
<link rel="STYLESHEET" type="text/css" href="FILES/style.css">
<link rel="STYLESHEET" type="text/css" href="FILES/docsafari.css">
<style type="text/css">	.tt1    {font-size: 10pt;}</style>
</head>
<body><H3 class="docSection1Title">7.3 Restore a SQL Server Database</H3>
<P>Sometimes the user needs to restore a database, and again, it is nice if he doesn't have to go to Enterprise Manager to accomplish this task. This How-To explains how to use the <TT>Restore</TT> object from SQL-DMO to accomplish this task.</P>
<P>It's all well and good to be able to back up and verify a SQL Server database, but what about being able to restore the database if necessary? How do you create a dialog box to restore a SQL Server database?</P>
<H4 class="docSection2Title"> Technique</H4>
<P>For this How-To, you will use the <TT>Restore</TT> object of the SQL-DMO object model. You can see the properties and methods that will be used in Table 7.5.</P>
<P><TABLE BORDER="1" align="center" CELLPADDING="6" CELLSPACING="0">
<CAPTION><h5 class="docTableTitle">Table 7.5. Properties and Methods of the <TT>Restore</TT> Object</h5></CAPTION><COLGROUP span="2">
<TR>
<TH class="docTableHeader" align="left" valign="top">
<P>Property/Method</P>
</TH>
<TH class="docTableHeader" align="left" valign="top">
<P>Description</P>
</TH>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>Action</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P>This property allows you to specify what type of backup you want to take place. The choices are found in the <TT>SQLDMO.SQLDMO_RESTORE_TYPE</TT> namespace and are <TT>SQLDMORestore_Database</TT>, <TT>SQLDMORestore_Files</TT>, <TT>SQLDMORestore_Log</TT>.</P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>Database</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P>This property allows you to specify the database name to restore to.</P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>Devices</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P>This property shows which device(s) you are restoring from.</P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>ReplaceDatabase</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P>This property tells whether to replace the database.</P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>SQLRestore</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P>This method causes the restore to be executed.</P>
</TD>
</TR>
</COLGROUP>
</TABLE></P>
<P>Using the objects listed in Table 7.5, you will create a form with options for the user to restore his database.</P>
<H4 class="docSection2Title"> Steps</H4>
<P>Open and run the VB.NET -Chapter 7 solution. From the main Windows Form, click on the command button with the caption How-To 7.3. You will then see the form displayed in Figure 7.8.</P>
<CENTER><H5 class="docFigureTitle">Figure 7.8. This form restores a SQL Server database.</H5><p><IMG BORDER="0" WIDTH="464" HEIGHT="304" src="FILES/07fig08.gif" ALT="graphics/07fig08.gif"></p>
</CENTER>
<P>As with How-To 7.2, a user clicks on the SQL Server for which he wants to display the databases. He can then choose the database and backup device. From there, the user can click the Restore button to restore the database.</P>





<span style="font-weight:bold"><OL class="docList" START="1">
<LI><span style="font-weight:normal" value="1"><P>Create a Windows Form. Then place the controls shown in Figure 7.8, with the following properties set as in Table 7.6.</P><P><TABLE BORDER="1" align="center" CELLPADDING="6" CELLSPACING="0">
<CAPTION><h5 class="docTableTitle">Table 7.6. Label, ListBox, DataGrid, and Command Button Controls Property Settings</h5></CAPTION><COLGROUP span="3">
<TR>
<TH class="docTableHeader" align="left" valign="top">
<P>Object</P>
</TH>
<TH class="docTableHeader" align="left" valign="top">
<P>Property</P>
</TH>
<TH class="docTableHeader" align="left" valign="top">
<P>Setting</P>
</TH>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>Label</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Name</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Label1</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">&nbsp;</TD>
<TD class="docTableCell" valign="top">
<P><TT>Text</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>SQL Servers</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>ListBox</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Name</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>lstSQLServers</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>Label</TT> </P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Name</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Label2</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">&nbsp;</TD>
<TD class="docTableCell" valign="top">
<P><TT>Text</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Databases</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>ListBox</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Name</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>lstDatabases</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>Label</TT> </P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Name</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Label3</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">&nbsp;</TD>
<TD class="docTableCell" valign="top">
<P><TT>Text</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Backup Devices</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>ListBox</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Name</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>lstBackupDevices</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>Command Button</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Name</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>btnBackup</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">&nbsp;</TD>
<TD class="docTableCell" valign="top">
<P><TT>Text</TT> </P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>&amp;Backup</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>Label</TT> </P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Name</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Label4</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">&nbsp;</TD>
<TD class="docTableCell" valign="top">
<P><TT>Text</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Options</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>Panel</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Name</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Panel1</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>CheckBox</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Name</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>chkReplaceDB</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">&nbsp;</TD>
<TD class="docTableCell" valign="top">
<P><TT>Text</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Replace Database?</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">&nbsp;</TD>
<TD class="docTableCell" valign="top">
<P><TT>Checked</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>True</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">
<P><TT>Command Button</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>Name</TT></P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>btnClose</TT></P>
</TD>
</TR>
<TR>
<TD class="docTableCell" valign="top">&nbsp;</TD>
<TD class="docTableCell" valign="top">
<P><TT>Text</TT> </P>
</TD>
<TD class="docTableCell" valign="top">
<P><TT>&amp;Close</TT></P>
</TD>
</TR>
</COLGROUP>
</TABLE></P></span></LI><LI><span style="font-weight:normal" value="2"><P>On the form, add the code in Listing 7.14 to the Load event. This will look familiar from the first How-To. For an examination of the LoadSQLServers routine, check out step 4 in How-To 7.1.</P>
<H5 class="docExampleTitle">Listing 7.14 <TT>frmHowTo7_3.vb</TT>: Calling the Routine That Loads Available SQL Servers into a List Box</H5>
<PRE>
Private Sub frmHowTo7_3_Load(ByVal sender As System.Object, _
                        ByVal e As System.EventArgs) Handles MyBase.Load

        '-- Load up the SQL Servers
        LoadSQLServers(Me.lstSQLServers)

End Sub
</PRE></span></LI><LI><span style="font-weight:normal" value="3"><P>On the lstSQLServers list box, add the code in Listing 7.15 to the <TT>SelectedIndexChanged</TT> event. This routine calls both <TT>GetSQLDatabases</TT>, described in step 6 of How-To 7.1, and <TT>GetBackupDevices</TT>, described in step 4 of How-To 7.2.</P>
<H5 class="docExampleTitle">Listing 7.15 <TT>frmHowTo7_3.vb</TT>: Populating the lstDatabases and lstBackupDevices List Boxes</H5>
<PRE>
Private Sub lstSQLServers_SelectedIndexChanged(ByVal sender As System.Object,
                    ByVal e As System.EventArgs) _
                   Handles lstSQLServers.SelectedIndexChanged

        GetSQLDatabases(Me.lstSQLServers.SelectedItem, Me.lstDatabases)
        GetBackupDevices(Me.lstSQLServers.SelectedItem, Me.lstBackupDevices)

End Sub
</PRE></span></LI><LI><span style="font-weight:normal" value="4"><P>On the btnRestore button, add the code in Listing 7.16 to the <TT>Click</TT> event. After logging into the server, the <TT>Restore</TT> object is created and its properties are set from the form. The <TT>SQLRestore</TT> method is invoked and the connection is closed.</P>
<H5 class="docExampleTitle">Listing 7.16 <TT>frmHowTo7_3.vb</TT>: Performing the Backup</H5>
<PRE>
Private Sub btnRestore_Click(ByVal sender As System.Object, _
                        ByVal e As System.EventArgs) Handles btnRestore.Click

        '-- Create a connection to the server
        Dim osvr As New SQLDMO.SQLServer()
        osvr.LoginSecure = True
        osvr.Connect(Me.lstSQLServers.SelectedItem)

        '-- Create the restore object, set the properties from the form,
        '   and execute the restore.
        Dim oRestore As New SQLDMO.Restore()

        With oRestore

            .Action = SQLDMO.SQLDMO_RESTORE_TYPE.SQLDMORestore_Database
            .Database = Me.lstDatabases.SelectedItem
            .Devices = "[" &amp; Me.lstBackupDevices.SelectedItem &amp; "]"
            .ReplaceDatabase = Me.chkReplaceDB.Checked
            .SQLRestore(osvr)

        End With

        '-- Disconnect and clean up.
        osvr.DisConnect()

        osvr = Nothing
        oRestore = Nothing

        MessageBox.Show("Database Restored", "Task Completed", _
                                                MessageBoxButtons.OK)

End Sub
</PRE></span></LI><LI><span style="font-weight:normal" value="5"><P>Add the code in Listing 7.17 to the Click event of btnClose.</P>
<H5 class="docExampleTitle">Listing 7.17 <TT>frmHowTo7_3.vb</TT>: Performing the Backup</H5>
<PRE>
Private Sub btnClose_Click(ByVal sender As System.Object, _
                    ByVal e As System.EventArgs) Handles btnClose.Click

        Me.Close()

End Sub
</PRE></span></LI></OL></span>
<H4 class="docSection2Title"> How It Works</H4>
<P>The <TT>Restore</TT> object is the counter object to the <TT>Backup</TT> object, allowing you to restore databases that have been backed up. As with the <TT>Backup</TT> object, you can either specify the properties yourself or let the user choose them on the form.</P>
<H4 class="docSection2Title"> Comments</H4>
<P>Again, you need to be careful which options you let the user specify and which you specify yourself. This is a utility that you might want to secure; only let an administrator have access to it so that users don't accidentally overwrite a good database with an old one.</P>
<P>As with the backup, you could enhance this utility by allowing the user to specify a file to restore from instead of a backup device.</P>
<ul></ul>
</body></html>
