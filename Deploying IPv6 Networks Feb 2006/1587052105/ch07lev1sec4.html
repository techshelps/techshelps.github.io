<html>
<META http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
<head>
<title>Topology Examples</title>
<link rel="STYLESHEET" type="text/css" href="images/style.css">
<link rel="STYLESHEET" type="text/css" href="images/docsafari.css">
</head>
<body>
<table width="100%" border="0" cellspacing="0" cellpadding="0">
<tr><td><div STYLE="MARGIN-LEFT: 0.15in;">
<a href=ch07lev1sec3.html><img src="images/prev.gif" width="60" height="17" border="0" align="absmiddle" alt="Previous Page"></a>
<td align="right"><div STYLE="MARGIN-LEFT: 0.15in;">
<a href=ch08.html><img src="images/next.gif" width="60" height="17" border="0" align="absmiddle" alt="Next Page"></a>
</div></td></tr></table>
<br><table width="100%" border="0" cellspacing="0" cellpadding="0"><TR><TD valign="top"><a name="ch07lev1sec4"></a>
<H3 class="docSection1Title">Topology Examples</h3>
<p class="docText"><a name="iddle1167"></a><a name="iddle1216"></a><a name="iddle1449"></a>This section provides VPNv6 topology examples and relevant configurations. The first one is a CE-based VPNv6 example; the remaining examples are PE-based BGP-MPLS IPv6 VPN topologies, starting with a basic topology, then moving forward to more complex cases such as dual-stack VPNs, route reflectors, hub and spoke, Internet access, and inter-AS.</p>
<a name="ch07lev2sec18"></a>
<h4 class="docSection2Title">Using IPsec to Secure IPv6 over an IPv4 Tunnel</h4>
<p class="docText">In this example, a preexisting IPv4 IPsec tunnel is used to create an IPv6 VPN. The tunnel type used is an IPv6 manually configured. <a class="docLink" href="#ch07fig07">Figure 7-7</a> illustrates the relevant topology.</p>
<a name="ch07fig07"></a><p><center>
<h5 class="docFigureTitle">Figure 7-7. Multiprotocol VRF</h5>
<p class="docText"><div class="v1"><a target="_self" href="images/07fig07_alt.jpg">[View full size image]</a></div><img border="0" alt="" width="500" height="370" SRC="images/07fig07.jpg"></p>
</center></p><br>
<p class="docText"><a class="docLink" href="#ch07ex14">Example 7-14</a> shows CE1's (<a class="docLink" href="#ch07fig07">Figure 7-7</a>) configuration. The key elements of the configuration are preceded by highlighted comments.</p>
<a name="ch07ex14"></a><H5 class="docExampleTitle">Example 7-14. IPv6 over IPv4 IPsec Tunnel Configuration</h5><p><table cellspacing="0" width="90%" border="1" cellpadding="5"><TR><TD>


<pre>hostname CE1
ipv6 unicast-routing
ipv6 cef
<span class="docEmphMark">!IPsec configuration for the IPv4 tunnel</span>
crypto isakmp policy 1
 authentication pre-share
 group 2
crypto isakmp key SECRET address 10.1.1.2
crypto ipsec transform-set IPSEC ah-sha-hmac esp-des
!
crypto map IPV6TUNNEL 10 ipsec-isakmp
 set peer 9.100.17.1
 set transform-set IPSEC
 match address 100
!
<span class="docEmphMark">!Configuration of the IPv6 over ipv4 manual tunnel</span>
interface Tunnel0
 no ip address
 ipv6 address 2001:100:2:1000::72a
 tunnel source Serial0/0
 tunnel destination 9.200.17.1
 tunnel mode ipv6ip
 crypto map IPV6TUNNEL
!
interface Loopback0
 ip address 200.14.14.1. 255.255.255.0
 !
interface Serial0/0
 ip address 9.100.27.1 255.255.255.0
 crypto map IPV6TUNNEL
!
router bgp 1001
  neighbor 2001:100:2:1000::72e remote-as 1001
  neighbor 9.100.27.2 remote-as 100
!
<span class="docEmphMark">! Configure eBGP-IPv4 to peer with the SP</span>
 address-family ipv4
 neighbor 9.100.27.2 activate
!
<span class="docEmphMark">! Configure an iBGP-IPv6 routing protocol over the IPsec tunnel</span>
 address-family ipv6
 neighbor 2001:100:2:1000::72e activate
 network 2001:100:1::1000::/56
!
<span class="docEmphMark">!Configure an extended IP access_list to allow IPv6 traffic</span>
access-list 100 permit 41 host 9.100.27.1 host 9.100.17.1</pre><br>

</td></tr></table></p>

<a name="ch07lev2sec19"></a>
<H4 class="docSection2Title">Basic MPLS VPNv6 Topology</h4>
<p class="docText"><a name="iddle1131"></a><a name="iddle1676"></a><a name="iddle1739"></a>The basic MPLS VPNv6 topology corresponds to an SP connecting two customer sites over its MPLS backbone. <a class="docLink" href="#ch07fig08">Figure 7-8</a> shows the steps necessary to design and configure the MPLS IPv6 VPN in the provider network.</p>
<a name="ch07fig08"></a><p><center>
<h5 class="docFigureTitle">Figure 7-8. Steps for Configuring the Provider Routers to Enable MPLS VPNv6</H5>
<p class="docText"><div class="v1"><a target="_self" href="images/07fig08_alt.jpg">[View full size image]</a></div><img border="0" alt="" width="500" height="353" SRC="images/07fig08.jpg"></P>
</center></P><br>
<p class="docText"><span class="docEmphStrong">Step 1</span> focuses on configuring the core MPLS network. This is not needed if the core network already runs MPLS to provide VPNv4 service. For details on how to set up an MPLS network, refer to the book <span class="docEmphasis">MPLS and VPN Architectures</span>.</p>
<p class="docText"><span class="docEmphStrong">Step 2</span> is driven by the customer needs and requirements. Typically, a new customer triggers the design and configuration of one or more VRFs per PE routers facing customer sites. The VRF configuration is essentially a matter of network design, similar to what is involved in configuring VRFs for VPNv4. VRF design is an important part of a migration scenario for those SPs that want to offer a VPNv6 service to their VPNv4 enterprise customers. Dual-stack VPNs are covered in a subsequent topology example, and the migration scenario is studied in detail in <a class="docLink" href="ch13.html#ch13">Chapter 13</a>.</p>
<p class="docText"><a class="docLink" href="#ch07fig09">Figure 7-9</a> shows a basic VRF configuration, where each PE (PE1 and PE2) is attached to two sites, and three VPNs are designed (VPN-A, VPN-B and VPN-C).</p>
<a name="ch07fig09"></a><p><center>
<h5 class="docFigureTitle">Figure 7-9. Basic VRF Configuration</h5>
<p class="docText"><div class="v1"><a target="_self" href="images/07fig09_alt.jpg">[View full size image]</a></div><img border="0" alt="" width="500" height="273" SRC="images/07fig09.jpg"></p>
</center></p><br>
<p class="docText"><span class="docEmphStrong">Step 3</span> involves peering the PEs together. In the simple case, this is accomplished by a direct PE-PE peering. More often, however, this is done via one or more route reflectors. In the following example, the MPLS core network is IPv4 based, and the iBGP peer endpoints are IPv4 loopback (/32) addresses, configured at each PE and distributed by the IGP (OSPF, for instance) inside the provider network. <a class="docLink" href="#ch07ex15">Example 7-15</a> illustrates the relevant configuration at PE1 (<a class="docLink" href="#ch07fig09">Figure 7-9</a>).</p>
<a name="ch07ex15"></a><h5 class="docExampleTitle">Example 7-15. BGP VPNv6 Peering Configuration</h5><p><table cellspacing="0" width="90%" border="1" cellpadding="5"><TR><TD>


<pre>hostname PE1
interface Loopback0
 ip address 200.11.11.1 255.255.255.255
!
router bgp 100
 neighbor 200.10.10.1 remote-as 100
 neighbor 200.10.10.1 update-source Loopback0
!
 address-family vpnv6
 neighbor 200.10.10.1 activate
 neighbor 200.10.10.1 send-community extended
 exit-address-family</pre><BR>

</TD></TR></table></p>
<p class="docText"><span class="docEmphStrong">Step 4</span> involves configuring routing between the PE and the CE. The simplest option is to configure static routes on the PE, using the <span class="docEmphStrong">ipv6 route</span> command. With this command, you have the option of specifying the VRF in which it applies, as well as the next hop. You have several options when choosing the next hop:</p>
<ul><li><p class="docList">A VRF interface:</p><div class="docText"><pre>ipv6 route vrf site1 2001:100:1:1000::/56 serial 0/0</pre></div></li><li><p class="docList">A next -hop address in the same VRF as the route being configured:</p><div class="docText"><pre>ipv6 route vrf site1 2001:100:1:1000::/56 2001:100:1:1000::72a</pre></div></li><li><p class="docList">A next-hop address in a different VRF:</p><div class="docText"><pre>ipv6 route vrf site2 2001:100:1:1000::/56 2001:100:2:1000::72a nexthop-
  vrf site3</pre></div></li></UL>
<p class="docText">Static routes are useful in deployments that involve stub sitesthat is, sites with only one access interface to the SP.</p>
<p class="docText">After static routes have been configured at the PE, they must be redistributed into MP-BGP, using the <span class="docEmphStrong">redistribute</span> command shown in <a class="docLink" href="#ch07ex16">Example 7-16</a>.</p>
<a name="ch07ex16"></a><H5 class="docExampleTitle">Example 7-16. Redistributing Static Route into BGP VRF</H5><p><table cellspacing="0" width="90%" border="1" cellpadding="5"><tr><td>


<pre>hostname PE1
router bgp 100
  address-family ipv6 vrf site1
     redistribute static</pre><br>

</TD></tr></table></p>
<p class="docText">Another option is to use eBGP between the PE and the CE. This option is attractive because all routes learned from the PE are automatically redistributed to remote PEs and then to CEs participating in a given VPN. In the example shown in <a class="docLink" href="#ch07fig09">Figure 7-9</a>, with four sites and three VPNs (VPN-A, VPN-B and VPN-C), you must configure the address family IPv6 for each VRF (site1 and site2 at PE1, site3 and site4 at PE2). <a class="docLink" href="#ch07ex17">Example 7-17</a> illustrates BGP configuration on PE1.</p>
<a name="ch07ex17"></a><h5 class="docExampleTitle">Example 7-17. Using eBGP on the PE-CE Interface</H5><P><table cellspacing="0" width="90%" border="1" cellpadding="5"><TR><td>


<pre>router bgp 100
 address-family ipv6 vrf site1
  neighbor 2001:100:1:1000::72a remote-as 65001
!
 address-family ipv6 vrf site2
  neighbor 2001:1001:2000::72a remote-as 65002</pre><br>

</td></tr></table></p>
<p class="docText">Along with the provider network configuration, the CE routers must be configured. From the CE routers' standpoint, the BGP configuration is a standard eBGP configuration, with no VRF reference.</p>
<p class="docText">The CE routers also participate in the site routing, and are therefore configured with an IPv6 IGP or static routes, and route redistribution between this IGP and eBGP.</p>
<p class="docText"><a class="docLink" href="#ch07ex18">Example 7-18</a> illustrates the corresponding eBGP configuration on CE1 at site1.</p>
<a name="ch07ex18"></a><h5 class="docExampleTitle">Example 7-18. eBGP Configuration Example at CE</h5><p><table cellspacing="0" width="90%" border="1" cellpadding="5"><tr><td>


<pre>hostname CE1
router bgp 65001
neighbor 2001:100:1:1000::72b remote-as 100
 address-family ipv6
 neighbor 2001:100:1:1000::72b activate
 redistribute ospf 1</pre><br>

</TD></TR></table></P>

<a name="ch07lev2sec20"></a>
<H4 class="docSection2Title">Dual-Stack VPNs</H4>
<p class="docText"><a name="iddle1132"></a><a name="iddle1294"></a><a name="iddle1677"></a>Dual-stack VPNs are likely to be predominant in many of the MPLS IPv6 VPN deployment scenarios. As defined earlier, a dual-stack VPN connects IPv4-enabled sites together and IPv6-enabled sites together. In a typical deployment scenario, an MPLS SP will have to enable IPv6 on already-deployed IPv4 VPNs because existing customers will have migrated some or all of their sites to dual stack (IPv4 and IPv6). In such a scenario, the following provisioning steps must be taken:</p>
<a name="ch07pro03"></a>



<table border="0" class="docText"><tr><td width="25" valign="top"><div class="docText"><b>1. </b></div></td><td><div class="docText">By the customer: Migrate site (or part of it) to dual stack, and configure CE-PE interface with IPv6.<br><br>
</div></td></tr><tr><td width="25" valign="top"><div class="docText"><B>2. </b></div></td><td><div class="docText">By the SP: Migrate PE routers to dual stack, migrate existing IPv4 VRFs to dual-stack VRF (including specific IPv6 VRF policies configuration if any), and configure PE-CE interface with IPv6.<BR><BR>
</div></td></tr><tr><td width="25" valign="top"><div class="docText"><B>3. </b></div></td><td><div class="docText">By the SP: Enable MP-BGP VPNv6 address family between PE pairs connecting IPv6-enabled sites.<br><br>
</div></TD></TR></table>
<p class="docText"><a class="docLink" href="#ch07fig10">Figure 7-10</a> shows the topology of a dual-stack VPN.</P>
<a name="ch07fig10"></a><p><center>
<h5 class="docFigureTitle">Figure 7-10. Dual-Stack VPN</h5>
<p class="docText"><div class="v1"><a target="_self" href="images/07fig10_alt.jpg">[View full size image]</a></div><img border="0" alt="" width="500" height="386" SRC="images/07fig10.jpg"></p>
</center></p><br>
<p class="docText"><a name="iddle1141"></a><a name="iddle1686"></a><a name="iddle1807"></a><a class="docLink" href="#ch07ex19">Example 7-19</a> illustrates the BGP configuration of a dual-stack VPN (IPv6-related configuration highlighted).</p>
<a name="ch07ex19"></a><h5 class="docExampleTitle">Example 7-19. BGP Configuration of Dual-Stack VPN</h5><p><table cellspacing="0" width="90%" border="1" cellpadding="5"><tr><td>


<pre>hostname PE1
router bgp 100
neighbor 200.10.10.1 remote-as 100
neighbor 200.10.10.1 update-source Loopback0
 address-family ipv4 vrf site1
  neighbor 10.100.1.1 remote-as 100
  neighbor 10.100.1.1 activate
!
 <span class="docEmphMark">address-family ipv6 vrf site1</span>
  <span class="docEmphMark">neighbor 2001:100:1:1000::72a remote-as 100</span>
  <span class="docEmphMark">neighbor 2001:100:1:1000::72a activate</span>
!
 address-family vpnv4
 neighbor 200.10.10.1 activate
 neighbor 200.10.10.1 send-community extended
!
<span class="docEmphMark">address-family vpnv6</span>
  <span class="docEmphMark">neighbor 200.10.10.1 activates</span>
  <span class="docEmphMark">neighbor 200.10.10.1 send-community extended</span></pre><br>

</td></TR></table></P>
<p class="docText">And <a class="docLink" href="#ch07ex20">Example 7-20</a> shows the VRF configuration.</P>
<a name="ch07ex20"></a><H5 class="docExampleTitle">Example 7-20. Configuration Example of Dual-Stack VRF</H5><p><table cellspacing="0" width="90%" border="1" cellpadding="5"><tr><td>


<pre>vrf definition site1
 rd 100:1
 route-target import 100:1
 route-target export 100:1
 address-family ipv4
 <span class="docEmphMark">address-family ipv6</span>
!
interface serial0/0
vrf forwarding site1
ip address 10.100.1.2 255.255.0.0
<span class="docEmphMark">ipv6 address 2001:100:1:1000::72b/64</span></pre><br>

</td></tr></table></p>

<a name="ch07lev2sec21"></a>
<h4 class="docSection2Title">Route Reflectors</h4>
<p class="docText">Route reflectors are discussed in the &quot;<a class="docLink" href="ch07lev1sec3.html#ch07lev2sec16">Scaling IPv6 VPN</a>&quot; section. <a class="docLink" href="#ch07fig11">Figure 7-11</a> shows a simple topology with route reflectors.</p>
<a name="ch07fig11"></a><p><center>
<h5 class="docFigureTitle">Figure 7-11. Route Reflectors Topology</H5>
<p class="docText"><div class="v1"><a target="_self" href="images/07fig11_alt.jpg">[View full size image]</a></div><img border="0" alt="" width="500" height="219" SRC="images/07fig11.jpg"></p>
</center></p><BR>
<p class="docText"><a name="iddle1134"></a><a name="iddle1408"></a><a name="iddle1679"></a><a class="docLink" href="#ch07ex20">Example 7-20</a> is an example of route reflector configuration.</P>
<a name="ch07ex21"></a><h5 class="docExampleTitle">Example 7-21. Route Reflector Configuration Example</h5><p><table cellspacing="0" width="90%" border="1" cellpadding="5"><tr><TD>


<pre>router bgp 101
 no bgp default route-target filter
 neighbor 200.11.11.1 remote-as 101
 neighbor 200.10.10.1 remote-as 101
 neighbor 200.11.11.1 update-source Loopback0
 neighbor 200.10.10.1 update-source Loopback0
address-family vpnv6
 neighbor 200.11.11.1 activate
 <span class="docEmphMark">neighbor 200.11.11.1 route-reflector-client</span>
 neighbor 200.11.11.1 send-community extended
 neighbor 200.10.10.1 activate
 <span class="docEmphMark">neighbor 200.10.10.1 route-reflector-client</span>
 neighbor 200.10.10.1 send-community extended</pre><br>

</td></tr></table></p>
<p class="docText">Note that <span class="docEmphStrong">no bgp default route-target filter</span> command is necessary on the route reflector, because it does not maintain a VRF table (unless it is also a regular PE), and would not keep any entry otherwise, as described in the &quot;<a class="docLink" href="ch07lev1sec3.html#ch07lev2sec16">Scaling IPv6 VPN</a>&quot; section.</P>
<p class="docText">Another remarkable element of the preceding configuration is that neither the IPv6 address nor IPv6 routing protocol need to be configured at the route reflector, if the SP chooses to deploy it in an IPv4-based backbone (6VPE). The only IPv6 configuration is in the VPNv6 address family under the BGP router configuration. It is still required to enable the address family, however, because route reflection is on a per-AFI/SAFI basis.</P>

<a name="ch07lev2sec22"></a>
<H4 class="docSection2Title">Hub and Spoke</h4>
<p class="docText">Hub-and-spoke topology is one of the most widely deployed network topologies with VPNv4, and there is no reason why it should not be the same with VPNv6. Large corporations, with multiple sites distributed across the SP backbone, may want to centralize services such as Internet access, firewalls, server farms, and so on. To achieve this, a hub site is deployed with all the other sites forwarding traffic to it. <a class="docLink" href="#ch07fig12">Figure 7-12</a> shows this topology.</p>
<a name="ch07fig12"></a><p><center>
<h5 class="docFigureTitle">Figure 7-12. Hub-and-Spoke Topology</h5>
<p class="docText"><div class="v1"><a target="_self" href="images/07fig12_alt.jpg">[View full size image]</a></div><img border="0" alt="" width="500" height="500" SRC="images/07fig12.jpg"></p>
</center></p><br>
<p class="docText"><a class="docLink" href="#ch07ex22">Example 7-22</a> illustrates the BGP configuration of the Paris PE hub router.</p>
<a name="ch07ex22"></a><h5 class="docExampleTitle">Example 7-22. BGP VPNv6 Hub-and-Spoke Configuration Example</h5><p><table cellspacing="0" width="90%" border="1" cellpadding="5"><tr><td>


<pre><span class="docEmphMark">!Peering to each spoke site</span>
address-family vpnv6
 neighbor 200.11.11.1 activate
 neighbor 200.11.11.1 send-community extended
 neighbor 200.17.17.1 activate

 neighbor 200.17.17.1 send-community extended
<span class="docEmphMark">!Peering to Paris central site CE hub</span>
 address-family ipv6 vrf red-spoke
 neighbor 2001:2006::16 remote-as 400
 neighbor 2001:2006::16 activate
 neighbor 2001:2006::16 allowas-in 2
<span class="docEmphMark">!Peering to Paris central site CE spoke</span>
 address-family ipv6 vrf red-hub
 neighbor 2001:2005::15 remote-as 400
 neighbor 2001:2005::15 activate
 neighbor 2001:2005::15 allowas-in 2</pre><BR>

</TD></TR></table></P>
<p class="docText"><a name="iddle1135"></a><a name="iddle1680"></a>As shown in <a class="docLink" href="#ch07ex23">Example 7-23</a>, a <span class="docEmphStrong">traceroute</span> command, initiated at one of the spoke sites (London-CE), shows the path used by traffic between spoke sites (the hops are highlighted).</P>
<a name="ch07ex23"></a><h5 class="docExampleTitle">Example 7-23. Traceroute Output Throughout the Hub-and-Spoke Topology</h5><p><table cellspacing="0" width="90%" border="1" cellpadding="5"><tr><td>


<pre>London-CE#<span class="docEmphStrong">traceroute  2001:201::1</span>
  1 <span class="docEmphMark">London-PE-spoke</span> 2001:100::11
  2 <span class="docEmphMark">P</span>               ::FFFF:40.1.1.13 [MPLS: Labels 16/36 Exp 0]
  3 <span class="docEmphMark">Paris-PE-hub</span>    2001:2006::10 [AS 100] [MPLS: Label 36 Exp 0]
  4 <span class="docEmphMark">Paris-CE-hub</span>    2001:2006::16 [AS 100]
  5 <span class="docEmphMark">Paris-CE-spoke</span>  2001:2001::15 [AS 400]
  6 <span class="docEmphMark">Paris-PE-hub</span>    2001:2005::10 [AS 400]
  7 <span class="docEmphMark">P</span>               ::FFFF:42.1.1.3 [MPLS: Labels 17/25 Exp 0]
  8 <span class="docEmphMark">Nice-PE-spoke</span>   2001:200::17 [AS 100] [MPLS: Label 25 Exp 0]
  9 <span class="docEmphMark">Nice-CE</span>         2001:200::18 [AS 100]</pre><br>

</td></tr></table></p>
<p class="docText">Note that P-routers have not been configured with an IPv6 address and must use an IPv4-mapped address (::FFFF:42.1.1, in this example) to source their ICMPv6 &quot;time-exceeded&quot; messages.</p>

<a name="ch07lev2sec23"></a>
<h4 class="docSection2Title">Internet Access</h4>
<p class="docText">Most VPN sites require access to the Internet. Internet Draft draft-ietf-l3vpn-rfc2547bis describes in section 11 a set of models for enabling VPN access to the Internet. All these models (1 to 4) apply to IPv6 VPNs, too. Some are straightforward, such as model 1, in which an interface is used by the CE to connect to the Internet and a different one to connect to the VRF. In model 4 of section 11, all Internet routes are redistributed into the VRF. This approach has the disadvantage of requiring the Internet routes to be replicated in each VRF.</P>
<p class="docText">In the case of model 3, a static route is inserted into the VRF table, with a next hop that points to the Internet gateway, found in the IPv6 default table. <a class="docLink" href="#ch07fig13">Figure 7-13</a> shows a scenario in which Internet access is provided to the customer in VRF red based on model 3.</p>
<a name="ch07fig13"></a><p><center>
<H5 class="docFigureTitle">Figure 7-13. Internet Access Topology</H5>
<p class="docText"><div class="v1"><a target="_self" href="images/07fig13_alt.jpg">[View full size image]</a></div><img border="0" alt="" width="500" height="360" SRC="images/07fig13.jpg"></p>
</center></p><br>
<p class="docText">For outbound traffic, the default route configured in the VRF table (red) at PE1 directs traffic for destinations outside the VPN to the Internet gateway. <a class="docLink" href="#ch07ex24">Example 7-24</a> shows PE1's relevant configuration in this scenario.</p>
<a name="ch07ex24"></a><H5 class="docExampleTitle">Example 7-24. Internet Access: (PE ) Static Route to Internet Gateway</h5><p><table cellspacing="0" width="90%" border="1" cellpadding="5"><tr><td>


<pre>PE1#<span class="docEmphStrong">show running</span>
ipv6 route vrf red ::/0 2001:BEEF:14::1 nexthop-vrf default
PE1#<span class="docEmphStrong">show ipv6 route vrf red</span>
S   ::/0 [1/0]
     via 2001:BEEF:14::1%default
The next hop (2001:BEEF:14::1) is in the default routing table:
PE1#<span class="docEmphStrong">show ipv6 route</span>
B   2001:BEEF:14::1/128 [200/0]
     via 200.14.14.1%Default-IP-Routing-Table, indirectly connected</pre><BR>

</TD></TR></table></p>
<p class="docText">It is expected that this next hop has been advertised by the Internet gateway (for instance, over MP-iBGP), based on the configuration in <a class="docLink" href="#ch07ex25">Example 7-25</a>.</p>
<a name="ch07ex25"></a><h5 class="docExampleTitle">Example 7-25. Internet Access: (Internet Gateway) BGP Configuration</h5><p><table cellspacing="0" width="90%" border="1" cellpadding="5"><tr><td>


<pre>IGW#<span class="docEmphStrong">show running</span>
router bgp 100
 address-family ipv6
 neighbor 200.11.11.1 activate
 neighbor 200.11.11.1 send-label
 network 2001:BEEF:14::1/128</pre><br>

</td></tr></table></p>
<p class="docText">For inbound traffic, a route must exist at the Internet gateway to direct the traffic for customer site (site1 in <a class="docLink" href="#ch07fig13">Figure 7-13</a>) via its PE of attachment (PE1 above). Assuming that site1 global prefix is 2001:100:1:1000::/64, the following route in <a class="docLink" href="#ch07ex26">Example 7-26</a> should be configured on the Internet gateway.</p>
<a name="ch07ex26"></a><h5 class="docExampleTitle">Example 7-26. Internet Access: (Internet Gateway) Route to the PE</h5><P><table cellspacing="0" width="90%" border="1" cellpadding="5"><TR><TD>


<pre>IGW#<span class="docEmphStrong">show ipv6 route</span>
IPv6 Routing Table - default - 6 entries
B   2001:100:1:1000 ::/56 [200/0]
     via 200.11.11.1%Default-IP-Routing-Table, indirectly connected</pre><BR>

</TD></tr></table></p>
<p class="docText">This route can be distributed by PE1, via MP-iBGP (IPv6 address family), so no specific configuration needs to be done on per-VPN PE basis at the Internet gateway. Nevertheless, for inbound traffic at PE1, a route must exist in the default table, for site1 global prefix (2001:100:1:1000::/64), pointing to site1 VRF.</p>
<a name="ch07ex27"></a><h5 class="docExampleTitle">Example 7-27. Internet Access: (PE) Route to Customer Site</h5><p><table cellspacing="0" width="90%" border="1" cellpadding="5"><tr><td>


<pre>PE1#<span class="docEmphStrong">show running</span>
ipv6 route 2001:100:1:1000::/56 2001:100:1:1000::72a/64 nexthop-vrf red
PE1#<span class="docEmphStrong">show ipv6 route</span>
IPv6 Routing Table - default - 5 entries
S  2001:100:1:1000::/56 [1/0]
     via 2001:100:1:1000::72a%red</pre><br>

</td></tr></table></p>
<p class="docText"><a class="docLink" href="#ch07ex28">Example 7-28</a> shows the BGP configuration for PE1.</P>
<a name="ch07ex28"></a><h5 class="docExampleTitle">Example 7-28. Internet Access: (PE) BGP Configuration Example</h5><P><table cellspacing="0" width="90%" border="1" cellpadding="5"><TR><td>


<pre>router bgp 100
<span class="docEmphMark">! Peering with remote VPN site</span>
 address-family vpnv6
 neighbor 200.10.10.1 activate
 neighbor 200.10.10.1 send-community extended
<span class="docEmphMark">! Peering with internet Gateway</span>
 address-family ipv6
 neighbor 200.14.14.1 activate
 neighbor 200.14.14.1 send-label
 network 2001:100:1:1000::/56
<span class="docEmphMark">! Peering with local VPN site</span>
 address-family ipv6 vrf red
 neighbor 2001:100:1:1000::72a remote-as 200
 neighbor 2001:100:1:1000::72a activate</pre><br>

</td></tr></table></P>

<a name="ch07lev2sec24"></a>
<h4 class="docSection2Title">Interprovider VPNs</h4>
<p class="docText"><a name="iddle1136"></a><a name="iddle1437"></a><a name="iddle1681"></a>The challenge with interprovider VPNs is similar for IPv6 and IPv4, assuming IPv6 is deployed everywhere IPv4 is. That, however, is not the situation today.</p>
<p class="docText">In IPv6 deployments crossing AS boundaries, providers have to pick up a peering model. <a class="docLink" href="#ch07fig14">Figure 7-14</a> shows the interprovider scenarios (A, B, and C, specified in draft-ietf-l3vpn-rfc2547bis, section 10) in the VPNv6 case.</p>
<a name="ch07fig14"></a><P><center>
<H5 class="docFigureTitle">Figure 7-14. Interprovider Scenarios</H5>
<p class="docText"><div class="v1"><a target="_self" href="images/07fig14_alt.jpg">[View full size image]</a></div><img border="0" alt="" width="500" height="560" SRC="images/07fig14.jpg"></p>
</center></p><br>
<p class="docText">Depending on the network protocol used between ASBRs, the three scenarios described in draft-ietf-l3vpn-rfc2547bis, section 10, can face several implementation options. For instance, scenario B, which suggests an MP-eBGP-VPNv6 peering between ASBRs, could use an IPv6 link, or an IPv4 link. The following example illustrates these two cases. If the peering between ASBRs is performed over an IPv4 link, the BGP configuration on ASBR1 is as shown in <a class="docLink" href="#ch07ex29">Example 7-29</a>.</p>
<a name="ch07ex29"></a><h5 class="docExampleTitle">Example 7-29. Inter-AS BGP Configuration, Scenario B, ASBRs Peering over IPv4</h5><p><table cellspacing="0" width="90%" border="1" cellpadding="5"><tr><td>


<pre>router bgp 1001
 no bgp default ipv4-unicast
 no bgp default route-target filter
 neighbor 40.1.1.1 remote-as 1002
 neighbor 200.11.11.1 remote-as 1001
 neighbor 200.11.11.1 update-source Loopback1
 !
 address-family vpnv6
<span class="docEmphMark">!Peering to ASBR2 over an IPv4 link</span>
 neighbor 40.1.1.1 activate
 neighbor 40.1.1.1 send-community extended
<span class="docEmphMark">!Peering to PE1 over an IPv4 link</span>
 neighbor 200.11.11.1 activate
 neighbor 200.11.11.1  next-hop-self
 neighbor 200.11.11.1 send-community extended</pre><br>

</td></tr></table></p>
<p class="docText">If the peering between ASBRs is performed over an IPv6 link, the BGP configuration on ASBR1 is as shown in <a class="docLink" href="#ch07ex30">Example 7-30</a>.</p>
<a name="ch07ex30"></a><H5 class="docExampleTitle">Example 7-30. Inter-AS BGP Configuration, Scenario B, ASBRs Peering over IPv6</H5><P><table cellspacing="0" width="90%" border="1" cellpadding="5"><TR><TD>


<pre>router bgp 1001
neighbor 2001:101::72d remote-as 1002
!
 address-family vpnv6
<span class="docEmphMark">!Peering to ASBR2 over an IPv6 link</span>
 neighbor 2001:101::72d  activate
 neighbor 2001:101::72d send-community extended</pre><br>

</td></tr></table></p>
<p class="docText">In inter-AS scenario C, multihop MP-eBGP redistributes VPNv6 routes across route reflectors in different autonomous systems. Labeled IPv4 routes to the PEs (in the 6VPE case) need to be advertised across ASBRs so that a complete LSP is set up end to end. <a class="docLink" href="#ch07fig15">Figure 7-15</a> shows inter-AS scenario C, both routing and forwarding paths.</p>
<a name="ch07fig15"></a><p><center>
<h5 class="docFigureTitle">Figure 7-15. Inter-AS Scenario C</h5>
<p class="docText"><div class="v1"><a target="_self" href="images/07fig15_alt.jpg">[View full size image]</a></div><img border="0" alt="" width="500" height="314" SRC="images/07fig15.jpg"></p>
</center></p><br>
<p class="docText">The label stack computed at ingress PE (PE2) contains the following labels:</p>
<UL><li><p class="docList">Label (Ld) to reach the first P-router in the same AS, and get to the ASBR (ASBR2)</p></LI><LI><p class="docList">Label (L3) to traverse the AS boundary as a labeled packet</p></li><li><p class="docList">Label (L1) to be switched at egress PE (PE1) to the VRF interface</p></LI></ul>
<p class="docText">On PE1, you can display the label stack imposed by the forwarding plane (CEF) to reach a destination (2001::2::1) located in remote VRF blue, as shown in <a class="docLink" href="#ch07ex31">Example 7-31</a>.</p>
<a name="ch07ex31"></a><h5 class="docExampleTitle">Example 7-31. Inter-AS: Example of Three-Label Stack at the PE (Scenario C)</h5><P><table cellspacing="0" width="90%" border="1" cellpadding="5"><TR><TD>


<pre>pe1#<span class="docEmphStrong">show ipv6 cef vrf blue</span>
2001:201::/64
  nexthop 10.1.1.2 Serial0/0 label 20 19 22</pre><br>

</td></tr></table></p>
<p class="docText">In <a class="docLink" href="#ch07ex31">Example 7-31</a>, the values of labels Ld, L3, L1 are 20, 19, 22.</p>
<p class="docText">The commands in the following examples highlight the origin of each label.</p>
<ul><li><p class="docList"><a class="docLink" href="#ch07ex32">Example 7-32</a> is used to display to bottom label, L1 (22), used to identify the VRF interface at PE2.</p><a name="ch07ex32"></a><h5 class="docExampleTitle">Example 7-32. Inter-AS: Looking at Bottom (BGP VPNv6) Label</h5><p><table cellspacing="0" width="90%" border="1" cellpadding="5"><tr><td>


<pre>PE1#<span class="docEmphStrong">show bgp vpnv6 uni all 2001:201::/64</span>
BGP routing table entry for [200:1]2001:201::/64, version 4
Paths: (1 available, best #1, table blue)
  Not advertised to any peer
  200 65502
    ::FFFF:7.7.7.7 (metric 20) from 2.2.2.2 (2.2.2.2)
      Origin incomplete, metric 0, localpref 100, valid, internal, best
      Extended Community: RT:200:1,
      mpls labels in/out nolabel/<span class="docEmphMark">22</span></pre><BR>

</TD></TR></table></P></LI><li><p class="docList"><a class="docLink" href="#ch07ex33">Example 7-33</a> is used to display the middle label, L3 (19), used to traverse the autonomous system boundary.</p><a name="ch07ex33"></a><h5 class="docExampleTitle">Example 7-33. Inter-AS: Looking at Middle (BGP IPv4) Label</h5><p><table cellspacing="0" width="90%" border="1" cellpadding="5"><tr><td>


<pre>PE1#<span class="docEmphStrong">show bgp ipv4 unicast 7.7.7.7</span>
BGP routing table entry for 7.7.7.7/32, version 10
Paths: (1 available, best #1, table Default-IP-Routing-Table)
  Not advertised to any peer
  200
    90.1.1.2 (metric 20) from 2.2.2.2 (2.2.2.2)
      Origin IGP, metric 0, localpref 100, valid, internal, best
      Originator: 3.3.3.3, Cluster list: 2.2.2.2,
      mpls labels in/out nolabel/19</pre><br>

</td></tr></table></p></li><LI><p class="docList"><a class="docLink" href="#ch07ex34">Example 7-34</a> is used to display to top label, Ld (20), used to traverse the local autonomous system.</p><a name="ch07ex34"></a><h5 class="docExampleTitle">Example 7-34. Inter-AS: Looking at Top (LDP) Label</H5><P><table cellspacing="0" width="90%" border="1" cellpadding="5"><tr><td>


<pre>PE1#<span class="docEmphStrong">show mpls ldp bindings 90.1.1.2 32</span>
  lib entry: 90.1.1.2/32, rev 16
        local binding:  label: 21
        remote binding: lsr: 30.1.1.2:0, label: <span class="docEmphMark">20</span></pre><br>

</td></TR></table></p></li></ul>
<p class="docText">Finally, it is possible to understand the recursion process by analyzing in detail the way Cisco Express Forwarding (CEF) has built the label stack, as shown in <a class="docLink" href="#ch07ex35">Example 7-35</a>.</p>
<a name="ch07ex35"></a><H5 class="docExampleTitle">Example 7-35. Inter-AS: Label Stack Recursive Resolution</H5><P><table cellspacing="0" width="90%" border="1" cellpadding="5"><tr><td>


<pre>PE1#<span class="docEmphStrong">show ipv6 cef vrf blue internal</span>
2001:2::/64, epoch 0, RIB
  sources: RIB
    <span class="docEmphMark">recursive via 7.7.7.7 label 22</span>
     <span class="docEmphMark">recursive via 90.1.1.2 label 19</span>
       <span class="docEmphMark">nexthop 10.1.1.2 Serial0/0 label 20,</span> adjacency IP adj out of Serial0/0
  output chain: label 22 label 19 label 20 TAG adj out of Serial0/0</pre><br>

</td></tr></table></p>
<p class="docText">The topology examples discussed in the last sections show the extent of the similarities between VPNv6 and VPNv4. Almost every topology found in the VPNv4 world has a correspondence in the VPNv6 world. The reverse is also true, except where coexistence leads to a more integrated scenario.</p>
<p class="docText">A full-scale IPv6 MPLS deployment is described in <a class="docLink" href="ch13.html#ch13">Chapter 13</a>. It integrates some of the configuration examples from this chapter into a complete, end-to-end IPv6 deployment case study.</p>


<a href="22971536.html"><img src="images/pixel.jpg" alt="" width="1" height="1" border="0"></a></TD></TR></table>
<br>
<table width="100%" border="0" cellspacing="0" cellpadding="0">
<tr><td><div STYLE="MARGIN-LEFT: 0.15in;">
<a href=ch07lev1sec3.html><img src="images/prev.gif" width="60" height="17" border="0" align="absmiddle" alt="Previous Page"></a>
<td align="right"><div STYLE="MARGIN-LEFT: 0.15in;">
<a href=ch08.html><img src="images/next.gif" width="60" height="17" border="0" align="absmiddle" alt="Next Page"></a>
</div></td></tr></table>
</body></html>