<html>
<META http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
<head>
<title>Operating and Troubleshooting the Network</title>
<link rel="STYLESHEET" type="text/css" href="images/style.css">
<link rel="STYLESHEET" type="text/css" href="images/docsafari.css">
</head>
<body>
<table width="100%" border="0" cellspacing="0" cellpadding="0">
<tr><td><div STYLE="MARGIN-LEFT: 0.15in;">
<a href=ch13lev1sec5.html><img src="images/prev.gif" width="60" height="17" border="0" align="absmiddle" alt="Previous Page"></a>
<td align="right"><div STYLE="MARGIN-LEFT: 0.15in;">
<a href=ch13lev1sec7.html><img src="images/next.gif" width="60" height="17" border="0" align="absmiddle" alt="Next Page"></a>
</div></td></tr></table>
<br><table width="100%" border="0" cellspacing="0" cellpadding="0"><tr><TD valign="top"><a name="ch13lev1sec6"></a>
<h3 class="docSection1Title" id="570594-920">Operating and Troubleshooting the Network</H3>
<p class="docText">For the most part, EuropCom plans to keep managing its network as before, using IPv4 tools, processes, Management Information Bases (MIBs), and transport. It sees IPv6 as a new service deployment rather than a replacement for IPv4. Therefore, it will be managed as a service (service monitoring, IPv6 traffic management, and so on), although the network itself will still be managed with the current IPv4 tools. Configuration management and topology management, for instance, will continue to be performed using HP OpenView. This strategy relies on the fact that most devices will be either IPv4 only or dual stack, and none will be IPv6 only.</P>
<ul><LI><p class="docList">The core routers are IPv4 only.</p></li><LI><p class="docList">The ASBRs are IPv4 only.</P></LI><li><p class="docList">The IPv4 RRs are IPv4 only.</p></li><LI><p class="docList">Many edge routers, especially in L3 POPs, are IPv4 only, and will remain that way until the first customer using such POP requests an IPv6 access.</p></li><LI><p class="docList">The IPv6 RRs have no IPv6-enabled interface, and no IPv6 addresses configured.</P></li></ul>
<a name="ch13lev2sec13"></a>
<h4 class="docSection2Title">Service and Traffic Monitoring</h4>
<p class="docText"><a name="iddle1070"></a><a name="iddle1576"></a><a name="iddle1904"></a>All the IPv6 services management will be performed over MPLS 6PE (all the IPv6 enabled devices have 6PE connectivity). Service availability will be monitored using Nagios (IPv6 ping) and IPv6 traffic management using Cisco Network Analysis Module (NAM). See <a class="docLink" href="ch10.html#ch10">Chapter 10</a>, &quot;IPv6 Network Management,&quot; for details.</P>

<a name="ch13lev2sec14"></a>
<h4 class="docSection2Title">Addressing</h4>
<p class="docText">EuropCom is a well-established ISP, with more than 200 IPv6 customers. Therefore, it could justify and obtain a /32 prefix from the RIPE/NCC (see <a class="docLink" href="ch12.html#ch12">Chapter 12</a>, &quot;Generic Deployment Planning Guidelines,&quot; for details on deployment planning), as illustrated in <a class="docLink" href="#ch13table09">Table 13-9</a>. The prefix allocated to EuropCom is 2001:6FC::/32.</P>
<a name="ch13table09"></a><p><table cellspacing="0" class="allBorders" border="1" RULES="all" cellpadding="4"><caption><H5 class="docTableTitle">Table 13-9. EuropCom Addressing Plan</h5></caption><colgroup><col width="200"><col width="300"></colgroup><thead><tr><th class="thead" scope="col" align="left" valign="bottom"><p class="docText">Descriptor</p></th><th class="thead" scope="col" align="left" valign="bottom"><p class="docText">Description</p></th></tr></thead><tr><td class="docTableCell" align="left" valign="top"><p class="docText">network:ID:</p></td><td class="docTableCell" align="left" valign="top"><p class="docText">NET-EUROPCOM</p></td></tr><tr><td class="docTableCell" align="left" valign="top"><p class="docText">network:Network-Name:</P></td><td class="docTableCell" align="left" valign="top"><p class="docText">EUROPCOM</p></TD></tr><TR><TD class="docTableCell" align="left" valign="top"><p class="docText">network:IP-Network:</p></TD><td class="docTableCell" align="left" valign="top"><p class="docText">2001:6FC::/32</p></TD></TR><TR><td class="docTableCell" align="left" valign="top"><p class="docText">network:Org-Name:</p></td><TD class="docTableCell" align="left" valign="top"><p class="docText">EuropCom</p></td></TR><TR><td class="docTableCell" align="left" valign="top"><p class="docText">network:Street-Address:</p></td><td class="docTableCell" align="left" valign="top"><p class="docText">1701 Nice street</P></td></tr><TR><td class="docTableCell" align="left" valign="top"><p class="docText">network:City:</P></td><td class="docTableCell" align="left" valign="top"><p class="docText">London</p></td></tr><tr><td class="docTableCell" align="left" valign="top"><p class="docText">network:State:</p></td><td class="docTableCell" align="left" valign="top"><p class="docText">UK</p></td></tr><tr><td class="docTableCell" align="left" valign="top"><p class="docText">network:Postal-Code:</P></td><td class="docTableCell" align="left" valign="top"><p class="docText">17203</p></TD></tr><TR><TD class="docTableCell" align="left" valign="top"><p class="docText">network:Country-Code:</p></TD><td class="docTableCell" align="left" valign="top"><p class="docText">44</p></TD></TR><TR><td class="docTableCell" align="left" valign="top"><p class="docText">network:Tech-Contact:</p></td><TD class="docTableCell" align="left" valign="top"><p class="docText"><a class="docLink" href="mailto:europcom-ops@europcom.net">europcom-ops@europcom.net</a></p></td></TR><TR><td class="docTableCell" align="left" valign="top"><p class="docText">network:Updates:</p></td><td class="docTableCell" align="left" valign="top"><p class="docText">20050505</P></td></tr><TR><td class="docTableCell" align="left" valign="top"><p class="docText">network:Updated-By:</P></td><td class="docTableCell" align="left" valign="top"><p class="docText"><a class="docLink" href="mailto:ela@europcom.net">ela@europcom.net</a></p></td></tr><tr><td class="docTableCell" align="left" valign="top"><p class="docText">network:Class-Name:network:</p></td><td class="docTableCell" align="left" valign="top"><p class="docText">network</p></td></tr></table></p><br>
<p class="docText">The EuropCom addressing plan is in full compliance with RFC2373.</P>
<p class="docText">EuropCom will keep 2001:6FC::/48 to use for its own infrastructure. It will assign up to/48 to large enterprise customers, and up to /56 to small business customers, out of its 2001:6FC::/32 block. Residential customers will each get a /64 prefix. Note that there is no fundamental difference whether the customers are VPN customers or IA customers. Allocated addresses will always be within the public range (2001:6FC::/32).</p>
<p class="docText">For large enterprise customers, the assigned prefix will be in the form 2001:6FC:1abc::/48, where abc identifies the customer.</p>
<p class="docText">Small enterprise customers will get 2001:6FC:2abc:defg::/56, where abc:defg identifies the customer (defg &gt; 0).</p>
<p class="docText"><a name="iddle1488"></a><a name="iddle2000"></a><a name="iddle2028"></a>EuropCom does not intend to &quot;enforce&quot; a routing policy that would <span class="docEmphasis">require</span> a customer to follow the preceding rule, other than making sure VPNv6 customers will not advertise more than a certain number of prefixes per PE.</P>
<a name="ch13lev3sec16"></a>
<h5 class="docSection3Title">Link-Local Addresses</H5>
<p class="docText">On PE-CE interfaces, EuropCom will use link-local addresses for peering with the CE, in the form FE80::83D7:ID, where 83D7 is EuropCom ASN (33751) in hexadecimal format and the ID is a 16-bit numeric value, starting at 1, reusable from link to link, and from PE to PE. Note that because most PE-CE links are point to point, most peering address on the PE-CE interface will be FE80::83D7:1. On the CE side, the corresponding CE-PE address will be in the same format, with the customer ASN. For instance, EuropCom customer Cisco, with ASN 21214, will use FE80::52DE:1.</P>

<a name="ch13lev3sec17"></a>
<h5 class="docSection3Title">Addresses for Management</H5>
<p class="docText">Because using link-local addresses on the PE-CE interface might be an issue for troubleshooting and management (could not ping the interface from remote devices, for instance), and for any router application required to locally generate packets (including ICMPv6, Telnet, and so on), each side should assign a global address on the PE-CE interface, from its own prefix. Typically, EuropCom customers will choose a small block (for instance /64) out of the prefix they got from EuropCom, and configure a loopback address out of it (one per CE). Note that assigning global addresses may open some security breach and such addresses should be properly protected against DoS attacks (see the &quot;<a class="docLink" href="#ch13lev2sec16">Security</a>&quot; section).</p>
<p class="docText">EuropCom itself will use 2001:6FC::/64 for that purpose, and assign 2001:6FC::PE#/128 at each 6PE and 6VPE (in each vrf). These global addresses will be advertised to all EuropCom 6PEs, but will never cross the autonomous system boundaries.</p>

<a name="ch13lev3sec18"></a>
<H5 class="docSection3Title">Using Unique-Local Addresses</H5>
<p class="docText">EuropCom is not really concerned about unique-local addresses, which could be used for intra-site or inter-site communication. Because unique-local addresses are not publicly routable, a customer using unique-local addresses will be allocated a public range anyway so that it can access the IPv6 Internet. EuropCom will simply filter unique-local prefix (FC00::/8) on the boundary to the public Internet, while treating them as regular global addresses when exchanged between sites of a VPN. In practice, 6PE routers will have the configuration shown in <a class="docLink" href="#ch13ex25">Example 13-25</a>.</P>
<a name="ch13ex25"></a><h5 class="docExampleTitle">Example 13-25. Filtering Unique Local Addresses</h5><p><table cellspacing="0" width="90%" border="1" cellpadding="5"><TR><td>


<pre>router bgp &lt;ASN&gt;
 neighbor a.b.c.d remote-as &lt;ASN&gt;
 neighbor a.b.c.d update-source Loopback0
!
 address-family ipv6
 neighbor a.b.c.d activate
 neighbor a.b.c.d send-label
 neighbor prefix-list Unique-Local out
!
..
ipv6 prefix-list Unique-Local seq 10 permit 2001:6FC::/32 le 56</pre><br>

</TD></TR></table></p>
<p class="docText"><a name="iddle1621"></a>The preceding prefix list will prevent unique-local or anything else outside the EuropCom prefix range to be advertised to the IGW.</p>
<p class="docText">The leaking of addresses from a VPN site to the Internet is closely controlled by EuropCom, so no prefix list is required on 6VPE routers.</p>

<a name="ch13lev3sec19"></a>
<h5 class="docSection3Title">Inter-Provider Communications</H5>
<p class="docText">For connecting IX and POPs together, EuropCom is using IPv4, and therefore does not have to create a specific IPv6 addressing plan and can just use the existing IPv4 one, based on a private 172/16 block.</p>
<p class="docText">For interconnecting with other providers at IXs, EuropCom plans to use inter-AS 6PE, which again will not use any IPv6 addresses, thus saving the need to agree on IPv6 addressing rules on these interfaces.</p>

<a name="ch13lev3sec20"></a>
<H5 class="docSection3Title">Multihoming</h5>
<p class="docText">EuropCom CE routers can be multihomed in several ways:</P>
<ul><li><p class="docList">Connected to several (usually two) ISPs, in which case they will get a prefix from EuropCom (2001:6FC:abcd::/48) and a prefix from another provider, and advertise both of them on both sides. This does not work differently than IPv4, and has all the same inconveniences (see the &quot;<a class="docLink" href="#ch13lev3sec20">Multihoming</a>&quot; section in <a class="docLink" href="ch04.html#ch04">Chapter 4</a> for details). However, &quot;by default&quot;, Europcom do no plan to let prefixes more specific than /35 (other than within its own 2001:6FC::/32 range) spreading over its core routing tables. In order for such multihoming configuration to be enabled, it will take case-by-case negotiations between EuropCom, an EuropCom customer and the other provider. Whenever possible, EuropCom will rather implement a multihoming solution based on RFC2260 and RFC3178, and establish a tunnel between the Customer Edge router and the Provider Edge router facing this customer, via the secondary service provider.</p></li><li><p class="docList">Connected to two EuropCom PEs. In that case, EuropCom will assign 2001:6FC:1abc::/48, and the CE will advertise back chunks of it (2001:6FC:1abc:WXYZ::/s) to each CE, where WXYZ is a multihomed selector, and s ranges from 49 to 52.</p></li></ul>
<p class="docText">In the case of IPv6 VPN service, a customer will be allocated 2001:6FC:1abc::/48, and will distribute smaller chunks to each site, (2001:6FC:1abcd:WXYZ::/s), like in the multihomed case.</p>


<a name="ch13lev2sec15"></a>
<h4 class="docSection2Title">MTU Discovery</h4>
<p class="docText"><a name="iddle1583"></a><a name="iddle1587"></a><a name="iddle1595"></a><a name="iddle1867"></a><a name="iddle1911"></a><a name="iddle1915"></a>Initially, no backbone routers will be upgraded to software images that can send ICMPv6 messages. So P-routers cannot send &quot;packet-too-big&quot; ICMPv6 messages back to the source. Unlike IPv4, transit routers cannot fragment IPv6 packets with a size that does not fit the outgoing link MTU. If MTU design is not tuned up front, large IPv6 packets could be black-holed by the MPLS core.</p>
<p class="docText">To prevent core routers fragmenting VPNv4 traffic, EuropCom has been using <span class="docEmphStrong">mpls mtu</span> on the ingress PE to core interfaces, consistent with the core MTU. That way, packets can be fragmented at the edge of the network if it is larger than the configured maximum labeled MTU size.</p>
<p class="docText">The same configuration applies to IPv6 labeled packets, because they use the same LSP (and label stack) as VPNv4. The difference is that instead of fragmenting IPv6 packets, the edge routers (6PE and 6VPE) will send a &quot;packet-too-big&quot; ICMPv6 message back to the source.</p>
<p class="docText">Note that the &quot;consistent MTU&quot; approach applies to the core only. The MTU on the PE-CE link can be smaller than the one configured in the core. In this case, the PE will send back an ICMPv6 too-big message over the MPLS core.</p>

<a name="ch13lev2sec16"></a>
<H4 class="docSection2Title">Security</h4>
<p class="docText">An important aspect of the IPv6 deployment planning and design is that of assessing the security risks it would introduce in EuropCom network. The analysis was performed based on the guidelines mentioned in <a class="docLink" href="ch09.html#ch09">Chapter 9</a>, &quot;Securing IPv6 Networks,&quot; and it was decided that as a general rule, all IPv4 security policies will be matched for IPv6. At the same time, EuropCom had to consider several IPv6- and 6PE-specific security policies.</p>
<a name="ch13lev3sec21"></a>
<h5 class="docSection3Title">Securing the Edge</H5>
<p class="docText">In the process of securing the edge, EuropCom took the following measures:</p>
<UL><LI><p class="docList">Updated the configuration of the PIX Firewall protecting the hosted services in the L1 POPs.</p></LI><li><p class="docList">Updated any edge router IPv4 ACLs to IPv6. In matching the IPv4 security policies, the IPv6 filters defined on the edge routers observed the requirements of ICMPv6 as mentioned in <a class="docLink" href="ch09.html#ch09">Chapter 9</a>.</p></LI><LI><p class="docList">Enabled IPv6 uRPF on all interfaces facing the Internet-access customers. This measure prevents spoofing attacks sourced by EuropCom customers.</P></li></ul>
<p class="docText">EuropCom interfaces directly with only a subset of its customers. In these cases, it considers implementing protective measures for its routers against floods of control message such as Router Solicitations, Neighbor Solicitation, and MLD traffic. <a class="docLink" href="#ch13ex26">Example 13-26</a> shows how an interface is configured to police all Neighbor Solicitation and &quot;All Routers&quot; messages.</p>
<a name="ch13ex26"></a><H5 class="docExampleTitle">Example 13-26. Configuring Control-Plane Protection</h5><p><table cellspacing="0" width="90%" border="1" cellpadding="5"><TR><TD>


<pre>ipv6 access-list DOS-acl
 <span class="docEmphMark">permit icmp any any nd-ns</span>
 <span class="docEmphMark">permit ipv6 any host FF02::2</span>
class-map match-all DOS-class
 match access-group name DOS-acl
policy-map prevent-attack
 class DOS-class
 <span class="docEmphMark">police 70000 1500 1500 conform-action transmit exceed-action drop</span>
!
interface GigabitEthernet1/1
 <span class="docEmphMark">service-policy input prevent-attack</span></pre><br>

</td></tr></table></p>
<p class="docText">When implementing the policies shown in <a class="docLink" href="#ch13ex26">Example 13-26</a>, consideration should be given to their impact on the router operation. They should be implemented on a large scale only on interfaces that support the functionality in hardware.</P>

<a name="ch13lev3sec22"></a>
<h5 class="docSection3Title">Securing the 6PE Infrastructure</h5>
<p class="docText">The MPLS backbone and the PE routers are critical elements to support the IPv6 service as well as existent, revenue-generating IPv4 services. The IPv6 deployment should not open any security holes that can expose it to attacks. A few security measures have to be enforced to protect the MPLS because of the 6PE/VPNv6 overlay:</P>
<ul><LI><p class="docList">The global addresses of the loopback interfaces should not be advertised outside the EuropCom network because they can allow attackers to target a PE router over IPv6 and in the process impact the IPv4 services supported by that PE. Traffic destined for these management prefixes can be easily blocked because, based on EuropCom addressing plan, they all belong to the prefix range 2001:6FC::/64. The same policy should be implemented for any global address used on internal links.</p></li><li><p class="docList">If the P-routers in the MPLS backbone are capable of sending ICMP replies, traceroute ICMP traffic has to be particularly blocked at EuropCom border. As it was seen in the traceroute example of a previous section, in this case the path would reveal the IPv4 addresses of the P-routers. This information can be used to attack the network core over IPv4.</p></li><li><p class="docList">ACLs can be implemented on PE routers to protect bandwidth, buffer, and processing resources in case of an IPv6 attack, as mentioned in the previous section.</p></li></ul>
<p class="docText">Another useful feature that should be leveraged on the PE routers but, depending on the platform it can be used for EuropCom CE routers as well, is the control-plane protection. If the policy <span class="docEmphStrong">prevent-attack</span> in <a class="docLink" href="#ch13ex26">Example 13-26</a> is modified to include all ICMP traffic, it could be used to protect the router resources used for control purposes.</p>
<div class="docText"><pre><span class="docEmphMark">control-plane</span>
 <span class="docEmphMark">service-policy input prevent-attack</span></pre></div><br>
<p class="docText">Most network elements that support EuropCom IPv6 service are dual stack. The IPv4 side of these routers is already secured based on the best practices recommendations.</p>


<a name="ch13lev2sec17"></a>
<h4 class="docSection2Title">Troubleshooting</h4>
<p class="docText"><a name="iddle1588"></a><a name="iddle1916"></a><a name="iddle1977"></a>Being able to easily troubleshoot network anomalies with regard to the new deployed service is a key element of the EuropCom deployment process. EuropCom operation engineers are familiar with BGP, MPLS, IPv4, and VPN. When troubleshooting IPv6, anything that looks similar to VPNv4 will dramatically minimize their learning curve. In fact, very few of the tools and commands used to troubleshoot 6PE and 6VPE are specific to IPv6. In the vast majority of the cases, the troubleshooting methodology is the same for IPv4 and IPv6, and the commands and tools vary by one keyword.</p>
<a name="ch13lev3sec23"></a>
<H5 class="docSection3Title">Routing</h5>
<p class="docText">The deployed solution (6PE/6PE) involves principally BGP, which EuropCom has been already operating for IPv4 services. The same set of commands EuropCom is already familiar with can be used (with different set of arguments) for IPv6, and similar outputs are obtained.</p>
<p class="docText">For instance, you can display a summary of BGP IPv6 activity as shown in <a class="docLink" href="#ch13ex27">Example 13-27</a>.</p>
<a name="ch13ex27"></a><H5 class="docExampleTitle">Example 13-27. BGP IPv6 Activity Summary</h5><P><table cellspacing="0" width="90%" border="1" cellpadding="5"><TR><td>


<pre>Nice-PE-IA#<span class="docEmphStrong">show bgp ipv6 summary</span>
For address family: IPv6 Unicast
BGP router identifier 100.26.26.1, local AS number 33751
BGP table version is 15, main routing table version 15
12 network entries using 1692 bytes of memory
22 path entries using 1672 bytes of memory
5/4 BGP path/bestpath attribute entries using 580 bytes of memory
14 BGP rrinfo entries using 336 bytes of memory
2 BGP AS-PATH entries using 48 bytes of memory
0 BGP route-map cache entries using 0 bytes of memory
0 BGP filter-list cache entries using 0 bytes of memory
BGP using 4328 total bytes of memory
Dampening enabled. 0 history paths, 0 dampened paths
BGP activity 13/1 prefixes, 23/1 paths, scan interval 60 secs
Neighbor        V    AS MsgRcvd MsgSent   TblVer  InQ OutQ Up/Down  State/PfxRcd
100.46.46.1     4 33751     991     983       15    0    0 16:26:21       10
100.47.47.1     4 33751     991     983       15    0    0 16:26:22       10
FE80::4F6B:44%Serial1/0
                4 20331     982     987       15    0    0 14:55:52        1
</pre><BR>

</td></tr></table></P>
<p class="docText">Each table (BGP IPv6, BGP VPNv6) can be looked at individually, as shown in <a class="docLink" href="#ch13ex28">Example 13-28</a>.</P>
<a name="ch13ex28"></a><H5 class="docExampleTitle">Example 13-28. Dumping BGP IPv6 Table</h5><p><table cellspacing="0" width="90%" border="1" cellpadding="5"><tr><TD>


<pre>Nice-PE-IA#<span class="docEmphStrong">show bgp ipv6 unicast</span>
BGP table version is 15, local router ID is 100.26.26.1
Status codes: s suppressed, d damped, h history, * valid, &gt; best, i - internal,
              r RIB-failure, S Stale
Origin codes: i - IGP, e - EGP, ? - incomplete
   Network          Next Hop            Metric LocPrf Weight Path
* i2001:500::/48    ::FFFF:100.1.1.1     0    100      0 10000 ?
*&gt;i                 ::FFFF:100.1.1.1     0    100      0 10000 ?
* i2001:6FC::1/128  ::FFFF:100.1.1.1     0    100      0 i
*&gt;i                 ::FFFF:100.1.1.1     0    100      0 i
..</pre><br>

</td></TR></table></P>
<p class="docText">IPv6 routing tables can be displayed, to identify each routing protocol contributor to routable entries, as shown in <a class="docLink" href="#ch13ex29">Example 13-29</a>.</p>
<a name="ch13ex29"></a><h5 class="docExampleTitle">Example 13-29. Dumping IPv6 Routing Table</h5><p><table cellspacing="0" width="90%" border="1" cellpadding="5"><TR><td>


<pre>Nice-PE-IA#<span class="docEmphStrong">show ipv6 route</span>
IPv6 Routing Table - default - 13 entries
Codes: C - Connected, L - Local, S - Static, U - Per-user Static route
       B - BGP, R - RIP, I1 - ISIS L1, I2 - ISIS L2
       IA - ISIS interarea, IS - ISIS summary
       O - OSPF Intra, OI - OSPF Inter, OE1 - OSPF ext 1, OE2 - OSPF ext 2
       ON1 - OSPF NSSA ext 1, ON2 - OSPF NSSA ext 2
B   2001:500::/48 [200/0]
     <span class="docEmphMark">via 100.1.1.1%Default-IP-Routing-Table, indirectly connected</span>
B   2001:6FC::1/128 [200/0]
     via 100.1.1.1%Default-IP-Routing-Table, c
LC  2001:6FC::26/128 [0/0]
     via Loopback0, receive
..</pre><br>

</TD></tr></table></P>
<p class="docText">Note that, from an IPv6 routing perspective, entries reachable over the MPLS backbone are listed as &quot;indirectly connected&quot; because MPLS is providing a layer 2 tunnel mechanism.</p>

<a name="ch13lev3sec24"></a>
<h5 class="docSection3Title">Forwarding</h5>
<p class="docText">Forwarding anomalies should be detected, understood, and troubleshot. Tools such as <span class="docEmphStrong">ping ipv6</span> and <span class="docEmphStrong">traceroute ipv6</span> are used to validate data-plane connectivity and detect traffic black-holing. Commands such as <span class="docEmphStrong">traceroute mpls</span> and <span class="docEmphStrong">show mpls forwarding</span> can pinpoint the damaged node, interface, and FEC. At the edge, troubleshooting forwarding failures for a particular IPv6 destination commonly leads to breaking down the recursive resolution into elementary pieces. This requires combining analysis of IPv6 routing (iBGP/eBGP), IP routing (IS-IS/OSPF), label distribution (BGP/LDP/RSVP), and adjacency resolution to narrow down a resolution breakage.</p>
<a name="ch13lev4sec4"></a>
<h5 class="docSection4Title">PE-CE Connectivity</h5>
<p class="docText">The IPv6 ping and traceroute are useful to check connectivity from a PE to a CE, whether locally attached, or remote over the MPLS backbone.</p>
<p class="docText">When locally attached, EuropCom uses IPv6 ping with the CE link-local address (used for eBGP peering), as illustrated here (pinging Nice-CE):</p>
<div class="docText"><pre>Nice-PE-IA#<span class="docEmphStrong">ping FE80::4F6B:44%Serial1/0</span>
Type escape sequence to abort.
Sending 5, 100-byte ICMP Echos to FE80::4F6B:44, timeout is 2 seconds:
!!!!!
Success rate is 100 percent (5/5), round-trip min/avg/max = 28/33/48 ms</pre></div><br>
<p class="docText">The same command can be used to test remote PE or CE reachability, but only IPv6 global addresses can be used (link-locals are not advertised beyond the link):</p>
<div class="docText"><pre>London-PE-IA# <span class="docEmphStrong">ping 2001:6FC:1120:1::44</span>
Type escape sequence to abort.
Sending 5, 100-byte ICMP Echos to 2001:6FC:1120:1:44::1, timeout is 2 seconds:
!!!!!
Success rate is 100 percent (5/5), round-trip min/avg/max = 28/33/48 ms</pre></div><br>
<p class="docText">Note that the ping (and traceroute) over MPLS requires PEs and CEs to announce one IPv6 global prefix. Each 6PE router announces 2001:6FC::PE#/128, filtered at the autonomous system edge. Each IPv6 CE configures 2001:6FC:prefix:CE#/128 and announces it as part as their less-specific prefix (2001:6FC:prefix::/n).</p>
<p class="docText">Reachability of remote PEs and CEs can be tested by using traceroute. EuropCom has configured all its PEs with <span class="docEmphStrong">no mpls ip propagate-ttl forwarded</span>, so when traceroute is executed from a CE, it will only show the IPv6 nodes:</p>
<div class="docText"><pre>Nice-CE#<span class="docEmphStrong">traceroute 2001:6FC::1</span>
Type escape sequence to abort.
Tracing the route to 2001:6FC::1
  1 2001:6FC::26 [AS 33751] 32 msec 32 msec 20 msec
  2 2001:6FC::1 [AS 33751] [MPLS: Label 73 Exp 0] 20 msec 20 msec 20 msec
  3 2001:6FC::1 [AS 33751] 28 msec 20 msec 20 msec</pre></div><br>
<p class="docText">After the P-routers have been upgraded with images that support ICMPv6, the same command executed on the PE router (TTL is then propagated) will also show P-routers responses, as illustrated here:</p>
<div class="docText"><pre>Nice-PE-IA#<span class="docEmphStrong">traceroute 2001:6FC::1</span>
Type escape sequence to abort.
Tracing the route to 2001:6FC::1
  1 ::FFFF:172.20.25.1 [MPLS: Labels 38/73 Exp 0] 40 msec 32 msec 32 msec
  2 ::FFFF:172.20.10.1 [MPLS: Labels 30/73 Exp 0] 60 msec 32 msec 32 msec
  3 2001:6FC::1 [MPLS: Label 73 Exp 0] 32 msec 32 msec 16 msec</pre></div><BR>
<p class="docText">When run from a 6VPE router, both <span class="docEmphStrong">ping</span> and <span class="docEmphStrong">traceroute</span> commands accept a <span class="docEmphStrong">vrf</span> argument, exactly as in the case of VPNv4.</p>
<p class="docText">Note that the <span class="docEmphStrong">traceroute</span> command is useful for evaluating the path across the MPLS backbone, but not for troubleshooting data-plane failures. The P-routers are IPv6 unaware (like they are VPNv4 unaware), so the ICMPv6 messages that they generate in response to the <span class="docEmphStrong">traceroute</span> command are forwarded to the <span class="docEmphasis">egress PE</span> using the received label stack. It is the egress PE that can route the ICMPv6 message to the source of the traceroute. When the MPLS path is broken, it is also broken from the ICMP message, which cannot reach the egress PE.</p>
<p class="docText">For troubleshooting data-plane failures, LSP ping should be used.</p>

<a name="ch13lev4sec5"></a>
<H5 class="docSection4Title">PE Imposition Path</h5>
<p class="docText">On Cisco routers, when it comes to troubleshooting the imposition path, the most useful command to start from is the Cisco Express Forwarding (CEF) <span class="docEmphStrong">show ipv6 cef</span> command. You can either display the forwarding table with label stacks used for each destination prefix, as shown in <a class="docLink" href="#ch13ex30">Example 13-30</a>, or display details for a specific entry, to analyze how the destination was resolved and the label stack computed, as shown in <a class="docLink" href="#ch13ex31">Example 13-31</a>.</P>
<a name="ch13ex30"></a><H5 class="docExampleTitle">Example 13-30. Dumping IPv6 Forwarding Table</h5><P><table cellspacing="0" width="90%" border="1" cellpadding="5"><tr><td>


<pre>Nice-PE-IA# <span class="docEmphStrong">show ipv6 cef</span>
2001:500::/48
  <span class="docEmphMark">nexthop 172.20.25.1 Serial0/0 label 38 72</span>
2001:6FC::1/128
  nexthop 172.20.25.1 Serial0/0 label 38 73
2001:6FC::26/128
  attached to Loopback0, receive
..</pre><BR>

</TD></TR></table></p>
<a name="ch13ex31"></a><h5 class="docExampleTitle">Example 13-31. Details on an IPv6 Entry in the Forwarding Table</h5><P><table cellspacing="0" width="90%" border="1" cellpadding="5"><tr><td>


<pre>Nice-PE-IA# <span class="docEmphStrong">show ipv6 cef 2001:500::/48 internal</span>
<span class="docEmphMark">2001:500::/48, epoch 0, RIB[B], refcount 4</span>
  sources: RIB
..
  <span class="docEmphMark">recursive via 100.1.1.1[IPv4:Default] label 72, fib 0252B1F8, 1 terminal fib</span>
    path 024F56A8, path list 024F0BA8, share 0/1, type attached nexthop
    ifnums: (none)
     path_list contains at least one resolved destination(s). HW IPv4 notified.
   <span class="docEmphMark">nexthop 172.20.25.1 Serial0/0 label 38, adjacency IP adj out of Serial0/0 0289BEF0</span>
  output chain: label 72 label 38 TAG adj out of Serial0/0 0289BD80</pre><BR>

</TD></tr></table></p>
<p class="docText">From the preceding detailed output, each label composing the label stack has a different origin that can be tracked down individually. BGP table has the bottom label, as shown in <a class="docLink" href="#ch13ex32">Example 13-32</a>.</p>
<a name="ch13ex32"></a><h5 class="docExampleTitle">Example 13-32. Details on a BGP Entry in the BGP Table</H5><p><table cellspacing="0" width="90%" border="1" cellpadding="5"><tr><TD>


<pre>Nice-PE-IA#<span class="docEmphStrong">show bgp ipv6 unicast 2001:500::/48</span>
BGP routing table entry for 2001:500::/48, version 2
Paths: (2 available, best #2, table default)
  Advertised to update-groups:
     1
  10000
    ::FFFF:100.1.1.1 (metric 30) from 100.47.47.1 (100.47.47.1)
      Origin incomplete, metric 0, localpref 100, valid, internal
      Originator: 100.1.1.1, Cluster list: 100.47.47.1,
      <span class="docEmphMark">mpls labels in/out nolabel/72</span>
  10000
    ::FFFF:100.1.1.1 (metric 30) from 100.46.46.1 (100.46.46.1)
      Origin incomplete, metric 0, localpref 100, valid, internal, best
      Originator: 100.1.1.1, Cluster list: 100.46.46.1,
      mpls labels in/out nolabel/72
LDP (used in this example, could be replaced by RSVP) has the other labels:
Nice-PE-IA#show mpls ldp bindings 100.1.1.1 32
  lib entry: 100.1.1.1/32, rev 56
        local binding: label: 40
        <span class="docEmphMark">remote binding: lsr: 100.19.19.1:0, label: 38</span>
Nice-PE-IA#show mpls ldp bindings 172.20.25.0 24
  lib entry: 172.20.25.0/24, rev 2
        local binding: label: imp-null
        <span class="docEmphMark">remote binding: lsr: 100.19.19.1:0, label: imp-null</span></pre><br>

</TD></tr></table></p>

<a name="ch13lev4sec6"></a>
<h5 class="docSection4Title">PE Disposition Path</h5>
<p class="docText">The disposition path can be looked at and troubleshot by displaying the MPLS forwarding table. <a class="docLink" href="#ch13ex33">Example 13-33</a> illustrates the output at Milan-IGW.</p>
<a name="ch13ex33"></a><h5 class="docExampleTitle">Example 13-33. Dumping the MPLS Forwarding Table</h5><p><table cellspacing="0" width="90%" border="1" cellpadding="5"><tr><td>


<pre>Milan-IGW#<span class="docEmphStrong">show mpls forwarding-table</span>
Local  Outgoing         Prefix             Bytes Label   Outgoing   Next Hop
Label  Label or VC      or Tunnel Id       Switched      interface
16     Pop Label        100.14.14.1/32     0             Se0/0      point2point
17     26               100.46.46.1/32     0             Se0/0      point2point
..
<span class="docEmphMark">72     No Label         2001:500::/48      63121         Se1/0      point2point</span>
73     Aggregate        2001:6FC::1/128    24123</pre><br>

</td></tr></table></p>
<p class="docText">The label used for switching has been announced by iBGP (6PE in this example), and can be checked. <a class="docLink" href="#ch13ex34">Example 13-34</a> illustrates this switching.</p>
<a name="ch13ex34"></a><H5 class="docExampleTitle">Example 13-34. BGP Label Analysis</h5><p><table cellspacing="0" width="90%" border="1" cellpadding="5"><tr><TD>


<pre>Milan-IGW#<span class="docEmphStrong">show bgp ipv6 2001:500::/48</span>
BGP routing table entry for 2001:500::/48, version 2
Paths: (1 available, best #1, table default)
  Advertised to update-groups:
     2
  10000
    FE80::2710:2 (FE80::2710:2) from FE80::2710:2%Serial1/0 (100.2.2.2)
      Origin incomplete, metric 0, localpref 100, valid, external, best,
      <span class="docEmphMark">mpls labels in/out 72/nolabel</span></pre><br>

</TD></TR></table></p>

<a name="ch13lev4sec7"></a>
<H5 class="docSection4Title">Label Switch Path</h5>
<p class="docText">Because the 6PE and 6VPE LSP endpoints are IPv4 addresses, the IPv4 tools EuropCom has been using to troubleshoot LSPs are more than ever useful to detect data-plane failures that would lead to IPv6 traffic black-holing.</p>
<p class="docText">In <a class="docLink" href="#ch13ex35">Example 13-35</a>, at Nice-PE-IA, the <span class="docEmphStrong">show ipv6 route</span> command provides the LSP IPv4 tail end.</P>
<a name="ch13ex35"></a><H5 class="docExampleTitle">Example 13-35. Analyzing the Label Switch Path</H5><p><table cellspacing="0" width="90%" border="1" cellpadding="5"><tr><td>


<pre>Nice-PE-IA#<span class="docEmphStrong">show ipv6 route 2001:6FC::1/128</span>
Routing entry for 2001:6FC::1/128
  Known via "bgp 33751", distance 200, metric 0, type internal
  Route count is 1/1, share count 0
  Routing paths:
    <span class="docEmphMark">100.1.1.1%Default-IP-Routing-Table indirectly connected</span>
      MPLS Required
      Last updated 02:42:12 ago</pre><BR>

</td></tr></table></P>
<p class="docText">And the traceroute-LSP, executed from Nice-PE-IA, is shown in <a class="docLink" href="#ch13ex36">Example 13-36</a>.</P>
<a name="ch13ex36"></a><h5 class="docExampleTitle">Example 13-36. Traceroute-LSP Example</h5><p><table cellspacing="0" width="90%" border="1" cellpadding="5"><tr><TD>


<pre><span class="docEmphMark">Nice-PE-IA#<span class="docEmphStrong">traceroute mpls ipv4 100.1.1.1/32 verbose</span></span>
Tracing MPLS Label Switched Path to 100.1.1.1/32, timeout is 2 seconds
Codes: '!' - success, 'Q' - request not transmitted,
       '.' - timeout, 'U' - unreachable,
       'R' - downstream router but not target,
       'M' - malformed request
Type escape sequence to abort.
  0 172.20.25.2 0.0.0.0 MRU 1500 [Labels: 38 Exp: 0]
R 1 172.20.25.1 0.0.0.0 MRU 1500 [Labels: 30 Exp: 0] 40 ms, ret code 6
R 2 172.20.10.1 0.0.0.0 MRU 1504 [Labels: implicit-null Exp: 0] 60 ms, ret code 6
! 3 172.20.40.1 48 ms</pre><br>

</td></TR></table></p>

<a name="ch13lev4sec8"></a>
<H5 class="docSection4Title">Troubleshooting Routing and Forwarding</h5>
<p class="docText">When it comes to fine troubleshooting of routing and forwarding anomalies, enabling debugging commands can prove useful, although the number of messages (factor of the activity on the wire) can annihilate the usability of such tool (<span class="docEmphStrong">debug ipv6 cef</span>, <span class="docEmphStrong">debug mpls packet</span>, <span class="docEmphStrong">debug ipv6 packet</span> for the forwarding path; <span class="docEmphStrong">debug bgp ipv6</span> and <span class="docEmphStrong">debug bgp vpnv6</span> for the control plane).</p>
<p class="docText">External tools, such as ethereal, are also used in critical cases to capture and analyze relevant traffic.</p>




</TD></TR></table>
<br>
<table width="100%" border="0" cellspacing="0" cellpadding="0">
<tr><td><div STYLE="MARGIN-LEFT: 0.15in;">
<a href=ch13lev1sec5.html><img src="images/prev.gif" width="60" height="17" border="0" align="absmiddle" alt="Previous Page"></a>
<td align="right"><div STYLE="MARGIN-LEFT: 0.15in;">
<a href=ch13lev1sec7.html><img src="images/next.gif" width="60" height="17" border="0" align="absmiddle" alt="Next Page"></a>
</div></td></tr></table>
</body></html>