<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<HTML>
<HEAD>
<META HTTP-EQUIV="Content-Type" Content="text/html; charset=Windows-1252">
<TITLE>Processing the WM_IME_COMPOSITION Message</TITLE>
</HEAD>

<BODY BGCOLOR="#FFFFC8" TEXT="#341717">



<P><A NAME="awkkiw"></A><B>Processing the WM_IME_COMPOSITION Message</B></P>

<P>Applications that process the <A HREF="y5wer6.htm">WM_IME_COMPOSITION</A> message test the bits in <I>lParam</I> parameter and call the <A HREF="65q3ci.htm"><B>ImmGetCompositionString</B></A> function to retrieve the indicated string or data. The following example checks for the result string, allocates sufficient memory for the string, and retrieves the result string from the IME:</P>

<P>HIMC hIMC;<BR>
HWND hWnd;<BR>
DWORD dwSize;<BR>
HGLOBAL hstr;<BR>
LPSTR lpstr;<BR>
<BR>
case WM_IME_COMPOSITION:<BR>
    if (lParam &amp; GCS_RESULTSTR) {<BR>
        hIMC = ImmGetContext(hWnd);<BR>
<BR>
        If (!hIMC)<BR>
            MyError(ERROR_NULLCONTEXT);<BR>
<BR>
        // Get the size of the result string.<BR>
        dwSize = ImmGetCompositionString(hIMC, GCS_RESULTSTR, NULL, 0);<BR>
<BR>
        // increase buffer size for NULL terminator, <BR>
        //   maybe it is in UNICODE<BR>
        dwSize += sizeof(WCHAR);<BR>
<BR>
        hstr = GlobalAlloc(GHND,dwSize);<BR>
        if (hstr == NULL)<BR>
             MyError(ERROR_GLOBALALLOC);<BR>
<BR>
        lpstr = GlobalLock(hstr);<BR>
        if (lpstr == NULL)<BR>
             MyError(ERROR_GLOBALLOCK);<BR>
<BR>
        // Get the result strings that is generated by IME into lpstr.<BR>
        ImmGetCompositionString(hIMC, GCS_RESULTSTR, lpstr, dwSize);<BR>
        ImmReleaseContext(hWnd, hIMC);<BR>
<BR>
        // add this string into text buffer of application<BR>
<BR>
        GlobalUnlock(hstr);<BR>
        GlobalFree(hstr);<BR>
    }<BR>
  </P>

</BODY>
</HTML>
