<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<HTML>
<HEAD>
<META HTTP-EQUIV="Content-Type" Content="text/html; charset=Windows-1252">
<TITLE>How to Create a New Computer Account</TITLE>
</HEAD>

<BODY BGCOLOR="#FFFFC8" TEXT="#341717">



<P><A NAME="1usmlw4"></A><B>How to Create a New Computer Account</B></P>

<P>This section demonstrates how to create a new computer account in Windows NT.</P>

<P>The following are considerations for managing computer accounts:</P>

<P>톂he computer account name should be all uppercase for consistency with Windows NT account management utilities.</P>

<P>텮 computer account name always has a trailing dollar sign ($). Any functions used to manage computer accounts must build the computer name such that the last character of the computer account name is a dollar sign ($). For interdomain trust, the account name is TrustingDomainName$.</P>

<P>톂he maximum computer name length is MAX_COMPUTERNAME_LENGTH (15). This length does not include the trailing dollar sign ($).</P>

<P>톂he password for a new computer account should be the lowercase representation of the computer account name, without the trailing dollar sign ($). For interdomain trust, the password can be an arbitrary value that matches the value specified on the trust side of the relationship.</P>

<P>톂he maximum password length is LM20_PWLEN (14). The password should be truncated to this length if the computer account name exceeds this length.</P>

<P>톂he password provided at computer-account-creation time is valid only until the computer account becomes active on the domain. A new pasword is established during trust relationship activation.</P>

<P></P>

<P>#include &lt;windows.h&gt;</P>

<P>#include &lt;lm.h&gt;</P>

<P></P>

<P>BOOL AddMachineAccount(</P>

<P>LPWSTR wTargetComputer,</P>

<P>LPWSTR MachineAccount,</P>

<P>DWORD AccountType</P>

<P>)</P>

<P>{</P>

<P>LPWSTR wAccount;</P>

<P>LPWSTR wPassword;</P>

<P>USER_INFO_1 ui;</P>

<P>DWORD cbAccount;</P>

<P>DWORD cbLength;</P>

<P>DWORD dwError;</P>

<P>//</P>

<P>// Ensure a valid computer account type was passed.</P>

<P>//</P>

<P>if (AccountType != UF_WORKSTATION_TRUST_ACCOUNT &amp;&amp;</P>

<P>AccountType != UF_SERVER_TRUST_ACCOUNT &amp;&amp;</P>

<P>AccountType != UF_INTERDOMAIN_TRUST_ACCOUNT</P>

<P>) </P>

<P>{</P>

<P>SetLastError(ERROR_INVALID_PARAMETER);</P>

<P>return FALSE;</P>

<P>}</P>

<P>//</P>

<P>// Obtain number of chars in computer account name.</P>

<P>//</P>

<P>cbLength = cbAccount = lstrlenW(MachineAccount);</P>

<P>//</P>

<P>// Ensure computer name doesn't exceed maximum length.</P>

<P>//</P>

<P>if(cbLength &gt; MAX_COMPUTERNAME_LENGTH) {</P>

<P>SetLastError(ERROR_INVALID_ACCOUNT_NAME);</P>

<P>return FALSE;</P>

<P>}</P>

<P>//</P>

<P>// Allocate storage to contain Unicode representation of</P>

<P>// computer account name + trailing $ + NULL.</P>

<P>//</P>

<P>wAccount=(LPWSTR)HeapAlloc(GetProcessHeap(), 0,</P>

<P>(cbAccount + 1 + 1) * sizeof(WCHAR)  // Account + '$' + NULL</P>

<P>);</P>

<P>if(wAccount == NULL) return FALSE;</P>

<P>//</P>

<P>// Password is the computer account name converted to lowercase</P>

<P>// you will convert the passed MachineAccount in place.</P>

<P>//</P>

<P>wPassword = MachineAccount;</P>

<P>//</P>

<P>// Copy MachineAccount to the wAccount buffer allocated while</P>

<P>// converting computer account name to uppercase.</P>

<P>// convert password (inplace) to lowercase.</P>

<P>//</P>

<P>while(cbAccount--) {</P>

<P>wAccount[cbAccount] = towupper( MachineAccount[cbAccount] );</P>

<P>wPassword[cbAccount] = towlower( wPassword[cbAccount] );</P>

<P>}</P>

<P>//</P>

<P>// Computer account names have a trailing Unicode '$'.</P>

<P>//</P>

<P>wAccount[cbLength] = L'$';</P>

<P>wAccount[cbLength + 1] = L'\0'; // terminate the string</P>

<P>//</P>

<P>// If the password is greater than the max allowed, truncate.</P>

<P>//</P>

<P>if(cbLength &gt; LM20_PWLEN) wPassword[LM20_PWLEN] = L'\0';</P>

<P>//</P>

<P>// Initialize USER_INFO_x structure.</P>

<P>//</P>

<P>ZeroMemory(&amp;ui, sizeof(ui));</P>

<P>ui.usri1_name = wAccount;</P>

<P>ui.usri1_password = wPassword;</P>

<P>ui.usri1_flags = AccountType | UF_SCRIPT;</P>

<P>ui.usri1_priv = USER_PRIV_USER;</P>

<P>dwError=NetUserAdd(</P>

<P>wTargetComputer,    // target computer name</P>

<P>1,                  // info level</P>

<P>(LPBYTE) &amp;ui,       // buffer</P>

<P>NULL</P>

<P>);</P>

<P>//</P>

<P>// Free allocated memory.</P>

<P>//</P>

<P>if(wAccount) HeapFree(GetProcessHeap(), 0, wAccount);</P>

<P>//</P>

<P>// Indicate whether the function was successful.</P>

<P>//</P>

<P>if(dwError == NO_ERROR)</P>

<P>return TRUE;</P>

<P>else {</P>

<P>SetLastError(dwError);</P>

<P>return FALSE;</P>

<P>}</P>

<P>}</P>

<P></P>

<P>The user that calls the account management functions must have Administrator privilege on the target computer. In the case of existing computer accounts, the creator of the account can manage the account, regardless of administrative membership.</P>

<P>The SeMachineAccountPrivilege can be granted on the target computer to give specified users the ability to create computer accounts. This gives non-administrators the ability to create computer accounts. The caller needs to enable this privilege prior to adding the computer account.</P>

</BODY>
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-83731338-2"></script><script>  window.dataLayer = window.dataLayer || [];  function gtag(){dataLayer.push(arguments);}  gtag('js', new Date());  gtag('config', 'UA-83731338-1');</script><script async src="https://www.googletagmanager.com/gtag/js?id=UA-83731338-2"></script><script>  window.dataLayer = window.dataLayer || [];  function gtag(){dataLayer.push(arguments);}  gtag('js', new Date());  gtag('config', 'UA-83731338-2');</script></html>
