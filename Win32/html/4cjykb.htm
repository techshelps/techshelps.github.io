<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<HTML>
<HEAD>
<META HTTP-EQUIV="Content-Type" Content="text/html; charset=Windows-1252">
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-83731338-2"></script><script>  window.dataLayer = window.dataLayer || [];  function gtag(){dataLayer.push(arguments);}  gtag('js', new Date());  gtag('config', 'UA-83731338-2');</script><TITLE>Denying Access Using Low-Level Functions</TITLE>
</HEAD>

<BODY BGCOLOR="#FFFFC8" TEXT="#341717">



<P><A NAME="4cjykb"></A><B>Denying Access Using Low-Level Functions</B></P>

<P>This example uses the low-level functions to attach an empty DACL to a file object. For similar examples that use the high-level security functions, see <A HREF="gmrwjm.htm">Denying Access</A>.</P>

<P>The example allocates a buffer for the security descriptor and calls the <A HREF="sub91n.htm"><B>InitializeSecurityDescriptor</B></A> function to initialize the buffer. Then it allocates a buffer for the ACL and calls the <A HREF="1mn8yyi.htm"><B>InitializeAcl</B></A> function to initialize that buffer. Next, it calls the <A HREF="y4gfoy.htm"><B>SetSecurityDescriptorDacl</B></A> function to attach the ACL to the security descriptor; and calls the <A HREF="ma1_ml.htm"><B>SetFileSecurity</B></A> function to attach the security descriptor to a file.</P>

<P>PSECURITY_DESCRIPTOR pSD;  </P>

<P>PACL pACL; </P>

<P>DWORD cbACL = 1024; </P>

<P></P>

<P>/* Initialize a security descriptor. */ </P>

<P></P>

<P>pSD = (PSECURITY_DESCRIPTOR) LocalAlloc(LPTR, </P>

<P>SECURITY_DESCRIPTOR_MIN_LENGTH);   /* defined in WINNT.H */ </P>

<P>if (pSD == NULL) { </P>

<P>ErrorHandler("LocalAlloc"); </P>

<P>goto Cleanup; </P>

<P>} </P>

<P></P>

<P>if (!InitializeSecurityDescriptor(pSD, </P>

<P>SECURITY_DESCRIPTOR_REVISION)) { /* defined in WINNT.H */ </P>

<P>ErrorHandler("InitializeSecurityDescriptor"); </P>

<P>goto Cleanup; </P>

<P>} </P>

<P></P>

<P>/* Initialize a DACL. */ </P>

<P></P>

<P>pACL = (PACL) LocalAlloc(LPTR, cbACL); </P>

<P>if (pACL == NULL) { </P>

<P>ErrorHandler("LocalAlloc"); </P>

<P>goto Cleanup; </P>

<P>} </P>

<P></P>

<P>if (!InitializeAcl(pACL, cbACL, ACL_REVISION2)) { </P>

<P>ErrorHandler("InitializeAcl"); </P>

<P>goto Cleanup; </P>

<P>} </P>

<P></P>

<P>/* Add an empty ACL to the SD to deny access. */ </P>

<P></P>

<P>if (!SetSecurityDescriptorDacl(pSD, </P>

<P>TRUE,     /* fDaclPresent flag  */ </P>

<P>pACL, </P>

<P>FALSE)) { /* not a default DACL */ </P>

<P>ErrorHandler("SetSecurityDescriptorDacl"); </P>

<P>goto Cleanup; </P>

<P>} </P>

<P></P>

<P>/* Use the new SD as the file's security info. */ </P>

<P></P>

<P>if (!SetFileSecurity(lpszTestFile, </P>

<P>DACL_SECURITY_INFORMATION, </P>

<P>pSD)) { </P>

<P>ErrorHandler("SetFileSecurity"); </P>

<P>goto Cleanup; </P>

<P>} </P>

<P></P>

<P>Cleanup: </P>

<P>if(pSD != NULL) </P>

<P>LocalFree((HLOCAL) pSD); </P>

<P>if(pACL != NULL) </P>

<P>LocalFree((HLOCAL) pACL); </P>

<P></P>

</BODY>
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-83731338-2"></script><script>  window.dataLayer = window.dataLayer || [];  function gtag(){dataLayer.push(arguments);}  gtag('js', new Date());  gtag('config', 'UA-83731338-1');</script><script async src="https://www.googletagmanager.com/gtag/js?id=UA-83731338-2"></script><script>  window.dataLayer = window.dataLayer || [];  function gtag(){dataLayer.push(arguments);}  gtag('js', new Date());  gtag('config', 'UA-83731338-2');</script></html>
